var $t=Object.create;var Ce=Object.defineProperty;var xt=Object.getOwnPropertyDescriptor;var St=Object.getOwnPropertyNames;var Tt=Object.getPrototypeOf,Mt=Object.prototype.hasOwnProperty;var Pt=(e,t,i)=>t in e?Ce(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i;var Rt=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var At=(e,t,i,c)=>{if(t&&typeof t=="object"||typeof t=="function")for(let d of St(t))!Mt.call(e,d)&&d!==i&&Ce(e,d,{get:()=>t[d],enumerable:!(c=xt(t,d))||c.enumerable});return e};var Xe=(e,t,i)=>(i=e!=null?$t(Tt(e)):{},At(t||!e||!e.__esModule?Ce(i,"default",{value:e,enumerable:!0}):i,e));var D=(e,t,i)=>(Pt(e,typeof t!="symbol"?t+"":t,i),i);var Pe=Rt((Ra,Me)=>{(function(){"use strict";let e={fatal:!0},t=[new TextDecoder("iso-8859-15",e),new TextDecoder("utf-8",e),new TextDecoder("sjis",e),new TextDecoder("euc-jp",e),new TextDecoder("ascii")],i={debug:!1,parse:function(c,d){if(c instanceof Uint8Array)return i.Uint8(c);if(typeof c=="string")return i.Base64(c);if(c instanceof HTMLElement&&c.type==="file")return i.addListener(c,d);throw new Error("MidiParser.parse() : Invalid input provided")},addListener:function(c,d){if(!File||!FileReader)throw new Error("The File|FileReader APIs are not supported in this browser. Use instead MidiParser.Base64() or MidiParser.Uint8()");if(c===void 0||!(c instanceof HTMLElement)||c.tagName!=="INPUT"||c.type.toLowerCase()!=="file")return console.warn("MidiParser.addListener() : Provided element is not a valid FILE INPUT element"),!1;d=d||function(){},c.addEventListener("change",function(h){if(!h.target.files.length)return!1;console.log("MidiParser.addListener() : File detected in INPUT ELEMENT processing data..");let g=new FileReader;g.readAsArrayBuffer(h.target.files[0]),g.onload=function(b){d(i.Uint8(new Uint8Array(b.target.result)))}})},Base64:function(c){let d=function(b){var m="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";if(b=b.replace(/^.*?base64,/,""),b=String(b).replace(/[\t\n\f\r ]+/g,""),!/^(?:[A-Za-z\d+\/]{4})*?(?:[A-Za-z\d+\/]{2}(?:==)?|[A-Za-z\d+\/]{3}=?)?$/.test(b))throw new TypeError("Failed to execute _atob() : The string to be decoded is not correctly encoded.");b+="==".slice(2-(3&b.length));let C,a="",n,s,r=0;for(;r<b.length;)C=m.indexOf(b.charAt(r++))<<18|m.indexOf(b.charAt(r++))<<12|(n=m.indexOf(b.charAt(r++)))<<6|(s=m.indexOf(b.charAt(r++))),a+=n===64?String.fromCharCode(C>>16&255):s===64?String.fromCharCode(C>>16&255,C>>8&255):String.fromCharCode(C>>16&255,C>>8&255,255&C);return a}(c=String(c));var h=d.length;let g=new Uint8Array(new ArrayBuffer(h));for(let b=0;b<h;b++)g[b]=d.charCodeAt(b);return i.Uint8(g)},Uint8:function(g){let d={data:null,pointer:0,movePointer:function(n){return this.pointer+=n,this.pointer},readInt:function(n){if((n=Math.min(n,this.data.byteLength-this.pointer))<1)return-1;let s=0;if(1<n)for(let r=1;r<=n-1;r++)s+=this.data.getUint8(this.pointer)*Math.pow(256,n-r),this.pointer++;return s+=this.data.getUint8(this.pointer),this.pointer++,s},readStr:function(n){let s=new Uint8Array(n),r=!1,l;s.forEach((o,f)=>{s[f]=this.readInt(1)});for(let o=0;o<t.length;o++)if(!r)try{if(l=t[o].decode(s),o===0)for(let f=0;f<l.length;f++){let u=l.charCodeAt(f);if(u>191||u>127&&u<160)throw new RangeError(`Invalid code point: ${u}`)}r=!0,console.debug(`String byte sequence in ${t[o].encoding}`)}catch(f){console.debug(`SMF string ${f}`)}return l||"String byte sequence read failed."},backOne:function(){this.pointer--},readIntVLV:function(){let n=0;if(this.pointer>=this.data.byteLength)return-1;if(this.data.getUint8(this.pointer)<128)n=this.readInt(1);else{let r=[];for(;128<=this.data.getUint8(this.pointer);)r.push(this.readInt(1)-128);var s=this.readInt(1);for(let l=1;l<=r.length;l++)n+=r[r.length-l]*Math.pow(128,l);n+=s}return n}};if(d.data=new DataView(g.buffer,g.byteOffset,g.byteLength),d.readInt(4)!==1297377380)return console.warn("Header validation failed (not MIDI standard or file corrupt.)"),!1;d.readInt(4);let h={};h.formatType=d.readInt(2),h.tracks=d.readInt(2),h.track=[];var g=d.readInt(1),b=d.readInt(1);128<=g?(h.timeDivision=[],h.timeDivision[0]=g-128,h.timeDivision[1]=b):h.timeDivision=256*g+b;for(let n=1;n<=h.tracks;n++){h.track[n-1]={event:[]};var m,C=d.readInt(4);if(C===-1)break;if(C!==1297379947)return!1;d.readInt(4);let s=0,r=!1,l,o;for(;!r&&(s++,h.track[n-1].event[s-1]={},h.track[n-1].event[s-1].deltaTime=d.readIntVLV(),(l=d.readInt(1))!==-1);)if(128<=l?o=l:(l=o,d.movePointer(-1)),l===255){h.track[n-1].event[s-1].type=255,h.track[n-1].event[s-1].metaType=d.readInt(1);var a=d.readIntVLV();switch(h.track[n-1].event[s-1].metaType){case 47:case-1:r=!0;break;case 1:case 2:case 3:case 4:case 5:case 7:case 6:h.track[n-1].event[s-1].data=d.readStr(a);break;case 33:case 89:case 81:h.track[n-1].event[s-1].data=d.readInt(a);break;case 84:h.track[n-1].event[s-1].data=[],h.track[n-1].event[s-1].data[0]=d.readInt(1),h.track[n-1].event[s-1].data[1]=d.readInt(1),h.track[n-1].event[s-1].data[2]=d.readInt(1),h.track[n-1].event[s-1].data[3]=d.readInt(1),h.track[n-1].event[s-1].data[4]=d.readInt(1);break;case 88:h.track[n-1].event[s-1].data=[],h.track[n-1].event[s-1].data[0]=d.readInt(1),h.track[n-1].event[s-1].data[1]=d.readInt(1),h.track[n-1].event[s-1].data[2]=d.readInt(1),h.track[n-1].event[s-1].data[3]=d.readInt(1);break;default:this.customInterpreter!==null&&(h.track[n-1].event[s-1].data=this.customInterpreter(h.track[n-1].event[s-1].metaType,d,a)),this.customInterpreter!==null&&h.track[n-1].event[s-1].data!==!1||(d.readInt(a),h.track[n-1].event[s-1].data=d.readInt(a),this.debug&&console.info("Unimplemented 0xFF meta event! data block readed as Integer"))}}else switch((l=l.toString(16).split(""))[1]||l.unshift("0"),h.track[n-1].event[s-1].type=parseInt(l[0],16),h.track[n-1].event[s-1].channel=parseInt(l[1],16),h.track[n-1].event[s-1].type){case 15:this.customInterpreter!==null&&(h.track[n-1].event[s-1].data=this.customInterpreter(h.track[n-1].event[s-1].type,d,!1)),this.customInterpreter!==null&&h.track[n-1].event[s-1].data!==!1||(m=d.readIntVLV(),h.track[n-1].event[s-1].data=d.readInt(m),this.debug&&console.info("Unimplemented 0xF exclusive events! data block readed as Integer"));break;case 10:case 11:case 14:case 8:case 9:h.track[n-1].event[s-1].data=[],h.track[n-1].event[s-1].data[0]=d.readInt(1),h.track[n-1].event[s-1].data[1]=d.readInt(1);break;case 12:case 13:h.track[n-1].event[s-1].data=d.readInt(1);break;case-1:r=!0;break;default:if(this.customInterpreter!==null&&(h.track[n-1].event[s-1].data=this.customInterpreter(h.track[n-1].event[s-1].metaType,d,!1)),this.customInterpreter===null||h.track[n-1].event[s-1].data===!1)return console.log("Unknown EVENT detected... reading cancelled!"),!1}}return h},customInterpreter:null};if(typeof Me<"u")Me.exports=i;else{let c=typeof window=="object"&&window.self===window&&window||typeof self=="object"&&self.self===self&&self||typeof global=="object"&&global.global===global&&global;c.MidiParser=i}})()});var _e=function(e,t){let i=Math.min(e.length,t.length),c=e.slice(0,i),d=t.slice(0,i),h=0,g=0;for(;g<i&&h==0;)h=Math.sign(c[g]-d[g]),g++;return h},_=function(e=""){this.name=e,this.pool=[],this.point=function(t,i=!1){if(this.pool.length>0){let c=this.pool.length,d=1<<Math.floor(Math.log2(c)),h=d,g=64;for(;d>=1&&g>=0;){if(g<=0)throw new Error("TTL reached.");if(h==c)h-=d;else{let m=_e(t,this.pool[h]);switch(m){case 0:{g=0;break}case 1:{h+d<=c&&(h+=d);break}case-1:{h!=0&&(h-=d);break}default:console.warn(`Unexpected result ${m}.`)}}d=d>>1,g--}let b=!0;if(h>=this.pool.length)b=!1;else{let m=this;this.pool[h].forEach(function(C,a,n){b&&C!=t[a]&&(b=!1)}),!b&&_e(t,this.pool[h])>0&&h++}return b||i?h:-1}else return i?0:-1},this.add=function(t,i){return t.data=i,this.pool.splice(this.point(t,!0),0,t),this},this.default=function(t){console.warn(`No match in "${this.name||"(unknown)"}" for "${t}". Default action not defined.`)},this.get=function(t){let i=this.point(t);if(i>-1)return this.pool[i].data;this.default(t)},this.run=function(t,...i){let c=this.point(t);c>-1?t.subarray?this.pool[c].data(t.subarray(this.pool[c].length),...i):this.pool[c].data(t.slice(this.pool[c].length),...i):this.default(t,...i)}};var de=class{#a={};addEventListener(e,t){this.#a[e]||(this.#a[e]=[]),this.#a[e].unshift(t)}removeEventListener(e,t){if(this.#a[e]){let i=this.#a[e].indexOf(t);i>-1&&this.#a[e].splice(i,1),this.#a[e].length<1&&delete this.#a[e]}}dispatchEvent(e,t){let i=new Event(e),c=this;i.data=t,this.#a[e]?.length>0&&this.#a[e].forEach(function(d){try{d?.call(c,i)}catch(h){console.error(h)}}),this[`on${e}`]&&this[`on${e}`](i)}};var It=["MSB","PRG","LSB","NME","ELC","DRM","LVL","VXP"],Lt={krs:"KR",s90es:"ES",motif:"ES"},Dt={krs:"Kr",s90es:"SE",motif:"ME"},ve=function(e){let t=Math.floor(e/10),i=e%10;return`${t.toString(16)}${i}`},ke=class{#a;get bankInfo(){return this.#a}strictMode=!1;get(e=0,t=0,i=0,c,d=0){let h=[e,t,i],g,b=1,m=0,C,a,n,s=Array.from(arguments);switch(c){case"xg":{switch(e){case 0:{i===126?s[2]=125:i===127&&(s[2]=0);break}case 16:{i===126&&(s[2]=0);break}case 32:{i>125&&(s[2]=0),s[2]+=4;break}case 33:{(i>125||i===3)&&(s[2]=0),s[2]+=5;break}case 34:case 35:case 36:{i>125&&(s[2]=0),s[2]+=5;break}case 79:case 80:case 81:case 82:case 83:case 84:s[0]+=16;case 95:case 96:case 97:case 98:case 99:case 100:{i===126&&(s[2]=0);break}case 48:case 64:case 126:case 127:{i===126&&(e===127&&t===0||(s[2]=0));break}case 121:{switch(i){case 126:{s[2]=0;break}case 16:{s[2]=15;break}default:s[2]=s[2]&15}break}}break}case"gs":case"sc":{e===0&&i<5?s[0]=49:e<128&&e>125&&i<5&&i!==2&&(s[2]=e,s[0]=49);break}case"mt32":{e===0&&(s[0]=49);break}case"sd":{switch(e){case 121:{s[0]=96;break}case 120:{s[0]=104;break}}s[0]>>1===40?s[2]|=16:s[0]>95&&s[0]<100&&(s[2]|=16,t>>4===7&&(s[0]=96));break}case"pa":{switch(e){case 120:{i==64?s[2]=2:s[2]=1;break}case 121:{switch(i){case 127:{s[2]=79;break}default:s[2]=(s[2]&63)+32}break}}break}case"g2":{e>>1===40?s[2]|=16:e>95&&e<100&&(s[2]|=16,t>>4===7&&(s[0]=96));break}case"sg":{e===8&&i===0&&(s[2]=5);break}case"05rw":case"x5d":{e&&e<56&&(s[0]=56);break}case"s90es":case"motif":case"an1x":case"cs1x":case"cs6x":{if(e===0)break;switch(e){case 63:{switch(c){case"s90es":{i<8?s[2]+=17:i<32?s[2]+=13:s[2]=(s[2]>>3)+19;break}case"motif":{i<8?s[2]+=28:i<32?s[2]+=13:s[2]=(s[2]>>3)+19;break}case"cs1x":{switch(i>>1){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:case 8:case 9:case 10:{s[2]+=34;break}case 32:{s[2]=34+((i&1)<<2);break}case 33:{s[2]=47+((i&1)<<2);break}case 61:{s[2]=34+((i&1)<<2);break}case 62:{s[2]=47+((i&1)<<2);break}}break}}break}case 32:{i>125&&(s[2]=0),s[2]+=4;break}case 33:{(i>125||i===3)&&(s[2]=0),s[2]+=5;break}case 34:case 35:case 36:{i>125&&(s[2]=0),s[2]+=5;break}case 79:case 80:case 81:case 82:case 83:case 84:s[0]+=16;case 95:case 96:case 97:case 98:case 99:case 100:{i===126&&(s[2]=0);break}}break}}let r=" ",l="M",o="",f=0,u=0;switch(s[0]){case 0:{switch(s[2]){case 127:{l="GM-a";break}case 126:{l="GM-n";break}case 7:{l="GM-k",o="GLX";break}case 5:{l="SG-a",o="000";break}case 4:{c==="gs"||c==="sc"?(l="GM-a",o="000"):(l="SP-l",o="C/M");break}case 3:case 2:case 1:{(c==="gs"||c==="sc")&&(l="GM-a",o="000");break}case 0:{l="GM-a";break}default:l="y",f=3}break}case 8:{c==="sg"?l="GM-s":l="r:";break}case 32:case 33:case 34:case 35:case 36:{c==="xg"&&(l=`${["AP","VL","PF","DX","AN"][e&7]}-${"abcdefgh"[i]}`,f=3);break}case 48:{o=`M${(s[2]>>3).toString().padStart(2,"0")}`,l=`y${o}`,f=1;break}case 49:{s[2]>>1===63?(l=`MT-${"ba"[s[2]&1]}`,o=`C${"-/"[s[2]&1]}M`):(l="GM-a",o="000");break}case 56:{l="GM-b";break}case 57:l=["yDOC","QY10","QY20"][s[2]-112]||"yMxv",o=["DOC","QY1","QY2"][s[2]-112]||"057";case 61:case 128:{l="rDrm";break}case 120:{l="gDrm";break}case 62:{l="kDrm";break}case 63:{if(s[2]<17){let $=s[2];l=$<10?"kP:":"kC:",l+=$%10}else if(s[2]<34)l=["Pre1","Pre2","Pre3","Pre4","Usr1","Usr2","DrmP","DrmU","Plg1","Plg2","Plg3","Pre1","Pre2","Pre3","Pre4","Pre5","Pre6"][s[2]-17];else if(s[2]<55){let $=s[2]-34;switch($>12&&$--,i>>1){case 32:case 33:{l=`Pr${i-63}U`;break}case 61:case 62:{l=`Pr${i-121}U`;break}default:l=s[2]===46?"PrDr":`Pr${($>>2)+1}${String.fromCharCode(65+($&3))}`}}else l="Ds";f=1;break}case 64:{l="ySFX",o="SFX";break}case 67:{l="DX:S";break}case 80:case 81:case 82:case 83:{l=`Prg${"UABC"[s[0]-80]}`;break}case 88:case 89:case 90:case 91:{l=`Cmb${"UABC"[s[0]-88]}`;break}case 95:{l=`${["DR","PC"][s[2]]}-d`;break}case 96:{l=s[2]===106?"AP-a":s[2]>>4===1?"SDg":"PF",s[2]>63?u=63:s[2]>>4===1&&(u=16),f=3;break}case 97:{l=s[2]>>4===1?"SDa":"VL:",f=3,s[2]>>4===1?u=16:u=112;break}case 98:{l=s[2]>>4===1?"SDb":"SG-a",f=3,u=16;break}case 99:{l=s[2]>>4===1?"SDc":"DX",s[2]>63?u=63:s[2]>>4===1&&(u=16),f=3;break}case 100:{l="AN",s[2]>63?u=63:s[2]>>4===1&&(u=16),f=3;break}case 104:case 105:case 106:case 107:{l="SDd",u=104;break}case 121:{l=`GM${s[2]?"":"-a"}`,f=1;break}case 122:{l="lDrm";break}case 126:{l="yDrS";break}case 127:{s[2]===127?l="rDrm":l="yDrm";break}default:s[0]<48?l="r:":l="M"}l.length<4&&(l+=`${[e,i,s[0],s[2]][f]-u}`.padStart(4-l.length,"0")),o.length<3&&(o+=`${[e,i,e,i][f]}`.padStart(3-o.length,"0")),c==="xg"&&(e===0?s[2]<100?l=l.replace("y0","y:"):s[2]===125&&(l="y126"):e===16?(g=`Voice${((s[2]<<7)+s[1]+1).toString().padStart(3,"0")}`,r=" "):e===35&&i>>1===2&&(g=`DXCH_${(((s[2]&1)<<7)+t+1).toString().padStart(3,"0")}`,r=" "));let p=[s[0],s[1],s[2]];for(;!(g?.length>=0);)if(g=this.#a[s[1]||0][(s[0]<<8)+s[2]]?.name,g){let $=this.#a[s[1]||0][(s[0]<<8)+s[2]];b=$?.poly||b,m=$?.type||m,C=$?.drum,a=$?.level,n=$?.voice}else if(this.strictMode)g="",r="?";else if(s[0]===0&&s[1]===0&&s[2]===0)g="Unloaded";else if(this.#a[s[1]||0][s[0]<<8])s[0]===0?(s[2]=0,r="^"):s[2]<1?(s[0]=0,r="*"):(s[2]--,r="^");else if(e===48)s[0]=0,s[2]=0,r="!";else if(e===62)s[1]--,r=" ",s[1]<1&&!g?.length&&(s[0]=0,r="!");else if(e<63)s[0]===0?(s[2]=0,r="^"):s[2]<1?(s[0]=0,r="*"):s[2]--;else if(e===80)g=`PrgU:${t.toString().padStart(3,"0")}`,r="!";else if(e===88)g=`CmbU:${t.toString().padStart(3,"0")}`,r="!";else if(e===121)g=`GM2Vox0${i}`,r="#";else if(e===122)if(s[1]===32?s[1]:s[1]%=7,g=this.#a[s[1]||0][(s[0]<<8)+s[2]]?.name,g){r=" ";let $=this.#a[s[1]||0][(s[0]<<8)+s[2]];b=$?.poly||b,m=$?.type||m,C=$?.drum,a=$?.level}else g="",r="*";else s[1]===0?(g=`${e.toString().padStart(3,"0")} ${t.toString().padStart(3,"0")} ${i.toString().padStart(3,"0")}`,r="!"):s[0]===0?(s[2]=0,r="^"):s[2]>0?s[2]--:s[1]>0?(s[1]=0,r="!"):(s[0]=0,r="?");let w=[s[0],s[1],s[2]];switch(r){case"^":{switch(c){case"gs":case"sc":case"ns5r":{r=" ";break}case"xg":{i===126&&(r=" ");break}}e===127&&(r=" ");break}case"*":break;case"!":break;case"?":break}let E="??";switch(s[0]){case 0:{s[2]===0?E="GM":s[2]===5||s[2]===7?E="KG":s[2]<126&&(E="XG");break}case 32:case 33:case 35:case 36:{s[2]>4?E=["AP","VL","PF","DX","AN"][s[0]-32]:E="GS";break}case 48:{E="MU";break}case 49:{s[2]>>1===63?E="MT":s[2]<5&&(E="GM");break}case 56:{E="AG";break}case 61:case 80:case 83:case 88:case 89:case 91:{E="AI";break}case 62:case 82:case 90:{E="XD";break}case 63:{s[2]<17?E="KR":s[2]<34?E="ES":s[2]<55?E="CS":E="DS";break}case 64:case 126:{E="XG";break}case 67:case 99:{E=s[2]>>4===1?"SD":"DX";break}case 81:{E="RW";break}case 95:{E=["DR","PC"][s[2]];break}case 96:{E=s[2]===106?"AP":s[2]>>4===1?"SD":"PF";break}case 97:{E=s[2]>>4===1?"SD":"VL";break}case 98:{E=s[2]>>4===1?"SD":"SG";break}case 100:{E="AN";break}case 104:case 105:case 106:case 107:{E="SD";break}case 120:{E=t===0?"GM":["G2","PA","PA"][s[2]]??"G2";break}case 128:{E=t===0?"GM":"GS";break}case 121:{E=s[2]?["G2","XG","PA","PA","PA"][s[2]>>4]:"GM";break}case 122:{E="KG";break}case 127:{E=s[2]===127?"MT":t===0?"GM":"XG";break}default:s[0]<48&&(s[0]===16&&c==="xg"?E="XG":E="GS")}if(r!==" ")switch(c){case"krs":case"s90es":case"motif":{g="",E=Lt[c],r="?";break}case"g2":{g="GM2 Ext?",r="?";break}case"pa":{r==="^"&&(g="Unknown",r="?");break}default:self.debugMode&&(g="",r="?")}return{name:g||`${Dt[c]||c.toUpperCase()}${ve(e||0)}${ve(t||0)}${ve(i||0)}`,poly:b,type:m,drum:C,level:a,voice:n,iid:p,eid:w,sid:h,ending:r,sect:l,bank:o,standard:E,mode:c}}async load(e,t,i="(internal)",c){let d=this,h=[],g=0,b=0,m=0;e.split(`
`).forEach(function(C,a){let n=C.split("	"),s=[];if(a===0){if(n.forEach(function(r,l){h[It.indexOf(r)]=l}),h.length<4){console.debug("Debugger launched.");debugger}}else{let r=0,l=0,o=0,f,u=1,p=0,w,E,$;n.forEach(function(U,we){switch(we){case h[0]:{r=parseInt(U);break}case h[1]:{l=parseInt(U);break}case h[2]:{o=parseInt(U);break}case h[3]:{f=U;break}case h[4]:{U=parseInt(U),U<16?u=U+1:(p=(U&15)+1,u=p);break}case h[5]:{E=U;break}case h[6]:{typeof U=="string"&&(w=parseInt(U));break}case h[7]:{$=U;break}}}),d.#a[l]=d.#a[l]||[];let S=d.#a[l],R={msb:r,prg:l,lsb:o,name:f,poly:u,type:p,drum:E,level:w,voice:$,priority:c},O=!1;c<S[r<<8|o]?.priority&&(O=!0,m++),(!S[r<<8|o]||O||t)&&(S[r<<8|o]=R,g++),b++}}),t||console.debug(`Map: From "${i}", ${b} total, ${g} loaded (${g-m} + ${m}).`)}clearRange(e){let t=e.prg!==void 0?e.prg.constructor===Array?e.prg:[e.prg,e.prg]:[0,127],i=e.msb!==void 0?e.msb.constructor===Array?e.msb:[e.msb,e.msb]:[0,127],c=e.lsb!==void 0?e.lsb.constructor===Array?e.lsb:[e.lsb,e.lsb]:[0,127];for(let d=i[0];d<=i[1];d++){let h=d<<8;for(let g=c[0];g<=c[1];g++){let b=h+g;for(let m=t[0];m<=t[1];m++)delete this.#a[m][b]}}}init(){this.#a=[];for(let e=0;e<128;e++)this.#a.push([""])}async loadFiles(...e){this.init();let t=this;e.forEach(async function(i,c){try{t.load(await(await fetch(`./data/bank/${i}.tsv`)).text(),!1,i,c)}catch{console.error(`Failed loading "${i}.tsv".`)}})}constructor(...e){this.loadFiles(...e)}};var He=class{#a={};context;set(e,t){this.#a[e]=t}has(e){return!!this.#a[e]}async read(e,t){if(!this.has(e))throw new Error(`No decoder registered for "${e}"`);return await this.#a[e].call(this.context||this,t)}};var Ot=function(e,t){let i=!0;return t.forEach((c,d)=>{i=i&&e[d]===c}),i},ae=function(e){let t=0;return e.forEach(i=>{t*=256,t+=i}),t},F=new TextDecoder,ie=new He;ie.set("s7e",async function(e){let t=new Uint8Array(await e.slice(0,65536).arrayBuffer()),i="MSB	LSB	PRG	NME",c=[0,0,0,0],d=32,h=0,g=0,b=!0,m=[],C=0;for(;b;){let a=t.subarray(h);([()=>{F.decode(a.subarray(0,4))==="YSFC"?(h+=80,g=1):h++},()=>{if(Ot(a.subarray(0,4),c))m.forEach((n,s,r)=>{let l=ae(t.subarray(n.start+4,n.start+8));n.length=l}),g=2;else{let n=F.decode(a.subarray(0,4)),s=ae(a.subarray(4,8));m.push({type:n,start:s}),h+=8}},()=>{let n=m[C],s=t.subarray(n.start,n.start+n.length),r=32;switch(n.type){case"ENVC":{let l=d;for(;l<s.length;){let o=s.subarray(l,l+r),f=F.decode(o.subarray(0,10)).trimEnd();f.slice(0,5)==="Init "&&(f=""),f&&(i+=`
063	${(o[17]+13).toString().padStart(3,"0")}	${o[19].toString().padStart(3,"0")}	${f}`),l+=r}break}case"EDVC":{let l=d;for(;l<s.length;){let o=s.subarray(l,l+r),f=F.decode(o.subarray(0,10)).trimEnd();f.slice(0,5)==="Init "&&(f=""),f&&(i+=`
063	024	${o[19].toString().padStart(3,"0")}	${f}`),l+=r}break}case"EPVC":{let l=32,o=d;for(;o<s.length;){let f=s.subarray(o,o+l),u=F.decode(f.subarray(0,10)).trimEnd();u==="----------"&&(u=""),u&&(i+=`
063	${(f[17]+1).toString().padStart(3,"0")}	${f[19].toString().padStart(3,"0")}	${u}`),o+=l}break}}C++,C>=m.length&&(g=3,b=!1)}][g]||(()=>{b=!1}))()}return i});ie.set("pcg",async function(e){let t=new Uint8Array(await e.arrayBuffer()),i="MSB	LSB	PRG	NME",c=100,d=0,h=0,g=!0,b=[],m=0;for(;g;){let C=t.subarray(c);([()=>{g=F.decode(C.subarray(0,4))==="INI2",h=C[15],c+=16,d=1},()=>{let a=F.decode(C.subarray(0,4)),n=C[5],s=C[7],r=C[11],l=ae(C.subarray(12,16)),o=ae(C.subarray(16,20)),f=ae(C.subarray(36,40)),u=F.decode(C.subarray(44,44+r));b.push({type:a,tipMsb:n,tipLsb:s,nameLen:r,length:l,start:o,entryLen:f,name:u}),c+=64,h--,h<1&&(d=2)},()=>{let a=b[m],n=t.subarray(a.start,a.start+a.length);switch(a.type){case"PRG1":break;case"PBK1":{let s=63,r=(a.tipMsb?6:0)+a.tipLsb;for(let l=0;l<128;l++){let o=l*a.entryLen,f=n.subarray(o,o+a.entryLen),u=F.decode(f.subarray(0,24)).trimEnd().replace("InitProg","");u.length&&r>5&&(i+=`
${s.toString().padStart(3,"0")}	${r.toString().padStart(3,"0")}	${l.toString().padStart(3,"0")}	${u}`)}break}case"CBK1":{let s=63,r=(a.tipMsb?3:0)+a.tipLsb+10;for(let l=0;l<128;l++){let o=l*a.entryLen,f=n.subarray(o,o+a.entryLen),u=F.decode(f.subarray(0,24)).trimEnd().replace("InitCombi","");u.length&&r>12&&(i+=`
${s.toString().padStart(3,"0")}	${r.toString().padStart(3,"0")}	${l.toString().padStart(3,"0")}	${u}`)}break}}m++,m>=b.length&&(d=3,g=!1)}][d]||(()=>{g=!1}))()}return i});var re=["off","hall","room","stage","plate","delay LCR","delay LR","echo","cross delay","early reflections","gate reverb","reverse gate"].concat(new Array(4),["white room","tunnel","canyon","basement","karaoke"],new Array(43),["pass through","chorus","celeste","flanger","symphonic","rotary speaker","tremelo","auto pan","phaser","distortion","overdrive","amplifier","3-band EQ","2-band EQ","auto wah"],new Array(1),["pitch change","harmonic","touch wah","compressor","noise gate","voice channel","2-way rotary speaker","ensemble detune","ambience"],new Array(4),["talking mod","Lo-Fi","dist + delay","comp + dist + delay","wah + dist + delay","V dist","dual rotor speaker"]),se=["melodic","drums","drum set 1","drum set 2","drum set 3","drum set 4","drum set 5","drum set 6","drum set 7","drum set 8"],Ut=[17.1,18.6,20.2,21.8,23.3,24.9,26.5,28,29.6,31.2,32.8,34.3,35.9,37.5,39,40.6,42.2,43.7,45.3,46.9,48.4,50],J=[20,22,25,28,32,36,40,45,50,56,63,70,80,90,100,110,125,140,160,180,200,225,250,280,315,355,400,450,500,560,630,700,800,900,1e3,1100,1200,1400,1600,1800,2e3,2200,2500,2800,3200,3600,4e3,4500,5e3,5600,6300,7e3,8e3,9e3,1e4,11e3,12e3,14e3,16e3,18e3,2e4],Ge=[0,.04,.08,.13,.17,.21,.25,.29,.34,.38,.42,.46,.51,.55,.59,.63,.67,.72,.76,.8,.84,.88,.93,.97,1.01,1.05,1.09,1.14,1.18,1.22,1.26,1.3,1.35,1.39,1.43,1.47,1.51,1.56,1.6,1.64,1.68,1.72,1.77,1.81,1.85,1.89,1.94,1.98,2.02,2.06,2.1,2.15,2.19,2.23,2.27,2.31,2.36,2.4,2.44,2.48,2.52,2.57,2.61,2.65,2.69,2.78,2.86,2.94,3.03,3.11,3.2,3.28,3.37,3.45,3.53,3.62,3.7,3.87,4.04,4.21,4,37,4.54,4.71,4.88,5.05,5.22,5.38,5.55,5.72,6.06,6.39,6.73,7.07,7.4,7.74,8.08,8.41,8.75,9.08,9.42,9.76,10.1,10.8,11.4,12.1,12.8,13.5,14.1,14.8,15.5,16.2,16.8,17.5,18.2,19.5,20.9,22.2,23.6,24.9,26.2,27.6,28.9,30.3,31.6,33,34.3,37,39.7],Ke=function(e){let t=.1,i=-.3;return e>66?(t=5,i=315):e>56?(t=1,i=47):e>46&&(t=.5,i=18.5),t*e-i},Fe=function(e){return e>105?Ut[e-106]:e>100?e*1.1-100:e/10},Ye=",a,i,u,e,o,ka,ki,ku,ke,ko,ky,kw,sa,si,su,se,so,sh,ta,ti,tu,te,to,t,ch,t,s,na,ni,nu,ne,no,ny,nn,ha,hi,hu,he,ho,hy,fa,fi,fu,fe,fo,ma,mi,mu,me,mo,my,mm,ya,yu,ye,yo,ra,ri,ru,re,ro,ry,wa,wi,we,wo,ga,gi,gu,ge,go,gy,gw,za,zi,zu,ze,zo,ja,ji,ju,je,jo,jy,da,di,du,de,do,dy,ba,bi,bu,be,bo,by,va,vi,vu,ve,vo,pa,pi,pu,pe,po,py,nga,ngi,ngu,nge,ngo,ngy,ng,hha,hhi,hhu,hhe,hho,hhy,hhw,*,_,,,~,.".split(","),$e={};`hi*,
ka,ã‹
ki,ã
ku,ã
ke,ã‘
ko,ã“
ky,ã!
kw,ãl
tsu,ã¤
ts,ã¤l
sa,ã•
si,ã™ãƒ
su,ã™
se,ã›
so,ã
shi,ã—
sh,ã—!
ta,ãŸ
ti,ã¦ãƒ
tu,ã¨ã…
te,ã¦
to,ã¨
tchy,ã¡!
tchi,ã¡
na,ãª
ni,ã«
nu,ã¬
ne,ã­
no,ã®
ny,ã«!
nn,ã‚“
ha,ã¯
hi,ã²
hu,ã»ã…
he,ã¸
ho,ã»
hy,ã²!
fa,ãµã
fi,ãµãƒ
fu,ãµ
fe,ãµã‡
fo,ãµã‰
ma,ã¾
mi,ã¿
mu,ã‚€
me,ã‚
mo,ã‚‚
my,ã¿!
mm,ã‡º
ra,ã‚‰
ri,ã‚Š
ru,ã‚‹
re,ã‚Œ
ro,ã‚
ry,ã‚Š!
wa,ã‚
wi,ã‚
we,ã‚‘
wo,ã‚’
nga,ã‹ã‚š
ngi,ãã‚š
ngu,ãã‚š
nge,ã‘ã‚š
ngo,ã“ã‚š
ngy,ãã‚š!
ng,ãƒ³
ga,ãŒ
gi,ãŽ
gu,ã
ge,ã’
go,ã”
gy,ãŽ!
gw,ãl
za,ã–
zi,ãšãƒ
zu,ãš
ze,ãœ
zo,ãž
ja,ã˜ã‚ƒ
ji,ã˜
ju,ã˜ã‚…
je,ã˜ã‡
jo,ã˜ã‚‡
jy,ã˜!
da,ã 
di,ã§ãƒ
du,ã©ã…
de,ã§
do,ã©
dy,ã§!
ba,ã°
bi,ã³
bu,ã¶
be,ã¹
bo,ã¼
by,ã³!
va,ã‚”ã
vi,ã‚”ãƒ
vu,ã‚”
ve,ã‚”ã‡
vo,ã‚”ã‰
pa,ã±
pi,ã´
pu,ã·
pe,ãƒš
po,ã½
py,ã´!
!ya,ã‚ƒ
!yu,ã‚…
!ye,ã‡
!yo,ã‚‡
ya,ã‚„
yu,ã‚†
ye,ð›€
yo,ã‚ˆ
!a,ã‚ƒ
!u,ã‚…
!e,ã‡
!o,ã‚‡
!a,ã‚ƒ
!u,ã‚…
!e,ã‡
!o,ã‚‡
la,ã
li,ãƒ
lu,ã…
le,ã‡
lo,ã‰
a,ã‚
i,ã„
u,ã†
e,ãˆ
o,ãŠ
*,ã£
~,
^,
_,`.split(`
`).forEach(e=>{let t=e.split(",");$e[t[0]]=t[1]});var We=function(e){let t=e;e[0]=="*"&&(t=t.slice(1)),["aa","ii","uu","ee","oo"].forEach(c=>{for(;t.indexOf(c)>-1;)t=t.replace(c,c[0])});for(let c in $e)t=t.replaceAll(c,$e[c]);t.indexOf("ã‚“")==0&&t.length>1&&(t=t.slice(1));let i=t.indexOf("!");return i>-1&&t.length>1&&(t=t.slice(i+1)),t},ze=function(e){return e?e<96?`cc${e}`:["aftertouch","velocity","pitch bend"][e-96]:"off"},qe={u8:["utf-8","Unicode"],l1:["l9","Pan-Latin"],jp:["sjis","Japanese"],kr:["iso-2022-kr","Korean"],hz:["gb18030","Simplified Chinese"],b5:["big5","Traditional Chinese"],cy:["koi8-ru","Cyrillic"],vn:["tcvn-5773-1993","Vietnamese"]},Qe={m:"Male",f:"Female",c:"Chorus",s:"Solo",p:"Plural",w:"Words",x:"Non-vocal"};var xe=["room 1","room 2","room 3","hall 1","hall 2","plate","delay","panning delay"],je=["chorus 1","chorus 2","chorus 3","chorus 4","feedback","flanger","short delay","short delay feedback"],Je=["delay 1","delay 2","delay 3","delay 4","pan delay 1","pan delay 2","pan delay 3","pan delay 4","delay to reverb","pan repeat"];var Nt={0:"thru",256:"stereo EQ",257:"spectrum",258:"enhancer",259:"humanizer",272:"overdrive",273:"distortion",288:"phaser",289:"auto wah",290:"rotary",291:"stereo flanger",292:"step flanger",293:"tremelo",294:"auto pan",304:"compressor",305:"limiter",320:"hexa chorus",321:"tremelo chorus",322:"stereo chorus",323:"space D",324:"3D chorus",336:"stereo delay",337:"modulated delay",338:"3-tap delay",339:"4-tap delay",340:"tremelo control delay",341:"reverb",342:"gate reverb",343:"3D delay",352:"2-pitch shifter",353:"feedback pitch shifter",368:"3D auto",369:"3D manual",370:"Lo-Fi 1",371:"Lo-Fi 2",512:"overdrive - chorus",513:"overdrive - flanger",514:"overdrive - delay",515:"distortion - chorus",516:"distortion - flanger",517:"distortion - delay",518:"enhancer - chorus",519:"enhancer - flanger",520:"enhancer - delay",521:"chorus - delay",522:"flanger - delay",523:"chorus - flanger",524:"rotary multi",1024:"guitar multi 1",1025:"guitar multi 2",1026:"guitar multi 3",1027:"clean guitar multi 1",1028:"clean guitar multi 2",1029:"bass multi",1030:"rhodes multi",1280:"keyboard multi",4352:"chorus / delay",4353:"flanger / delay",4354:"chorus / flanger",4355:"overdrive / distortion",4356:"overdrive / rotary",4357:"overdrive / phaser",4358:"overdrive / auto wah",4359:"phaser / rotary",4360:"phaser / auto wah"},Bt={66307:["drive"],66309:["vowel",e=>"aiueo"[e]],94723:["pre-filter"],94724:["Lo-Fi type"],94725:["post-filter"],94979:["Lo-Fi type"],94980:["fill type",e=>["off","LPF","HPF"][e]],94984:["noise type",e=>["white","pink"][e]],94987:["disc type",e=>["LP","SP","EP","RND"]],94990:["hum type",e=>`${e+5}0Hz`],94993:["M/S",e=>["mono","stereo"][e]]},Se=function(e){return Nt[(e[0]-32<<8)+e[1]]||`0x${e[0].toString(16).padStart(2,"0")}${e[1].toString(16).padStart(2,"0")}`},Ze=function(e,t,i){let c=(e[0]-32<<16)+(e[1]<<8)+t,d=Bt[c]||{},h=d[0];if(h?.length)return h+=`: ${(d[1]||function(){})(i)||i}`,h},Te=[68,48,95,78,41,3,110,122,0];var et=(e,t)=>{let i=Math.min(e.length,t.length),c=0;for(let d=0;d<i;d++)if(c=e[d]-t[d],c!==0)return[d,c];return e.length!==t.length?[i,e.length-t.length]:[0,0]},B=function(e=64){return Math.round(2e3*Math.log10(e/64))/100},tt=function(e,t,i){let c=[],d=i==!1?t.readIntVLV():i;e==0||e==127;for(let h=0;h<d;h++){let g=t.readInt(1);if(c.push(g),g!=247){if(g!=240){if(g>127)return console.debug(`Early termination: ${c}`),c.pop(),t.backOne(),t.backOne(),new Uint8Array(c)}}}return new Uint8Array(c)},Q=function(e){let t=0;return e.forEach(i=>{t+=i,t=t&127}),~t+1&127},H=function(e,t){let i=0,c=0;for(let d=0;d<e.length;d++){let h=(d&7)-1,g=(c>>h&1)<<7,b=e[d];b+=g,d&7?(t(b,i,e),i++):c=e[d]}};var Vt=function(e,t){let i=0;for(let c=0;c<e.length;c++)if(c&1){i=i<<4|e[c]&15;let d=c>>1;t(i,d,e)}else i=e[c]&15},at=function(e){let t=e.length>>1,i=new Uint8Array(t);return Vt(e,(c,d)=>{i[d]=c}),i},ne=function(e){let t=Math.floor(e*14.2);return t<128?t:0},T=function(){return self.Bun?!0:self.debugMode??!1},it=function(e){let t=(e.length+1)*3>>2,i=new Uint8Array(t),c=e.length+3>>2;for(let d=0;d<c;d++){let h=d<<2,g=d*3,b=0;for(let m=0;m<4;m++)b<<=6,b|=e.charCodeAt(h+m)-32&63;i[g]=b>>16,i[g+1]=b>>8&255,i[g+2]=b&255}return i};var Ma="â™­ð„«,ð„«,â™­,,â™¯,ð„ª,ð„ªâ™¯".split(",");var Fa=Xe(Pe(),1),A=["?","gm","gs","sc","xg","g2","mt32","doc","qy10","qy20","ns5r","x5d","05rw","k11","sg","sd","pa","krs","s90es","motif","cs6x","trin","an1x","cs1x"],Xt={gm2:"g2","mt-32":"mt32","c/m":"mt32",ag10:"05rw","ag-10":"05rw","05r/w":"05rw",x5:"05rw",x5dr:"x5d",gmega:"k11","kross 2":"krs","motif es":"motif","s90 es":"s90es",trinity:"trin","tr-rack":"trin"},_t=["melodic","drum","menu"],le={"?":[0,0,120,0,0],gm:[0,0,120,0,0],gs:[0,0,128,0,0],sc:[0,0,128,0,0],xg:[0,0,127,0,0],g2:[0,0,120,0,0],mt32:[0,127,127,0,127],doc:[57,112,127,57,112],qy10:[57,113,127,57,113],qy20:[57,114,127,57,114],ns5r:[0,0,61,0,0],x5d:[82,0,62,56,0],"05rw":[81,0,62,56,0],k11:[0,0,122,0,0],sg:[0,0,122,0,0],sd:[97,0,105,0,0],pa:[0,0,120,121,0],krs:[121,0,120,0,0],s90es:[0,0,127,0,0],motif:[0,0,127,0,0],cs6x:[0,0,127,0,0],trin:[0,0,61,0,0],an1x:[36,3,127,0,0],cs1x:[0,0,127,63,0],cs2x:[0,0,127,63,0]},Ht=[9,25,41,57,73,89,105,121],Gt=[0,3,81,84,88],rt={8:"Off",9:"On",10:"Note aftertouch",11:"cc",12:"pc",13:"Channel aftertouch",14:"Pitch"},he={0:0,1:1,2:3,5:4},st={0:0,1:1,2:2,5:3},nt=[[0,24],[0,127],[0,127],[40,88],[0,127],[0,127]],Ae=[36,37,48,49,52,53],pe=[20,21,22,23,24,25,26,28,29,30,31,36,37,48,49,52,53,64,65],lt={26:127,29:0,30:0,31:0,52:12,53:54},j=[0,1,2,4,5,6,7,8,10,11,12,13,14,15,16,17,18,19,20,21,22,26,28,32,38,40,41,42,43,44,45,46,47,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,80,81,82,83,84,91,92,93,94,95,98,99,100,101,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157],Kt=[2,4,12,13,14,15,16,17,18,19,20,21,40,41,42,43,44,45,46,47,80,81,83,136,130,131,132,133,134,135,137,138,139,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157],Ft=[33,102,99,32,100,8,9,10],ct=[0,16,25,40,32,64,24,48],ce="reverb,chorus,delay,insert0,insert1,insert2,insert3,insert4".split(","),G=[["VL",32,8,1],["SG",8,1,1],["DX",16,1,16],["AN",16,2,5],["PF",2,1,64],["DR",2,1,32],["PC",2,1,32],["AP",2,1,64]],k={};A.forEach((e,t)=>{k[e]=t});var v=[];j.forEach((e,t)=>{v[e]=t});var X={length:pe.length};pe.forEach((e,t)=>{X[e]=t});var Yt={};_t.forEach((e,t)=>{Yt[e]=t});var Wt=function(e){let t=[],i=0;return e?.forEach(function(c,d){c===247?t.push(e.subarray(i,d)):c===240&&(i=d+1)}),t.length||t.push(e.subarray(0)),T()&&console.debug(t),t};var Re=8,y={port:Re,ch:Re<<4,chShift:Math.ceil(Math.log2(Re))+4,cc:j.length,nn:128,pl:512,tr:256,cmt:14,rpn:6,rpnt:4,nrpn:Ae.length,ace:8,drm:8,dpn:pe.length,dnc:128,ext:3,efx:8,cvn:12,redir:32,vxPrim:3,invalidCh:255};y.chcc=y.cc*y.ch;var K={bank0:255},zt=new TextDecoder("l9"),M=new Uint16Array(y.ch),Z=new Uint16Array(y.ch),qt=new Uint16Array(y.ch),ue=new Uint16Array(y.ch),Qt=new Uint16Array(y.ch),ee=new Uint16Array(y.ch),ot=new Array(y.drm);for(let e=0;e<y.ch;e++)M[e]=e*y.cc,Z[e]=e*y.rpn,qt[e]=e*y.nrpn,ue[e]=e*y.ace,Qt[e]=e*y.ext,ee[e]=e*y.cvn;for(let e=0;e<y.drm;e++){ot[e]=new Uint16Array(y.dpn);let t=e*y.dpn*y.dnc;for(let i=0;i<y.dpn;i++)ot[e][i]=t+i*y.dnc}var ft=class extends de{NOTE_IDLE=0;NOTE_ATTACK=1;NOTE_DECAY=2;NOTE_SUSTAIN=3;NOTE_HELD=4;NOTE_RELEASE=5;NOTE_SOSTENUTO_ATTACK=8;NOTE_SOSTENUTO_DECAY=9;NOTE_SOSTENUTO_SUSTAIN=10;NOTE_SOSTENUTO_HELD=11;NOTE_MUTED_RECOVERABLE=16;CH_MELODIC=0;CH_DRUMS=1;CH_DRUM1=2;CH_DRUM2=3;CH_DRUM3=4;CH_DRUM4=5;CH_DRUM5=6;CH_DRUM6=7;CH_DRUM7=8;CH_DRUM8=9;DUMP_ALL=0;DUMP_ONCE=1;DUMP_MODE=2;EXT_NONE=0;EXT_VL=1;EXT_DX=3;VLBC_SYSTEM=0;VLBC_BRTHEXPR=1;VLBC_VELOINIT=2;VLBC_VELOALL=3;CH_INACTIVE=0;CH_ACTIVE=1;CH_DISABLED=2;KARAOKE_NONE=0;KARAOKE_TEXT=1;KARAOKE_XF=2;#a=0;#b=0;#S=0;#T=new Array(11);get#$(){return this.#T[this.#b]}set#$(e){this.#T[this.#b]=e}#u=new Uint8Array(y.ch);#f=new Uint8Array(y.ch);#r=new Uint8Array(y.ch);#e=new Uint8Array(y.chcc<<1);#y=new Uint8Array(y.ch*y.ace);#n=new Uint8Array(y.ch*y.vxPrim);#h=new Uint8Array(y.ch*y.nn);#d=new Uint8Array(y.ch);#c=new Uint16Array(y.pl);#l=new Uint8Array(y.pl);#v=new Int16Array(y.ch);#M=new Uint8Array(y.ch);#O=new Uint8Array(y.ch);#x=new Uint8Array(y.ch*y.ext);#s=new Uint8Array(y.ch*y.rpn);#o=new Uint8Array(y.ch*y.rpnt);#Q=new Int8Array(y.ch*Ae.length);#A=new Uint8Array(y.drm*y.dpn*y.dnc);#V=new Uint8Array(y.drm*2);#R=new Uint8Array(y.efx*3);#Y=new Uint8Array(y.ch);#G=new Uint8Array(y.ch*y.redir);#k=new Uint8Array(y.port);#K=new Uint8Array(y.port);#E=new Uint8Array(y.ch);#L=new Uint8Array(y.ch);#W=new Uint8Array(y.ch*y.cvn);#X=new Uint8Array(y.ch);#U=new Uint8Array(128);#w=new Uint8Array(y.cmt*8);#j=new Uint8Array(1024);#t=new Uint8Array(y.cmt*64);#p={};modelEx={xg:{varSys:!1,insPart:new Uint8Array(5)},yPlg:[],sc:{showBar:!0,invBar:!1,invDisp:!1,peakHold:1},cs1x:{perfCh:0},kross:{chToggle:!1},sg:{convLastSyll:0,runLineLen:0,maxLineLen:32,splitMask:!1}};#i;get detect(){return structuredClone(this.#i)}#g;#N;#m=100;#_=0;#ae=500;#ue=0;#pe=0;#be=32;#re=!1;#J="";#z=0;#Z=0;#ee=0;#te=!0;#C=0;#Ee=1;#ye;#P=!1;#ge=0;#ne=new Array(y.ch);#H=[];#ie=new Uint8Array(y.ch);#se=new Uint8Array(y.tr);baseBank=new ke("gm2","ns5r","xg","gs","sd","gmega","plg-vl","plg-pf","plg-dx","plg-an","plg-dr","plg-sg","kross","s90es","cs2x","pa");userBank=new ke("gm2");initOnReset=!1;aiEfxName="";polyIndexShrink=!0;polyIndexLatest=0;polyIndexLast=0;chRedir(e,t,i){let c=this;if(c.#se[t])return(c.#se[t]-1)*16+e;if(c.#a===k.sc||c.#a===k.sd){if(i===1)return e;let d=0,h=!0;for(;h;)c.#ie[e+d]===0?(c.#ie[e+d]=t,console.debug(`Assign track ${t} to channel ${e+d+1}.`),h=!1):this.#ie[e+d]===t?h=!1:(d+=16,d>=128&&(d=0,h=!1));return e+d}else return e}getTrackPort(e){return this.chRedir(0,e,!0)>>4}forceVoiceRefresh(){for(let e=0;e<y.ch;e++)this.#u[e]&&this.dispatchEvent("voice",{part:e})}#B=[];#le;#I={nOff:(e,t)=>{let i=e*128+t,c=this.#c.lastIndexOf(i);if(c>-1)if(this.getChCc(e,64)>>6)this.#l[c]=this.NOTE_HELD,this.dispatchEvent("note",{part:e,note:t,velo:this.#h[i],state:this.NOTE_HELD});else if(this.getChCc(e,66)>>6&&this.#l[c]===this.NOTE_SOSTENUTO_SUSTAIN)this.#l[c]=this.NOTE_SOSTENUTO_HELD,this.dispatchEvent("note",{part:e,note:t,velo:this.#h[i],state:this.NOTE_SOSTENUTO_HELD});else{this.#c[c]=0,this.#h[i]=0,this.#l[c]=this.NOTE_IDLE;let d=this.getExt(e)[1];(d===this.VLBC_VELOINIT||d===this.VLBC_VELOALL)&&this.setChCc(e,129,0),this.dispatchEvent("note",{part:e,note:t,velo:0,state:this.NOTE_IDLE})}if(this.#d[e]){for(let d=this.polyIndexLast;d>=0;d--)if(this.#c[d]>>7===e&&this.#l[d]!==0){this.#l[d]===this.NOTE_MUTED_RECOVERABLE&&(this.#l[d]=this.NOTE_SUSTAIN);break}}if(this.polyIndexShrink&&this.polyIndexLast>0){let h=!1,g=this.polyIndexLast-8,b=this.polyIndexLast;for(;b>g&&this.#l[b]===0;b--)h=!0;h&&(this.polyIndexLast=b,this.#l[b+1]!==0&&console.error("Polyphonic slot shrinking edge case."))}},nOn:(e,t,i)=>{let c=e*128+t,d=0;if(this.#d[e])for(let h=0;h<=this.polyIndexLast;h++)this.#c[h]>>7===e&&this.#l[h]!==0&&(this.#l[h]=this.NOTE_MUTED_RECOVERABLE);for(;this.#l[d]>0&&this.#c[d]!==c;)d++;if(d<y.pl){this.#c[d]=c,this.#h[c]=i,this.#l[d]=this.NOTE_SUSTAIN,this.#M[e]<i&&(this.#M[e]=i);let h=this.getExt(e)[1];(h===this.VLBC_VELOINIT||h===this.VLBC_VELOALL)&&this.setChCc(e,129,i),this.dispatchEvent("note",{part:e,note:t,velo:i,state:this.NOTE_SUSTAIN}),this.polyIndexLatest=d+1,d>this.polyIndexLast&&(this.polyIndexLast=d)}else console.error("Polyphony exceeded.")},nAt:(e,t,i)=>{},cAt:(e,t)=>{},hoOf:e=>{this.#l.forEach((t,i)=>{if(t===this.NOTE_HELD){let c=this.#c[i],d=c>>7;e===d&&(this.#l[i]=this.NOTE_IDLE,this.#c[i]=0,this.#h[c]=0,this.dispatchEvent("note",{part:e,note:c&127,velo:0,state:this.NOTE_IDLE}))}})},soOn:e=>{this.#l.forEach((t,i)=>{let c;switch(t){case this.NOTE_ATTACK:{c=this.NOTE_SOSTENUTO_ATTACK;break}case this.NOTE_DECAY:{c=this.NOTE_SOSTENUTO_DECAY;break}case this.NOTE_SUSTAIN:{c=this.NOTE_SOSTENUTO_SUSTAIN;break}}if(c){this.#l[i]=c;let d=this.#c[i];this.dispatchEvent("note",{part:e,note:d&127,velo:this.#h[d],state:c})}})},soOf:e=>{this.#l.forEach((t,i)=>{if(t===this.NOTE_SOSTENUTO_HELD){let c=this.#c[i],d=c>>7;e===d&&(this.#l[i]=this.NOTE_IDLE,this.#c[i]=0,this.#h[c]=0,this.dispatchEvent("note",{part:e,note:c&127,velo:0,state:this.NOTE_IDLE}))}})},ano:e=>{this.#c.forEach(t=>{let i=t>>7,c=t&127;t===0&&this.#h[0]===0||i===e&&this.#I.nOff(i,c)})}};#me={8:function(e){let t=e.channel,i=e.data[0];this.#I.nOff(t,i)},9:function(e){let t=e.channel,i=this;if(i.getChModeId(t)===k.xg&&i.#r[t]>1){let h=i.getChDrumFirstWrite(t);h[0]&&h[1]!==y.invalidCh&&!i.#u[t]&&(i.copyChSetup(h[1],t),i.pushChPrimitives(t),console.debug(`Part CH${t+1} copied from CH${h[1]+1}.`))}i.setChActive(t,1);let c=e.data[0],d=e.data[1];d>0?i.#I.nOn(t,c,d):i.#I.nOff(t,c)},10:function(e){let t=e.channel,i=t*128+e.data[0];this.#c.indexOf(i)>-1&&(this.#h[i]=data[1],this.getExt(t)[1]===this.VLBC_VELOALL&&this.setChCc(t,129,data[1]),this.dispatchEvent("note",{part:t,note:e.data[0],velo:e.data[1],state:this.NOTE_SUSTAIN}))},11:function(e){let t=e.channel,i=this,c=i.#ne[t],d=c[e.data[0]];d&&(e.data[0]=d),[0,32].indexOf(e.data[0])>-1&&(()=>{switch(this.#a){case k.s90es:case k.motif:{if(e.data[0]===0){[0,63].indexOf(e.data[1])>-1&&i.setChActive(t,1);break}e.data[1]&&i.setChActive(t,1);break}default:break}})();let h=t*y.ext,g=i.getChModeId(t);switch(e.data[0]){case 96:return;case 97:return;case 120:return;case 121:{this.#I.ano(t),this.#v[t]=0,i.resetChCc(t,1,0),i.resetChCc(t,5,0),i.resetChCc(t,64,0),i.resetChCc(t,65,0),i.resetChCc(t,66,0),i.resetChCc(t,67,0),i.resetChCc(t,11,127),i.resetChCc(t,101,127),i.resetChCc(t,100,127),i.resetChCc(t,99,127),i.resetChCc(t,98,127);return}case 123:{this.#I.ano(t);return}case 124:{this.#I.ano(t);return}case 125:{this.#I.ano(t);return}case 126:{this.#d[t]=1,this.#I.ano(t);return}case 127:{this.#d[t]=0,this.#I.ano(t);return}}if(v[e.data[0]]===void 0)console.warn(`cc${e.data[0]} is not accepted.`);else{switch(Kt.indexOf(e.data[0])>-1&&this.allocateAce(t,e.data[0]),e.data[0]){case 0:{switch(T()&&console.debug(`${A[this.#a]}, CH${t+1}: ${e.data[1]}`),this.#a===0?e.data[1]<48?(this.#r[t]>0&&(e.data[1]=this.getChPrimitive(t,1,!1),e.data[1]=le.gs[2],console.debug(`Forced channel ${t+1} to stay drums.`)),e.data[1]>0&&(console.debug(`Roland GS detected with MSB: ${e.data[1]}`),this.switchMode("gs"))):e.data[1]===56?this.switchMode(this.#i.x5===82?"x5d":"05rw"):e.data[1]===62?this.switchMode(this.#i.x5===82?"x5d":"05rw"):e.data[1]===63?this.switchMode(A[this.#i.ds]):e.data[1]===64||e.data[1]===127?this.switchMode("xg"):(e.data[1]===120||e.data[1]===121)&&this.switchMode("g2"):this.#a===k.gs||this.#a===k.sc?e.data[1]<56&&this.#r[t]>0&&(e.data[1]=this.getChPrimitive(t,1,!1),e.data[1]=le.gs[2],console.debug(`Forced channel ${t+1} to stay drums.`)):this.#a===k.gm&&(e.data[1]<48?this.#r[t]>0&&(e.data[1]=le.gs[2],this.switchMode("gs",!0),console.debug(`Forced channel ${t+1} to stay drums.`)):(e.data[1]===64||e.data[1]===127)&&this.switchMode("xg",!0)),this.#a){case k.xg:{[79,95,126,127].indexOf(e.data[1])>-1?this.#r[t]===0&&(this.setChType(t,this.CH_DRUM2),console.debug(`CH${t+1} set to drums by MSB.`)):this.#r[t]>0&&(this.setChType(t,this.CH_MELODIC),console.debug(`CH${t+1} set to melodic by MSB.`)),[33,81,97].indexOf(e.data[1])>-1?this.#x[h]=this.EXT_VL:[35,67,83,99].indexOf(e.data[1])>-1?this.#x[h]=this.EXT_DX:this.#x[h]=this.EXT_NONE;break}case k["05rw"]:case k.x5d:case k.ns5r:{[61,62,126,127].indexOf(e.data[1])>-1?this.#r[t]===this.CH_MELODIC&&(this.setChType(t,this.CH_DRUM2),console.debug(`CH${t+1} set to drums by MSB.`)):[80,81,82,83].indexOf(e.data[1])>-1||this.#r[t]!==this.CH_MELODIC&&(this.setChType(t,this.CH_MELODIC),console.debug(`CH${t+1} set to melodic by MSB.`));break}case k.sd:{[104,105,106,107,120].indexOf(e.data[1])>-1?this.#r[t]===0&&(this.setChType(t,this.CH_DRUM2),console.debug(`CH${t+1} set to drums by MSB.`)):this.#r[t]>0&&(this.setChType(t,this.CH_MELODIC),console.debug(`CH${t+1} set to melodic by MSB.`));break}case k.g2:{e.data[1]===120?this.#r[t]===0&&(this.setChType(t,this.CH_DRUMS),console.debug(`CH${t+1} set to drums by MSB.`)):this.#r[t]>0&&(this.setChType(t,this.CH_MELODIC),console.debug(`CH${t+1} set to melodic by MSB.`));break}}break}case 2:{this.getExt(t)[1]===this.VLBC_BRTHEXPR&&this.setChCc(t,129,e.data[1]);break}case 6:{if(this.#O[t]){[k.xg,k.gs,k.sc,k.ns5r].indexOf(this.#a)<0&&console.warn(`NRPN commits are not available under "${A[this.#a]}" mode, even when they are supported in Octavia.`);let b=this.getChCc(t,99),m=this.getChCc(t,98);if(b===1){let C=Ft.indexOf(m);if(C>-1)this.setChCc(t,71+C,e.data[1]),T()&&console.debug(`Redirected NRPN 1 ${m} to cc${71+C}.`),this.dispatchEvent("cc",{part:t,cc:71+C,data:e.data[1]});else{let a=Ae.indexOf(m);a>-1?this.#Q[t*10+a]=e.data[1]-64:console.warn(`NRPN 0x01${m.toString(16).padStart(2,"0")} is not supported.`),T()&&console.debug(`CH${t+1} voice NRPN ${m} commit`)}}else{if(pe.indexOf(b)<0){let a=`NRPN 0x${b.toString(16).padStart(2,"0")}${m.toString(16).padStart(2,"0")} `;console.warn(b===127?`${a}is not necessary. Consider removing it.`:`${a}is not supported.`)}else{let a=this.#r[t]-2;a<0?console.warn(`CH${t+1} cannot accept drum NRPN as type ${se[this.#r[t]]}.`):this.#A[(a*y.dpn+X[b])*y.dnc+m]=e.data[1]}T()&&console.debug(`CH${t+1} (${se[this.#r[t]]}) drum NRPN ${b} commit`)}}else{let b=he[this.getChCc(t,100)],m=st[this.getChCc(t,100)];if(this.getChCc(t,101)===0&&b!==void 0)switch(T()&&console.debug(`CH${t+1} RPN 0 ${this.getChCc(t,100)} commit: ${e.data[1]}`),e.data[1]=Math.min(Math.max(e.data[1],nt[b][0]),nt[b][1]),this.#s[t*y.rpn+b]=e.data[1],this.#o[t*y.rpnt+m]=1,g){case k.xg:case k.gs:case k.sc:case k.mt32:case k.s90es:case k.motif:case k.cs1x:case k.cs6x:{switch(this.getChCc(t,100)){case 1:case 2:{this.dispatchEvent("pitch",{part:t,pitch:this.getPitchShift(t)});break}}break}default:this.dispatchEvent("pitch",{part:t,pitch:this.getPitchShift(t)})}}break}case 32:{switch(T()&&console.debug(`${A[this.#a]}, CH${t+1} LSB: ${e.data[1]}`),this.#a){case k.s90es:case k.motif:{this.setChType(t,[32,40].indexOf(e.data[1])>-1?this.CH_DRUMS:this.CH_MELODIC,this.#a,!0);break}}this.getExt(t)[0],this.EXT_DX;break}case 38:{if(!this.#O[t]){let b=he[this.getChCc(t,100)],m=st[this.getChCc(t,100)];this.getChCc(t,101)===0&&b!==void 0&&(this.#s[t*y.rpn+b+1]=e.data[1],this.#o[t*y.rpnt+m]=1)}break}case 64:{e.data[1]<64&&this.#I.hoOf(t);break}case 66:{e.data[1]>>6?this.#I.soOn(t):this.#I.soOf(t);break}case 98:case 99:{this.#O[t]=1;break}case 100:case 101:{this.#O[t]=0;break}}this.setChCc(t,e.data[0],e.data[1]),this.dispatchEvent("cc",{part:t,cc:e.data[0],data:e.data[1]})}i.getChModeId(t)===k.xg&&i.#r[t]&&i.setDrumFirstWrite(t)},12:function(e){let t=e.channel,i=this;switch(i.#a){case k.s90es:case k.motif:{e.data&&i.setChActive(t,1);break}default:i.setChActive(t,1)}let c=M[t];switch(i.getExt(t)[0]){case i.EXT_VL:break}i.#n[t]=e.data,i.#L[t]=0,i.pushChPrimitives(t),T()&&console.debug(`T:${e.track} C:${t} P:${e.data}`),i.getChModeId(t)===k.xg&&i.#r[t]&&i.setDrumFirstWrite(t)},13:function(e){let t=this,i=e.channel;this.#c.forEach(function(c){let d=c>>7;i===d&&(t.#h[c]=e.data,t.dispatchEvent("note",{part:i,note:c&127,velo:e.data,state:t.NOTE_SUSTAIN}))})},14:function(e){let t=e.channel;this.#v[t]=e.data[1]*128+e.data[0]-8192,this.dispatchEvent("pitch",{part:t,pitch:this.getPitchShift(t)})},15:function(e){Wt(e.data).forEach(t=>{let i=t[0],c=t[1];this.#ge=t.length,(this.#we[i]||function(){console.debug(`Unknown manufacturer ${i}.`)})(c,t.subarray(2),e.track)})},248:function(e){},250:function(e){},251:function(e){},252:function(e){},254:function(e){},255:function(e){(this.#B[e.meta]||function(i,c,d){}).call(this,e.data,e.track,e.meta),e.meta!==32&&(this.#_=0);let t=Gt.indexOf(e.meta)>-1;if(T()&&console.debug(e),t)return e.reply="meta",e}};#we={64:(e,t,i)=>{this.#fe.run(t,i,e)},65:(e,t,i)=>{if(t[0]<16)if(t[1]===72){let c=t[t.length-1],d=Q(t.subarray(3,t.length-1));c===d?this.#F.run(t.subarray(0,t.length-1),i,e):console.warn(`Bad SD checksum ${c} - should be ${d}.`)}else this.#F.run(t,i,e);else{let c=t[t.length-1],d=Q(t.subarray(2,t.length-1));c===d?this.#F.run(t.subarray(0,t.length-1),i,e):console.warn(`Bad GS checksum ${c} - should be ${d}.`)}},66:(e,t,i)=>{this.#q.run(t,i,e)},67:(e,t,i)=>{switch(e>>4){case 0:{let c=0;for(;t[c]===127&&c<4;)c++;let d=t[1+c]<<7|t[2+c];if(d+7+c!==t.length){console.warn(`Yamaha bulk dump length mismatch! Expected ${t.length-7-c}, received ${d}.`),console.debug(t);break}let h=Q(t.subarray(1+c,t.length-1)),g=t[t.length-1];if(t[t.length-1]>>7)console.warn(`Yamaha bulk dump checksum invalid! Expected ${h}, received ${g}:
`),console.debug(t);else if(h!==g)console.warn(`Yamaha bulk dump checksum mismatch! Expected ${h}, received ${g}:
`),console.debug(t);else{let b=t.slice(2,t.length-1);for(let m=0;m<=c;m++)b[m]=t[m];this.#D.run(b,i,e&15)}break}case 1:{this.#D.run(t,i,e&15);break}case 2:{console.warn("Octavia doesn't yet support Yamaha bulk dump requests.");break}case 3:{console.warn("Octavia doesn't yet support Yamaha parameter requests.");break}case 7:{switch(e&15){case 14:{let c=new Uint8Array(t.length+1);c[0]=126,c.set(t,1),this.#D.run(c,i,0);break}default:console.warn(`Unknown Yamaha special SysEx type: ${e}.`)}break}default:console.warn(`Unknown Yamaha SysEx type: ${e>>4}.`)}},68:(e,t,i)=>{this.#he.run(t,i,e)},71:(e,t,i)=>{this.#de.run(t,i,e)},126:(e,t,i)=>{this.#ce.run(t,i,e)},127:(e,t,i)=>{this.switchMode("gm"),this.#oe.run(t,i,e)}};#ce;#oe;#D;#F;#q;#fe;#de;#he;buildRchTree(){let e=[];this.#f.forEach((t,i)=>{t<y.ch&&(e[t]?.constructor||(e[t]=[]),e[t].push(i))}),this.#ye=e}buildRccMap(){let e=this;for(let t=0;t<y.ch;t++)e.#ne[t]={};e.#G.forEach((t,i)=>{t&&(e.#ne[Math.floor(i/y.redir)][t]=i%y.redir|128)}),T()&&console.debug(e.#ne)}invokeSysExIndicator(){this.dispatchEvent("mupromptex",this.#ge)}getActive(){return this.#u}getChActive(e){return this.#u[e]}getCc(e){if(typeof e!="number"||e<0||e>=y.ch)throw new RangeError(`Invalid part number: CH${e+1}`);let t=this,i=M[e];return t.#e.subarray(i,i+y.cc)}getChCc(e,t){let i=this;if(j.indexOf(t)<0)throw new Error("CC number not accepted");return i.#e[M[e]+v[t]]}getChCcWritten(e,t){let i=this;if(j.indexOf(t)<0)throw new Error("CC number not accepted");return i.#e[y.chcc+M[e]+v[t]]}setChCc(e=0,t,i){let c=this;if(j.indexOf(t)<0)throw new Error("CC number not accepted");if(i?.constructor!==Number)throw new TypeError("Expected numbers for value");let d=i&255,h=M[e]+v[t];c.#e[h]=d,c.#e[h+y.chcc]=1,c.dispatchEvent("cc",{part:e,cc:t,data:d})}getCcAll(){return this.#e.slice()}resetCc(e){let t=this,i=M[e]+y.chcc;t.#e.fill(0,i,i+y.cc)}resetChCc(e,t,i){let c=this;i?.constructor&&c.setChCc(e,t,i),c.#e[M[e]+v[t]+y.chcc]=0}resetCcAll(){this.#e.fill(0,y.chcc,y.chcc<<1)}isChCcWritten(e,t){if(j.indexOf(t)<0)throw new Error("CC number not accepted");return upThis.#e[M[e]+v[t]+y.chcc]}getChSource(){return this.#f}getChType(e=0){return this.#r[e]}getChTypes(){return this.#r}setChType(e,t,i=0,c=!1){t&=15;let d=this;i=i||d.getChModeId(e),d.#r[e]=t,t>0&&!c&&(d.setChCc(e,0,d.#p[i][2]),d.pushChPrimitives(e))}setChActive(e,t=0){this.#u[e]!==t&&this.dispatchEvent("channeltoggle",{part:e,active:t}),this.#u[e]=t}getExt(e){let t=y.ext*e,i=this.#x.subarray(t,t+y.ext),c=new Uint8Array(i.length);return c.set(i),c[1]=c[1]||this.#Ee,c}getPitch(){return this.#v}getProgram(){return this.#n}getTexts(){return this.#H.slice()}getVel(e){let t=new Map,i=this;return i.#c.forEach(function(c,d){let h=c>>7,g=c&127;e===h&&i.#h[c]>0&&t.set(g,{v:i.#h[c],s:i.#l[d]})}),t}getBitmap(){return{bitmap:this.#$,expire:this.#S}}getLetter(){return{text:this.#J,set:this.#Z,expire:this.#z}}getMode(){return A[this.#a]}getMaster(){return{volume:this.#m}}getRpn(){return this.#s}getNrpn(){return this.#Q}getSubDb(){return self?.structuredClone(this.#p)}getDetect(){return self?.structuredClone(this.#i)}getVoice(e,t,i,c="?"){let d=this;k[c]?.constructor||(c="?");let h=k[c],g=e||d.#p[h][0],b=t,m=i||d.#p[h][1];g===K.bank0&&(g=0),m===K.bank0&&(m=0),c==="ns5r"&&g>0&&g<56&&(m=3);let C=d.userBank.get(g,b,m,c);if(c==="mt32"&&C.name.indexOf("MT-m:")===0){let a=parseInt(C.name.slice(5)),n=a*y.cmt,s="";d.#t.subarray(n,n+10).forEach(l=>{l>31&&(s+=String.fromCharCode(l))});let r=`MSB	LSB	PRG	NME
49	127	${b}	${s}`;d.userBank.load(r,!0),C.name=s,C.ending=" "}return(C.ending!==" "||!C.name.length)&&(C=d.baseBank.get(g,b,m,c)),C}getChPrimitive(e,t,i){if(t>=y.vxPrim||t?.constructor!==Number)throw new RangeError(`Invalid voice primitive component "${t}"`);if(typeof e!="number"||e<0||e>=y.ch)throw new RangeError(`Invalid part number: CH${e+1}`);let c=this,d=c.#n[t<<y.chShift|e];switch(t){case 1:case 2:{c.getChCcWritten(e,[255,0,32][t])||(d=d||c.#p[c.getChModeId(e)][t+2]),i&&(d=d||c.#p[c.getChModeId(e)][t-1]),d===K.bank0&&(d=0);break}}return d}getChPrimitives(e,t){let i=this,c=new Uint8Array(3);return c[1]=i.#n[e],c[0]=i.getChPrimitive(e,1,t),c[2]=i.getChPrimitive(e,2,t),c}pushChPrimitives(e){let t=this;t.#n[1<<y.chShift|e]=t.getChCc(e,0),t.#n[2<<y.chShift|e]=t.getChCc(e,32),t.dispatchEvent("voice",{part:e})}getChCvnBuffer(e,t=y.cvn){if(t>y.cvn||t<1)throw new RangeError("Invalid custom voice name buffer length");let i=ee[e];return this.#W.subarray(i,i+t)}getChCvnRegister(e,t){if(t>=y.cvn||t<0)throw new RangeError("Invalid custom voice name register");return this.#W[ee[e]+t]}setChCvnRegister(e,t,i=32){if(t>=y.cvn||t<0)throw new RangeError("Invalid custom voice name register");this.#X[e]=1,this.#W[ee[e]+t]=Math.max(32,i&255)}resetChCvn(e){this.#W.fill(32,ee[e],ee[e]+y.cvn),this.#X[e]=0}getChCvnString(e,t){let i=zt.decode(this.getChCvnBuffer(e));return t||(i=i.trimEnd()),i}getChCvnIsWritten(e){return this.#X[e]}getChVoice(e){let t=this,i=t.getVoice(...t.getChPrimitives(e),t.getChMode(e));if(t.#L[e]){let c="";switch(t.#a){case k.mt32:{t.#w.subarray(y.cmt*(e-1),y.cmt*(e-1)+10).forEach(d=>{c+=String.fromCharCode(Math.max(d,32))}),c=c.trimEnd();break}default:c=t.getChCvnString(e)}c.length&&(i.ending="~",i.name=c)}return i}getRawPitch(){return this.#v}getPitchShift(e){let t=this,i=e*y.rpn,c=t.#s[i];return t.#o[e*y.rpnt]?c>>7&&(c-=256):t.#a===k.mt32&&(c=12),t.#v[e]/8192*c+(t.#s[i+3]-64)+((t.#s[i+1]<<7)+t.#s[i+2]-8192)/8192}getEffectType(e=0){let t=3*e+1;return this.#R.subarray(t,t+2)}getPolyState(e=0){return this.#l[e]}setEffectTypeRaw(e=0,t,i){let c=3*e;this.#R[c]=1,this.#R[c+1+ +t]=i}setEffectType(e=0,t,i){this.setEffectTypeRaw(e,!1,t),this.setEffectTypeRaw(e,!0,i)}pushEffectType(e=0,t=!1){if(e<0||e>=y.efx)throw new RangeError(`Invalid EFX slot ${e}`);let i=this.getEffectType(e);t||i[0]===0&&i[1]>>4===15&&(t=!0),this.dispatchEvent(`efx${ce[e]}`,{id:i,hidden:t})}getEffectSink(){return this.#Y}getChEffectSink(e){return this.#Y[e]}setChEffectSink(e,t=0){let i=this;if(t<0||t>=y.efx)throw new RangeError(`Invalid EFX slot ${t}`);if(e<0||e>=y.ch)throw new RangeError(`Invalid CH${e+1}`);this.#Y[e]=t,this.dispatchEvent("partefxtoggle",{part:e,active:t})}setXgChEffectSink(e,t=0){let i=this,c=i.modelEx.xg,d=t-2;if(t<0||d>=c.insPart.length)throw new RangeError(`Invalid XG insertion slot ${d}`);let h=c.insPart[d];c.insPart[d]=e,h!==y.invalidCh&&i.setChEffectSink(h,0),e===y.invalidCh?h!==y.invalidCh&&i.setChEffectSink(h,0):i.setChEffectSink(e,t)}setLetterDisplay(e,t,i=0,c=3200){let d=this,h;d.#J=" ".repeat(i),e.forEach(g=>{d.#J+=String.fromCharCode(g>31?g:32),g<32&&(h=h||new Set,h.add(g))}),d.#Z=Date.now(),d.#z=Date.now()+c,d.dispatchEvent("letter"),h&&(h=Array.from(h),h.forEach((g,b,m)=>{m[b]=g.toString(16).padStart(2,"0")}),console.warn(`${t}${t?" ":""}invalid code point${h.length>1?"s":""}: 0x${h.join(", 0x")}`))}setDetectionTargets(e="?",t=0){let i=this,c=-1;switch(e.replaceAll(", ",",").split(",").forEach(d=>{d=d.toLowerCase();let h=A.indexOf(Xt[d]||d);T()&&console.debug(`Mapped mode "${d}" to ID "${h}".`),h>-1&&(c=h)}),T()&&console.debug(`Set detection target to ID "${c}".`),c>0&&(i.#i.x5=82,i.#i.ds=k.krs,i.#i.gm=k.gm,i.#i.g2=k.g2),c){case k["05rw"]:{i.#i.x5=81;break}case k.s90es:{i.#i.ds=k.s90es,i.#i.smotif=k.s90es;break}case k.motif:{i.#i.ds=k.motif,i.#i.smotif=k.motif;break}case k.sd:{i.#i.g2=k.sd;break}case k.pa:{i.#i.g2=k.pa;break}}}setGsTargets(e=!1,t=4){if(!t)t=e?3:4;else{if(t>4||t<0)throw new Error(`Invalid GS level ${t}`);if(e&&t>>1!==1)throw new Error(`Invalid SC level ${t}`)}let i=this;i.#i[e?"sc":"gs"]=t,i.#p[k[e?"sc":"gs"]][1]=t,i.forceVoiceRefresh()}getConfigs(){return this.#N}setDumpLimit(e){if(e>2||e<0)throw new RangeError("Invalid dump limit.");this.#g.dumpLimit=e}allocateAce(e=0,t){let i=this;if(!t||t<128&&t>95){console.warn(`cc${t} cannot be allocated as an active custom effect.`);return}let c=!0,d=0,h=y.ace*e;for(;c&&d<y.ace;)i.#y[d+h]===t?c=!1:i.#y[d+h]||(c=!1,i.#y[d+h]=t,console.debug(`Allocated cc${t} to ACE slot ${d} in CH${e+1}.`)),d++;d>=y.ace&&console.warn(`ACE slots are full in CH${e+1}.`)}allocateAceAll(e){let t=this;if(!e||e<128&&e>95){console.warn(`cc${e} cannot be allocated as an active custom effect.`);return}for(let i=0;i<y.ch;i++){let c=!0,d=0,h=y.ace*i;for(;c&&d<y.ace;)t.#y[d+h]===e?c=!1:t.#y[d+h]||(c=!1,t.#y[d+h]=e),d++;d>=y.ace&&console.warn(`ACE slots are full in CH${i+1}.`)}}resetAce(){this.#y.fill(0),console.info("All ACE slots have been reset.")}resetChAceAll(e=0){this.#y.subarray(ue[e],ue[e]+y.ace).fill(0)}resetChAce(e=0,t){let i=!0,c=ue[e],d=c+y.ace;for(;i&&c<d;)this.#y[c]===t&&(this.#y[c]=0,i=!1),c++;i&&T()&&console.debug(`No ACE slot was allocated to cc${t} in CH${e+1}.`)}getAce(){return this.#y}getChAce(e=0,t=0){if(t<0||t>=y.ace)throw new RangeError("No such ACE slot");let i=this.#y[y.ace*e+t];if(i){if(j.indexOf(i)>=0)return this.getChCc(e,i);throw new Error(`Invalid ACE source in CH${e+1}: ${i}`)}else return 0}initDrums(){let e=this;e.#A.fill(64);for(let t=0;t<y.drm;t++){let i=t*y.dpn;for(let c in lt){let d=lt[c],h=(i+X[c])*y.dnc;e.#A.subarray(h,h+y.dnc).fill(d)}}}init(e=0){let t=this;t.#_=0,t.#p[k.xg][1]=0,t.dispatchEvent("banklevel",{mode:"xg",data:0}),t.#u.fill(0),t.#e.fill(0),t.#y.fill(0),t.#n.fill(0),t.#h.fill(0),t.#c.fill(0),t.#l.fill(0),t.#d.fill(0),t.#M.fill(0),t.#v.fill(0),t.#Q.fill(0),t.#o.fill(0),t.#x.fill(0),t.#k.fill(0),t.#K.fill(0),t.#E.fill(0),t.#G.fill(0),t.#m=100,t.#H=[],t.#ae=500,t.modelEx.sg.convLastSyll=0,t.modelEx.sg.runLineLen=0,t.modelEx.sg.splitMask=!1,t.#S=0,t.#b=0;for(let i=0;i<t.#T.length;i++)t.#$.fill(0);t.#C=t.KARAOKE_NONE,t.#ee=0,t.#te=!0,t.#P=!1,t.#ge=0,t.initDrums(),t.polyIndexLatest=0,t.polyIndexLast=0,t.#f.forEach(function(i,c,d){d[c]=c}),e===0&&(t.dispatchEvent("mode","?"),t.#a=0,t.#ie.fill(0),t.#se.fill(0),t.#z=0,t.#J=""),Ht.forEach(i=>{t.setChCc(i,0,t.#p[t.getChModeId(i)][2])}),t.#r.fill(t.CH_MELODIC),t.#r[9]=t.CH_DRUM1,t.#r[25]=t.CH_DRUM3,t.#r[41]=t.CH_DRUMS,t.#r[57]=t.CH_DRUMS,t.#r[73]=t.CH_DRUM5,t.#r[89]=t.CH_DRUM7,t.#r[105]=t.CH_DRUMS,t.#r[121]=t.CH_DRUMS;for(let i=0;i<y.drm;i++)t.#V[i<<1]=0,t.#V[i<<1|1]=y.invalidCh;t.#j.fill(0),t.#t.fill(0),t.#U.fill(0),t.#w.fill(0),t.#L.fill(0),t.#R.fill(0),t.#Y.fill(0),t.aiEfxName="",t.userBank.clearRange({msb:0,lsb:127,prg:[0,127]}),t.modelEx.xg.varSys=!1,t.modelEx.xg.insPart.fill(y.invalidCh);for(let i=0;i<G.length;i++){let c=t.modelEx.yPlg[i];c.fill(0,0,G[i][2]),c.fill(y.invalidCh,G[i][2])}t.modelEx.sc.showBar=!0,t.modelEx.sc.invBar=!1,t.modelEx.sc.invDisp=!1,t.modelEx.sc.peakHold=1,t.modelEx.cs1x.perfCh=0;for(let i=0;i<y.ch;i++){t.resetChCvn(i);let c=M[i];t.#e[c+v[7]]=100,t.#e[c+v[11]]=127,t.#e[c+v[2]]=127,t.#e[c+v[10]]=64,t.#e.subarray(c+v[71],c+v[71]+8).fill(64),t.#e[c+v[128]]=127,t.#e.subarray(c+v[130],c+v[157]+1).fill(64),t.#e[c+v[91]]=40,t.#e[c+v[101]]=127,t.#e[c+v[100]]=127,t.#e[c+v[99]]=127,t.#e[c+v[98]]=127;let d=i*y.rpn;t.#s[d]=2,t.#s[d+1]=64,t.#s[d+2]=0,t.#s[d+3]=64,t.#s[d+4]=0,t.#s[d+5]=0;let h=i*y.ext;t.#x[h+1]=t.VLBC_BRTHEXPR;let g=i*y.redir;t.#G[g+8]=13}t.buildRchTree(),t.buildRccMap(),t.dispatchEvent("mastervolume",t.#m);for(let i=0;i<ce.length;i++)t.pushEffectType(i);t.dispatchEvent("reset"),t.switchMode("?")}setChMode(e,t){let i=this;if(typeof e!="number"||e<0||e>=y.ch)throw new RangeError(`Invalid part number: CH${e+1}`);if(e<0||t>=A.length)throw new RangeError(`Invalid mode ID ${t}`);i.#E[e]=t,i.dispatchEvent("chmode",{part:e,id:t,mode:A[t]}),i.pushChPrimitives(e)}getChMode(e,t){return A[this.getChModeId(e,t)]}getChModeId(e,t){return t?this.#E[e]||this.#k[e>>4]:this.#E[e]||this.#k[e>>4]||this.#a}getPortMode(e,t){return A[this.getPortModeId(e,t)]}getPortModeId(e,t){return t?this.#k[e]:this.#k[e]||this.#a}setPortMode(e,t,i){let c=this;if(e<0||e>=y.ch>>4)throw new RangeError(`Invalid port ${e+1}`);if(t<1)throw new RangeError("Range must be a positive integer");if(e+t>=y.ch>>4)throw new RangeError("Range must be in bound");if(e<0||i>=A.length)throw new RangeError(`Invalid mode ID ${i}`);c.#K[e]=i;for(let d=e;d<e+t;d++){let h=c.#K[d];if(t>1&&h!==0&&h!==i)break;c.#k[d]=i;for(let g=d<<4;g<d+1<<4;g++)c.dispatchEvent("chmode",{part:g,id:i,mode:A[i]}),c.pushChPrimitives(g)}}copyChSetup(e,t,i){if(e===t){console.warn(`Failed attempt at overwriting CH${e+1} with its own data.`);return}let c=this;if(i&&c.#u[t]){console.warn(`Failed attempt at copying setup data from CH${e+1} to CH${t+1}.`);return}let d=M[e],h=M[t];c.#n[t]=c.#n[e],c.#e.set(c.#e.subarray(d,d+y.cc),h),c.pushChPrimitives(t)}setDrumFirstWrite(e,t){let i=this,c=i.#r[e];if(c<2)return;let d=c-2;if(i.#V[d<<1])if(t)i.#V[d<<1]=0,T()&&console.debug(`First write part for drum set ${d+1} has been reset.`);else return;else t?console.warn(`First write part for drum set ${d+1} is already blank.`):(i.#V[d<<1]=1,i.#V[d<<1|1]=e,console.debug(`First write part for drum set ${d+1} is set to CH${e+1}.`))}getChDrumFirstWrite(e){let t=this,i=t.#r[e];if(i<2)return;let c=i-2;return t.#V.subarray(c<<1,c+1<<1)}getDrumFirstWrite(e){if(e>=0&&e<y.drm)return this.#V.subarray(e<<1,e+1<<1)}switchMode(e,t=!1,i=!1){let c=this,d=k[e];if(d>-1){if(c.#a===0||t){switch(c.initOnReset&&t&&c.init(1),c.#b=0,d){case k.gm:{d=c.#i.gm;break}case k.g2:{d=c.#i.g2;break}}switch(c.#a=d,d){case k.gs:case k.sc:{c.#p[k[e]][1]=c.#i[e];break}}for(let b=0;b<y.ch;b++){let m=c.getChModeId(b,!0);c.#r[b]>0&&m===k["?"]&&(c.setChCc(b,0,c.#p[d][2]),T()&&console.debug(`CH${b+1} (${c.#r[b]}) (${c.getChMode(b)}), ${A[m]} (${c.#p[m][2]}) -> ${A[d]} (${c.#p[d][2]})`),c.pushChPrimitives(b))}switch(d){case k.mt32:{Te.forEach((b,m)=>{let C=m+1;c.#u[C]||(c.#n[C]=b,c.setChCc(C,91,127),c.pushChPrimitives(C))});for(let b=1;b<10;b++)c.pushChPrimitives(b);break}}let h,g;switch(d){case k["?"]:case k.g2:{h=[52,4,52,18,0,255,0,255,0,255,0,255,0,255,0,255];break}case k.xg:case k.cs1x:{h=[1,0,65,0,5,0,64,0,64,0,64,0,64,0,0,255],g=[64,0];break}case k.gm:case k.gs:case k.sc:{h=[40,4,40,18,40,32,32,0,0,255,0,255,0,255,0,255],g=[32,0];break}case k.sd:{h=[58,0,60,0,61,0,61,0],g=[61,0];break}case k["05rw"]:case k.x5d:case k.ns5r:{h=[44,1,44,19,0,255,0,255,0,255,0,255,0,255,0,255];break}case k.k11:case k.sg:{h=[24,0,0,255,0,255,0,255,0,255,0,255,0,255,0,255];break}case k.mt32:{h=[40,4,0,255,0,255,0,255,0,255,0,255,0,255,0,255];break}case k.doc:{h=[24,16,0,255,0,255,0,255,0,255,0,255,0,255,0,255];break}case k.motif:case k.s90es:case k.cs6x:{h=[129,0,133,0,130,0,128,0,128,0,0,255,0,255,0,255],g=[128,0];break}case k.pa:{h=[28,52,28,16,28,0,28,0,0,255,0,255,0,255,0,255],g=[28,0];break}case k.krs:{h=[45,0,45,0,0,255,45,0,45,0,45,0,45,0,45,0],g=[45,0];break}default:h=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]}for(let b=0;b<y.efx;b++)if(!c.#R[3*b]&&typeof h[b<<1]=="number"){c.#R[3*b+1]=h[b<<1],c.#R[3*b+2]=h[b<<1|1];let m=!1;g?.length>0&&h[b<<1]===g[0]&&h[b<<1|1]===g[1]&&(m=!0),c.pushEffectType(b,m)}i&&c.setDetectionTargets(e),c.dispatchEvent("mode",A[d]),c.forceVoiceRefresh()}}else throw new Error(`Unknown mode ${e}`)}getRawStrength(){let e=this;return this.#c.forEach(function(t){let i=t>>7;e.#h[t]>e.#M[i]&&(e.#M[i]=e.#h[t])}),this.#M}getStrength(){let e=[],t=this;return this.getRawStrength().forEach(function(i,c){e[c]=Math.floor(i*t.getChCc(c,7)*t.getChCc(c,11)*t.#m/803288)}),e}newStrength(){this.#M.fill(0)}runJson(e){if(e.type>14)return e.type===15&&e.data.constructor!==Uint8Array&&(e.data=Uint8Array.from(e.data)),this.#me[e.type].call(this,e);{let t=this.chRedir(e.part,e.track),i=!1;this.#ye[t]?.forEach(c=>{e.channel=c,i=!0,this.#me[e.type].call(this,e)}),i||console.warn(`${rt[e.type]?rt[e.type]:e.type}${[11,12].includes(e.type)?(e.data[0]!==void 0?e.data[0]:e.data).toString():""} event sent to CH${t+1} without any recipient.`)}this.#H.length>100&&this.#H.splice(100,this.#H.length-99)}runRaw(e){}async loadBank(e,t){let i=this;switch(e=e.toLowerCase(),e){case"s7e":{i.userBank.clearRange({msb:63,lsb:[21,22]}),i.userBank.clearRange({msb:63,lsb:[24,27]});break}case"pcg":{i.userBank.clearRange({msb:63,lsb:[6,9]}),i.userBank.clearRange({msb:63,lsb:[13,16]});break}default:throw new Error(`Unknown bank format ${e}`)}switch(e){case"s7e":case"pcg":{ie.context=this,await i.userBank.load(await ie.read(e,t),!1);break}}i.forceVoiceRefresh()}constructor(){super();let e=this;for(let a=0;a<10;a++)e.#T[a]=new Uint8Array(256);e.#T[10]=new Uint8Array(512),e.#le=new _,e.#i={x5:82,ds:k.krs,smotif:k.s90es,gs:4,sc:3,gm:k.gm,g2:k.g2},e.#g={dumpLimit:e.DUMP_MODE},e.#N=new Proxy(e.#g,{set:()=>{}});for(let a in le){let n=k[a];n===void 0?console.debug(`SubDB build error: "${a}" does not exist`):e.#p[n]=new Uint8Array(le[a])}for(let a of G)e.modelEx.yPlg.push(new Uint8Array(a[1]));e.userBank.strictMode=!0,e.userBank.load(`MSB	PRG	LSB	NME
062	000	000	
122	000	000	
122	001	000	
122	002	000	
122	003	000	
122	004	000	
122	005	000	
122	006	000	`),e.addEventListener("metacommit",function(a){let{data:n}=a;e.#H[0]?.type===n.type&&e.#H[0]?.amend?(e.#H[0].amend=n.amend,e.#H[0].data+=n.data):e.#H.unshift(n)}),e.#B[1]=function(a){switch(a=a.replaceAll(`\r
`,`
`).replaceAll("\r",`
`),a.substring(0,2)){case"@I":{e.#C=e.KARAOKE_TEXT,e.dispatchEvent("metacommit",{type:"Kar.Info",data:a.substring(2)?.trimStart()});break}case"@K":{e.#C=e.KARAOKE_TEXT;let n=a.substring(2);n!=="MIDI KARAOKE FILE"&&e.dispatchEvent("metacommit",{type:"Kar.Mode",data:n?.trimStart()}),console.debug(`Karaoke mode active: ${n}`);break}case"@L":{e.#C=e.KARAOKE_TEXT,e.dispatchEvent("metacommit",{type:"Kar.Lang",data:a.substring(2)?.trimStart()});break}case"@T":{e.#C=e.KARAOKE_TEXT,e.dispatchEvent("metacommit",{type:"KarTitle",data:a.substring(2)?.trimStart()});break}case"@V":{e.#C=e.KARAOKE_TEXT,e.dispatchEvent("metacommit",{type:"Kar.Ver.",data:a.substring(2)?.trimStart()});break}case"Mi":{if(a.substring(2,16)==="dStamp-1.00: 0"){let n=a.length;for(let r=a.length;r>0;r--)if((a.charCodeAt(r-1)>>5)+1>>1===1){n=r;break}let s=a.substring(16,n);e.dispatchEvent("metacommit",{type:"MidStamp",data:it(s)})}else a.split(`
`).forEach((n,s)=>{e.dispatchEvent("metacommit",{type:"Cmn.Text",data:n,mask:s!==0})});break}case"XF":{let n=a.slice(2).split(":");switch(n[0]){case"hd":{n.slice(1).forEach((s,r)=>{s.length&&e.dispatchEvent("metacommit",{type:["XfSngDte","XfSngRgn","XfSngCat","XfSongBt","XfSngIns","XfSngVoc","XfSngCmp","XfSngLrc","XfSngArr","XfSngPer","XfSngPrg","XfSngTag"][r],data:s})});break}case"ln":{n.slice(1).forEach((s,r)=>{s.length&&e.dispatchEvent("metacommit",{type:["XfKarLng","XfKarNme","XfKarCmp","XfKarLrc","XfKarArr","XfKarPer","XfKarPrg"][r],data:s})});break}default:e.dispatchEvent("metacommit",{type:"XfUnData",data:a})}break}default:switch(e.#C){case e.KARAOKE_TEXT:{switch(a[0]){case"\\":{e.dispatchEvent("metacommit",{type:"KarLyric",data:"",amend:!1}),e.dispatchEvent("metacommit",{type:"KarLyric",data:a.substring(1),amend:!0});break}case"/":{e.dispatchEvent("metacommit",{type:"KarLyric",data:"",mask:!0,amend:!1}),e.dispatchEvent("metacommit",{type:"KarLyric",data:a.substring(1),mask:!0,amend:!0});break}default:e.dispatchEvent("metacommit",{type:"KarLyric",data:a,amend:!0})}break}default:a.split(`
`).forEach((n,s)=>{e.dispatchEvent("metacommit",{type:"Cmn.Text",data:n,mask:s!==0})})}}},e.#B[2]=function(a){e.dispatchEvent("metacommit",{type:"Copyrite",data:a})},e.#B[3]=function(a,n){n<1&&e.#_<1&&e.dispatchEvent("metacommit",{type:"TrkTitle",data:a})},e.#B[4]=function(a,n){e.dispatchEvent("metacommit",{type:"Instrmnt",data:a})},e.#B[5]=function(a){switch(e.#C){case e.KARAOKE_XF:{let n="";for(let s of a)switch(s){case"^":case"%":{n+=" ";break}case">":{n+="	";break}case"<":{e.dispatchEvent("metacommit",{type:"KarLyric",data:n,mask:e.#P,amend:!1}),n="",e.#P=!1;break}case"/":{e.dispatchEvent("metacommit",{type:"KarLyric",data:n,mask:!1,amend:!1}),n="",e.#P=!0;break}default:n+=s}n.length>0&&(e.dispatchEvent("metacommit",{type:"KarLyric",data:n,mask:e.#P,amend:!0}),e.#P=!1);break}default:{let n=0,s=!0,r=a.length-1;for(;s&&n<8;)switch(a.charCodeAt(n)){case 32:{n++;break}default:s=!1}switch(n>0&&(e.dispatchEvent("metacommit",{type:"C.Lyrics",data:a.substring(0,n),amend:!0,mask:e.#P,untimed:!0}),e.#P=!1),a.charCodeAt(r)){case 10:{e.dispatchEvent("metacommit",{type:"C.Lyrics",data:a.substring(n,r),amend:!1,mask:e.#P}),e.#P=!1;break}case 11:case 13:{e.dispatchEvent("metacommit",{type:"C.Lyrics",data:a.substring(n,r),amend:!1,mask:e.#P}),e.#P=!0;break}case 32:{e.dispatchEvent("metacommit",{type:"C.Lyrics",data:a.substring(n,r),amend:!0,mask:e.#P}),e.dispatchEvent("metacommit",{type:"C.Lyrics",data:" ",amend:!0,mask:!1,untimed:!0}),e.#P=!1;break}default:a.trim()===""?console.info("Blank line? Shouldn't happen."):e.dispatchEvent("metacommit",{type:"C.Lyrics",data:a,amend:!0,mask:e.#P}),e.#P=!1}break}}},e.#B[6]=function(a){e.dispatchEvent("metacommit",{type:"C.Marker",data:a})},e.#B[7]=function(a){switch(a[0]){case"$":{if(a.substring(1,5)==="Lyrc"){e.#C=e.KARAOKE_XF;let n=a.substring(6).split(":"),s=n[0].replaceAll(" ","").split(",");s.forEach((l,o,f)=>{f[o]=parseInt(l)-1});let r=qe[n[2].substring(0,2).toLowerCase()];e.dispatchEvent("metacommit",{type:"XfMeloCh",data:`CH${n[0].replaceAll(" ","").split(",").join(", CH")}`,parsed:s}),e.dispatchEvent("metacommit",{type:"XfLyrOff",data:n[1],parsed:parseInt(n[1])}),e.dispatchEvent("metacommit",{type:"XfLyrEnc",data:r[1],parsed:r[0]}),e.#P=!1}else e.dispatchEvent("metacommit",{type:"CuePoint",data:a});break}case"#":{e.dispatchEvent("metacommit",{type:"XfScneNo",data:a.substring(1)});break}case"&":{a.length===2?(e.dispatchEvent("metacommit",{type:"XfSngPrt",data:Qe[a[1]]||`Unknown "${a[1]}"`}),e.#P=!1):e.dispatchEvent("metacommit",{type:"CuePoint",data:a});break}default:e.dispatchEvent("metacommit",{type:"CuePoint",data:a})}},e.#B[32]=function(a){e.#_=a[0]+1},e.#B[33]=function(a,n){T()&&console.debug(`Track ${n} requests getting assigned to port ${a}.`),e.#se[n]=a+1},e.#B[81]=function(a,n){e.#ae=a/1e3},e.#B[127]=function(a,n){e.#le.run(a,n)},e.#le.default=function(a){let n=[];for(let s=0;s<8&&s<a.length;s++)n.push(a[s].toString(16).padStart(2,"0").toUpperCase());console.warn(`Unrecognized implementation-specific byte sequence: ${n.join(" ")}${a.length>8?" ...":""}
%o`,a)},e.#le.add([67,0,1],(a,n)=>{T()&&console.debug(`XGworks port assign requests assigning track ${n} to port ${a[0]}.`),e.#se[n]=a[0]+1}).add([67,123,1],(a,n)=>{let s=[];for(let r=0;r<a.length;r+=2){let l=a[r]>>4,o=a[r]&15;if(l<7&&o&&o<8){let f=new Uint8Array(5);f[0]=o-1,f[1]=l-3<<2,f[2]=a[r|1],s.push(f)}}e.dispatchEvent("metacommit",{type:"ChordCtl",src:"yxf",data:s}),console.debug("Yamaha XF chord data: %o",s)}).add([67,123,2],(a,n)=>{let s=new Uint8Array(2);s[0]=a[0]&15,s[1]=a[0]>>4,e.dispatchEvent("metacommit",{type:"RhrslMrk",src:"yxf",data:s}),console.debug(`Yamaha XF rehearsal mark: ${["Intro","Ending","Fill-in"][s[0]]??String.fromCharCode(62+s[0])}${"'".repeat(s[1])} %o`,s)}).add([67,123,96],(a,n)=>{let s=[0,0];a.subarray(1,3).forEach(r=>{s[0]=s[0]<<7,s[0]|=r&127}),a.subarray(3,5).forEach(r=>{s[1]=s[1]<<7,s[1]|=r&127}),e.dispatchEvent("metacommit",{type:"YStyleId",data:s}),console.debug(`Yamaha style ID: model ${s[0].toString(16)}, style ${s[1]+1}`)}),e.#ce=new _("universal non-realtime"),e.#oe=new _("universal realtime"),e.#D=new _("Yamaha"),e.#F=new _("Roland"),e.#q=new _("Korg"),e.#fe=new _("Kawai"),e.#de=new _("Akai"),e.#he=new _("Casio");let t=new _("DX7+ Dump"),i=function(a){let n=[];for(let s=0;s<8&&s<a.length;s++)n.push(a[s].toString(16).padStart(2,"0").toUpperCase());console.info(`Unrecognized SysEx in "${this.name}" set: ${n.join(" ")}${a.length>8?" ...":""}
%o`,a)};e.#ce.default=i,e.#oe.default=i,e.#D.default=i,e.#F.default=i,e.#q.default=i,e.#fe.default=i,e.#de.default=i,e.#he.default=i,t.default=i,e.#ce.add([9],(a,n,s)=>{e.switchMode(["gm","?","g2"][a[0]-1],!0),e.setPortMode(e.getTrackPort(n),1,[k.gm,k["?"],e.#i.g2][a[0]-1]),e.#C=e.#C||e.KARAOKE_NONE,console.info(`MIDI reset: ${["GM","Init","GM2"][a[0]-1]}`),a[0]===2&&e.init()}),e.#oe.add([4,1],(a,n,s)=>{e.invokeSysExIndicator(),e.#m=((a[1]<<7)+a[0])/16383*100,e.dispatchEvent("mastervolume",e.#m)}).add([4,3],(a,n,s)=>((a[1]<<7)+a[0]-8192)/8192).add([4,4],(a,n,s)=>a[1]-64).add([4,5],(a,n,s)=>{e.invokeSysExIndicator();let r=a[0],l=a[1],o=a[2],f=3,u=f+(r<<1),p=u+l;if(r!==1){console.error(`Unsupported GM2 global parameter set: slotpath length too long (${r})!
`,a);return}let w=0,E=0,$=0;switch(a.subarray(f,u).forEach(S=>{w=w<<7,w|=S}),a.subarray(u,p).forEach((S,R)=>{E|=S<<R*7}),a.subarray(p).forEach((S,R)=>{$|=S<<R*7}),T()&&console.debug(`GM2 global parameter: (${a.subarray(3,u)}; p: ${E}, v: ${$})`),w){case 129:{E===0&&(e.setEffectType(0,52,$),e.pushEffectType(0));break}case 130:{E===0&&(e.setEffectType(1,52,$|16),e.pushEffectType(1));break}default:T()&&console.debug("GM2 global paramater slot path unknown.")}}),this.#D.add([76,0,0],(a,n,s)=>{switch(a[0]){case 125:{e.initDrums(),console.info(`XG drum setup reset on drum kit ${a[1]}.`);break}case 126:{e.switchMode("xg",!0),e.setPortMode(e.getTrackPort(n),4,k.xg),e.#C=e.#C||e.KARAOKE_NONE,console.info("MIDI reset: XG");break}default:{e.invokeSysExIndicator();let r=[0,0,0,0],l=(o,f)=>{r[f]=o};if(a.subarray(1).forEach((o,f)=>{let u=f+a[0];([l,l,l,l,p=>{this.#m=p*129/16383*100,e.dispatchEvent("mastervolume",e.#m)},p=>{},p=>{}][u]||(()=>{}))(o,f)}),a[0]<4){let o=0;r.forEach(f=>{o=o<<4,o+=f}),o-=1024,console.debug(`Master tune: ${o}`)}}}}).add([76,2,1],(a,n,s)=>{e.invokeSysExIndicator();let r="XG ";a[0]<32?(r+="reverb ",a.subarray(1).forEach((l,o)=>{([f=>{e.setEffectTypeRaw(0,!1,f),console.info(`${r}main type: ${re[f]}`),e.pushEffectType(0)},f=>{e.setEffectTypeRaw(0,!0,f),console.debug(`${r}sub type: ${f+1}`),e.pushEffectType(0)},f=>{console.debug(`${r}time: ${Ke(f)}s`)},f=>{console.debug(`${r}diffusion: ${f}`)},f=>{console.debug(`${r}initial delay: ${f}`)},f=>{console.debug(`${r}HPF cutoff: ${J[f]}Hz`)},f=>{console.debug(`${r}LPF cutoff: ${J[f]}Hz`)},f=>{console.debug(`${r}width: ${f}`)},f=>{console.debug(`${r}height: ${f}`)},f=>{console.debug(`${r}depth: ${f}`)},f=>{console.debug(`${r}wall type: ${f}`)},f=>{console.debug(`${r}dry/wet: ${f}`)},f=>{console.debug(`${r}send: ${B(f)}dB`)},f=>{console.debug(`${r}pan: ${f-64}`)},!1,!1,f=>{console.debug(`${r}delay: ${f}`)},f=>{console.debug(`${r}density: ${f}`)},f=>{console.debug(`${r}balance: ${f}`)},f=>{},f=>{console.debug(`${r}feedback: ${f}`)},f=>{}][a[0]+o]||function(){console.warn(`Unknown XG reverb address: ${a[0]}.`)})(l)})):a[0]<64?(r+="chorus ",a.subarray(1).forEach((l,o)=>{([f=>{e.setEffectTypeRaw(1,!1,f),console.info(`${r}main type: ${re[f]}`),e.pushEffectType(1)},f=>{e.setEffectTypeRaw(1,!0,f),console.debug(`${r}sub type: ${f+1}`),e.pushEffectType(1)},f=>{console.debug(`${r}LFO: ${Ge[f]}Hz`)},f=>{},f=>{console.debug(`${r}feedback: ${f}`)},f=>{console.debug(`${r}delay offset: ${Fe(f)}ms`)},f=>{},f=>{console.debug(`${r}low: ${J[f]}Hz`)},f=>{console.debug(`${r}low: ${f-64}dB`)},f=>{console.debug(`${r}high: ${J[f]}Hz`)},f=>{console.debug(`${r}high: ${f-64}dB`)},f=>{console.debug(`${r}dry/wet: ${f}`)},f=>{console.debug(`${r}send: ${B(f)}dB`)},f=>{console.debug(`${r}pan: ${f-64}`)},f=>{console.debug(`${r}to reverb: ${B(f)}dB`)},!1,f=>{},f=>{},f=>{},f=>{console.debug(`${r}LFO phase diff: ${(f-64)*3}deg`)},f=>{console.debug(`${r}input mode: ${f?"stereo":"mono"}`)},f=>{}][a[0]-32+o]||function(){console.warn(`Unknown XG chorus address: ${a[0]}.`)})(l)})):a[0]<86?(r+="variation ",a.subarray(1).forEach((l,o)=>{([f=>{e.setEffectTypeRaw(2,!1,f),console.info(`${r}main type: ${re[f]}`),e.pushEffectType(2)},f=>{e.setEffectTypeRaw(2,!0,f),console.debug(`${r}sub type: ${f+1}`),e.pushEffectType(2)}][a[0]-64+o]||function(){})(l)})):a[0]<97?(r+="variation ",a.subarray(1).forEach((l,o)=>{[f=>{console.debug(`${r}send: ${B(f)}dB`)},f=>{console.debug(`${r}pan: ${f-64}`)},f=>{console.debug(`${r}to reverb: ${B(f)}dB`)},f=>{console.debug(`${r}to chorus: ${B(f)}dB`)},f=>{e.modelEx.xg.varSys=!!f,console.debug(`${r}connection: ${f?"system":"insertion"}`)},f=>{if(e.modelEx.xg.varSys){console.warn(`${r}effect is applied system-wide. Setting its effective channel to CH${f+1} will not have any effect.`);return}if(f<64){let u=e.chRedir(f,n,!0);e.setXgChEffectSink(u,2),console.debug(`${r}channel: CH${f+1} (CH${u+1})`)}else e.setXgChEffectSink(y.invalidCh,2),console.info(`${r}channel: CH${f+1} (unsupported)`)},f=>{console.debug(`${r}mod wheel: ${f-64}`)},f=>{console.debug(`${r}bend wheel: ${f-64}`)},f=>{console.debug(`${r}channel after touch: ${f-64}`)},f=>{console.debug(`${r}AC1: ${f-64}`)},f=>{console.debug(`${r}AC2: ${f-64}`)}][a[0]-86+o](l)})):a[0]>111&&a[0]<118?r+="variation ":console.warn(`Unknown XG variation address: ${a[0]}`)}).add([76,2,64],(a,n,s)=>{a.subarray(1).forEach((r,l)=>{let o=l+a[0];if(o===0)console.debug(`XG EQ preset: ${["flat","jazz","pop","rock","classic"][r]}`);else{let f=o-1>>2,u=o-1&3,p=`XG EQ ${f} ${["gain","freq","Q","shape"][u]}: `;[()=>{console.debug(`${p}${r-64}dB`)},()=>{console.debug(`${p}${r} (raw)`)},()=>{console.debug(`${p}${r/10}`)},()=>{console.debug(`${p}${["shelf","peak"][+!!r]}`)}][u]()}})}).add([76,3],(a,n,s)=>{e.invokeSysExIndicator();let r=a[0],l=a[1],o=`XG Insertion ${a[0]+1} `;a.subarray(2).forEach((f,u)=>{([()=>{e.setEffectTypeRaw(3+r,!1,f),console.info(`${o}main type: ${re[f]}`),e.pushEffectType(3+r)},()=>{e.setEffectTypeRaw(3+r,!0,f),console.debug(`${o}sub type: ${f+1}`),e.pushEffectType(3+r)},!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,()=>{if(f<64){let p=e.chRedir(f,n,!0);e.setXgChEffectSink(p,3+r),console.debug(`${o}channel: CH${f+1} (CH${p+1})`)}else e.setXgChEffectSink(y.invalidCh,3+r),console.info(`${o}channel: CH${f+1} (unsupported)`)}][l+u]||function(){})(f)})}).add([76,6,0],(a,n,s)=>{let r=a[0];r<64?e.setLetterDisplay(a.subarray(1),"XG letter display",r):e.#z=Date.now()}).add([76,7,0],(a,n,s)=>{let r=a[0];e.#b=0,e.#S=Date.now()+3200,a.subarray(1).forEach(function(o,f){let u=f+r,p=u>>4,w=u&15,E=(w*3+p)*7,$=7,S=0;for(E-=w*5,p===2&&($=2);S<$;)e.#$[E+S]=o>>6-S&1,S++})}).add([76,8],(a,n)=>{e.invokeSysExIndicator();let s=e.chRedir(a[0],n,!0),r=a[1],l=M[s],o=`XG CH${s+1} `,f=`Unknown XG part address ${r}.`,u=!0;a.subarray(2).forEach((p,w)=>{u=!0,r<1?console.debug(f):r<41?([()=>{e.setChCc(s,0,p),e.pushChPrimitives(s)},()=>{e.setChCc(s,32,p),e.pushChPrimitives(s)},()=>{e.#n[s]=p,e.pushChPrimitives(s)},()=>{u=!1;let E=e.chRedir(p,n,!0),$=e.#f[s];e.#f[s]=E,(s!==E||E!==$)&&(e.buildRchTree(),console.info(`${o}receives from CH${E+1}`)),e.#u[s]||(e.copyChSetup(E,s,!0),console.debug(`${o}copied from CH${E+1}.`),e.setChActive(s,1),e.pushChPrimitives(s))},()=>{e.#d[s]=+!p},()=>{},()=>{u=!1,e.setChType(s,p,k.xg),console.debug(`${o}type: ${se[p]||p}`),e.pushChPrimitives(s)},()=>{e.#s[y.rpn*s+3]=p,e.#o[y.rpnt*s+2]=1,e.dispatchEvent("pitch",{part:s,pitch:e.getPitchShift(s)})},!1,!1,()=>{e.setChCc(s,7,p)},!1,!1,()=>{e.setChCc(s,10,p||128)},!1,!1,()=>{e.setChCc(s,128,p),e.allocateAce(s,128)},()=>{e.setChCc(s,93,p)},()=>{e.setChCc(s,91,p)},()=>{e.setChCc(s,94,p)},()=>{e.setChCc(s,76,p)},()=>{e.setChCc(s,77,p)},()=>{e.setChCc(s,78,p)},()=>{e.setChCc(s,74,p)},()=>{e.setChCc(s,71,p)},()=>{e.setChCc(s,73,p)},()=>{e.setChCc(s,75,p)},()=>{e.setChCc(s,72,p)}][r+w-1]||(()=>{}))():r<48?console.debug(f):r<111?r>102&&r<105&&e.setChCc(s,[5,65][r&1],p):r<114?console.debug(f):r<116?console.debug(`${o}EQ ${["bass","treble"][r&1]} gain: ${p-64}dB`):r<118?console.debug(f):r<120?console.debug(`${o}EQ ${["bass","treble"][r&1]} freq: ${p}`):console.debug(f)}),u&&e.#r[s]>1&&e.setDrumFirstWrite(s)}).add([76,9],(a,n)=>{let s=e.chRedir(a[0],n,!0),r=a[1],l=M[s],o=`PLG-VL CH${s+1} `;a.subarray(2).forEach((f,u)=>{let p=u+r;switch(p){case 1:{console.info(`${o}breath mode: ${["system","breath","velocity","touch EG"][f]}`);break}case 0:case 27:case 28:break;default:if(p<27){let w=p-3>>1,E=["pressure","embouchure","tonguing","scream","breath noise","growl","throat formant","harmonic enhancer","damping","absorption","amplification","brightness"][w];p&1?p<23?(console.debug(`${o}${E} control source: ${ze(f)}`),f&&f<96&&e.allocateAce(s,130+w),e.#G[y.redir*s+w+2]=f,e.buildRccMap()):console.debug(`${o}${E} scale break point: ${f}`):(console.debug(`${o}${E} depth: ${f-64}`),e.setChCc(s,130+w,f))}}})}).add([76,10],(a,n,s)=>{}).add([76,16],(a,n,s)=>{}).add([76,17,0,0],(a,n,s)=>{}).add([76,112],(a,n,s)=>{if(a[0]>=G.length){console.error(`Supplied invalid plugin board ID: ${a[0]}`);return}if(a[1]>=G[a[0]][1]){console.error(`Supplied invalid slot ID for board type "${G[a[0]][0]}" (${a[0]}): ${a[1]} (#${a[1]+1}))`);return}switch(a[1]>=G[a[0]][2]?console.warn(`While enabled in Octavia, slot #${a[1]+1} for board type "${G[a[0]][0]}" (${a[0]}) may not function outside software recreation.`):a[2]>63?console.debug(`XG disable PLG-${G[a[0]][0]} (${a[0]}) slot #${a[1]+1} as it's set to CH${a[2]+1}.`):console.debug(`XG enable PLG-${G[a[0]][0]} (${a[0]}) slot #${a[1]+1} for CH${a[2]+1}.`),e.modelEx.yPlg[a[0]][a[1]]=a[2]<64?e.chRedir(a[2],n,!0):y.invalidCh,a[0]){case 0:{e.#x[y.ext*a[2]]=e.EXT_VL;break}case 2:{e.#x[y.ext*a[2]]=e.EXT_DX;break}default:e.#x[y.ext*a[2]]=e.EXT_NONE}}).add([73,0,0],(a,n)=>{let s=a[0],r="MU1000 System - ";a.subarray(1).forEach((l,o)=>{let f=s+o;f===8?console.debug(`${r}LCD contrast: ${l}.`):f===18?(e.#p[k.xg][1]=l?126:0,console.debug(`${r}default bank: ${l?"MU100 Native":"MU Basic"}.`),e.dispatchEvent("banklevel",{mode:"xg",data:+!!l}),e.forceVoiceRefresh()):f>=64&&f<69&&[()=>{e.dispatchEvent("channelactive",l)},()=>{l<8?(e.dispatchEvent("channelmin",l<<4),console.debug(`Octavia System: Minimum CH${(l<<4)+1}`)):(e.dispatchEvent("channelreset"),console.info("Octavia System: Clear channel ranges"))},()=>{l<8?(e.dispatchEvent("channelmax",(l<<4)+15),console.debug(`Octavia System: Maximum CH${(l<<4)+16}`)):(e.dispatchEvent("channelreset"),console.info("Octavia System: Clear channel ranges"))},()=>{e.dispatchEvent("channelreset"),console.info("Octavia System: Clear channel ranges")},()=>{e.#te=!!l,console.info(`Octavia System: RS receiving ${["dis","en"][l]}abled.`)}][f-64]()})}).add([73,10,0],(a,n)=>{let s=a[0],r=`MU1000 RS${e.#te?"":" (ignored)"}: `;if(s<16)switch(s){case 2:{let l=e.chRedir(0,n,!0);e.#te&&(e.dispatchEvent("portrange",4),e.dispatchEvent("portstart",l)),console.info(`${r}Show CH${l+1}~CH${l+64}`);break}case 3:{let l=e.chRedir(a[1]<<5,n,!0);e.#te&&(e.dispatchEvent("portrange",2),e.dispatchEvent("portstart",l)),console.info(`${r}Show CH${l+1}~CH${l+32}`);break}default:console.debug(`${r}unknown switch ${s} invoked.`)}else if(s<32){if(e.#te){let l=e.chRedir(s-16+(e.#ee<<4),n,!0);e.dispatchEvent("channelactive",l)}}else if(s<36){let l=e.chRedir(s-32<<4,n,!0);e.#te&&(e.dispatchEvent("portrange",1),e.dispatchEvent("portstart",l>>4),e.#ee=s-32),console.info(`${r}Show CH${l+1}~CH${l+16}`)}}).add([73,11,0],(a,n)=>{let s="MU1000 System - channel ",r="Octavia System - channel ",l=a[0];a.subarray(1).forEach((o,f)=>{let u=l+f;([()=>{e.setChActive(o,1),e.dispatchEvent("channelactive",o),T()&&console.debug(`${s}current part: CH${o+1}`)},()=>{o<5?(e.dispatchEvent("portrange",1<<o),console.debug(`${s}port range: ${1<<o} port(s)`)):(e.dispatchEvent("portrange",0),console.debug(`${s}port range: reset`))},()=>{o<16?(e.dispatchEvent("portstart",o),console.debug(`${r}start port: ${"ABCDEFGHIJKLMNOP"[o]}`)):(e.dispatchEvent("portstart",255),console.debug(`${r}start port: reset`))}][u]||(()=>{console.debug(`${s}unknown address: ${u}`)}))()})}).add([93,3],(a,n)=>{let s=e.chRedir(a[0],n,!0),r=`PLG-SG CH${s+1} `,l=Date.now(),o=e.modelEx.sg;if(a[1]===0){let f="",u=0;a.subarray(2).forEach((p,w)=>{w%2===0?f+=Ye[p]||p.toString().padStart("0"):u+=p*13}),(l>=o.convLastSyll||o.runLineLen>=o.maxLineLen)&&(e.dispatchEvent("metacommit",{type:"SGLyrics",data:"",amend:!1}),o.splitMask=l<o.convLastSyll,o.runLineLen=0),e.dispatchEvent("metacommit",{type:"SGLyrics",data:`${We(f)}`,amend:!0,mask:o.splitMask}),o.runLineLen++,o.splitMask=!1,o.convLastSyll=l+Math.ceil(u/2)+e.#ae,T()&&console.debug(`${r}vocals: ${f}`)}else console.warn(`Unknown PLG-SG data: ${a}`)}).add([98,96],(a,n,s,r)=>{let l=e.chRedir(a[0],n,!0),o=M[l],f=a[1];a.subarray(2).forEach((u,p)=>{let w=f+p;if(!(w<10)){if(w===10)e.resetAce();else if(w<27){let E=w+131;e.setChCc(l,E,u),!r?.noAce&&u>0&&u!==64&&e.allocateAce(l,E),e.dispatchEvent("cc",{part:l,cc:E,data:u})}}})}).add([1,20],(a,n,s)=>{s===115?(e.switchMode("doc",!0),e.setPortMode(e.getTrackPort(n),1,k.doc),console.info("MIDI reset: DOC")):console.debug(`Unknown Yamaha SysEx: 67, ${s}, ${a.join(", ")}`)}).add([1,17,15,89],(a,n,s)=>{s===115?(e.setEffectType(0,24,a[0]|16),e.pushEffectType(0)):console.debug(`Unknown Yamaha SysEx: 67, ${s}, ${a.join(", ")}`)}).add([1,24],(a,n,s)=>{if(s===115){for(let r=0;r<16;r++){let l=e.chRedir(r,n,!0);e.setChCc(l,91,127)}console.info("DOC Global Reverb: on")}else console.debug(`Unknown Yamaha SysEx: 67, ${s}, ${a.join(", ")}`)}).add([126,0],(a,n,s)=>{switch(a[1]){case 0:{e.dispatchEvent("metacommit",{type:"YMCSSect",data:"Disabled",raw:"Intro "}),console.debug("Yamaha Section Control is off.");break}case 127:{e.dispatchEvent("metacommit",{type:"YMCSSect",data:["Intro","Main A","Main B","Fill-in AB","Fill-in BA","Ending","Blank"][a[0]-8]??`invalid section ${a[0]}`,raw:["Intro ","Main A","Main B","FillAB","FillBA","Ending","Blank "][a[0]-8]??`ID: ${a[0]}`}),console.debug(`Yamaha Section Control switches to "${["intro","main A","main B","fill-in AB","fill-in BA","ending","blank"][a[0]-8]??`Invalid section ${a[0]}`}".`);break}default:console.debug(`Unknown YMCS section control: ${a[1]}`)}}).add([126,2],(a,n,s)=>{let r=[];for(let l=0;l<a.length;l+=2){let o=a[l]>>4,f=a[l]&15;if(o<7&&f&&f<8){let u=new Uint8Array(5);u[0]=f-1,u[1]=o-3<<2,u[2]=a[l|1],r.push(u)}}e.dispatchEvent("metacommit",{type:"ChordCtl",src:"ymcs",data:r}),console.debug("YMCS chord data: %o",r)});let c=function(a,n,s,r){},d=function(a,n){e.invokeSysExIndicator();let s=a*y.dpn,r=n[0],l=n[1];n.subarray(2).forEach((o,f)=>{let u=f+l,p=-1;u<16?([()=>{p=24},()=>{p=25},()=>{p=26},()=>{},()=>{p=28},()=>{p=29},()=>{p=30},()=>{p=31},()=>{},()=>{},()=>{},()=>{p=20},()=>{p=21},()=>{p=22},()=>{p=23},()=>{}][u]||(()=>{console.debug(`Unknown XG-style drum param ${u} on set ${a+1}.`)}))():u<32||(u<40?([()=>{p=48},()=>{p=49},!1,!1,()=>{p=52},()=>{p=53}][u-32]||(()=>{console.debug(`Unknown XG-style drum param ${u} on set ${a+1}.`)}))():u<80||([()=>{p=36}][u-80]||(()=>{console.debug(`Unknown XG-style drum param ${u} on set ${a+1}.`)}))()),p>=0?(T()&&console.debug(s,p,r,o),e.#A[(s+X[p])*y.dnc+r]=o):T()&&console.debug(`XG-style drum param ${u} has no writes.`)})},h=function(a,n,s){e.invokeSysExIndicator();let r=a*y.dpn,l=(n<<7)+s[0];s.subarray(1).forEach((o,f)=>{let u=f+l,p=u&127,w=u>>7,E=-1;w>1&&([()=>{E=26},()=>{},()=>{E=28},()=>{E=29},()=>{E=30},()=>{},()=>{},()=>{E=31}][w-2]||(()=>{console.debug(`Unknown GS-style drum param ${w} on set ${a+1}.`)}))(),E>-1?(T()&&console.debug(r,E,p,o),e.#A[(r+X[E])*y.dnc+p]=o):T()&&console.debug(`GS-style drum param ${w} has no writes.`)})};this.#D.add([76,48],(a,n,s)=>{d(0,a)}).add([76,49],(a,n,s)=>{d(1,a)}).add([76,50],(a,n,s)=>{d(2,a)}).add([76,51],(a,n,s)=>{d(3,a)}).add([76,52],(a,n,s)=>{d(4,a)}).add([76,53],(a,n,s)=>{d(5,a)}).add([76,54],(a,n,s)=>{d(6,a)}).add([76,55],(a,n,s)=>{d(7,a)}),this.#D.add([89,0],(a,n,s)=>{if(e.eprom){let r=a[0],l=(a[1]<<14)+(a[2]<<7)+a[3]+(e.eprom.offset||0);T()&&console.debug(`MU1000 EPROM trail to 0x${l.toString(16).padStart(6,"0")}, ${r} bytes.`);let o=e.eprom.data;a.subarray(4).forEach((f,u)=>{let p=u>>3,w=u&7;if(w===7)for(let E=0;E<7;E++)o[l+7*p+E]+=(f>>6-E&1)<<7;else o[l+7*p+w]=f})}}).add([89,1],(a,n,s)=>{let r=(a[0]<<21)+(a[1]<<14)+(a[2]<<7)+a[3];T()&&console.debug(`MU1000 EPROM jump to 0x${r.toString(16).padStart(6,"0")}.`),e.eprom&&(e.eprom.offset=r)}).add([89,2],(a,n,s)=>{if(e.eprom){let r=(a[0]<<21)+(a[1]<<14)+(a[2]<<7)+a[3]+(e.eprom.offset||0);T()&&console.debug(`MU1000 EPROM write to 0x${r.toString(16).padStart(6,"0")}.`);let l=e.eprom.data;a.subarray(4).forEach((o,f)=>{let u=f>>3,p=f&7;if(p===7)for(let w=0;w<7;w++)l[r+7*u+w]+=(o>>6-w&1)<<7;else l[r+7*u+p]=o})}}).add([89,3],(a,n,s)=>{}),this.#D.add([39,48],(a,n,s)=>{}).add([43,0,0],(a,n,s)=>{e.invokeSysExIndicator();let r=[0,0,0,0],l=(o,f)=>{r[f]=o};if(a.subarray(1).forEach((o,f)=>{let u=f+a[0];[l,l,l,l,()=>{this.#m=o*129/16383*100,e.dispatchEvent("mastervolume",e.#m)},()=>o-64,()=>o||128,()=>o,()=>o,()=>{console.debug(`TG300 variation on cc${o}.`)}][u](o,u)}),a[0]<4){let o=0;r.forEach(f=>{o=o<<4,o+=f}),o-=1024,console.debug(`Master tune: ${o}`)}}).add([43,1,0],(a,n,s)=>{e.invokeSysExIndicator()}).add([43,2],(a,n,s)=>{e.invokeSysExIndicator();let r=e.chRedir(a[0],n,!0),l=a[1],o=M[r],f=`TG300 CH${r+1} `;a.subarray(2).forEach((u,p)=>{p<5?([()=>{},()=>{e.setChCc(r,0,u),e.pushChPrimitives(r)},()=>{e.setChCc(r,32,u),e.pushChPrimitives(r)},()=>{e.#n[r]=u,e.pushChPrimitives(r)},()=>{let w=e.chRedir(u,n,!0),E=e.#f[r];e.#f[r]=w,(r!==w||w!==E)&&(e.buildRchTree(),console.info(`${f}receives from CH${w+1}`))}][p+l]||(()=>{}))(u,p+l):p<21||(p<47?([()=>{e.#d[r]=+!u},()=>{},()=>{},()=>{e.#s[y.rpn*r+3]=u,e.#o[y.rpnt*r+2]=1,e.dispatchEvent("pitch",{part:r,pitch:e.getPitchShift(r)})},()=>{},()=>{e.setChCc(r,7,u)},!1,!1,()=>{e.setChCc(r,10,u||128)},!1,!1,()=>{console.debug(`${f} AC1 at cc${u}`)},()=>{console.debug(`${f} AC2 at cc${u}`)},()=>{e.#e[o+v[128]]=u,e.allocateAce(r,128)},()=>{e.#e[o+v[93]]=u},()=>{e.#e[o+v[91]]=u},()=>{e.#e[o+v[94]]=u},()=>{e.#e[o+v[76]]=u},()=>{e.#e[o+v[77]]=u},()=>{e.#e[o+v[74]]=u},()=>{e.#e[o+v[71]]=u},()=>{e.#e[o+v[73]]=u},()=>{e.#e[o+v[75]]=u},()=>{e.#e[o+v[72]]=u},()=>{e.#e[o+v[78]]=u}][p+l-21]||(()=>{}))(u,p+l):p<95||([()=>{e.#e[o+v[65]]=u},()=>{e.#e[o+v[5]]=u}][p+l-95]||(()=>{}))(u,p+l))})}).add([43,7,0],(a,n,s)=>{let r=a[0];e.setLetterDisplay(a.subarray(1),"TG300 letter display",r)}).add([43,7,1],(a,n,s)=>{e.#b=0,e.#S=Date.now()+3200,a.forEach(function(r,l){let o=l>>4,f=l&15,u=(f*3+o)*7,p=7,w=0;for(u-=f*5,o===2&&(p=2);w<p;)e.#$[u+w]=r>>6-w&1,w++})}),this.#F.add([66,18,0,0,127],(a,n,s)=>{e.switchMode("sc",!0),e.setPortMode(e.getTrackPort(n),2,k.sc),e.#C=e.KARAOKE_NONE,e.#ie.fill(0),console.info(`GS system to ${["single","dual"][a[0]]} mode.`)}).add([66,18,64,0],(a,n,s)=>{switch(a[0]){case 127:{e.switchMode("gs",!0),e.setPortMode(e.getTrackPort(n),4,k.gs),e.#C=e.KARAOKE_NONE,e.#ie.fill(0),console.info("MIDI reset: GS");break}default:{e.invokeSysExIndicator();let r=[0,0,0,0],l=(o,f)=>{r[f]=o};if(a.subarray(1).forEach((o,f)=>{let u=f+a[0];[l,l,l,l,p=>{this.#m=p*129/16383*100,e.dispatchEvent("mastervolume",e.#m)},p=>{},p=>{}][u](o,f)}),a[0]<4){let o=0;r.forEach(f=>{o=o<<4,o+=f}),o-=1024,console.debug(`Master tune: ${o}`)}}}}).add([66,18,64,1],(a,n,s)=>{e.invokeSysExIndicator();let r=a[0];if(r<16){let l="".padStart(r," ");a.subarray(1).forEach((o,f)=>{l+=String.fromCharCode(Math.max(32,o))}),l=l.padEnd(16," "),console.debug(`GS patch name: ${l}`)}else r<48||(r<65?a.subarray(1).forEach((l,o)=>{let f=`GS ${r+o>55?"chorus":"reverb"} `;([()=>{console.info(`${f}type: ${xe[l]}`),e.setEffectType(0,40,l),e.pushEffectType(0)},()=>{},()=>{},()=>{},()=>{},()=>{},!1,()=>{console.debug(`${f}predelay: ${l}ms`)},()=>{console.info(`${f}type: ${je[l]}`),e.setEffectType(1,40,16+l),e.pushEffectType(1)},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{console.debug(`${f}to reverb: ${B(l)}`)},()=>{console.debug(`${f}to delay: ${B(l)}`)}][r+o-48]||(()=>{}))()}):r<80?console.debug(`Unknown GS patch address: ${r}`):r<91?a.subarray(1).forEach((l,o)=>{let f="GS delay ";([()=>{console.info(`${f}type: ${Je[l]}`),e.setEffectType(2,40,32+l),e.pushEffectType(2)},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{console.debug(`${f}to reverb: ${B(l)}`)}][r+o-80]||(()=>{}))()}):console.debug(`Unknown GS patch address: ${r}`))}).add([66,18,64,2],(a,n,s)=>{let r="GS EQ ";a.subarray(1).forEach((l,o)=>{([()=>{console.debug(`${r}low freq: ${[200,400][l]}Hz`)},()=>{console.debug(`${r}low gain: ${l-64}dB`)},()=>{console.debug(`${r}high freq: ${[3e3,6e3][l]}Hz`)},()=>{console.debug(`${r}high gain: ${l-64}dB`)}][a[0]+o]||function(){console.warn(`Unknown GS EQ address: ${a[0]+o}`)})()})}).add([66,18,64,3],(a,n,s)=>{e.invokeSysExIndicator();let r="GS EFX ",l=function(o,f){let u=Ze(e.#R.subarray(10,12),f,o);u&&console.debug(`${r}${Se(e.#R.subarray(10,12))} ${u}`)};a.subarray(1).forEach((o,f)=>{([()=>{e.setEffectTypeRaw(3,!1,32+o),e.pushEffectType(3)},()=>{e.setEffectTypeRaw(3,!0,o),console.info(`${r}type: ${Se(e.#R.subarray(10,12))}`),e.pushEffectType(3)},!1,l,l,l,l,l,l,l,l,l,l,l,l,l,l,l,l,l,l,l,l,()=>{console.debug(`${r}to reverb: ${B(o)}dB`)},()=>{console.debug(`${r}to chorus: ${B(o)}dB`)},()=>{console.debug(`${r}to delay: ${B(o)}dB`)},!1,()=>{console.debug(`${r}1 source: ${o}`),o&&o<96&&e.allocateAceAll(o)},()=>{console.debug(`${r}1 depth: ${o-64}`)},()=>{console.debug(`${r}2 source: ${o}`),o&&o<96&&e.allocateAceAll(o)},()=>{console.debug(`${r}2 depth: ${o-64}`)},()=>{console.debug(`${r}to EQ: ${o?"ON":"OFF"}`)}][a[0]+f]||function(u,p){console.warn(`Unknown GS EFX address: ${p}`)})(o,a[0]+f)})}).add([66,18,65],(a,n,s)=>{h((a[0]>>4)+1<<1,a[0]&15,a.subarray(1))}).add([66,18,72],(a,n,s)=>{let r=(a[0]&127)<<7|a[1]&127;console.debug(r,at(a.subarray(2)))}).add([69,18,16],(a,n,s)=>{switch(a[0]){case 0:{let r=a[1];e.setLetterDisplay(a.subarray(2),"GS display text",r);break}case 8:{let r=a[1],l=e.modelEx.sc;a.subarray(2).forEach((o,f)=>{([()=>{l.showBar=!(o&1),l.invBar=o>>1&1,l.invDisp=o>>2&1},()=>{l.peakHold=o<4?o:1}][f+r]||(()=>{console.debug("Unsupported GS display type SysEx.")}))()});break}case 32:{e.#S=Date.now()+3200,a[1]===0&&(a[2]?(e.#b=Math.max(Math.min(a[2]-1,9),0),T()&&console.debug(`GS switch display page ${a[2]-1}.`)):(e.#b=0,e.#S=Date.now(),T()&&console.debug("GS disable display page.")));break}default:if(a[0]<6){e.#b>9&&(e.#b=0);let r=a[0]-1<<1|a[1]>>6;e.#b===r&&(e.#S=Date.now()+3200),e.#T[r]?.length||(e.#T[r]=new Uint8Array(256));let l=e.#T[r];T()&&console.debug(`GS frame draw page ${r}.`);let o=a[1]&63;a.subarray(2).forEach(function(u,p){let w=p+o,E=w>>4,$=w&15,S=($*4+E)*5,R=5,O=0;for(S-=$*4,E===3&&(R=1);O<R;)l[S+O]=u>>4-O&1,O++})}else console.warn(`Unknown GS display section: ${a[0]}`)}}).add([69,18,32],(a,n,s)=>{let r=a[0],l=a[1],o=a.subarray(2);if(r>>4){console.warn(`SC-8850 partial screen dump out of bounds: invalid bundle.
`,a);return}let f=l+o.length,u=l*6-(l*2428>>16<<1),p=f*6-(f*2428>>16<<1);if(u>640){console.warn(`SC-8850 partial screen dump out of bounds: invalid buffer range.
`,a);return}p>640&&(console.info(`SC-8850 partial screen dump out of bounds: invalid buffer end, automatically restricted.
`,a),p=640);let w=new Uint8Array(p-u);o.forEach((S,R)=>{let O=R+l,U=(O*2428&65535)*27>>16===26,we=O*6-(O*2428>>16<<1),fe=U?2:0;for(;fe<6;)w[we+(5-fe)]=S>>fe&1,fe++});let E=r*108+l,$=E*6-(E*2428>>16<<1);e.dispatchEvent("screen",{type:"sc8850",offset:$,data:w}),T()&&console.debug(`SC-8850 screen dump: bundle ${r+1}, range ${u}~${p}`)});let g=function(a,n,s){e.invokeSysExIndicator();let r=a[0],l=M[n],o=Z[n],f=`GS CH${n+1} `;r<3?(a.subarray(1).forEach((u,p)=>{[()=>{e.#e[l+v[0]]=u,e.pushChPrimitives(n)},()=>{e.#n[n]=u},()=>{let w=0;u<16?w=e.chRedir(u,s,!0):w=y.ch;let E=e.#f[n];e.#f[n]=w,(n!==w||w!==E)&&(e.buildRchTree(),console.info(`${f}receives from CH${w+1}`))}][r+p]()}),e.pushChPrimitives(n)):r<19||(r<44?a.subarray(1).forEach((u,p)=>{([()=>{e.#d[n]=+!u},!1,()=>{e.setChType(n,u<<1,k.gs),console.debug(`${f}type: ${u?"drum ":"melodic"}${u||""}`)},()=>{e.#s[o+3]=u,e.#o[y.rpnt*n+2]=1,e.dispatchEvent("pitch",{part:n,pitch:e.getPitchShift(n)})},!1,()=>{e.#e[l+v[7]]=u},!1,!1,()=>{e.#e[l+v[10]]=u||128},!1,!1,()=>{console.debug(`${f}CC 1: cc${u}`)},()=>{console.debug(`${f}CC 2: cc${u}`)},()=>{e.#e[l+v[93]]=u},()=>{e.#e[l+v[91]]=u},!1,!1,()=>{e.#s[o+1]=u,e.#o[y.rpnt*n+1]=1,e.dispatchEvent("pitch",{part:n,pitch:e.getPitchShift(n)})},()=>{e.#s[o+2]=u,e.#o[y.rpnt*n+1]=1,e.dispatchEvent("pitch",{part:n,pitch:e.getPitchShift(n)})},()=>{e.#e[l+v[94]]=u}][r+p-19]||(()=>{}))()}):r<76||console.debug(`Unknown GS part address: ${r}`))},b=function(a,n){let s=a[0],r=`GS CH${n+1} `;s<2?a.subarray(1).forEach((l,o)=>{[()=>{e.setChCc(n,32,l)},()=>{}][s+o]()}):s<32?console.warn(`Unknown GS misc address: ${s}`):s<35?a.subarray(1).forEach((l,o)=>{[()=>{console.debug(`${r}EQ: o${["ff","n"][l]}`)},()=>{},()=>{console.debug(`${r}EFX: o${["ff","n"][l]}`),e.setChEffectSink(n,l?3:0)}][s+o-32]()}):console.warn(`Unknown GS misc address: ${s}`)};this.#F.add([66,18,64,16],(a,n)=>{g(a,e.chRedir(9,n,!0),n)}).add([66,18,64,17],(a,n)=>{g(a,e.chRedir(0,n,!0),n)}).add([66,18,64,18],(a,n)=>{g(a,e.chRedir(1,n,!0),n)}).add([66,18,64,19],(a,n)=>{g(a,e.chRedir(2,n,!0),n)}).add([66,18,64,20],(a,n)=>{g(a,e.chRedir(3,n,!0),n)}).add([66,18,64,21],(a,n)=>{g(a,e.chRedir(4,n,!0),n)}).add([66,18,64,22],(a,n)=>{g(a,e.chRedir(5,n,!0),n)}).add([66,18,64,23],(a,n)=>{g(a,e.chRedir(6,n,!0),n)}).add([66,18,64,24],(a,n)=>{g(a,e.chRedir(7,n,!0),n)}).add([66,18,64,25],(a,n)=>{g(a,e.chRedir(8,n,!0),n)}).add([66,18,64,26],(a,n)=>{g(a,e.chRedir(10,n,!0),n)}).add([66,18,64,27],(a,n)=>{g(a,e.chRedir(11,n,!0),n)}).add([66,18,64,28],(a,n)=>{g(a,e.chRedir(12,n,!0),n)}).add([66,18,64,29],(a,n)=>{g(a,e.chRedir(13,n,!0),n)}).add([66,18,64,30],(a,n)=>{g(a,e.chRedir(14,n,!0),n)}).add([66,18,64,31],(a,n)=>{g(a,e.chRedir(15,n,!0),n)}).add([66,18,64,64],(a,n)=>{b(a,e.chRedir(9,n,!0))}).add([66,18,64,65],(a,n)=>{b(a,e.chRedir(0,n,!0))}).add([66,18,64,66],(a,n)=>{b(a,e.chRedir(1,n,!0))}).add([66,18,64,67],(a,n)=>{b(a,e.chRedir(2,n,!0))}).add([66,18,64,68],(a,n)=>{b(a,e.chRedir(3,n,!0))}).add([66,18,64,69],(a,n)=>{b(a,e.chRedir(4,n,!0))}).add([66,18,64,70],(a,n)=>{b(a,e.chRedir(5,n,!0))}).add([66,18,64,71],(a,n)=>{b(a,e.chRedir(6,n,!0))}).add([66,18,64,72],(a,n)=>{b(a,e.chRedir(7,n,!0))}).add([66,18,64,73],(a,n)=>{b(a,e.chRedir(8,n,!0))}).add([66,18,64,74],(a,n)=>{b(a,e.chRedir(10,n,!0))}).add([66,18,64,75],(a,n)=>{b(a,e.chRedir(11,n,!0))}).add([66,18,64,76],(a,n)=>{b(a,e.chRedir(12,n,!0))}).add([66,18,64,77],(a,n)=>{b(a,e.chRedir(13,n,!0))}).add([66,18,64,78],(a,n)=>{b(a,e.chRedir(14,n,!0))}).add([66,18,64,79],(a,n)=>{b(a,e.chRedir(15,n,!0))}),this.#q.add([54,65],(a,n)=>{let s=e.#i.x5===81?"05rw":"x5d";e.switchMode(s,!0),e.setPortMode(e.getTrackPort(n),1,k[s]);let r=a[a.length-1],l=a.subarray(0,a.length-1),o=Q(l);o!==r&&(console.info(`X5D multi parameters checksum mismatch! Expected ${o}, got ${r}.`),console.debug(a));let f=(a[1]<<7)+a[0],u=(a[3]<<7)+a[2],p=e.chRedir(f&15,n,!0),w=M[p];[()=>{u<1||(u<101?(e.setChType(p,e.CH_MELODIC,k.x5d),e.#n[p]=u-1,e.#e[w+v[0]]=e.#i.x5):u<229?(e.setChType(p,e.CH_MELODIC,k.x5d),e.#n[p]=u-101,e.#e[w+v[0]]=56):(e.setChType(p,e.CH_DRUMS,k.x5d),e.#n[p]=ct[u-229]||0,e.#e[w+v[0]]=62)),e.pushChPrimitives(p)},()=>{e.#e[w+v[7]]=u},()=>{u<31&&(e.#e[w+v[10]]=Math.round((u-15)*4.2+64))},()=>{e.#e[w+v[93]]=ne(u)},()=>{e.#e[w+v[91]]=ne(u)},()=>{e.#s[p*y.rpn+3]=u>8191?u-16320:64+u,e.#o[y.rpnt*p+2]=1,e.dispatchEvent("pitch",{part:p,pitch:e.getPitchShift(p)})},()=>{e.#s[p*y.rpn+1]=u>8191?u-16320:64+u,e.#o[y.rpnt*p+1]=1,e.dispatchEvent("pitch",{part:p,pitch:e.getPitchShift(p)})},()=>{u>0&&(e.#s[p*y.rpn]=u,e.#o[y.rpnt*p]=1,e.dispatchEvent("pitch",{part:p,pitch:e.getPitchShift(p)}))},()=>{}][f>>4]()}).add([54,76,0],(a,n)=>{e.invokeSysExIndicator();let s=e.#i.x5===81?"05rw":"x5d";e.switchMode(s),e.setPortMode(e.getTrackPort(n),1,k[s]);let r="",l=e.#i.x5,o=0,f=0,u="MSB	PRG	LSB	NME";H(a,function(p,w){if(w<16400){let E=w%164;switch(!0){case E<10:{p>31&&(r+=String.fromCharCode(p));break}case E===10:break;case E===11:{u+=`
${l}	${o}	${f}	${r.trim().replace("Init Voice","")}`,o++,r="";break}}o>99&&(l=90,o=0)}}),e.userBank.clearRange({msb:e.#i.x5,prg:[0,99],lsb:0}),e.userBank.load(u),T()&&console.debug(u),e.forceVoiceRefresh()}).add([54,77,0],(a,n)=>{e.invokeSysExIndicator();let s=e.#i.x5===81?"05rw":"x5d";e.switchMode(s),e.setPortMode(e.getTrackPort(n),1,k[s]);let r="",l=90,o=0,f=0,u="MSB	PRG	LSB	NME";H(a,function(p,w){if(w<13600){let E=w%136;switch(!0){case E<10:{p>31&&(r+=String.fromCharCode(p));break}case E===11:{u+=`
${l}	${o}	${f}	${r.trim().replace("Init Combi","")}`,o++,r="";break}}}}),e.userBank.clearRange({msb:90,prg:[0,99],lsb:0}),e.userBank.load(u),T()&&console.debug(u),e.forceVoiceRefresh()}).add([54,78],(a,n)=>{let s=e.#i.x5===81?"05rw":"x5d";e.switchMode(s),e.setPortMode(e.getTrackPort(n),1,k[s]),console.debug(`X5D mode switch requested: ${["combi","combi edit","prog","prog edit","multi","global"][a[0]]} mode.`)}).add([54,85],(a,n)=>{e.invokeSysExIndicator();let s=e.#i.x5===81?"05rw":"x5d";e.switchMode(s),e.setPortMode(e.getTrackPort(n),1,k[s]),H(a,(r,l)=>{l>0&&l<3&&(e.setEffectType(l-1,44,r),e.pushEffectType(l-1))})}).add([54,104],(a,n)=>{e.invokeSysExIndicator();let s=e.#i.x5===81?"05rw":"x5d";e.switchMode(s,!0);let r=e.getTrackPort(n);if(e.#k[r]&&e.#k[r]!==k[s])if(e.#g.dumpLimit===e.DUMP_MODE){console.warn(`Dump cancelled for track ${n}. Port ${String.fromCharCode(65+r)} mode "${A[e.#k[r]]}" mismatch, should be "${s}".`);return}else console.info(`Track ${n} is trying to perform a mismached mode dump on port ${String.fromCharCode(65+r)}.`);e.setPortMode(r,1,k[s]),H(a,function(l,o,f,u){if(o<192){let p=e.chRedir(Math.floor(o/12),n,!0),w=M[p];switch(o%12){case 0:{l<128?(e.setChType(p,e.CH_MELODIC,k.x5d),e.#e[w+v[0]]=e.#i.x5,e.#n[p]=l):(e.setChType(p,e.CH_DRUMS,k.x5d),e.#e[w+v[0]]=62,e.#n[p]=ct[l-128]),l>0&&e.setChActive(p,1),e.pushChPrimitives(p);break}case 1:{e.#e[w+v[7]]=l;break}case 2:{e.#s[p*y.rpn+3]=l>127?l-192:64+l,e.#o[y.rpnt*p+2]=1,e.dispatchEvent("pitch",{part:p,pitch:e.getPitchShift(p)});break}case 3:{e.#s[p*y.rpn+1]=l>127?l-192:64+l,e.#o[y.rpnt*p+1]=1,e.dispatchEvent("pitch",{part:p,pitch:e.getPitchShift(p)});break}case 4:{l<31&&(e.#e[w+v[10]]=Math.round((l-15)*4.2+64));break}case 5:{let E=l>>4,$=l&15;e.#e[w+v[91]]=ne($),e.#e[w+v[93]]=ne(E);break}case 10:{e.#r[p]||(e.#e[w+v[0]]=l>>6?56:e.#i.x5,e.pushChPrimitives(p));break}case 11:{let E=e.chRedir(l&15,n,!0),$=l>>4;e.#f[p]=l,(E!==p||$)&&console.info(`X5D Part CH${p+1} receives from CH${E+1}.`)}}}else{let p=e.chRedir(o-192,n,!0)}}),e.buildRchTree()}),this.#F.add([22,18,127],(a,n,s)=>{e.switchMode("mt32",!0),e.setPortMode(e.getTrackPort(n),1,k.mt32),e.#C=e.KARAOKE_NONE,e.userBank.clearRange({msb:0,lsb:127,prg:[0,127]}),console.info("MIDI reset: MT-32")}).add([22,18,0],(a,n,s)=>{e.switchMode("mt32");let r=e.chRedir(s,n,!0),l=a[1];a.subarray(2).forEach((o,f)=>{let u=f+l;e.#U[u+(r-1)*16]=o,([!1,()=>{let p=e.#U[r-1<<4];if(p<3){if(e.#L[r]=1,p===2)for(let w=0;w<name.length;w++)e.#w[(r-1)*y.cmt+w]=e.#t[o*y.cmt+w];else{let w=e.baseBank.get(0,o+(p<<6),127,"mt32").name;for(let E=0;E<w.length;E++)e.#w[(r-1)*y.cmt+E]=w.charCodeAt(E)}e.pushChPrimitives(r)}},()=>{e.#s[r*y.rpn+3]=o+40,e.#o[y.rpnt*r+2]=1},()=>{e.#s[r*y.rpn+1]=o+14,e.#o[y.rpnt*r+1]=1},()=>{e.#s[r*y.rpn]=o,e.#o[y.rpnt*r]=1},!1,()=>{e.setChCc(r,91,o?127:0)},!1,()=>{e.setChCc(r,7,o)},()=>{e.setChCc(r,10,Math.ceil(o*9.05))}][u]||(()=>{}))()})}).add([22,18,1],(a,n,s)=>{e.switchMode("mt32");let r=s&7;console.debug(`MT-32 slot #${s+1} Drum: ${a}`);let l=a[0]<<7|a[1];a.subarray(2).forEach((o,f)=>{let u=f+l,p=(u>>2)+24,w=u&3,E=r*y.dpn;if(T()&&console.debug(`MT-32 temp drum note ${p} param ${w}: ${o}`),p<24){console.warn(`MT-32 dev drum write attempted on an OOB note: ${p}`);return}[()=>{},()=>{e.#A[(E+X[26])*y.dnc+p]=Math.round(o*1.27)},()=>{e.#A[(E+X[26])*y.dnc+p]=o*9+1&127},()=>{e.#A[(E+X[26])*y.dnc+p]=o?127:0}][w]()})}).add([22,18,2],(a,n,s)=>{e.switchMode("mt32");let r=e.chRedir(s,n,!0),l=a[1]+(a[0]<<7);l<10&&(e.#L[r]=1),a.subarray(2).forEach((o,f)=>{let u=f+l;u<14&&(e.#w[(r-1)*y.cmt+u]=o)}),e.pushChPrimitives(r)}).add([22,18,3],(a,n,s)=>{e.switchMode("mt32");let r=s&7;if(a[0]){let l=(a[0]-1<<7)+a[1]-16;a.subarray(2).forEach((o,f)=>{let u=f+l,p=(u>>2)+24,w=u&3,E=r*y.dpn;if(T()&&console.debug(`MT-32 dev drum note ${p} param ${w}: ${o}`),p<24){console.warn(`MT-32 dev drum write attempted on an OOB note: ${p}`);return}[()=>{},()=>{e.#A[(E+X[26])*y.dnc+p]=Math.round(o*1.27)},()=>{e.#A[(E+X[26])*y.dnc+p]=o*9+1&127},()=>{e.#A[(E+X[26])*y.dnc+p]=o?127:0}][w]()})}else{let l=a[1];a.subarray(2).forEach((o,f)=>{let u=f+l;e.#U[u]=o;let p=e.chRedir(1+(u>>4),n,!0),w=u&15;([!1,()=>{let E=e.#U[p-1<<4];if(E<3)if(e.#L[p]=1,E===2)for(let $=0;$<name.length;$++)e.#w[(p-1)*y.cmt+$]=e.#t[o*y.cmt+$];else{let $=e.baseBank.get(0,o+(E<<6),127,"mt32").name;for(let S=0;S<$.length;S++)e.#w[(p-1)*y.cmt+S]=$.charCodeAt(S)}e.pushChPrimitives(p)},()=>{e.#s[p*y.rpn+3]=o+40,e.#o[y.rpnt*p+2]=1},()=>{e.#s[p*y.rpn+1]=o+14,e.#o[y.rpnt*p+1]=1},()=>{e.#s[p*y.rpn]=o,e.#o[y.rpnt*p]=1},!1,()=>{e.setChCc(p,91,o?127:0)},!1,()=>{e.setChCc(p,7,o)},()=>{e.setChCc(p,10,Math.ceil(o*9.05))}][w]||(()=>{}))()})}}).add([22,18,4],(a,n,s)=>{e.switchMode("mt32");let r=a[1]+(a[0]<<7),l=[];a.subarray(2).forEach((o,f)=>{let u=f+r,p=e.chRedir(Math.floor(u/246+1),n,!0),w=u%246;w<14&&(e.#w[(p-1)*y.cmt+w]=o),w<10&&(e.#L[p]=1),l.indexOf(p)<0&&l.push(p)}),l.forEach(o=>{e.pushChPrimitives(o)})}).add([22,18,5],(a,n,s)=>{e.switchMode("mt32");let r=(a[0]<<7)+a[1];a.subarray(2).forEach((l,o)=>{let f=r+o,u=Math.floor(f/8),p=f&7,w=u*8;e.#j[f]=l,([!1,()=>{let E=e.#j[w];if(E<3){let $="";if(E===2){let R=y.cmt*u;$=`MT-m:${l.toString().padStart(3,"0")}`}else $=e.baseBank.get(0,l+(E<<6),127,"mt32").name;e.userBank.clearRange({msb:0,lsb:127,prg:u});let S=`MSB	LSB	PRG	NME
49	127	${u}	${$}`;e.userBank.load(S,!0)}}][p]||(()=>{}))()}),e.forceVoiceRefresh()}).add([22,18,8],(a,n,s)=>{e.switchMode("mt32");let r=((a[0]&1)<<7)+a[1],l=a[0]>>1,o=!1;if(a.subarray(2).forEach((f,u)=>{let p=r+u;p<y.cmt&&(e.#t[l*y.cmt+p]=f,o=!0)}),o){e.userBank.clearRange({msb:0,lsb:127,prg:l});let f=`MSB	LSB	PRG	NME
49	127	${l}	MT-m:${l}`;e.userBank.load(f,!0)}e.forceVoiceRefresh()}).add([22,18,16],(a,n,s)=>{e.switchMode("mt32");let r=a[1],l=!1,o=function(f,u){e.#f[u-12]=f,l=!0};a.subarray(2).forEach((f,u)=>{let p=u+r;([!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,o,o,o,o,o,o,o,o,o,()=>{e.#m=f,e.dispatchEvent("mastervolume",e.#m)}][p]||(()=>{}))(f,u)}),l&&e.buildRchTree()}).add([22,18,32],(a,n,s)=>{e.switchMode("mt32");let r=a[1],l=" ".repeat(r);a.subarray(2).forEach(o=>{o>31?l+=String.fromCharCode(o):l+=" "}),e.#J=l.padStart(20," "),e.#z=Date.now()+3200}).add([22,18,82],(a,n)=>{let s=e.chRedir(0,n,!0);for(let r=0;r<16;r++)e.#I.ano(s+r),r&&r<10&&(e.#n[s+r]=Te[r-1]);console.info("MT-32 alt reset complete.")}),this.#q.add([66,0],(a,n)=>{e.switchMode("ns5r",!0),e.setPortMode(e.getTrackPort(n),2,k.ns5r),e.#C=e.KARAOKE_NONE,console.debug(`NS5R mode switch requested: ${["global","multi","prog edit","comb edit","drum edit","effect edit"][a[0]]} mode.`)}).add([66,1],(a,n)=>{let s=["ns5r","05rw"][a[0]];e.switchMode(s,!0),e.setPortMode(e.getTrackPort(n),2,k[s]),e.#C=e.KARAOKE_NONE}).add([66,18,0,0],(a,n)=>{let s=a[0];switch(s){case 124:case 126:case 127:{e.switchMode("ns5r",!0),e.setPortMode(e.getTrackPort(n),2,k.ns5r),e.#C=e.KARAOKE_NONE;break}case 125:{e.initDrums(),console.info(`NS5R drum setup reset on drum kit ${a[1]}.`);break}default:if(s<10){let r=[0,0,0,0],l=(o,f)=>{r[f]=o};if(a.subarray(1).forEach((o,f)=>{[l,l,l,l,()=>{e.#m=o*129/16383*100,e.dispatchEvent("mastervolume",e.#m)},()=>o-64,()=>o-64,()=>{},()=>{},()=>{}][s+f]()}),a[0]<4){let o=0;r.forEach(f=>{o=o<<4,o+=f}),o-=1024,console.debug(`Master tune: ${o}`)}}}}).add([66,18,0,1],(a,n)=>{}).add([66,18,0,2],(a,n)=>{}).add([66,18,1],(a,n)=>{e.invokeSysExIndicator();let s=e.chRedir(a[0],n,!0),r=M[s],l=a[1],o=`NS5R CH${s+1} `;a.subarray(2).forEach((f,u)=>{let p=l+u;p<3?([()=>{e.#e[r+v[0]]=f||K.bank0,e.pushChPrimitives(s)},()=>{e.#e[r+v[32]]=f,e.pushChPrimitives(s)},()=>{e.#n[s]=f}][p](),e.pushChPrimitives(s)):p<8||(p<14?[()=>{let w=e.chRedir(f,n,!0),E=e.#f[s];e.#f[s]=w,(s!==w||w!==E)&&(e.buildRchTree(),console.info(`${o}receives from CH${w+1}`))},()=>{e.#d[s]=+!f},()=>{e.setChType(s,f,k.ns5r),console.debug(`${o}type: ${se[f]}`)},()=>{e.#s[y.rpn*s+3]=f,e.#o[y.rpnt*s+2]=1,e.dispatchEvent("pitch",{part:s,pitch:e.getPitchShift(s)})},()=>{},()=>{}][p-8]():p<16||(p<33?[()=>{e.#e[r+v[7]]=f},()=>{e.#e[r+v[11]]=f},()=>{},()=>{},()=>{e.#e[r+v[10]]=f||128},()=>{},()=>{},()=>{e.#e[r+v[93]]=f},()=>{e.#e[r+v[91]]=f},()=>{e.#e[r+v[76]]=f},()=>{e.#e[r+v[77]]=f},()=>{e.#e[r+v[78]]=f},()=>{e.#e[r+v[74]]=f},()=>{e.#e[r+v[71]]=f},()=>{e.#e[r+v[73]]=f},()=>{e.#e[r+v[75]]=f},()=>{e.#e[r+v[72]]=f}][p-16]():p<112||p<114&&[()=>{e.#e[r+v[5]]=f},()=>{e.#e[r+v[65]]=f}][p-112]()))})}).add([66,18,8,0],(a,n)=>{let s=a[0];if(s<32)e.setLetterDisplay(a.subarray(1,33),"NS5R letter display");else{let r=s-32;e.#S=Date.now()+3200,e.#b=10;let l=a.subarray(1),o=4;l.forEach(function(f,u){let p=u+r,w=p>>4,E=p&15;if(p<80){let $=w<o?f:f>>3,S=0,R=w<o?6:3;for(;$>0;)e.#$[E*32+w*7+(R-S)]=$&1,$=$>>1,S++}})}}).add([66,18,48],(a,n,s)=>{d(0,a)}).add([66,18,49],(a,n,s)=>{d(1,a)}).add([66,18,50],(a,n,s)=>{d(2,a)}).add([66,18,51],(a,n,s)=>{d(3,a)}).add([66,18,52],(a,n,s)=>{d(4,a)}).add([66,18,53],(a,n,s)=>{d(5,a)}).add([66,18,54],(a,n,s)=>{d(6,a)}).add([66,18,55],(a,n,s)=>{d(7,a)}).add([66,52],(a,n)=>{e.switchMode("ns5r"),e.#C=e.KARAOKE_NONE;let s="";H(a,(r,l)=>{l<8?(r>31&&(s+=String.fromCharCode(r)),l===7&&(e.aiEfxName=s)):l<10&&(e.setEffectType(l-8,44,r),e.pushEffectType(l-8))})}).add([66,53],(a,n)=>{e.invokeSysExIndicator(),e.switchMode("ns5r"),e.#C=e.KARAOKE_NONE;let s="",r=a[a.length-1],l=a.subarray(0,a.length-1),o=Q(l);o!==r&&(console.info(`NS5R current multi dump checksum mismatch! Expected ${o}, got ${r}.`),console.debug(a));let f=e.getTrackPort(n);if(e.#k[f]&&e.#k[f]!==k.ns5r)if(e.#g.dumpLimit===e.DUMP_MODE){console.warn(`Dump cancelled for track ${n}. Port ${String.fromCharCode(65+f)} mode "${A[e.#k[f]]}" mismatch, should be "ns5r".`);return}else console.info(`Track ${n} is trying to perform a mismached mode dump on port ${String.fromCharCode(65+f)}.`);e.setPortMode(f,2,k.ns5r),H(l,function(u,p){switch(!0){case p<2944:{let w=e.chRedir(Math.floor(p/92),n,!0),E=M[w];switch(p%92){case 0:{e.#e[E+v[0]]=u,e.pushChPrimitives(w),e.pushChPrimitives(w);break}case 1:{e.#e[E+v[32]]=u,!u&&!e.#e[E+v[0]]&&(e.#e[E+v[0]]=K.bank0),e.pushChPrimitives(w);break}case 2:{e.#n[w]=u,u>0&&e.setChActive(w,1);break}case 3:{let $=e.chRedir(u,n,!0);e.#f[w]=$,w!==$&&console.info(`NS5R CH${w+1} receives from CH${$+1}.`);break}case 7:{e.#r[w]=u,e.pushChPrimitives(w);break}case 8:{e.#s[w*y.rpn+3]=u<40||u>88?u+(u>63?-192:64):u,e.#o[y.rpnt*w+2]=1,e.dispatchEvent("pitch",{part:w,pitch:e.getPitchShift(w)});break}case 9:case 10:{e.#e[E+v[7]]=u;break}case 11:{e.#e[E+v[11]]=u;break}case 14:{e.#e[E+v[10]]=u||128;break}case 19:{e.#e[E+v[93]]=u;break}case 20:{e.#e[E+v[91]]=u;break}case 84:{e.#e[E+v[65]]=u;break}case 85:{e.#e[E+v[5]]=u;break}}break}case p<3096:break;case p<3134:{let w=p-3096;w<8?(u>31&&(s+=String.fromCharCode(u)),w===7&&(e.aiEfxName=s)):w<10&&(e.setEffectType(w-8,44,u),e.pushEffectType(w-8));break}case p<8566:break}}),e.buildRchTree()}).add([66,54],(a,n)=>{e.invokeSysExIndicator(),e.switchMode("ns5r");let s="",r=80,l=0,o=0,f="MSB	PRG	LSB	NME";H(a,function(u,p){let w=p%158;switch(!0){case w<10:{u>31&&(s+=String.fromCharCode(u));break}case w===10:break;case w===11:{r=u&127;break}case w===12:{o=u&127;break}case w===13:{f+=`
${r}	${l}	${o}	${s.trim().replace("Init Voice","")}`,l++,s="";break}}}),e.userBank.clearRange({msb:80,lsb:0}),e.userBank.load(f),T()&&console.debug(f),e.forceVoiceRefresh()}).add([66,55],(a,n)=>{e.invokeSysExIndicator(),e.switchMode("ns5r");let s="",r=88,l=0,o=0,f="MSB	PRG	LSB	NME";H(a,function(u,p){let w=p%126;switch(!0){case w<10:{u>31&&(s+=String.fromCharCode(u));break}case w===11:break;case w===12:break;case w===13:{f+=`
${r}	${l}	${o}	${s.trim().replace("Init Combi","")}`,l++,s="";break}}}),e.userBank.clearRange({msb:88,lsb:0}),e.userBank.load(f),T()&&console.debug(f),e.forceVoiceRefresh()}).add([66,125],(a,n,s)=>{e.dispatchEvent("backlight",["green","orange","red",!1,"yellow","blue","purple"][a[0]]||"white")}).add([66,127],(a,n,s)=>{let r=a[a.length-1],l=a.subarray(0,a.length-1),o=Q(l);o!==r&&(console.info(`NS5R screen dump checksum mismatch! Expected ${o}, got ${r}.`),console.debug(a));let f=new Uint8Array(5760);H(a,(u,p,w)=>{if(p<720)for(let E=0;E<8;E++)f[p*8+E]=u>>7-E&1}),e.dispatchEvent("screen",{type:"ns5r",data:f})}).add([76],(a,n,s)=>{e.#q.run([66,...a],n,s)}),e.#fe.add([16,0,8,0],(a,n,s)=>{let r=(a[2]<<4)+a[3],l="K11 ";([()=>{e.switchMode("k11",!0),e.setPortMode(e.getTrackPort(n),2,k.k11),e.#C=e.KARAOKE_NONE,e.#p[k.k11][1]=r?4:0,console.info("MIDI reset: GMega/K11")},()=>{e.setEffectType(0,24,r),console.debug(`${l}reverb type: ${r}`),e.pushEffectType(0)},()=>{console.debug(`${l}reverb time: ${r}`)},()=>{console.debug(`${l}reverb time: ${r}`)},()=>{console.debug(`${l}reverb predelay: ${r}`)},()=>{console.debug(`${l}reverb predelay: ${r}`)},()=>{console.debug(`${l}depth high: ${r}`)},()=>{console.debug(`${l}depth high: ${r}`)},()=>{console.debug(`${l}depth low: ${r}`)},()=>{console.debug(`${l}depth low: ${r}`)}][a[0]]||(()=>{}))()}).add([16,0,8,1],(a,n,s)=>{e.invokeSysExIndicator();let r=e.chRedir(a[1],n,!0),l=M[r],o=Z[r],f=(a[3]<<4)+a[4],u=`GMega CH${r+1} `;([()=>{f<128?(e.setChType(r,e.CH_MELODIC,k.k11),e.#e[l+v[0]]=0,e.#n[r]=f):(e.setChType(r,e.CH_DRUMS,k.k11),e.#n[r]=f-128),e.pushChPrimitives(r)},()=>{let p=e.chRedir(f,n,!0),w=e.#f[r];e.#f[r]=p,(r!==p||p!==w)&&(e.buildRchTree(),console.info(`${u}receives from CH${p+1}`))},()=>{e.#e[l+v[7]]=f},()=>{uupThis.setChActive(r,f)},()=>{e.#e[l+v[10]]=f},()=>{e.#s[o+3]=f+40,e.#o[y.rpnt*r+2]=1,e.dispatchEvent("pitch",{part:r,pitch:e.getPitchShift(r)})},()=>{e.#s[o+1]=f>>1,e.#s[o+2]=f&1,e.#o[y.rpnt*r+1]=1,e.dispatchEvent("pitch",{part:r,pitch:e.getPitchShift(r)})},()=>{e.#e[l+v[91]]=f?127:0},()=>{},()=>{e.#e[l+v[74]]=f},()=>{e.#e[l+v[73]]=f},()=>{e.#e[l+v[72]]=f}][a[0]]||(()=>{}))()}).add([16,0,9,0],(a,n,s)=>{e.invokeSysExIndicator();let r=(a[2]<<4)+a[3],l="GMLX ";([()=>{console.debug(`${l}reverb type: ${r}`)},()=>{console.debug(`${l}reverb time: ${r}`)},()=>{console.debug(`${l}reverb predelay: ${r}`)},()=>{console.debug(`${l}depth high: ${r}`)},()=>{console.debug(`${l}depth low: ${r}`)}][a[0]]||(()=>{}))()}).add([16,0,9,3],(a,n,s)=>{e.invokeSysExIndicator();let r=(a[2]<<4)+a[3],l=e.chRedir(a[1],n,!0),o=M[l],f=`GMLX CH${l+1} `;[()=>{r<128?(e.setChType(l,e.CH_MELODIC,k.k11),e.#e[o+v[0]]=0,e.#e[o+v[32]]=0,e.#n[l]=r):r<160?(e.setChType(l,e.CH_MELODIC,k.k11),e.#e[o+v[0]]=0,e.#e[o+v[32]]=7,e.#n[l]=r-100):(e.setChType(l,e.CH_DRUMS,k.k11),e.#e[o+v[0]]=122,e.#e[o+v[32]]=0,e.#n[l]=r-160),e.pushChPrimitives(l)},()=>{let u=e.chRedir(r,n,!0),p=e.#f[l];e.#f[l]=u,(l!==u||u!==p)&&(e.buildRchTree(),console.info(`${f}receives from CH${u+1}`))}][a[0]]()}).add([16,0,9,4],(a,n,s)=>{e.invokeSysExIndicator();let r=(a[2]<<4)+a[3],l=e.chRedir(a[1],n,!0),o=M[l],f=Z[l];[()=>{e.setChActive(l,r)},()=>{e.#e[o+v[7]]=r},()=>{e.#e[o+v[10]]=r},()=>{e.#e[o+v[91]]=r?127:0},()=>{e.#s[f+3]=r+40,e.#o[y.rpnt*l+2]=1,e.dispatchEvent("pitch",{part:l,pitch:e.getPitchShift(l)})},()=>{e.#s[f+1]=r,e.#o[y.rpnt*l+1]=1,e.dispatchEvent("pitch",{part:l,pitch:e.getPitchShift(l)})},()=>{e.#s[f]=r,e.#o[y.rpnt*l]=1,e.dispatchEvent("pitch",{part:l,pitch:e.getPitchShift(l)})},()=>{}][a[0]]()}),this.#de.add([66,93,64],(a,n,s)=>{let r=a[2];switch(a[0]){case 0:{switch(a[1]){case 4:{e.invokeSysExIndicator(),e.#m=r*129/16383*100,e.dispatchEvent("mastervolume",e.#m);break}case 5:{e.invokeSysExIndicator(),r-64;break}case 6:{e.invokeSysExIndicator(),console.debug(`SG global reverb: ${r?"on":"off"}`);break}case 127:{e.switchMode("sg",!0),e.setPortMode(e.getTrackPort(n),1,k.sg);break}}break}case 1:{switch(a[1]){case 48:{e.invokeSysExIndicator(),console.debug(`SG reverb type: ${xe[r]}`);break}}break}default:if(a[0]>>4===1){e.invokeSysExIndicator();let l=e.chRedir(a[0]&15,n,!0);if(a[1]===2){let o=e.chRedir(r,n,!0),f=e.#f[l];e.#f[l]=o,(l!==o||o!==f)&&(e.buildRchTree(),console.info(`SG CH${l+1} receives from CH${o+1}`))}else a[1]===19&&e.setChCc(l,7,r)}else console.warn(`Unknown AKAI SG SysEx: ${a}`)}}),this.#he.add([9],(a,n,s)=>{e.invokeSysExIndicator(),console.debug(`GZ set effect: ${["stage reverb","hall reverb","room reverb","chorus","tremolo","phaser","rotary speaker","enhancer","flanger","EQ"][a[0]]||"off"}`)}),this.#D.add([127,0],(a,n,s)=>{e.switchMode("motif");let r=new Uint8Array([127,1,...a]);e.#D.run(r,n,s)}).add([127,1,0,0],(a,n,s)=>{e.switchMode("s90es");let r="S90/Motif ES system ",l=a[0];a.subarray(1).forEach((o,f)=>{([()=>{e.#m=o*12900/16383,e.dispatchEvent("mastervolume",e.#m)}][l+f]||(()=>{console.info(`Unrecognized ${r}ID: ${l+f}`)}))()})}).add([127,1,14],(a,n,s)=>{e.switchMode("s90es");let r="S90/Motif ES bulk header ",l=[];l[95]=(o,f,u)=>{console.debug(`${r}multi edit buffer: ${o[1]}`)},(l[a[0]]||(()=>{console.info(`Unrecognized ${r}ID: ${a[0]}.`)}))(a.subarray(1))}).add([127,1,15],(a,n,s)=>{e.switchMode("s90es");let r="S90/Motif ES bulk footer ",l=[];l[95]=(o,f,u)=>{console.debug(`${r}multi edit buffer: ${o[1]}`)},(l[a[0]]||(()=>{console.info(`Unrecognized ${r}ID: ${a[0]}.`)}))(a.subarray(1))}).add([127,1,54,1],(a,n,s)=>{e.switchMode("s90es");let r="S90/Motif ES reverb ",l=a[0];a.subarray(1).forEach((o,f)=>{([()=>{e.setEffectTypeRaw(0,!1,o&15|128)},()=>{e.setEffectTypeRaw(0,!0,o)}][l+f]||(()=>{}))()}),e.pushEffectType(0)}).add([127,1,54,2],(a,n,s)=>{e.switchMode("s90es");let r="S90/Motif ES chorus ",l=a[0];a.subarray(1).forEach((o,f)=>{([()=>{e.setEffectTypeRaw(1,!1,o&15|128)},()=>{e.setEffectTypeRaw(1,!0,o)}][l+f]||(()=>{}))()}),e.pushEffectType(1)}).add([127,1,54,3],(a,n,s)=>{e.switchMode("s90es");let r="S90/Motif ES insert 1 ",l=a[0];a.subarray(1).forEach((o,f)=>{([()=>{e.setEffectTypeRaw(3,!1,o&15|128)},()=>{e.setEffectTypeRaw(3,!0,o)}][l+f]||(()=>{}))()}),e.pushEffectType(3)}).add([127,1,54,4],(a,n,s)=>{e.switchMode("s90es");let r="S90/Motif ES insert 2 ",l=a[0];a.subarray(1).forEach((o,f)=>{([()=>{e.setEffectTypeRaw(4,!1,o&15|128)},()=>{e.setEffectTypeRaw(4,!0,o)}][l+f]||(()=>{}))()}),e.pushEffectType(4)}).add([127,1,54,16],(a,n,s)=>{e.switchMode("s90es");let r=a[0];a.subarray(1).forEach((l,o)=>{let u=`S90/Motif ES EQ${(o>>2)+1} `;([()=>{let p=l-64},()=>{let p=J[l]},()=>{let p=l/10},()=>{let p=l}][r+o&3]||(()=>{}))()})}).add([127,1,54,17],(a,n,s)=>{e.switchMode("s90es");let r="S90/Motif ES variation ",l=a[0];a.subarray(1).forEach((o,f)=>{([()=>{e.setEffectTypeRaw(2,!1,o&15|128)},()=>{e.setEffectTypeRaw(2,!0,o)}][l+f]||(()=>{}))()}),e.pushEffectType(2)}).add([127,1,55],(a,n,s)=>{e.invokeSysExIndicator(),e.switchMode("s90es");let r=e.getTrackPort(n);if(e.#k[r]&&e.#k[r]!==e.#i.smotif)if(e.#g.dumpLimit===e.DUMP_MODE){console.warn(`Dump cancelled for track ${n}. Port ${String.fromCharCode(65+r)} mode "${A[e.#k[r]]}" mismatch, should be "${A[e.#i.smotif]}".`);return}else console.info(`Track ${n} is trying to perform a mismached mode dump on port ${String.fromCharCode(65+r)}.`);let l=e.chRedir(a[0],n,!0),o=M[l],f=a[1];a[0]>15&&(l=a[0]+32);let u=`Track ${n} S90/Motif ES bulk CH${l<128?l+1:"U"+(l-127)} `;console.debug(u,a),!(a[0]>15)&&a.subarray(2).forEach((p,w)=>{([()=>{e.setChCc(l,0,p),e.pushChPrimitives(l)},()=>{p&&e.setChActive(l,1),e.setChCc(l,32,p),e.getChPrimitive(l,1)===63&&e.setChType(l,[32,40].indexOf(p)>-1?e.CH_DRUMS:e.CH_MELODIC,e.#a,!0),e.pushChPrimitives(l)},()=>{p&&e.setChActive(l,1),e.#n[l]=p,e.pushChPrimitives(l)},()=>{let E=e.chRedir(p,n,!0),$=e.#f[l];e.#f[l]=E,(l!==E||E!==$)&&(e.buildRchTree(),console.info(`${u}receives from CH${E+1}`))},()=>{e.#d[l]=p?0:1},!1,!1,!1,!1,!1,!1,!1,!1,()=>{p!==100&&e.setChActive(l,1),e.#e[o+v[7]]=p},()=>{p!==64&&e.setChActive(l,1),e.#e[o+v[10]]=p},!1,!1,!1,()=>{e.#e[o+v[91]]=p},()=>{p&&e.setChActive(l,1),e.#e[o+v[93]]=p},()=>{p&&e.setChActive(l,1),e.#e[o+v[94]]=p},()=>{e.setChCc(l,128,p),p!==127&&(e.setChActive(l,1),e.allocateAce(l,128))},()=>{},()=>{p!==64&&e.setChActive(l,1),e.#e[o+v[74]]=p},()=>{p!==64&&e.setChActive(l,1),e.#e[o+v[71]]=p},!1,()=>{e.#e[o+v[65]]=p},()=>{e.#e[o+v[5]]=p},()=>{}][f+w]||(()=>{}))()})}),e.#D.add([100,14],(a,n,s)=>{e.switchMode("cs6x"),e.setPortMode(e.getTrackPort(n),1,k.cs6x);let r=["normal voice","plugin voice PLG","drums",,"performance",,"phrase clip"][a[0]>>4]??"invalid";a[0]&!0?r+=" edit buffer":a[0]>>4==1?r+=`${(a[0]&1)+1}`:r+=` ${["INT","EXT"][a[0]&1]}`,console.debug(`CS6x bulk dump for ${r} started.`)}).add([100,15],(a,n,s)=>{e.switchMode("cs6x");let r=["normal voice","plugin voice PLG","drums",,"performance",,"phrase clip"][a[0]>>4]??"invalid";a[0]&!0?r+=" edit buffer":a[0]>>4==1?r+=`${(a[0]&1)+1}`:r+=` ${["INT","EXT"][a[0]&1]}`,console.debug(`CS6x bulk dump for ${r} ended.`)}).add([100,76,112],(a,n,s)=>{e.switchMode("cs6x");let r=0,l=a[0];a.subarray(1).forEach((o,f)=>{let u=f+l;u<10?(e.setChCvnRegister(r,f,o&127),e.#L[r]=1):u<12||u<13&&console.debug(`Plugin voice type: ${o}`)}),e.pushChPrimitives(r)}).add([100,76,0],(a,n,s)=>{e.switchMode("cs6x"),e.setPortMode(e.getTrackPort(n),1,k.cs6x);let r=0,l=a[0];a.subarray(1).forEach((o,f)=>{let u=f+l;([()=>{e.setChCc(r,7,o),o!==100&&e.setChActive(r,1)},,,()=>{e.#d[r]=o==0,e.setChCc(r,64,0),e.#I.ano(r),e.resetChAceAll(r)},,()=>{},,,()=>{e.setChCc(r,65,o?127:0)},()=>{e.setChCc(r,5,o)},,()=>{e.setChCc(r,91,o),o!==40&&e.setChActive(r,1)},()=>{e.setChCc(r,93,o),o&&e.setChActive(r,1)}][u]||(()=>{}))()})}).add([100,76,1],(a,n,s)=>{e.switchMode("cs6x");let r=0,l=a[0],o=!1;a.subarray(1).forEach((f,u)=>{let p=u+l;([()=>{e.setEffectTypeRaw(0,!1,f&15|128),o=!0},()=>{e.setEffectTypeRaw(0,!0,f),o=!0}][p]||(()=>{}))()}),o&&e.pushEffectType(0)}).add([100,76,2],(a,n,s)=>{e.switchMode("cs6x");let r=0,l=a[0],o=!1;a.subarray(1).forEach((f,u)=>{let p=u+l;([()=>{e.setEffectTypeRaw(1,!1,f&15|128),o=!0},()=>{e.setEffectTypeRaw(1,!0,f),o=!0}][p]||(()=>{}))()}),o&&e.pushEffectType(1)}).add([100,76,3],(a,n,s)=>{e.switchMode("cs6x");let r=0,l=a[0],o=!1;a.subarray(1).forEach((f,u)=>{let p=u+l;([()=>{e.setEffectTypeRaw(2,!1,f&15|128),o=!0},()=>{e.setEffectTypeRaw(2,!0,f),o=!0}][p]||(()=>{}))()}),o&&e.pushEffectType(2)}).add([100,76,5],(a,n,s)=>{e.switchMode("cs6x")}).add([100,76,16],(a,n,s)=>{e.switchMode("cs6x");let r=0,l=a[0],o=!1;if(a.subarray(1).forEach((f,u)=>{let p=u+l;([()=>{e.setChCc(r,0,f),o=!0},()=>{e.setChCc(r,32,f),o=!0,f&&e.setChActive(r,1)},()=>{e.#n[r]=f,o=!0,f&&e.setChActive(r,1)},()=>{e.#o[Z[r]+he[2]]=1,e.#s[Z[r]+he[2]]=f,f&&e.setChActive(r,1)}][p]||(()=>{}))()}),o){switch(e.pushChPrimitives(r),e.getChVoice(r).standard){case"DX":{e.#x[r]=e.EXT_DX;break}case"VL":{e.#x[r]=e.EXT_VL;break}}e.dispatchEvent("metacommit",{type:"OSysMeta",msg:"part.rename",data:{part:r}})}}).add([100,76,32],(a,n,s)=>{e.switchMode("cs6x");let r=0,l=a[0],o=e.#x[r];switch(o){case e.EXT_DX:{a.length>2&&console.debug(a),a.subarray(1).forEach((f,u)=>{let p=u+l;if(p<6){let w=p+142;e.setChCc(r,w,f),f!==64&&e.allocateAce(r,w)}else if(p<12){let w=p+144;e.setChCc(r,w,f),f!==64&&e.allocateAce(r,w)}else([()=>{},()=>{},()=>{},()=>{}][p]||(()=>{}))()});break}case e.EXT_VL:{console.info(`Support for Modular System Plug-in writes is not yet present for plugin type ${o}.`);break}default:console.warn(`Unsupported plug-in type: ${o}`)}}),this.#F.add([0,72,18,0,0,0,0],(a,n,s)=>{e.switchMode("sd",!0),e.setPortMode(e.getTrackPort(n),2,k.sd),console.info("MIDI reset: SD")}).add([0,72,18,16,0],(a,n,s)=>{e.invokeSysExIndicator();let r=a[0]>>5,l=a[0]&31;switch(r){case 0:{let o=a[0]>>1,f=a[1];switch(o){case 1:{a.subarray(2).forEach((u,p,w)=>{let E=p+f;switch(E){case 0:{u&&(e.setEffectType(1,60,u-1),e.pushEffectType(1),console.debug(`SD MFX Cho: ${E} - ${u}`));break}}});break}case 2:{a.subarray(2).forEach((u,p)=>{let w=p+f;switch(w){case 0:{u&&(e.setEffectType(0,55+u,0),e.pushEffectType(0),console.debug(`SD MFX Rev: ${w} - ${u}`));break}}});break}case 3:case 4:case 5:{let u=o-1;a.subarray(2).forEach((p,w)=>{let E=w+f;switch(console.debug(`SD MFX ${u-2}: ${E} - ${p}`),E){case 0:{e.setEffectTypeRaw(u,62,p),e.pushEffectType(u);break}}}),console.debug(`SD MFX message:
%o`,a);break}default:console.debug(`Unknown SD-90 global effects message:
%o`,a)}break}case 1:{let o=e.chRedir(l,n,!0),f=a[1],u=M[o];a.subarray(2).forEach((p,w)=>{let E=f+w;E<37?([()=>{},()=>{},0,()=>{},()=>{switch(p){case 104:case 105:case 106:case 107:case 120:case 128:{e.#r[o]||e.setChType(o,e.CH_DRUMS);break}default:e.#r[o]&&e.setChType(o,e.CH_MELODIC)}e.setChCc(o,0,p),e.pushChPrimitives(o)},()=>{e.#e[u+v[32]]=p,e.pushChPrimitives(o)},()=>{e.#n[o]=p},()=>{e.#e[u+v[7]]=p},()=>{e.#e[u+v[10]]=p},()=>{},()=>{},()=>{p<2&&(e.#d[o]=p)},()=>{p<2&&(e.#e[u+v[68]]=p?127:0)},()=>{},()=>{p<2&&(e.#e[u+v[65]]=p?127:0)},()=>{e.#e[u+v[5]]=p&15<<4|e.#e[u+v[5]]&15},()=>{e.#e[u+v[5]]=p&15|(e.#e[u+v[5]]&240)>>4},()=>{e.#e[u+v[74]]=p},()=>{e.#e[u+v[71]]=p},()=>{e.#e[u+v[73]]=p},()=>{e.#e[u+v[72]]=p},0,0,0,0,0,0,0,()=>{e.#e[u+v[128]]=p,e.allocateAce(128)},()=>{e.#e[u+v[93]]=p},()=>{e.#e[u+v[91]]=p},0,0,()=>{e.#e[u+v[75]]=p},()=>{e.#e[u+v[76]]=p},()=>{e.#e[u+v[77]]=p},()=>{e.#e[u+v[78]]=p}][E]||(()=>{}))():E<63||(E<64?(e.#r[o]?(e.#e[u+v[0]]=104|p,e.pushChPrimitives(o)):(e.#e[u+v[0]]=96|p,e.pushChPrimitives(o)),e.pushChPrimitives(o)):console.debug(`Unknown SD-90 global CH${o+1} param setup message:
%o`,a))});break}case 2:{let o=e.chRedir(l,n,!0),f=a[1];console.debug(`Unknown SD-90 global CH${o+1} MIDI setup message:
%o`,a.subarray(2));break}default:console.warn(`Unknown SD-90 global part setup message:
%o`,a)}}),e.#q.add([0,1,73,78],(a,n,s)=>{e.switchMode("krs"),e.setPortMode(e.getTrackPort(n),1,k.krs),console.debug("Might be KORG KROSS 2 mode reset... Not sure.")}).add([0,1,73,117,2,37],(a,n,s)=>{e.switchMode("krs");let r=e.getTrackPort(n);if(e.#k[r]&&e.#k[r]!==k.krs)if(e.#g.dumpLimit===e.DUMP_MODE){console.warn(`Dump cancelled. Port ${String.fromCharCode(65+r)} mode "${A[e.#k[r]]}" mismatch, should be "krs".`);return}else console.info(`Track ${n} is trying to perform a mismached mode dump on port ${String.fromCharCode(65+r)}.`);e.setPortMode(e.getTrackPort(n),1,k.krs);let l="KROSS 2 BMT1 ",o="";H(a,(f,u)=>{if(u<24)o+=String.fromCharCode(Math.max(32,f));else if(!(u<88)){if(u<468){let p=u-88,w=p*863>>16,E=p-w*76;([()=>{e.setEffectType(w+3,45,f),e.pushEffectType(w+3)},!1,()=>{console.debug(`${l}IFX${w+1} sends to ${f<=5&&f>0?`IFX${f}`:"direct out"}.`)}][E]||(()=>{}))()}else if(u<604){let p=u-468,w=p*964>>16,E=p-w*68;([()=>{e.setEffectType(1-w,45,f),e.dispatchEvent(["efxreverb","efxchorus"][1-w],{id:e.getEffectType(1-w)})},!1][E]||(()=>{}))()}else if(!(u<1276)){let p=u-1276,w=p*1490>>16,E=e.chRedir(w,n,!0),$=p-w*44;$<22?([()=>{f&&e.setChActive(E,1),e.#n[E]=f,e.pushChPrimitives(E)},()=>{f&&e.setChActive(E,1),f<10?(e.setChCc(E,0,63),e.setChCc(E,32,f)):f<20?(e.setChCc(E,0,121),e.setChCc(E,32,f-10)):f<24&&(e.setChCc(E,0,[120,0,56,62][f-20]),e.setChCc(E,32,0)),e.pushChPrimitives(E)},()=>{let S=e.chRedir(f&15,n,!0);e.#f[E]=S,S!==E&&console.info(`${l}CH${E+1} receives from CH${S+1}`);let R=f>>5&1;e.modelEx.kross.chToggle&&(e.setChActive(E,R),R||console.debug(`KORG KROSS 2 CH${E+1} is disabled.`))},!1,!1,()=>{e.setChCc(E,7,f)},!1,()=>{},()=>{},!1,!1,!1,!1,!1,()=>{e.setChCc(E,10,f||128)}][$]||(()=>{}))():$<36?([()=>{let S=f&7;f&8&&(S=1),S>1&&console.debug(`${l}CH${E+1} sends to ${S>1?`IFX${S-1}`:"direct out"} (${f.toString(16)}).`),e.setChEffectSink(E,f>1&&f<7?f+1:0)}][$-22]||(()=>{}))():([()=>{e.setChCc(E,74,(f+128&255)-64)},()=>{e.setChCc(E,71,(f+128&255)-64)},!1,!1,()=>{e.setChCc(E,73,(f+128&255)-64)},()=>{e.setChCc(E,75,(f+128&255)-64)},!1,()=>{e.setChCc(E,72,(f+128&255)-64)}][$-36]||(()=>{}))()}}}),o=o.trimEnd(),e.dispatchEvent("metacommit",{type:"EORTitle",data:o})});let m=function(a,n,s){let r=e.chRedir(a,n,!0);e.setChMode(r,k.an1x),e.pushChPrimitives(r),console.debug(`Yamaha AN1x slot ${s+1} receives from CH${r+1}(${a+1}).`),e.modelEx.yPlg[3][s]=r};e.#D.add([92,0,0],(a,n,s)=>{let r=a[0];a.subarray(1).forEach((l,o)=>{let f=o+r;f<2||([!1,!1,!1,!1,!1,!1,()=>{m(l,n,0)},()=>{m(l,n,1)}][f-2]||(()=>{}))()})}),e.#D.add([75,80,0],(a,n,s)=>{let r=a[0];a.subarray(1).forEach((l,o)=>{let f=o+r;([()=>{e.modelEx.cs1x.perfCh=l,e.pushChPrimitives(l),console.debug(`Yamaha CS1x performance on CH${l+1}.`)},!1,!1,!1,()=>{},!1,()=>{switch(l){case 1:{e.switchMode("xg",!0),e.setPortMode(e.getTrackPort(n),1,k.xg),console.debug("Yamaha CS1x set to XG mode.");break}case 3:{e.switchMode("cs1x",!0),e.setPortMode(e.getTrackPort(n),1,k.cs1x),console.debug("Yamaha CS1x set to performance mode.");break}default:console.warn(`Unknown Yamaha CS1x mode: ${l}`)}},()=>{}][f]||(()=>{}))()})}).add([75,96,0],(a,n,s)=>{let r=a[0],l=!1,o=e.modelEx.cs1x.perfCh;a.subarray(1).forEach((f,u)=>{let p=u+r;p<8?(l=!0,e.#L[o]=1,e.setChCvnRegister(o,p,f)):p<48?([!1,()=>{e.setChCc(o,7,f)}][p]||(()=>{}))():p<80?([()=>{e.setEffectTypeRaw(0,!1,f)},()=>{e.setEffectTypeRaw(0,!0,f),e.pushEffectType(0)},()=>{e.setEffectTypeRaw(1,!1,f)},()=>{e.setEffectTypeRaw(1,!0,f),e.pushEffectType(1)},()=>{e.setEffectTypeRaw(2,!1,f)},()=>{e.setEffectTypeRaw(2,!0,f),e.pushEffectType(2)}][p-48]||(()=>{}))():T()&&console.debug(`Unknown CS1x effect register: ${p}.`)}),l&&(e.setChActive(o,1),e.pushChPrimitives(o))});let C=(a,n,s)=>{let r=0;s.forEach((l,o)=>{([()=>{r=(l&1)<<7|r&127,e.setEffectTypeRaw(a,!1,28),e.setEffectTypeRaw(a,!0,r)},()=>{r=r&128|l&127,e.setEffectTypeRaw(a,!1,28),e.setEffectTypeRaw(a,!0,r),e.pushEffectType(a)}][o+n]||(()=>{}))()})};e.#q.add([96,0,1],(a,n,s)=>{let r=a[0];switch(a[1]){case 0:{C(0,a[2],a.subarray(3)),console.debug(`Partially parsed KORG PA EFX SysEX:
`,a);break}case 1:{C(1,a[2],a.subarray(3)),console.debug(`Partially parsed KORG PA EFX SysEX:
`,a);break}case 2:{C(2,a[2],a.subarray(3)),console.debug(`Partially parsed KORG PA EFX SysEX:
`,a);break}case 3:{C(3,a[2],a.subarray(3)),console.debug(`Partially parsed KORG PA EFX SysEX:
`,a);break}default:console.debug(`Unparsed KORG PA SysEX:
`,a)}})}};var Ue=Xe(Pe(),1);var dt=class{#a=!1;constructor(e,t,i,c){this.#a=e,this.start=t,this.end=i,this.data=c}get duration(){return this.ranged?this.end-this.start:0}get ranged(){return this.#a}},Ie=class extends dt{constructor(e,t,i){super(!0,e,t,i)}},ht=class extends dt{constructor(e,t){super(!1,e,e,t)}},Le=class extends Array{#a=-1;constructor(){super(...arguments)}resetIndex(e){this.#a=-1}fresh(){this.sort(function(e,t){return e.start==t.start?0:(+(e.start>t.start)<<1)-1}),this.forEach(function(e,t){e.index=t})}step(e,t=!1){let i=[];if(t)for(let c=0;c<this.length&&!(this[c].start>e);c++){if(this[c].end<e)continue;i.push(this[c])}else{let c=this.getRange(this.#a==-1?0:e-1,e),d=this;c.forEach(function(h){h.index>d.#a&&(i.push(h),d.#a=h.index)})}return i}getRange(e,t){e>t&&([e,t]=[t,e]);let i=[],c=-1,d=Math.ceil(Math.sqrt(this.length)),h=!0;for(let g=0;g<this.length;g+=d)this[g+d]?c<0&&this[g+d].start>=e&&(c=g):c=c<0?g:c;for(;h;)this[c]?.end<t?this[c].start>=e&&i.push(this[c]):h=!1,c++;return i}};var jt=0xffffffffffff,ut=function(e){let t=new Le,i=this,c=e.timeDivision,d=120,h=new Le,g=0,b=0;h.push(new Ie(0,jt,[120,0])),e.track.forEach(function(n){g=0,n.event.forEach(function(s){g+=s.deltaTime,s.type===255&&s?.metaType===81&&(d=6e7/s.data,h[h.length-1]&&h.push(new Ie(g,0xffffffffffff,[d,0])))})}),h.fresh(),h.forEach(function(n,s,r){s>0&&(r[s-1].end=n.start)});let m=120;h.forEach(function(n,s,r){s>0&&(n.end===n.start?r.splice(r.indexOf(n),1):m===n.data[0]&&(r[s-1].end=n.end,r.splice(r.indexOf(n),1)),m=n.data[0])});let C=0,a=120;return h.forEach(function(n){let s=n.start,r=s/a/c*60+C;a=n.data[0],C=r-s/a/c*60,n.data[1]=C}),console.debug("All tempo changes: ",h),d=120,g=0,b=0,e.track.forEach(function(n,s){g=0,b=0;let r=s+1;n.event.forEach(function(l,o){g+=l.deltaTime;let f=h.step(g,!0)[0];f&&(d=f.data[0],b=f.data[1]);let u={type:l.type,data:l.data,track:r,part:0};l.type>14?u.meta=l.metaType:u.part=l.channel,t.push(new ht(g/d/c*60+b,u))})}),t.fresh(),self.midiEvents=t,console.debug(`Parsed a type ${e.formatType} MIDI sequence.`),t};var Jt={866:"cp866","utf-8":"utf-8",utf8:"utf-8","utf-16":"utf-16",utf16:"utf-16","utf-16le":"utf-16",utf16le:"utf-16",unicode:"utf-16",unicodefeff:"utf-16","ucs-2":"utf-16","utf-16be":"utf-16be",utf16be:"utf-16be","utf-24":"utf-24",utf24:"utf-24","utf-24le":"utf-24",utf24le:"utf-24","utf-24be":"utf-24be",utf24be:"utf-24be","utf-32":"utf-32",utf32:"utf-32","utf-32le":"utf-32",utf32le:"utf-32","utf-32be":"utf-32be",utf32be:"utf-32be",latin1:"latin1",l1:"latin1",ascii:"latin1","us-ascii":"latin1","iso-8859-1":"latin1","iso8859-1":"latin1",cp1252:"latin1","windows-1252":"latin1",cp819:"latin1",ibm819:"latin1",latin2:"latin2",l2:"latin2","iso-8859-2":"latin2","iso8859-2":"latin2",latin3:"latin3",l3:"latin3","iso-8859-3":"latin3","iso8859-3":"latin3",latin4:"latin4",l4:"latin4","iso-8859-4":"latin4","iso8859-4":"latin4",latin5:"latin5",l5:"latin5","iso-8859-9":"latin5","iso8859-9":"latin5",cp1254:"latin5","windows-1254":"latin5",latin6:"latin6",l6:"latin6","iso-8859-10":"latin6","iso8859-10":"latin6",latin9:"latin9",l9:"latin9","iso-8859-15":"latin9","iso8859-15":"latin9","iso-8859-5":"iso-8859-5","iso8859-5":"iso-8859-5",cyrillic:"iso-8859-5","iso-8859-6":"iso-8859-6","iso8859-6":"iso-8859-6","iso-8859-6-e":"iso-8859-6","iso8859-6e":"iso-8859-6","iso-8859-6-i":"iso-8859-6","iso8859-6i":"iso-8859-6","asmo-708":"iso-8859-6","ecma-114":"iso-8859-6",arabic:"iso-8859-6","iso-8859-7":"iso-8859-7","iso8859-7":"iso-8859-7","ecma-118":"iso-8859-7",greek:"iso-8859-7",greek8:"iso-8859-7","iso-8859-8":"iso-8859-8","iso8859-8":"iso-8859-8","iso-8859-8-e":"iso-8859-8","iso8859-8e":"iso-8859-8",hebrew:"iso-8859-8",visual:"iso-8859-8","iso-8859-8-i":"iso-8859-8-i","iso8859-8i":"iso-8859-8-i",logical:"iso-8859-8-i","iso-8859-11":"iso-8859-11","iso8859-11":"iso-8859-11","windows-874":"iso-8859-11","dos-874":"iso-8859-11",cp874:"iso-8859-11","tis-620":"iso-8859-11","iso-8859-13":"iso-8859-13","iso8859-13":"iso-8859-13",latin7:"iso-8859-13",l7:"iso-8859-13","iso-8859-14":"iso-8859-14","iso8859-14":"iso-8859-14",latin8:"iso-8859-14",l8:"iso-8859-14","iso-8859-16":"iso-8859-16","iso8859-16":"iso-8859-16",cp866:"cp866",ibm866:"cp866",cp1250:"cp1250","windows-1250":"cp1250",cp1251:"cp1251","windows-1251":"cp1251",cp1253:"cp1253","windows-1253":"cp1253",cp1255:"cp1255","windows-1255":"cp1255",cp1256:"cp1256","windows-1256":"cp1256",cp1257:"cp1257","windows-1257":"cp1257",cp1258:"cp1258","windows-1258":"cp1258","euc-jp":"euc-jp",cp954:"euc-jp","euc-kr":"euc-kr",koi8:"koi8",koi:"koi8","koi8-r":"koi8","koi8-u":"koi8-u","koi8-ru":"koi8-u",mac:"mac",macintosh:"mac","mac-cyrillic":"x-mac-cyrillic","x-mac-cyrillic":"x-mac-cyrillic","x-mac-ukrainian":"x-mac-cyrillic",gbk:"gbk",gb2312:"gbk",chinese:"gbk","euc-cn":"gbk",gb18030:"gb18030",big5:"big5","big5-hkscs":"big5",sjis:"sjis","shift-jis":"sjis",ms932:"sjis","windows-31j":"sjis"},Zt={"utf-8":1,"utf-16":2,"utf-16be":3,"utf-24":4,"utf-24be":5,"utf-32":6,"utf-32be":7,latin1:0,latin2:0,latin3:0,latin4:0,latin5:0,latin6:0,latin9:0,"iso-8859-5":0,"iso-8859-6":0,"iso-8859-7":0,"iso-8859-8":0,"iso-8859-8-i":0,"iso-8859-11":0,"iso-8859-13":0,"iso-8859-14":0,"iso-8859-16":0,cp866:0,cp1250:0,cp1251:0,cp1253:0,cp1255:0,cp1256:0,cp1257:0,cp1258:0,"euc-jp":1,"euc-kr":1,koi8:0,"koi8-u":0,mac:0,"x-mac-cyrillic":0,gbk:1,gb18030:1,big5:1,sjis:1},Y,z=(Y=class{static getUnitSize(e){if(e>7)throw new RangeError("Cannot decode encodings with more than 4 bits per unit.");return(e>>1)+1}static isBigEndian(e){return(e&1)===1}static collapse(e){let t=Jt[e];if(typeof t!="string")throw new TypeError(`Provided label "${e}" is not supported.`);return t}static indicator(e){let t=Zt[e];if(typeof t!="number")throw new TypeError(`Provided collapsed label "${e}" is not supported.`);return t}},D(Y,"BYTE_1",0),D(Y,"BYTE_1_VL",1),D(Y,"BYTE_2_LE",2),D(Y,"BYTE_2_BE",3),D(Y,"BYTE_3_LE",4),D(Y,"BYTE_3_BE",5),D(Y,"BYTE_4_LE",6),D(Y,"BYTE_4_BE",7),Y),N=(e,t)=>{e.unsent=!1,e.enqueue(t)},ge=(e,t,i=1,c=!0)=>{if(typeof i!="number"||i<=0||i>4)throw new RangeError(`Invalid byte size ${i}.`);if(!(e instanceof Uint8Array||e instanceof Uint8ClampedArray))throw new TypeError("Input buffer is not Uint8Array.");if(typeof t!="number"||t<0||t>=e.length)throw new RangeError(`Provided offset ${t} is out of buffer range.`);if(i===1)return e[t];{let d=0;if(c)for(let h=0;h<i;h++)d<<=8,d|=e[t+h];else for(let h=0;h<i;h++)d|=e[t+h]<<(h<<3);return d<0?d+4294967296:d}},ea=class{static lineRaw(e,t=0){if(typeof t!="number"||t<0||t>7)throw new TypeError("Invalid split mode.");if(!e||e?.constructor!==ReadableStream)throw new TypeError("Not a readable stream.");let i=z.getUnitSize(t),c=z.isBigEndian(t),d=e.getReader(),h,g=!1,b=[],m=0,C=0,a=0;return new ReadableStream({pull:async n=>{for(n.unsent=!0;n.unsent;){if(!h||m>=h.length){m>C&&(b.push(h.subarray(C)),C=0);let s=await d.read();h=s.value,g=s.done,m=0}if(h){let s=0;if(i===1)s=h[m];else if(c)for(let l=0;l<i;l++)s<<=8,s|=h[m+l];else for(let l=0;l<i;l++)s|=h[m+l]<<(l<<3);let r=!1;switch(s){case 10:{a===13?C+=i:r=!0;break}case 13:{r=!0;break}}if(r){if(b.length){b.push(h.subarray(C,m));let l=0;for(let u=0;u<b.length;u++)l+=b[u].length;let o=new Uint8Array(l),f=0;for(let u=0;u<b.length;u++)o.set(b[u],f),f+=b[u].length;N(n,o),b=[]}else N(n,h.subarray(C,m));C=m+=i}a=s}if(g){if(C!==m&&h&&b.push(h.subarray(C,m)),b.length){let s=0;for(let o=0;o<b.length;o++)s+=b[o].length;let r=new Uint8Array(s),l=0;for(let o=0;o<b.length;o++)r.set(b[o],l),l+=b[o].length;N(n,r)}n.unsent=!1,n.close()}m+=i}}},new ByteLengthQueuingStrategy({highWaterMark:256}))}static chunkRaw(e,t="utf-8"){if(!e||e?.constructor!==ReadableStream)throw new TypeError("Not a readable stream.");let i=z.indicator(t),c=z.getUnitSize(i),d=z.isBigEndian(i),h=e.getReader(),g;return new ReadableStream({pull:async b=>{b.unsent=!0;let{value:m,done:C}=await h.read();if(m){let a=0,n=m.length;if(i!==0&&typeof g?.length=="number"){let s=!1;switch(t){case"big5":case"gbk":case"sjis":case"euc-kr":{a=1;let r=new Uint8Array(2);r[0]=g[0],r[1]=m[0],N(b,r);break}case"euc-jp":{let r=3;g[0]===143?a=3-g.length:g[0]>127?(a=1,r=2):r=g.length;let l=new Uint8Array(3);l.set(g),l.set(m.subarray(0,a),g.length),N(b,l.subarray(0,r));break}case"gb18030":{let r=new Uint8Array(4),l=4;r.set(g),r.set(m.subarray(0,4-g.length),g.length),r[0]<128?l=g.length:r[1]>=64?(a=1,l=2):a=4-g.length,N(b,r.subarray(0,l));break}case"utf-8":{let r=4;g[0]>=240?a=4-g.length:g[0]>=224?(a=3-g.length,r=3):g[0]>=192?(a=1,r=2):r=g.length;let l=new Uint8Array(4);l.set(g),l.set(m.subarray(0,a),g.length),N(b,l.subarray(0,r));break}case"utf-16":case"utf-16be":{let r=new Uint8Array(4);r.set(g),r.set(m.subarray(0,4-g.length)),a=4-g.length,ge(transientSize,0,2,d)>=55296&&ge(transientSize,2,2,d)>=55296?N(b,r):(N(b,r.subarray(0,2)),N(b,r.subarray(2)));break}default:{let r=new Uint8Array(c);r.set(g),r.set(m.subarray(0,c-g.length),g.length),N(b,r)}}}if(g=void 0,i===0)N(b,m.subarray(a));else{switch(t){case"utf-24":case"utf-24be":{n=Math.floor((m.length-a)/c)*c+a;break}case"utf-32":case"utf-32be":{n=(m.length-a>>2<<2)+a;break}case"utf-8":{if(m[m.length-1]>127){let s=!0,r=m.length,l=m.length-8;for(;s&&r>l;)r--,m[r]<128?n=r+1:m[r]>192&&(n=r)}break}case"utf-16":case"utf-16be":{if(n=(m.length-a>>1<<1)+a,ge(m,n-2,2,d)>=55296){let s=!0,r=n,l=n-6;for(;s&&r>l;)r-=2,ge(m,r,2,d)>>10===54&&(n=r)}break}default:throw new TypeError("Maybe someday the rest of the decoders will be implemented")}N(b,m.subarray(a,n))}n<m.length&&(g=m.subarray(n))}C&&(typeof g?.length=="number"&&N(b,g),b.unsent=!1,b.close())}},new ByteLengthQueuingStrategy({highWaterMark:256}))}static line(e,t="utf-8",i){let c=z.collapse(t),d=z.indicator(c),h=this.lineRaw(e,d).getReader(),g=new TextDecoder(c,onlostpointercapture);return new ReadableStream({pull:async b=>{let{value:m,done:C}=await h.read();m&&b.enqueue(g.decode(m)),C&&b.close()}})}static chunk(e,t="utf-8",i){let c=z.collapse(t);if(self.TextDecoderStream){let d=new TextDecoderStream(c,i);return e.pipeTo(d.writable),d.readable}else{let d=this.chunkRaw(e,c).getReader(),h=new TextDecoder(c);return new ReadableStream({pull:async g=>{let{value:b,done:m}=await d.read();b&&(console.debug(b),g.enqueue(h.decode(b))),m&&g.close()}})}}},pt=ea;var De={0:"\0",a:"\x07",b:"\b",e:"\x1B",f:"\f",n:`
`,r:"\r",t:"	",v:"\v","\\":"\\","'":"'",'"':'"'},Oe=new Uint8Array(128);Oe.fill(1,48,58);Oe.fill(1,65,71);Oe.fill(1,97,103);var te=new Uint8Array(256);te.fill(1,0,32);te.fill(1,128,160);te[127]=1;var ta={};for(let e in De){let t=De[e];ta[t]=`\\${e}`,te[t.charCodeAt(0)]=2}te[34]=3;te[39]=3;var gt=e=>{let t="",i=!1;for(let c=0;c<e.length;c++){let d=e[c];if(i){let h=0;switch(d){case"x":{h=2;break}case"u":{h=4;break}case"U":{h=8;break}default:{let g=De[d];if(typeof g=="string")t+=g;else throw new Error(`Invalid escape identifier "${d}" at index ${c}`);i=!1;continue}}if(h>0){let g=c+1,b=e.substring(g,g+h);if(b.length<h)throw new RangeError(`Insufficient code point buffer "${b}" at index ${g}`);let m=parseInt(b,16);if(Number.isNaN(m))throw new RangeError(`Malformed code point representation "${b}" at index ${g}`);if(m>=1114112)throw new RangeError(`Code point "${b}" exceeds 0x10ffff at index ${g}`);t+=String.fromCodePoint(m),i=!1,c+=h}}else d==="\\"?i=!0:t+=d}return t},aa=(e,t=0)=>{};self.TextEscape=aa;var q,be=(q=class{static parse(e,t){let i=e&this.MASK_TYPE,c=e&this.MASK_DATA,d=0,h=0,g,b=0,m,C=t.getReader();return new ReadableStream({pull:async a=>{let{value:n,done:s}=await C.read();if(typeof n=="string"){switch(i){case this.TYPE_TSV:{g=[];try{for(let r of n.split("	"))switch(c){case this.DATA_TEXT:{g.push(gt(r));break}case this.DATA_JSON:{g.push(d===0?gt(r):JSON.parse(r));break}default:throw new TypeError(`Unknown DSV value type ${i}`)}}catch(r){console.debug(`The following error appeared when parsing on line ${d+1}.`),console.error(r)}break}case this.TYPE_CSV:{if(c!==this.DATA_TEXT)throw new TypeError(`Invalid type ${i} for CSV, only plain text is allowed`);break}default:throw new TypeError(`Unknown DSV type ${i}`)}a.enqueue(g),d++}s&&a.close()}})}static parseObjects(e,t){let i=0,c=this.parse(e,t).getReader(),d;return new ReadableStream({start:async h=>{let{value:g,done:b}=await c.read();typeof g?.length=="number"&&(d=g),b&&h.close()},pull:async h=>{let{value:g,done:b}=await c.read();if(typeof g?.length=="number"){let m={};for(let C=0;C<g.length;C++)g[C]&&(m[d[C]]=g[C]);h.enqueue(m)}b&&h.close()}})}},D(q,"MASK_TYPE",3),D(q,"MASK_DATA",12),D(q,"TYPE_TSV",0),D(q,"TYPE_CSV",1),D(q,"DATA_TEXT",0),D(q,"DATA_JSON",4),q);Ue.default.customInterpreter=tt;var P=(e,t,i)=>{e.addEventListener(i,c=>{t.dispatchEvent(i,c.data)})},bt=e=>{let t=e.split("/");return t[t.length-1]||t[t.length-2]||"(remote)"},yt=class extends de{device;#a;#b={};#S=[];#T=new Map;#$="";#u=[];#f=[];#r=new Uint8ClampedArray(128);#e=new Uint8ClampedArray(128);#y=.5;#n=120;#h=4;#d=4;#c=0;#l=0;#v=new Array(y.ch);#M=new Uint8Array(y.ch);#O=0;smoothAttack=0;smoothDecay=0;reset(){let e=this;e.dispatchEvent("reset"),e.#a?.resetIndex(),e.device.init(),e.#$="",e.#y=.5,e.#n=120,e.#h=4,e.#d=4,e.#c=0,e.#l=0,e.dispatchEvent("tempo",e.#n),e.dispatchEvent("title",e.#$),e.dispatchEvent("tsig",e.getTimeSig())}init(){this.reset(),this.#a=void 0}async loadFile(e){this.#a=ut(Ue.default.parse(new Uint8Array(await e.arrayBuffer())))}async loadMap(e,t,i,c="(internal)"){let d=this,h=0,g=0,b=0,m=0,C,a;e.split(`
`).forEach((n,s)=>{if(!n)return;let r=n.split("	");if(s){if(!m)return;let l="",o="";r.forEach((u,p)=>{switch(p){case C:{l=u;break}case a:{o=u;break}}});let f=!1;d.#b[l]?.priority>i&&(f=!0,b++),!d.#b[l]||f||t?(d.#b[l]={name:o,priority:i},h++):self.debugMode&&console.debug(`Voice "${o}" (${l}) seems to be in conflict with (${d.#b[l]}).`),g++}else r.forEach((l,o)=>{switch(l){case"ID":{C=o,m++;break}case"Name":{a=o,m++;break}default:console.debug(`Unknown map field: ${l}`)}})}),console.debug(`Voice names: From "${c}", ${g} total, ${h} loaded (${h-b} + ${b}).`),d?.device.forceVoiceRefresh()}async loadMapPaths(e){let t=this;e.forEach(async(i,c)=>{t.loadMap(await(await fetch(i)).text(),0,c,bt(i))})}async loadEfx(e,t){let i=this,c=0,d=0,h,g,b;e.split(`
`).forEach((m,C)=>{if(m)if(C){let a=0,n;m.split("	").forEach((s,r)=>{switch(r){case h:{a|=(parseInt(s,16)&255)<<8;break}case g:{a|=parseInt(s,16)&255;break}case b:{n=s;break}}}),!i.#S[a]||t?(i.#S[a]=n,c++):self.debugMode&&console.debug(`EFX ID 0x${a.toString(16).padStart(4,"0")} (${n}) seems to be in conflict.`),d++}else m.split("	").forEach((a,n)=>{switch(a){case"MSB":{h=n;break}case"LSB":{g=n;break}case"Name":{b=n;break}default:console.debug(`Unknown EFX field: ${a}`)}})}),console.debug(`EFX: ${d} total, ${c} loaded.`);for(let m=0;m<ce.length;m++){let C=!1,a=i.device.getEffectType(m);a[0]===0&&a[1]>>4===15&&(C=!0),i.dispatchEvent(`efx${ce[m]}`,{id:a,hidden:C})}}async loadModels(e,t){let i=this,c=0,d=0}async loadStyles(e,t){let i=this,c=0,d=0}async loadProps(e,t,i=0,c="(internal)"){let d=this,h=0,g=0,b=0;for await(let m of be.parseObjects(be.DATA_TEXT|be.TYPE_TSV,pt.line(e)))if(typeof m?.voiceId=="string")if(g++,!(d.#T.has(m.voiceId)||d.#T.get(m.voiceId)?.priority<=i)||t){if(Object.keys(m).length<2)continue;d.#T.get(m.voiceId)?.priority>i&&b++,m.priority=i,d.handleProp&&await d.handleProp(m),d.#T.set(m.voiceId,m),h++}else console.debug(`Tried to write a pre-existing entry "${m.voiceId}" on entry ${g}.`);console.debug(`Voice properties: From "${c}", ${g} total, ${h} loaded (${h-b} + ${b}).`)}async loadPropsPaths(e){let t=this;e.forEach(async(i,c)=>{let d=i.split("/");t.loadProps((await fetch(i)).body,0,c,bt(i))})}switchMode(e,t=!1){this.device.switchMode(e,t)}getMode(){return this.device.getMode()}getVoice(){return this.device.getVoice(...arguments)}getChVoice(e){return this.device.getChVoice(e)}refreshCachedChVoice(e,t){let i=this,c=t??i.device.getChVoice(e),d=i.#v[e],h=!0;if(i.#O++,!t)switch(i.device.getChMode(e)){case"xg":{i.device.getChType(e)>0&&c.ending==="!"&&(h=!1,d.refreshFailure=!0,console.debug("Cached voice persisted due to invalid drum kit."));break}case"gs":case"sc":{c.ending!==" "&&(c.sid[2]===1?(c.name="Silence",c.refreshFailure=!0,console.debug("Cached voice nullified due to invalid SC-55 voice.")):(h=!1,d.refreshFailure=!0,console.debug("Cached voice persisted due to invalid GS voice.")));break}}return h?(i.#v[e]=c,i.#M[e]=c.poly??1,i.#O>1?console.debug(`Bubbling prevented at instance #${i.#O}.`):i.dispatchEvent("cachedvoice",{part:e}),i.#O--,c):(i.#O--,d)}getCachedChVoice(e){let t=this,i=t.#v[e],c=t.device?.getChPrimitives(e,!0);if(i&&t.device?.getChCvnIsWritten(e)===0)switch(i.ending){case"?":case"!":return t.refreshCachedChVoice(e,void 0);default:return et(i.sid,c)[1]!==0?t.refreshCachedChVoice(e):i}else return t.refreshCachedChVoice(e)}getChPrimitive(e,t,i){return this.device.getChPrimitive(e,t,i)}getChPrimitives(e,t){return this.device.getChPrimitives(e,t)}getMapped(e){return this.#b[e]?.name||e}getEfx(e){let[t,i]=e,c=t<<8|i;return this.#S[c]||`0x${c.toString(16).padStart(4,"0")}`}getVoxBm(e){if(!e)throw new Error("Voice object must be valid");let t=this;if(!t.voxBm)throw new Error("Voice bitmap repository isn't yet initialized");let i=t.voxBm.getBm(e.name);if(!i)switch(e.mode){case"xg":{switch(e.sid[0]){case 0:case 80:case 81:case 83:case 84:case 96:case 97:case 99:case 100:{i=t.voxBm.getBm(t.getVoice(K.bank0,e.sid[1],K.bank0,e.mode).name);break}}break}case"g2":case"sd":{switch(e.sid[0]){case 96:case 97:case 98:case 99:{i=t.voxBm.getBm(t.getVoice(K.bank0,e.sid[1],K.bank0,e.mode).name);break}case 104:case 105:case 106:case 107:{i=t.voxBm.getBm(t.getVoice(120,e.sid[1],K.bank0,e.mode).name);break}}break}case"gs":case"sc":case"k11":case"sg":case"gm":{switch(e.sid[0]){case 120:break;case 122:case 127:{i=t.voxBm.getBm(t.getVoice(120,e.sid[1],0,e.mode).name);break}default:i=t.voxBm.getBm(t.getVoice(0,e.sid[1],0,e.mode).name)}break}default:switch(e.sid[0]){case 56:{i=t.voxBm.getBm(t.getVoice(0,e.sid[1],0,e.mode).name);break}}}return i||(i=t.voxBm.getBm(t.getVoice(e.sid[0],e.sid[1],0,e.mode).name)),i}getChBm(e,t){let i=this;t=t??i.getChVoice(e);let c=i.getVoxBm(t);if(!c){if(!i.sysBm)return;switch(t.mode){case"xg":{switch(t.sid[0]){case 126:{t.sid[1]>>1===56&&(c=i.sysBm.getBm("cat_smpl"));break}case 16:{c=i.sysBm.getBm("cat_smpl");break}case 64:case 67:{c=i.sysBm.getBm("cat_sfx");break}case 32:case 33:case 34:case 35:case 36:case 48:case 82:{c=i.sysBm.getBm("cat_xg");break}}break}default:switch(t.sid[0]){case 63:case 32:case 33:case 34:case 35:case 36:case 48:case 82:{c=i.sysBm.getBm("cat_mex");break}}}}return c||(i.device.getChType(e)?c=i.sysBm.getBm("cat_drm"):c=i.sysBm.getBm("no_vox")),c}getProps(e){let t=this,i,c,d=0,h=e;for(;d<8&&i==null&&(!c?.constructor||c instanceof Array&&(c[1]!==e.eid[1]||c[2]!==e.eid[2]));)c=e.eid,typeof e.voice=="string"&&(t.#T.has(e.voice)?i=t.#T.get(e.voice):e=t.getVoice(c[0],c[2]===0?0:c[1],c[2]===0?0:c[2]-1));return!i&&d===8&&console.info(`Voice property fetching failed for "${e.name}" (${e.eid.join(" ")}).`),i}get noteProgress(){return this.#l/this.#y}get noteOverall(){return(this.noteProgress-this.#c)*this.#d/4}get noteBar(){return Math.floor(this.noteOverall/this.#h)}get noteBeat(){let e=this.noteOverall%this.#h;return e<0&&(e+=this.#h),e}get noteOffset(){return this.#c}getTimeSig(){return[this.#h,this.#d]}getTempo(){return this.#n}getChCachedVoice(e){return this.#v[e]}eachVoice(e,t=!1){let i=this;for(let c=0;c<i.#v.length;c++)(t||i.device?.getChActive(c))&&e(i.#v[c],c,i.#v)}sendCmd(e){this.device.runJson(e)}render(e){e>this.#l&&(this.#l=e);let t=this.#a?.step(e)||[],i=0,c=0,d=new Set,h={},g=[],b=this,m=[];for(b.device.getStrength().forEach((E,$)=>{b.#e[$]=E}),b.device.newStrength(),t.forEach(function(E){let $=E.data,S=b.device.runJson($);switch(S?.reply){case"meta":{m.push(S);break}}S?.reply&&delete S.reply});b.#f.length>0;){let E=b.#f.shift(),$=E.part<<7|E.note;E.state?(d.add($),h[$]=E.velo):d.has($)&&(g.push({part:E.part,note:E.note,velo:h[$],state:b.device.NOTE_SUSTAIN}),i++,c+=b.#M[E.part])}m?.length>0&&b.dispatchEvent("meta",m);let C=b.device.getActive(),a=[],n=b.device.getPitch(),s=b.device.getCcAll(),r=b.device.getProgram(),l=b.device.getChTypes(),o=[],f=b.device.getStrength();f.forEach(function(E,$,S){S[$]=Math.max(b.#e[$],E);let R=S[$]-b.#r[$];if(R>=0){let O=4*.25**(b.device.getChCc($,73)/64);b.#r[$]+=Math.ceil(R-R*b.smoothAttack**O)}else{let O=4*.25**(b.device.getChCc($,72)/64);b.#r[$]+=Math.floor(R-R*b.smoothDecay**O)}});let u=0,p=0;return C.forEach(function(E,$){E&&(a[$]=b.device.getVel($),o[$]=b.device.getExt($),u+=a[$].size,p+=a[$].size*b.#M[$])}),{extraPoly:i,extraPolyEC:c,extraNotes:g,curPoly:u,curPolyEC:p,chInUse:C,chKeyPr:a,chPitch:n,chProgr:r,chContr:s,chType:l,chExt:o,eventCount:t.length,title:b.#$,bitmap:b.device.getBitmap(),letter:b.device.getLetter(),texts:b.device.getTexts(),master:b.device.getMaster(),mode:b.device.getMode(),strength:b.#r.slice(),velo:f,rpn:b.device.getRpn(),tSig:b.getTimeSig(),tempo:b.getTempo(),noteBar:b.noteBar,noteBeat:b.noteBeat,ace:b.device.getAce(),rawVelo:b.device.getStrength(),rawStrength:b.device.getRawStrength(),rawPitch:b.device.getRawPitch(),efxSink:b.device.getEffectSink()}}constructor(e,t=.5,i=.5){super();let c=this;c.smoothAttack=t,c.smoothDecay=i,c.device=e,c.addEventListener("meta",function(d){d?.data?.forEach(function(h){(c.#u[h.meta]||console.debug).call(c,h.meta,h.data)})}),P(c.device,c,"mode"),P(c.device,c,"mastervolume"),P(c.device,c,"channelactive"),P(c.device,c,"channelmin"),P(c.device,c,"channelmax"),P(c.device,c,"portrange"),P(c.device,c,"portstart"),P(c.device,c,"channelreset"),P(c.device,c,"channeltoggle"),P(c.device,c,"screen"),P(c.device,c,"metacommit"),P(c.device,c,"voice"),P(c.device,c,"pitch"),P(c.device,c,"note"),P(c.device,c,"reset"),P(c.device,c,"banklevel"),P(c.device,c,"efxreverb"),P(c.device,c,"efxchorus"),P(c.device,c,"efxdelay"),P(c.device,c,"efxinsert0"),P(c.device,c,"efxinsert1"),P(c.device,c,"efxinsert2"),P(c.device,c,"efxinsert3"),P(c.device,c,"efxinsert4"),P(c.device,c,"partefxtoggle"),P(c.device,c,"chmode"),c.addEventListener("note",function({data:d}){c.#f.push(d)}),c.addEventListener("voice",({data:d})=>{c.refreshCachedChVoice(d.part)}),c.addEventListener("reset",({data:d})=>{c.#M.fill(1)}),c.#M.fill(1),c.#u[3]=function(d,h){c.#$?.length<1&&(c.#$=h,c.dispatchEvent("title",c.#$))},c.#u[81]=function(d,h){let g=c.noteProgress,b=c.#y||.5;c.#n=6e7/h,c.#y=h/1e6,c.#c+=g*(b/c.#y)-g,c.dispatchEvent("tempo",c.#n)},c.#u[88]=function(d,h){let g=c.noteBar,b=c.noteBeat,m=c.#h,C=c.#d;c.#h=h[0],c.#d=1<<h[1];let a=Math.round(g+b/m);m!==c.#h&&(c.#c-=a*(c.#h-m)*(4/c.#d)),C!==c.#d&&(console.debug(`${g}/${b}`),C<c.#d?c.#c+=a*(c.#d-C)*(C/c.#d):c.#c+=a*(c.#d-C)*(c.#d/C)),c.dispatchEvent("tsig",c.getTimeSig())},c.addEventListener("metacommit",({data:d})=>{switch(d.type){case"KarTitle":case"EORTitle":{c.#$?.length<1&&(c.#$=d.data,c.dispatchEvent("title",c.#$));break}}})}};var ia=class extends EventTarget{static sleep(e){return new Promise(t=>{self.AbortSignal?AbortSignal.timeout(e).addEventListener("abort",t):setTimeout(t,e)})}#a;#b;#S=!1;get finished(){return this.#S}finish(){this.#S=!0,this.#b&&this.#b()}wait(){if(!this.#S)return this.#a}constructor(){super(),this.#a=new Promise(e=>{this.#b=()=>{this.#S=!0,e()}})}},mt=ia;var Ne=new Uint8Array(40),oe=0,Be,wi=setInterval(()=>{Be&&(Ne[oe]=!Ne[oe],oe++,oe>34&&(oe=0))},1e3/50);Uint8Array.prototype.render=function(e){let t=0,i=0,c=this.width||5,d=this.height||8;for(let h=0;h<this.length;h++)e(this[h],t,i,this),t++,t>=c&&(t=0,i++)};var Et=class{#a=[];loaded=new mt;async load(e,t=!1,i="(internal)"){let c=this,d=0,h=0;console.debug(`Font "${i||"(internal)"}": loading started.`),e.split(`
`).forEach(function(g,b){if(b>0&&g?.length>0){let m=g.split("	"),C=parseInt(m[0],16);if(h++,c.#a[C]&&!t)return;let a=new Uint8Array(40);Array.from(m[1]).forEach(async function(n,s){let r=s&1?4:0,l=s>>1,o=parseInt(n,16),f=3;for(;o>0||f>=0;){let u=(r+f)*5+l;a[u]=o&1,o=o>>1,f--}}),a.width=5,a.height=8,c.#a[C]=a,d++}}),c.loaded.finished||c.loaded.finish(),console.debug(`Font "${i||"(internal)"}": ${h} total, ${d} loaded.`)}async loadFile(e,t=!1){let i=this;console.debug(`Requested font file from "${e}".`),await i.load(await(await fetch(e)).text(),t,e),Be=!1}constructor(...e){Be=!0,(async()=>{for(let t=0;t<e.length;t++)await this.loadFile(e[t])})()}getCP(e){return this.#a[e]}getStr(e){let t=[],i=this;return Array.from(e).forEach(function(c){t.push(i.#a[c.charCodeAt(0)]||i.#a[32]||Ne)}),t}keys(){return Object.keys(this.#a)}data(e){return this.#a[e]}};var ye=16/9,me=64,W=new Float64Array(49),ra="Vx,Dr,D1,D2,D3,D4,D5,D6,D7,D8".split(","),sa=[1,3,6,8,10],wt=[0,.5,1,1.5,2,3,3.5,4,4.5,5,5.5,6],na=2*Math.PI,la={"?":"Unset",gm:"General MIDI",g2:"General MIDI 2",xg:"Yamaha XG",gs:"Roland GS",sc:"Roland GS",mt32:"Roland MT-32",doc:"Yamaha DOC",qy10:"Yamaha QY10",qy20:"Yamaha QY20",sd:"Roland SD",x5d:"Korg X5D","05rw":"Korg 05R/W",ns5r:"Korg NS5R",k11:"Kawai K11",sg:"Akai SG",trin:"Korg Trinity",krs:"Korg KROSS 2",s90es:"Yamaha S90 ES",cs6x:"Yamaha CS6x",cs1x:"Yamaha CS1x",motif:"Yamaha Motif ES",pa:"Korg PA"},ca={"C.Lyrics":"Lyrics","C.Marker":"Marker","Cmn.Text":"Text",Copyrite:"Copyright",CuePoint:"Cue Point",EORTitle:"Real Title",Instrmnt:"Instrument","Kar.Info":"Kar. Info","Kar.Lang":"Language","Kar.Mode":"Karaoke","Kar.Ver.":"Kar. Version",KarLyric:"Kar. Lyrics",KarTitle:"Kar. Title",MidStamp:"MIDI Stamp",OSysMeta:"Octavia Sys.",SGLyrics:"SG Lyrics",TrkTitle:"Title",XfSngDte:"XF Date",XfSngRgn:"XF Region",XfSngCat:"XF Category",XfSongBt:"XF Beat",XfSngIns:"XF Instr.",XfSngVoc:"XF Vocalist",XfSngCmp:"XF Compose",XfSngLrc:"XF Lyricist",XfSngArr:"XF Arranger",XfSngPer:"XF Perform.",XfSngPrg:"XF Program.",XfSngTag:"XF Tags",XfKarLng:"XF Lang.",XfKarNme:"XF Name",XfKarCmp:"XK Compo.",XfKarLrc:"XK Lyricist",XfKarArr:"XK Arranger",XfKarPer:"XK Perform.",XfKarPrg:"XK Progr.",XfScneNo:"XF Scene #",XfMeloCh:"XF Melody",XfLyrOff:"XL Offset",XfLyrEnc:"XL Lang.",XfSngPrt:"XL Part",YMCSSect:"Section Ctrl.",YStyleId:"Active Style"},oa=["ChordCtl","MidStamp","RhrslMrk","XfSongBt","XfSngIns","XfSngVoc","XfLyrOff","XfSngRgn"],Ve=[[],[4,2],[3,2]],fa=[{l:0,t:0},{l:0,t:416},{l:960,t:0},{l:960,t:416}],Ct={none:{font4:[0,0],cfont4:[0,0],font7:[0,0]},macos:{font4:[2,0],cfont4:[1,0],font7:[0,0]},chromium:{font4:[1,0],cfont4:[0,0],font7:[1,0]}},Ee={xg:["9efaa0","006415"],doc:["9efaa0","006415"],qy10:["9efaa0","006415"],qy20:["9efaa0","006415"],ns5r:["9efaa0","006415"],x5d:["9efaa0","006415"],"05rw":["9efaa0","006415"],trin:["9efaa0","006415"],k11:["9efaa0","006415"],s90es:["9efaa0","006415"],motif:["9efaa0","006415"],cs6x:["9efaa0","006415"],an1x:["9efaa0","006415"],cs1x:["9efaa0","006415"],gm:["a1f3ff","005e88"],g2:["a1f3ff","005e88"],pa:["a1f3ff","005e88"],krs:["a1f3ff","005e88"],gs:["ffe1a5","804e00"],sc:["ffe1a5","804e00"],mt32:["ffe1a5","804e00"],sd:["ffe1a5","804e00"],sg:["ffdddd","990022"]};W.forEach((e,t,i)=>{i[t]=Math.PI*t/12});var x=function(e,t,i={}){let c=document.createElement(e);t?.forEach(a=>{c.classList.add(a)});let{t:d,l:h,w:g,h:b,i:m,a:C}=i;return d?.constructor&&(c.style.top=d?.length?d:`${d}px`),h?.constructor&&(c.style.left=h?.length?h:`${h}px`),g?.constructor&&(c.style.width=g?.length?g:`${g}px`),b?.constructor&&(c.style.height=b?.length?b:`${b}px`),m?.constructor&&c.appendChild(document.createTextNode(m)),C?.constructor&&(c.style.textAlign=C),c};var I=function(e,t){t?.forEach(i=>{e.appendChild(i)})},L=function(e,t){t.forEach(i=>{e.classList.contains(i)&&e.classList.remove(i)})},V=function(e,t){t.forEach(i=>{e.classList.contains(i)||e.classList.add(i)})},da=new Array(128).fill(0);da.forEach((e,t,i)=>{i[t]=Math.floor(24*t/12.7)/10});var ha=new Array(128).fill(0);ha.forEach((e,t,i)=>{i[t]=Math.abs(Math.round(48*(t-64)/12.7)/10)});var kt=new Array(11).fill(null);kt.forEach((e,t,i)=>{i[t]=`${Math.round(t*12/.0128)/100}%`});var ua=new Array(128).fill(null);ua.forEach((e,t,i)=>{i[t]=`${Math.round(t/1.27)/100}`});var vt=function(e,t,i){e.innerText=t,e.rNew=!0;let c=e.font.substring(0,6)==="italic";i&&!c?e.font=`italic ${e.font}`:!i&&c&&(e.font=e.font.substring(7));let d=e.measureText(t);e.rWidth=d.width};HTMLElement.prototype.setTextRaw=function(e){let t;this.childNodes[0]?.nodeType===3?(t=this.childNodes[0],t.data=e):(t=document.createTextNode(e),this.prepend(t))};var Si=class extends yt{#a=16;#b=32;#S=128;#T=!1;#$="";#u;#f=0;#r=0;#e=0;#y=0;#n=0;#h;#d=0;#c=!1;#l=y.invalidCh;#v=1;#M=0;#O=0;#x=0;#s=new Uint8Array(1280);#o=new Uint8Array(1280);#Q=new Uint8Array(1280);#A=new Uint8Array(512);#V=new Uint8Array(512);#R=new Uint8Array(512);#Y=new Uint8Array(y.ch);#G;#k;#K;#E;#L;#W="fcdaff";#X=new Array(y.ch);#U=new Array(y.ch);#w="ffffff";#j="?";#t={};#p={};#i=[];#g={};#N={};eventViewMode=0;useElementCount=!0;#m=[];#_="comb";glyphs=new Et;panStyle=11;pixelMin=12;pixelMax=255;#ae(e,t,i,c=0,d=0,h){let g=this,{width:b,height:m}=e.canvas,C,a,n,s,r=g.#v,l=0,o=sa.indexOf(t%12)>-1;switch(c){case g.device.NOTE_HELD:case g.device.NOTE_SOSTENUTO_SUSTAIN:case g.device.NOTE_SOSTENUTO_HELD:{l=1;break}case g.device.NOTE_MUTED_RECOVERABLE:{l=2;break}}switch(g.#_){case"block":case"comb":{C=Math.round(t*b/128),a=Math.round((t+1)*b/128),n=a-C,s=r===1?2:1;break}case"piano":{C=Math.round((Math.floor(t/12)*7+wt[t%12])*b/75*1.0044642857142856),a=Math.round((Math.floor(t/12)*7+wt[t%12]+1)*b/75*1.0044642857142856)-1,n=a-C,s=r===1?3:1;break}case"line":{let f=t-d;Math.abs(d)>2&&(f=t-Math.sign(d)*2),a=Math.round((t+.5)*b/128),C=Math.round((f+.5)*b/128)}default:}switch(e.fillStyle=`#${o?g.getChAccent(h):g.#w}${(i<<1|i>>6).toString(16).padStart(2,"0")}`,e.strokeStyle=e.fillStyle,e.lineWidth=r===1?4:2,e.lineDashOffset=0,g.#_){case"block":{let f=e.canvas.height-1;e.fillRect(C,0,n,f),l>0&&e.clearRect(C+s,s,n-(s<<1),f-(s<<1)),l===2&&e.clearRect(C,s<<1,n,f-(s<<2));break}case"comb":{let f=(o?Math.round((e.canvas.height<<1)/3):e.canvas.height)-1;e.fillRect(C,0,n,f),l>0&&e.clearRect(C+s,s,n-(s<<1),f-(s<<1)),l===2&&e.clearRect(C,s<<1,n,f-(s<<2));break}case"piano":{let f=o?0:e.canvas.height>>1,u=(e.canvas.height>>1)-1;e.fillRect(C,f,n,u),l>0&&e.clearRect(C+s,f+s,n-(s<<1),u-(s<<1)),l===2&&e.clearRect(C,f+(s<<1),n,u-(s<<2));break}case"line":{if(l===1)switch(r){case 4:{e.setLineDash(Ve[2]);break}default:e.setLineDash(Ve[1])}else e.setLineDash(Ve[0]),r!==4&&self?.document?.mozFullScreen&&(C+=.5,a+=.5);e.beginPath(),e.moveTo(C,(r===4||!l)&&self?.document?.mozFullScreen?1:0),e.lineTo(a,(m>>1)+1),e.lineTo(C,m),e.stroke();break}default:}}#ue(e,t){let i=this;(e?.chInUse||t).forEach((c,d)=>{if(c){let h=i.#i[d>>4][d&15].cxt;h.clearRect(0,0,h.canvas.width,h.canvas.height),e.chKeyPr[d].forEach(({v:g,s:b},m)=>{i.#ae(h,m,g,b,i.device.getPitchShift(d),d)})}})}#pe(e){let t=this;Date.now()-t.#f>4e3&&(t.#r=0,t.#e=142-t.#g.view.clientHeight,(t.#u?.clientWidth||0)>840&&(t.#r=840-t.#u.clientWidth),t.#g.view.style.transform=`translateX(${t.#r}px) translateY(${t.#e}px)`,e&&(t.#f=0))}#be(){let e=self.innerWidth/self.innerHeight,t=1,i=self.innerWidth,c=self.innerHeight;e>=ye?(t=Math.min(Math.round(self.innerHeight/1080*1e4)/1e4,100),i=Math.ceil(self.innerHeight*ye)):e<ye&&(t=Math.min(Math.round(self.innerWidth/1920*1e4)/1e4,100),c=Math.ceil(self.innerWidth/ye)),this.#K.style.width=`${i}px`,this.#K.style.height=`${c}px`,this.#E.style.transform=`scale(${t})`}#re;#J(){let e=this,t=e.#G?.currentTime||0,i=e.render(t),c=Date.now(),d=i.curPoly+i.extraPoly,h=i.curPolyEC+i.extraPolyEC;e.#y<d&&(e.#y=d),e.#n<h&&(e.#n=h),e.#t.curPoly.setTextRaw(`${e.useElementCount?h:d}`.padStart(3,"0")),e.#t.maxPoly.setTextRaw(`${e.useElementCount?e.#n:e.#y}`.padStart(3,"0")),e.#G?.realtime?(e.#t.barCount.setTextRaw("LINE"),e.#t.barDelim.style.display="none",e.#t.barNote.setTextRaw("IN")):(e.#t.barCount.setTextRaw(i.noteBar+1),e.#t.barDelim.style.display="",e.#t.barNote.setTextRaw(Math.floor(i.noteBeat)+1));let g=[7,11,1,91,93,94,74,5,256,256],b=e.#M+e.#v;for(let n=0;n<y.ch;n++){let s=n>>4,r=n*y.cc,l=n*y.ace,o=e.#i[s][n&15];if(e.device.getActive()[n]&&s>=e.#M&&s<b){g[8]=i.ace[l+0]||256,g[9]=i.ace[l+1]||256,o.ccVis.clearRect(0,0,109,25),o.ccVis.fillStyle=`#${e.getChAccent(n)}`,o.ccVis.strokeStyle=`#${e.getChAccent(n)}`,o.ccVis.lineWidth=2;for(let u=0;u<g.length;u++){let p=g[u];if(p<256){let w=i.chContr[r+v[p]],E=w*24/127;if(E>0){let $=24-E;o.ccVis.fillRect(u*6,$,4,E)}}}let f=i.chContr[r+v[10]]||1;switch(e.panStyle){case 7:case 6:case 5:case 3:case 2:case 1:{let u=(f+125)*.024933275,p=(f-64)*.024933275;o.ccVis.beginPath(),f>127?e.panStyle>>1&1&&(o.ccVis.arc(84.5,22.5,21.5,0,W[12],!0),o.ccVis.stroke()):(e.panStyle>>1&1&&(f<64?(o.ccVis.arc(84.5,22.5,21.5,W[18],u,!0),o.ccVis.stroke()):f>64&&(o.ccVis.arc(84.5,22.5,21.5,W[18],u),o.ccVis.stroke())),e.panStyle&1&&(o.ccVis.strokeStyle=`#${e.#w}`,o.ccVis.lineWidth=e.panStyle>>2?1:3,o.ccVis.beginPath(),o.ccVis.moveTo(84.5,22.5),f===64?o.ccVis.lineTo(84.5,4):o.ccVis.lineTo(84.5+18*Math.sin(p),22.5-18.5*Math.cos(p)),o.ccVis.stroke())),e.panStyle>>2&1&&(o.ccVis.fillStyle=`#${e.#w}`,o.ccVis.beginPath(),o.ccVis.arc(84.5,22.5,2.5,0,W[4]),o.ccVis.fill());break}case 11:case 10:case 9:{let u=(f+77)*.033244367,p=(f-64)*.033244367;o.ccVis.beginPath(),f>127?e.panStyle>>1&1&&(o.ccVis.arc(84.5,16.5,15.5,W[26],W[34],!0),o.ccVis.stroke()):(e.panStyle>>1&1&&(f<64?(o.ccVis.arc(84.5,16.5,15.5,W[18],u,!0),o.ccVis.stroke()):f>64&&(o.ccVis.arc(84.5,16.5,15.5,W[18],u),o.ccVis.stroke())),e.panStyle&1&&(o.ccVis.strokeStyle=`#${e.#w}`,o.ccVis.lineWidth=3,o.ccVis.beginPath(),o.ccVis.moveTo(84.5,16.5),f===64?o.ccVis.lineTo(84.5,4):o.ccVis.lineTo(84.5+11.5*Math.sin(p),16.5-11.5*Math.cos(p)),o.ccVis.stroke())),(!(e.panStyle&1)||f>>7)&&(o.ccVis.fillStyle=`#${e.#w}`,o.ccVis.beginPath(),o.ccVis.arc(84.5,16.5,2.5,0,W[24]),o.ccVis.fill());break}default:{let u=Math.abs(f-64)/2.625;f<64?o.ccVis.fillRect(84-u,0,u,24):f>127?(o.ccVis.fillRect(60,0,49,24),o.ccVis.clearRect(61,1,47,22)):o.ccVis.fillRect(85,0,u,24),o.ccVis.fillStyle=`#${e.#w}`,o.ccVis.fillRect(84,0,1,24)}}if(o.metre.clearRect(0,0,121,25),o.metre.fillStyle=`#${e.#w}`,o.metre.globalCompositeOperation="source-over",o.metre.rWidth>o.metre.canvas.width){o.metre.rNew&&(o.metre.rNew=!1,o.metre.rOffset=t);let u=t-(o.metre.rOffset||0),p=32,w=o.metre.rWidth-o.metre.canvas.width+p,E=u*-25%(o.metre.rWidth+p+48)+48;E>0&&(E=0),o.metre.fillText(o.metre.innerText,E,3+e.#L.cfont4[0]),Math.abs(E)>w&&o.metre.fillText(o.metre.innerText,E+o.metre.rWidth+p,3+e.#L.cfont4[0])}else o.metre.fillText(o.metre.innerText,0,3+e.#L.cfont4[0]);switch(o.metre.globalCompositeOperation="xor",o.metre.fillRect(0,0,i.strength[n]*121/255,25),o.extVis.clearRect(0,0,47,25),o.extVis.fillStyle=`#${e.#w}`,i.chExt[n][0]){case e.device.EXT_VL:{let u=(i.chContr[r+v[136]]-64)/64||i.rawPitch[n]/8192;u=u*-4+4;let p=+(i.rawVelo[n]>0||i.chContr[r+v[1]]>0)*(i.chContr[r+v[129]]*i.chContr[r+v[11]]/16129);!p&&i.rawStrength[n]&&(p=i.rawStrength[n]*i.chContr[r+v[11]]/16129),p*=32;let w=i.chContr[r+v[1]]/127*8;o.extVis.beginPath(),o.extVis.moveTo(0,12-u-3),o.extVis.lineTo(7+p,12),o.extVis.lineTo(0,12+u+3),o.extVis.fill(),o.extVis.fillStyle=`#${e.getChAccent(n)}`,o.extVis.beginPath(),o.extVis.ellipse(43,12,4,4+w,0,0,na),o.extVis.fill();break}case e.device.EXT_DX:{i.chContr.subarray(r+v[142],r+v[157]+1).forEach((p,w)=>{w>=8&&(o.extVis.fillStyle=`#${e.getChAccent(n)}`);let E=w*3,$=(p-64)/5.82;$>=0?o.extVis.fillRect(E,12-$,2,$+1):o.extVis.fillRect(E,12,2,1-$)});break}}}}let m=new Array(y.ch);if(e.#i.forEach((n,s)=>{n.forEach((r,l)=>{r.refresh&&(r.refresh=!1,m[s<<7|l]=!0)})}),["line"].indexOf(e.#_)>-1)for(;e.#m.length>0;){let n=e.#m.shift();m[n.part]=!0}e.#ue(i,m),i.extraNotes.forEach(n=>{let{part:s,note:r,velo:l,state:o}=n,f=e.#i[s>>4][s&15].cxt;e.#ae(f,r,l,o,e.device.getPitchShift(s),s)});let C=e.#N.cxt;if(c>i.bitmap.expire?e.#R.fill(0):i.bitmap.bitmap.length>256?i.bitmap.bitmap.forEach((n,s)=>{e.#R[s]=n?e.pixelMax:e.pixelMin}):i.bitmap.bitmap.forEach((n,s)=>{e.#R[s<<1]=n?e.pixelMax:e.pixelMin,e.#R[s<<1|1]=n?e.pixelMax:e.pixelMin}),e.#Q.fill(0),c<=i.letter.expire&&e.glyphs.getStr(i.letter.text.padEnd(32," ")).forEach((n,s)=>{let r=(s&15)*5,l=s>>4<<3;n.forEach((o,f)=>{let u=r+f%5,p=l+Math.floor(f/5);e.#Q[p*80+u]=o?e.pixelMax:e.pixelMin})}),e.#A.forEach((n,s,r)=>{let l=e.#R[s];l>n?r[s]+=Math.min(l-n,me):l<n&&(r[s]-=Math.min(n-l,me))}),e.#s.forEach((n,s,r)=>{let l=e.#Q[s];l>n?r[s]+=Math.min(l-n,me):l<n&&(r[s]-=Math.min(n-l,me))}),e.#A.forEach((n,s)=>{let r=s>>5,l=s&31;e.#V[s]!==n?(C.clearRect(252+(l<<2),r<<2,3,3),n&&(C.fillStyle=`#${e.#w}${n.toString(16).padStart(2,"0")}`,C.fillRect(252+(l<<2),r<<2,3,3))):T()&&(C.clearRect(252+(l<<2),r<<2,3,3),n&&(C.fillStyle=`#ff0000${n.toString(16).padStart(2,"0")}`,C.fillRect(252+(l<<2),r<<2,3,3)))}),e.#s.forEach((n,s)=>{let r=Math.floor(s/80),l=s%80;l+=Math.floor(l/5),e.#o[s]!==n?(C.clearRect(l<<2,(r|16)<<2,3,3),n&&(C.fillStyle=`#${e.#w}${n.toString(16).padStart(2,"0")}`,C.fillRect(l<<2,(r|16)<<2,3,3))):T()&&(C.clearRect(l<<2,(r|16)<<2,3,3),n&&(C.fillStyle=`#ff0000${n.toString(16).padStart(2,"0")}`,C.fillRect(l<<2,(r|16)<<2,3,3)))}),e.#V.forEach((n,s,r)=>{r[s]=e.#A[s]}),e.#o.forEach((n,s,r)=>{r[s]=e.#s[s]}),T()){C.clearRect(0,0,251,63);for(let n=0;n<=e.device.polyIndexLast;n++){let s=n&31,r=n>>5;if(n+1===e.device.polyIndexLatest)C.fillStyle="#ff0";else switch(e.device.getPolyState(n)){case e.device.NOTE_SUSTAIN:{C.fillStyle="#0f0";break}case e.device.NOTE_HELD:case e.device.NOTE_SOSTENUTO_HELD:{C.fillStyle="#0f7";break}case e.device.NOTE_SOSTENUTO_SUSTAIN:{C.fillStyle="#70f";break}case e.device.NOTE_MUTED_RECOVERABLE:{C.fillStyle="#f70";break}default:C.fillStyle="#f00"}C.fillRect(s<<2,r<<2,3,3)}}let a=(self.performance||self.Date).now();switch(e.eventViewMode){case 0:{e.#t.events.setTextRaw(`${i.eventCount}`.padStart(3,"0"));break}case 1:{let n=1e3/(a-e.#O);n>99?(n=Math.round(n),e.#t.events.setTextRaw(`${n}`)):n>9?(n=Math.round(n*10)/10,e.#t.events.setTextRaw(`${Math.floor(n)}.${Math.floor(n*10%10)}`)):(n=Math.round(n*100)/100,e.#t.events.setTextRaw(`${Math.floor(n)}.${Math.floor(n*100%100)}`));break}case 2:{e.#t.events.setTextRaw(`${e.device.polyIndexLatest}`.padStart(3,"0"));break}default:e.#t.events.setTextRaw("???")}e.#O=a}#z;#Z;get style(){return this.#_}set style(e){let t=this;t.#_=e,t.#ue(t.render(t.#G?.currentTime||0)),L(t.#E,["cambiare-style-block","cambiare-style-comb","cambiare-style-piano","cambiare-style-line"]),V(t.#E,[`cambiare-style-${e}`])}getChMode(e=0,t){if(e>=y.ch)throw new RangeError("Invalid part number");let i=this;return t?i.#U[e]:i.#U[e]??i.#j}getChAccent(e=0){if(e>=y.ch)throw new RangeError("Invalid part number");let t=this;return t.#X[e]??t.#W}setClockSource(e){this.#G=e}setPixelProfile(e){let t=this;if(Ct[e]){let i=Ct[e];t.#L=i,t.#E&&(t.#E.style.setProperty("--pcp-font4",`translate(${i.font4[1]}px, ${i.font4[0]}px)`),t.#E.style.setProperty("--pcp-font7",`translate(${i.font7[1]}px, ${i.font7[0]}px)`))}else throw new Error(`"${e}" is not a valid pixel correction profile`)}setMode(e){let t=this;t.#j=e,t.#W=(Ee[e]||["fcdaff","742b81"])[t.#x];for(let i of t.#E.classList)i.substring(0,14)==="cambiare-mode-"&&t.#E.classList.remove(i);e!=="?"&&t.#E.classList.add(`cambiare-mode-${e}`)}setChMode(e,t){let i=this;i.#U[e]=t;let c=i.#i[e>>4][e&15];for(let d of c.root.classList)d.substring(0,10)==="part-mode-"&&c.root.classList.remove(d);t!=="?"&&c.root.classList.add(`part-mode-${t}`)}setScheme(e=0){let t=this;t.#x=e?1:0,t.#w=["ffffff","000000"][t.#x],[L,V][t.#x](t.#E,["cambiare-scheme-light"]),t.#W=(Ee[t.#j]||["fcdaff","742b81"])[t.#x];for(let i=0;i<y.ch;i++)if(t.device.getChActive(i)!==0&&t.#X[i]){let c=Ee[t.#U[i]];c&&(t.#X[i]=c[t.#x])}}#ee(e){let t=this,i=t.#v,c=t.#M;t.#i.forEach((d,h)=>{if(h>=c&&h<c+i){V(d.root,["port-active"]);let g=h-c,{l:b,t:m}=fa[g*(4/i)];d.root.style.top=`${m}px`,d.root.style.left=`${b}px`,d.forEach((C,a)=>{C.root.style.top=`${a*(i>2?26:52)}px`})}else L(d.root,["port-active"]),d.root.style.top="",d.root.style.left="",d.forEach((g,b)=>{g.root.style.top=""});e&&d.forEach((g,b)=>{g.cxt.canvas.width=t.#v===1?1193:495,g.cxt.canvas.height=t.#v===4?26:52})})}setPort(e){let t=this;L(t.#E,["cambiare-start0","cambiare-start1","cambiare-start2","cambiare-start3","cambiare-start4","cambiare-start5","cambiare-start6","cambiare-start7"]),V(t.#E,[`cambiare-start${e}`]),t.#M=e,t.#ee(!1)}setRange(e){let t=this;L(t.#E,["cambiare-port1","cambiare-port2","cambiare-port4","cambiare-compact"]),V(t.#E,[`cambiare-${e}`]),t.#v=parseInt(e.slice(4))||1,t.#ee(!0)}setFrameTime(e=20){let t=this;t.#Z?.constructor&&clearInterval(t.#Z),e<5?e=5:e>500&&(e=500),t.#Z=setInterval(t.#z,e),t.smoothingAtk=Math.pow(.1,e/20),t.smoothingDcy=Math.pow(.75,e/20)}attach(e){let t=this;t.#k=e;let i=x("div",["cambiare-container"]);e.appendChild(i),t.#K=i;let c=x("div",["cambiare-canvas","cambiare-port1","cambiare-start0","cambiare-style-comb"]);i.appendChild(c),t.#E=c,self.addEventListener("resize",t.#re),t.#re(),t.setFrameTime(20),t.#t.root=x("div",["sect-info"]),t.#t.events=x("span",["field","pcp-font4"],{t:1,l:0,w:35,h:33}),t.#t.curPoly=x("span",["field","pcp-font4"],{t:1,l:52,w:35,h:33}),t.#t.maxPoly=x("span",["field","pcp-font4"],{t:1,l:98,w:35,h:33}),t.#t.sigN=x("span",["field","pcp-font4"],{t:1,l:194,w:23,h:33,a:"right"}),t.#t.sigD=x("span",["field","pcp-font4"],{t:1,l:232,w:23,h:33}),t.#t.barCount=x("span",["field","pcp-font4"],{t:1,l:304,w:35,h:33,a:"right"}),t.#t.barDelim=x("span",["field","field-label","pcp-font4"],{t:0,l:343,w:8,h:33,i:"/"}),t.#t.barNote=x("span",["field","pcp-font4"],{t:1,l:354,w:23,h:33}),t.#t.tempo=x("span",["field","pcp-font4"],{t:1,l:454,w:64,h:33,a:"right"}),t.#t.volume=x("span",["field","pcp-font4"],{t:1,l:562,w:63,h:33,a:"right"}),t.#t.mode=x("span",["field","pcp-font4"],{t:1,l:708,w:152,h:33}),t.#t.reverb=x("span",["field","pcp-font4"],{t:1,l:1e3,w:190,h:33}),t.#t.chorus=x("span",["field","pcp-font4"],{t:1,l:1235,w:190,h:33}),t.#t.delay=x("span",["field","pcp-font4"],{t:1,l:1471,w:190,h:33}),t.#t.insert=x("span",["field","pcp-font4"],{t:1,l:1706,w:190,h:33}),t.#t.title=x("span",["field","pcp-font4"],{t:35,l:50,w:810,h:33}),t.#t.insert1=x("span",["field","pcp-font4"],{t:0,l:40,w:190,h:33}),t.#t.insert2=x("span",["field","pcp-font4"],{t:0,l:40,w:190,h:33}),t.#t.insert3=x("span",["field","pcp-font4"],{t:0,l:40,w:190,h:33}),t.#t.insert4=x("span",["field","pcp-font4"],{t:0,l:40,w:190,h:33}),t.#t.inscon1=x("span",["field","field-collapsive"],{t:35,l:960,w:230,h:33}),t.#t.inscon2=x("span",["field","field-collapsive"],{t:35,l:1195,w:230,h:33}),t.#t.inscon3=x("span",["field","field-collapsive"],{t:35,l:1431,w:230,h:33}),t.#t.inscon4=x("span",["field","field-collapsive"],{t:35,l:1666,w:230,h:33}),I(t.#t.inscon1,[x("span",["field","field-key","pcp-font7"],{t:0,l:0,w:36,h:33,i:"In2",a:"right"}),t.#t.insert1]),I(t.#t.inscon2,[x("span",["field","field-key","pcp-font7"],{t:0,l:0,w:36,h:33,i:"In3",a:"right"}),t.#t.insert2]),I(t.#t.inscon3,[x("span",["field","field-key","pcp-font7"],{t:0,l:0,w:36,h:33,i:"In4",a:"right"}),t.#t.insert3]),I(t.#t.inscon4,[x("span",["field","field-key","pcp-font7"],{t:0,l:0,w:36,h:33,i:"In5",a:"right"}),t.#t.insert4]),c.appendChild(t.#t.root),I(t.#t.root,[t.#t.events,t.#t.curPoly,x("span",["field","field-label","pcp-font4"],{t:1,l:89,w:5,h:33,i:":"}),t.#t.maxPoly,x("span",["field","field-key","pcp-font7"],{t:1,l:148,w:41,h:33,i:"TSig"}),t.#t.sigN,x("span",["field","field-label","pcp-font4"],{t:0,l:221,w:8,h:33,i:"/"}),t.#t.sigD,x("span",["field","field-key","pcp-font7"],{t:1,l:268,w:30,h:33,i:"Bar"}),t.#t.barCount,t.#t.barDelim,t.#t.barNote,x("span",["field","field-key","pcp-font7"],{t:1,l:390,w:61,h:33,i:"Tempo",a:"right"}),t.#t.tempo,x("span",["field","field-key","pcp-font7"],{t:1,l:528,w:29,h:33,i:"Vol"}),t.#t.volume,x("span",["field","field-label","pcp-font4"],{t:1,l:626,w:17,h:33,i:"%"}),x("span",["field","field-key","pcp-font7"],{t:1,l:652,w:52,h:33,i:"Mode"}),t.#t.mode,x("span",["field","field-key","pcp-font7"],{t:1,l:960,w:36,h:33,i:"Rev",a:"right"}),t.#t.reverb,x("span",["field","field-key","pcp-font7"],{t:1,l:1195,w:36,h:33,i:"Cho",a:"right"}),t.#t.chorus,x("span",["field","field-key","pcp-font7"],{t:1,l:1431,w:36,h:33,i:"Var",a:"right"}),t.#t.delay,x("span",["field","field-key","pcp-font7"],{t:1,l:1666,w:36,h:33,i:"In1",a:"right"}),t.#t.insert,t.#t.inscon1,t.#t.inscon2,t.#t.inscon3,t.#t.inscon4,x("span",["field","field-key","pcp-font7"],{t:35,l:0,w:44,h:33,i:"Title"}),t.#t.title]),t.#p.root=x("div",["sect-mark"]),t.#p.left=x("div",["sect-mark-left","boundary"],{t:0,l:0}),t.#p.right=x("div",["sect-mark-right","boundary"],{t:0,l:960}),c.appendChild(t.#p.root),I(t.#p.root,[t.#p.left,t.#p.right]),I(t.#p.left,[x("span",["field","field-key"],{t:0,l:0,w:26,h:33,i:"CH"}),x("span",["field","field-key"],{t:0,l:30,w:49,h:33,i:"Voice"}),x("span",["field","field-key","mark-send-title"],{t:2,l:164,w:25,h:18,i:"Send"}),x("span",["field","field-label","mark-send-param"],{t:16,l:146,w:58,h:16,i:"VEMRCDBP12",a:"center"}),x("span",["field","field-key"],{t:0,l:212,w:35,h:33,i:"Pan"}),x("span",["field","field-key"],{t:0,l:256,w:45,h:33,i:"Note"})]),I(t.#p.right,[x("span",["field","field-key"],{t:0,l:0,w:26,h:33,i:"CH"}),x("span",["field","field-key"],{t:0,l:30,w:49,h:33,i:"Voice"}),x("span",["field","field-key","mark-send-title"],{t:2,l:164,w:25,h:18,i:"Send"}),x("span",["field","field-label","mark-send-param"],{t:16,l:146,w:58,h:16,i:"VEMRCDBP12",a:"center"}),x("span",["field","field-key"],{t:0,l:212,w:35,h:33,i:"Pan"}),x("span",["field","field-key"],{t:0,l:256,w:45,h:33,i:"Note"})]),t.#i.root=x("div",["sect-part"]);for(let d=0;d<y.ch>>4;d++){let h=d<<4;t.#i[d]=[],t.#i[d].root=x("div",["boundary",`part-port-${d}`]);for(let g=0;g<16;g++){let b=(h|g)+1;b>=100?b=`${Math.floor(b/10).toString(16)}${b%10}`:b=`${b}`.padStart(2,"0"),t.#i[d][g]={root:x("div",["boundary","part-channel"]),major:x("div",["boundary","part-info-major"]),minor:x("div",["boundary","part-info-minor"],{t:26}),keys:x("div",["boundary","part-keys"]),notes:x("div",["boundary","part-keyboard"]),cxt:x("canvas",["field"]).getContext("2d"),number:x("span",["field","field-label","pcp-font4"],{t:1,w:18,h:25,i:b}),voice:x("span",["field"],{l:22,t:1,w:121,h:25}),metre:x("canvas",["field"]).getContext("2d"),type:x("span",["field","field-label","pcp-font4"],{t:1,w:18,h:25}),std:x("span",["field","pcp-font4"],{l:22,t:1,w:20,h:25,a:"center"}),msb:x("span",["field","pcp-font4"],{l:48,t:1,w:27,h:25}),prg:x("span",["field","pcp-font4"],{l:81,t:1,w:27,h:25}),lsb:x("span",["field","pcp-font4"],{l:114,t:1,w:27,h:25}),ccVis:x("canvas",["field"],{l:145,t:1}).getContext("2d"),extVis:x("canvas",["field"],{l:207,t:1}).getContext("2d"),ccUpdate:!1};let m=t.#i[d][g];kt.forEach(C=>{m.notes.appendChild(x("span",["field","part-csplit"],{l:C}))}),m.notes.appendChild(x("span",["field","part-csplit","part-cdive"],{l:0,w:"100%",h:1})),m.metre.canvas.width=121,m.metre.canvas.height=25,m.metre.textBaseline="top",m.metre.font="20px 'PT Sans Narrow'",m.ccVis.canvas.width=109,m.ccVis.canvas.height=25,m.ccVis.fillStyle=`#${t.#w}`,m.extVis.canvas.width=47,m.extVis.canvas.height=25,m.extVis.fillStyle=`#${t.#w}`,I(m.notes,[m.cxt.canvas]),I(m.keys,[m.notes]),I(m.voice,[m.metre.canvas]),I(m.major,[m.number,m.voice,m.ccVis.canvas]),I(m.minor,[m.type,m.std,m.msb,m.prg,m.lsb,m.extVis.canvas]),I(m.root,[m.major,m.minor,m.keys]),I(t.#i[d].root,[m.root]),m.number.addEventListener("contextmenu",C=>{C.preventDefault(),C.stopImmediatePropagation();let a=d<<4|g;t.#Y[a]=+!t.#Y[a],[L,V][t.#Y[a]](m.root,["part-hidden"])})}t.#i.root.appendChild(t.#i[d].root)}c.appendChild(t.#i.root),t.#g.root=x("div",["sect-meta"]),t.#g.view=x("div",["boundary"]),c.appendChild(t.#g.root),I(t.#g.root,[t.#g.view]),t.#N.root=x("div",["sect-pix","boundary"],{l:1529,t:950,w:379,h:127}),t.#N.cxt=x("canvas",["field"]).getContext("2d"),t.#N.fps=x("span",["field","field-key"],{l:0,w:"100%",h:1}),t.#N.cxt.canvas.width=379,t.#N.cxt.canvas.height=127,I(t.#N.root,[t.#N.cxt.canvas]),c.appendChild(t.#N.root),t.addEventListener("mode",d=>{t.#t.mode.setTextRaw(`${la[d.data]}`),t.setMode(d.data)}),t.addEventListener("mastervolume",d=>{let h=Math.round(d.data*100)/100;t.#t.volume.setTextRaw(`${Math.floor(h)}.${`${Math.floor(h%1*100)}`.padStart(2,"0")}`)}),t.addEventListener("tempo",d=>{let h=Math.round(d.data*100);t.#t.tempo.setTextRaw(`${Math.floor(h/100)}.${`${Math.floor(h%100)}`.padStart(2,"0")}`)}),t.addEventListener("tsig",d=>{[t.#t.sigN.innerText,t.#t.sigD.innerText]=d.data}),t.addEventListener("title",d=>{t.#t.title.setTextRaw(d.data||"No Title")}),t.addEventListener("voice",({data:d})=>{let h=t.getCachedChVoice(d.part,!0),g=t.getChPrimitives(d.part,!0),b=t.#i[d.part>>4][d.part&15];vt(b.metre,t.getMapped(h.name),h.refreshFailure||h.ending!==" "),b.type.setTextRaw(ra[t.device.getChType(d.part)]),b.std.setTextRaw(h.standard),b.msb.setTextRaw(`${g[0]}`.padStart(3,"0")),b.prg.setTextRaw(`${g[1]}`.padStart(3,"0")),b.lsb.setTextRaw(`${g[2]}`.padStart(3,"0"))}),t.addEventListener("pitch",d=>{let{part:h,pitch:g}=d.data;t.#i[h>>4][h&15].notes.style.transform=`translateX(${g/1.28}%)`}),t.addEventListener("efxreverb",d=>{if(!d.data?.id)debugger;t.#t.reverb.setTextRaw(t.getEfx(d.data.id))}),t.addEventListener("efxchorus",d=>{if(!d.data?.id)debugger;t.#t.chorus.setTextRaw(t.getEfx(d.data.id))}),t.addEventListener("efxdelay",d=>{if(!d.data?.id)debugger;t.#t.delay.setTextRaw(t.getEfx(d.data.id))}),t.addEventListener("efxinsert0",d=>{if(!d.data?.id)debugger;t.#t.insert.setTextRaw(t.getEfx(d.data.id))}),t.addEventListener("efxinsert1",d=>{if(!d.data?.id)debugger;t.#t.insert1.setTextRaw(t.getEfx(d.data.id)),d.data?.hidden?L(t.#t.inscon1,["field-active"]):V(t.#t.inscon1,["field-active"])}),t.addEventListener("efxinsert2",d=>{if(!d.data?.id)debugger;t.#t.insert2.setTextRaw(t.getEfx(d.data.id)),d.data?.hidden?L(t.#t.inscon2,["field-active"]):V(t.#t.inscon2,["field-active"])}),t.addEventListener("efxinsert3",d=>{if(!d.data?.id)debugger;t.#t.insert3.setTextRaw(t.getEfx(d.data.id)),d.data?.hidden?L(t.#t.inscon3,["field-active"]):V(t.#t.inscon3,["field-active"])}),t.addEventListener("efxinsert4",d=>{if(!d.data?.id)debugger;t.#t.insert4.setTextRaw(t.getEfx(d.data.id)),d.data?.hidden?L(t.#t.inscon4,["field-active"]):V(t.#t.inscon4,["field-active"])}),t.addEventListener("partefxtoggle",d=>{let{part:h,active:g}=d.data;if(h>=y.ch)throw new Error("HORNI");[L,V][g?1:0](t.#i[h>>4][h&15].number,["part-efx"])}),t.addEventListener("channeltoggle",d=>{let{part:h,active:g}=d.data;[L,V][g?1:0](t.#i[h>>4][h&15].root,["part-active"])}),t.addEventListener("channelactive",d=>{if(t.#l<y.ch){let g=t.#i[t.#l>>4][t.#l&15].number;L(g,["part-focus"])}let h=d.data;if(h<y.ch){let g=t.#i[h>>4][h&15].number;V(g,["part-focus"]),t.#l=h}}),t.addEventListener("metacommit",d=>{let h=d.data,g=!1;if(t.#T&&h.type===t.#$&&t.#u){switch(h.type){case"C.Lyrics":case"KarLyric":case"SGLyrics":{I(t.#u,[x("span",["meta-slice"],{i:h.data})]);break}default:t.#u.childNodes[0].data+=h.data}g=!0}else if((h.data?.length||typeof h.data=="object")&&oa.indexOf(h.type)===-1){let b=x("div",["meta-line"]),m=x("span",["field","field-key","meta-type"],{i:ca[h.type]||h.type});switch(h.mask&&(m.style.display="none"),h.type){case"C.Lyrics":case"KarLyric":case"SGLyrics":{t.#u=x("span",["field","meta-data"]),I(t.#u,[x("span",["meta-slice"],{i:h.data})]);break}case"OSysMeta":{let C=h?.data,a;switch(h?.msg){case"part.rename":{let n=t.device?.getVoice(...t.getCachedChVoice(C.part).sid,t.device?.getChMode(0)).name;a=`CH${C.part+1} was renamed from "${t.getMapped(n)}" (${n}) to "${visualizer.device?.getChCvnString(0)}".`;break}default:console.debug(`Unhandled Octavia system meta event "${h.msg}":
%o`,h.data)}t.#u=x("span",["field","meta-data"],{i:a??`${h.data?.msg}`});break}default:t.#u=x("span",["field","meta-data"],{i:h.data})}for(t.#g.view.appendChild(b),I(b,[m,t.#u]),t.#g.view.children.length>t.#b&&(t.#d=Date.now()+500,t.#c===0&&console.debug("Meta event garbage collector triggered."),t.#c=1);t.#g.view.children.length>t.#S;)t.#g.view.children[0].remove();g=!0}g&&(t.#T=h.amend??!1,t.#$=h.type??""),t.#pe()}),t.#g.view.style.transform="translateX(0px) translateY(140px)",t.#h=setInterval(async()=>{let d=Date.now();if(t.#c!==0)switch(t.#c){case 1:{if(d<t.#d)break;t.#g.view.style.transition="none";let h=0;for(;t.#g.view.children.length>t.#a;)t.#g.view.children[0].remove(),h++;t.#pe(),console.debug(`Meta event garbage collector removed ${h} events.`),t.#c=2;break}case 2:{if(d<t.#d+100)break;t.#g.view.style.transition="",T()&&console.debug("Meta event garbage collector restored meta animation."),t.#c=0;break}}},40),t.dispatchEvent("mode","?"),t.dispatchEvent("mastervolume",100),t.dispatchEvent("tempo",120),t.dispatchEvent("tsig",[4,4]),t.dispatchEvent("title",""),t.dispatchEvent("efxreverb",{id:t.device.getEffectType(0)}),t.dispatchEvent("efxchorus",{id:t.device.getEffectType(1)}),t.dispatchEvent("efxdelay",{id:t.device.getEffectType(2)}),t.dispatchEvent("efxinsert0",{id:t.device.getEffectType(3)}),t.#ee(!0)}detach(e){let t=this;self.removeEventListener("resize",t.#re),t.#E.remove(),t.#E=void 0,t.#K.remove(),t.#K=void 0,t.#k=void 0,clearInterval(t.#Z),clearInterval(t.#h)}constructor(e,t){super(new ft,.1,.75);let i=this;i.#re=i.#be.bind(this),i.#z=i.#J.bind(this),i.#X.fill(null),i.#U.fill(null),e&&i.attach(e),t&&i.setClockSource(t),i.setPixelProfile("none"),i.addEventListener("reset",()=>{i.#y=0,i.#n=0,i.#T=!1,i.#$="",i.#u=null,i.#l=y.invalidCh,i.#X.fill(null),i.#U.fill(null),L(i.#t.inscon1,["field-active"]),L(i.#t.inscon2,["field-active"]),L(i.#t.inscon3,["field-active"]),L(i.#t.inscon4,["field-active"]);try{let c=i.#g.view.children;for(let d=c.length-1;d>=0;d--)c[d].remove();i.#g.view.style.transform="translateX(0px) translateY(140px)";for(let d=0;d<y.ch;d++){let h=i.#i[d>>4][d&15];L(h.root,["part-active"]),L(h.number,["part-efx","part-focus"]);for(let g of h.root.classList)g.substring(0,10)==="part-mode-"&&h.root.classList.remove(g);vt(h.metre,""),h.type.setTextRaw(""),h.std.setTextRaw(""),h.msb.setTextRaw(""),h.prg.setTextRaw(""),h.lsb.setTextRaw(""),h.notes.style.transform="",h.ccUpdate=!0}}catch{}}),i.addEventListener("chmode",({data:c})=>{let{part:d,mode:h}=c;i.setChMode(d,h);let g=Ee[h];g&&(i.#X[d]=g[i.#x])}),i.addEventListener("pitch",({data:c})=>{i.#m.push(c)})}};export{Si as Cambiare};
