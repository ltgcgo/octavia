var Gr=Object.create;var Vt=Object.defineProperty;var Xr=Object.getOwnPropertyDescriptor;var Vr=Object.getOwnPropertyNames;var Kr=Object.getPrototypeOf,Fr=Object.prototype.hasOwnProperty;var zr=(g,e,r)=>e in g?Vt(g,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):g[e]=r;var rr=(g,e)=>()=>(g&&(e=g(g=0)),e);var qr=(g,e)=>()=>(e||g((e={exports:{}}).exports,e),e.exports);var Wr=(g,e,r,l)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of Vr(e))!Fr.call(g,n)&&n!==r&&Vt(g,n,{get:()=>e[n],enumerable:!(l=Xr(e,n))||l.enumerable});return g};var Yr=(g,e,r)=>(r=g!=null?Gr(Kr(g)):{},Wr(e||!g||!g.__esModule?Vt(r,"default",{value:g,enumerable:!0}):r,g));var R=(g,e,r)=>(zr(g,typeof e!="symbol"?e+"":e,r),r),ar=(g,e,r)=>{if(!e.has(g))throw TypeError("Cannot "+r)};var t=(g,e,r)=>(ar(g,e,"read from private field"),r?r.call(g):e.get(g)),T=(g,e,r)=>{if(e.has(g))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(g):e.set(g,r)},x=(g,e,r,l)=>(ar(g,e,"write to private field"),l?l.call(g,r):e.set(g,r),r),sr=(g,e,r,l)=>({set _(n){x(g,e,n,r)},get _(){return t(g,e,l)}});var ir=rr(()=>{"use strict";N();(function(){var g=function(v,y,$){var a,s;if(self.MessageEvent)switch(v){case"message":{s=new MessageEvent(v,{data:y,ports:$==null?void 0:$.ports}),Object.defineProperty(s,"source",{value:$==null?void 0:$.source});break}default:s=new Event(v)}else s=document.createEvent("Event"),s.initEvent(v,!1,!1),$&&v=="message"&&(s.data=y,$.source&&Object.defineProperty(s,"source",{value:$.source}),(a=$.ports)!=null&&a.length&&Object.defineProperty(s,"ports",{value:$.ports}));return s};self.BroadcastChannel?console.info("[Snowy] Snowy is disabled."):(console.info("[Snowy] Snowy is enabled. Path: ".concat(self.SNOWY_PATH||"/snowy.js")),r=[],l={},n=function(v){var y,$=this;if((this==null?void 0:this.constructor)!=n)throw new TypeError("Illegal constructor");r.push(this),(y=l[v])!=null&&y.constructor||(l[v]=[]),l[v].push(this);var a=Math.floor(Math.random()*281474976710656),s=[],h=0,i=[],c=!0,d=!1;Object.defineProperty(this,"id",{get:function(){return a}}),Object.defineProperty(this,"name",{value:v}),this.close=function(){var u,f=r.indexOf($);f>-1?(e.postMessage({t:"d",c:v,i:a}),r.splice(f,1),(u=l[v])!=null&&u.constructor&&(f=l[v].indexOf($),f>-1&&l[v].splice(f,1)),l[v].length||delete l[v],console.debug("[Snowy] BroadcastChannel closed."),d=!0):console.debug("[Snowy] BroadcastChannel already closed.")},this.postMessage=function(u){if(e){if(d)throw new Error("Channel already closed");e.postMessage({t:"m",c:v,i:a,m:h,d:u}),h++,h>4294967295&&(h=0)}else i.push(u),console.debug("[Snowy] Message is cached.")},this.flush=function(){if(e){if(c){for(e.postMessage({t:"r",c:v,i:a}),console.debug("[Snowy] ".concat(i.length," message(s) in cache."));i.length;){var u=i.shift();$.postMessage(u)}c=!1,console.debug("[Snowy] All cached messages are flushed away.")}}else throw new Error("Tried to flush when the ports are not ready")},this.receiveMessage=function(u){u.c==v?u.i!=a&&$.dispatchEvent(g("message",u.d,{source:$})):console.debug("[Snowy] Channel ID mismatch. Instance ".concat(a," receives from ").concat(v,", not ").concat(u.c,"."))};var o={};this.dispatchEvent=function(u){var f,b;if(Object.defineProperty(u,"target",{value:$}),Object.defineProperty(u,"currentTarget",{value:$}),(f=o[u.type])!=null&&f.length)for(var k=o[u.type],M=0;M<k.length;M++)((b=k[M])==null?void 0:b.constructor)==Function&&k[M].call($,u);$["on".concat(u.type)]&&$["on".concat(u.type)].constructor==Function&&$["on".concat(u.type)].call($,u)},this.addEventListener=function(u,f){var b;(b=o[u])!=null&&b.constructor||(o[u]=[]);var k=o[u].indexOf(f);k==-1&&o[u].push(f)},this.removeEventListener=function(u,f){var b,k;if((b=o[u])!=null&&b.length){var M=o[u].indexOf(f);M>-1&&o[u].splice(M,1)}!((k=o[u])!=null&&k.length)&&o[u].constructor&&delete o[u]}},self.BroadcastChannel=n,p=function(){if(e){e.addEventListener("message",function(y){var $=y.data,a=!1;switch($.t){case"k":{a=!1,e.postMessage({t:"k"});break}case"m":{var s=l[$.c];if(s!=null&&s.length)for(var h=0;h<s.length;h++)s[h].receiveMessage($);break}case"c":{for(var i=[],c=0;c<r.length;c++){var d=r[c].name;i.indexOf(d)<0&&i.push(d)}e.postMessage({t:"k",c:i});break}default:a=!0}a&&console.info("ReceiveBroadcast",$)});for(var v=0;v<r.length;v++)r[v].flush()}else throw new Error("Message port isn't yet ready");console.info("[Snowy] Snowy is active.")},m=function(){if(!e){var v=new SharedWorker(self.SNOWY_PATH||"/snowy.js");v.port.start();var y=function($){$.data.t=="swc"&&(v.port.removeEventListener("message",y),e=v.port,e.postMessage({t:"k"}),p())};v.port.addEventListener("message",y)}},m());var e,r,l,n,p,m})()});var N=rr(()=>{"use strict";ir();{let g=function(e,r){let l=new FileReader;return new Promise((n,p)=>{switch(l.addEventListener("abort",()=>{p(new Error("Blob read aborted"))}),l.addEventListener("error",m=>{p(l.error||m.data||new Error("Blob read error"))}),l.addEventListener("load",()=>{n(l.result)}),r.toLowerCase()){case"arraybuffer":case"buffer":{l.readAsArrayBuffer(e);break}case"string":case"text":{l.readAsText(e);break}default:p(new Error(`Unknown target ${r}`))}})};Blob.prototype.arrayBuffer=Blob.prototype.arrayBuffer||function(){return g(this,"buffer")},Blob.prototype.text=Blob.prototype.text||function(){return g(this,"text")}}String.prototype.replaceAll=String.prototype.replaceAll||function(g,e){let r=0,l=16,n=this,p=[];for(;r<l&&n.lastIndexOf(g)>-1;){let m=n.lastIndexOf(g);p.unshift(n.slice(m+g.length)),n=n.slice(0,m),m==0&&p.unshift(""),r++}return n.length&&p.unshift(n),p.join(e)||""},String.prototype.padStart=String.prototype.padStart||function(g,e){if(e){let r=this;for(;r.length<g;)r=`${e}${r}`;return r}},String.prototype.padEnd=String.prototype.padEnd||function(g,e){if(e){let r=this;for(;r.length<g;)r+=e;return r}}});var Lr=qr((is,Jt)=>{N();(function(){"use strict";let g={fatal:!0},e=[new TextDecoder("iso-8859-15",g),new TextDecoder("utf-8",g),new TextDecoder("sjis",g),new TextDecoder("euc-jp",g),new TextDecoder("utf-16",g),new TextDecoder("ascii")],r={debug:!1,parse:function(l,n){if(l instanceof Uint8Array)return r.Uint8(l);if(typeof l=="string")return r.Base64(l);if(l instanceof HTMLElement&&l.type==="file")return r.addListener(l,n);throw new Error("MidiParser.parse() : Invalid input provided")},addListener:function(l,n){if(!File||!FileReader)throw new Error("The File|FileReader APIs are not supported in this browser. Use instead MidiParser.Base64() or MidiParser.Uint8()");if(l===void 0||!(l instanceof HTMLElement)||l.tagName!=="INPUT"||l.type.toLowerCase()!=="file")return console.warn("MidiParser.addListener() : Provided element is not a valid FILE INPUT element"),!1;n=n||function(){},l.addEventListener("change",function(p){if(!p.target.files.length)return!1;console.log("MidiParser.addListener() : File detected in INPUT ELEMENT processing data..");let m=new FileReader;m.readAsArrayBuffer(p.target.files[0]),m.onload=function(v){n(r.Uint8(new Uint8Array(v.target.result)))}})},Base64:function(l){let n=function(v){var y="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";if(v=v.replace(/^.*?base64,/,""),v=String(v).replace(/[\t\n\f\r ]+/g,""),!/^(?:[A-Za-z\d+\/]{4})*?(?:[A-Za-z\d+\/]{2}(?:==)?|[A-Za-z\d+\/]{3}=?)?$/.test(v))throw new TypeError("Failed to execute _atob() : The string to be decoded is not correctly encoded.");v+="==".slice(2-(3&v.length));let $,a="",s,h,i=0;for(;i<v.length;)$=y.indexOf(v.charAt(i++))<<18|y.indexOf(v.charAt(i++))<<12|(s=y.indexOf(v.charAt(i++)))<<6|(h=y.indexOf(v.charAt(i++))),a+=s===64?String.fromCharCode($>>16&255):h===64?String.fromCharCode($>>16&255,$>>8&255):String.fromCharCode($>>16&255,$>>8&255,255&$);return a}(l=String(l));var p=n.length;let m=new Uint8Array(new ArrayBuffer(p));for(let v=0;v<p;v++)m[v]=n.charCodeAt(v);return r.Uint8(m)},Uint8:function(m){let n={data:null,pointer:0,movePointer:function(s){return this.pointer+=s,this.pointer},readInt:function(s){if((s=Math.min(s,this.data.byteLength-this.pointer))<1)return-1;let h=0;if(1<s)for(let i=1;i<=s-1;i++)h+=this.data.getUint8(this.pointer)*Math.pow(256,s-i),this.pointer++;return h+=this.data.getUint8(this.pointer),this.pointer++,h},readStr:function(s){let h=new Uint8Array(s),i=!1,c;h.forEach((d,o)=>{h[o]=this.readInt(1)});for(let d=0;d<e.length;d++)if(!i)try{if(c=e[d].decode(h),d==0)for(let o=0;o<c.length;o++){let u=c.charCodeAt(o);if(u>191||u>127&&u<160)throw new RangeError(`Invalid code point: ${u}`)}i=!0,console.debug(`String byte sequence in ${e[d].encoding}`)}catch(o){console.debug(`SMF string ${o}`)}return c||"String byte sequence read failed."},backOne:function(){this.pointer--},readIntVLV:function(){let s=0;if(this.pointer>=this.data.byteLength)return-1;if(this.data.getUint8(this.pointer)<128)s=this.readInt(1);else{let i=[];for(;128<=this.data.getUint8(this.pointer);)i.push(this.readInt(1)-128);var h=this.readInt(1);for(let c=1;c<=i.length;c++)s+=i[i.length-c]*Math.pow(128,c);s+=h}return s}};if(n.data=new DataView(m.buffer,m.byteOffset,m.byteLength),n.readInt(4)!==1297377380)return console.warn("Header validation failed (not MIDI standard or file corrupt.)"),!1;n.readInt(4);let p={};p.formatType=n.readInt(2),p.tracks=n.readInt(2),p.track=[];var m=n.readInt(1),v=n.readInt(1);128<=m?(p.timeDivision=[],p.timeDivision[0]=m-128,p.timeDivision[1]=v):p.timeDivision=256*m+v;for(let s=1;s<=p.tracks;s++){p.track[s-1]={event:[]};var y,$=n.readInt(4);if($===-1)break;if($!==1297379947)return!1;n.readInt(4);let h=0,i=!1,c,d;for(;!i&&(h++,p.track[s-1].event[h-1]={},p.track[s-1].event[h-1].deltaTime=n.readIntVLV(),(c=n.readInt(1))!==-1);)if(128<=c?d=c:(c=d,n.movePointer(-1)),c===255){p.track[s-1].event[h-1].type=255,p.track[s-1].event[h-1].metaType=n.readInt(1);var a=n.readIntVLV();switch(p.track[s-1].event[h-1].metaType){case 47:case-1:i=!0;break;case 1:case 2:case 3:case 4:case 5:case 7:case 6:p.track[s-1].event[h-1].data=n.readStr(a);break;case 33:case 89:case 81:p.track[s-1].event[h-1].data=n.readInt(a);break;case 84:p.track[s-1].event[h-1].data=[],p.track[s-1].event[h-1].data[0]=n.readInt(1),p.track[s-1].event[h-1].data[1]=n.readInt(1),p.track[s-1].event[h-1].data[2]=n.readInt(1),p.track[s-1].event[h-1].data[3]=n.readInt(1),p.track[s-1].event[h-1].data[4]=n.readInt(1);break;case 88:p.track[s-1].event[h-1].data=[],p.track[s-1].event[h-1].data[0]=n.readInt(1),p.track[s-1].event[h-1].data[1]=n.readInt(1),p.track[s-1].event[h-1].data[2]=n.readInt(1),p.track[s-1].event[h-1].data[3]=n.readInt(1);break;default:this.customInterpreter!==null&&(p.track[s-1].event[h-1].data=this.customInterpreter(p.track[s-1].event[h-1].metaType,n,a)),this.customInterpreter!==null&&p.track[s-1].event[h-1].data!==!1||(n.readInt(a),p.track[s-1].event[h-1].data=n.readInt(a),this.debug&&console.info("Unimplemented 0xFF meta event! data block readed as Integer"))}}else switch((c=c.toString(16).split(""))[1]||c.unshift("0"),p.track[s-1].event[h-1].type=parseInt(c[0],16),p.track[s-1].event[h-1].channel=parseInt(c[1],16),p.track[s-1].event[h-1].type){case 15:this.customInterpreter!==null&&(p.track[s-1].event[h-1].data=this.customInterpreter(p.track[s-1].event[h-1].type,n,!1)),this.customInterpreter!==null&&p.track[s-1].event[h-1].data!==!1||(y=n.readIntVLV(),p.track[s-1].event[h-1].data=n.readInt(y),this.debug&&console.info("Unimplemented 0xF exclusive events! data block readed as Integer"));break;case 10:case 11:case 14:case 8:case 9:p.track[s-1].event[h-1].data=[],p.track[s-1].event[h-1].data[0]=n.readInt(1),p.track[s-1].event[h-1].data[1]=n.readInt(1);break;case 12:case 13:p.track[s-1].event[h-1].data=n.readInt(1);break;case-1:i=!0;break;default:if(this.customInterpreter!==null&&(p.track[s-1].event[h-1].data=this.customInterpreter(p.track[s-1].event[h-1].metaType,n,!1)),this.customInterpreter===null||p.track[s-1].event[h-1].data===!1)return console.log("Unknown EVENT detected... reading cancelled!"),!1}}return p},customInterpreter:null};if(typeof Jt<"u")Jt.exports=r;else{let l=typeof window=="object"&&window.self===window&&window||typeof self=="object"&&self.self===self&&self||typeof global=="object"&&global.global===global&&global;l.MidiParser=r}})()});N();N();var ce,nr,Ut=(nr=class{constructor(){T(this,ce,{})}addEventListener(g,e){t(this,ce)[g]||(t(this,ce)[g]=[]),t(this,ce)[g].unshift(e)}removeEventListener(g,e){if(t(this,ce)[g]){let r=t(this,ce)[g].indexOf(e);r>-1&&t(this,ce)[g].splice(r,1),t(this,ce)[g].length<1&&delete t(this,ce)[g]}}dispatchEvent(g,e){var n;let r=new Event(g),l=this;r.data=e,((n=t(this,ce)[g])==null?void 0:n.length)>0&&t(this,ce)[g].forEach(function(p){try{p==null||p.call(l,r)}catch(m){console.error(m)}}),this[`on${g}`]&&this[`on${g}`](r)}},ce=new WeakMap,nr);N();N();var cr=function(g,e){let r=Math.min(g.length,e.length),l=g.slice(0,r),n=e.slice(0,r),p=0,m=0;for(;m<r&&p==0;)p=Math.sign(l[m]-n[m]),m++;return p},me=function(g=""){this.name=g,this.pool=[],this.point=function(e,r=!1){if(this.pool.length>0){let l=this.pool.length,n=1<<Math.floor(Math.log2(l)),p=n,m=64;for(;n>=1&&m>=0;){if(m<=0)throw new Error("TTL reached.");if(p==l)p-=n;else{let y=cr(e,this.pool[p]);switch(y){case 0:{m=0;break}case 1:{p+n<=l&&(p+=n);break}case-1:{p!=0&&(p-=n);break}default:console.warn(`Unexpected result ${y}.`)}}n=n>>1,m--}let v=!0;if(p>=this.pool.length)v=!1;else{let y=this;this.pool[p].forEach(function($,a,s){v&&$!=e[a]&&(v=!1)}),!v&&cr(e,this.pool[p])>0&&p++}return v||r?p:-1}else return r?0:-1},this.add=function(e,r){return e.data=r,this.pool.splice(this.point(e,!0),0,e),this},this.default=function(e){console.warn(`No match in "${this.name||"(unknown)"}" for "${e}". Default action not defined.`)},this.get=function(e){let r=this.point(e);if(r>-1)return this.pool[r].data;this.default(e)},this.run=function(e,...r){let l=this.point(e);l>-1?e.subarray?this.pool[l].data(e.subarray(this.pool[l].length),...r):this.pool[l].data(e.slice(this.pool[l].length),...r):this.default(e,...r)}};N();var Qr=["MSB","PRG","LSB","NME","ELC","DRM","LVL"],Zr={krs:"KR",s90es:"ES",motif:"ES"},Jr={krs:"Kr",s90es:"SE",motif:"ME"},Kt=function(g){let e=Math.floor(g/10),r=g%10;return`${e.toString(16)}${r}`},ee,or,Ft=(or=class{constructor(...g){T(this,ee,void 0);R(this,"strictMode",!1);this.loadFiles(...g)}get bankInfo(){return t(this,ee)}get(g=0,e=0,r=0,l,n=0){var k,M;let p=[g,e,r],m,v=1,y=0,$,a,s=Array.from(arguments);switch(l){case"xg":{switch(g){case 0:{r===126?s[2]=125:r===127&&(s[2]=0);break}case 16:{r===126&&(s[2]=0);break}case 32:{r>125&&(s[2]=0),s[2]+=4;break}case 33:{(r>125||r===3)&&(s[2]=0),s[2]+=5;break}case 34:case 35:case 36:{r>125&&(s[2]=0),s[2]+=5;break}case 79:case 80:case 81:case 82:case 83:case 84:s[0]+=16;case 95:case 96:case 97:case 98:case 99:case 100:{r===126&&(s[2]=0);break}case 48:case 64:case 126:case 127:{r===126&&(g===127&&e===0||(s[2]=0));break}}break}case"gs":case"sc":{g===0&&r<5?s[0]=49:g>125&&r<5&&r!=2&&(s[2]=g,s[0]=49);break}case"mt32":{g===0&&(s[0]=49);break}case"sd":{switch(g){case 121:{s[0]=96;break}case 120:{s[0]=104;break}}s[0]>>1===40?s[2]|=16:s[0]>95&&s[0]<100&&(s[2]|=16,e>>4===7&&(s[0]=96));break}case"g2":{g>>1===40?s[2]|=16:g>95&&g<100&&(s[2]|=16,e>>4===7&&(s[0]=96));break}case"sg":{g===8&&r===0&&(s[2]=5);break}case"05rw":case"x5d":{g&&g<56&&(s[0]=56);break}case"s90es":{if(g===0)break;r<8?s[2]+=17:r<32?s[2]+=13:s[2]=(s[2]>>3)+19;break}case"motif":{if(g===0)break;r<8?s[2]+=28:r<32?s[2]+=13:s[2]=(s[2]>>3)+19;break}}let h=" ",i="M",c="",d=0,o=0;switch(s[0]){case 0:{switch(s[2]){case 127:{i="GM-a";break}case 126:{i="GM-n";break}case 7:{i="GM-k",c="GLX";break}case 5:{i="SG-a",c="000";break}case 4:{l==="gs"||l==="sc"?(i="GM-a",c="000"):(i="SP-l",c="C/M");break}case 3:case 2:case 1:{(l==="gs"||l==="sc")&&(i="GM-a",c="000");break}case 0:{i="GM-a";break}default:i="y",d=3}break}case 8:{l==="sg"?i="GM-s":i="r:";break}case 32:case 33:case 34:case 35:case 36:{l==="xg"&&(i=`${["AP","VL","PF","DX","AN"][g&7]}-${"abcdefgh"[r]}`,d=3);break}case 48:{c=`M${(s[2]>>3).toString().padStart(2,"0")}`,i=`y${c}`,d=1;break}case 49:{s[2]>>1===63?(i=`MT-${"ba"[s[2]&1]}`,c=`C${"-/"[s[2]&1]}M`):(i="GM-a",c="000");break}case 56:{i="GM-b";break}case 57:i=["yDOC","QY10","QY20"][s[2]-112]||"yMxv",c=["DOC","QY1","QY2"][s[2]-112]||"057";case 61:case 120:{i="rDrm";break}case 62:{i="kDrm";break}case 63:{if(s[2]<17){let P=s[2];i=P<10?"kP:":"kC:",i+=P%10}else s[2]<34?i=["Pre1","Pre2","Pre3","Pre4","Usr1","Usr2","DrmP","DrmU","Plg1","Plg2","Plg3","Pre1","Pre2","Pre3","Pre4","Pre5","Pre6"][s[2]-17]:i="Ds";d=1;break}case 64:{i="ySFX",c="SFX";break}case 67:{i="DX:S";break}case 80:case 81:case 82:case 83:{i=`Prg${"UABC"[s[0]-80]}`;break}case 88:case 89:case 90:case 91:{i=`Cmb${"UABC"[s[0]-88]}`;break}case 95:{i=`${["DR","PC"][s[2]]}-d`;break}case 96:{i=s[2]===106?"AP-a":s[2]>>4===1?"SDg":"PF",s[2]>63?o=63:s[2]>>4===1&&(o=16),d=3;break}case 97:{i=s[2]>>4===1?"SDa":"VL:",d=3,s[2]>>4===1?o=16:o=112;break}case 98:{i=s[2]>>4===1?"SDb":"SG-a",d=3,o=16;break}case 99:{i=s[2]>>4===1?"SDc":"DX",s[2]>63?o=63:s[2]>>4===1&&(o=16),d=3;break}case 100:{i="AN",s[2]>63?o=63:s[2]>>4===1&&(o=16),d=3;break}case 104:case 105:case 106:case 107:{i="SDd",o=104;break}case 121:{i=`GM-${s[2]?"":"a"}`,d=3;break}case 122:{i="lDrm";break}case 126:{i="yDrS";break}case 127:{s[2]===127?i="rDrm":i="yDrm";break}default:s[0]<48?i="r:":i="M"}i.length<4&&(i+=`${[g,r,s[0],s[2]][d]-o}`.padStart(4-i.length,"0")),c.length<3&&(c+=`${[g,r,g,r][d]}`.padStart(3-c.length,"0")),l==="xg"&&(g===0?s[2]<100?i=i.replace("y0","y:"):s[2]===125&&(i="y126"):g===16?(m=`Voice${((s[2]<<7)+s[1]+1).toString().padStart(3,"0")}`,h=" "):g===35&&r>>1===2&&(m=`DXCH_${(((s[2]&1)<<7)+e+1).toString().padStart(3,"0")}`,h=" "));let u=[s[0],s[1],s[2]];for(;!((m==null?void 0:m.length)>=0);)if(m=(k=t(this,ee)[s[1]||0][(s[0]<<8)+s[2]])==null?void 0:k.name,m){let P=t(this,ee)[s[1]||0][(s[0]<<8)+s[2]];v=(P==null?void 0:P.poly)||v,y=(P==null?void 0:P.type)||y,$=P==null?void 0:P.drum,a=P==null?void 0:P.level}else if(this.strictMode)m="",h="?";else if(s[0]===0&&s[1]===0&&s[2]===0)m="Unloaded";else if(t(this,ee)[s[1]||0][s[0]<<8])s[0]===0?(s[2]=0,h="^"):s[2]<1?(s[0]=0,h="*"):(s[2]--,h="^");else if(g===48)s[0]=0,s[2]=0,h="!";else if(g===62)s[1]--,h=" ",s[1]<1&&!(m!=null&&m.length)&&(s[0]=0,h="!");else if(g<63)s[0]===0?(s[2]=0,h="^"):s[2]<1?(s[0]=0,h="*"):s[2]--;else if(g===80)m=`PrgU:${e.toString().padStart(3,"0")}`,h="!";else if(g===88)m=`CmbU:${e.toString().padStart(3,"0")}`,h="!";else if(g===121)m=`GM2Vox0${r}`,h="#";else if(g===122)if(s[1]===32?s[1]:s[1]%=7,m=(M=t(this,ee)[s[1]||0][(s[0]<<8)+s[2]])==null?void 0:M.name,m){h=" ";let P=t(this,ee)[s[1]||0][(s[0]<<8)+s[2]];v=(P==null?void 0:P.poly)||v,y=(P==null?void 0:P.type)||y,$=P==null?void 0:P.drum,a=P==null?void 0:P.level}else m="",h="*";else s[1]===0?(m=`${g.toString().padStart(3,"0")} ${e.toString().padStart(3,"0")} ${r.toString().padStart(3,"0")}`,h="!"):s[0]===0?(s[2]=0,h="^"):s[2]>0?s[2]--:s[1]>0?(s[1]=0,h="!"):(s[0]=0,h="?");let f=[s[0],s[1],s[2]];switch(h){case"^":{switch(l){case"gs":case"sc":case"ns5r":{h=" ";break}}g===127&&h==="^"&&(h=" ");break}}let b="??";switch(s[0]){case 0:{s[2]===0?b="GM":s[2]===5||s[2]===7?b="KG":s[2]<126&&(b="XG");break}case 32:case 33:case 35:case 36:{s[2]>4?b=["AP","VL","PF","DX","AN"][s[0]-32]:b="GS";break}case 48:{b="MU";break}case 49:{s[2]>>1===63?b="MT":s[2]<5&&(b="GM");break}case 56:{b="AG";break}case 61:case 80:case 83:case 88:case 89:case 91:{b="AI";break}case 62:case 82:case 90:{b="XD";break}case 63:{s[2]<17?b="KR":s[2]<34?b="ES":b="DS";break}case 64:case 126:{b="XG";break}case 67:case 99:{b=s[2]>>4===1?"SD":"DX";break}case 81:{b="RW";break}case 95:{b=["DR","PC"][s[2]];break}case 96:{b=s[2]===106?"AP":s[2]>>4===1?"SD":"PF";break}case 97:{b=s[2]>>4===1?"SD":"VL";break}case 98:{b=s[2]>>4===1?"SD":"SG";break}case 100:{b="AN";break}case 104:case 105:case 106:case 107:{b="SD";break}case 120:{b=e===0?"GM":"GS";break}case 121:{b=s[2]?"G2":"GM";break}case 122:{b="KG";break}case 127:{b=s[2]===127?"MT":e===0?"GM":"XG";break}default:s[0]<48&&(s[0]===16&&l==="xg"?b="XG":b="GS")}if(h!=" ")switch(l){case"krs":case"s90es":case"motif":{m="",b=Zr[l];break}default:self.debugMode&&(m="")}return{name:m||`${Jr[l]||l.toUpperCase()}${Kt(g||0)}${Kt(e||0)}${Kt(r||0)}`,poly:v,type:y,drum:$,level:a,iid:u,eid:f,sid:p,ending:h,sect:i,bank:c,standard:b,mode:l}}async load(g,e,r="(internal)",l){let n=this,p=[],m=0,v=0,y=0;g.split(`
`).forEach(function($,a){var i;let s=$.split("	"),h=[];if(a===0){if(s.forEach(function(c,d){p[Qr.indexOf(c)]=d}),p.length<4){console.debug("Debugger launched.");debugger}}else{let c=0,d=0,o=0,u,f=1,b=0,k,M;s.forEach(function(_,Fe){switch(Fe){case p[0]:{c=parseInt(_);break}case p[1]:{d=parseInt(_);break}case p[2]:{o=parseInt(_);break}case p[3]:{u=_;break}case p[4]:{_=parseInt(_),_<16?f=_+1:(b=(_&15)+1,f=b);break}case p[5]:{M=_;break}case p[6]:{_!=null&&_.constructor&&(k=parseInt(_));break}}}),t(n,ee)[d]=t(n,ee)[d]||[];let P=t(n,ee)[d],O={msb:c,prg:d,lsb:o,name:u,poly:f,type:b,drum:M,level:k,priority:l},z=!1;l<((i=P[c<<8|o])==null?void 0:i.priority)&&(z=!0,y++),(!P[c<<8|o]||z||e)&&(P[c<<8|o]=O,m++),v++}}),e||console.debug(`Map "${r}": ${v} total, ${m} loaded (${m-y} + ${y}).`)}clearRange(g){let e=g.prg!=null?g.prg.constructor===Array?g.prg:[g.prg,g.prg]:[0,127],r=g.msb!=null?g.msb.constructor===Array?g.msb:[g.msb,g.msb]:[0,127],l=g.lsb!=null?g.lsb.constructor===Array?g.lsb:[g.lsb,g.lsb]:[0,127];for(let n=r[0];n<=r[1];n++){let p=n<<8;for(let m=l[0];m<=l[1];m++){let v=p+m;for(let y=e[0];y<=e[1];y++)delete t(this,ee)[y][v]}}}init(){x(this,ee,[]);for(let g=0;g<128;g++)t(this,ee).push([""])}async loadFiles(...g){this.init();let e=this;g.forEach(async function(r,l){try{e.load(await(await fetch(`./data/bank/${r}.tsv`)).text(),!1,r,l)}catch(n){console.error(`Failed loading "${r}.tsv".`)}})}},ee=new WeakMap,or);N();N();var ft,lr,dr=(lr=class{constructor(){T(this,ft,{});R(this,"context")}set(g,e){t(this,ft)[g]=e}has(g){return!!t(this,ft)[g]}async read(g,e){if(!this.has(g))throw new Error(`No decoder registered for "${g}"`);return await t(this,ft)[g].call(this.context||this,e)}},ft=new WeakMap,lr);var jr=function(g,e){let r=!0;return e.forEach((l,n)=>{r=r&&g[n]===l}),r},kt=function(g){let e=0;return g.forEach(r=>{e*=256,e+=r}),e},$e=new TextDecoder,$t=new dr;$t.set("s7e",async function(g){let e=new Uint8Array(await g.slice(0,65536).arrayBuffer()),r="MSB	LSB	PRG	NME",l=[0,0,0,0],n=32,p=0,m=0,v=!0,y=[],$=0;for(;v;){let a=e.subarray(p);([()=>{$e.decode(a.subarray(0,4))==="YSFC"?(p+=80,m=1):p++},()=>{if(jr(a.subarray(0,4),l))y.forEach((s,h,i)=>{let c=kt(e.subarray(s.start+4,s.start+8));s.length=c}),m=2;else{let s=$e.decode(a.subarray(0,4)),h=kt(a.subarray(4,8));y.push({type:s,start:h}),p+=8}},()=>{let s=y[$],h=e.subarray(s.start,s.start+s.length),i=32;switch(s.type){case"ENVC":{let c=n;for(;c<h.length;){let d=h.subarray(c,c+i),o=$e.decode(d.subarray(0,10)).trimEnd();o.slice(0,5)==="Init "&&(o=""),o&&(r+=`
063	${(d[17]+13).toString().padStart(3,"0")}	${d[19].toString().padStart(3,"0")}	${o}`),c+=i}break}case"EDVC":{let c=n;for(;c<h.length;){let d=h.subarray(c,c+i),o=$e.decode(d.subarray(0,10)).trimEnd();o.slice(0,5)==="Init "&&(o=""),o&&(r+=`
063	024	${d[19].toString().padStart(3,"0")}	${o}`),c+=i}break}case"EPVC":{let c=32,d=n;for(;d<h.length;){let o=h.subarray(d,d+c),u=$e.decode(o.subarray(0,10)).trimEnd();u==="----------"&&(u=""),u&&(r+=`
063	${(o[17]+1).toString().padStart(3,"0")}	${o[19].toString().padStart(3,"0")}	${u}`),d+=c}break}}$++,$>=y.length&&(m=3,v=!1)}][m]||(()=>{v=!1}))()}return r});$t.set("pcg",async function(g){let e=new Uint8Array(await g.arrayBuffer()),r="MSB	LSB	PRG	NME",l=100,n=0,p=0,m=!0,v=[],y=0;for(;m;){let $=e.subarray(l);([()=>{m=$e.decode($.subarray(0,4))==="INI2",p=$[15],l+=16,n=1},()=>{let a=$e.decode($.subarray(0,4)),s=$[5],h=$[7],i=$[11],c=kt($.subarray(12,16)),d=kt($.subarray(16,20)),o=kt($.subarray(36,40)),u=$e.decode($.subarray(44,44+i));v.push({type:a,tipMsb:s,tipLsb:h,nameLen:i,length:c,start:d,entryLen:o,name:u}),l+=64,p--,p<1&&(n=2)},()=>{let a=v[y],s=e.subarray(a.start,a.start+a.length);switch(a.type){case"PRG1":break;case"PBK1":{let h=63,i=(a.tipMsb?6:0)+a.tipLsb;for(let c=0;c<128;c++){let d=c*a.entryLen,o=s.subarray(d,d+a.entryLen),u=$e.decode(o.subarray(0,24)).trimEnd().replace("InitProg","");u.length&&i>5&&(r+=`
${h.toString().padStart(3,"0")}	${i.toString().padStart(3,"0")}	${c.toString().padStart(3,"0")}	${u}`)}break}case"CBK1":{let h=63,i=(a.tipMsb?3:0)+a.tipLsb+10;for(let c=0;c<128;c++){let d=c*a.entryLen,o=s.subarray(d,d+a.entryLen),u=$e.decode(o.subarray(0,24)).trimEnd().replace("InitCombi","");u.length&&i>12&&(r+=`
${h.toString().padStart(3,"0")}	${i.toString().padStart(3,"0")}	${c.toString().padStart(3,"0")}	${u}`)}break}}y++,y>=v.length&&(n=3,m=!1)}][n]||(()=>{m=!1}))()}return r});N();var xt=["off","hall","room","stage","plate","delay LCR","delay LR","echo","cross delay","early reflections","gate reverb","reverse gate"].concat(new Array(4),["white room","tunnel","canyon","basement","karaoke"],new Array(43),["pass through","chorus","celeste","flanger","symphonic","rotary speaker","tremelo","auto pan","phaser","distortion","overdrive","amplifier","3-band EQ","2-band EQ","auto wah"],new Array(1),["pitch change","harmonic","touch wah","compressor","noise gate","voice channel","2-way rotary speaker","ensemble detune","ambience"],new Array(4),["talking mod","Lo-Fi","dist + delay","comp + dist + delay","wah + dist + delay","V dist","dual rotor speaker"]),St=["melodic","drums","drum set 1","drum set 2","drum set 3","drum set 4","drum set 5","drum set 6","drum set 7","drum set 8"],ea=[17.1,18.6,20.2,21.8,23.3,24.9,26.5,28,29.6,31.2,32.8,34.3,35.9,37.5,39,40.6,42.2,43.7,45.3,46.9,48.4,50],ut=[20,22,25,28,32,36,40,45,50,56,63,70,80,90,100,110,125,140,160,180,200,225,250,280,315,355,400,450,500,560,630,700,800,900,1e3,1100,1200,1400,1600,1800,2e3,2200,2500,2800,3200,3600,4e3,4500,5e3,5600,6300,7e3,8e3,9e3,1e4,11e3,12e3,14e3,16e3,18e3,2e4],hr=[0,.04,.08,.13,.17,.21,.25,.29,.34,.38,.42,.46,.51,.55,.59,.63,.67,.72,.76,.8,.84,.88,.93,.97,1.01,1.05,1.09,1.14,1.18,1.22,1.26,1.3,1.35,1.39,1.43,1.47,1.51,1.56,1.6,1.64,1.68,1.72,1.77,1.81,1.85,1.89,1.94,1.98,2.02,2.06,2.1,2.15,2.19,2.23,2.27,2.31,2.36,2.4,2.44,2.48,2.52,2.57,2.61,2.65,2.69,2.78,2.86,2.94,3.03,3.11,3.2,3.28,3.37,3.45,3.53,3.62,3.7,3.87,4.04,4.21,4,37,4.54,4.71,4.88,5.05,5.22,5.38,5.55,5.72,6.06,6.39,6.73,7.07,7.4,7.74,8.08,8.41,8.75,9.08,9.42,9.76,10.1,10.8,11.4,12.1,12.8,13.5,14.1,14.8,15.5,16.2,16.8,17.5,18.2,19.5,20.9,22.2,23.6,24.9,26.2,27.6,28.9,30.3,31.6,33,34.3,37,39.7],fr=function(g){let e=.1,r=-.3;return g>66?(e=5,r=315):g>56?(e=1,r=47):g>46&&(e=.5,r=18.5),e*g-r},ur=function(g){return g>105?ea[g-106]:g>100?g*1.1-100:g/10},pr=",a,i,u,e,o,ka,ki,ku,ke,ko,ky,kw,sa,si,su,se,so,sh,ta,ti,tu,te,to,t,ch,t,s,na,ni,nu,ne,no,ny,nn,ha,hi,hu,he,ho,hy,fa,fi,fu,fe,fo,ma,mi,mu,me,mo,my,mm,ya,yu,ye,yo,ra,ri,ru,re,ro,ry,wa,wi,we,wo,ga,gi,gu,ge,go,gy,gw,za,zi,zu,ze,zo,ja,ji,ju,je,jo,jy,da,di,du,de,do,dy,ba,bi,bu,be,bo,by,va,vi,vu,ve,vo,pa,pi,pu,pe,po,py,nga,ngi,ngu,nge,ngo,ngy,ng,hha,hhi,hhu,hhe,hho,hhy,hhw,*,_,,,~,.".split(","),zt={};`hi*,
ka,ã‹
ki,ã
ku,ã
ke,ã‘
ko,ã“
ky,ã!
kw,ãl
tsu,ã¤
ts,ã¤l
sa,ã•
si,ã™ãƒ
su,ã™
se,ã›
so,ã
shi,ã—
sh,ã—!
ta,ãŸ
ti,ã¦ãƒ
tu,ã¨ã…
te,ã¦
to,ã¨
tchy,ã¡!
tchi,ã¡
na,ãª
ni,ã«
nu,ã¬
ne,ã­
no,ã®
ny,ã«!
nn,ã‚“
ha,ã¯
hi,ã²
hu,ã»ã…
he,ã¸
ho,ã»
hy,ã²!
fa,ãµã
fi,ãµãƒ
fu,ãµ
fe,ãµã‡
fo,ãµã‰
ma,ã¾
mi,ã¿
mu,ã‚€
me,ã‚
mo,ã‚‚
my,ã¿!
mm,ã‡º
ra,ã‚‰
ri,ã‚Š
ru,ã‚‹
re,ã‚Œ
ro,ã‚
ry,ã‚Š!
wa,ã‚
wi,ã‚
we,ã‚‘
wo,ã‚’
nga,ã‹ã‚š
ngi,ãã‚š
ngu,ãã‚š
nge,ã‘ã‚š
ngo,ã“ã‚š
ngy,ãã‚š!
ng,ãƒ³
ga,ãŒ
gi,ãŽ
gu,ã
ge,ã’
go,ã”
gy,ãŽ!
gw,ãl
za,ã–
zi,ãšãƒ
zu,ãš
ze,ãœ
zo,ãž
ja,ã˜ã‚ƒ
ji,ã˜
ju,ã˜ã‚…
je,ã˜ã‡
jo,ã˜ã‚‡
jy,ã˜!
da,ã 
di,ã§ãƒ
du,ã©ã…
de,ã§
do,ã©
dy,ã§!
ba,ã°
bi,ã³
bu,ã¶
be,ã¹
bo,ã¼
by,ã³!
va,ã‚”ã
vi,ã‚”ãƒ
vu,ã‚”
ve,ã‚”ã‡
vo,ã‚”ã‰
pa,ã±
pi,ã´
pu,ã·
pe,ãƒš
po,ã½
py,ã´!
!ya,ã‚ƒ
!yu,ã‚…
!ye,ã‡
!yo,ã‚‡
ya,ã‚„
yu,ã‚†
ye,ð›€
yo,ã‚ˆ
!a,ã‚ƒ
!u,ã‚…
!e,ã‡
!o,ã‚‡
!a,ã‚ƒ
!u,ã‚…
!e,ã‡
!o,ã‚‡
la,ã
li,ãƒ
lu,ã…
le,ã‡
lo,ã‰
a,ã‚
i,ã„
u,ã†
e,ãˆ
o,ãŠ
*,ã£
~,
^,
_,`.split(`
`).forEach(g=>{let e=g.split(",");zt[e[0]]=e[1]});var gr=function(g){let e=g;g[0]=="*"&&(e=e.slice(1)),["aa","ii","uu","ee","oo"].forEach(l=>{for(;e.indexOf(l)>-1;)e=e.replace(l,l[0])});for(let l in zt)e=e.replaceAll(l,zt[l]);e.indexOf("ã‚“")==0&&e.length>1&&(e=e.slice(1));let r=e.indexOf("!");return r>-1&&e.length>1&&(e=e.slice(r+1)),e},br=function(g){return g?g<96?`cc${g}`:["aftertouch","velocity","pitch bend"][g-96]:"off"},mr={u8:["utf-8","Unicode"],l1:["l9","Pan-Latin"],jp:["sjis","Japanese"],kr:["iso-2022-kr","Korean"],hz:["gb18030","Simplified Chinese"],b5:["big5","Traditional Chinese"],cy:["koi8-ru","Cyrillic"],vn:["tcvn-5773-1993","Vietnamese"]},Er={m:"Male",f:"Female",c:"Chorus",s:"Solo",p:"Plural",w:"Words",x:"Non-vocal"};N();var qt=["room 1","room 2","room 3","hall 1","hall 2","plate","delay","panning delay"],yr=["chorus 1","chorus 2","chorus 3","chorus 4","feedback","flanger","short delay","short delay feedback"],vr=["delay 1","delay 2","delay 3","delay 4","pan delay 1","pan delay 2","pan delay 3","pan delay 4","delay to reverb","pan repeat"];var ta={0:"thru",256:"stereo EQ",257:"spectrum",258:"enhancer",259:"humanizer",272:"overdrive",273:"distortion",288:"phaser",289:"auto wah",290:"rotary",291:"stereo flanger",292:"step flanger",293:"tremelo",294:"auto pan",304:"compressor",305:"limiter",320:"hexa chorus",321:"tremelo chorus",322:"stereo chorus",323:"space D",324:"3D chorus",336:"stereo delay",337:"modulated delay",338:"3-tap delay",339:"4-tap delay",340:"tremelo control delay",341:"reverb",342:"gate reverb",343:"3D delay",352:"2-pitch shifter",353:"feedback pitch shifter",368:"3D auto",369:"3D manual",370:"Lo-Fi 1",371:"Lo-Fi 2",512:"overdrive - chorus",513:"overdrive - flanger",514:"overdrive - delay",515:"distortion - chorus",516:"distortion - flanger",517:"distortion - delay",518:"enhancer - chorus",519:"enhancer - flanger",520:"enhancer - delay",521:"chorus - delay",522:"flanger - delay",523:"chorus - flanger",524:"rotary multi",1024:"guitar multi 1",1025:"guitar multi 2",1026:"guitar multi 3",1027:"clean guitar multi 1",1028:"clean guitar multi 2",1029:"bass multi",1030:"rhodes multi",1280:"keyboard multi",4352:"chorus / delay",4353:"flanger / delay",4354:"chorus / flanger",4355:"overdrive / distortion",4356:"overdrive / rotary",4357:"overdrive / phaser",4358:"overdrive / auto wah",4359:"phaser / rotary",4360:"phaser / auto wah"},ra={66307:["drive"],66309:["vowel",g=>"aiueo"[g]],94723:["pre-filter"],94724:["Lo-Fi type"],94725:["post-filter"],94979:["Lo-Fi type"],94980:["fill type",g=>["off","LPF","HPF"][g]],94984:["noise type",g=>["white","pink"][g]],94987:["disc type",g=>["LP","SP","EP","RND"]],94990:["hum type",g=>`${g+5}0Hz`],94993:["M/S",g=>["mono","stereo"][g]]},Wt=function(g){return ta[(g[0]-32<<8)+g[1]]||`0x${g[0].toString(16).padStart(2,"0")}${g[1].toString(16).padStart(2,"0")}`},Cr=function(g,e,r){let l=(g[0]-32<<16)+(g[1]<<8)+e,n=ra[l]||{},p=n[0];if(p!=null&&p.length)return p+=`: ${(n[1]||function(){})(r)||r}`,p},Yt=[68,48,95,78,41,3,110,122,0];N();var oe=function(g=64){return Math.round(2e3*Math.log10(g/64))/100},wr=function(g,e,r){let l=[],n=r==!1?e.readIntVLV():r;g==0||g==127;for(let p=0;p<n;p++){let m=e.readInt(1);if(l.push(m),m!=247){if(m!=240){if(m>127)return console.debug(`Early termination: ${l}`),l.pop(),e.backOne(),e.backOne(),new Uint8Array(l)}}}return new Uint8Array(l)},Ie=function(g){let e=0;return g.forEach(r=>{e+=r,e=e&127}),~e+1&127},Ee=function(g,e){let r=0,l=0;for(let n=0;n<g.length;n++){let p=n%8-1,m=(l>>p&1)<<7,v=g[n];v+=m,n%8!=0?(e(v,r,g),r++):l=g[n]}};var Tt=function(g){let e=Math.floor(g*14.2);return e<128?e:0},L=function(){var g;return self.Bun?!0:(g=self.debugMode)!=null?g:!1};var W=["?","gm","gs","sc","xg","g2","mt32","doc","qy10","qy20","ns5r","x5d","05rw","k11","sg","sd","pa","krs","s90es","motif","trin"],aa={gm2:"g2","mt-32":"mt32","c/m":"mt32",ag10:"05rw","ag-10":"05rw","05r/w":"05rw",x5:"05rw",x5dr:"x5d",gmega:"k11","kross 2":"krs","motif es":"motif","s90 es":"s90es",trinity:"trin","tr-rack":"trin"},sa=["melodic","drum","menu"],kr={"?":[0,0,120,0,0],gm:[0,0,120,0,0],gs:[0,0,120,0,0],sc:[0,0,120,0,0],xg:[0,0,127,0,0],g2:[0,0,120,0,0],mt32:[0,127,127,0,127],doc:[57,112,127,57,112],qy10:[57,113,127,57,113],qy20:[57,114,127,57,114],ns5r:[0,0,61,0,0],x5d:[82,0,62,56,0],"05rw":[81,0,62,56,0],k11:[0,0,122,0,0],sg:[0,0,122,0,0],sd:[97,0,105,0,0],krs:[121,0,120,0,0],s90es:[0,0,127,0,0],motif:[0,0,127,0,0],trin:[0,0,127,0,0]},ia=[9,25,41,57,73,89,105,121],na=[0,3,81,84,88],$r={8:"Off",9:"On",10:"Note aftertouch",11:"cc",12:"pc",13:"Channel aftertouch",14:"Pitch"},xr={0:0,1:1,2:3,5:4},Sr={0:0,1:1,2:2,5:3},Tr=[[0,24],[0,127],[0,127],[40,88],[0,127],[0,127]],Zt=[36,37,48,49,52,53],Xt=[20,21,22,23,24,25,26,28,29,30,31,36,37,48,49,52,53,64,65],Mr={26:127,29:0,30:0,31:0,52:12,53:54},pt=[0,1,2,4,5,6,7,8,10,11,12,13,14,15,16,17,18,19,20,21,22,26,28,32,38,40,41,42,43,44,45,46,47,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,80,81,82,83,84,91,92,93,94,95,98,99,100,101,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157],ca=[2,4,12,13,14,15,16,17,18,19,20,21,40,41,42,43,44,45,46,47,80,81,83,136,130,131,132,133,134,135,137,138,139,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157],oa=[33,102,99,32,100,8,9,10],Pr=[0,16,25,40,32,64,24,48],S={};W.forEach((g,e)=>{S[g]=e});var w=[];pt.forEach((g,e)=>{w[g]=e});var ge={length:Xt.length};Xt.forEach((g,e)=>{ge[g]=e});var la={};sa.forEach((g,e)=>{la[g]=e});var da=function(g){let e=[],r=0;return g==null||g.forEach(function(l,n){l===247?e.push(g.subarray(r,n)):l===240&&(r=n+1)}),e.length||e.push(g.subarray(0)),L()&&console.debug(e),e};var Qt=8,E={port:Qt,ch:Qt<<4,chShift:Math.ceil(Math.log2(Qt))+4,cc:pt.length,nn:128,pl:512,tr:256,cmt:14,rpn:6,rpnt:4,nrpn:Zt.length,ace:8,drm:8,dpn:Xt.length,dnc:128,ext:3,efx:7,cvn:12,redir:32,vxPrim:3,invalidCh:255};E.chcc=E.cc*E.ch;var ke={bank0:128},H=new Uint16Array(E.ch),Nt=new Uint16Array(E.ch),ha=new Uint16Array(E.ch),fa=new Uint16Array(E.ch),Dr=new Uint16Array(E.ch),Rr=new Array(E.drm);for(let g=0;g<E.ch;g++)H[g]=g*E.cc,Nt[g]=g*E.rpn,ha[g]=g*E.nrpn,fa[g]=g*E.ace,Dr[g]=g*E.ext;for(let g=0;g<E.drm;g++){Rr[g]=new Uint16Array(E.dpn);let e=g*E.dpn*E.dnc;for(let r=0;r<E.dpn;r++)Rr[g][r]=e+r*E.dnc}var G,te,ye,Ae,pe,Re,Or,le,Z,A,C,re,I,J,ie,q,K,De,xe,ze,de,D,U,gt,ne,ve,he,bt,qe,Y,mt,We,Ce,Mt,Be,we,Et,Ue,Q,B,Se,Pt,F,Ye,yt,Qe,Ze,_t,Je,Ne,_e,Rt,vt,Te,X,Ht,At,je,fe,Oe,He,ae,et,j,Dt,Gt,tt,rt,ue,be,Me,at,st,it,Ar,es=(Ar=class extends Ut{constructor(){super();T(this,pe);R(this,"NOTE_IDLE",0);R(this,"NOTE_ATTACK",1);R(this,"NOTE_DECAY",2);R(this,"NOTE_SUSTAIN",3);R(this,"NOTE_HELD",4);R(this,"NOTE_RELEASE",5);R(this,"NOTE_SOSTENUTO_ATTACK",8);R(this,"NOTE_SOSTENUTO_DECAY",9);R(this,"NOTE_SOSTENUTO_SUSTAIN",10);R(this,"NOTE_SOSTENUTO_HELD",11);R(this,"NOTE_MUTED_RECOVERABLE",16);R(this,"CH_MELODIC",0);R(this,"CH_DRUMS",1);R(this,"CH_DRUM1",2);R(this,"CH_DRUM2",3);R(this,"CH_DRUM3",4);R(this,"CH_DRUM4",5);R(this,"CH_DRUM5",6);R(this,"CH_DRUM6",7);R(this,"CH_DRUM7",8);R(this,"CH_DRUM8",9);R(this,"DUMP_ALL",0);R(this,"DUMP_ONCE",1);R(this,"DUMP_MODE",2);R(this,"EXT_NONE",0);R(this,"EXT_VL",1);R(this,"EXT_DX",3);R(this,"VLBC_SYSTEM",0);R(this,"VLBC_BRTHEXPR",1);R(this,"VLBC_VELOINIT",2);R(this,"VLBC_VELOALL",3);R(this,"CH_INACTIVE",0);R(this,"CH_ACTIVE",1);R(this,"CH_DISABLED",2);R(this,"KARAOKE_NONE",0);R(this,"KARAOKE_TEXT",1);R(this,"KARAOKE_XF",2);T(this,G,0);T(this,te,0);T(this,ye,0);T(this,Ae,new Array(11));T(this,le,new Uint8Array(E.ch));T(this,Z,new Uint8Array(E.ch));T(this,A,new Uint8Array(E.ch));T(this,C,new Uint8Array(E.chcc<<1));T(this,re,new Uint8Array(E.ch*E.ace));T(this,I,new Uint8Array(E.ch*E.vxPrim));T(this,J,new Uint8Array(E.ch*E.nn));T(this,ie,new Uint8Array(E.ch));T(this,q,new Uint16Array(E.pl));T(this,K,new Uint8Array(E.pl));T(this,De,new Int16Array(E.ch));T(this,xe,new Uint8Array(E.ch));T(this,ze,new Uint8Array(E.ch));T(this,de,new Uint8Array(E.ch*E.ext));T(this,D,new Uint8Array(E.ch*E.rpn));T(this,U,new Uint8Array(E.ch*E.rpnt));T(this,gt,new Int8Array(E.ch*Zt.length));T(this,ne,new Uint8Array(E.drm*E.dpn*E.dnc));T(this,ve,new Uint8Array(E.drm*2));T(this,he,new Uint8Array(E.efx*3));T(this,bt,new Uint8Array(E.ch));T(this,qe,new Uint8Array(E.ch*E.redir));T(this,Y,new Uint8Array(E.port));T(this,mt,new Uint8Array(E.port));T(this,We,new Uint8Array(E.ch));T(this,Ce,new Uint8Array(E.ch));T(this,Mt,new Uint8Array(E.ch*E.cvn));T(this,Be,new Uint8Array(128));T(this,we,new Uint8Array(E.cmt*8));T(this,Et,new Uint8Array(1024));T(this,Ue,new Uint8Array(E.cmt*64));T(this,Q,{});R(this,"modelEx",{sc:{showBar:!0,invBar:!1,invDisp:!1,peakHold:1}});T(this,B,void 0);T(this,Se,void 0);T(this,Pt,void 0);T(this,F,100);T(this,Ye,0);T(this,yt,500);T(this,Qe,0);T(this,Ze,0);T(this,_t,32);T(this,Je,!1);T(this,Ne,"");T(this,_e,0);T(this,Rt,0);T(this,vt,0);T(this,Te,!0);T(this,X,0);T(this,Ht,1);T(this,At,void 0);T(this,je,new Array(E.ch));T(this,fe,[]);T(this,Oe,new Uint8Array(E.ch));T(this,He,new Uint8Array(E.tr));R(this,"baseBank",new Ft("gm2","ns5r","xg","gs","sd","gmega","plg-vl","plg-pf","plg-dx","plg-an","plg-dr","plg-sg","kross","s90es"));R(this,"userBank",new Ft("gm2"));R(this,"initOnReset",!1);R(this,"aiEfxName","");R(this,"polyIndexShrink",!0);R(this,"polyIndexLatest",0);R(this,"polyIndexLast",0);T(this,ae,[]);T(this,et,void 0);T(this,j,{nOff:(e,r)=>{let l=e*128+r,n=t(this,q).lastIndexOf(l);if(n>-1)if(this.getChCc(e,64)>>6)t(this,K)[n]=this.NOTE_HELD,this.dispatchEvent("note",{part:e,note:r,velo:t(this,J)[l],state:this.NOTE_HELD});else if(this.getChCc(e,66)>>6&&t(this,K)[n]===this.NOTE_SOSTENUTO_SUSTAIN)t(this,K)[n]=this.NOTE_SOSTENUTO_HELD,this.dispatchEvent("note",{part:e,note:r,velo:t(this,J)[l],state:this.NOTE_SOSTENUTO_HELD});else{t(this,q)[n]=0,t(this,J)[l]=0,t(this,K)[n]=this.NOTE_IDLE;let p=this.getExt(e)[1];(p===this.VLBC_VELOINIT||p===this.VLBC_VELOALL)&&this.setChCc(e,129,0),this.dispatchEvent("note",{part:e,note:r,velo:0,state:this.NOTE_IDLE})}if(t(this,ie)[e]){for(let p=this.polyIndexLast;p>=0;p--)if(t(this,q)[p]>>7===e&&t(this,K)[p]!==0){t(this,K)[p]===this.NOTE_MUTED_RECOVERABLE&&(t(this,K)[p]=this.NOTE_SUSTAIN);break}}this.polyIndexShrink&&this.polyIndexLast>0&&t(this,K)[this.polyIndexLast]===0&&this.polyIndexLast--},nOn:(e,r,l)=>{let n=e*128+r,p=0;if(t(this,ie)[e])for(let m=0;m<=this.polyIndexLast;m++)t(this,q)[m]>>7===e&&t(this,K)[m]!==0&&(t(this,K)[m]=this.NOTE_MUTED_RECOVERABLE);for(;t(this,K)[p]>0&&t(this,q)[p]!=n;)p++;if(p<E.pl){t(this,q)[p]=n,t(this,J)[n]=l,t(this,K)[p]=this.NOTE_SUSTAIN,t(this,xe)[e]<l&&(t(this,xe)[e]=l);let m=this.getExt(e)[1];(m===this.VLBC_VELOINIT||m===this.VLBC_VELOALL)&&this.setChCc(e,129,l),this.dispatchEvent("note",{part:e,note:r,velo:l,state:this.NOTE_SUSTAIN}),this.polyIndexLatest=p+1,p>this.polyIndexLast&&(this.polyIndexLast=p)}else console.error("Polyphony exceeded.")},nAt:(e,r,l)=>{},cAt:(e,r)=>{},hoOf:e=>{t(this,K).forEach((r,l)=>{if(r===this.NOTE_HELD){let n=t(this,q)[l],p=n>>7;e===p&&(t(this,K)[l]=this.NOTE_IDLE,t(this,q)[l]=0,t(this,J)[n]=0,this.dispatchEvent("note",{part:e,note:n&127,velo:0,state:this.NOTE_IDLE}))}})},soOn:e=>{t(this,K).forEach((r,l)=>{let n;switch(r){case this.NOTE_ATTACK:{n=this.NOTE_SOSTENUTO_ATTACK;break}case this.NOTE_DECAY:{n=this.NOTE_SOSTENUTO_DECAY;break}case this.NOTE_SUSTAIN:{n=this.NOTE_SOSTENUTO_SUSTAIN;break}}if(n){t(this,K)[l]=n;let p=t(this,q)[l];this.dispatchEvent("note",{part:e,note:p&127,velo:t(this,J)[p],state:n})}})},soOf:e=>{t(this,K).forEach((r,l)=>{if(r===this.NOTE_SOSTENUTO_HELD){let n=t(this,q)[l],p=n>>7;e===p&&(t(this,K)[l]=this.NOTE_IDLE,t(this,q)[l]=0,t(this,J)[n]=0,this.dispatchEvent("note",{part:e,note:n&127,velo:0,state:this.NOTE_IDLE}))}})},ano:e=>{t(this,q).forEach(r=>{let l=r>>7,n=r&127;r===0&&t(this,J)[0]===0||l===e&&t(this,j).nOff(l,n)})}});T(this,Dt,{8:function(e){let r=e.channel,l=e.data[0];t(this,j).nOff(r,l)},9:function(e){let r=e.channel,l=this;if(l.getChModeId(r)===S.xg&&t(l,A)[r]>1){let m=l.getChDrumFirstWrite(r);m[0]&&m[1]!=E.invalidCh&&!t(l,le)[r]&&(l.copyChSetup(m[1],r),l.dispatchEvent("voice",{part:r}),console.debug(`Part CH${r+1} copied from CH${m[1]+1}.`))}l.setChActive(r,1);let n=e.data[0],p=e.data[1];p>0?t(l,j).nOn(r,n,p):t(l,j).nOff(r,n)},10:function(e){let r=e.channel,l=r*128+e.data[0];t(this,q).indexOf(l)>-1&&(t(this,J)[l]=data[1],this.getExt(r)[1]===this.VLBC_VELOALL&&this.setChCc(r,129,data[1]),this.dispatchEvent("note",{part:r,note:e.data[0],velo:e.data[1],state:this.NOTE_SUSTAIN}))},11:function(e){let r=e.channel,l=this,n=t(l,je)[r],p=n[e.data[0]];p&&(e.data[0]=p),[0,32].indexOf(e.data[0])>-1&&(()=>{switch(t(this,G)){case S.s90es:case S.motif:{if(e.data[0]===0){[0,63].indexOf(e.data[1])>-1&&l.setChActive(r,1);break}e.data[1]&&l.setChActive(r,1);break}default:break}})();let m=r*E.ext,v=l.getChModeId(r);switch(e.data[0]){case 96:return;case 97:return;case 120:return;case 121:{t(this,j).ano(r),t(this,De)[r]=0,l.resetChCc(r,1,0),l.resetChCc(r,5,0),l.resetChCc(r,64,0),l.resetChCc(r,65,0),l.resetChCc(r,66,0),l.resetChCc(r,67,0),l.resetChCc(r,11,127),l.resetChCc(r,101,127),l.resetChCc(r,100,127),l.resetChCc(r,99,127),l.resetChCc(r,98,127);return}case 123:{t(this,j).ano(r);return}case 124:{t(this,j).ano(r);return}case 125:{t(this,j).ano(r);return}case 126:{t(this,ie)[r]=1,t(this,j).ano(r);return}case 127:{t(this,ie)[r]=0,t(this,j).ano(r);return}}if(w[e.data[0]]===void 0)console.warn(`cc${e.data[0]} is not accepted.`);else{switch(ca.indexOf(e.data[0])>-1&&this.allocateAce(r,e.data[0]),e.data[0]){case 0:{switch(L()&&console.debug(`${W[t(this,G)]}, CH${r+1}: ${e.data[1]}`),t(this,G)===0?e.data[1]<48?(t(this,A)[r]>0&&(e.data[1]=this.getChPrimitive(r,1,!1),e.data[1]=120,console.debug(`Forced channel ${r+1} to stay drums.`)),e.data[1]>0&&(console.debug(`Roland GS detected with MSB: ${e.data[1]}`),this.switchMode("gs"))):e.data[1]===56?this.switchMode(t(this,B).x5===82?"x5d":"05rw"):e.data[1]===62?this.switchMode(t(this,B).x5===82?"x5d":"05rw"):e.data[1]===63?this.switchMode(W[t(this,B).ds]):(e.data[1]===64||e.data[1]===127)&&this.switchMode("xg"):t(this,G)===S.gs||t(this,G)===S.sc?e.data[1]<56&&t(this,A)[r]>0&&(e.data[1]=this.getChPrimitive(r,1,!1),e.data[1]=120,console.debug(`Forced channel ${r+1} to stay drums.`)):t(this,G)===S.gm&&(e.data[1]<48?t(this,A)[r]>0&&(e.data[1]=120,this.switchMode("gs",!0),console.debug(`Forced channel ${r+1} to stay drums.`)):(e.data[1]===64||e.data[1]===127)&&this.switchMode("xg",!0)),t(this,G)){case S.xg:{[79,95,126,127].indexOf(e.data[1])>-1?t(this,A)[r]===0&&(this.setChType(r,this.CH_DRUM2),console.debug(`CH${r+1} set to drums by MSB.`)):t(this,A)[r]>0&&(this.setChType(r,this.CH_MELODIC),console.debug(`CH${r+1} set to melodic by MSB.`)),[33,81,97].indexOf(e.data[1])>-1?t(this,de)[m]=this.EXT_VL:[35,67,83,99].indexOf(e.data[1])>-1?t(this,de)[m]=this.EXT_DX:t(this,de)[m]=this.EXT_NONE;break}case S["05rw"]:case S.x5d:case S.ns5r:{[61,62,126,127].indexOf(e.data[1])>-1?t(this,A)[r]===this.CH_MELODIC&&(this.setChType(r,this.CH_DRUM2),console.debug(`CH${r+1} set to drums by MSB.`)):[80,81,82,83].indexOf(e.data[1])>-1||t(this,A)[r]!=this.CH_MELODIC&&(this.setChType(r,this.CH_MELODIC),console.debug(`CH${r+1} set to melodic by MSB.`));break}case S.sd:{[104,105,106,107].indexOf(e.data[1])>-1?t(this,A)[r]===0&&(this.setChType(r,this.CH_DRUM2),console.debug(`CH${r+1} set to drums by MSB.`)):t(this,A)[r]>0&&(this.setChType(r,this.CH_MELODIC),console.debug(`CH${r+1} set to melodic by MSB.`));break}case S.g2:{e.data[1]===120?t(this,A)[r]===0&&(this.setChType(r,this.CH_DRUMS),console.debug(`CH${r+1} set to drums by MSB.`)):t(this,A)[r]>0&&(this.setChType(r,this.CH_MELODIC),console.debug(`CH${r+1} set to melodic by MSB.`));break}}break}case 2:{this.getExt(r)[1]===this.VLBC_BRTHEXPR&&this.setChCc(r,129,e.data[1]);break}case 6:{if(t(this,ze)[r]){[S.xg,S.gs,S.sc,S.ns5r].indexOf(t(this,G))<0&&console.warn(`NRPN commits are not available under "${W[t(this,G)]}" mode, even when they are supported in Octavia.`);let y=this.getChCc(r,99),$=this.getChCc(r,98);if(y===1){let a=oa.indexOf($);if(a>-1)this.setChCc(r,71+a,e.data[1]),L()&&console.debug(`Redirected NRPN 1 ${$} to cc${71+a}.`),this.dispatchEvent("cc",{part:r,cc:71+a,data:e.data[1]});else{let s=Zt.indexOf($);s>-1?t(this,gt)[r*10+s]=e.data[1]-64:console.warn(`NRPN 0x01${$.toString(16).padStart(2,"0")} is not supported.`),L()&&console.debug(`CH${r+1} voice NRPN ${$} commit`)}}else{if(Xt.indexOf(y)<0){let s=`NRPN 0x${y.toString(16).padStart(2,"0")}${$.toString(16).padStart(2,"0")} `;console.warn(y===127?`${s}is not necessary. Consider removing it.`:`${s}is not supported.`)}else{let s=t(this,A)[r]-2;s<0?console.warn(`CH${r+1} cannot accept drum NRPN as type ${St[t(this,A)[r]]}.`):t(this,ne)[(s*E.dpn+ge[y])*E.dnc+$]=e.data[1]}L()&&console.debug(`CH${r+1} (${St[t(this,A)[r]]}) drum NRPN ${y} commit`)}}else{let y=xr[this.getChCc(r,100)],$=Sr[this.getChCc(r,100)];if(this.getChCc(r,101)===0&&y!=null)switch(L()&&console.debug(`CH${r+1} RPN 0 ${this.getChCc(r,100)} commit: ${e.data[1]}`),e.data[1]=Math.min(Math.max(e.data[1],Tr[y][0]),Tr[y][1]),t(this,D)[r*E.rpn+y]=e.data[1],t(this,U)[r*E.rpnt+$]=1,v){case S.xg:case S.gs:case S.sc:case S.mt32:case S.s90es:case S.motif:{switch(this.getChCc(r,100)){case 1:case 2:{this.dispatchEvent("pitch",{part:r,pitch:this.getPitchShift(r)});break}}break}default:this.dispatchEvent("pitch",{part:r,pitch:this.getPitchShift(r)})}}break}case 32:{switch(L()&&console.debug(`${W[t(this,G)]}, CH${r+1} LSB: ${e.data[1]}`),t(this,G)){case S.s90es:case S.motif:{this.setChType(r,[32,40].indexOf(e.data[1])>-1?this.CH_DRUMS:this.CH_MELODIC,t(this,G),!0);break}}this.getExt(r)[0],this.EXT_DX;break}case 38:{if(!t(this,ze)[r]){let y=xr[this.getChCc(r,100)],$=Sr[this.getChCc(r,100)];this.getChCc(r,101)===0&&y!=null&&(t(this,D)[r*E.rpn+y+1]=e.data[1],t(this,U)[r*E.rpnt+$]=1)}break}case 64:{e.data[1]<64&&t(this,j).hoOf(r);break}case 66:{e.data[1]>>6?t(this,j).soOn(r):t(this,j).soOf(r);break}case 98:case 99:{t(this,ze)[r]=1;break}case 100:case 101:{t(this,ze)[r]=0;break}}this.setChCc(r,e.data[0],e.data[1]),this.dispatchEvent("cc",{part:r,cc:e.data[0],data:e.data[1]})}l.getChModeId(r)===S.xg&&t(l,A)[r]&&l.setDrumFirstWrite(r)},12:function(e){let r=e.channel,l=this;switch(t(l,G)){case S.s90es:case S.motif:{e.data&&l.setChActive(r,1);break}default:l.setChActive(r,1)}let n=H[r];switch(l.getExt(r)[0]){case l.EXT_VL:break}t(l,I)[r]=e.data,t(l,Ce)[r]=0,l.pushChPrimitives(r),L()&&console.debug(`T:${e.track} C:${r} P:${e.data}`),l.dispatchEvent("voice",{part:r}),l.getChModeId(r)===S.xg&&t(l,A)[r]&&l.setDrumFirstWrite(r)},13:function(e){let r=this,l=e.channel;t(this,q).forEach(function(n){let p=n>>7;l===p&&(t(r,J)[n]=e.data,r.dispatchEvent("note",{part:l,note:n&127,velo:e.data,state:r.NOTE_SUSTAIN}))})},14:function(e){let r=e.channel;t(this,De)[r]=e.data[1]*128+e.data[0]-8192,this.dispatchEvent("pitch",{part:r,pitch:this.getPitchShift(r)})},15:function(e){da(e.data).forEach(r=>{let l=r[0],n=r[1];(t(this,Gt)[l]||function(){console.debug(`Unknown manufacturer ${l}.`)})(n,r.subarray(2),e.track)})},248:function(e){},250:function(e){},251:function(e){},252:function(e){},254:function(e){},255:function(e){(t(this,ae)[e.meta]||function(l,n,p){}).call(this,e.data,e.track,e.meta),e.meta!=32&&x(this,Ye,0);let r=na.indexOf(e.meta)>-1;if(L()&&console.debug(e),r)return e.reply="meta",e}});T(this,Gt,{64:(e,r,l)=>{t(this,at).run(r,l,e)},65:(e,r,l)=>{if(r[0]<16)if(r[1]===72){let n=r[r.length-1],p=Ie(r.subarray(3,r.length-1));n===p?t(this,be).run(r.subarray(0,r.length-1),l,e):console.warn(`Bad SD checksum ${n} - should be ${p}.`)}else t(this,be).run(r,l,e);else{let n=r[r.length-1],p=Ie(r.subarray(2,r.length-1));n===p?t(this,be).run(r.subarray(0,r.length-1),l,e):console.warn(`Bad GS checksum ${n} - should be ${p}.`)}},66:(e,r,l)=>{t(this,Me).run(r,l,e)},67:(e,r,l)=>{t(this,ue).run(r,l,e)},68:(e,r,l)=>{t(this,it).run(r,l,e)},71:(e,r,l)=>{t(this,st).run(r,l,e)},126:(e,r,l)=>{t(this,tt).run(r,l,e)},127:(e,r,l)=>{this.switchMode("gm"),t(this,rt).run(r,l,e)}});T(this,tt,void 0);T(this,rt,void 0);T(this,ue,void 0);T(this,be,void 0);T(this,Me,void 0);T(this,at,void 0);T(this,st,void 0);T(this,it,void 0);let e=this;x(e,pe,new Uint8Array(256),Or),t(e,Ae)[10]=new Uint8Array(512),x(e,et,new me),x(e,B,{x5:82,ds:S.krs,smotif:S.s90es,gs:4,sc:3}),x(e,Se,{dumpLimit:e.DUMP_MODE}),x(e,Pt,new Proxy(t(e,Se),{set:()=>{}}));for(let a in kr){let s=S[a];s===void 0?console.debug(`SubDB build error: "${a}" does not exist`):t(e,Q)[s]=new Uint8Array(kr[a])}e.userBank.strictMode=!0,e.userBank.load(`MSB	PRG	LSB	NME
062	000	000	
122	000	000	
122	001	000	
122	002	000	
122	003	000	
122	004	000	
122	005	000	
122	006	000	`),e.addEventListener("metacommit",function(a){var h,i;let{data:s}=a;((h=t(e,fe)[0])==null?void 0:h.type)===s.type&&((i=t(e,fe)[0])!=null&&i.amend)?(t(e,fe)[0].amend=s.amend,t(e,fe)[0].data+=s.data):t(e,fe).unshift(s)}),t(e,ae)[1]=function(a){var s,h,i,c,d;switch(a=a.replaceAll(`\r
`,`
`).replaceAll("\r",`
`),a.slice(0,2)){case"@I":{x(e,X,e.KARAOKE_TEXT),e.dispatchEvent("metacommit",{type:"Kar.Info",data:(s=a.slice(2))==null?void 0:s.trimLeft()});break}case"@K":{x(e,X,e.KARAOKE_TEXT),e.dispatchEvent("metacommit",{type:"Kar.Mode",data:(h=a.slice(2))==null?void 0:h.trimLeft()}),console.debug(`Karaoke mode active: ${a.slice(2)}`);break}case"@L":{x(e,X,e.KARAOKE_TEXT),e.dispatchEvent("metacommit",{type:"Kar.Lang",data:(i=a.slice(2))==null?void 0:i.trimLeft()});break}case"@T":{x(e,X,e.KARAOKE_TEXT),e.dispatchEvent("metacommit",{type:"KarTitle",data:(c=a.slice(2))==null?void 0:c.trimLeft()});break}case"@V":{x(e,X,e.KARAOKE_TEXT),e.dispatchEvent("metacommit",{type:"Kar.Ver.",data:(d=a.slice(2))==null?void 0:d.trimLeft()});break}case"XF":{let o=a.slice(2).split(":");switch(o[0]){case"hd":{o.slice(1).forEach((u,f)=>{u.length&&e.dispatchEvent("metacommit",{type:["XfSngDte","XfSngRgn","XfSngCat","XfSongBt","XfSngIns","XfSngVoc","XfSngCmp","XfSngLrc","XfSngArr","XfSngPer","XfSngPrg","XfSngTag"][f],data:u})});break}case"ln":{o.slice(1).forEach((u,f)=>{u.length&&e.dispatchEvent("metacommit",{type:["XfKarLng","XfKarNme","XfKarCmp","XfKarLrc","XfKarArr","XfKarPer","XfKarPrg"][f],data:u})});break}default:e.dispatchEvent("metacommit",{type:"XfUnData",data:a})}break}default:switch(t(e,X)){case e.KARAOKE_TEXT:{switch(a[0]){case"\\":{e.dispatchEvent("metacommit",{type:"KarLyric",data:"",amend:!1}),e.dispatchEvent("metacommit",{type:"KarLyric",data:a.slice(1),amend:!0});break}case"/":{e.dispatchEvent("metacommit",{type:"KarLyric",data:"",mask:!0,amend:!1}),e.dispatchEvent("metacommit",{type:"KarLyric",data:a.slice(1),mask:!0,amend:!0});break}default:e.dispatchEvent("metacommit",{type:"KarLyric",data:a,amend:!0})}break}default:a.split(`
`).forEach((o,u)=>{e.dispatchEvent("metacommit",{type:"Cmn.Text",data:o,mask:u!=0})})}}},t(e,ae)[2]=function(a){e.dispatchEvent("metacommit",{type:"Copyrite",data:a})},t(e,ae)[3]=function(a,s){s<1&&t(e,Ye)<1&&e.dispatchEvent("metacommit",{type:"TrkTitle",data:a})},t(e,ae)[4]=function(a,s){e.dispatchEvent("metacommit",{type:"Instrmnt",data:a})};let r=!1;t(e,ae)[5]=function(a){switch(t(e,X)){case e.KARAOKE_XF:{let s="";for(let h of a)switch(h){case"^":{s+=" ";break}case">":break;case"<":{e.dispatchEvent("metacommit",{type:"KarLyric",data:s,mask:r,amend:!1}),s="",r=!1;break}case"/":case"%":{e.dispatchEvent("metacommit",{type:"KarLyric",data:s,mask:!1,amend:!0}),e.dispatchEvent("metacommit",{type:"KarLyric",data:"",mask:!0,amend:!1}),s="",r=!0;break}default:s+=h}s.length>0&&(e.dispatchEvent("metacommit",{type:"KarLyric",data:s,mask:r,amend:!0}),r=!1);break}default:{a.trim()===""?e.dispatchEvent("metacommit",{type:"C.Lyrics",data:"",amend:!1}):e.dispatchEvent("metacommit",{type:"C.Lyrics",data:a,amend:!0});break}}},t(e,ae)[6]=function(a){e.dispatchEvent("metacommit",{type:"C.Marker",data:a})},t(e,ae)[7]=function(a){switch(a[0]){case"$":{if(a.substring(1,5)==="Lyrc"){x(e,X,e.KARAOKE_XF);let s=a.substring(6).split(":"),h=s[0].replaceAll(" ","").split(",");h.forEach((c,d,o)=>{o[d]=parseInt(c)-1});let i=mr[s[2].substring(0,2).toLowerCase()];e.dispatchEvent("metacommit",{type:"XfMeloCh",data:`CH${s[0].replaceAll(" ","").split(",").join(", CH")}`,parsed:h}),e.dispatchEvent("metacommit",{type:"XfLyrOff",data:s[1],parsed:parseInt(s[1])}),e.dispatchEvent("metacommit",{type:"XfLyrEnc",data:i[1],parsed:i[0]}),r=!1}else e.dispatchEvent("metacommit",{type:"CuePoint",data:a});break}case"#":{e.dispatchEvent("metacommit",{type:"XfScneNo",data:a.substring(1)});break}case"&":{a.length===2?(e.dispatchEvent("metacommit",{type:"XfSngPrt",data:Er[a[1]]||`Unknown "${a[1]}"`}),r=!1):e.dispatchEvent("metacommit",{type:"CuePoint",data:a});break}default:e.dispatchEvent("metacommit",{type:"CuePoint",data:a})}},t(e,ae)[32]=function(a){x(e,Ye,a[0]+1)},t(e,ae)[33]=function(a,s){L()&&console.debug(`Track ${s} requests to get assigned to output ${a}.`),t(e,He)[s]=a+1},t(e,ae)[81]=function(a,s){x(e,yt,a/1e3)},t(e,ae)[127]=function(a,s){t(e,et).run(a,s)},t(e,et).default=function(a){console.warn(`Unrecognized sequencer-specific byte sequence: ${a}`)},t(e,et).add([67,0,1],function(a,s){L()&&console.debug(`XGworks requests assigning track ${s} to output ${a[0]}.`),t(e,He)[s]=a[0]+1}),x(e,tt,new me("universal non-realtime")),x(e,rt,new me("universal realtime")),x(e,ue,new me("Yamaha")),x(e,be,new me("Roland")),x(e,Me,new me("Korg")),x(e,at,new me("Kawai")),x(e,st,new me("Akai")),x(e,it,new me("Casio"));let l=new me("DX7+ Dump"),n=function(a){console.info(`Unrecognized SysEx in "${this.name}" set.
%o`,a)};t(e,tt).default=n,t(e,rt).default=n,t(e,ue).default=n,t(e,be).default=n,t(e,Me).default=n,t(e,at).default=n,t(e,st).default=n,t(e,it).default=n,l.default=n,t(e,tt).add([9],(a,s,h)=>{e.switchMode(["gm","?","g2"][a[0]-1],!0),e.setPortMode(e.getTrackPort(s),1,S[["gm","?","g2"][a[0]-1]]),x(e,X,t(e,X)||e.KARAOKE_NONE),console.info(`MIDI reset: ${["GM","Init","GM2"][a[0]-1]}`),a[0]===2&&e.init()}),t(e,rt).add([4,1],(a,s,h)=>{e.dispatchEvent("mupromptex"),x(e,F,((a[1]<<7)+a[0])/16383*100),e.dispatchEvent("mastervolume",t(e,F))}).add([4,3],(a,s,h)=>((a[1]<<7)+a[0]-8192)/8192).add([4,4],(a,s,h)=>a[1]-64).add([4,5],(a,s,h)=>{e.dispatchEvent("mupromptex");let i=a[0],c=a[1],d=a[2],o=3,u=o+(i<<1),f=u+c;if(i!=1){console.error(`Unsupported GM2 global parameter set: slotpath length too long (${i})!
`,a);return}let b=0,k=0,M=0;switch(a.subarray(o,u).forEach(P=>{b=b<<7,b|=P}),a.subarray(u,f).forEach((P,O)=>{k|=P<<O*7}),a.subarray(f).forEach((P,O)=>{M|=P<<O*7}),L()&&console.debug(`GM2 global parameter: (${a.subarray(3,u)}; p: ${k}, v: ${M})`),b){case 129:{k===0&&(e.setEffectType(0,52,M),e.dispatchEvent("efxreverb",e.getEffectType(0)));break}case 130:{k===0&&(e.setEffectType(1,52,M|16),e.dispatchEvent("efxchorus",e.getEffectType(1)));break}default:L()&&console.debug("GM2 global paramater slot path unknown.")}}),t(this,ue).add([76,0,0],(a,s,h)=>{switch(a[0]){case 125:{e.initDrums(),console.info(`XG drum setup reset on drum kit ${a[1]}.`);break}case 126:{e.switchMode("xg",!0),e.setPortMode(e.getTrackPort(s),4,S.xg),x(e,X,t(e,X)||e.KARAOKE_NONE),console.info("MIDI reset: XG");break}default:{e.dispatchEvent("mupromptex");let i=[0,0,0,0],c=(d,o)=>{i[o]=d};if(a.subarray(1).forEach((d,o)=>{let u=o+a[0];([c,c,c,c,f=>{x(this,F,f*129/16383*100),e.dispatchEvent("mastervolume",t(e,F))},f=>{},f=>{}][u]||(()=>{}))(d,o)}),a[0]<4){let d=0;i.forEach(o=>{d=d<<4,d+=o}),d-=1024}}}}).add([76,2,1],(a,s,h)=>{e.dispatchEvent("mupromptex");let i="XG ";a[0]<32?(i+="reverb ",a.subarray(1).forEach((c,d)=>{([o=>{e.setEffectTypeRaw(0,!1,o),console.info(`${i}main type: ${xt[o]}`),e.dispatchEvent("efxreverb",e.getEffectType(0))},o=>{e.setEffectTypeRaw(0,!0,o),console.debug(`${i}sub type: ${o+1}`),e.dispatchEvent("efxreverb",e.getEffectType(0))},o=>{console.debug(`${i}time: ${fr(o)}s`)},o=>{console.debug(`${i}diffusion: ${o}`)},o=>{console.debug(`${i}initial delay: ${o}`)},o=>{console.debug(`${i}HPF cutoff: ${ut[o]}Hz`)},o=>{console.debug(`${i}LPF cutoff: ${ut[o]}Hz`)},o=>{console.debug(`${i}width: ${o}`)},o=>{console.debug(`${i}height: ${o}`)},o=>{console.debug(`${i}depth: ${o}`)},o=>{console.debug(`${i}wall type: ${o}`)},o=>{console.debug(`${i}dry/wet: ${o}`)},o=>{console.debug(`${i}send: ${oe(o)}dB`)},o=>{console.debug(`${i}pan: ${o-64}`)},!1,!1,o=>{console.debug(`${i}delay: ${o}`)},o=>{console.debug(`${i}density: ${o}`)},o=>{console.debug(`${i}balance: ${o}`)},o=>{},o=>{console.debug(`${i}feedback: ${o}`)},o=>{}][a[0]+d]||function(){console.warn(`Unknown XG reverb address: ${a[0]}.`)})(c)})):a[0]<64?(i+="chorus ",a.subarray(1).forEach((c,d)=>{([o=>{e.setEffectTypeRaw(1,!1,o),console.info(`${i}main type: ${xt[o]}`),e.dispatchEvent("efxchorus",e.getEffectType(1))},o=>{e.setEffectTypeRaw(1,!0,o),console.debug(`${i}sub type: ${o+1}`),e.dispatchEvent("efxchorus",e.getEffectType(1))},o=>{console.debug(`${i}LFO: ${hr[o]}Hz`)},o=>{},o=>{console.debug(`${i}feedback: ${o}`)},o=>{console.debug(`${i}delay offset: ${ur(o)}ms`)},o=>{},o=>{console.debug(`${i}low: ${ut[o]}Hz`)},o=>{console.debug(`${i}low: ${o-64}dB`)},o=>{console.debug(`${i}high: ${ut[o]}Hz`)},o=>{console.debug(`${i}high: ${o-64}dB`)},o=>{console.debug(`${i}dry/wet: ${o}`)},o=>{console.debug(`${i}send: ${oe(o)}dB`)},o=>{console.debug(`${i}pan: ${o-64}`)},o=>{console.debug(`${i}to reverb: ${oe(o)}dB`)},!1,o=>{},o=>{},o=>{},o=>{console.debug(`${i}LFO phase diff: ${(o-64)*3}deg`)},o=>{console.debug(`${i}input mode: ${o?"stereo":"mono"}`)},o=>{}][a[0]-32+d]||function(){console.warn(`Unknown XG chorus address: ${a[0]}.`)})(c)})):a[0]<86?(i+="variation ",a.subarray(1).forEach((c,d)=>{([o=>{e.setEffectTypeRaw(2,!1,o),console.info(`${i}main type: ${xt[o]}`),e.dispatchEvent("efxdelay",e.getEffectType(2))},o=>{e.setEffectTypeRaw(2,!0,o),console.debug(`${i}sub type: ${o+1}`),e.dispatchEvent("efxdelay",e.getEffectType(2))}][a[0]-64+d]||function(){})(c)})):a[0]<97?(i+="variation ",a.subarray(1).forEach((c,d)=>{[o=>{console.debug(`${i}send: ${oe(o)}dB`)},o=>{console.debug(`${i}pan: ${o-64}`)},o=>{console.debug(`${i}to reverb: ${oe(o)}dB`)},o=>{console.debug(`${i}to chorus: ${oe(o)}dB`)},o=>{console.debug(`${i}connection: ${o?"system":"insertion"}`)},o=>{console.debug(`${i}channel: CH${o+1}`)},o=>{console.debug(`${i}mod wheel: ${o-64}`)},o=>{console.debug(`${i}bend wheel: ${o-64}`)},o=>{console.debug(`${i}channel after touch: ${o-64}`)},o=>{console.debug(`${i}AC1: ${o-64}`)},o=>{console.debug(`${i}AC2: ${o-64}`)}][a[0]-86+d](c)})):a[0]>111&&a[0]<118?i+="variation ":console.warn(`Unknown XG variation address: ${a[0]}`)}).add([76,2,64],(a,s,h)=>{a.subarray(1).forEach((i,c)=>{let d=c+a[0];if(d===0)console.debug(`XG EQ preset: ${["flat","jazz","pop","rock","classic"][i]}`);else{let o=d-1>>2,u=d-1&3,f=`XG EQ ${o} ${["gain","freq","Q","shape"][u]}: `;[()=>{console.debug(`${f}${i-64}dB`)},()=>{console.debug(`${f}${i} (raw)`)},()=>{console.debug(`${f}${i/10}`)},()=>{console.debug(`${f}${["shelf","peak"][+!!i]}`)}][u]()}})}).add([76,3],(a,s,h)=>{e.dispatchEvent("mupromptex");let i=a[0],c=a[1],d=`XG Insertion ${a[0]+1} `;a.subarray(2).forEach((o,u)=>{([f=>{e.setEffectTypeRaw(3+i,!1,f),console.info(`${d}main type: ${xt[f]}`),e.dispatchEvent(`efxinsert${i}`,e.getEffectType(3+i))},f=>{e.setEffectTypeRaw(3+i,!0,f),console.debug(`${d}sub type: ${f+1}`),e.dispatchEvent(`efxinsert${i}`,e.getEffectType(3+i))}][c+u]||function(){})(o)})}).add([76,6,0],(a,s,h)=>{let i=a[0];i<64?e.setLetterDisplay(a.subarray(1),"XG letter display",i):x(e,_e,Date.now())}).add([76,7,0],(a,s,h)=>{let i=a[0];x(e,te,0),x(e,ye,Date.now()+3200),t(e,pe,Re).fill(0);let c=a.subarray(1);for(let d=0;d<i;d++)c.unshift(0);c.forEach(function(d,o){let u=Math.floor(o/16),f=o%16,b=(f*3+u)*7,k=7,M=0;for(b-=f*5,u===2&&(k=2);M<k;)t(e,pe,Re)[b+M]=d>>6-M&1,M++})}).add([76,8],(a,s)=>{e.dispatchEvent("mupromptex");let h=e.chRedir(a[0],s,!0),i=a[1],c=H[h],d=`XG CH${h+1} `,o=`Unknown XG part address ${i}.`,u=!0;a.subarray(2).forEach((f,b)=>{u=!0,i<1?console.debug(o):i<41?([()=>{e.setChCc(h,0,f),e.pushChPrimitives(h),e.dispatchEvent("voice",{part:h})},()=>{e.setChCc(h,32,f),e.pushChPrimitives(h),e.dispatchEvent("voice",{part:h})},()=>{t(e,I)[h]=f,e.dispatchEvent("voice",{part:h})},()=>{u=!1;let k=e.chRedir(f,s,!0);t(e,Z)[h]=k,h!=k&&(e.buildRchTree(),console.info(`${d}receives from CH${k+1}`)),t(e,le)[h]||(e.copyChSetup(k,h,!0),console.debug(`${d}copied from CH${k+1}.`),e.setChActive(h,1),e.dispatchEvent("voice",{part:h}))},()=>{t(e,ie)[h]=+!f},()=>{},()=>{u=!1,e.setChType(h,f,S.xg),console.debug(`${d}type: ${St[f]||f}`),e.dispatchEvent("voice",{part:h})},()=>{t(e,D)[E.rpn*h+3]=f,t(e,U)[E.rpnt*h+2]=1,e.dispatchEvent("pitch",{part:h,pitch:e.getPitchShift(h)})},!1,!1,()=>{e.setChCc(h,7,f)},!1,!1,()=>{e.setChCc(h,10,f||128)},!1,!1,()=>{e.setChCc(h,128,f),e.allocateAce(h,128)},()=>{e.setChCc(h,93,f)},()=>{e.setChCc(h,91,f)},()=>{e.setChCc(h,94,f)},()=>{e.setChCc(h,76,f)},()=>{e.setChCc(h,77,f)},()=>{e.setChCc(h,78,f)},()=>{e.setChCc(h,74,f)},()=>{e.setChCc(h,71,f)},()=>{e.setChCc(h,73,f)},()=>{e.setChCc(h,75,f)},()=>{e.setChCc(h,72,f)}][i+b-1]||(()=>{}))():i<48?console.debug(o):i<111?i>102&&i<105&&e.setChCc(h,[5,65][i&1],f):i<114?console.debug(o):i<116?console.debug(`${d}EQ ${["bass","treble"][i&1]} gain: ${f-64}dB`):i<118?console.debug(o):i<120?console.debug(`${d}EQ ${["bass","treble"][i&1]} freq: ${f}`):console.debug(o)}),u&&t(e,A)[h]>1&&e.setDrumFirstWrite(h)}).add([76,9],(a,s)=>{let h=e.chRedir(a[0],s,!0),i=a[1],c=H[h],d=`PLG-VL CH${h+1} `;a.subarray(2).forEach((o,u)=>{let f=u+i;switch(f){case 1:{console.info(`${d}breath mode: ${["system","breath","velocity","touch EG"][o]}`);break}case 0:case 27:case 28:break;default:if(f<27){let b=f-3>>1,k=["pressure","embouchure","tonguing","scream","breath noise","growl","throat formant","harmonic enhancer","damping","absorption","amplification","brightness"][b];f&1?f<23?(console.debug(`${d}${k} control source: ${br(o)}`),o&&o<96&&e.allocateAce(h,130+b),t(e,qe)[E.redir*h+b+2]=o,e.buildRccMap()):console.debug(`${d}${k} scale break point: ${o}`):(console.debug(`${d}${k} depth: ${o-64}`),e.setChCc(h,130+b,o))}}})}).add([76,10],(a,s,h)=>{}).add([76,16],(a,s,h)=>{}).add([76,17,0,0],(a,s,h)=>{}).add([76,112],(a,s,h)=>{switch(console.debug(`XG enable PLG-${["VL","SG","DX","AN","PF","DR","PC","AP"][a[0]]} for CH${a[2]+1}.`),a[0]){case 0:{t(e,de)[E.ext*a[2]]=e.EXT_VL;break}case 2:{t(e,de)[E.ext*a[2]]=e.EXT_DX;break}default:t(e,de)[E.ext*a[2]]=e.EXT_NONE}}).add([73,0,0],(a,s)=>{let h=a[0],i="MU1000 System - ";a.subarray(1).forEach((c,d)=>{let o=h+d;o===8?console.debug(`${i}LCD contrast: ${c}.`):o===18?(t(e,Q)[S.xg][1]=c?126:0,console.debug(`${i}default bank: ${c?"MU100 Native":"MU Basic"}.`),e.dispatchEvent("banklevel",{mode:"xg",data:+!!c}),e.forceVoiceRefresh()):o>=64&&o<69&&[()=>{e.dispatchEvent("channelactive",c)},()=>{c<8?(e.dispatchEvent("channelmin",c<<4),console.debug(`Octavia System: Minimum CH${(c<<4)+1}`)):(e.dispatchEvent("channelreset"),console.info("Octavia System: Clear channel ranges"))},()=>{c<8?(e.dispatchEvent("channelmax",(c<<4)+15),console.debug(`Octavia System: Maximum CH${(c<<4)+16}`)):(e.dispatchEvent("channelreset"),console.info("Octavia System: Clear channel ranges"))},()=>{e.dispatchEvent("channelreset"),console.info("Octavia System: Clear channel ranges")},()=>{x(e,Te,!!c),console.info(`Octavia System: RS receiving ${["dis","en"][c]}abled.`)}][o-64]()})}).add([73,10,0],(a,s)=>{let h=a[0],i=`MU1000 RS${t(e,Te)?"":" (ignored)"}: `;if(h<16)switch(h){case 2:{let c=e.chRedir(0,s,!0);t(e,Te)&&(e.dispatchEvent("portrange",4),e.dispatchEvent("portstart",c)),console.info(`${i}Show CH${c+1}~CH${c+64}`);break}case 3:{let c=e.chRedir(a[1]<<5,s,!0);t(e,Te)&&(e.dispatchEvent("portrange",2),e.dispatchEvent("portstart",c)),console.info(`${i}Show CH${c+1}~CH${c+32}`);break}default:console.debug(`${i}unknown switch ${h} invoked.`)}else if(h<32){if(t(e,Te)){let c=e.chRedir(h-16+(t(e,vt)<<4),s,!0);e.dispatchEvent("channelactive",c)}}else if(h<36){let c=e.chRedir(h-32<<4,s,!0);t(e,Te)&&(e.dispatchEvent("portrange",1),e.dispatchEvent("portstart",c>>4),x(e,vt,h-32)),console.info(`${i}Show CH${c+1}~CH${c+16}`)}}).add([73,11,0],(a,s)=>{let h="MU1000 System - channel ",i="Octavia System - channel ",c=a[0];a.subarray(1).forEach((d,o)=>{let u=c+o;([()=>{e.setChActive(d,1),e.dispatchEvent("channelactive",d),L()&&console.debug(`${h}current part: CH${d+1}`)},()=>{d<5?(e.dispatchEvent("portrange",1<<d),console.debug(`${h}port range: ${1<<d} port(s)`)):(e.dispatchEvent("portrange",0),console.debug(`${h}port range: reset`))},()=>{d<16?(e.dispatchEvent("portstart",d),console.debug(`${i}start port: ${"ABCDEFGHIJKLMNOP"[d]}`)):(e.dispatchEvent("portstart",255),console.debug(`${i}start port: reset`))}][u]||(()=>{console.debug(`${h}unknown address: ${u}`)}))()})}).add([93,3],(a,s)=>{let h=e.chRedir(a[0],s,!0),i=`PLG-SG CH${h+1} `,c=Date.now();if(a[1]===0){let d="",o=0;a.subarray(2).forEach((u,f)=>{f%2===0?d+=pr[u]||u.toString().padStart("0"):o+=u*13}),(c>=t(e,Qe)||t(e,Ze)>=t(e,_t))&&(e.dispatchEvent("metacommit",{type:"SGLyrics",data:"",amend:!1}),x(e,Je,c<t(e,Qe)),x(e,Ze,0)),e.dispatchEvent("metacommit",{type:"SGLyrics",data:`${gr(d)}`,amend:!0,mask:t(e,Je)}),sr(e,Ze)._++,x(e,Je,!1),x(e,Qe,c+Math.ceil(o/2)+t(e,yt)),L()&&console.debug(`${i}vocals: ${d}`)}else console.warn(`Unknown PLG-SG data: ${a}`)}).add([98,0],(a,s,h)=>{e.dispatchEvent("mupromptex");let i=a[0],c=a.length-5,d=a.length-1;if(i!=c){console.info(`PLG-DX native dump size mismatch! Gave ${i} instead of ${a.length-5}.`);return}let o=Ie(a.subarray(4,d));if(o!=a[d]){console.info(`Bad PLG-DX checksum ${a[d]} - should be ${o}.`);return}a[0]=98,t(e,ue).run(a.subarray(0,d),s,h,{noAce:!0})}).add([98,96],(a,s,h,i)=>{let c=e.chRedir(a[0],s,!0),d=H[c],o=a[1];a.subarray(2).forEach((u,f)=>{let b=o+f;if(!(b<10)){if(b===10)e.resetAce();else if(b<27){let k=b+131;i!=null&&i.noAce||e.allocateAce(c,k),e.setChCc(c,k,u),e.dispatchEvent("cc",{part:c,cc:k,data:u})}}})}).add([100,0],(a,s,h)=>{let i=a.subarray(0,a.length-1);if(a[0]+5!=a.length){console.warn(`Yamaha DX7+ dump SysEx size mismatch! Expected ${a.length}, but got ${a[0]}:
`,a);return}let c=Ie(i),d=a[a.length-1];if(c!=d){console.warn(`Yamaha DX7+ dump SysEx checksum mismatch! Expected ${c}, but got ${d}:
`,a);return}l.run(i.subarray(1))}).add([100,76],(a,s,h)=>{let i=a[0]>>4,c=a[0]&15,d=a[1];switch(i){case 2:{let o=e.chRedir(c,s,!0),u=H[o];a.subarray(2).forEach((f,b)=>{let k=b+d;if(!(k<7)){if(k<23){let M=k+135;e.allocateAce(o,M),e.setChCc(o,M,f),e.dispatchEvent("cc",{part:o,cc:M,data:f})}}});break}default:console.info("Unknown DX7+ multipart: %o",a)}}).add([1,20],(a,s,h)=>{h===115?(e.switchMode("doc",!0),e.setPortMode(e.getTrackPort(s),1,S.doc),console.info("MIDI reset: DOC")):console.debug(`Unknown Yamaha SysEx: 67, ${h}, ${a.join(", ")}`)}).add([1,17,15,89],(a,s,h)=>{h===115?(e.setEffectType(0,24,a[0]|16),e.dispatchEvent("efxreverb",e.getEffectType(0))):console.debug(`Unknown Yamaha SysEx: 67, ${h}, ${a.join(", ")}`)}).add([1,24],(a,s,h)=>{if(h===115){for(let i=0;i<16;i++){let c=e.chRedir(i,s,!0);e.setChCc(c,91,127)}console.info("DOC Global Reverb: on")}else console.debug(`Unknown Yamaha SysEx: 67, ${h}, ${a.join(", ")}`)}),l.add([14,31],(a,s,h)=>{e.setChCc(a[0],64,0),t(e,j).ano(a[0]),e.switchMode("xg"),e.setPortMode(e.getTrackPort(s),1,S.xg),e.resetAce(),console.debug(`Yamaha DX7+ reset CH${a[0]+1}.`)}).add([76,112],async a=>{let s=a[0],h=H[s],i=Dr[s],c=E.cvn*s;t(e,de)[i]=e.EXT_DX,t(e,Ce)[s]=1;let d=t(e,Mt).subarray(c,c+E.cvn);d.fill(32),a.subarray(1).forEach((o,u)=>{if(u<10)d[u]=Math.max(o,32);else if(!(u<40)){if(u<56){let f=u+102;e.setChCc(s,f,o),e.dispatchEvent("cc",{part:s,cc:f,data:o})}}}),t(e,I)[s]=s&127,e.setChCc(s,0,35),e.setChCc(s,32,s>>7|4),e.pushChPrimitives(s),e.dispatchEvent("voice",{part:s}),console.debug(`DX7+ CH${s+1} dump: %o`,a)});let p=function(a,s,h,i){},m=function(a,s){e.dispatchEvent("mupromptex");let h=a*E.dpn,i=s[0],c=s[1];s.subarray(2).forEach((d,o)=>{let u=o+c,f=-1;u<16?([()=>{f=24},()=>{f=25},()=>{f=26},()=>{},()=>{f=28},()=>{f=29},()=>{f=30},()=>{f=31},()=>{},()=>{},()=>{},()=>{f=20},()=>{f=21},()=>{f=22},()=>{f=23},()=>{}][u]||(()=>{console.debug(`Unknown XG-style drum param ${u} on set ${a+1}.`)}))():u<32||(u<40?([()=>{f=48},()=>{f=49},!1,!1,()=>{f=52},()=>{f=53}][u-32]||(()=>{console.debug(`Unknown XG-style drum param ${u} on set ${a+1}.`)}))():u<80||([()=>{f=36}][u-80]||(()=>{console.debug(`Unknown XG-style drum param ${u} on set ${a+1}.`)}))()),f>=0?(L()&&console.debug(h,f,i,d),t(e,ne)[(h+ge[f])*E.dnc+i]=d):L()&&console.debug(`XG-style drum param ${u} has no writes.`)})},v=function(a,s,h){e.dispatchEvent("mupromptex");let i=a*E.dpn,c=(s<<7)+h[0];h.subarray(1).forEach((d,o)=>{let u=o+c,f=u&127,b=u>>7,k=-1;b>1&&([()=>{k=26},()=>{},()=>{k=28},()=>{k=29},()=>{k=30},()=>{},()=>{},()=>{k=31}][b-2]||(()=>{console.debug(`Unknown GS-style drum param ${b} on set ${a+1}.`)}))(),k>-1?(L()&&console.debug(i,k,f,d),t(e,ne)[(i+ge[k])*E.dnc+f]=d):L()&&console.debug(`GS-style drum param ${b} has no writes.`)})};t(this,ue).add([76,48],(a,s,h)=>{m(0,a)}).add([76,49],(a,s,h)=>{m(1,a)}).add([76,50],(a,s,h)=>{m(2,a)}).add([76,51],(a,s,h)=>{m(3,a)}).add([76,52],(a,s,h)=>{m(4,a)}).add([76,53],(a,s,h)=>{m(5,a)}).add([76,54],(a,s,h)=>{m(6,a)}).add([76,55],(a,s,h)=>{m(7,a)}),t(this,ue).add([89,0],(a,s,h)=>{if(e.eprom){let i=a[0],c=(a[1]<<14)+(a[2]<<7)+a[3]+(e.eprom.offset||0);L()&&console.debug(`MU1000 EPROM trail to 0x${c.toString(16).padStart(6,"0")}, ${i} bytes.`);let d=e.eprom.data;a.subarray(4).forEach((o,u)=>{let f=u>>3,b=u&7;if(b===7)for(let k=0;k<7;k++)d[c+7*f+k]+=(o>>6-k&1)<<7;else d[c+7*f+b]=o})}}).add([89,1],(a,s,h)=>{let i=(a[0]<<21)+(a[1]<<14)+(a[2]<<7)+a[3];L()&&console.debug(`MU1000 EPROM jump to 0x${i.toString(16).padStart(6,"0")}.`),e.eprom&&(e.eprom.offset=i)}).add([89,2],(a,s,h)=>{if(e.eprom){let i=(a[0]<<21)+(a[1]<<14)+(a[2]<<7)+a[3]+(e.eprom.offset||0);L()&&console.debug(`MU1000 EPROM write to 0x${i.toString(16).padStart(6,"0")}.`);let c=e.eprom.data;a.subarray(4).forEach((d,o)=>{let u=o>>3,f=o&7;if(f===7)for(let b=0;b<7;b++)c[i+7*u+b]+=(d>>6-b&1)<<7;else c[i+7*u+f]=d})}}).add([89,3],(a,s,h)=>{}),t(this,ue).add([39,48],(a,s,h)=>{}).add([43,0,0],(a,s,h)=>{e.dispatchEvent("mupromptex");let i=[0,0,0,0],c=(d,o)=>{i[o]=d};if(a.subarray(1).forEach((d,o)=>{let u=o+a[0];[c,c,c,c,()=>{x(this,F,d*129/16383*100),e.dispatchEvent("mastervolume",t(e,F))},()=>d-64,()=>d||128,()=>d,()=>d,()=>{console.debug(`TG300 variation on cc${d}.`)}][u](d,u)}),a[0]<4){let d=0;i.forEach(o=>{d=d<<4,d+=o}),d-=1024}}).add([43,1,0],(a,s,h)=>{e.dispatchEvent("mupromptex")}).add([43,2],(a,s,h)=>{e.dispatchEvent("mupromptex");let i=e.chRedir(a[0],s,!0),c=a[1],d=H[i],o=`TG300 CH${i+1} `;a.subarray(2).forEach((u,f)=>{f<5?([()=>{},()=>{e.setChCc(i,0,u),e.pushChPrimitives(i),e.dispatchEvent("voice",{part:i})},()=>{e.setChCc(i,32,u),e.pushChPrimitives(i),e.dispatchEvent("voice",{part:i})},()=>{t(e,I)[i]=u,e.dispatchEvent("voice",{part:i})},()=>{let b=e.chRedir(u,s,!0);t(e,Z)[i]=b,i!=b&&(e.buildRchTree(),console.info(`${o}receives from CH${b+1}`))}][f+c]||(()=>{}))(u,f+c):f<21||(f<47?([()=>{t(e,ie)[i]=+!u},()=>{},()=>{},()=>{t(e,D)[E.rpn*i+3]=u,t(e,U)[E.rpnt*i+2]=1,e.dispatchEvent("pitch",{part:i,pitch:e.getPitchShift(i)})},()=>{},()=>{e.setChCc(i,7,u)},!1,!1,()=>{e.setChCc(i,10,u||128)},!1,!1,()=>{console.debug(`${o} AC1 at cc${u}`)},()=>{console.debug(`${o} AC2 at cc${u}`)},()=>{t(e,C)[d+w[128]]=u,e.allocateAce(i,128)},()=>{t(e,C)[d+w[93]]=u},()=>{t(e,C)[d+w[91]]=u},()=>{t(e,C)[d+w[94]]=u},()=>{t(e,C)[d+w[76]]=u},()=>{t(e,C)[d+w[77]]=u},()=>{t(e,C)[d+w[74]]=u},()=>{t(e,C)[d+w[71]]=u},()=>{t(e,C)[d+w[73]]=u},()=>{t(e,C)[d+w[75]]=u},()=>{t(e,C)[d+w[72]]=u},()=>{t(e,C)[d+w[78]]=u}][f+c-21]||(()=>{}))(u,f+c):f<95||([()=>{t(e,C)[d+w[65]]=u},()=>{t(e,C)[d+w[5]]=u}][f+c-95]||(()=>{}))(u,f+c))})}).add([43,7,0],(a,s,h)=>{let i=a[0];e.setLetterDisplay(a.subarray(1),"TG300 letter display",i)}).add([43,7,1],(a,s,h)=>{x(e,te,0),x(e,ye,Date.now()+3200),t(e,pe,Re).fill(0),a.forEach(function(i,c){let d=Math.floor(c/16),o=c%16,u=(o*3+d)*7,f=7,b=0;for(u-=o*5,d===2&&(f=2);b<f;)t(e,pe,Re)[u+b]=i>>6-b&1,b++})}),t(this,be).add([66,18,0,0,127],(a,s,h)=>{e.switchMode("sc",!0),e.setPortMode(e.getTrackPort(s),2,S.sc),t(e,Q)[S.sc][1]=t(e,B).sc,x(e,X,e.KARAOKE_NONE),t(e,Oe).fill(0),console.info(`GS system to ${["single","dual"][a[0]]} mode.`)}).add([66,18,64,0],(a,s,h)=>{switch(a[0]){case 127:{e.switchMode("gs",!0),e.setPortMode(e.getTrackPort(s),4,S.gs),t(e,Q)[S.gs][1]=t(e,B).gs,x(e,X,e.KARAOKE_NONE),t(e,Oe).fill(0),console.info("MIDI reset: GS");break}default:{e.dispatchEvent("mupromptex");let i=[0,0,0,0],c=(d,o)=>{i[o]=d};if(a.subarray(1).forEach((d,o)=>{let u=o+a[0];[c,c,c,c,f=>{x(this,F,f*129/16383*100),e.dispatchEvent("mastervolume",t(e,F))},f=>{},f=>{}][u](d,o)}),a[0]<4){let d=0;i.forEach(o=>{d=d<<4,d+=o}),d-=1024}}}}).add([66,18,64,1],(a,s,h)=>{e.dispatchEvent("mupromptex");let i=a[0];if(i<16){let c="".padStart(i," ");a.subarray(1).forEach((d,o)=>{c+=String.fromCharCode(Math.max(32,d))}),c=c.padEnd(16," "),console.debug(`GS patch name: ${c}`)}else i<48||(i<65?a.subarray(1).forEach((c,d)=>{let o=`GS ${i+d>55?"chorus":"reverb"} `;([()=>{console.info(`${o}type: ${qt[c]}`),e.setEffectType(0,40,c),e.dispatchEvent("efxreverb",e.getEffectType(0))},()=>{},()=>{},()=>{},()=>{},()=>{},!1,()=>{console.debug(`${o}predelay: ${c}ms`)},()=>{console.info(`${o}type: ${yr[c]}`),e.setEffectType(1,40,16+c),e.dispatchEvent("efxchorus",e.getEffectType(1))},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{console.debug(`${o}to reverb: ${oe(c)}`)},()=>{console.debug(`${o}to delay: ${oe(c)}`)}][i+d-48]||(()=>{}))()}):i<80?console.debug(`Unknown GS patch address: ${i}`):i<91?a.subarray(1).forEach((c,d)=>{let o="GS delay ";([()=>{console.info(`${o}type: ${vr[c]}`),e.setEffectType(2,40,32+c),e.dispatchEvent("efxdelay",e.getEffectType(2))},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{console.debug(`${o}to reverb: ${oe(c)}`)}][i+d-80]||(()=>{}))()}):console.debug(`Unknown GS patch address: ${i}`))}).add([66,18,64,2],(a,s,h)=>{let i="GS EQ ";a.subarray(1).forEach((c,d)=>{([()=>{console.debug(`${i}low freq: ${[200,400][c]}Hz`)},()=>{console.debug(`${i}low gain: ${c-64}dB`)},()=>{console.debug(`${i}high freq: ${[3e3,6e3][c]}Hz`)},()=>{console.debug(`${i}high gain: ${c-64}dB`)}][a[0]+d]||function(){console.warn(`Unknown GS EQ address: ${a[0]+d}`)})()})}).add([66,18,64,3],(a,s,h)=>{e.dispatchEvent("mupromptex");let i="GS EFX ",c=function(d,o){let u=Cr(t(e,he).subarray(10,12),o,d);u&&console.debug(`${i}${Wt(t(e,he).subarray(10,12))} ${u}`)};a.subarray(1).forEach((d,o)=>{([()=>{e.setEffectTypeRaw(3,!1,32+d),e.dispatchEvent("efxinsert0",e.getEffectType(3))},()=>{e.setEffectTypeRaw(3,!0,d),console.info(`${i}type: ${Wt(t(e,he).subarray(10,12))}`),e.dispatchEvent("efxinsert0",e.getEffectType(3))},!1,c,c,c,c,c,c,c,c,c,c,c,c,c,c,c,c,c,c,c,c,()=>{console.debug(`${i}to reverb: ${oe(d)}dB`)},()=>{console.debug(`${i}to chorus: ${oe(d)}dB`)},()=>{console.debug(`${i}to delay: ${oe(d)}dB`)},!1,()=>{console.debug(`${i}1 source: ${d}`),d&&d<96&&e.allocateAceAll(d)},()=>{console.debug(`${i}1 depth: ${d-64}`)},()=>{console.debug(`${i}2 source: ${d}`),d&&d<96&&e.allocateAceAll(d)},()=>{console.debug(`${i}2 depth: ${d-64}`)},()=>{console.debug(`${i}to EQ: ${d?"ON":"OFF"}`)}][a[0]+o]||function(u,f){console.warn(`Unknown GS EFX address: ${f}`)})(d,a[0]+o)})}).add([66,18,65],(a,s,h)=>{v((a[0]>>4)+1<<1,a[0]&15,a.subarray(1))}).add([69,18,16],(a,s,h)=>{var i;switch(a[0]){case 0:{let c=a[1];e.setLetterDisplay(a.subarray(2),"GS display text",c);break}case 8:{let c=a[1],d=e.modelEx.sc;a.subarray(2).forEach((o,u)=>{([()=>{d.showBar=!(o&1),d.invBar=o>>1&1,d.invDisp=o>>2&1},()=>{d.peakHold=o<4?o:1}][u+c]||(()=>{console.debug("Unsupported GS display type SysEx.")}))()});break}case 32:{x(e,ye,Date.now()+3200),a[1]===0&&(a[2]?(x(e,te,Math.max(Math.min(a[2]-1,9),0)),L()&&console.debug(`GS switch display page ${a[2]-1}.`)):(x(e,te,0),x(e,ye,Date.now()),L()&&console.debug("GS disable display page.")));break}default:if(a[0]<6){t(e,te)>9&&x(e,te,0);let c=a[0]-1<<1|a[1]>>6;t(e,te)===c&&x(e,ye,Date.now()+3200),(i=t(e,Ae)[c])!=null&&i.length||(t(e,Ae)[c]=new Uint8Array(256));let d=t(e,Ae)[c];L()&&console.debug(`GS frame draw page ${c}.`);let o=a[1]&63;d.fill(0),a.subarray(2).forEach(function(f,b){let k=b+o,M=Math.floor(k/16),P=k%16,O=(P*4+M)*5,z=5,_=0;for(O-=P*4,M===3&&(z=1);_<z;)d[O+_]=f>>4-_&1,_++})}else console.warn(`Unknown GS display section: ${a[0]}`)}}).add([69,18,32],(a,s,h)=>{let i=a[0],c=a[1],d=a.subarray(2);if(i>>4){console.warn(`SC-8850 partial screen dump out of bounds: invalid bundle.
`,a);return}let o=c+d.length,u=c*6-(c*2428>>16<<1),f=o*6-(o*2428>>16<<1);if(u>640){console.warn(`SC-8850 partial screen dump out of bounds: invalid buffer range.
`,a);return}f>640&&(console.info(`SC-8850 partial screen dump out of bounds: invalid buffer end, automatically restricted.
`,a),f=640);let b=new Uint8Array(f-u);d.forEach((P,O)=>{let z=O+c,_=(z*2428&65535)*27>>16===26,Fe=z*6-(z*2428>>16<<1),Bt=_?2:0;for(;Bt<6;)b[Fe+(5-Bt)]=P>>Bt&1,Bt++});let k=i*108+c,M=k*6-(k*2428>>16<<1);e.dispatchEvent("screen",{type:"sc8850",offset:M,data:b}),L()&&console.debug(`SC-8850 screen dump: bundle ${i+1}, range ${u}~${f}`)});let y=function(a,s,h){e.dispatchEvent("mupromptex");let i=a[0],c=H[s],d=Nt[s],o=`GS CH${s+1} `;i<3?(a.subarray(1).forEach((u,f)=>{[()=>{t(e,C)[c+w[0]]=u,e.pushChPrimitives(s)},()=>{t(e,I)[s]=u},()=>{let b=0;u<16?b=e.chRedir(u,h,!0):b=E.ch,t(e,Z)[s]=b,s!=b&&(e.buildRchTree(),console.info(`${o}receives from CH${b+1}`))}][i+f]()}),e.dispatchEvent("voice",{part:s})):i<19||(i<44?a.subarray(1).forEach((u,f)=>{([()=>{t(e,ie)[s]=+!u},!1,()=>{e.setChType(s,u<<1,S.gs),console.debug(`${o}type: ${u?"drum ":"melodic"}${u||""}`)},()=>{t(e,D)[d+3]=u,t(e,U)[E.rpnt*s+2]=1,e.dispatchEvent("pitch",{part:s,pitch:e.getPitchShift(s)})},!1,()=>{t(e,C)[c+w[7]]=u},!1,!1,()=>{t(e,C)[c+w[10]]=u||128},!1,!1,()=>{console.debug(`${o}CC 1: cc${u}`)},()=>{console.debug(`${o}CC 2: cc${u}`)},()=>{t(e,C)[c+w[93]]=u},()=>{t(e,C)[c+w[91]]=u},!1,!1,()=>{t(e,D)[d+1]=u,t(e,U)[E.rpnt*s+1]=1,e.dispatchEvent("pitch",{part:s,pitch:e.getPitchShift(s)})},()=>{t(e,D)[d+2]=u,t(e,U)[E.rpnt*s+1]=1,e.dispatchEvent("pitch",{part:s,pitch:e.getPitchShift(s)})},()=>{t(e,C)[c+w[94]]=u}][i+f-19]||(()=>{}))()}):i<76||console.debug(`Unknown GS part address: ${i}`))},$=function(a,s){let h=a[0],i=`GS CH${s+1} `;h<2?a.subarray(1).forEach((c,d)=>{[()=>{e.setChCc(s,32,c)},()=>{}][h+d]()}):h<32?console.warn(`Unknown GS misc address: ${h}`):h<35?a.subarray(1).forEach((c,d)=>{[()=>{console.debug(`${i}EQ: o${["ff","n"][c]}`)},()=>{},()=>{console.debug(`${i}EFX: o${["ff","n"][c]}`),t(e,bt)[s]=c,e.dispatchEvent("partefxtoggle",{part:s,active:c})}][h+d-32]()}):console.warn(`Unknown GS misc address: ${h}`)};t(this,be).add([66,18,64,16],(a,s)=>{y(a,e.chRedir(9,s,!0),s)}).add([66,18,64,17],(a,s)=>{y(a,e.chRedir(0,s,!0),s)}).add([66,18,64,18],(a,s)=>{y(a,e.chRedir(1,s,!0),s)}).add([66,18,64,19],(a,s)=>{y(a,e.chRedir(2,s,!0),s)}).add([66,18,64,20],(a,s)=>{y(a,e.chRedir(3,s,!0),s)}).add([66,18,64,21],(a,s)=>{y(a,e.chRedir(4,s,!0),s)}).add([66,18,64,22],(a,s)=>{y(a,e.chRedir(5,s,!0),s)}).add([66,18,64,23],(a,s)=>{y(a,e.chRedir(6,s,!0),s)}).add([66,18,64,24],(a,s)=>{y(a,e.chRedir(7,s,!0),s)}).add([66,18,64,25],(a,s)=>{y(a,e.chRedir(8,s,!0),s)}).add([66,18,64,26],(a,s)=>{y(a,e.chRedir(10,s,!0),s)}).add([66,18,64,27],(a,s)=>{y(a,e.chRedir(11,s,!0),s)}).add([66,18,64,28],(a,s)=>{y(a,e.chRedir(12,s,!0),s)}).add([66,18,64,29],(a,s)=>{y(a,e.chRedir(13,s,!0),s)}).add([66,18,64,30],(a,s)=>{y(a,e.chRedir(14,s,!0),s)}).add([66,18,64,31],(a,s)=>{y(a,e.chRedir(15,s,!0),s)}).add([66,18,64,64],(a,s)=>{$(a,e.chRedir(9,s,!0))}).add([66,18,64,65],(a,s)=>{$(a,e.chRedir(0,s,!0))}).add([66,18,64,66],(a,s)=>{$(a,e.chRedir(1,s,!0))}).add([66,18,64,67],(a,s)=>{$(a,e.chRedir(2,s,!0))}).add([66,18,64,68],(a,s)=>{$(a,e.chRedir(3,s,!0))}).add([66,18,64,69],(a,s)=>{$(a,e.chRedir(4,s,!0))}).add([66,18,64,70],(a,s)=>{$(a,e.chRedir(5,s,!0))}).add([66,18,64,71],(a,s)=>{$(a,e.chRedir(6,s,!0))}).add([66,18,64,72],(a,s)=>{$(a,e.chRedir(7,s,!0))}).add([66,18,64,73],(a,s)=>{$(a,e.chRedir(8,s,!0))}).add([66,18,64,74],(a,s)=>{$(a,e.chRedir(10,s,!0))}).add([66,18,64,75],(a,s)=>{$(a,e.chRedir(11,s,!0))}).add([66,18,64,76],(a,s)=>{$(a,e.chRedir(12,s,!0))}).add([66,18,64,77],(a,s)=>{$(a,e.chRedir(13,s,!0))}).add([66,18,64,78],(a,s)=>{$(a,e.chRedir(14,s,!0))}).add([66,18,64,79],(a,s)=>{$(a,e.chRedir(15,s,!0))}),t(this,Me).add([54,65],(a,s)=>{let h=t(e,B).x5==="81"?"05rw":"x5d";e.switchMode(h,!0),e.setPortMode(e.getTrackPort(s),1,S[h]);let i=a[a.length-1],c=a.subarray(0,a.length-1),d=Ie(c);d!=i&&(console.info(`X5D multi parameters checksum mismatch! Expected ${d}, got ${i}.`),console.debug(a));let o=(a[1]<<7)+a[0],u=(a[3]<<7)+a[2],f=e.chRedir(o&15,s,!0),b=H[f];[()=>{u<1||(u<101?(e.setChType(f,e.CH_MELODIC,S.x5d),t(e,I)[f]=u-1,t(e,C)[b+w[0]]=t(e,B).x5):u<229?(e.setChType(f,e.CH_MELODIC,S.x5d),t(e,I)[f]=u-101,t(e,C)[b+w[0]]=56):(e.setChType(f,e.CH_DRUMS,S.x5d),t(e,I)[f]=Pr[u-229]||0,t(e,C)[b+w[0]]=62)),e.pushChPrimitives(f),e.dispatchEvent("voice",{part:f})},()=>{t(e,C)[b+w[7]]=u},()=>{u<31&&(t(e,C)[b+w[10]]=Math.round((u-15)*4.2+64))},()=>{t(e,C)[b+w[93]]=Tt(u)},()=>{t(e,C)[b+w[91]]=Tt(u)},()=>{t(e,D)[f*E.rpn+3]=u>8191?u-16320:64+u,t(e,U)[E.rpnt*f+2]=1,e.dispatchEvent("pitch",{part:f,pitch:e.getPitchShift(f)})},()=>{t(e,D)[f*E.rpn+1]=u>8191?u-16320:64+u,t(e,U)[E.rpnt*f+1]=1,e.dispatchEvent("pitch",{part:f,pitch:e.getPitchShift(f)})},()=>{u>0&&(t(e,D)[f*E.rpn]=u,t(e,U)[E.rpnt*f]=1,e.dispatchEvent("pitch",{part:f,pitch:e.getPitchShift(f)}))},()=>{}][o>>4]()}).add([54,76,0],(a,s)=>{e.dispatchEvent("mupromptex");let h=t(e,B).x5==="81"?"05rw":"x5d";e.switchMode(h),e.setPortMode(e.getTrackPort(s),1,S[h]);let i="",c=t(e,B).x5,d=0,o=0,u="MSB	PRG	LSB	NME";Ee(a,function(f,b){if(b<16400){let k=b%164;switch(!0){case k<10:{f>31&&(i+=String.fromCharCode(f));break}case k===10:break;case k===11:{u+=`
${c}	${d}	${o}	${i.trim().replace("Init Voice","")}`,d++,i="";break}}d>99&&(c=90,d=0)}}),e.userBank.clearRange({msb:t(e,B).x5,prg:[0,99],lsb:0}),e.userBank.load(u),L()&&console.debug(u),e.forceVoiceRefresh()}).add([54,77,0],(a,s)=>{e.dispatchEvent("mupromptex");let h=t(e,B).x5==="81"?"05rw":"x5d";e.switchMode(h),e.setPortMode(e.getTrackPort(s),1,S[h]);let i="",c=90,d=0,o=0,u="MSB	PRG	LSB	NME";Ee(a,function(f,b){if(b<13600){let k=b%136;switch(!0){case k<10:{f>31&&(i+=String.fromCharCode(f));break}case k===11:{u+=`
${c}	${d}	${o}	${i.trim().replace("Init Combi","")}`,d++,i="";break}}}}),e.userBank.clearRange({msb:90,prg:[0,99],lsb:0}),e.userBank.load(u),L()&&console.debug(u),e.forceVoiceRefresh()}).add([54,78],(a,s)=>{let h=t(e,B).x5==="81"?"05rw":"x5d";e.switchMode(h),e.setPortMode(e.getTrackPort(s),1,S[h]),console.debug(`X5D mode switch requested: ${["combi","combi edit","prog","prog edit","multi","global"][a[0]]} mode.`)}).add([54,85],(a,s)=>{e.dispatchEvent("mupromptex");let h=t(e,B).x5==="81"?"05rw":"x5d";e.switchMode(h),e.setPortMode(e.getTrackPort(s),1,S[h]),Ee(a,(i,c)=>{c>0&&c<3&&(e.setEffectType(c-1,44,i),e.dispatchEvent(`efx${["reverb","chorus"][c-1]}`,e.getEffectType(c-1)))})}).add([54,104],(a,s)=>{e.dispatchEvent("mupromptex");let h=t(e,B).x5==="81"?"05rw":"x5d";e.switchMode(h,!0);let i=e.getTrackPort(s);if(t(e,Y)[i]&&t(e,Y)[i]!=S[h])if(t(e,Se).dumpLimit===e.DUMP_MODE){console.warn(`Dump cancelled for track ${s}. Port ${String.fromCharCode(65+i)} mode "${W[t(e,Y)[i]]}" mismatch, should be "${h}".`);return}else console.info(`Track ${s} is trying to perform a mismached mode dump on port ${String.fromCharCode(65+i)}.`);e.setPortMode(i,1,S[h]),Ee(a,function(c,d,o,u){if(d<192){let f=e.chRedir(Math.floor(d/12),s,!0),b=H[f];switch(d%12){case 0:{c<128?(e.setChType(f,e.CH_MELODIC,S.x5d),t(e,C)[b+w[0]]=t(e,B).x5,t(e,I)[f]=c):(e.setChType(f,e.CH_DRUMS,S.x5d),t(e,C)[b+w[0]]=62,t(e,I)[f]=Pr[c-128]),c>0&&e.setChActive(f,1),e.pushChPrimitives(f),e.dispatchEvent("voice",{part:f});break}case 1:{t(e,C)[b+w[7]]=c;break}case 2:{t(e,D)[f*E.rpn+3]=c>127?c-192:64+c,t(e,U)[E.rpnt*f+2]=1,e.dispatchEvent("pitch",{part:f,pitch:e.getPitchShift(f)});break}case 3:{t(e,D)[f*E.rpn+1]=c>127?c-192:64+c,t(e,U)[E.rpnt*f+1]=1,e.dispatchEvent("pitch",{part:f,pitch:e.getPitchShift(f)});break}case 4:{c<31&&(t(e,C)[b+w[10]]=Math.round((c-15)*4.2+64));break}case 5:{let k=c>>4,M=c&15;t(e,C)[b+w[91]]=Tt(M),t(e,C)[b+w[93]]=Tt(k);break}case 10:{t(e,A)[f]||(t(e,C)[b+w[0]]=c>>6?56:t(e,B).x5,e.pushChPrimitives(f),e.dispatchEvent("voice",{part:f}));break}case 11:{let k=e.chRedir(c&15,s,!0),M=c>>4;t(e,Z)[f]=c,(k!=f||M)&&(console.info(`X5D Part CH${f+1} receives from CH${k+1}.`),e.buildRchTree())}}}else{let f=e.chRedir(d-192,s,!0)}})}),t(this,be).add([22,18,127],(a,s,h)=>{e.switchMode("mt32",!0),e.setPortMode(e.getTrackPort(s),1,S.mt32),x(e,X,e.KARAOKE_NONE),e.userBank.clearRange({msb:0,lsb:127,prg:[0,127]}),console.info("MIDI reset: MT-32")}).add([22,18,0],(a,s,h)=>{e.switchMode("mt32");let i=e.chRedir(h,s,!0),c=a[1];a.subarray(2).forEach((d,o)=>{let u=o+c;t(e,Be)[u+(i-1)*16]=d,([!1,()=>{let f=t(e,Be)[i-1<<4];if(f<3){if(t(e,Ce)[i]=1,f===2)for(let b=0;b<name.length;b++)t(e,we)[(i-1)*E.cmt+b]=t(e,Ue)[d*E.cmt+b];else{let b=e.baseBank.get(0,d+(f<<6),127,"mt32").name;for(let k=0;k<b.length;k++)t(e,we)[(i-1)*E.cmt+k]=b.charCodeAt(k)}e.dispatchEvent("voice",{part:i})}},()=>{t(e,D)[i*E.rpn+3]=d+40,t(e,U)[E.rpnt*i+2]=1},()=>{t(e,D)[i*E.rpn+1]=d+14,t(e,U)[E.rpnt*i+1]=1},()=>{t(e,D)[i*E.rpn]=d,t(e,U)[E.rpnt*i]=1},!1,()=>{e.setChCc(i,91,d?127:0)},!1,()=>{e.setChCc(i,7,d)},()=>{e.setChCc(i,10,Math.ceil(d*9.05))}][u]||(()=>{}))()})}).add([22,18,1],(a,s,h)=>{e.switchMode("mt32");let i=h&7;console.debug(`MT-32 slot #${h+1} Drum: ${a}`);let c=a[0]<<7|a[1];a.subarray(2).forEach((d,o)=>{let u=o+c,f=(u>>2)+24,b=u&3,k=i*E.dpn;if(L()&&console.debug(`MT-32 temp drum note ${f} param ${b}: ${d}`),f<24){console.warn(`MT-32 dev drum write attempted on an OOB note: ${f}`);return}[()=>{},()=>{t(e,ne)[(k+ge[26])*E.dnc+f]=Math.round(d*1.27)},()=>{t(e,ne)[(k+ge[26])*E.dnc+f]=d*9+1&127},()=>{t(e,ne)[(k+ge[26])*E.dnc+f]=d?127:0}][b]()})}).add([22,18,2],(a,s,h)=>{e.switchMode("mt32");let i=e.chRedir(h,s,!0),c=a[1]+(a[0]<<7);c<10&&(t(e,Ce)[i]=1),a.subarray(2).forEach((d,o)=>{let u=o+c;u<14&&(t(e,we)[(i-1)*E.cmt+u]=d)}),e.dispatchEvent("voice",{part:i})}).add([22,18,3],(a,s,h)=>{e.switchMode("mt32");let i=h&7;if(a[0]){let c=(a[0]-1<<7)+a[1]-16;a.subarray(2).forEach((d,o)=>{let u=o+c,f=(u>>2)+24,b=u&3,k=i*E.dpn;if(L()&&console.debug(`MT-32 dev drum note ${f} param ${b}: ${d}`),f<24){console.warn(`MT-32 dev drum write attempted on an OOB note: ${f}`);return}[()=>{},()=>{t(e,ne)[(k+ge[26])*E.dnc+f]=Math.round(d*1.27)},()=>{t(e,ne)[(k+ge[26])*E.dnc+f]=d*9+1&127},()=>{t(e,ne)[(k+ge[26])*E.dnc+f]=d?127:0}][b]()})}else{let c=a[1];a.subarray(2).forEach((d,o)=>{let u=o+c;t(e,Be)[u]=d;let f=e.chRedir(1+(u>>4),s,!0),b=u&15;([!1,()=>{let k=t(e,Be)[f-1<<4];if(k<3)if(t(e,Ce)[f]=1,k===2)for(let M=0;M<name.length;M++)t(e,we)[(f-1)*E.cmt+M]=t(e,Ue)[d*E.cmt+M];else{let M=e.baseBank.get(0,d+(k<<6),127,"mt32").name;for(let P=0;P<M.length;P++)t(e,we)[(f-1)*E.cmt+P]=M.charCodeAt(P)}e.dispatchEvent("voice",{part:f})},()=>{t(e,D)[f*E.rpn+3]=d+40,t(e,U)[E.rpnt*f+2]=1},()=>{t(e,D)[f*E.rpn+1]=d+14,t(e,U)[E.rpnt*f+1]=1},()=>{t(e,D)[f*E.rpn]=d,t(e,U)[E.rpnt*f]=1},!1,()=>{e.setChCc(f,91,d?127:0)},!1,()=>{e.setChCc(f,7,d)},()=>{e.setChCc(f,10,Math.ceil(d*9.05))}][b]||(()=>{}))()})}}).add([22,18,4],(a,s,h)=>{e.switchMode("mt32");let i=a[1]+(a[0]<<7),c=[];a.subarray(2).forEach((d,o)=>{let u=o+i,f=e.chRedir(Math.floor(u/246+1),s,!0),b=u%246;b<14&&(t(e,we)[(f-1)*E.cmt+b]=d),b<10&&(t(e,Ce)[f]=1),c.indexOf(f)<0&&c.push(f)}),c.forEach(d=>{e.dispatchEvent("voice",{part:d})})}).add([22,18,5],(a,s,h)=>{e.switchMode("mt32");let i=(a[0]<<7)+a[1];a.subarray(2).forEach((c,d)=>{let o=i+d,u=Math.floor(o/8),f=o&7,b=u*8;t(e,Et)[o]=c,([!1,()=>{let k=t(e,Et)[b];if(k<3){let M="";if(k===2){let O=E.cmt*u;M=`MT-m:${c.toString().padStart(3,"0")}`}else M=e.baseBank.get(0,c+(k<<6),127,"mt32").name;e.userBank.clearRange({msb:0,lsb:127,prg:u});let P=`MSB	LSB	PRG	NME
49	127	${u}	${M}`;e.userBank.load(P,!0)}}][f]||(()=>{}))()}),e.forceVoiceRefresh()}).add([22,18,8],(a,s,h)=>{e.switchMode("mt32");let i=((a[0]&1)<<7)+a[1],c=a[0]>>1,d=!1;if(a.subarray(2).forEach((o,u)=>{let f=i+u;f<E.cmt&&(t(e,Ue)[c*E.cmt+f]=o,d=!0)}),d){e.userBank.clearRange({msb:0,lsb:127,prg:c});let o=`MSB	LSB	PRG	NME
49	127	${c}	MT-m:${c}`;e.userBank.load(o,!0)}e.forceVoiceRefresh()}).add([22,18,16],(a,s,h)=>{e.switchMode("mt32");let i=a[1],c=!1,d=function(o,u){t(e,Z)[u-12]=o,c=!0};a.subarray(2).forEach((o,u)=>{let f=u+i;([!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,d,d,d,d,d,d,d,d,d,()=>{x(e,F,o),e.dispatchEvent("mastervolume",t(e,F))}][f]||(()=>{}))(o,u)}),c&&e.buildRchTree()}).add([22,18,32],(a,s,h)=>{e.switchMode("mt32");let i=a[1],c=" ".repeat(i);a.subarray(2).forEach(d=>{d>31?c+=String.fromCharCode(d):c+=" "}),x(e,Ne,c.padStart(20," ")),x(e,_e,Date.now()+3200)}).add([22,18,82],(a,s)=>{let h=e.chRedir(0,s,!0);for(let i=0;i<16;i++)t(e,j).ano(h+i),i&&i<10&&(t(e,I)[h+i]=Yt[i-1]);console.info("MT-32 alt reset complete.")}),t(this,Me).add([66,0],(a,s)=>{e.switchMode("ns5r",!0),e.setPortMode(e.getTrackPort(s),2,S.ns5r),x(e,X,e.KARAOKE_NONE),console.debug(`NS5R mode switch requested: ${["global","multi","prog edit","comb edit","drum edit","effect edit"][a[0]]} mode.`)}).add([66,1],(a,s)=>{let h=["ns5r","05rw"][a[0]];e.switchMode(h,!0),e.setPortMode(e.getTrackPort(s),2,S[h]),x(e,X,e.KARAOKE_NONE)}).add([66,18,0,0],(a,s)=>{let h=a[0];switch(h){case 124:case 126:case 127:{e.switchMode("ns5r",!0),e.setPortMode(e.getTrackPort(s),2,S.ns5r),x(e,X,e.KARAOKE_NONE);break}case 125:{e.initDrums(),console.info(`NS5R drum setup reset on drum kit ${a[1]}.`);break}default:if(h<10){let i=[0,0,0,0],c=(d,o)=>{i[o]=d};if(a.subarray(1).forEach((d,o)=>{[c,c,c,c,()=>{x(e,F,d*129/16383*100),e.dispatchEvent("mastervolume",t(e,F))},()=>d-64,()=>d-64,()=>{},()=>{},()=>{}][h+o]()}),a[0]<4){let d=0;i.forEach(o=>{d=d<<4,d+=o}),d-=1024}}}}).add([66,18,0,1],(a,s)=>{}).add([66,18,0,2],(a,s)=>{}).add([66,18,1],(a,s)=>{e.dispatchEvent("mupromptex");let h=e.chRedir(a[0],s,!0),i=H[h],c=a[1],d=`NS5R CH${h+1} `;a.subarray(2).forEach((o,u)=>{let f=c+u;f<3?([()=>{t(e,C)[i+w[0]]=o||ke.bank0,e.pushChPrimitives(h)},()=>{t(e,C)[i+w[32]]=o,e.pushChPrimitives(h)},()=>{t(e,I)[h]=o}][f](),e.dispatchEvent("voice",{part:h})):f<8||(f<14?[()=>{let b=e.chRedir(o,s,!0);t(e,Z)[h]=b,h!=b&&(e.buildRchTree(),console.info(`${d}receives from CH${b+1}`))},()=>{t(e,ie)[h]=+!o},()=>{e.setChType(h,o,S.ns5r),console.debug(`${d}type: ${St[o]}`)},()=>{t(e,D)[E.rpn*h+3]=o,t(e,U)[E.rpnt*h+2]=1,e.dispatchEvent("pitch",{part:h,pitch:e.getPitchShift(h)})},()=>{},()=>{}][f-8]():f<16||(f<33?[()=>{t(e,C)[i+w[7]]=o},()=>{t(e,C)[i+w[11]]=o},()=>{},()=>{},()=>{t(e,C)[i+w[10]]=o||128},()=>{},()=>{},()=>{t(e,C)[i+w[93]]=o},()=>{t(e,C)[i+w[91]]=o},()=>{t(e,C)[i+w[76]]=o},()=>{t(e,C)[i+w[77]]=o},()=>{t(e,C)[i+w[78]]=o},()=>{t(e,C)[i+w[74]]=o},()=>{t(e,C)[i+w[71]]=o},()=>{t(e,C)[i+w[73]]=o},()=>{t(e,C)[i+w[75]]=o},()=>{t(e,C)[i+w[72]]=o}][f-16]():f<112||f<114&&[()=>{t(e,C)[i+w[5]]=o},()=>{t(e,C)[i+w[65]]=o}][f-112]()))})}).add([66,18,8,0],(a,s)=>{let h=a[0];if(h<32)e.setLetterDisplay(a.subarray(1,33),"NS5R letter display");else{let i=h-32;x(e,ye,Date.now()+3200),x(e,te,10),t(e,pe,Re).fill(0);let c=a.subarray(1),d=4;c.forEach(function(o,u){let f=u+i,b=f>>4,k=f&15;if(f<80){let M=b<d?o:o>>3,P=0,O=b<d?6:3;for(;M>0;)t(e,pe,Re)[k*32+b*7+(O-P)]=M&1,M=M>>1,P++}})}}).add([66,18,48],(a,s,h)=>{m(0,a)}).add([66,18,49],(a,s,h)=>{m(1,a)}).add([66,18,50],(a,s,h)=>{m(2,a)}).add([66,18,51],(a,s,h)=>{m(3,a)}).add([66,18,52],(a,s,h)=>{m(4,a)}).add([66,18,53],(a,s,h)=>{m(5,a)}).add([66,18,54],(a,s,h)=>{m(6,a)}).add([66,18,55],(a,s,h)=>{m(7,a)}).add([66,52],(a,s)=>{e.switchMode("ns5r"),x(e,X,e.KARAOKE_NONE);let h="";Ee(a,(i,c)=>{c<8?(i>31&&(h+=String.fromCharCode(i)),c===7&&(e.aiEfxName=h)):c<10&&(e.setEffectType(c-8,44,i),e.dispatchEvent(`efx${["reverb","chorus"][c-8]}`,e.getEffectType(c-8)))})}).add([66,53],(a,s)=>{e.dispatchEvent("mupromptex"),e.switchMode("ns5r"),x(e,X,e.KARAOKE_NONE);let h="",i=a[a.length-1],c=a.subarray(0,a.length-1),d=Ie(c);d!=i&&(console.info(`NS5R current multi dump checksum mismatch! Expected ${d}, got ${i}.`),console.debug(a));let o=e.getTrackPort(s);if(t(e,Y)[o]&&t(e,Y)[o]!=S.ns5r)if(t(e,Se).dumpLimit===e.DUMP_MODE){console.warn(`Dump cancelled for track ${s}. Port ${String.fromCharCode(65+o)} mode "${W[t(e,Y)[o]]}" mismatch, should be "ns5r".`);return}else console.info(`Track ${s} is trying to perform a mismached mode dump on port ${String.fromCharCode(65+o)}.`);e.setPortMode(o,2,S.ns5r),Ee(c,function(u,f){switch(!0){case f<2944:{let b=e.chRedir(Math.floor(f/92),s,!0),k=H[b];switch(f%92){case 0:{t(e,C)[k+w[0]]=u,e.pushChPrimitives(b),e.dispatchEvent("voice",{part:b});break}case 1:{t(e,C)[k+w[32]]=u,!u&&!t(e,C)[k+w[0]]&&(t(e,C)[k+w[0]]=ke.bank0),e.pushChPrimitives(b),e.dispatchEvent("voice",{part:b});break}case 2:{t(e,I)[b]=u,u>0&&e.setChActive(b,1),e.dispatchEvent("voice",{part:b});break}case 3:{let M=e.chRedir(u,s,!0);t(e,Z)[b]=M,b!=M&&(console.info(`NS5R CH${b+1} receives from CH${M+1}.`),e.buildRchTree());break}case 7:{t(e,A)[b]=u,e.dispatchEvent("voice",{part:b});break}case 8:{t(e,D)[b*E.rpn+3]=u<40||u>88?u+(u>63?-192:64):u,t(e,U)[E.rpnt*b+2]=1,e.dispatchEvent("pitch",{part:b,pitch:e.getPitchShift(b)});break}case 9:case 10:{t(e,C)[k+w[7]]=u;break}case 11:{t(e,C)[k+w[11]]=u;break}case 14:{t(e,C)[k+w[10]]=u||128;break}case 19:{t(e,C)[k+w[93]]=u;break}case 20:{t(e,C)[k+w[91]]=u;break}case 84:{t(e,C)[k+w[65]]=u;break}case 85:{t(e,C)[k+w[5]]=u;break}}break}case f<3096:break;case f<3134:{let b=f-3096;b<8?(u>31&&(h+=String.fromCharCode(u)),b===7&&(e.aiEfxName=h)):b<10&&(e.setEffectType(b-8,44,u),e.dispatchEvent(`efx${["reverb","chorus"][b-8]}`,e.getEffectType(b-8)));break}case f<8566:break}})}).add([66,54],(a,s)=>{e.dispatchEvent("mupromptex"),e.switchMode("ns5r");let h="",i=80,c=0,d=0,o="MSB	PRG	LSB	NME";Ee(a,function(u,f){let b=f%158;switch(!0){case b<10:{u>31&&(h+=String.fromCharCode(u));break}case b===10:break;case b===11:{i=u&127;break}case b===12:{d=u&127;break}case b===13:{o+=`
${i}	${c}	${d}	${h.trim().replace("Init Voice","")}`,c++,h="";break}}}),e.userBank.clearRange({msb:80,lsb:0}),e.userBank.load(o),L()&&console.debug(o),e.forceVoiceRefresh()}).add([66,55],(a,s)=>{e.dispatchEvent("mupromptex"),e.switchMode("ns5r");let h="",i=88,c=0,d=0,o="MSB	PRG	LSB	NME";Ee(a,function(u,f){let b=f%126;switch(!0){case b<10:{u>31&&(h+=String.fromCharCode(u));break}case b===11:break;case b===12:break;case b===13:{o+=`
${i}	${c}	${d}	${h.trim().replace("Init Combi","")}`,c++,h="";break}}}),e.userBank.clearRange({msb:88,lsb:0}),e.userBank.load(o),L()&&console.debug(o),e.forceVoiceRefresh()}).add([66,125],(a,s,h)=>{e.dispatchEvent("backlight",["green","orange","red",!1,"yellow","blue","purple"][a[0]]||"white")}).add([66,127],(a,s,h)=>{let i=a[a.length-1],c=a.subarray(0,a.length-1),d=Ie(c);d!=i&&(console.info(`NS5R screen dump checksum mismatch! Expected ${d}, got ${i}.`),console.debug(a));let o=new Uint8Array(5760);Ee(a,(u,f,b)=>{if(f<720)for(let k=0;k<8;k++)o[f*8+k]=u>>7-k&1}),e.dispatchEvent("screen",{type:"ns5r",data:o})}).add([76],(a,s,h)=>{t(e,Me).run([66,...a],s,h)}),t(this,at).add([16,0,8,0],(a,s,h)=>{let i=(a[2]<<4)+a[3],c="K11 ";([()=>{e.switchMode("k11",!0),e.setPortMode(e.getTrackPort(s),2,S.k11),x(e,X,e.KARAOKE_NONE),t(e,Q)[S.k11][1]=i?4:0,console.info("MIDI reset: GMega/K11")},()=>{e.setEffectType(0,24,i),console.debug(`${c}reverb type: ${i}`),e.dispatchEvent("efxreverb",e.getEffectType(0))},()=>{console.debug(`${c}reverb time: ${i}`)},()=>{console.debug(`${c}reverb time: ${i}`)},()=>{console.debug(`${c}reverb predelay: ${i}`)},()=>{console.debug(`${c}reverb predelay: ${i}`)},()=>{console.debug(`${c}depth high: ${i}`)},()=>{console.debug(`${c}depth high: ${i}`)},()=>{console.debug(`${c}depth low: ${i}`)},()=>{console.debug(`${c}depth low: ${i}`)}][a[0]]||(()=>{}))()}).add([16,0,8,1],(a,s,h)=>{e.dispatchEvent("mupromptex");let i=e.chRedir(a[1],s,!0),c=H[i],d=Nt[i],o=(a[3]<<4)+a[4],u=`K11 CH${i+1} `;([()=>{o<128?(e.setChType(i,e.CH_MELODIC,S.k11),t(e,C)[c+w[0]]=0,t(e,I)[i]=o):(e.setChType(i,e.CH_DRUMS,S.k11),t(e,I)[i]=o-128),e.pushChPrimitives(i),e.dispatchEvent("voice",{part:i})},()=>{let f=e.chRedir(o,s,!0);t(e,Z)[i]=f,i!=f&&(e.buildRchTree(),console.info(`${u}receives from CH${f+1}`))},()=>{t(e,C)[c+w[7]]=o},()=>{uupThis.setChActive(i,o)},()=>{t(e,C)[c+w[10]]=o},()=>{t(e,D)[d+3]=o+40,t(e,U)[E.rpnt*i+2]=1,e.dispatchEvent("pitch",{part:i,pitch:e.getPitchShift(i)})},()=>{t(e,D)[d+1]=o>>1,t(e,D)[d+2]=o&1,t(e,U)[E.rpnt*i+1]=1,e.dispatchEvent("pitch",{part:i,pitch:e.getPitchShift(i)})},()=>{t(e,C)[c+w[91]]=o?127:0},()=>{},()=>{t(e,C)[c+w[74]]=o},()=>{t(e,C)[c+w[73]]=o},()=>{t(e,C)[c+w[72]]=o}][a[0]]||(()=>{}))()}).add([16,0,9,0],(a,s,h)=>{e.dispatchEvent("mupromptex");let i=(a[2]<<4)+a[3],c="GMLX ";([()=>{console.debug(`${c}reverb type: ${i}`)},()=>{console.debug(`${c}reverb time: ${i}`)},()=>{console.debug(`${c}reverb predelay: ${i}`)},()=>{console.debug(`${c}depth high: ${i}`)},()=>{console.debug(`${c}depth low: ${i}`)}][a[0]]||(()=>{}))()}).add([16,0,9,3],(a,s,h)=>{e.dispatchEvent("mupromptex");let i=(a[2]<<4)+a[3],c=e.chRedir(a[1],s,!0),d=H[c];[()=>{i<128?(e.setChType(c,e.CH_MELODIC,S.k11),t(e,C)[d+w[0]]=0,t(e,C)[d+w[32]]=0,t(e,I)[c]=i):i<160?(e.setChType(c,e.CH_MELODIC,S.k11),t(e,C)[d+w[0]]=0,t(e,C)[d+w[32]]=7,t(e,I)[c]=i-100):(e.setChType(c,e.CH_DRUMS,S.k11),t(e,C)[d+w[0]]=122,t(e,C)[d+w[32]]=0,t(e,I)[c]=i-160),e.pushChPrimitives(c),e.dispatchEvent("voice",{part:c})},()=>{let o=e.chRedir(i,s,!0);t(e,Z)[c]=o,c!=o&&(e.buildRchTree(),console.info(`GMLX CH${c+1} receives from CH${o+1}`))}][a[0]]()}).add([16,0,9,4],(a,s,h)=>{e.dispatchEvent("mupromptex");let i=(a[2]<<4)+a[3],c=e.chRedir(a[1],s,!0),d=H[c],o=Nt[c],u=`GMLX CH${c+1} `;[()=>{e.setChActive(c,i)},()=>{t(e,C)[d+w[7]]=i},()=>{t(e,C)[d+w[10]]=i},()=>{t(e,C)[d+w[91]]=i?127:0},()=>{t(e,D)[o+3]=i+40,t(e,U)[E.rpnt*c+2]=1,e.dispatchEvent("pitch",{part:c,pitch:e.getPitchShift(c)})},()=>{t(e,D)[o+1]=i,t(e,U)[E.rpnt*c+1]=1,e.dispatchEvent("pitch",{part:c,pitch:e.getPitchShift(c)})},()=>{t(e,D)[o]=i,t(e,U)[E.rpnt*c]=1,e.dispatchEvent("pitch",{part:c,pitch:e.getPitchShift(c)})},()=>{}][a[0]]()}),t(this,st).add([66,93,64],(a,s,h)=>{let i=a[2];switch(a[0]){case 0:{switch(a[1]){case 4:{e.dispatchEvent("mupromptex"),x(e,F,i*129/16383*100),e.dispatchEvent("mastervolume",t(e,F));break}case 5:{e.dispatchEvent("mupromptex"),i-64;break}case 6:{e.dispatchEvent("mupromptex"),console.debug(`SG global reverb: ${i?"on":"off"}`);break}case 127:{e.switchMode("sg",!0),e.setPortMode(e.getTrackPort(s),1,S.sg);break}}break}case 1:{switch(a[1]){case 48:{e.dispatchEvent("mupromptex"),console.debug(`SG reverb type: ${qt[i]}`);break}}break}default:if(a[0]>>4===1){e.dispatchEvent("mupromptex");let c=e.chRedir(a[0]&15,s,!0);if(a[1]===2){let d=e.chRedir(i,s,!0);t(e,Z)[c]=d,c!=d&&(e.buildRchTree(),console.info(`SG CH${c+1} receives from CH${d+1}`))}else a[1]===19&&e.setChCc(c,7,i)}else console.warn(`Unknown AKAI SG SysEx: ${a}`)}}),t(this,it).add([9],(a,s,h)=>{e.dispatchEvent("mupromptex"),console.debug(`GZ set effect: ${["stage reverb","hall reverb","room reverb","chorus","tremolo","phaser","rotary speaker","enhancer","flanger","EQ"][a[0]]||"off"}`)}),t(this,ue).add([127,0],(a,s,h)=>{e.switchMode("motif");let i=new Uint8Array([127,1,...a]);t(e,ue).run(i,s,h)}).add([127,1,0,0],(a,s,h)=>{e.switchMode("s90es");let i="S90/Motif ES system ",c=a[0];a.subarray(1).forEach((d,o)=>{([()=>{x(e,F,d*12900/16383),e.dispatchEvent("mastervolume",t(e,F))}][c+o]||(()=>{console.info(`Unrecognized ${i}ID: ${c+o}`)}))()})}).add([127,1,0,36,54,1],(a,s,h)=>{e.switchMode("s90es");let i="S90/Motif ES reverb ",c=a[0];a.subarray(1).forEach((d,o)=>{([()=>{e.setEffectTypeRaw(0,!1,d&15|128)},()=>{e.setEffectTypeRaw(0,!0,d)}][c+o]||(()=>{}))()}),e.dispatchEvent("efxreverb",e.getEffectType(0))}).add([127,1,0,37,54,2],(a,s,h)=>{e.switchMode("s90es");let i="S90/Motif ES chorus ",c=a[0];a.subarray(1).forEach((d,o)=>{([()=>{e.setEffectTypeRaw(1,!1,d&15|128)},()=>{e.setEffectTypeRaw(1,!0,d)}][c+o]||(()=>{}))()}),e.dispatchEvent("efxchorus",e.getEffectType(1))}).add([127,1,0,34,54,3],(a,s,h)=>{e.switchMode("s90es");let i="S90/Motif ES insert 1 ",c=a[0];a.subarray(1).forEach((d,o)=>{([()=>{e.setEffectTypeRaw(3,!1,d&15|128)},()=>{e.setEffectTypeRaw(3,!0,d)}][c+o]||(()=>{}))()}),e.dispatchEvent("efxinsert0",e.getEffectType(3))}).add([127,1,0,34,54,4],(a,s,h)=>{e.switchMode("s90es");let i="S90/Motif ES insert 2 ",c=a[0];a.subarray(1).forEach((d,o)=>{([()=>{e.setEffectTypeRaw(4,!1,d&15|128)},()=>{e.setEffectTypeRaw(4,!0,d)}][c+o]||(()=>{}))()}),e.dispatchEvent("efxinsert1",e.getEffectType(4))}).add([127,1,0,35,54,17],(a,s,h)=>{e.switchMode("s90es");let i="S90/Motif ES variation ",c=a[0];a.subarray(1).forEach((d,o)=>{([()=>{e.setEffectTypeRaw(2,!1,d&15|128)},()=>{e.setEffectTypeRaw(2,!0,d)}][c+o]||(()=>{}))()}),e.dispatchEvent("efxdelay",e.getEffectType(2))}).add([127,1,0,58,55],(a,s,h)=>{e.dispatchEvent("mupromptex"),e.switchMode("s90es");let i=e.getTrackPort(s);if(t(e,Y)[i]&&t(e,Y)[i]!=t(e,B).smotif)if(t(e,Se).dumpLimit===e.DUMP_MODE){console.warn(`Dump cancelled for track ${s}. Port ${String.fromCharCode(65+i)} mode "${W[t(e,Y)[i]]}" mismatch, should be "${W[t(e,B).smotif]}".`);return}else console.info(`Track ${s} is trying to perform a mismached mode dump on port ${String.fromCharCode(65+i)}.`);let c=e.chRedir(a[0],s,!0),d=H[c],o=a[1];a[0]>15&&(c=a[0]+32);let u=`Track ${s} S90/Motif ES bulk CH${c<128?c+1:"U"+(c-127)} `;console.debug(u,a),!(a[0]>15)&&a.subarray(2).forEach((f,b)=>{([()=>{t(e,C)[d+w[0]]=f,e.pushChPrimitives(c),e.dispatchEvent("voice",{part:c})},()=>{f&&e.setChActive(c,1),t(e,C)[d+w[32]]=f,e.getChPrimitive(c,1)===63&&e.setChType(c,[32,40].indexOf(f)>-1?e.CH_DRUMS:e.CH_MELODIC,t(e,G),!0),e.pushChPrimitives(c),e.dispatchEvent("voice",{part:c})},()=>{f&&e.setChActive(c,1),t(e,I)[c]=f,e.dispatchEvent("voice",{part:c})},()=>{let k=e.chRedir(f,s,!0);t(e,Z)[c]=k,c!=k&&(e.buildRchTree(),console.info(`${u}receives from CH${k+1}`))},()=>{t(e,ie)[c]=f?0:1},!1,!1,!1,!1,!1,!1,!1,!1,()=>{f!=100&&e.setChActive(c,1),t(e,C)[d+w[7]]=f},()=>{f!=64&&e.setChActive(c,1),t(e,C)[d+w[10]]=f},!1,!1,!1,()=>{t(e,C)[d+w[91]]=f},()=>{f&&e.setChActive(c,1),t(e,C)[d+w[93]]=f},()=>{f&&e.setChActive(c,1),t(e,C)[d+w[94]]=f},()=>{e.setChCc(c,128,f),f!=127&&(e.setChActive(c,1),e.allocateAce(c,128))},()=>{},()=>{f!=64&&e.setChActive(c,1),t(e,C)[d+w[74]]=f},()=>{f!=64&&e.setChActive(c,1),t(e,C)[d+w[71]]=f},!1,()=>{t(e,C)[d+w[65]]=f},()=>{t(e,C)[d+w[5]]=f},()=>{}][o+b]||(()=>{}))()})}).add([127,1,54,16],(a,s,h)=>{e.switchMode("s90es");let i=a[0];a.subarray(1).forEach((c,d)=>{let u=`S90/Motif ES EQ${(d>>2)+1} `;([()=>{let f=c-64},()=>{let f=ut[c]},()=>{let f=c/10},()=>{let f=c}][i+d&3]||(()=>{}))()})}),t(this,be).add([0,72,18,0,0,0,0],(a,s,h)=>{e.switchMode("sd",!0),e.setPortMode(e.getTrackPort(s),2,S.sd),console.info("MIDI reset: SD")}).add([0,72,18,16,0],(a,s,h)=>{e.dispatchEvent("mupromptex");let i=a[0]>>5,c=a[0]&31;switch(i){case 0:{let d=a[0]>>1,o=a[1];switch(d){case 1:{a.subarray(2).forEach((u,f,b)=>{let k=f+o;switch(k){case 0:{u&&(e.setEffectType(1,60,u-1),e.dispatchEvent("efxchorus",e.getEffectType(1)),console.debug(`SD MFX Cho: ${k} - ${u}`));break}}});break}case 2:{a.subarray(2).forEach((u,f)=>{let b=f+o;switch(b){case 0:{u&&(e.setEffectType(0,55+u,0),e.dispatchEvent("efxreverb",e.getEffectType(0)),console.debug(`SD MFX Rev: ${b} - ${u}`));break}}});break}case 3:case 4:case 5:{let u=d-1;a.subarray(2).forEach((f,b)=>{let k=b+o;switch(console.debug(`SD MFX ${u-2}: ${k} - ${f}`),k){case 0:{e.setEffectTypeRaw(u,62,f),e.dispatchEvent(`efx${u>2?"delay":"insert"+(u-4)}`,e.getEffectType(u));break}}}),console.debug(`SD MFX message:
%o`,a);break}default:console.debug(`Unknown SD-90 global effects message:
%o`,a)}break}case 1:{let d=e.chRedir(c,s,!0),o=a[1],u=H[d];a.subarray(2).forEach((f,b)=>{let k=o+b;k<37?([()=>{},()=>{},0,()=>{},()=>{switch(f){case 104:case 105:case 106:case 107:case 120:{t(e,A)[d]||e.setChType(d,e.CH_DRUMS);break}default:t(e,A)[d]&&e.setChType(d,e.CH_MELODIC)}e.setChCc(d,0,f),e.pushChPrimitives(d),e.dispatchEvent("voice",{part:d})},()=>{t(e,C)[u+w[32]]=f,e.pushChPrimitives(d),e.dispatchEvent("voice",{part:d})},()=>{t(e,I)[d]=f,e.dispatchEvent("voice",{part:d})},()=>{t(e,C)[u+w[7]]=f},()=>{t(e,C)[u+w[10]]=f},()=>{},()=>{},()=>{f<2&&(t(e,ie)[d]=f)},()=>{f<2&&(t(e,C)[u+w[68]]=f?127:0)},()=>{},()=>{f<2&&(t(e,C)[u+w[65]]=f?127:0)},()=>{t(e,C)[u+w[5]]=f&15<<4|t(e,C)[u+w[5]]&15},()=>{t(e,C)[u+w[5]]=f&15|(t(e,C)[u+w[5]]&240)>>4},()=>{t(e,C)[u+w[74]]=f},()=>{t(e,C)[u+w[71]]=f},()=>{t(e,C)[u+w[73]]=f},()=>{t(e,C)[u+w[72]]=f},0,0,0,0,0,0,0,()=>{t(e,C)[u+w[128]]=f,e.allocateAce(128)},()=>{t(e,C)[u+w[93]]=f},()=>{t(e,C)[u+w[91]]=f},0,0,()=>{t(e,C)[u+w[75]]=f},()=>{t(e,C)[u+w[76]]=f},()=>{t(e,C)[u+w[77]]=f},()=>{t(e,C)[u+w[78]]=f}][k]||(()=>{}))():k<63||(k<64?(t(e,A)[d]?(t(e,C)[u+w[0]]=104|f,e.pushChPrimitives(d),e.dispatchEvent("voice",{part:d})):(t(e,C)[u+w[0]]=96|f,e.pushChPrimitives(d),e.dispatchEvent("voice",{part:d})),e.dispatchEvent("voice",{part:d})):console.debug(`Unknown SD-90 global CH${d+1} param setup message:
%o`,a))});break}case 2:{let d=e.chRedir(c,s,!0),o=a[1];console.debug(`Unknown SD-90 global CH${d+1} MIDI setup message:
%o`,a.subarray(2));break}default:console.warn(`Unknown SD-90 global part setup message:
%o`,a)}}),t(e,Me).add([0,1,73,78],(a,s,h)=>{e.switchMode("krs"),e.setPortMode(e.getTrackPort(s),1,S.krs),console.debug("Might be KORG KROSS 2 mode reset... Not sure.")}).add([0,1,73,117,2,37],(a,s,h)=>{e.switchMode("krs");let i=e.getTrackPort(s);if(t(e,Y)[i]&&t(e,Y)[i]!=S.krs)if(t(e,Se).dumpLimit===e.DUMP_MODE){console.warn(`Dump cancelled. Port ${String.fromCharCode(65+i)} mode "${W[t(e,Y)[i]]}" mismatch, should be "krs".`);return}else console.info(`Track ${s} is trying to perform a mismached mode dump on port ${String.fromCharCode(65+i)}.`);e.setPortMode(e.getTrackPort(s),1,S.krs);let c="KROSS 2 BMT1 ",d="";Ee(a,(o,u)=>{if(u<24)d+=String.fromCharCode(Math.max(32,o));else if(!(u<1276)){let f=u-1276,b=e.chRedir(Math.floor(f/44),s,!0),k=f%44,M=H[b];k<15?([()=>{o&&e.setChActive(b,1),t(e,I)[b]=o,e.dispatchEvent("voice",{part:b})},()=>{o&&e.setChActive(b,1),o<10?(t(e,C)[M+w[0]]=63,t(e,C)[M+w[32]]=o):o<20?(t(e,C)[M+w[0]]=121,t(e,C)[M+w[32]]=o-10):o<24&&(t(e,C)[M+w[0]]=[120,0,56,62][o-20],t(e,C)[M+w[32]]=0),e.pushChPrimitives(b),e.dispatchEvent("voice",{part:b})},()=>{let P=e.chRedir(o&15,s,!0);t(e,Z)[b]=P,console.info(`${c}CH${b+1} receives from CH${P+1}`)},!1,!1,()=>{t(e,C)[M+w[7]]=o},!1,()=>{},()=>{},!1,!1,!1,!1,!1,()=>{t(e,C)[M+w[10]]=o||128}][k]||(()=>{}))():k<36||([()=>{t(e,C)[M+w[74]]=(o+128&255)-64},()=>{t(e,C)[M+w[71]]=(o+128&255)-64},!1,!1,()=>{t(e,C)[M+w[73]]=(o+128&255)-64},()=>{t(e,C)[M+w[75]]=(o+128&255)-64},!1,()=>{t(e,C)[M+w[72]]=(o+128&255)-64}][k]||(()=>{}))()}}),d=d.trimRight(),e.dispatchEvent("metacommit",{type:"EORTitle",data:d})})}chRedir(e,r,l){let n=this;if(t(n,He)[r])return(t(n,He)[r]-1)*16+e;if(t(n,G)===S.sc||t(n,G)===S.sd){if(l===1)return e;let p=0,m=!0;for(;m;)t(n,Oe)[e+p]===0?(t(n,Oe)[e+p]=r,console.debug(`Assign track ${r} to channel ${e+p+1}.`),m=!1):t(this,Oe)[e+p]===r?m=!1:(p+=16,p>=128&&(p=0,m=!1));return e+p}else return e}getTrackPort(e){return this.chRedir(0,e,!0)>>4}forceVoiceRefresh(){for(let e=0;e<E.ch;e++)t(this,le)[e]&&this.dispatchEvent("voice",{part:e})}buildRchTree(){let e=[];t(this,Z).forEach((r,l)=>{var n;r<E.ch&&((n=e[r])!=null&&n.constructor||(e[r]=[]),e[r].push(l))}),x(this,At,e)}buildRccMap(){let e=this;for(let r=0;r<E.ch;r++)t(e,je)[r]={};t(e,qe).forEach((r,l)=>{r&&(t(e,je)[Math.floor(l/E.redir)][r]=l%E.redir|128)}),L()&&console.debug(t(e,je))}getActive(){return t(this,le)}getChActive(e){return t(this,le)[e]}getCc(e){if(typeof e!="number"||e<0||e>=E.ch)throw new RangeError(`Invalid part number: CH${e+1}`);let r=this,l=H[e];return t(r,C).subarray(l,l+E.cc)}getChCc(e,r){let l=this;if(pt.indexOf(r)<0)throw new Error("CC number not accepted");return t(l,C)[H[e]+w[r]]}setChCc(e=0,r,l){let n=this;if(pt.indexOf(r)<0)throw new Error("CC number not accepted");if((l==null?void 0:l.constructor)!=Number)throw new TypeError("Expected numbers for value");let p=l&255,m=H[e]+w[r];t(n,C)[m]=p,t(n,C)[m+E.chcc]=1,n.dispatchEvent("cc",{part:e,cc:r,data:p})}getCcAll(){return t(this,C).slice()}resetCc(e){}resetChCc(e,r,l){let n=this;l!=null&&l.constructor&&n.setChCc(e,r,l),t(n,C)[H[e]+w[r]+E.chcc]=0}resetCcAll(){}isChCcWritten(e,r){if(pt.indexOf(r)<0)throw new Error("CC number not accepted");return t(upThis,C)[H[e]+w[r]+E.chcc]}getChSource(){return t(this,Z)}getChType(){return t(this,A)}setChType(e,r,l=0,n=!1){r&=15;let p=this;l=l||p.getChModeId(e),t(p,A)[e]=r,r>0&&!n&&(p.setChCc(e,0,t(p,Q)[l][2]),p.pushChPrimitives(e))}setChActive(e,r=0){t(this,le)[e]!=r&&this.dispatchEvent("channeltoggle",{part:e,active:r}),t(this,le)[e]=r}getExt(e){let r=E.ext*e,l=t(this,de).subarray(r,r+E.ext),n=new Uint8Array(l.length);return n.set(l),n[1]=n[1]||t(this,Ht),n}getPitch(){return t(this,De)}getProgram(){return t(this,I)}getTexts(){return t(this,fe).slice()}getVel(e){let r=new Map,l=this;return t(l,q).forEach(function(n,p){let m=n>>7,v=n&127;e===m&&t(l,J)[n]>0&&r.set(v,{v:t(l,J)[n],s:t(l,K)[p]})}),r}getBitmap(){return{bitmap:t(this,pe,Re),expire:t(this,ye)}}getLetter(){return{text:t(this,Ne),set:t(this,Rt),expire:t(this,_e)}}getMode(){return W[t(this,G)]}getMaster(){return{volume:t(this,F)}}getRawStrength(){let e=this;return t(this,q).forEach(function(r){let l=r>>7;t(e,J)[r]>t(e,xe)[l]&&(t(e,xe)[l]=t(e,J)[r])}),t(this,xe)}getStrength(){let e=[],r=this;return this.getRawStrength().forEach(function(l,n){e[n]=Math.floor(l*r.getChCc(n,7)*r.getChCc(n,11)*t(r,F)/803288)}),e}getRpn(){return t(this,D)}getNrpn(){return t(this,gt)}getSubDb(){return self==null?void 0:self.structuredClone(t(this,Q))}getDetect(){return self==null?void 0:self.structuredClone(t(this,B))}getVoice(e,r,l,n="?"){var s;let p=this;(s=S[n])!=null&&s.constructor||(n="?");let m=S[n],v=e||t(p,Q)[m][0],y=r,$=l||t(p,Q)[m][1];v===ke.bank0&&(v=0),$===ke.bank0&&($=0),n==="ns5r"&&v>0&&v<56&&($=3);let a=p.userBank.get(v,y,$,n);if(n==="mt32"&&a.name.indexOf("MT-m:")===0){let h=parseInt(a.name.slice(5)),i=h*E.cmt,c="";t(p,Ue).subarray(i,i+10).forEach(o=>{o>31&&(c+=String.fromCharCode(o))});let d=`MSB	LSB	PRG	NME
49	127	${y}	${c}`;p.userBank.load(d,!0),a.name=c,a.ending=" "}return(a.ending!=" "||!a.name.length)&&(a=p.baseBank.get(v,y,$,n)),a}getChPrimitive(e,r,l){if(r>=E.vxPrim||(r==null?void 0:r.constructor)!=Number)throw new RangeError(`Invalid voice primitive component "${r}"`);if(typeof e!="number"||e<0||e>=E.ch)throw new RangeError(`Invalid part number: CH${e+1}`);let n=this,p=t(n,I)[r<<E.chShift|e];switch(r){case 1:case 2:{l&&(p=p||t(n,Q)[n.getChModeId(e)][r-1]),p===ke.bank0&&(p=0);break}}return p}getChPrimitives(e,r){let l=this,n=new Uint8Array(3);return n[1]=t(l,I)[e],n[0]=l.getChPrimitive(e,1,r),n[2]=l.getChPrimitive(e,2,r),n}pushChPrimitives(e){let r=this;t(r,I)[1<<E.chShift|e]=r.getChCc(e,0),t(r,I)[2<<E.chShift|e]=r.getChCc(e,32),r.dispatchEvent("voice",{part:e})}getChVoice(e){let r=this,l=r.getVoice(...r.getChPrimitives(e),r.getChMode(e));if(t(r,Ce)[e]){let n="";switch(t(r,G)){case S.mt32:{t(r,we).subarray(E.cmt*(e-1),E.cmt*(e-1)+10).forEach(p=>{n+=String.fromCharCode(Math.max(p,32))}),n=n.trimRight();break}default:{let p=E.cvn*e;t(r,Mt).subarray(p,p+E.cvn).forEach(m=>{n+=String.fromCharCode(Math.max(m,32))}),n=n.trimRight()}}n.length&&(l.ending="~",l.name=n)}return l}getRawPitch(){return t(this,De)}getPitchShift(e){let r=this,l=e*E.rpn,n=t(r,D)[l];return t(r,U)[e*E.rpnt]||t(r,G)===S.mt32&&(n=12),t(r,De)[e]/8192*n+(t(r,D)[l+3]-64)+((t(r,D)[l+1]<<7)+t(r,D)[l+2]-8192)/8192}getEffectType(e=0){let r=3*e+1;return t(this,he).subarray(r,r+2)}getPolyState(e=0){return t(this,K)[e]}setEffectTypeRaw(e=0,r,l){let n=3*e;t(this,he)[n]=1,t(this,he)[n+1+ +r]=l}setEffectType(e=0,r,l){this.setEffectTypeRaw(e,!1,r),this.setEffectTypeRaw(e,!0,l)}getEffectSink(){return t(this,bt)}setLetterDisplay(e,r,l=0,n=3200){let p=this,m;x(p,Ne," ".repeat(l)),e.forEach(v=>{x(p,Ne,t(p,Ne)+String.fromCharCode(v>31?v:32)),v<32&&(m=m||new Set,m.add(v))}),x(p,Rt,Date.now()),x(p,_e,Date.now()+n),p.dispatchEvent("letter"),m&&(m=Array.from(m),m.forEach((v,y,$)=>{$[y]=v.toString(16).padStart(2,"0")}),console.warn(`${r}${r?" ":""}invalid code point${m.length>1?"s":""}: 0x${m.join(", 0x")}`))}setDetectionTargets(e="?",r=0){let l=this,n=-1;switch(e.replaceAll(", ",",").split(",").forEach(p=>{p=p.toLowerCase();let m=W.indexOf(aa[p]||p);L()&&console.debug(`Mapped mode "${p}" to ID "${m}".`),m>-1&&(n=m)}),L()&&console.debug(`Set detection target to ID "${n}".`),n>0&&(t(l,B).x5=82,t(l,B).ds=S.krs),n){case S["05rw"]:{t(l,B).x5=81;break}case S.s90es:t(l,B).ds=S.s90es,t(l,B).smotif=S.s90es;case S.motif:t(l,B).ds=S.motif,t(l,B).smotif=S.motif}}setGsTargets(e=!1,r=4){if(!r)r=e?3:4;else{if(r>4||r<0)throw new Error(`Invalid GS level ${r}`);if(e&&r>>1!=1)throw new Error(`Invalid SC level ${r}`)}let l=this;t(l,B)[e?"sc":"gs"]=r,t(l,Q)[S[e?"sc":"gs"]][1]=r,l.forceVoiceRefresh()}getConfigs(){return t(this,Pt)}setDumpLimit(e){if(e>2||e<0)throw new RangeError("Invalid dump limit.");t(this,Se).dumpLimit=e}allocateAce(e=0,r){let l=this;if(!r||r<128&&r>95){console.warn(`cc${r} cannot be allocated as an active custom effect.`);return}let n=!0,p=0,m=E.ace*e;for(;n&&p<E.ace;)t(l,re)[p+m]===r?n=!1:t(l,re)[p+m]||(n=!1,t(l,re)[p+m]=r,console.info(`Allocated cc${r} to ACE slot ${p} in CH${e+1}.`)),p++;p>=E.ace&&console.warn(`ACE slots are full in CH${e+1}.`)}allocateAceAll(e){let r=this;if(!e||e<128&&e>95){console.warn(`cc${e} cannot be allocated as an active custom effect.`);return}for(let l=0;l<E.ch;l++){let n=!0,p=0,m=E.ace*l;for(;n&&p<E.ace;)t(r,re)[p+m]===e?n=!1:t(r,re)[p+m]||(n=!1,t(r,re)[p+m]=e),p++;p>=E.ace&&console.warn(`ACE slots are full in CH${l+1}.`)}}releaseAce(e=0,r){let l=!0,n=E.ace*e,p=n+E.ace;for(;l&&n<p;)t(this,re)[n]===r&&(t(this,re)[n]=0,l=!1),n++;l&&L()&&console.debug(`No ACE slot was allocated to cc${r} in CH${e+1}.`)}resetAce(){t(this,re).fill(0),console.info("All ACE slots have been reset.")}getAce(){return t(this,re)}getChAce(e=0,r=0){if(r<0||r>=E.ace)throw new RangeError("No such ACE slot");let l=t(this,re)[E.ace*e+r];if(l){if(pt.indexOf(l)>=0)return this.getChCc(e,l);throw new Error(`Invalid ACE source in CH${e+1}: ${l}`)}else return 0}initDrums(){let e=this;t(e,ne).fill(64);for(let r=0;r<E.drm;r++){let l=r*E.dpn;for(let n in Mr){let p=Mr[n],m=(l+ge[n])*E.dnc;t(e,ne).subarray(m,m+E.dnc).fill(p)}}}init(e=0){let r=this;x(r,Ye,0),t(r,Q)[S.xg][1]=0,r.dispatchEvent("banklevel",{mode:"xg",data:0}),t(r,le).fill(0),t(r,C).fill(0),t(r,re).fill(0),t(r,I).fill(0),t(r,J).fill(0),t(r,q).fill(0),t(r,K).fill(0),t(r,ie).fill(0),t(r,xe).fill(0),t(r,De).fill(0),t(r,gt).fill(0),t(r,U).fill(0),t(r,de).fill(0),t(r,Y).fill(0),t(r,mt).fill(0),t(r,We).fill(0),t(r,qe).fill(0),x(r,F,100),x(r,fe,[]),x(r,yt,500),x(r,Qe,0),x(r,Ze,0),x(r,Je,!1),x(r,ye,0),x(r,te,0),t(r,pe,Re).fill(0),x(r,X,r.KARAOKE_NONE),x(r,vt,0),x(r,Te,!0),r.initDrums(),r.polyIndexLatest=0,r.polyIndexLast=0,t(r,Z).forEach(function(l,n,p){p[n]=n}),e===0&&(r.dispatchEvent("mode","?"),x(r,G,0),t(r,Oe).fill(0),t(r,He).fill(0),x(r,_e,0),x(r,Ne,"")),ia.forEach(l=>{r.setChCc(l,0,t(r,Q)[r.getChModeId(l)][2])}),t(r,A).fill(r.CH_MELODIC),t(r,A)[9]=r.CH_DRUM1,t(r,A)[25]=r.CH_DRUM3,t(r,A)[41]=r.CH_DRUMS,t(r,A)[57]=r.CH_DRUMS,t(r,A)[73]=r.CH_DRUM5,t(r,A)[89]=r.CH_DRUM7,t(r,A)[105]=r.CH_DRUMS,t(r,A)[121]=r.CH_DRUMS;for(let l=0;l<E.drm;l++)t(r,ve)[l<<1]=0,t(r,ve)[l<<1|1]=E.invalidCh;t(r,Et).fill(0),t(r,Ue).fill(0),t(r,Be).fill(0),t(r,we).fill(0),t(r,Ce).fill(0),t(r,he).fill(0),t(r,bt).fill(0),r.aiEfxName="",r.userBank.clearRange({msb:0,lsb:127,prg:[0,127]}),r.modelEx.sc.showBar=!0,r.modelEx.sc.invBar=!1,r.modelEx.sc.invDisp=!1,r.modelEx.sc.peakHold=1;for(let l=0;l<E.ch;l++){let n=H[l];t(r,C)[n+w[7]]=100,t(r,C)[n+w[11]]=127,t(r,C)[n+w[2]]=127,t(r,C)[n+w[10]]=64,t(r,C).subarray(n+w[71],n+w[71]+8).fill(64),t(r,C)[n+w[128]]=127,t(r,C).subarray(n+w[130],n+w[157]+1).fill(64),t(r,C)[n+w[91]]=40,t(r,C)[n+w[101]]=127,t(r,C)[n+w[100]]=127,t(r,C)[n+w[99]]=127,t(r,C)[n+w[98]]=127;let p=l*E.rpn;t(r,D)[p]=2,t(r,D)[p+1]=64,t(r,D)[p+2]=0,t(r,D)[p+3]=64,t(r,D)[p+4]=0,t(r,D)[p+5]=0;let m=l*E.ext;t(r,de)[m+1]=r.VLBC_BRTHEXPR;let v=l*E.redir;t(r,qe)[v+8]=13}r.buildRchTree(),r.buildRccMap(),r.dispatchEvent("mastervolume",t(r,F)),r.dispatchEvent("efxreverb",r.getEffectType(0)),r.dispatchEvent("efxchorus",r.getEffectType(1)),r.dispatchEvent("efxdelay",r.getEffectType(2)),r.dispatchEvent("efxinsert0",r.getEffectType(3)),r.dispatchEvent("efxinsert1",r.getEffectType(4)),r.dispatchEvent("efxinsert2",r.getEffectType(5)),r.dispatchEvent("efxinsert3",r.getEffectType(6)),r.dispatchEvent("reset"),r.switchMode("?")}setChMode(e,r){let l=this;if(typeof e!="number"||e<0||e>=E.ch)throw new RangeError(`Invalid part number: CH${e+1}`);if(port<0||r>=W.length)throw new RangeError(`Invalid mode ID ${r}`);t(l,We)[e]=r,l.dispatchEvent("chmode",{part:e,id:r,mode:W[r]}),l.dispatchEvent("voice",{part:e})}getChMode(e,r){return W[this.getChModeId(e,r)]}getChModeId(e,r){return r?t(this,We)[e]||t(this,Y)[e>>4]:t(this,We)[e]||t(this,Y)[e>>4]||t(this,G)}setPortMode(e,r,l){let n=this;if(e<0||e>=E.ch>>4)throw new RangeError(`Invalid port ${e+1}`);if(r<1)throw new RangeError("Range must be a positive integer");if(e+r>=E.ch>>4)throw new RangeError("Range must be in bound");if(e<0||l>=W.length)throw new RangeError(`Invalid mode ID ${l}`);t(n,mt)[e]=l;for(let p=e;p<e+r;p++){let m=t(n,mt)[p];if(r>1&&m!==0&&m!==l)break;t(n,Y)[p]=l;for(let v=p<<4;v<p+1<<4;v++)n.dispatchEvent("chmode",{part:v,id:l,mode:W[l]}),n.dispatchEvent("voice",{part:v})}}copyChSetup(e,r,l){if(e===r){console.warn(`Failed attempt at overwriting CH${e+1} with its own data.`);return}let n=this;if(l&&t(n,le)[r]){console.warn(`Failed attempt at copying setup data from CH${e+1} to CH${r+1}.`);return}let p=H[e],m=H[r];t(n,I)[r]=t(n,I)[e],t(n,C).set(t(n,C).subarray(p,p+E.cc),m),n.pushChPrimitives(r)}setDrumFirstWrite(e,r){let l=this,n=t(l,A)[e];if(n<2)return;let p=n-2;if(t(l,ve)[p<<1])if(r)t(l,ve)[p<<1]=0,L()&&console.debug(`First write part for drum set ${p+1} has been reset.`);else return;else r?console.warn(`First write part for drum set ${p+1} is already blank.`):(t(l,ve)[p<<1]=1,t(l,ve)[p<<1|1]=e,console.debug(`First write part for drum set ${p+1} is set to CH${e+1}.`))}getChDrumFirstWrite(e){let r=this,l=t(r,A)[e];if(l<2)return;let n=l-2;return t(r,ve).subarray(n<<1,n+1<<1)}getDrumFirstWrite(e){if(e>=0&&e<E.drm)return t(this,ve).subarray(e<<1,e+1<<1)}switchMode(e,r=!1,l=!1){var m;let n=this,p=S[e];if(p>-1){if(t(n,G)===0||r){n.initOnReset&&r&&this.init(1),x(n,G,p),x(n,te,0);for(let y=0;y<E.ch;y++){let $=n.getChModeId(y,!0);t(n,A)[y]>0&&$===S["?"]&&(n.setChCc(y,0,t(n,Q)[p][2]),L()&&console.debug(`CH${y+1} (${t(n,A)[y]}) (${n.getChMode(y)}), ${W[$]} (${t(n,Q)[$][2]}) -> ${W[p]} (${t(n,Q)[p][2]})`),n.pushChPrimitives(y))}switch(p){case S.mt32:{Yt.forEach((y,$)=>{let a=$+1;t(n,le)[a]||(t(n,I)[a]=y,n.setChCc(a,91,127),n.pushChPrimitives(a))});for(let y=1;y<10;y++)n.dispatchEvent("voice",{part:y});break}}let v;switch(p){case S["?"]:case S.g2:{v=[52,4,52,18,0,0,0,0];break}case S.xg:{v=[1,0,65,0,5,0,0,0];break}case S.gm:case S.gs:case S.sc:{v=[40,4,40,18,40,32,32,0];break}case S.sd:{v=[58,0,60,0,61,0,61,0];break}case S["05rw"]:case S.x5d:case S.ns5r:{v=[44,1,44,19,44,0,44,0];break}case S.k11:case S.sg:{v=[24,0,0,0,0,0,0,0];break}case S.mt32:{v=[40,4,0,0,0,0,0,0];break}case S.doc:{v=[24,16,0,0,0,0,0,0];break}case S.motif:case S.s90es:{v=[129,0,133,0,130,0,0,0];break}default:v=[0,0,0,0,0,0,0,0]}for(let y=0;y<E.efx;y++)!t(n,he)[3*y]&&((m=v[y<<1])!=null&&m.constructor)&&(t(n,he)[3*y+1]=v[2*y],t(n,he)[3*y+2]=v[2*y+1],n.dispatchEvent(`efx${["reverb","chorus","delay","insert0"][y]}`,n.getEffectType(y)));l&&n.setDetectionTargets(e),n.dispatchEvent("mode",e),n.forceVoiceRefresh()}}else throw new Error(`Unknown mode ${e}`)}newStrength(){t(this,xe).fill(0)}runJson(e){var r;if(e.type>14)return e.type===15&&e.data.constructor!=Uint8Array&&(e.data=Uint8Array.from(e.data)),t(this,Dt)[e.type].call(this,e);{let l=this.chRedir(e.part,e.track),n=!1;(r=t(this,At)[l])==null||r.forEach(p=>{e.channel=p,n=!0,t(this,Dt)[e.type].call(this,e)}),n||console.warn(`${$r[e.type]?$r[e.type]:e.type}${[11,12].includes(e.type)?(e.data[0]!=null?e.data[0]:e.data).toString():""} event sent to CH${l+1} without any recipient.`)}t(this,fe).length>100&&t(this,fe).splice(100,t(this,fe).length-99)}runRaw(e){}async loadBank(e,r){let l=this;switch(e=e.toLowerCase(),e){case"s7e":{l.userBank.clearRange({msb:63,lsb:[21,22]}),l.userBank.clearRange({msb:63,lsb:[24,27]});break}case"pcg":{l.userBank.clearRange({msb:63,lsb:[6,9]}),l.userBank.clearRange({msb:63,lsb:[13,16]});break}default:throw new Error(`Unknown bank format ${e}`)}switch(e){case"s7e":case"pcg":{$t.context=this,await l.userBank.load(await $t.read(e,r),!1);break}}l.forceVoiceRefresh()}},G=new WeakMap,te=new WeakMap,ye=new WeakMap,Ae=new WeakMap,pe=new WeakSet,Re=function(){return t(this,Ae)[t(this,te)]},Or=function(e){t(this,Ae)[t(this,te)]=e},le=new WeakMap,Z=new WeakMap,A=new WeakMap,C=new WeakMap,re=new WeakMap,I=new WeakMap,J=new WeakMap,ie=new WeakMap,q=new WeakMap,K=new WeakMap,De=new WeakMap,xe=new WeakMap,ze=new WeakMap,de=new WeakMap,D=new WeakMap,U=new WeakMap,gt=new WeakMap,ne=new WeakMap,ve=new WeakMap,he=new WeakMap,bt=new WeakMap,qe=new WeakMap,Y=new WeakMap,mt=new WeakMap,We=new WeakMap,Ce=new WeakMap,Mt=new WeakMap,Be=new WeakMap,we=new WeakMap,Et=new WeakMap,Ue=new WeakMap,Q=new WeakMap,B=new WeakMap,Se=new WeakMap,Pt=new WeakMap,F=new WeakMap,Ye=new WeakMap,yt=new WeakMap,Qe=new WeakMap,Ze=new WeakMap,_t=new WeakMap,Je=new WeakMap,Ne=new WeakMap,_e=new WeakMap,Rt=new WeakMap,vt=new WeakMap,Te=new WeakMap,X=new WeakMap,Ht=new WeakMap,At=new WeakMap,je=new WeakMap,fe=new WeakMap,Oe=new WeakMap,He=new WeakMap,ae=new WeakMap,et=new WeakMap,j=new WeakMap,Dt=new WeakMap,Gt=new WeakMap,tt=new WeakMap,rt=new WeakMap,ue=new WeakMap,be=new WeakMap,Me=new WeakMap,at=new WeakMap,st=new WeakMap,it=new WeakMap,Ar);var tr=Yr(Lr(),1);N();N();var Ot,Ir,Ur=(Ir=class{constructor(g,e,r,l){T(this,Ot,!1);x(this,Ot,g),this.start=e,this.end=r,this.data=l}get duration(){return this.ranged?this.end-this.start:0}get ranged(){return t(this,Ot)}},Ot=new WeakMap,Ir),jt=class extends Ur{constructor(g,e,r){super(!0,g,e,r)}},Nr=class extends Ur{constructor(g,e){super(!1,g,g,e)}},nt,Br,er=(Br=class extends Array{constructor(){super(...arguments);T(this,nt,-1)}resetIndex(e){x(this,nt,-1)}fresh(){this.sort(function(e,r){return e.start==r.start?0:(+(e.start>r.start)<<1)-1}),this.forEach(function(e,r){e.index=r})}step(e,r=!1){let l=[];if(r)for(let n=0;n<this.length&&!(this[n].start>e);n++){if(this[n].end<e)continue;l.push(this[n])}else{let n=this.getRange(t(this,nt)==-1?0:e-1,e),p=this;n.forEach(function(m){m.index>t(p,nt)&&(l.push(m),x(p,nt,m.index))})}return l}getRange(e,r){var v;e>r&&([e,r]=[r,e]);let l=[],n=-1,p=Math.ceil(Math.sqrt(this.length)),m=!0;for(let y=0;y<this.length;y+=p)this[y+p]?n<0&&this[y+p].start>=e&&(n=y):n=n<0?y:n;for(;m;)((v=this[n])==null?void 0:v.end)<r?this[n].start>=e&&l.push(this[n]):m=!1,n++;return l}},nt=new WeakMap,Br);var ua=0xffffffffffff,_r=function(g){let e=new er,r=this,l=g.timeDivision,n=120,p=new er,m=0,v=0;p.push(new jt(0,ua,[120,0])),g.track.forEach(function(s){m=0,s.event.forEach(function(h){m+=h.deltaTime,h.type===255&&(h==null?void 0:h.metaType)===81&&(n=6e7/h.data,p[p.length-1]&&p.push(new jt(m,0xffffffffffff,[n,0])))})}),p.fresh(),p.forEach(function(s,h,i){h>0&&(i[h-1].end=s.start)});let y=120;p.forEach(function(s,h,i){h>0&&(s.end===s.start?i.splice(i.indexOf(s),1):y===s.data[0]&&(i[h-1].end=s.end,i.splice(i.indexOf(s),1)),y=s.data[0])});let $=0,a=120;return p.forEach(function(s){let h=s.start,i=h/a/l*60+$;a=s.data[0],$=i-h/a/l*60,s.data[1]=$}),console.debug("All tempo changes: ",p),n=120,m=0,v=0,g.track.forEach(function(s,h){m=0,v=0;let i=h+1;s.event.forEach(function(c,d){m+=c.deltaTime;let o=p.step(m,!0)[0];o&&(n=o.data[0],v=o.data[1]);let u={type:c.type,data:c.data,track:i,part:0};c.type>14?u.meta=c.metaType:u.part=c.channel,e.push(new Nr(m/n/l*60+v,u))})}),e.fresh(),self.midiEvents=e,console.debug(`Parsed a type ${g.formatType} MIDI sequence.`),e};tr.default.customInterpreter=wr;var V=function(g,e,r){g.addEventListener(r,l=>{e.dispatchEvent(r,l.data)})},ct,Ge,Ct,Le,ot,wt,lt,Lt,Xe,Ve,se,dt,Pe,ht,It,Ke,Hr,Cs=(Hr=class extends Ut{constructor(e,r=.5,l=.5){super();R(this,"device");T(this,ct,void 0);T(this,Ge,{});T(this,Ct,[]);T(this,Le,"");T(this,ot,[]);T(this,wt,[]);T(this,lt,new Uint8ClampedArray(128));T(this,Lt,new Uint8ClampedArray(128));T(this,Xe,.5);T(this,Ve,120);T(this,se,4);T(this,dt,4);T(this,Pe,0);T(this,ht,0);T(this,It,new Array(E.ch));T(this,Ke,new Uint8Array(E.ch));R(this,"smoothAttack",0);R(this,"smoothDecay",0);let n=this;n.smoothAttack=r,n.smoothDecay=l,n.device=e,n.addEventListener("meta",function(p){var m;(m=p==null?void 0:p.data)==null||m.forEach(function(v){(t(n,ot)[v.meta]||console.debug).call(n,v.meta,v.data)})}),V(n.device,n,"mode"),V(n.device,n,"mastervolume"),V(n.device,n,"channelactive"),V(n.device,n,"channelmin"),V(n.device,n,"channelmax"),V(n.device,n,"portrange"),V(n.device,n,"portstart"),V(n.device,n,"channelreset"),V(n.device,n,"channeltoggle"),V(n.device,n,"screen"),V(n.device,n,"metacommit"),V(n.device,n,"voice"),V(n.device,n,"pitch"),V(n.device,n,"note"),V(n.device,n,"reset"),V(n.device,n,"banklevel"),V(n.device,n,"efxreverb"),V(n.device,n,"efxchorus"),V(n.device,n,"efxdelay"),V(n.device,n,"efxinsert0"),V(n.device,n,"efxinsert1"),V(n.device,n,"efxinsert2"),V(n.device,n,"efxinsert3"),V(n.device,n,"partefxtoggle"),V(n.device,n,"chmode"),n.addEventListener("note",function({data:p}){t(n,wt).push(p)}),n.addEventListener("voice",({data:p})=>{var v;let m=n.getChVoice(p.part);t(n,It)[p.part]=m,t(n,Ke)[p.part]=(v=m.poly)!=null?v:1}),n.addEventListener("reset",({data:p})=>{t(n,Ke).fill(1)}),t(n,Ke).fill(1),t(n,ot)[3]=function(p,m){var v;((v=t(n,Le))==null?void 0:v.length)<1&&(x(n,Le,m),n.dispatchEvent("title",t(n,Le)))},t(n,ot)[81]=function(p,m){let v=n.noteProgress,y=t(n,Xe)||.5;x(n,Ve,6e7/m),x(n,Xe,m/1e6),x(n,Pe,t(n,Pe)+(v*(y/t(n,Xe))-v)),n.dispatchEvent("tempo",t(n,Ve))},t(n,ot)[88]=function(p,m){let v=n.noteProgress,y=n.noteOverall,$=n.noteBar,a=n.noteBeat,s=t(n,se),h=t(n,dt);x(n,se,m[0]),x(n,dt,1<<m[1]);let i=24*(32/m[3])/m[2];if(s!=t(n,se)){let c=$;x(n,Pe,t(n,Pe)-c*(t(n,se)-s)),a+1>=s&&(s<t(n,se)?x(n,Pe,t(n,Pe)-Math.ceil(t(n,se)-a-1)):x(n,Pe,t(n,Pe)+t(n,se)))}n.dispatchEvent("tsig",n.getTimeSig())}}reset(){var r;let e=this;e.dispatchEvent("reset"),(r=t(e,ct))==null||r.resetIndex(),e.device.init(),x(e,Le,""),x(e,Xe,.5),x(e,Ve,120),x(e,se,4),x(e,dt,4),x(e,Pe,0),x(e,ht,0),e.dispatchEvent("tempo",t(e,Ve)),e.dispatchEvent("title",t(e,Le))}init(){this.reset(),x(this,ct,void 0)}async loadFile(e){x(this,ct,_r(tr.default.parse(new Uint8Array(await e.arrayBuffer()))))}async loadMap(e,r,l){let n=this,p=0,m=0,v=0,y=0,$,a;e.split(`
`).forEach((s,h)=>{var c;if(!s)return;let i=s.split("	");if(h){if(!y)return;let d="",o="";i.forEach((f,b)=>{switch(b){case $:{d=f;break}case a:{o=f;break}}});let u=!1;((c=t(n,Ge)[d])==null?void 0:c.priority)>l&&(u=!0,v++),!t(n,Ge)[d]||u||r?(t(n,Ge)[d]={name:o,priority:l},p++):self.debugMode&&console.debug(`Voice "${o}" (${d}) seems to be in conflict with (${t(n,Ge)[d]}).`),m++}else i.forEach((d,o)=>{switch(d){case"ID":{$=o,y++;break}case"Name":{a=o,y++;break}default:console.debug(`Unknown map field: ${d}`)}})}),console.debug(`Voice names: ${m} total, ${p} loaded (${p-v} + ${v}).`),n==null||n.device.forceVoiceRefresh()}async loadMapPaths(e){let r=this;e.forEach(async(l,n)=>{r.loadMap(await(await fetch(l)).text(),0,n)})}async loadEfx(e,r){let l=this,n=0,p=0,m,v,y;e.split(`
`).forEach(($,a)=>{if($)if(a){let s=0,h;$.split("	").forEach((i,c)=>{switch(c){case m:{s|=(parseInt(i,16)&255)<<8;break}case v:{s|=parseInt(i,16)&255;break}case y:{h=i;break}}}),!t(l,Ct)[s]||r?(t(l,Ct)[s]=h,n++):self.debugMode&&console.debug(`EFX ID 0x${s.toString(16).padStart(4,"0")} (${h}) seems to be in conflict.`),p++}else $.split("	").forEach((s,h)=>{switch(s){case"MSB":{m=h;break}case"LSB":{v=h;break}case"Name":{y=h;break}default:console.debug(`Unknown EFX field: ${s}`)}})}),console.debug(`EFX: ${p} total, ${n} loaded.`),l.dispatchEvent("efxreverb",l.device.getEffectType(0)),l.dispatchEvent("efxchorus",l.device.getEffectType(1)),l.dispatchEvent("efxdelay",l.device.getEffectType(2)),l.dispatchEvent("efxinsert0",l.device.getEffectType(3)),l.dispatchEvent("efxinsert1",l.device.getEffectType(4)),l.dispatchEvent("efxinsert2",l.device.getEffectType(5)),l.dispatchEvent("efxinsert3",l.device.getEffectType(6))}switchMode(e,r=!1){this.device.switchMode(e,r)}getMode(){return this.device.getMode()}getVoice(){return this.device.getVoice(...arguments)}getChVoice(e){return this.device.getChVoice(e)}getChPrimitive(e,r,l){return this.device.getChPrimitive(e,r,l)}getChPrimitives(e,r){return this.device.getChPrimitives(e,r)}getMapped(e){var r;return((r=t(this,Ge)[e])==null?void 0:r.name)||e}getEfx([e,r]){let l=e<<8|r;return t(this,Ct)[l]||`0x${l.toString(16).padStart(4,"0")}`}getVoxBm(e){if(!e)throw new Error("Voice object must be valid");let r=this;if(!r.voxBm)throw new Error("Voice bitmap repository isn't yet initialized");let l=r.voxBm.getBm(e.name);if(!l)switch(e.mode){case"xg":{switch(e.sid[0]){case 0:case 80:case 81:case 83:case 84:case 96:case 97:case 99:case 100:{l=r.voxBm.getBm(r.getVoice(ke.bank0,e.sid[1],ke.bank0,e.mode).name);break}}break}case"g2":case"sd":{switch(e.sid[0]){case 96:case 97:case 98:case 99:{l=r.voxBm.getBm(r.getVoice(ke.bank0,e.sid[1],ke.bank0,e.mode).name);break}case 104:case 105:case 106:case 107:{l=r.voxBm.getBm(r.getVoice(120,e.sid[1],ke.bank0,e.mode).name);break}}break}case"gs":case"sc":case"k11":case"sg":case"gm":{switch(e.sid[0]){case 120:break;case 122:case 127:{l=r.voxBm.getBm(r.getVoice(120,e.sid[1],0,e.mode).name);break}default:l=r.voxBm.getBm(r.getVoice(0,e.sid[1],0,e.mode).name)}break}default:switch(e.sid[0]){case 56:{l=r.voxBm.getBm(r.getVoice(0,e.sid[1],0,e.mode).name);break}}}return l||(l=r.voxBm.getBm(r.getVoice(e.sid[0],e.sid[1],0,e.mode).name)),l}getChBm(e,r){let l=this;r=r||l.getChVoice(e);let n=l.getVoxBm(r);if(!n){if(!l.sysBm)return;switch(r.mode){case"xg":{switch(r.sid[0]){case 126:{r.sid[1]>>1===56&&(n=l.sysBm.getBm("cat_smpl"));break}case 16:{n=l.sysBm.getBm("cat_smpl");break}case 64:case 67:{n=l.sysBm.getBm("cat_sfx");break}case 32:case 33:case 34:case 35:case 36:case 48:case 82:{n=l.sysBm.getBm("cat_xg");break}}break}default:switch(r.sid[0]){case 63:case 32:case 33:case 34:case 35:case 36:case 48:case 82:{n=l.sysBm.getBm("cat_mex");break}}}}return n||(l.device.getChType()[e]?n=l.sysBm.getBm("cat_drm"):n=l.sysBm.getBm("no_vox")),n}get noteProgress(){return t(this,ht)/t(this,Xe)}get noteOverall(){return this.noteProgress-t(this,Pe)}get noteBar(){return Math.floor(this.noteOverall/t(this,se))}get noteBeat(){let e=this.noteOverall%t(this,se);return e<0&&(e+=t(this,se)),e}get noteOffset(){return t(this,Pe)}getTimeSig(){return[t(this,se),t(this,dt)]}getTempo(){return t(this,Ve)}eachVoice(e){t(this,It).forEach(e)}sendCmd(e){this.device.runJson(e)}render(e){var M;e>t(this,ht)&&x(this,ht,e);let r=((M=t(this,ct))==null?void 0:M.step(e))||[],l=0,n=0,p=new Set,m={},v=[],y=this,$=[];for(y.device.getStrength().forEach((P,O)=>{t(y,Lt)[O]=P}),y.device.newStrength(),r.forEach(function(P){let O=P.data,z=y.device.runJson(O);switch(z==null?void 0:z.reply){case"meta":{$.push(z);break}}z!=null&&z.reply&&delete z.reply});t(y,wt).length>0;){let P=t(y,wt).shift(),O=P.part<<7|P.note;P.state?(p.add(O),m[O]=P.velo):p.has(O)&&(v.push({part:P.part,note:P.note,velo:m[O],state:y.device.NOTE_SUSTAIN}),l++,n+=t(y,Ke)[P.part])}($==null?void 0:$.length)>0&&y.dispatchEvent("meta",$);let a=y.device.getActive(),s=[],h=y.device.getPitch(),i=y.device.getCcAll(),c=y.device.getProgram(),d=y.device.getChType(),o=[],u=y.device.getStrength();u.forEach(function(P,O,z){z[O]=Math.max(t(y,Lt)[O],P);let _=z[O]-t(y,lt)[O];if(_>=0){let Fe=4*.25**(y.device.getChCc(O,73)/64);t(y,lt)[O]+=Math.ceil(_-_*y.smoothAttack**Fe)}else{let Fe=4*.25**(y.device.getChCc(O,72)/64);t(y,lt)[O]+=Math.floor(_-_*y.smoothDecay**Fe)}});let f=0,b=0;return a.forEach(function(P,O){P&&(s[O]=y.device.getVel(O),o[O]=y.device.getExt(O),f+=s[O].size,b+=s[O].size*t(y,Ke)[O])}),{extraPoly:l,extraPolyEC:n,extraNotes:v,curPoly:f,curPolyEC:b,chInUse:a,chKeyPr:s,chPitch:h,chProgr:c,chContr:i,chType:d,chExt:o,eventCount:r.length,title:t(y,Le),bitmap:y.device.getBitmap(),letter:y.device.getLetter(),texts:y.device.getTexts(),master:y.device.getMaster(),mode:y.device.getMode(),strength:t(y,lt).slice(),velo:u,rpn:y.device.getRpn(),tSig:y.getTimeSig(),tempo:y.getTempo(),noteBar:y.noteBar,noteBeat:y.noteBeat,ace:y.device.getAce(),rawVelo:y.device.getStrength(),rawStrength:y.device.getRawStrength(),rawPitch:y.device.getRawPitch(),efxSink:y.device.getEffectSink()}}},ct=new WeakMap,Ge=new WeakMap,Ct=new WeakMap,Le=new WeakMap,ot=new WeakMap,wt=new WeakMap,lt=new WeakMap,Lt=new WeakMap,Xe=new WeakMap,Ve=new WeakMap,se=new WeakMap,dt=new WeakMap,Pe=new WeakMap,ht=new WeakMap,It=new WeakMap,Ke=new WeakMap,Hr);export{Cs as RootDisplay,E as allocated,w as ccToPos,ge as dnToPos};
