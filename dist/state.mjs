var Re=Object.create;var ne=Object.defineProperty;var Pe=Object.getOwnPropertyDescriptor;var Ae=Object.getOwnPropertyNames;var Oe=Object.getPrototypeOf,De=Object.prototype.hasOwnProperty;var Ie=(e,r)=>()=>(r||e((r={exports:{}}).exports,r),r.exports);var Le=(e,r,o,h)=>{if(r&&typeof r=="object"||typeof r=="function")for(let u of Ae(r))!De.call(e,u)&&u!==o&&ne(e,u,{get:()=>r[u],enumerable:!(h=Pe(r,u))||h.enumerable});return e};var Ue=(e,r,o)=>(o=e!=null?Re(Oe(e)):{},Le(r||!e||!e.__esModule?ne(o,"default",{value:e,enumerable:!0}):o,e));var ve=Ie((gt,re)=>{(function(){"use strict";let e={fatal:!0},r=[new TextDecoder("iso-8859-15",e),new TextDecoder("utf-8",e),new TextDecoder("sjis",e),new TextDecoder("euc-jp",e),new TextDecoder("ascii")],o={debug:!1,parse:function(h,u){if(h instanceof Uint8Array)return o.Uint8(h);if(typeof h=="string")return o.Base64(h);if(h instanceof HTMLElement&&h.type==="file")return o.addListener(h,u);throw new Error("MidiParser.parse() : Invalid input provided")},addListener:function(h,u){if(!File||!FileReader)throw new Error("The File|FileReader APIs are not supported in this browser. Use instead MidiParser.Base64() or MidiParser.Uint8()");if(h===void 0||!(h instanceof HTMLElement)||h.tagName!=="INPUT"||h.type.toLowerCase()!=="file")return console.warn("MidiParser.addListener() : Provided element is not a valid FILE INPUT element"),!1;u=u||function(){},h.addEventListener("change",function(E){if(!E.target.files.length)return!1;console.log("MidiParser.addListener() : File detected in INPUT ELEMENT processing data..");let y=new FileReader;y.readAsArrayBuffer(E.target.files[0]),y.onload=function(v){u(o.Uint8(new Uint8Array(v.target.result)))}})},Base64:function(h){let u=function(v){var a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";if(v=v.replace(/^.*?base64,/,""),v=String(v).replace(/[\t\n\f\r ]+/g,""),!/^(?:[A-Za-z\d+\/]{4})*?(?:[A-Za-z\d+\/]{2}(?:==)?|[A-Za-z\d+\/]{3}=?)?$/.test(v))throw new TypeError("Failed to execute _atob() : The string to be decoded is not correctly encoded.");v+="==".slice(2-(3&v.length));let c,d="",t,s,i=0;for(;i<v.length;)c=a.indexOf(v.charAt(i++))<<18|a.indexOf(v.charAt(i++))<<12|(t=a.indexOf(v.charAt(i++)))<<6|(s=a.indexOf(v.charAt(i++))),d+=t===64?String.fromCharCode(c>>16&255):s===64?String.fromCharCode(c>>16&255,c>>8&255):String.fromCharCode(c>>16&255,c>>8&255,255&c);return d}(h=String(h));var E=u.length;let y=new Uint8Array(new ArrayBuffer(E));for(let v=0;v<E;v++)y[v]=u.charCodeAt(v);return o.Uint8(y)},Uint8:function(y){let u={data:null,pointer:0,movePointer:function(t){return this.pointer+=t,this.pointer},readInt:function(t){if((t=Math.min(t,this.data.byteLength-this.pointer))<1)return-1;let s=0;if(1<t)for(let i=1;i<=t-1;i++)s+=this.data.getUint8(this.pointer)*Math.pow(256,t-i),this.pointer++;return s+=this.data.getUint8(this.pointer),this.pointer++,s},readStr:function(t){let s=new Uint8Array(t),i=!1,n;s.forEach((f,l)=>{s[l]=this.readInt(1)});for(let f=0;f<r.length;f++)if(!i)try{if(n=r[f].decode(s),f===0)for(let l=0;l<n.length;l++){let b=n.charCodeAt(l);if(b>191||b>127&&b<160)throw new RangeError(`Invalid code point: ${b}`)}i=!0,console.debug(`String byte sequence in ${r[f].encoding}`)}catch(l){console.debug(`SMF string ${l}`)}return n||"String byte sequence read failed."},backOne:function(){this.pointer--},readIntVLV:function(){let t=0;if(this.pointer>=this.data.byteLength)return-1;if(this.data.getUint8(this.pointer)<128)t=this.readInt(1);else{let i=[];for(;128<=this.data.getUint8(this.pointer);)i.push(this.readInt(1)-128);var s=this.readInt(1);for(let n=1;n<=i.length;n++)t+=i[i.length-n]*Math.pow(128,n);t+=s}return t}};if(u.data=new DataView(y.buffer,y.byteOffset,y.byteLength),u.readInt(4)!==1297377380)return console.warn("Header validation failed (not MIDI standard or file corrupt.)"),!1;u.readInt(4);let E={};E.formatType=u.readInt(2),E.tracks=u.readInt(2),E.track=[];var y=u.readInt(1),v=u.readInt(1);128<=y?(E.timeDivision=[],E.timeDivision[0]=y-128,E.timeDivision[1]=v):E.timeDivision=256*y+v;for(let t=1;t<=E.tracks;t++){E.track[t-1]={event:[]};var a,c=u.readInt(4);if(c===-1)break;if(c!==1297379947)return!1;u.readInt(4);let s=0,i=!1,n,f;for(;!i&&(s++,E.track[t-1].event[s-1]={},E.track[t-1].event[s-1].deltaTime=u.readIntVLV(),(n=u.readInt(1))!==-1);)if(128<=n?f=n:(n=f,u.movePointer(-1)),n===255){E.track[t-1].event[s-1].type=255,E.track[t-1].event[s-1].metaType=u.readInt(1);var d=u.readIntVLV();switch(E.track[t-1].event[s-1].metaType){case 47:case-1:i=!0;break;case 1:case 2:case 3:case 4:case 5:case 7:case 6:E.track[t-1].event[s-1].data=u.readStr(d);break;case 33:case 89:case 81:E.track[t-1].event[s-1].data=u.readInt(d);break;case 84:E.track[t-1].event[s-1].data=[],E.track[t-1].event[s-1].data[0]=u.readInt(1),E.track[t-1].event[s-1].data[1]=u.readInt(1),E.track[t-1].event[s-1].data[2]=u.readInt(1),E.track[t-1].event[s-1].data[3]=u.readInt(1),E.track[t-1].event[s-1].data[4]=u.readInt(1);break;case 88:E.track[t-1].event[s-1].data=[],E.track[t-1].event[s-1].data[0]=u.readInt(1),E.track[t-1].event[s-1].data[1]=u.readInt(1),E.track[t-1].event[s-1].data[2]=u.readInt(1),E.track[t-1].event[s-1].data[3]=u.readInt(1);break;default:this.customInterpreter!==null&&(E.track[t-1].event[s-1].data=this.customInterpreter(E.track[t-1].event[s-1].metaType,u,d)),this.customInterpreter!==null&&E.track[t-1].event[s-1].data!==!1||(u.readInt(d),E.track[t-1].event[s-1].data=u.readInt(d),this.debug&&console.info("Unimplemented 0xFF meta event! data block readed as Integer"))}}else switch((n=n.toString(16).split(""))[1]||n.unshift("0"),E.track[t-1].event[s-1].type=parseInt(n[0],16),E.track[t-1].event[s-1].channel=parseInt(n[1],16),E.track[t-1].event[s-1].type){case 15:this.customInterpreter!==null&&(E.track[t-1].event[s-1].data=this.customInterpreter(E.track[t-1].event[s-1].type,u,!1)),this.customInterpreter!==null&&E.track[t-1].event[s-1].data!==!1||(a=u.readIntVLV(),E.track[t-1].event[s-1].data=u.readInt(a),this.debug&&console.info("Unimplemented 0xF exclusive events! data block readed as Integer"));break;case 10:case 11:case 14:case 8:case 9:E.track[t-1].event[s-1].data=[],E.track[t-1].event[s-1].data[0]=u.readInt(1),E.track[t-1].event[s-1].data[1]=u.readInt(1);break;case 12:case 13:E.track[t-1].event[s-1].data=u.readInt(1);break;case-1:i=!0;break;default:if(this.customInterpreter!==null&&(E.track[t-1].event[s-1].data=this.customInterpreter(E.track[t-1].event[s-1].metaType,u,!1)),this.customInterpreter===null||E.track[t-1].event[s-1].data===!1)return console.log("Unknown EVENT detected... reading cancelled!"),!1}}return E},customInterpreter:null};if(typeof re<"u")re.exports=o;else{let h=typeof window=="object"&&window.self===window&&window||typeof self=="object"&&self.self===self&&self||typeof global=="object"&&global.global===global&&global;h.MidiParser=o}})()});var ce=function(e,r){let o=Math.min(e.length,r.length),h=e.slice(0,o),u=r.slice(0,o),E=0,y=0;for(;y<o&&E==0;)E=Math.sign(h[y]-u[y]),y++;return E},P=function(e=""){this.name=e,this.pool=[],this.point=function(r,o=!1){if(this.pool.length>0){let h=this.pool.length,u=1<<Math.floor(Math.log2(h)),E=u,y=64;for(;u>=1&&y>=0;){if(y<=0)throw new Error("TTL reached.");if(E==h)E-=u;else{let a=ce(r,this.pool[E]);switch(a){case 0:{y=0;break}case 1:{E+u<=h&&(E+=u);break}case-1:{E!=0&&(E-=u);break}default:console.warn(`Unexpected result ${a}.`)}}u=u>>1,y--}let v=!0;if(E>=this.pool.length)v=!1;else{let a=this;this.pool[E].forEach(function(c,d,t){v&&c!=r[d]&&(v=!1)}),!v&&ce(r,this.pool[E])>0&&E++}return v||o?E:-1}else return o?0:-1},this.add=function(r,o){return r.data=o,this.pool.splice(this.point(r,!0),0,r),this},this.default=function(r){console.warn(`No match in "${this.name||"(unknown)"}" for "${r}". Default action not defined.`)},this.get=function(r){let o=this.point(r);if(o>-1)return this.pool[o].data;this.default(r)},this.run=function(r,...o){let h=this.point(r);h>-1?r.subarray?this.pool[h].data(r.subarray(this.pool[h].length),...o):this.pool[h].data(r.slice(this.pool[h].length),...o):this.default(r,...o)}};var oe=class{#t={};addEventListener(e,r){this.#t[e]||(this.#t[e]=[]),this.#t[e].unshift(r)}removeEventListener(e,r){if(this.#t[e]){let o=this.#t[e].indexOf(r);o>-1&&this.#t[e].splice(o,1),this.#t[e].length<1&&delete this.#t[e]}}dispatchEvent(e,r){let o=new Event(e),h=this;o.data=r,this.#t[e]?.length>0&&this.#t[e].forEach(function(u){try{u?.call(h,o)}catch(E){console.error(E)}}),this[`on${e}`]&&this[`on${e}`](o)}};var Ne=["MSB","PRG","LSB","NME","ELC","DRM","LVL"],Be={krs:"KR",s90es:"ES",motif:"ES"},_e={krs:"Kr",s90es:"SE",motif:"ME"},j=function(e){let r=Math.floor(e/10),o=e%10;return`${r.toString(16)}${o}`},Z=class{#t;get bankInfo(){return this.#t}strictMode=!1;get(e=0,r=0,o=0,h,u=0){let E=[e,r,o],y,v=1,a=0,c,d,t=Array.from(arguments);switch(h){case"xg":{switch(e){case 0:{o===126?t[2]=125:o===127&&(t[2]=0);break}case 16:{o===126&&(t[2]=0);break}case 32:{o>125&&(t[2]=0),t[2]+=4;break}case 33:{(o>125||o===3)&&(t[2]=0),t[2]+=5;break}case 34:case 35:case 36:{o>125&&(t[2]=0),t[2]+=5;break}case 79:case 80:case 81:case 82:case 83:case 84:t[0]+=16;case 95:case 96:case 97:case 98:case 99:case 100:{o===126&&(t[2]=0);break}case 48:case 64:case 126:case 127:{o===126&&(e===127&&r===0||(t[2]=0));break}}break}case"gs":case"sc":{e===0&&o<5?t[0]=49:e>125&&o<5&&o!==2&&(t[2]=e,t[0]=49);break}case"mt32":{e===0&&(t[0]=49);break}case"sd":{switch(e){case 121:{t[0]=96;break}case 120:{t[0]=104;break}}t[0]>>1===40?t[2]|=16:t[0]>95&&t[0]<100&&(t[2]|=16,r>>4===7&&(t[0]=96));break}case"g2":{e>>1===40?t[2]|=16:e>95&&e<100&&(t[2]|=16,r>>4===7&&(t[0]=96));break}case"sg":{e===8&&o===0&&(t[2]=5);break}case"05rw":case"x5d":{e&&e<56&&(t[0]=56);break}case"s90es":case"motif":case"an1x":case"cs1x":case"cs6x":{if(e===0)break;switch(e){case 63:{switch(h){case"s90es":{o<8?t[2]+=17:o<32?t[2]+=13:t[2]=(t[2]>>3)+19;break}case"motif":{o<8?t[2]+=28:o<32?t[2]+=13:t[2]=(t[2]>>3)+19;break}case"cs1x":{switch(o>>1){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:case 8:case 9:case 10:{t[2]+=34;break}case 32:{t[2]=34+((o&1)<<2);break}case 33:{t[2]=47+((o&1)<<2);break}case 61:{t[2]=34+((o&1)<<2);break}case 62:{t[2]=47+((o&1)<<2);break}}break}}break}case 32:{o>125&&(t[2]=0),t[2]+=4;break}case 33:{(o>125||o===3)&&(t[2]=0),t[2]+=5;break}case 34:case 35:case 36:{o>125&&(t[2]=0),t[2]+=5;break}case 79:case 80:case 81:case 82:case 83:case 84:t[0]+=16;case 95:case 96:case 97:case 98:case 99:case 100:{o===126&&(t[2]=0);break}}break}}let s=" ",i="M",n="",f=0,l=0;switch(t[0]){case 0:{switch(t[2]){case 127:{i="GM-a";break}case 126:{i="GM-n";break}case 7:{i="GM-k",n="GLX";break}case 5:{i="SG-a",n="000";break}case 4:{h==="gs"||h==="sc"?(i="GM-a",n="000"):(i="SP-l",n="C/M");break}case 3:case 2:case 1:{(h==="gs"||h==="sc")&&(i="GM-a",n="000");break}case 0:{i="GM-a";break}default:i="y",f=3}break}case 8:{h==="sg"?i="GM-s":i="r:";break}case 32:case 33:case 34:case 35:case 36:{h==="xg"&&(i=`${["AP","VL","PF","DX","AN"][e&7]}-${"abcdefgh"[o]}`,f=3);break}case 48:{n=`M${(t[2]>>3).toString().padStart(2,"0")}`,i=`y${n}`,f=1;break}case 49:{t[2]>>1===63?(i=`MT-${"ba"[t[2]&1]}`,n=`C${"-/"[t[2]&1]}M`):(i="GM-a",n="000");break}case 56:{i="GM-b";break}case 57:i=["yDOC","QY10","QY20"][t[2]-112]||"yMxv",n=["DOC","QY1","QY2"][t[2]-112]||"057";case 61:case 120:{i="rDrm";break}case 62:{i="kDrm";break}case 63:{if(t[2]<17){let $=t[2];i=$<10?"kP:":"kC:",i+=$%10}else if(t[2]<34)i=["Pre1","Pre2","Pre3","Pre4","Usr1","Usr2","DrmP","DrmU","Plg1","Plg2","Plg3","Pre1","Pre2","Pre3","Pre4","Pre5","Pre6"][t[2]-17];else if(t[2]<55){let $=t[2]-34;switch($>12&&$--,o>>1){case 32:case 33:{i=`Pr${o-63}U`;break}case 61:case 62:{i=`Pr${o-121}U`;break}default:i=t[2]===46?"PrDr":`Pr${($>>2)+1}${String.fromCharCode(65+($&3))}`}}else i="Ds";f=1;break}case 64:{i="ySFX",n="SFX";break}case 67:{i="DX:S";break}case 80:case 81:case 82:case 83:{i=`Prg${"UABC"[t[0]-80]}`;break}case 88:case 89:case 90:case 91:{i=`Cmb${"UABC"[t[0]-88]}`;break}case 95:{i=`${["DR","PC"][t[2]]}-d`;break}case 96:{i=t[2]===106?"AP-a":t[2]>>4===1?"SDg":"PF",t[2]>63?l=63:t[2]>>4===1&&(l=16),f=3;break}case 97:{i=t[2]>>4===1?"SDa":"VL:",f=3,t[2]>>4===1?l=16:l=112;break}case 98:{i=t[2]>>4===1?"SDb":"SG-a",f=3,l=16;break}case 99:{i=t[2]>>4===1?"SDc":"DX",t[2]>63?l=63:t[2]>>4===1&&(l=16),f=3;break}case 100:{i="AN",t[2]>63?l=63:t[2]>>4===1&&(l=16),f=3;break}case 104:case 105:case 106:case 107:{i="SDd",l=104;break}case 121:{i=`GM-${t[2]?"":"a"}`,f=3;break}case 122:{i="lDrm";break}case 126:{i="yDrS";break}case 127:{t[2]===127?i="rDrm":i="yDrm";break}default:t[0]<48?i="r:":i="M"}i.length<4&&(i+=`${[e,o,t[0],t[2]][f]-l}`.padStart(4-i.length,"0")),n.length<3&&(n+=`${[e,o,e,o][f]}`.padStart(3-n.length,"0")),h==="xg"&&(e===0?t[2]<100?i=i.replace("y0","y:"):t[2]===125&&(i="y126"):e===16?(y=`Voice${((t[2]<<7)+t[1]+1).toString().padStart(3,"0")}`,s=" "):e===35&&o>>1===2&&(y=`DXCH_${(((t[2]&1)<<7)+r+1).toString().padStart(3,"0")}`,s=" "));let b=[t[0],t[1],t[2]];for(;!(y?.length>=0);)if(y=this.#t[t[1]||0][(t[0]<<8)+t[2]]?.name,y){let $=this.#t[t[1]||0][(t[0]<<8)+t[2]];v=$?.poly||v,a=$?.type||a,c=$?.drum,d=$?.level}else if(this.strictMode)y="",s="?";else if(t[0]===0&&t[1]===0&&t[2]===0)y="Unloaded";else if(this.#t[t[1]||0][t[0]<<8])t[0]===0?(t[2]=0,s="^"):t[2]<1?(t[0]=0,s="*"):(t[2]--,s="^");else if(e===48)t[0]=0,t[2]=0,s="!";else if(e===62)t[1]--,s=" ",t[1]<1&&!y?.length&&(t[0]=0,s="!");else if(e<63)t[0]===0?(t[2]=0,s="^"):t[2]<1?(t[0]=0,s="*"):t[2]--;else if(e===80)y=`PrgU:${r.toString().padStart(3,"0")}`,s="!";else if(e===88)y=`CmbU:${r.toString().padStart(3,"0")}`,s="!";else if(e===121)y=`GM2Vox0${o}`,s="#";else if(e===122)if(t[1]===32?t[1]:t[1]%=7,y=this.#t[t[1]||0][(t[0]<<8)+t[2]]?.name,y){s=" ";let $=this.#t[t[1]||0][(t[0]<<8)+t[2]];v=$?.poly||v,a=$?.type||a,c=$?.drum,d=$?.level}else y="",s="*";else t[1]===0?(y=`${e.toString().padStart(3,"0")} ${r.toString().padStart(3,"0")} ${o.toString().padStart(3,"0")}`,s="!"):t[0]===0?(t[2]=0,s="^"):t[2]>0?t[2]--:t[1]>0?(t[1]=0,s="!"):(t[0]=0,s="?");let C=[t[0],t[1],t[2]];switch(s){case"^":{switch(h){case"gs":case"sc":case"ns5r":{s=" ";break}}e===127&&s==="^"&&(s=" ");break}}let k="??";switch(t[0]){case 0:{t[2]===0?k="GM":t[2]===5||t[2]===7?k="KG":t[2]<126&&(k="XG");break}case 32:case 33:case 35:case 36:{t[2]>4?k=["AP","VL","PF","DX","AN"][t[0]-32]:k="GS";break}case 48:{k="MU";break}case 49:{t[2]>>1===63?k="MT":t[2]<5&&(k="GM");break}case 56:{k="AG";break}case 61:case 80:case 83:case 88:case 89:case 91:{k="AI";break}case 62:case 82:case 90:{k="XD";break}case 63:{t[2]<17?k="KR":t[2]<34?k="ES":t[2]<55?k="CS":k="DS";break}case 64:case 126:{k="XG";break}case 67:case 99:{k=t[2]>>4===1?"SD":"DX";break}case 81:{k="RW";break}case 95:{k=["DR","PC"][t[2]];break}case 96:{k=t[2]===106?"AP":t[2]>>4===1?"SD":"PF";break}case 97:{k=t[2]>>4===1?"SD":"VL";break}case 98:{k=t[2]>>4===1?"SD":"SG";break}case 100:{k="AN";break}case 104:case 105:case 106:case 107:{k="SD";break}case 120:{k=r===0?"GM":"GS";break}case 121:{k=t[2]?"G2":"GM";break}case 122:{k="KG";break}case 127:{k=t[2]===127?"MT":r===0?"GM":"XG";break}default:t[0]<48&&(t[0]===16&&h==="xg"?k="XG":k="GS")}if(s!==" ")switch(h){case"krs":case"s90es":case"motif":{y="",k=Be[h];break}default:self.debugMode&&(y="")}return{name:y||`${_e[h]||h.toUpperCase()}${j(e||0)}${j(r||0)}${j(o||0)}`,poly:v,type:a,drum:c,level:d,iid:b,eid:C,sid:E,ending:s,sect:i,bank:n,standard:k,mode:h}}async load(e,r,o="(internal)",h){let u=this,E=[],y=0,v=0,a=0;e.split(`
`).forEach(function(c,d){let t=c.split("	"),s=[];if(d===0){if(t.forEach(function(i,n){E[Ne.indexOf(i)]=n}),E.length<4){console.debug("Debugger launched.");debugger}}else{let i=0,n=0,f=0,l,b=1,C=0,k,$;t.forEach(function(M,N){switch(N){case E[0]:{i=parseInt(M);break}case E[1]:{n=parseInt(M);break}case E[2]:{f=parseInt(M);break}case E[3]:{l=M;break}case E[4]:{M=parseInt(M),M<16?b=M+1:(C=(M&15)+1,b=C);break}case E[5]:{$=M;break}case E[6]:{M?.constructor&&(k=parseInt(M));break}}}),u.#t[n]=u.#t[n]||[];let T=u.#t[n],D={msb:i,prg:n,lsb:f,name:l,poly:b,type:C,drum:$,level:k,priority:h},Y=!1;h<T[i<<8|f]?.priority&&(Y=!0,a++),(!T[i<<8|f]||Y||r)&&(T[i<<8|f]=D,y++),v++}}),r||console.debug(`Map "${o}": ${v} total, ${y} loaded (${y-a} + ${a}).`)}clearRange(e){let r=e.prg!==void 0?e.prg.constructor===Array?e.prg:[e.prg,e.prg]:[0,127],o=e.msb!==void 0?e.msb.constructor===Array?e.msb:[e.msb,e.msb]:[0,127],h=e.lsb!==void 0?e.lsb.constructor===Array?e.lsb:[e.lsb,e.lsb]:[0,127];for(let u=o[0];u<=o[1];u++){let E=u<<8;for(let y=h[0];y<=h[1];y++){let v=E+y;for(let a=r[0];a<=r[1];a++)delete this.#t[a][v]}}}init(){this.#t=[];for(let e=0;e<128;e++)this.#t.push([""])}async loadFiles(...e){this.init();let r=this;e.forEach(async function(o,h){try{r.load(await(await fetch(`./data/bank/${o}.tsv`)).text(),!1,o,h)}catch{console.error(`Failed loading "${o}.tsv".`)}})}constructor(...e){this.loadFiles(...e)}};var le=class{#t={};context;set(e,r){this.#t[e]=r}has(e){return!!this.#t[e]}async read(e,r){if(!this.has(e))throw new Error(`No decoder registered for "${e}"`);return await this.#t[e].call(this.context||this,r)}};var He=function(e,r){let o=!0;return r.forEach((h,u)=>{o=o&&e[u]===h}),o},H=function(e){let r=0;return e.forEach(o=>{r*=256,r+=o}),r},I=new TextDecoder,G=new le;G.set("s7e",async function(e){let r=new Uint8Array(await e.slice(0,65536).arrayBuffer()),o="MSB	LSB	PRG	NME",h=[0,0,0,0],u=32,E=0,y=0,v=!0,a=[],c=0;for(;v;){let d=r.subarray(E);([()=>{I.decode(d.subarray(0,4))==="YSFC"?(E+=80,y=1):E++},()=>{if(He(d.subarray(0,4),h))a.forEach((t,s,i)=>{let n=H(r.subarray(t.start+4,t.start+8));t.length=n}),y=2;else{let t=I.decode(d.subarray(0,4)),s=H(d.subarray(4,8));a.push({type:t,start:s}),E+=8}},()=>{let t=a[c],s=r.subarray(t.start,t.start+t.length),i=32;switch(t.type){case"ENVC":{let n=u;for(;n<s.length;){let f=s.subarray(n,n+i),l=I.decode(f.subarray(0,10)).trimEnd();l.slice(0,5)==="Init "&&(l=""),l&&(o+=`
063	${(f[17]+13).toString().padStart(3,"0")}	${f[19].toString().padStart(3,"0")}	${l}`),n+=i}break}case"EDVC":{let n=u;for(;n<s.length;){let f=s.subarray(n,n+i),l=I.decode(f.subarray(0,10)).trimEnd();l.slice(0,5)==="Init "&&(l=""),l&&(o+=`
063	024	${f[19].toString().padStart(3,"0")}	${l}`),n+=i}break}case"EPVC":{let n=32,f=u;for(;f<s.length;){let l=s.subarray(f,f+n),b=I.decode(l.subarray(0,10)).trimEnd();b==="----------"&&(b=""),b&&(o+=`
063	${(l[17]+1).toString().padStart(3,"0")}	${l[19].toString().padStart(3,"0")}	${b}`),f+=n}break}}c++,c>=a.length&&(y=3,v=!1)}][y]||(()=>{v=!1}))()}return o});G.set("pcg",async function(e){let r=new Uint8Array(await e.arrayBuffer()),o="MSB	LSB	PRG	NME",h=100,u=0,E=0,y=!0,v=[],a=0;for(;y;){let c=r.subarray(h);([()=>{y=I.decode(c.subarray(0,4))==="INI2",E=c[15],h+=16,u=1},()=>{let d=I.decode(c.subarray(0,4)),t=c[5],s=c[7],i=c[11],n=H(c.subarray(12,16)),f=H(c.subarray(16,20)),l=H(c.subarray(36,40)),b=I.decode(c.subarray(44,44+i));v.push({type:d,tipMsb:t,tipLsb:s,nameLen:i,length:n,start:f,entryLen:l,name:b}),h+=64,E--,E<1&&(u=2)},()=>{let d=v[a],t=r.subarray(d.start,d.start+d.length);switch(d.type){case"PRG1":break;case"PBK1":{let s=63,i=(d.tipMsb?6:0)+d.tipLsb;for(let n=0;n<128;n++){let f=n*d.entryLen,l=t.subarray(f,f+d.entryLen),b=I.decode(l.subarray(0,24)).trimEnd().replace("InitProg","");b.length&&i>5&&(o+=`
${s.toString().padStart(3,"0")}	${i.toString().padStart(3,"0")}	${n.toString().padStart(3,"0")}	${b}`)}break}case"CBK1":{let s=63,i=(d.tipMsb?3:0)+d.tipLsb+10;for(let n=0;n<128;n++){let f=n*d.entryLen,l=t.subarray(f,f+d.entryLen),b=I.decode(l.subarray(0,24)).trimEnd().replace("InitCombi","");b.length&&i>12&&(o+=`
${s.toString().padStart(3,"0")}	${i.toString().padStart(3,"0")}	${n.toString().padStart(3,"0")}	${b}`)}break}}a++,a>=v.length&&(u=3,y=!1)}][u]||(()=>{y=!1}))()}return o});var X=["off","hall","room","stage","plate","delay LCR","delay LR","echo","cross delay","early reflections","gate reverb","reverse gate"].concat(new Array(4),["white room","tunnel","canyon","basement","karaoke"],new Array(43),["pass through","chorus","celeste","flanger","symphonic","rotary speaker","tremelo","auto pan","phaser","distortion","overdrive","amplifier","3-band EQ","2-band EQ","auto wah"],new Array(1),["pitch change","harmonic","touch wah","compressor","noise gate","voice channel","2-way rotary speaker","ensemble detune","ambience"],new Array(4),["talking mod","Lo-Fi","dist + delay","comp + dist + delay","wah + dist + delay","V dist","dual rotor speaker"]),K=["melodic","drums","drum set 1","drum set 2","drum set 3","drum set 4","drum set 5","drum set 6","drum set 7","drum set 8"],Ge=[17.1,18.6,20.2,21.8,23.3,24.9,26.5,28,29.6,31.2,32.8,34.3,35.9,37.5,39,40.6,42.2,43.7,45.3,46.9,48.4,50],B=[20,22,25,28,32,36,40,45,50,56,63,70,80,90,100,110,125,140,160,180,200,225,250,280,315,355,400,450,500,560,630,700,800,900,1e3,1100,1200,1400,1600,1800,2e3,2200,2500,2800,3200,3600,4e3,4500,5e3,5600,6300,7e3,8e3,9e3,1e4,11e3,12e3,14e3,16e3,18e3,2e4],de=[0,.04,.08,.13,.17,.21,.25,.29,.34,.38,.42,.46,.51,.55,.59,.63,.67,.72,.76,.8,.84,.88,.93,.97,1.01,1.05,1.09,1.14,1.18,1.22,1.26,1.3,1.35,1.39,1.43,1.47,1.51,1.56,1.6,1.64,1.68,1.72,1.77,1.81,1.85,1.89,1.94,1.98,2.02,2.06,2.1,2.15,2.19,2.23,2.27,2.31,2.36,2.4,2.44,2.48,2.52,2.57,2.61,2.65,2.69,2.78,2.86,2.94,3.03,3.11,3.2,3.28,3.37,3.45,3.53,3.62,3.7,3.87,4.04,4.21,4,37,4.54,4.71,4.88,5.05,5.22,5.38,5.55,5.72,6.06,6.39,6.73,7.07,7.4,7.74,8.08,8.41,8.75,9.08,9.42,9.76,10.1,10.8,11.4,12.1,12.8,13.5,14.1,14.8,15.5,16.2,16.8,17.5,18.2,19.5,20.9,22.2,23.6,24.9,26.2,27.6,28.9,30.3,31.6,33,34.3,37,39.7],fe=function(e){let r=.1,o=-.3;return e>66?(r=5,o=315):e>56?(r=1,o=47):e>46&&(r=.5,o=18.5),r*e-o},he=function(e){return e>105?Ge[e-106]:e>100?e*1.1-100:e/10},ue=",a,i,u,e,o,ka,ki,ku,ke,ko,ky,kw,sa,si,su,se,so,sh,ta,ti,tu,te,to,t,ch,t,s,na,ni,nu,ne,no,ny,nn,ha,hi,hu,he,ho,hy,fa,fi,fu,fe,fo,ma,mi,mu,me,mo,my,mm,ya,yu,ye,yo,ra,ri,ru,re,ro,ry,wa,wi,we,wo,ga,gi,gu,ge,go,gy,gw,za,zi,zu,ze,zo,ja,ji,ju,je,jo,jy,da,di,du,de,do,dy,ba,bi,bu,be,bo,by,va,vi,vu,ve,vo,pa,pi,pu,pe,po,py,nga,ngi,ngu,nge,ngo,ngy,ng,hha,hhi,hhu,hhe,hho,hhy,hhw,*,_,,,~,.".split(","),J={};`hi*,
ka,ã‹
ki,ã
ku,ã
ke,ã‘
ko,ã“
ky,ã!
kw,ãl
tsu,ã¤
ts,ã¤l
sa,ã•
si,ã™ãƒ
su,ã™
se,ã›
so,ã
shi,ã—
sh,ã—!
ta,ãŸ
ti,ã¦ãƒ
tu,ã¨ã…
te,ã¦
to,ã¨
tchy,ã¡!
tchi,ã¡
na,ãª
ni,ã«
nu,ã¬
ne,ã­
no,ã®
ny,ã«!
nn,ã‚“
ha,ã¯
hi,ã²
hu,ã»ã…
he,ã¸
ho,ã»
hy,ã²!
fa,ãµã
fi,ãµãƒ
fu,ãµ
fe,ãµã‡
fo,ãµã‰
ma,ã¾
mi,ã¿
mu,ã‚€
me,ã‚
mo,ã‚‚
my,ã¿!
mm,ã‡º
ra,ã‚‰
ri,ã‚Š
ru,ã‚‹
re,ã‚Œ
ro,ã‚
ry,ã‚Š!
wa,ã‚
wi,ã‚
we,ã‚‘
wo,ã‚’
nga,ã‹ã‚š
ngi,ãã‚š
ngu,ãã‚š
nge,ã‘ã‚š
ngo,ã“ã‚š
ngy,ãã‚š!
ng,ãƒ³
ga,ãŒ
gi,ãŽ
gu,ã
ge,ã’
go,ã”
gy,ãŽ!
gw,ãl
za,ã–
zi,ãšãƒ
zu,ãš
ze,ãœ
zo,ãž
ja,ã˜ã‚ƒ
ji,ã˜
ju,ã˜ã‚…
je,ã˜ã‡
jo,ã˜ã‚‡
jy,ã˜!
da,ã 
di,ã§ãƒ
du,ã©ã…
de,ã§
do,ã©
dy,ã§!
ba,ã°
bi,ã³
bu,ã¶
be,ã¹
bo,ã¼
by,ã³!
va,ã‚”ã
vi,ã‚”ãƒ
vu,ã‚”
ve,ã‚”ã‡
vo,ã‚”ã‰
pa,ã±
pi,ã´
pu,ã·
pe,ãƒš
po,ã½
py,ã´!
!ya,ã‚ƒ
!yu,ã‚…
!ye,ã‡
!yo,ã‚‡
ya,ã‚„
yu,ã‚†
ye,ð›€
yo,ã‚ˆ
!a,ã‚ƒ
!u,ã‚…
!e,ã‡
!o,ã‚‡
!a,ã‚ƒ
!u,ã‚…
!e,ã‡
!o,ã‚‡
la,ã
li,ãƒ
lu,ã…
le,ã‡
lo,ã‰
a,ã‚
i,ã„
u,ã†
e,ãˆ
o,ãŠ
*,ã£
~,
^,
_,`.split(`
`).forEach(e=>{let r=e.split(",");J[r[0]]=r[1]});var pe=function(e){let r=e;e[0]=="*"&&(r=r.slice(1)),["aa","ii","uu","ee","oo"].forEach(h=>{for(;r.indexOf(h)>-1;)r=r.replace(h,h[0])});for(let h in J)r=r.replaceAll(h,J[h]);r.indexOf("ã‚“")==0&&r.length>1&&(r=r.slice(1));let o=r.indexOf("!");return o>-1&&r.length>1&&(r=r.slice(o+1)),r},be=function(e){return e?e<96?`cc${e}`:["aftertouch","velocity","pitch bend"][e-96]:"off"},Ee={u8:["utf-8","Unicode"],l1:["l9","Pan-Latin"],jp:["sjis","Japanese"],kr:["iso-2022-kr","Korean"],hz:["gb18030","Simplified Chinese"],b5:["big5","Traditional Chinese"],cy:["koi8-ru","Cyrillic"],vn:["tcvn-5773-1993","Vietnamese"]},ge={m:"Male",f:"Female",c:"Chorus",s:"Solo",p:"Plural",w:"Words",x:"Non-vocal"};var ee=["room 1","room 2","room 3","hall 1","hall 2","plate","delay","panning delay"],ye=["chorus 1","chorus 2","chorus 3","chorus 4","feedback","flanger","short delay","short delay feedback"],Ce=["delay 1","delay 2","delay 3","delay 4","pan delay 1","pan delay 2","pan delay 3","pan delay 4","delay to reverb","pan repeat"];var Xe={0:"thru",256:"stereo EQ",257:"spectrum",258:"enhancer",259:"humanizer",272:"overdrive",273:"distortion",288:"phaser",289:"auto wah",290:"rotary",291:"stereo flanger",292:"step flanger",293:"tremelo",294:"auto pan",304:"compressor",305:"limiter",320:"hexa chorus",321:"tremelo chorus",322:"stereo chorus",323:"space D",324:"3D chorus",336:"stereo delay",337:"modulated delay",338:"3-tap delay",339:"4-tap delay",340:"tremelo control delay",341:"reverb",342:"gate reverb",343:"3D delay",352:"2-pitch shifter",353:"feedback pitch shifter",368:"3D auto",369:"3D manual",370:"Lo-Fi 1",371:"Lo-Fi 2",512:"overdrive - chorus",513:"overdrive - flanger",514:"overdrive - delay",515:"distortion - chorus",516:"distortion - flanger",517:"distortion - delay",518:"enhancer - chorus",519:"enhancer - flanger",520:"enhancer - delay",521:"chorus - delay",522:"flanger - delay",523:"chorus - flanger",524:"rotary multi",1024:"guitar multi 1",1025:"guitar multi 2",1026:"guitar multi 3",1027:"clean guitar multi 1",1028:"clean guitar multi 2",1029:"bass multi",1030:"rhodes multi",1280:"keyboard multi",4352:"chorus / delay",4353:"flanger / delay",4354:"chorus / flanger",4355:"overdrive / distortion",4356:"overdrive / rotary",4357:"overdrive / phaser",4358:"overdrive / auto wah",4359:"phaser / rotary",4360:"phaser / auto wah"},Ke={66307:["drive"],66309:["vowel",e=>"aiueo"[e]],94723:["pre-filter"],94724:["Lo-Fi type"],94725:["post-filter"],94979:["Lo-Fi type"],94980:["fill type",e=>["off","LPF","HPF"][e]],94984:["noise type",e=>["white","pink"][e]],94987:["disc type",e=>["LP","SP","EP","RND"]],94990:["hum type",e=>`${e+5}0Hz`],94993:["M/S",e=>["mono","stereo"][e]]},te=function(e){return Xe[(e[0]-32<<8)+e[1]]||`0x${e[0].toString(16).padStart(2,"0")}${e[1].toString(16).padStart(2,"0")}`},me=function(e,r,o){let h=(e[0]-32<<16)+(e[1]<<8)+r,u=Ke[h]||{},E=u[0];if(E?.length)return E+=`: ${(u[1]||function(){})(o)||o}`,E},ae=[68,48,95,78,41,3,110,122,0];var R=function(e=64){return Math.round(2e3*Math.log10(e/64))/100};var L=function(e){let r=0;return e.forEach(o=>{r+=o,r=r&127}),~r+1&127},A=function(e,r){let o=0,h=0;for(let u=0;u<e.length;u++){let E=u%8-1,y=(h>>E&1)<<7,v=e[u];v+=y,u%8!==0?(r(v,o,e),o++):h=e[u]}};var V=function(e){let r=Math.floor(e*14.2);return r<128?r:0},w=function(){return self.Bun?!0:self.debugMode??!1};var bt="â™­ð„«,ð„«,â™­,,â™¯,ð„ª,ð„ªâ™¯".split(",");var Pt=Ue(ve(),1),S=["?","gm","gs","sc","xg","g2","mt32","doc","qy10","qy20","ns5r","x5d","05rw","k11","sg","sd","pa","krs","s90es","motif","cs6x","trin","an1x","cs1x"],Ve={gm2:"g2","mt-32":"mt32","c/m":"mt32",ag10:"05rw","ag-10":"05rw","05r/w":"05rw",x5:"05rw",x5dr:"x5d",gmega:"k11","kross 2":"krs","motif es":"motif","s90 es":"s90es",trinity:"trin","tr-rack":"trin"},Fe=["melodic","drum","menu"],ke={"?":[0,0,120,0,0],gm:[0,0,120,0,0],gs:[0,0,120,0,0],sc:[0,0,120,0,0],xg:[0,0,127,0,0],g2:[0,0,120,0,0],mt32:[0,127,127,0,127],doc:[57,112,127,57,112],qy10:[57,113,127,57,113],qy20:[57,114,127,57,114],ns5r:[0,0,61,0,0],x5d:[82,0,62,56,0],"05rw":[81,0,62,56,0],k11:[0,0,122,0,0],sg:[0,0,122,0,0],sd:[97,0,105,0,0],krs:[121,0,120,0,0],s90es:[0,0,127,0,0],motif:[0,0,127,0,0],cs6x:[0,0,127,0,0],trin:[0,0,61,0,0],an1x:[36,3,127,0,0],cs1x:[0,0,127,63,0]},Ye=[9,25,41,57,73,89,105,121],ze=[0,3,81,84,88],$e={8:"Off",9:"On",10:"Note aftertouch",11:"cc",12:"pc",13:"Channel aftertouch",14:"Pitch"},z={0:0,1:1,2:3,5:4},we={0:0,1:1,2:2,5:3},xe=[[0,24],[0,127],[0,127],[40,88],[0,127],[0,127]],ie=[36,37,48,49,52,53],Q=[20,21,22,23,24,25,26,28,29,30,31,36,37,48,49,52,53,64,65],Se={26:127,29:0,30:0,31:0,52:12,53:54},U=[0,1,2,4,5,6,7,8,10,11,12,13,14,15,16,17,18,19,20,21,22,26,28,32,38,40,41,42,43,44,45,46,47,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,80,81,82,83,84,91,92,93,94,95,98,99,100,101,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157],We=[2,4,12,13,14,15,16,17,18,19,20,21,40,41,42,43,44,45,46,47,80,81,83,136,130,131,132,133,134,135,137,138,139,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157],qe=[33,102,99,32,100,8,9,10],Te=[0,16,25,40,32,64,24,48],m={};S.forEach((e,r)=>{m[e]=r});var g=[];U.forEach((e,r)=>{g[e]=r});var O={length:Q.length};Q.forEach((e,r)=>{O[e]=r});var Qe={};Fe.forEach((e,r)=>{Qe[e]=r});var je=function(e){let r=[],o=0;return e?.forEach(function(h,u){h===247?r.push(e.subarray(o,u)):h===240&&(o=u+1)}),r.length||r.push(e.subarray(0)),w()&&console.debug(r),r};var se=8,p={port:se,ch:se<<4,chShift:Math.ceil(Math.log2(se))+4,cc:U.length,nn:128,pl:512,tr:256,cmt:14,rpn:6,rpnt:4,nrpn:ie.length,ace:8,drm:8,dpn:Q.length,dnc:128,ext:3,efx:7,cvn:12,redir:32,vxPrim:3,invalidCh:255};p.chcc=p.cc*p.ch;var F={bank0:128},Ze=new TextDecoder("l9"),x=new Uint16Array(p.ch),_=new Uint16Array(p.ch),Je=new Uint16Array(p.ch),W=new Uint16Array(p.ch),et=new Uint16Array(p.ch),q=new Uint16Array(p.ch),Me=new Array(p.drm);for(let e=0;e<p.ch;e++)x[e]=e*p.cc,_[e]=e*p.rpn,Je[e]=e*p.nrpn,W[e]=e*p.ace,et[e]=e*p.ext,q[e]=e*p.cvn;for(let e=0;e<p.drm;e++){Me[e]=new Uint16Array(p.dpn);let r=e*p.dpn*p.dnc;for(let o=0;o<p.dpn;o++)Me[e][o]=r+o*p.dnc}var Ot=class extends oe{NOTE_IDLE=0;NOTE_ATTACK=1;NOTE_DECAY=2;NOTE_SUSTAIN=3;NOTE_HELD=4;NOTE_RELEASE=5;NOTE_SOSTENUTO_ATTACK=8;NOTE_SOSTENUTO_DECAY=9;NOTE_SOSTENUTO_SUSTAIN=10;NOTE_SOSTENUTO_HELD=11;NOTE_MUTED_RECOVERABLE=16;CH_MELODIC=0;CH_DRUMS=1;CH_DRUM1=2;CH_DRUM2=3;CH_DRUM3=4;CH_DRUM4=5;CH_DRUM5=6;CH_DRUM6=7;CH_DRUM7=8;CH_DRUM8=9;DUMP_ALL=0;DUMP_ONCE=1;DUMP_MODE=2;EXT_NONE=0;EXT_VL=1;EXT_DX=3;VLBC_SYSTEM=0;VLBC_BRTHEXPR=1;VLBC_VELOINIT=2;VLBC_VELOALL=3;CH_INACTIVE=0;CH_ACTIVE=1;CH_DISABLED=2;KARAOKE_NONE=0;KARAOKE_TEXT=1;KARAOKE_XF=2;#t=0;#C=0;#P=0;#N=new Array(11);get#w(){return this.#N[this.#C]}set#w(e){this.#N[this.#C]=e}#x=new Uint8Array(p.ch);#c=new Uint8Array(p.ch);#a=new Uint8Array(p.ch);#e=new Uint8Array(p.chcc<<1);#y=new Uint8Array(p.ch*p.ace);#s=new Uint8Array(p.ch*p.vxPrim);#b=new Uint8Array(p.ch*p.nn);#m=new Uint8Array(p.ch);#h=new Uint16Array(p.pl);#l=new Uint8Array(p.pl);#B=new Int16Array(p.ch);#D=new Uint8Array(p.ch);#F=new Uint8Array(p.ch);#v=new Uint8Array(p.ch*p.ext);#r=new Uint8Array(p.ch*p.rpn);#i=new Uint8Array(p.ch*p.rpnt);#ne=new Int8Array(p.ch*ie.length);#$=new Uint8Array(p.drm*p.dpn*p.dnc);#A=new Uint8Array(p.drm*2);#S=new Uint8Array(p.efx*3);#ce=new Uint8Array(p.ch);#Y=new Uint8Array(p.ch*p.redir);#p=new Uint8Array(p.port);#oe=new Uint8Array(p.port);#z=new Uint8Array(p.ch);#M=new Uint8Array(p.ch);#W=new Uint8Array(p.ch*p.cvn);#H=new Uint8Array(128);#O=new Uint8Array(p.cmt*8);#le=new Uint8Array(1024);#G=new Uint8Array(p.cmt*64);#u={};modelEx={sc:{showBar:!0,invBar:!1,invDisp:!1,peakHold:1},cs1x:{perfCh:0}};#n;#I;#ue;#d=100;#q=0;#de=500;#Q=0;#j=0;#ge=32;#Z=!1;#X="";#K=0;#pe=0;#fe=0;#L=!0;#o=0;#ye=1;#be;#f=!1;#he=0;#J=new Array(p.ch);#T=[];#_=new Uint8Array(p.ch);#V=new Uint8Array(p.tr);baseBank=new Z("gm2","ns5r","xg","gs","sd","gmega","plg-vl","plg-pf","plg-dx","plg-an","plg-dr","plg-sg","kross","s90es","cs2x");userBank=new Z("gm2");initOnReset=!1;aiEfxName="";polyIndexShrink=!0;polyIndexLatest=0;polyIndexLast=0;chRedir(e,r,o){let h=this;if(h.#V[r])return(h.#V[r]-1)*16+e;if(h.#t===m.sc||h.#t===m.sd){if(o===1)return e;let u=0,E=!0;for(;E;)h.#_[e+u]===0?(h.#_[e+u]=r,console.debug(`Assign track ${r} to channel ${e+u+1}.`),E=!1):this.#_[e+u]===r?E=!1:(u+=16,u>=128&&(u=0,E=!1));return e+u}else return e}getTrackPort(e){return this.chRedir(0,e,!0)>>4}forceVoiceRefresh(){for(let e=0;e<p.ch;e++)this.#x[e]&&this.dispatchEvent("voice",{part:e})}#k=[];#ee;#E={nOff:(e,r)=>{let o=e*128+r,h=this.#h.lastIndexOf(o);if(h>-1)if(this.getChCc(e,64)>>6)this.#l[h]=this.NOTE_HELD,this.dispatchEvent("note",{part:e,note:r,velo:this.#b[o],state:this.NOTE_HELD});else if(this.getChCc(e,66)>>6&&this.#l[h]===this.NOTE_SOSTENUTO_SUSTAIN)this.#l[h]=this.NOTE_SOSTENUTO_HELD,this.dispatchEvent("note",{part:e,note:r,velo:this.#b[o],state:this.NOTE_SOSTENUTO_HELD});else{this.#h[h]=0,this.#b[o]=0,this.#l[h]=this.NOTE_IDLE;let u=this.getExt(e)[1];(u===this.VLBC_VELOINIT||u===this.VLBC_VELOALL)&&this.setChCc(e,129,0),this.dispatchEvent("note",{part:e,note:r,velo:0,state:this.NOTE_IDLE})}if(this.#m[e]){for(let u=this.polyIndexLast;u>=0;u--)if(this.#h[u]>>7===e&&this.#l[u]!==0){this.#l[u]===this.NOTE_MUTED_RECOVERABLE&&(this.#l[u]=this.NOTE_SUSTAIN);break}}this.polyIndexShrink&&this.polyIndexLast>0&&this.#l[this.polyIndexLast]===0&&this.polyIndexLast--},nOn:(e,r,o)=>{let h=e*128+r,u=0;if(this.#m[e])for(let E=0;E<=this.polyIndexLast;E++)this.#h[E]>>7===e&&this.#l[E]!==0&&(this.#l[E]=this.NOTE_MUTED_RECOVERABLE);for(;this.#l[u]>0&&this.#h[u]!==h;)u++;if(u<p.pl){this.#h[u]=h,this.#b[h]=o,this.#l[u]=this.NOTE_SUSTAIN,this.#D[e]<o&&(this.#D[e]=o);let E=this.getExt(e)[1];(E===this.VLBC_VELOINIT||E===this.VLBC_VELOALL)&&this.setChCc(e,129,o),this.dispatchEvent("note",{part:e,note:r,velo:o,state:this.NOTE_SUSTAIN}),this.polyIndexLatest=u+1,u>this.polyIndexLast&&(this.polyIndexLast=u)}else console.error("Polyphony exceeded.")},nAt:(e,r,o)=>{},cAt:(e,r)=>{},hoOf:e=>{this.#l.forEach((r,o)=>{if(r===this.NOTE_HELD){let h=this.#h[o],u=h>>7;e===u&&(this.#l[o]=this.NOTE_IDLE,this.#h[o]=0,this.#b[h]=0,this.dispatchEvent("note",{part:e,note:h&127,velo:0,state:this.NOTE_IDLE}))}})},soOn:e=>{this.#l.forEach((r,o)=>{let h;switch(r){case this.NOTE_ATTACK:{h=this.NOTE_SOSTENUTO_ATTACK;break}case this.NOTE_DECAY:{h=this.NOTE_SOSTENUTO_DECAY;break}case this.NOTE_SUSTAIN:{h=this.NOTE_SOSTENUTO_SUSTAIN;break}}if(h){this.#l[o]=h;let u=this.#h[o];this.dispatchEvent("note",{part:e,note:u&127,velo:this.#b[u],state:h})}})},soOf:e=>{this.#l.forEach((r,o)=>{if(r===this.NOTE_SOSTENUTO_HELD){let h=this.#h[o],u=h>>7;e===u&&(this.#l[o]=this.NOTE_IDLE,this.#h[o]=0,this.#b[h]=0,this.dispatchEvent("note",{part:e,note:h&127,velo:0,state:this.NOTE_IDLE}))}})},ano:e=>{this.#h.forEach(r=>{let o=r>>7,h=r&127;r===0&&this.#b[0]===0||o===e&&this.#E.nOff(o,h)})}};#Ee={8:function(e){let r=e.channel,o=e.data[0];this.#E.nOff(r,o)},9:function(e){let r=e.channel,o=this;if(o.getChModeId(r)===m.xg&&o.#a[r]>1){let E=o.getChDrumFirstWrite(r);E[0]&&E[1]!==p.invalidCh&&!o.#x[r]&&(o.copyChSetup(E[1],r),o.dispatchEvent("voice",{part:r}),console.debug(`Part CH${r+1} copied from CH${E[1]+1}.`))}o.setChActive(r,1);let h=e.data[0],u=e.data[1];u>0?o.#E.nOn(r,h,u):o.#E.nOff(r,h)},10:function(e){let r=e.channel,o=r*128+e.data[0];this.#h.indexOf(o)>-1&&(this.#b[o]=data[1],this.getExt(r)[1]===this.VLBC_VELOALL&&this.setChCc(r,129,data[1]),this.dispatchEvent("note",{part:r,note:e.data[0],velo:e.data[1],state:this.NOTE_SUSTAIN}))},11:function(e){let r=e.channel,o=this,h=o.#J[r],u=h[e.data[0]];u&&(e.data[0]=u),[0,32].indexOf(e.data[0])>-1&&(()=>{switch(this.#t){case m.s90es:case m.motif:{if(e.data[0]===0){[0,63].indexOf(e.data[1])>-1&&o.setChActive(r,1);break}e.data[1]&&o.setChActive(r,1);break}default:break}})();let E=r*p.ext,y=o.getChModeId(r);switch(e.data[0]){case 96:return;case 97:return;case 120:return;case 121:{this.#E.ano(r),this.#B[r]=0,o.resetChCc(r,1,0),o.resetChCc(r,5,0),o.resetChCc(r,64,0),o.resetChCc(r,65,0),o.resetChCc(r,66,0),o.resetChCc(r,67,0),o.resetChCc(r,11,127),o.resetChCc(r,101,127),o.resetChCc(r,100,127),o.resetChCc(r,99,127),o.resetChCc(r,98,127);return}case 123:{this.#E.ano(r);return}case 124:{this.#E.ano(r);return}case 125:{this.#E.ano(r);return}case 126:{this.#m[r]=1,this.#E.ano(r);return}case 127:{this.#m[r]=0,this.#E.ano(r);return}}if(g[e.data[0]]===void 0)console.warn(`cc${e.data[0]} is not accepted.`);else{switch(We.indexOf(e.data[0])>-1&&this.allocateAce(r,e.data[0]),e.data[0]){case 0:{switch(w()&&console.debug(`${S[this.#t]}, CH${r+1}: ${e.data[1]}`),this.#t===0?e.data[1]<48?(this.#a[r]>0&&(e.data[1]=this.getChPrimitive(r,1,!1),e.data[1]=120,console.debug(`Forced channel ${r+1} to stay drums.`)),e.data[1]>0&&(console.debug(`Roland GS detected with MSB: ${e.data[1]}`),this.switchMode("gs"))):e.data[1]===56?this.switchMode(this.#n.x5===82?"x5d":"05rw"):e.data[1]===62?this.switchMode(this.#n.x5===82?"x5d":"05rw"):e.data[1]===63?this.switchMode(S[this.#n.ds]):(e.data[1]===64||e.data[1]===127)&&this.switchMode("xg"):this.#t===m.gs||this.#t===m.sc?e.data[1]<56&&this.#a[r]>0&&(e.data[1]=this.getChPrimitive(r,1,!1),e.data[1]=120,console.debug(`Forced channel ${r+1} to stay drums.`)):this.#t===m.gm&&(e.data[1]<48?this.#a[r]>0&&(e.data[1]=120,this.switchMode("gs",!0),console.debug(`Forced channel ${r+1} to stay drums.`)):(e.data[1]===64||e.data[1]===127)&&this.switchMode("xg",!0)),this.#t){case m.xg:{[79,95,126,127].indexOf(e.data[1])>-1?this.#a[r]===0&&(this.setChType(r,this.CH_DRUM2),console.debug(`CH${r+1} set to drums by MSB.`)):this.#a[r]>0&&(this.setChType(r,this.CH_MELODIC),console.debug(`CH${r+1} set to melodic by MSB.`)),[33,81,97].indexOf(e.data[1])>-1?this.#v[E]=this.EXT_VL:[35,67,83,99].indexOf(e.data[1])>-1?this.#v[E]=this.EXT_DX:this.#v[E]=this.EXT_NONE;break}case m["05rw"]:case m.x5d:case m.ns5r:{[61,62,126,127].indexOf(e.data[1])>-1?this.#a[r]===this.CH_MELODIC&&(this.setChType(r,this.CH_DRUM2),console.debug(`CH${r+1} set to drums by MSB.`)):[80,81,82,83].indexOf(e.data[1])>-1||this.#a[r]!==this.CH_MELODIC&&(this.setChType(r,this.CH_MELODIC),console.debug(`CH${r+1} set to melodic by MSB.`));break}case m.sd:{[104,105,106,107].indexOf(e.data[1])>-1?this.#a[r]===0&&(this.setChType(r,this.CH_DRUM2),console.debug(`CH${r+1} set to drums by MSB.`)):this.#a[r]>0&&(this.setChType(r,this.CH_MELODIC),console.debug(`CH${r+1} set to melodic by MSB.`));break}case m.g2:{e.data[1]===120?this.#a[r]===0&&(this.setChType(r,this.CH_DRUMS),console.debug(`CH${r+1} set to drums by MSB.`)):this.#a[r]>0&&(this.setChType(r,this.CH_MELODIC),console.debug(`CH${r+1} set to melodic by MSB.`));break}}break}case 2:{this.getExt(r)[1]===this.VLBC_BRTHEXPR&&this.setChCc(r,129,e.data[1]);break}case 6:{if(this.#F[r]){[m.xg,m.gs,m.sc,m.ns5r].indexOf(this.#t)<0&&console.warn(`NRPN commits are not available under "${S[this.#t]}" mode, even when they are supported in Octavia.`);let v=this.getChCc(r,99),a=this.getChCc(r,98);if(v===1){let c=qe.indexOf(a);if(c>-1)this.setChCc(r,71+c,e.data[1]),w()&&console.debug(`Redirected NRPN 1 ${a} to cc${71+c}.`),this.dispatchEvent("cc",{part:r,cc:71+c,data:e.data[1]});else{let d=ie.indexOf(a);d>-1?this.#ne[r*10+d]=e.data[1]-64:console.warn(`NRPN 0x01${a.toString(16).padStart(2,"0")} is not supported.`),w()&&console.debug(`CH${r+1} voice NRPN ${a} commit`)}}else{if(Q.indexOf(v)<0){let d=`NRPN 0x${v.toString(16).padStart(2,"0")}${a.toString(16).padStart(2,"0")} `;console.warn(v===127?`${d}is not necessary. Consider removing it.`:`${d}is not supported.`)}else{let d=this.#a[r]-2;d<0?console.warn(`CH${r+1} cannot accept drum NRPN as type ${K[this.#a[r]]}.`):this.#$[(d*p.dpn+O[v])*p.dnc+a]=e.data[1]}w()&&console.debug(`CH${r+1} (${K[this.#a[r]]}) drum NRPN ${v} commit`)}}else{let v=z[this.getChCc(r,100)],a=we[this.getChCc(r,100)];if(this.getChCc(r,101)===0&&v!==void 0)switch(w()&&console.debug(`CH${r+1} RPN 0 ${this.getChCc(r,100)} commit: ${e.data[1]}`),e.data[1]=Math.min(Math.max(e.data[1],xe[v][0]),xe[v][1]),this.#r[r*p.rpn+v]=e.data[1],this.#i[r*p.rpnt+a]=1,y){case m.xg:case m.gs:case m.sc:case m.mt32:case m.s90es:case m.motif:case m.cs1x:case m.cs6x:{switch(this.getChCc(r,100)){case 1:case 2:{this.dispatchEvent("pitch",{part:r,pitch:this.getPitchShift(r)});break}}break}default:this.dispatchEvent("pitch",{part:r,pitch:this.getPitchShift(r)})}}break}case 32:{switch(w()&&console.debug(`${S[this.#t]}, CH${r+1} LSB: ${e.data[1]}`),this.#t){case m.s90es:case m.motif:{this.setChType(r,[32,40].indexOf(e.data[1])>-1?this.CH_DRUMS:this.CH_MELODIC,this.#t,!0);break}}this.getExt(r)[0],this.EXT_DX;break}case 38:{if(!this.#F[r]){let v=z[this.getChCc(r,100)],a=we[this.getChCc(r,100)];this.getChCc(r,101)===0&&v!==void 0&&(this.#r[r*p.rpn+v+1]=e.data[1],this.#i[r*p.rpnt+a]=1)}break}case 64:{e.data[1]<64&&this.#E.hoOf(r);break}case 66:{e.data[1]>>6?this.#E.soOn(r):this.#E.soOf(r);break}case 98:case 99:{this.#F[r]=1;break}case 100:case 101:{this.#F[r]=0;break}}this.setChCc(r,e.data[0],e.data[1]),this.dispatchEvent("cc",{part:r,cc:e.data[0],data:e.data[1]})}o.getChModeId(r)===m.xg&&o.#a[r]&&o.setDrumFirstWrite(r)},12:function(e){let r=e.channel,o=this;switch(o.#t){case m.s90es:case m.motif:{e.data&&o.setChActive(r,1);break}default:o.setChActive(r,1)}let h=x[r];switch(o.getExt(r)[0]){case o.EXT_VL:break}o.#s[r]=e.data,o.#M[r]=0,o.pushChPrimitives(r),w()&&console.debug(`T:${e.track} C:${r} P:${e.data}`),o.dispatchEvent("voice",{part:r}),o.getChModeId(r)===m.xg&&o.#a[r]&&o.setDrumFirstWrite(r)},13:function(e){let r=this,o=e.channel;this.#h.forEach(function(h){let u=h>>7;o===u&&(r.#b[h]=e.data,r.dispatchEvent("note",{part:o,note:h&127,velo:e.data,state:r.NOTE_SUSTAIN}))})},14:function(e){let r=e.channel;this.#B[r]=e.data[1]*128+e.data[0]-8192,this.dispatchEvent("pitch",{part:r,pitch:this.getPitchShift(r)})},15:function(e){je(e.data).forEach(r=>{let o=r[0],h=r[1];this.#he=r.length,(this.#Ce[o]||function(){console.debug(`Unknown manufacturer ${o}.`)})(h,r.subarray(2),e.track)})},248:function(e){},250:function(e){},251:function(e){},252:function(e){},254:function(e){},255:function(e){(this.#k[e.meta]||function(o,h,u){}).call(this,e.data,e.track,e.meta),e.meta!==32&&(this.#q=0);let r=ze.indexOf(e.meta)>-1;if(w()&&console.debug(e),r)return e.reply="meta",e}};#Ce={64:(e,r,o)=>{this.#re.run(r,o,e)},65:(e,r,o)=>{if(r[0]<16)if(r[1]===72){let h=r[r.length-1],u=L(r.subarray(3,r.length-1));h===u?this.#R.run(r.subarray(0,r.length-1),o,e):console.warn(`Bad SD checksum ${h} - should be ${u}.`)}else this.#R.run(r,o,e);else{let h=r[r.length-1],u=L(r.subarray(2,r.length-1));h===u?this.#R.run(r.subarray(0,r.length-1),o,e):console.warn(`Bad GS checksum ${h} - should be ${u}.`)}},66:(e,r,o)=>{this.#U.run(r,o,e)},67:(e,r,o)=>{switch(e>>4){case 0:{let h=0;for(;r[h]===127&&h<4;)h++;let u=r[1+h]<<7|r[2+h];if(u+7+h!==r.length){console.warn(`Yamaha bulk dump length mismatch! Expected ${r.length-7-h}, received ${u}.`),console.debug(r);break}let E=L(r.subarray(1+h,r.length-1)),y=r[r.length-1];if(r[r.length-1]>>7)console.warn(`Yamaha bulk dump checksum invalid! Expected ${E}, received ${y}:
`),console.debug(r);else if(E!==y)console.warn(`Yamaha bulk dump checksum mismatch! Expected ${E}, received ${y}:
`),console.debug(r);else{let v=r.slice(2,r.length-1);for(let a=0;a<=h;a++)v[a]=r[a];this.#g.run(v,o,e&15)}break}case 1:{this.#g.run(r,o,e&15);break}case 2:{console.warn("Octavia doesn't yet support Yamaha bulk dump requests.");break}case 3:{console.warn("Octavia doesn't yet support Yamaha parameter requests.");break}case 7:{switch(e&15){case 14:{let h=new Uint8Array(r.length+1);h[0]=126,h.set(r,1),this.#g.run(h,o,0);break}default:console.warn(`Unknown Yamaha special SysEx type: ${e}.`)}break}default:console.warn(`Unknown Yamaha SysEx type: ${e>>4}.`)}},68:(e,r,o)=>{this.#ie.run(r,o,e)},71:(e,r,o)=>{this.#se.run(r,o,e)},126:(e,r,o)=>{this.#te.run(r,o,e)},127:(e,r,o)=>{this.switchMode("gm"),this.#ae.run(r,o,e)}};#te;#ae;#g;#R;#U;#re;#se;#ie;buildRchTree(){let e=[];this.#c.forEach((r,o)=>{r<p.ch&&(e[r]?.constructor||(e[r]=[]),e[r].push(o))}),this.#be=e}buildRccMap(){let e=this;for(let r=0;r<p.ch;r++)e.#J[r]={};e.#Y.forEach((r,o)=>{r&&(e.#J[Math.floor(o/p.redir)][r]=o%p.redir|128)}),w()&&console.debug(e.#J)}invokeSysExIndicator(){this.dispatchEvent("mupromptex",this.#he)}getActive(){return this.#x}getChActive(e){return this.#x[e]}getCc(e){if(typeof e!="number"||e<0||e>=p.ch)throw new RangeError(`Invalid part number: CH${e+1}`);let r=this,o=x[e];return r.#e.subarray(o,o+p.cc)}getChCc(e,r){let o=this;if(U.indexOf(r)<0)throw new Error("CC number not accepted");return o.#e[x[e]+g[r]]}getChCcWritten(e,r){let o=this;if(U.indexOf(r)<0)throw new Error("CC number not accepted");return o.#e[p.chcc+x[e]+g[r]]}setChCc(e=0,r,o){let h=this;if(U.indexOf(r)<0)throw new Error("CC number not accepted");if(o?.constructor!==Number)throw new TypeError("Expected numbers for value");let u=o&255,E=x[e]+g[r];h.#e[E]=u,h.#e[E+p.chcc]=1,h.dispatchEvent("cc",{part:e,cc:r,data:u})}getCcAll(){return this.#e.slice()}resetCc(e){let r=this,o=x[e]+p.chcc;r.#e.fill(0,o,o+p.cc)}resetChCc(e,r,o){let h=this;o?.constructor&&h.setChCc(e,r,o),h.#e[x[e]+g[r]+p.chcc]=0}resetCcAll(){this.#e.fill(0,p.chcc,p.chcc<<1)}isChCcWritten(e,r){if(U.indexOf(r)<0)throw new Error("CC number not accepted");return upThis.#e[x[e]+g[r]+p.chcc]}getChSource(){return this.#c}getChType(){return this.#a}setChType(e,r,o=0,h=!1){r&=15;let u=this;o=o||u.getChModeId(e),u.#a[e]=r,r>0&&!h&&(u.setChCc(e,0,u.#u[o][2]),u.pushChPrimitives(e))}setChActive(e,r=0){this.#x[e]!==r&&this.dispatchEvent("channeltoggle",{part:e,active:r}),this.#x[e]=r}getExt(e){let r=p.ext*e,o=this.#v.subarray(r,r+p.ext),h=new Uint8Array(o.length);return h.set(o),h[1]=h[1]||this.#ye,h}getPitch(){return this.#B}getProgram(){return this.#s}getTexts(){return this.#T.slice()}getVel(e){let r=new Map,o=this;return o.#h.forEach(function(h,u){let E=h>>7,y=h&127;e===E&&o.#b[h]>0&&r.set(y,{v:o.#b[h],s:o.#l[u]})}),r}getBitmap(){return{bitmap:this.#w,expire:this.#P}}getLetter(){return{text:this.#X,set:this.#pe,expire:this.#K}}getMode(){return S[this.#t]}getMaster(){return{volume:this.#d}}getRawStrength(){let e=this;return this.#h.forEach(function(r){let o=r>>7;e.#b[r]>e.#D[o]&&(e.#D[o]=e.#b[r])}),this.#D}getStrength(){let e=[],r=this;return this.getRawStrength().forEach(function(o,h){e[h]=Math.floor(o*r.getChCc(h,7)*r.getChCc(h,11)*r.#d/803288)}),e}getRpn(){return this.#r}getNrpn(){return this.#ne}getSubDb(){return self?.structuredClone(this.#u)}getDetect(){return self?.structuredClone(this.#n)}getVoice(e,r,o,h="?"){let u=this;m[h]?.constructor||(h="?");let E=m[h],y=e||u.#u[E][0],v=r,a=o||u.#u[E][1];y===F.bank0&&(y=0),a===F.bank0&&(a=0),h==="ns5r"&&y>0&&y<56&&(a=3);let c=u.userBank.get(y,v,a,h);if(h==="mt32"&&c.name.indexOf("MT-m:")===0){let d=parseInt(c.name.slice(5)),t=d*p.cmt,s="";u.#G.subarray(t,t+10).forEach(n=>{n>31&&(s+=String.fromCharCode(n))});let i=`MSB	LSB	PRG	NME
49	127	${v}	${s}`;u.userBank.load(i,!0),c.name=s,c.ending=" "}return(c.ending!==" "||!c.name.length)&&(c=u.baseBank.get(y,v,a,h)),c}getChPrimitive(e,r,o){if(r>=p.vxPrim||r?.constructor!==Number)throw new RangeError(`Invalid voice primitive component "${r}"`);if(typeof e!="number"||e<0||e>=p.ch)throw new RangeError(`Invalid part number: CH${e+1}`);let h=this,u=h.#s[r<<p.chShift|e];switch(r){case 1:case 2:{h.getChCcWritten(e,[255,0,32][r])||(u=u||h.#u[h.getChModeId(e)][r+2]),o&&(u=u||h.#u[h.getChModeId(e)][r-1]),u===F.bank0&&(u=0);break}}return u}getChPrimitives(e,r){let o=this,h=new Uint8Array(3);return h[1]=o.#s[e],h[0]=o.getChPrimitive(e,1,r),h[2]=o.getChPrimitive(e,2,r),h}pushChPrimitives(e){let r=this;r.#s[1<<p.chShift|e]=r.getChCc(e,0),r.#s[2<<p.chShift|e]=r.getChCc(e,32),r.dispatchEvent("voice",{part:e})}getChCvnBuffer(e,r=p.cvn){if(r>p.cvn||r<1)throw new RangeError("Invalid custom voice name buffer length");let o=q[e];return this.#W.subarray(o,o+r)}getChCvnRegister(e,r){if(r>=p.cvn||r<0)throw new RangeError("Invalid custom voice name register");return this.#W[q[e]+r]}setChCvnRegister(e,r,o=32){if(r>=p.cvn||r<0)throw new RangeError("Invalid custom voice name register");this.#W[q[e]+r]=Math.max(32,o&255)}getChCvnString(e,r){let o=Ze.decode(this.getChCvnBuffer(e));return r||(o=o.trimEnd()),o}getChVoice(e){let r=this,o=r.getVoice(...r.getChPrimitives(e),r.getChMode(e));if(r.#M[e]){let h="";switch(r.#t){case m.mt32:{r.#O.subarray(p.cmt*(e-1),p.cmt*(e-1)+10).forEach(u=>{h+=String.fromCharCode(Math.max(u,32))}),h=h.trimEnd();break}default:h=r.getChCvnString(e)}h.length&&(o.ending="~",o.name=h)}return o}getRawPitch(){return this.#B}getPitchShift(e){let r=this,o=e*p.rpn,h=r.#r[o];return r.#i[e*p.rpnt]?h>>7&&(h-=256):r.#t===m.mt32&&(h=12),r.#B[e]/8192*h+(r.#r[o+3]-64)+((r.#r[o+1]<<7)+r.#r[o+2]-8192)/8192}getEffectType(e=0){let r=3*e+1;return this.#S.subarray(r,r+2)}getPolyState(e=0){return this.#l[e]}setEffectTypeRaw(e=0,r,o){let h=3*e;this.#S[h]=1,this.#S[h+1+ +r]=o}setEffectType(e=0,r,o){this.setEffectTypeRaw(e,!1,r),this.setEffectTypeRaw(e,!0,o)}getEffectSink(){return this.#ce}setLetterDisplay(e,r,o=0,h=3200){let u=this,E;u.#X=" ".repeat(o),e.forEach(y=>{u.#X+=String.fromCharCode(y>31?y:32),y<32&&(E=E||new Set,E.add(y))}),u.#pe=Date.now(),u.#K=Date.now()+h,u.dispatchEvent("letter"),E&&(E=Array.from(E),E.forEach((y,v,a)=>{a[v]=y.toString(16).padStart(2,"0")}),console.warn(`${r}${r?" ":""}invalid code point${E.length>1?"s":""}: 0x${E.join(", 0x")}`))}setDetectionTargets(e="?",r=0){let o=this,h=-1;switch(e.replaceAll(", ",",").split(",").forEach(u=>{u=u.toLowerCase();let E=S.indexOf(Ve[u]||u);w()&&console.debug(`Mapped mode "${u}" to ID "${E}".`),E>-1&&(h=E)}),w()&&console.debug(`Set detection target to ID "${h}".`),h>0&&(o.#n.x5=82,o.#n.ds=m.krs),h){case m["05rw"]:{o.#n.x5=81;break}case m.s90es:o.#n.ds=m.s90es,o.#n.smotif=m.s90es;case m.motif:o.#n.ds=m.motif,o.#n.smotif=m.motif}}setGsTargets(e=!1,r=4){if(!r)r=e?3:4;else{if(r>4||r<0)throw new Error(`Invalid GS level ${r}`);if(e&&r>>1!==1)throw new Error(`Invalid SC level ${r}`)}let o=this;o.#n[e?"sc":"gs"]=r,o.#u[m[e?"sc":"gs"]][1]=r,o.forceVoiceRefresh()}getConfigs(){return this.#ue}setDumpLimit(e){if(e>2||e<0)throw new RangeError("Invalid dump limit.");this.#I.dumpLimit=e}allocateAce(e=0,r){let o=this;if(!r||r<128&&r>95){console.warn(`cc${r} cannot be allocated as an active custom effect.`);return}let h=!0,u=0,E=p.ace*e;for(;h&&u<p.ace;)o.#y[u+E]===r?h=!1:o.#y[u+E]||(h=!1,o.#y[u+E]=r,console.debug(`Allocated cc${r} to ACE slot ${u} in CH${e+1}.`)),u++;u>=p.ace&&console.warn(`ACE slots are full in CH${e+1}.`)}allocateAceAll(e){let r=this;if(!e||e<128&&e>95){console.warn(`cc${e} cannot be allocated as an active custom effect.`);return}for(let o=0;o<p.ch;o++){let h=!0,u=0,E=p.ace*o;for(;h&&u<p.ace;)r.#y[u+E]===e?h=!1:r.#y[u+E]||(h=!1,r.#y[u+E]=e),u++;u>=p.ace&&console.warn(`ACE slots are full in CH${o+1}.`)}}resetAce(){this.#y.fill(0),console.info("All ACE slots have been reset.")}resetChAceAll(e=0){this.#y.subarray(W[e],W[e]+p.ace).fill(0)}resetChAce(e=0,r){let o=!0,h=W[e],u=h+p.ace;for(;o&&h<u;)this.#y[h]===r&&(this.#y[h]=0,o=!1),h++;o&&w()&&console.debug(`No ACE slot was allocated to cc${r} in CH${e+1}.`)}getAce(){return this.#y}getChAce(e=0,r=0){if(r<0||r>=p.ace)throw new RangeError("No such ACE slot");let o=this.#y[p.ace*e+r];if(o){if(U.indexOf(o)>=0)return this.getChCc(e,o);throw new Error(`Invalid ACE source in CH${e+1}: ${o}`)}else return 0}initDrums(){let e=this;e.#$.fill(64);for(let r=0;r<p.drm;r++){let o=r*p.dpn;for(let h in Se){let u=Se[h],E=(o+O[h])*p.dnc;e.#$.subarray(E,E+p.dnc).fill(u)}}}init(e=0){let r=this;r.#q=0,r.#u[m.xg][1]=0,r.dispatchEvent("banklevel",{mode:"xg",data:0}),r.#x.fill(0),r.#e.fill(0),r.#y.fill(0),r.#s.fill(0),r.#b.fill(0),r.#h.fill(0),r.#l.fill(0),r.#m.fill(0),r.#D.fill(0),r.#B.fill(0),r.#ne.fill(0),r.#i.fill(0),r.#v.fill(0),r.#p.fill(0),r.#oe.fill(0),r.#z.fill(0),r.#Y.fill(0),r.#d=100,r.#T=[],r.#de=500,r.#Q=0,r.#j=0,r.#Z=!1,r.#P=0,r.#C=0,r.#w.fill(0),r.#o=r.KARAOKE_NONE,r.#fe=0,r.#L=!0,r.#f=!1,r.#he=0,r.initDrums(),r.polyIndexLatest=0,r.polyIndexLast=0,r.#c.forEach(function(o,h,u){u[h]=h}),e===0&&(r.dispatchEvent("mode","?"),r.#t=0,r.#_.fill(0),r.#V.fill(0),r.#K=0,r.#X=""),Ye.forEach(o=>{r.setChCc(o,0,r.#u[r.getChModeId(o)][2])}),r.#a.fill(r.CH_MELODIC),r.#a[9]=r.CH_DRUM1,r.#a[25]=r.CH_DRUM3,r.#a[41]=r.CH_DRUMS,r.#a[57]=r.CH_DRUMS,r.#a[73]=r.CH_DRUM5,r.#a[89]=r.CH_DRUM7,r.#a[105]=r.CH_DRUMS,r.#a[121]=r.CH_DRUMS;for(let o=0;o<p.drm;o++)r.#A[o<<1]=0,r.#A[o<<1|1]=p.invalidCh;r.#le.fill(0),r.#G.fill(0),r.#H.fill(0),r.#O.fill(0),r.#M.fill(0),r.#W.fill(32),r.#S.fill(0),r.#ce.fill(0),r.aiEfxName="",r.userBank.clearRange({msb:0,lsb:127,prg:[0,127]}),r.modelEx.sc.showBar=!0,r.modelEx.sc.invBar=!1,r.modelEx.sc.invDisp=!1,r.modelEx.sc.peakHold=1,r.modelEx.cs1x.perfCh=0;for(let o=0;o<p.ch;o++){let h=x[o];r.#e[h+g[7]]=100,r.#e[h+g[11]]=127,r.#e[h+g[2]]=127,r.#e[h+g[10]]=64,r.#e.subarray(h+g[71],h+g[71]+8).fill(64),r.#e[h+g[128]]=127,r.#e.subarray(h+g[130],h+g[157]+1).fill(64),r.#e[h+g[91]]=40,r.#e[h+g[101]]=127,r.#e[h+g[100]]=127,r.#e[h+g[99]]=127,r.#e[h+g[98]]=127;let u=o*p.rpn;r.#r[u]=2,r.#r[u+1]=64,r.#r[u+2]=0,r.#r[u+3]=64,r.#r[u+4]=0,r.#r[u+5]=0;let E=o*p.ext;r.#v[E+1]=r.VLBC_BRTHEXPR;let y=o*p.redir;r.#Y[y+8]=13}r.buildRchTree(),r.buildRccMap(),r.dispatchEvent("mastervolume",r.#d),r.dispatchEvent("efxreverb",r.getEffectType(0)),r.dispatchEvent("efxchorus",r.getEffectType(1)),r.dispatchEvent("efxdelay",r.getEffectType(2)),r.dispatchEvent("efxinsert0",r.getEffectType(3)),r.dispatchEvent("efxinsert1",r.getEffectType(4)),r.dispatchEvent("efxinsert2",r.getEffectType(5)),r.dispatchEvent("efxinsert3",r.getEffectType(6)),r.dispatchEvent("reset"),r.switchMode("?")}setChMode(e,r){let o=this;if(typeof e!="number"||e<0||e>=p.ch)throw new RangeError(`Invalid part number: CH${e+1}`);if(e<0||r>=S.length)throw new RangeError(`Invalid mode ID ${r}`);o.#z[e]=r,o.dispatchEvent("chmode",{part:e,id:r,mode:S[r]}),o.dispatchEvent("voice",{part:e})}getChMode(e,r){return S[this.getChModeId(e,r)]}getChModeId(e,r){return r?this.#z[e]||this.#p[e>>4]:this.#z[e]||this.#p[e>>4]||this.#t}setPortMode(e,r,o){let h=this;if(e<0||e>=p.ch>>4)throw new RangeError(`Invalid port ${e+1}`);if(r<1)throw new RangeError("Range must be a positive integer");if(e+r>=p.ch>>4)throw new RangeError("Range must be in bound");if(e<0||o>=S.length)throw new RangeError(`Invalid mode ID ${o}`);h.#oe[e]=o;for(let u=e;u<e+r;u++){let E=h.#oe[u];if(r>1&&E!==0&&E!==o)break;h.#p[u]=o;for(let y=u<<4;y<u+1<<4;y++)h.dispatchEvent("chmode",{part:y,id:o,mode:S[o]}),h.dispatchEvent("voice",{part:y})}}copyChSetup(e,r,o){if(e===r){console.warn(`Failed attempt at overwriting CH${e+1} with its own data.`);return}let h=this;if(o&&h.#x[r]){console.warn(`Failed attempt at copying setup data from CH${e+1} to CH${r+1}.`);return}let u=x[e],E=x[r];h.#s[r]=h.#s[e],h.#e.set(h.#e.subarray(u,u+p.cc),E),h.pushChPrimitives(r)}setDrumFirstWrite(e,r){let o=this,h=o.#a[e];if(h<2)return;let u=h-2;if(o.#A[u<<1])if(r)o.#A[u<<1]=0,w()&&console.debug(`First write part for drum set ${u+1} has been reset.`);else return;else r?console.warn(`First write part for drum set ${u+1} is already blank.`):(o.#A[u<<1]=1,o.#A[u<<1|1]=e,console.debug(`First write part for drum set ${u+1} is set to CH${e+1}.`))}getChDrumFirstWrite(e){let r=this,o=r.#a[e];if(o<2)return;let h=o-2;return r.#A.subarray(h<<1,h+1<<1)}getDrumFirstWrite(e){if(e>=0&&e<p.drm)return this.#A.subarray(e<<1,e+1<<1)}switchMode(e,r=!1,o=!1){let h=this,u=m[e];if(u>-1){if(h.#t===0||r){h.initOnReset&&r&&this.init(1),h.#t=u,h.#C=0;for(let y=0;y<p.ch;y++){let v=h.getChModeId(y,!0);h.#a[y]>0&&v===m["?"]&&(h.setChCc(y,0,h.#u[u][2]),w()&&console.debug(`CH${y+1} (${h.#a[y]}) (${h.getChMode(y)}), ${S[v]} (${h.#u[v][2]}) -> ${S[u]} (${h.#u[u][2]})`),h.pushChPrimitives(y))}switch(u){case m.mt32:{ae.forEach((y,v)=>{let a=v+1;h.#x[a]||(h.#s[a]=y,h.setChCc(a,91,127),h.pushChPrimitives(a))});for(let y=1;y<10;y++)h.dispatchEvent("voice",{part:y});break}}let E;switch(u){case m["?"]:case m.g2:{E=[52,4,52,18,0,255,0,255];break}case m.xg:case m.cs1x:{E=[1,0,65,0,5,0,64,0];break}case m.gm:case m.gs:case m.sc:{E=[40,4,40,18,40,32,32,0];break}case m.sd:{E=[58,0,60,0,61,0,61,0];break}case m["05rw"]:case m.x5d:case m.ns5r:{E=[44,1,44,19,0,255,0,255];break}case m.k11:case m.sg:{E=[24,0,0,255,0,255,0,255];break}case m.mt32:{E=[40,4,0,255,0,255,0,255];break}case m.doc:{E=[24,16,0,255,0,255,0,255];break}case m.motif:case m.s90es:case m.cs6x:{E=[129,0,133,0,130,0,0,0];break}default:E=[0,0,0,0,0,0,0,0]}for(let y=0;y<p.efx;y++)!h.#S[3*y]&&E[y<<1]?.constructor&&(h.#S[3*y+1]=E[2*y],h.#S[3*y+2]=E[2*y+1],h.dispatchEvent(`efx${["reverb","chorus","delay","insert0"][y]}`,h.getEffectType(y)));o&&h.setDetectionTargets(e),h.dispatchEvent("mode",e),h.forceVoiceRefresh()}}else throw new Error(`Unknown mode ${e}`)}newStrength(){this.#D.fill(0)}runJson(e){if(e.type>14)return e.type===15&&e.data.constructor!==Uint8Array&&(e.data=Uint8Array.from(e.data)),this.#Ee[e.type].call(this,e);{let r=this.chRedir(e.part,e.track),o=!1;this.#be[r]?.forEach(h=>{e.channel=h,o=!0,this.#Ee[e.type].call(this,e)}),o||console.warn(`${$e[e.type]?$e[e.type]:e.type}${[11,12].includes(e.type)?(e.data[0]!==void 0?e.data[0]:e.data).toString():""} event sent to CH${r+1} without any recipient.`)}this.#T.length>100&&this.#T.splice(100,this.#T.length-99)}runRaw(e){}async loadBank(e,r){let o=this;switch(e=e.toLowerCase(),e){case"s7e":{o.userBank.clearRange({msb:63,lsb:[21,22]}),o.userBank.clearRange({msb:63,lsb:[24,27]});break}case"pcg":{o.userBank.clearRange({msb:63,lsb:[6,9]}),o.userBank.clearRange({msb:63,lsb:[13,16]});break}default:throw new Error(`Unknown bank format ${e}`)}switch(e){case"s7e":case"pcg":{G.context=this,await o.userBank.load(await G.read(e,r),!1);break}}o.forceVoiceRefresh()}constructor(){super();let e=this;e.#w=new Uint8Array(256),e.#N[10]=new Uint8Array(512),e.#ee=new P,e.#n={x5:82,ds:m.krs,smotif:m.s90es,gs:4,sc:3},e.#I={dumpLimit:e.DUMP_MODE},e.#ue=new Proxy(e.#I,{set:()=>{}});for(let a in ke){let c=m[a];c===void 0?console.debug(`SubDB build error: "${a}" does not exist`):e.#u[c]=new Uint8Array(ke[a])}e.userBank.strictMode=!0,e.userBank.load(`MSB	PRG	LSB	NME
062	000	000	
122	000	000	
122	001	000	
122	002	000	
122	003	000	
122	004	000	
122	005	000	
122	006	000	`),e.addEventListener("metacommit",function(a){let{data:c}=a;e.#T[0]?.type===c.type&&e.#T[0]?.amend?(e.#T[0].amend=c.amend,e.#T[0].data+=c.data):e.#T.unshift(c)}),e.#k[1]=function(a){switch(a=a.replaceAll(`\r
`,`
`).replaceAll("\r",`
`),a.substring(0,2)){case"@I":{e.#o=e.KARAOKE_TEXT,e.dispatchEvent("metacommit",{type:"Kar.Info",data:a.substring(2)?.trimLeft()});break}case"@K":{e.#o=e.KARAOKE_TEXT;let c=a.substring(2);c!=="MIDI KARAOKE FILE"&&e.dispatchEvent("metacommit",{type:"Kar.Mode",data:c?.trimLeft()}),console.debug(`Karaoke mode active: ${c}`);break}case"@L":{e.#o=e.KARAOKE_TEXT,e.dispatchEvent("metacommit",{type:"Kar.Lang",data:a.substring(2)?.trimLeft()});break}case"@T":{e.#o=e.KARAOKE_TEXT,e.dispatchEvent("metacommit",{type:"KarTitle",data:a.substring(2)?.trimLeft()});break}case"@V":{e.#o=e.KARAOKE_TEXT,e.dispatchEvent("metacommit",{type:"Kar.Ver.",data:a.substring(2)?.trimLeft()});break}case"XF":{let c=a.slice(2).split(":");switch(c[0]){case"hd":{c.slice(1).forEach((d,t)=>{d.length&&e.dispatchEvent("metacommit",{type:["XfSngDte","XfSngRgn","XfSngCat","XfSongBt","XfSngIns","XfSngVoc","XfSngCmp","XfSngLrc","XfSngArr","XfSngPer","XfSngPrg","XfSngTag"][t],data:d})});break}case"ln":{c.slice(1).forEach((d,t)=>{d.length&&e.dispatchEvent("metacommit",{type:["XfKarLng","XfKarNme","XfKarCmp","XfKarLrc","XfKarArr","XfKarPer","XfKarPrg"][t],data:d})});break}default:e.dispatchEvent("metacommit",{type:"XfUnData",data:a})}break}default:switch(e.#o){case e.KARAOKE_TEXT:{switch(a[0]){case"\\":{e.dispatchEvent("metacommit",{type:"KarLyric",data:"",amend:!1}),e.dispatchEvent("metacommit",{type:"KarLyric",data:a.substring(1),amend:!0});break}case"/":{e.dispatchEvent("metacommit",{type:"KarLyric",data:"",mask:!0,amend:!1}),e.dispatchEvent("metacommit",{type:"KarLyric",data:a.substring(1),mask:!0,amend:!0});break}default:e.dispatchEvent("metacommit",{type:"KarLyric",data:a,amend:!0})}break}default:a.split(`
`).forEach((c,d)=>{e.dispatchEvent("metacommit",{type:"Cmn.Text",data:c,mask:d!==0})})}}},e.#k[2]=function(a){e.dispatchEvent("metacommit",{type:"Copyrite",data:a})},e.#k[3]=function(a,c){c<1&&e.#q<1&&e.dispatchEvent("metacommit",{type:"TrkTitle",data:a})},e.#k[4]=function(a,c){e.dispatchEvent("metacommit",{type:"Instrmnt",data:a})},e.#k[5]=function(a){switch(e.#o){case e.KARAOKE_XF:{let c="";for(let d of a)switch(d){case"^":case"%":{c+=" ";break}case">":{c+="	";break}case"<":{e.dispatchEvent("metacommit",{type:"KarLyric",data:c,mask:e.#f,amend:!1}),c="",e.#f=!1;break}case"/":{e.dispatchEvent("metacommit",{type:"KarLyric",data:c,mask:!1,amend:!1}),c="",e.#f=!0;break}default:c+=d}c.length>0&&(e.dispatchEvent("metacommit",{type:"KarLyric",data:c,mask:e.#f,amend:!0}),e.#f=!1);break}default:{let c=0,d=!0,t=a.length-1;for(;d&&c<8;)switch(a.charCodeAt(c)){case 32:{c++;break}default:d=!1}switch(c>0&&(e.dispatchEvent("metacommit",{type:"C.Lyrics",data:a.substring(0,c),amend:!0,mask:e.#f,untimed:!0}),e.#f=!1),a.charCodeAt(t)){case 10:{e.dispatchEvent("metacommit",{type:"C.Lyrics",data:a.substring(c,t),amend:!1,mask:e.#f}),e.#f=!1;break}case 11:case 13:{e.dispatchEvent("metacommit",{type:"C.Lyrics",data:a.substring(c,t),amend:!1,mask:e.#f}),e.#f=!0;break}case 32:{e.dispatchEvent("metacommit",{type:"C.Lyrics",data:a.substring(c,t),amend:!0,mask:e.#f}),e.dispatchEvent("metacommit",{type:"C.Lyrics",data:" ",amend:!0,mask:!1,untimed:!0}),e.#f=!1;break}default:a.trim()===""?console.info("Blank line? Shouldn't happen."):e.dispatchEvent("metacommit",{type:"C.Lyrics",data:a,amend:!0,mask:e.#f}),e.#f=!1}break}}},e.#k[6]=function(a){e.dispatchEvent("metacommit",{type:"C.Marker",data:a})},e.#k[7]=function(a){switch(a[0]){case"$":{if(a.substring(1,5)==="Lyrc"){e.#o=e.KARAOKE_XF;let c=a.substring(6).split(":"),d=c[0].replaceAll(" ","").split(",");d.forEach((s,i,n)=>{n[i]=parseInt(s)-1});let t=Ee[c[2].substring(0,2).toLowerCase()];e.dispatchEvent("metacommit",{type:"XfMeloCh",data:`CH${c[0].replaceAll(" ","").split(",").join(", CH")}`,parsed:d}),e.dispatchEvent("metacommit",{type:"XfLyrOff",data:c[1],parsed:parseInt(c[1])}),e.dispatchEvent("metacommit",{type:"XfLyrEnc",data:t[1],parsed:t[0]}),e.#f=!1}else e.dispatchEvent("metacommit",{type:"CuePoint",data:a});break}case"#":{e.dispatchEvent("metacommit",{type:"XfScneNo",data:a.substring(1)});break}case"&":{a.length===2?(e.dispatchEvent("metacommit",{type:"XfSngPrt",data:ge[a[1]]||`Unknown "${a[1]}"`}),e.#f=!1):e.dispatchEvent("metacommit",{type:"CuePoint",data:a});break}default:e.dispatchEvent("metacommit",{type:"CuePoint",data:a})}},e.#k[32]=function(a){e.#q=a[0]+1},e.#k[33]=function(a,c){w()&&console.debug(`Track ${c} requests getting assigned to port ${a}.`),e.#V[c]=a+1},e.#k[81]=function(a,c){e.#de=a/1e3},e.#k[127]=function(a,c){e.#ee.run(a,c)},e.#ee.default=function(a){let c=[];for(let d=0;d<8&&d<a.length;d++)c.push(a[d].toString(16).padStart(2,"0").toUpperCase());console.warn(`Unrecognized implementation-specific byte sequence: ${c.join(" ")}${a.length>8?" ...":""}
%o`,a)},e.#ee.add([67,0,1],(a,c)=>{w()&&console.debug(`XGworks port assign requests assigning track ${c} to port ${a[0]}.`),e.#V[c]=a[0]+1}).add([67,123,1],(a,c)=>{let d=[];for(let t=0;t<a.length;t+=2){let s=a[t]>>4,i=a[t]&15;if(s<7&&i&&i<8){let n=new Uint8Array(5);n[0]=i-1,n[1]=s-3<<2,n[2]=a[t|1],d.push(n)}}e.dispatchEvent("metacommit",{type:"ChordCtl",src:"yxf",data:d}),console.debug("Yamaha XF chord data: %o",d)}).add([67,123,2],(a,c)=>{let d=new Uint8Array(2);d[0]=a[0]&15,d[1]=a[0]>>4,e.dispatchEvent("metacommit",{type:"RhrslMrk",src:"yxf",data:d}),console.debug(`Yamaha XF rehearsal mark: ${["Intro","Ending","Fill-in"][d[0]]??String.fromCharCode(62+d[0])}${"'".repeat(d[1])} %o`,d)}).add([67,123,96],(a,c)=>{let d=[0,0];a.subarray(1,3).forEach(t=>{d[0]=d[0]<<7,d[0]|=t&127}),a.subarray(3,5).forEach(t=>{d[1]=d[1]<<7,d[1]|=t&127}),e.dispatchEvent("metacommit",{type:"YStyleId",data:d}),console.debug(`Yamaha style ID: model ${d[0].toString(16)}, style ${d[1]+1}`)}),e.#te=new P("universal non-realtime"),e.#ae=new P("universal realtime"),e.#g=new P("Yamaha"),e.#R=new P("Roland"),e.#U=new P("Korg"),e.#re=new P("Kawai"),e.#se=new P("Akai"),e.#ie=new P("Casio");let r=new P("DX7+ Dump"),o=function(a){let c=[];for(let d=0;d<8&&d<a.length;d++)c.push(a[d].toString(16).padStart(2,"0").toUpperCase());console.info(`Unrecognized SysEx in "${this.name}" set: ${c.join(" ")}${a.length>8?" ...":""}
%o`,a)};e.#te.default=o,e.#ae.default=o,e.#g.default=o,e.#R.default=o,e.#U.default=o,e.#re.default=o,e.#se.default=o,e.#ie.default=o,r.default=o,e.#te.add([9],(a,c,d)=>{e.switchMode(["gm","?","g2"][a[0]-1],!0),e.setPortMode(e.getTrackPort(c),1,m[["gm","?","g2"][a[0]-1]]),e.#o=e.#o||e.KARAOKE_NONE,console.info(`MIDI reset: ${["GM","Init","GM2"][a[0]-1]}`),a[0]===2&&e.init()}),e.#ae.add([4,1],(a,c,d)=>{e.invokeSysExIndicator(),e.#d=((a[1]<<7)+a[0])/16383*100,e.dispatchEvent("mastervolume",e.#d)}).add([4,3],(a,c,d)=>((a[1]<<7)+a[0]-8192)/8192).add([4,4],(a,c,d)=>a[1]-64).add([4,5],(a,c,d)=>{e.invokeSysExIndicator();let t=a[0],s=a[1],i=a[2],n=3,f=n+(t<<1),l=f+s;if(t!==1){console.error(`Unsupported GM2 global parameter set: slotpath length too long (${t})!
`,a);return}let b=0,C=0,k=0;switch(a.subarray(n,f).forEach($=>{b=b<<7,b|=$}),a.subarray(f,l).forEach(($,T)=>{C|=$<<T*7}),a.subarray(l).forEach(($,T)=>{k|=$<<T*7}),w()&&console.debug(`GM2 global parameter: (${a.subarray(3,f)}; p: ${C}, v: ${k})`),b){case 129:{C===0&&(e.setEffectType(0,52,k),e.dispatchEvent("efxreverb",e.getEffectType(0)));break}case 130:{C===0&&(e.setEffectType(1,52,k|16),e.dispatchEvent("efxchorus",e.getEffectType(1)));break}default:w()&&console.debug("GM2 global paramater slot path unknown.")}}),this.#g.add([76,0,0],(a,c,d)=>{switch(a[0]){case 125:{e.initDrums(),console.info(`XG drum setup reset on drum kit ${a[1]}.`);break}case 126:{e.switchMode("xg",!0),e.setPortMode(e.getTrackPort(c),4,m.xg),e.#o=e.#o||e.KARAOKE_NONE,console.info("MIDI reset: XG");break}default:{e.invokeSysExIndicator();let t=[0,0,0,0],s=(i,n)=>{t[n]=i};if(a.subarray(1).forEach((i,n)=>{let f=n+a[0];([s,s,s,s,l=>{this.#d=l*129/16383*100,e.dispatchEvent("mastervolume",e.#d)},l=>{},l=>{}][f]||(()=>{}))(i,n)}),a[0]<4){let i=0;t.forEach(n=>{i=i<<4,i+=n}),i-=1024,console.debug(`Master tune: ${i}`)}}}}).add([76,2,1],(a,c,d)=>{e.invokeSysExIndicator();let t="XG ";a[0]<32?(t+="reverb ",a.subarray(1).forEach((s,i)=>{([n=>{e.setEffectTypeRaw(0,!1,n),console.info(`${t}main type: ${X[n]}`),e.dispatchEvent("efxreverb",e.getEffectType(0))},n=>{e.setEffectTypeRaw(0,!0,n),console.debug(`${t}sub type: ${n+1}`),e.dispatchEvent("efxreverb",e.getEffectType(0))},n=>{console.debug(`${t}time: ${fe(n)}s`)},n=>{console.debug(`${t}diffusion: ${n}`)},n=>{console.debug(`${t}initial delay: ${n}`)},n=>{console.debug(`${t}HPF cutoff: ${B[n]}Hz`)},n=>{console.debug(`${t}LPF cutoff: ${B[n]}Hz`)},n=>{console.debug(`${t}width: ${n}`)},n=>{console.debug(`${t}height: ${n}`)},n=>{console.debug(`${t}depth: ${n}`)},n=>{console.debug(`${t}wall type: ${n}`)},n=>{console.debug(`${t}dry/wet: ${n}`)},n=>{console.debug(`${t}send: ${R(n)}dB`)},n=>{console.debug(`${t}pan: ${n-64}`)},!1,!1,n=>{console.debug(`${t}delay: ${n}`)},n=>{console.debug(`${t}density: ${n}`)},n=>{console.debug(`${t}balance: ${n}`)},n=>{},n=>{console.debug(`${t}feedback: ${n}`)},n=>{}][a[0]+i]||function(){console.warn(`Unknown XG reverb address: ${a[0]}.`)})(s)})):a[0]<64?(t+="chorus ",a.subarray(1).forEach((s,i)=>{([n=>{e.setEffectTypeRaw(1,!1,n),console.info(`${t}main type: ${X[n]}`),e.dispatchEvent("efxchorus",e.getEffectType(1))},n=>{e.setEffectTypeRaw(1,!0,n),console.debug(`${t}sub type: ${n+1}`),e.dispatchEvent("efxchorus",e.getEffectType(1))},n=>{console.debug(`${t}LFO: ${de[n]}Hz`)},n=>{},n=>{console.debug(`${t}feedback: ${n}`)},n=>{console.debug(`${t}delay offset: ${he(n)}ms`)},n=>{},n=>{console.debug(`${t}low: ${B[n]}Hz`)},n=>{console.debug(`${t}low: ${n-64}dB`)},n=>{console.debug(`${t}high: ${B[n]}Hz`)},n=>{console.debug(`${t}high: ${n-64}dB`)},n=>{console.debug(`${t}dry/wet: ${n}`)},n=>{console.debug(`${t}send: ${R(n)}dB`)},n=>{console.debug(`${t}pan: ${n-64}`)},n=>{console.debug(`${t}to reverb: ${R(n)}dB`)},!1,n=>{},n=>{},n=>{},n=>{console.debug(`${t}LFO phase diff: ${(n-64)*3}deg`)},n=>{console.debug(`${t}input mode: ${n?"stereo":"mono"}`)},n=>{}][a[0]-32+i]||function(){console.warn(`Unknown XG chorus address: ${a[0]}.`)})(s)})):a[0]<86?(t+="variation ",a.subarray(1).forEach((s,i)=>{([n=>{e.setEffectTypeRaw(2,!1,n),console.info(`${t}main type: ${X[n]}`),e.dispatchEvent("efxdelay",e.getEffectType(2))},n=>{e.setEffectTypeRaw(2,!0,n),console.debug(`${t}sub type: ${n+1}`),e.dispatchEvent("efxdelay",e.getEffectType(2))}][a[0]-64+i]||function(){})(s)})):a[0]<97?(t+="variation ",a.subarray(1).forEach((s,i)=>{[n=>{console.debug(`${t}send: ${R(n)}dB`)},n=>{console.debug(`${t}pan: ${n-64}`)},n=>{console.debug(`${t}to reverb: ${R(n)}dB`)},n=>{console.debug(`${t}to chorus: ${R(n)}dB`)},n=>{console.debug(`${t}connection: ${n?"system":"insertion"}`)},n=>{console.debug(`${t}channel: CH${n+1}`)},n=>{console.debug(`${t}mod wheel: ${n-64}`)},n=>{console.debug(`${t}bend wheel: ${n-64}`)},n=>{console.debug(`${t}channel after touch: ${n-64}`)},n=>{console.debug(`${t}AC1: ${n-64}`)},n=>{console.debug(`${t}AC2: ${n-64}`)}][a[0]-86+i](s)})):a[0]>111&&a[0]<118?t+="variation ":console.warn(`Unknown XG variation address: ${a[0]}`)}).add([76,2,64],(a,c,d)=>{a.subarray(1).forEach((t,s)=>{let i=s+a[0];if(i===0)console.debug(`XG EQ preset: ${["flat","jazz","pop","rock","classic"][t]}`);else{let n=i-1>>2,f=i-1&3,l=`XG EQ ${n} ${["gain","freq","Q","shape"][f]}: `;[()=>{console.debug(`${l}${t-64}dB`)},()=>{console.debug(`${l}${t} (raw)`)},()=>{console.debug(`${l}${t/10}`)},()=>{console.debug(`${l}${["shelf","peak"][+!!t]}`)}][f]()}})}).add([76,3],(a,c,d)=>{e.invokeSysExIndicator();let t=a[0],s=a[1],i=`XG Insertion ${a[0]+1} `;a.subarray(2).forEach((n,f)=>{([l=>{e.setEffectTypeRaw(3+t,!1,l),console.info(`${i}main type: ${X[l]}`),e.dispatchEvent(`efxinsert${t}`,e.getEffectType(3+t))},l=>{e.setEffectTypeRaw(3+t,!0,l),console.debug(`${i}sub type: ${l+1}`),e.dispatchEvent(`efxinsert${t}`,e.getEffectType(3+t))}][s+f]||function(){})(n)})}).add([76,6,0],(a,c,d)=>{let t=a[0];t<64?e.setLetterDisplay(a.subarray(1),"XG letter display",t):e.#K=Date.now()}).add([76,7,0],(a,c,d)=>{let t=a[0];e.#C=0,e.#P=Date.now()+3200,e.#w.fill(0);let s=a.subarray(1);for(let i=0;i<t;i++)s.unshift(0);s.forEach(function(i,n){let f=Math.floor(n/16),l=n%16,b=(l*3+f)*7,C=7,k=0;for(b-=l*5,f===2&&(C=2);k<C;)e.#w[b+k]=i>>6-k&1,k++})}).add([76,8],(a,c)=>{e.invokeSysExIndicator();let d=e.chRedir(a[0],c,!0),t=a[1],s=x[d],i=`XG CH${d+1} `,n=`Unknown XG part address ${t}.`,f=!0;a.subarray(2).forEach((l,b)=>{f=!0,t<1?console.debug(n):t<41?([()=>{e.setChCc(d,0,l),e.pushChPrimitives(d),e.dispatchEvent("voice",{part:d})},()=>{e.setChCc(d,32,l),e.pushChPrimitives(d),e.dispatchEvent("voice",{part:d})},()=>{e.#s[d]=l,e.dispatchEvent("voice",{part:d})},()=>{f=!1;let C=e.chRedir(l,c,!0),k=e.#c[d];e.#c[d]=C,(d!==C||C!==k)&&(e.buildRchTree(),console.info(`${i}receives from CH${C+1}`)),e.#x[d]||(e.copyChSetup(C,d,!0),console.debug(`${i}copied from CH${C+1}.`),e.setChActive(d,1),e.dispatchEvent("voice",{part:d}))},()=>{e.#m[d]=+!l},()=>{},()=>{f=!1,e.setChType(d,l,m.xg),console.debug(`${i}type: ${K[l]||l}`),e.dispatchEvent("voice",{part:d})},()=>{e.#r[p.rpn*d+3]=l,e.#i[p.rpnt*d+2]=1,e.dispatchEvent("pitch",{part:d,pitch:e.getPitchShift(d)})},!1,!1,()=>{e.setChCc(d,7,l)},!1,!1,()=>{e.setChCc(d,10,l||128)},!1,!1,()=>{e.setChCc(d,128,l),e.allocateAce(d,128)},()=>{e.setChCc(d,93,l)},()=>{e.setChCc(d,91,l)},()=>{e.setChCc(d,94,l)},()=>{e.setChCc(d,76,l)},()=>{e.setChCc(d,77,l)},()=>{e.setChCc(d,78,l)},()=>{e.setChCc(d,74,l)},()=>{e.setChCc(d,71,l)},()=>{e.setChCc(d,73,l)},()=>{e.setChCc(d,75,l)},()=>{e.setChCc(d,72,l)}][t+b-1]||(()=>{}))():t<48?console.debug(n):t<111?t>102&&t<105&&e.setChCc(d,[5,65][t&1],l):t<114?console.debug(n):t<116?console.debug(`${i}EQ ${["bass","treble"][t&1]} gain: ${l-64}dB`):t<118?console.debug(n):t<120?console.debug(`${i}EQ ${["bass","treble"][t&1]} freq: ${l}`):console.debug(n)}),f&&e.#a[d]>1&&e.setDrumFirstWrite(d)}).add([76,9],(a,c)=>{let d=e.chRedir(a[0],c,!0),t=a[1],s=x[d],i=`PLG-VL CH${d+1} `;a.subarray(2).forEach((n,f)=>{let l=f+t;switch(l){case 1:{console.info(`${i}breath mode: ${["system","breath","velocity","touch EG"][n]}`);break}case 0:case 27:case 28:break;default:if(l<27){let b=l-3>>1,C=["pressure","embouchure","tonguing","scream","breath noise","growl","throat formant","harmonic enhancer","damping","absorption","amplification","brightness"][b];l&1?l<23?(console.debug(`${i}${C} control source: ${be(n)}`),n&&n<96&&e.allocateAce(d,130+b),e.#Y[p.redir*d+b+2]=n,e.buildRccMap()):console.debug(`${i}${C} scale break point: ${n}`):(console.debug(`${i}${C} depth: ${n-64}`),e.setChCc(d,130+b,n))}}})}).add([76,10],(a,c,d)=>{}).add([76,16],(a,c,d)=>{}).add([76,17,0,0],(a,c,d)=>{}).add([76,112],(a,c,d)=>{switch(console.debug(`XG enable PLG-${["VL","SG","DX","AN","PF","DR","PC","AP"][a[0]]} for CH${a[2]+1}.`),a[0]){case 0:{e.#v[p.ext*a[2]]=e.EXT_VL;break}case 2:{e.#v[p.ext*a[2]]=e.EXT_DX;break}default:e.#v[p.ext*a[2]]=e.EXT_NONE}}).add([73,0,0],(a,c)=>{let d=a[0],t="MU1000 System - ";a.subarray(1).forEach((s,i)=>{let n=d+i;n===8?console.debug(`${t}LCD contrast: ${s}.`):n===18?(e.#u[m.xg][1]=s?126:0,console.debug(`${t}default bank: ${s?"MU100 Native":"MU Basic"}.`),e.dispatchEvent("banklevel",{mode:"xg",data:+!!s}),e.forceVoiceRefresh()):n>=64&&n<69&&[()=>{e.dispatchEvent("channelactive",s)},()=>{s<8?(e.dispatchEvent("channelmin",s<<4),console.debug(`Octavia System: Minimum CH${(s<<4)+1}`)):(e.dispatchEvent("channelreset"),console.info("Octavia System: Clear channel ranges"))},()=>{s<8?(e.dispatchEvent("channelmax",(s<<4)+15),console.debug(`Octavia System: Maximum CH${(s<<4)+16}`)):(e.dispatchEvent("channelreset"),console.info("Octavia System: Clear channel ranges"))},()=>{e.dispatchEvent("channelreset"),console.info("Octavia System: Clear channel ranges")},()=>{e.#L=!!s,console.info(`Octavia System: RS receiving ${["dis","en"][s]}abled.`)}][n-64]()})}).add([73,10,0],(a,c)=>{let d=a[0],t=`MU1000 RS${e.#L?"":" (ignored)"}: `;if(d<16)switch(d){case 2:{let s=e.chRedir(0,c,!0);e.#L&&(e.dispatchEvent("portrange",4),e.dispatchEvent("portstart",s)),console.info(`${t}Show CH${s+1}~CH${s+64}`);break}case 3:{let s=e.chRedir(a[1]<<5,c,!0);e.#L&&(e.dispatchEvent("portrange",2),e.dispatchEvent("portstart",s)),console.info(`${t}Show CH${s+1}~CH${s+32}`);break}default:console.debug(`${t}unknown switch ${d} invoked.`)}else if(d<32){if(e.#L){let s=e.chRedir(d-16+(e.#fe<<4),c,!0);e.dispatchEvent("channelactive",s)}}else if(d<36){let s=e.chRedir(d-32<<4,c,!0);e.#L&&(e.dispatchEvent("portrange",1),e.dispatchEvent("portstart",s>>4),e.#fe=d-32),console.info(`${t}Show CH${s+1}~CH${s+16}`)}}).add([73,11,0],(a,c)=>{let d="MU1000 System - channel ",t="Octavia System - channel ",s=a[0];a.subarray(1).forEach((i,n)=>{let f=s+n;([()=>{e.setChActive(i,1),e.dispatchEvent("channelactive",i),w()&&console.debug(`${d}current part: CH${i+1}`)},()=>{i<5?(e.dispatchEvent("portrange",1<<i),console.debug(`${d}port range: ${1<<i} port(s)`)):(e.dispatchEvent("portrange",0),console.debug(`${d}port range: reset`))},()=>{i<16?(e.dispatchEvent("portstart",i),console.debug(`${t}start port: ${"ABCDEFGHIJKLMNOP"[i]}`)):(e.dispatchEvent("portstart",255),console.debug(`${t}start port: reset`))}][f]||(()=>{console.debug(`${d}unknown address: ${f}`)}))()})}).add([93,3],(a,c)=>{let d=e.chRedir(a[0],c,!0),t=`PLG-SG CH${d+1} `,s=Date.now();if(a[1]===0){let i="",n=0;a.subarray(2).forEach((f,l)=>{l%2===0?i+=ue[f]||f.toString().padStart("0"):n+=f*13}),(s>=e.#Q||e.#j>=e.#ge)&&(e.dispatchEvent("metacommit",{type:"SGLyrics",data:"",amend:!1}),e.#Z=s<e.#Q,e.#j=0),e.dispatchEvent("metacommit",{type:"SGLyrics",data:`${pe(i)}`,amend:!0,mask:e.#Z}),e.#j++,e.#Z=!1,e.#Q=s+Math.ceil(n/2)+e.#de,w()&&console.debug(`${t}vocals: ${i}`)}else console.warn(`Unknown PLG-SG data: ${a}`)}).add([98,96],(a,c,d,t)=>{let s=e.chRedir(a[0],c,!0),i=x[s],n=a[1];a.subarray(2).forEach((f,l)=>{let b=n+l;if(!(b<10)){if(b===10)e.resetAce();else if(b<27){let C=b+131;e.setChCc(s,C,f),!t?.noAce&&f>0&&f!==64&&e.allocateAce(s,C),e.dispatchEvent("cc",{part:s,cc:C,data:f})}}})}).add([1,20],(a,c,d)=>{d===115?(e.switchMode("doc",!0),e.setPortMode(e.getTrackPort(c),1,m.doc),console.info("MIDI reset: DOC")):console.debug(`Unknown Yamaha SysEx: 67, ${d}, ${a.join(", ")}`)}).add([1,17,15,89],(a,c,d)=>{d===115?(e.setEffectType(0,24,a[0]|16),e.dispatchEvent("efxreverb",e.getEffectType(0))):console.debug(`Unknown Yamaha SysEx: 67, ${d}, ${a.join(", ")}`)}).add([1,24],(a,c,d)=>{if(d===115){for(let t=0;t<16;t++){let s=e.chRedir(t,c,!0);e.setChCc(s,91,127)}console.info("DOC Global Reverb: on")}else console.debug(`Unknown Yamaha SysEx: 67, ${d}, ${a.join(", ")}`)}).add([126,0],(a,c,d)=>{switch(a[1]){case 0:{e.dispatchEvent("metacommit",{type:"YMCSSect",data:"Disabled",raw:"Intro "}),console.debug("Yamaha Section Control is off.");break}case 127:{e.dispatchEvent("metacommit",{type:"YMCSSect",data:["Intro","Main A","Main B","Fill-in AB","Fill-in BA","Ending","Blank"][a[0]-8]??`invalid section ${a[0]}`,raw:["Intro ","Main A","Main B","FillAB","FillBA","Ending","Blank "][a[0]-8]??`ID: ${a[0]}`}),console.debug(`Yamaha Section Control switches to "${["intro","main A","main B","fill-in AB","fill-in BA","ending","blank"][a[0]-8]??`Invalid section ${a[0]}`}".`);break}default:console.debug(`Unknown YMCS section control: ${a[1]}`)}}).add([126,2],(a,c,d)=>{let t=[];for(let s=0;s<a.length;s+=2){let i=a[s]>>4,n=a[s]&15;if(i<7&&n&&n<8){let f=new Uint8Array(5);f[0]=n-1,f[1]=i-3<<2,f[2]=a[s|1],t.push(f)}}e.dispatchEvent("metacommit",{type:"ChordCtl",src:"ymcs",data:t}),console.debug("YMCS chord data: %o",t)});let h=function(a,c,d,t){},u=function(a,c){e.invokeSysExIndicator();let d=a*p.dpn,t=c[0],s=c[1];c.subarray(2).forEach((i,n)=>{let f=n+s,l=-1;f<16?([()=>{l=24},()=>{l=25},()=>{l=26},()=>{},()=>{l=28},()=>{l=29},()=>{l=30},()=>{l=31},()=>{},()=>{},()=>{},()=>{l=20},()=>{l=21},()=>{l=22},()=>{l=23},()=>{}][f]||(()=>{console.debug(`Unknown XG-style drum param ${f} on set ${a+1}.`)}))():f<32||(f<40?([()=>{l=48},()=>{l=49},!1,!1,()=>{l=52},()=>{l=53}][f-32]||(()=>{console.debug(`Unknown XG-style drum param ${f} on set ${a+1}.`)}))():f<80||([()=>{l=36}][f-80]||(()=>{console.debug(`Unknown XG-style drum param ${f} on set ${a+1}.`)}))()),l>=0?(w()&&console.debug(d,l,t,i),e.#$[(d+O[l])*p.dnc+t]=i):w()&&console.debug(`XG-style drum param ${f} has no writes.`)})},E=function(a,c,d){e.invokeSysExIndicator();let t=a*p.dpn,s=(c<<7)+d[0];d.subarray(1).forEach((i,n)=>{let f=n+s,l=f&127,b=f>>7,C=-1;b>1&&([()=>{C=26},()=>{},()=>{C=28},()=>{C=29},()=>{C=30},()=>{},()=>{},()=>{C=31}][b-2]||(()=>{console.debug(`Unknown GS-style drum param ${b} on set ${a+1}.`)}))(),C>-1?(w()&&console.debug(t,C,l,i),e.#$[(t+O[C])*p.dnc+l]=i):w()&&console.debug(`GS-style drum param ${b} has no writes.`)})};this.#g.add([76,48],(a,c,d)=>{u(0,a)}).add([76,49],(a,c,d)=>{u(1,a)}).add([76,50],(a,c,d)=>{u(2,a)}).add([76,51],(a,c,d)=>{u(3,a)}).add([76,52],(a,c,d)=>{u(4,a)}).add([76,53],(a,c,d)=>{u(5,a)}).add([76,54],(a,c,d)=>{u(6,a)}).add([76,55],(a,c,d)=>{u(7,a)}),this.#g.add([89,0],(a,c,d)=>{if(e.eprom){let t=a[0],s=(a[1]<<14)+(a[2]<<7)+a[3]+(e.eprom.offset||0);w()&&console.debug(`MU1000 EPROM trail to 0x${s.toString(16).padStart(6,"0")}, ${t} bytes.`);let i=e.eprom.data;a.subarray(4).forEach((n,f)=>{let l=f>>3,b=f&7;if(b===7)for(let C=0;C<7;C++)i[s+7*l+C]+=(n>>6-C&1)<<7;else i[s+7*l+b]=n})}}).add([89,1],(a,c,d)=>{let t=(a[0]<<21)+(a[1]<<14)+(a[2]<<7)+a[3];w()&&console.debug(`MU1000 EPROM jump to 0x${t.toString(16).padStart(6,"0")}.`),e.eprom&&(e.eprom.offset=t)}).add([89,2],(a,c,d)=>{if(e.eprom){let t=(a[0]<<21)+(a[1]<<14)+(a[2]<<7)+a[3]+(e.eprom.offset||0);w()&&console.debug(`MU1000 EPROM write to 0x${t.toString(16).padStart(6,"0")}.`);let s=e.eprom.data;a.subarray(4).forEach((i,n)=>{let f=n>>3,l=n&7;if(l===7)for(let b=0;b<7;b++)s[t+7*f+b]+=(i>>6-b&1)<<7;else s[t+7*f+l]=i})}}).add([89,3],(a,c,d)=>{}),this.#g.add([39,48],(a,c,d)=>{}).add([43,0,0],(a,c,d)=>{e.invokeSysExIndicator();let t=[0,0,0,0],s=(i,n)=>{t[n]=i};if(a.subarray(1).forEach((i,n)=>{let f=n+a[0];[s,s,s,s,()=>{this.#d=i*129/16383*100,e.dispatchEvent("mastervolume",e.#d)},()=>i-64,()=>i||128,()=>i,()=>i,()=>{console.debug(`TG300 variation on cc${i}.`)}][f](i,f)}),a[0]<4){let i=0;t.forEach(n=>{i=i<<4,i+=n}),i-=1024,console.debug(`Master tune: ${i}`)}}).add([43,1,0],(a,c,d)=>{e.invokeSysExIndicator()}).add([43,2],(a,c,d)=>{e.invokeSysExIndicator();let t=e.chRedir(a[0],c,!0),s=a[1],i=x[t],n=`TG300 CH${t+1} `;a.subarray(2).forEach((f,l)=>{l<5?([()=>{},()=>{e.setChCc(t,0,f),e.pushChPrimitives(t),e.dispatchEvent("voice",{part:t})},()=>{e.setChCc(t,32,f),e.pushChPrimitives(t),e.dispatchEvent("voice",{part:t})},()=>{e.#s[t]=f,e.dispatchEvent("voice",{part:t})},()=>{let b=e.chRedir(f,c,!0),C=e.#c[t];e.#c[t]=b,(t!==b||b!==C)&&(e.buildRchTree(),console.info(`${n}receives from CH${b+1}`))}][l+s]||(()=>{}))(f,l+s):l<21||(l<47?([()=>{e.#m[t]=+!f},()=>{},()=>{},()=>{e.#r[p.rpn*t+3]=f,e.#i[p.rpnt*t+2]=1,e.dispatchEvent("pitch",{part:t,pitch:e.getPitchShift(t)})},()=>{},()=>{e.setChCc(t,7,f)},!1,!1,()=>{e.setChCc(t,10,f||128)},!1,!1,()=>{console.debug(`${n} AC1 at cc${f}`)},()=>{console.debug(`${n} AC2 at cc${f}`)},()=>{e.#e[i+g[128]]=f,e.allocateAce(t,128)},()=>{e.#e[i+g[93]]=f},()=>{e.#e[i+g[91]]=f},()=>{e.#e[i+g[94]]=f},()=>{e.#e[i+g[76]]=f},()=>{e.#e[i+g[77]]=f},()=>{e.#e[i+g[74]]=f},()=>{e.#e[i+g[71]]=f},()=>{e.#e[i+g[73]]=f},()=>{e.#e[i+g[75]]=f},()=>{e.#e[i+g[72]]=f},()=>{e.#e[i+g[78]]=f}][l+s-21]||(()=>{}))(f,l+s):l<95||([()=>{e.#e[i+g[65]]=f},()=>{e.#e[i+g[5]]=f}][l+s-95]||(()=>{}))(f,l+s))})}).add([43,7,0],(a,c,d)=>{let t=a[0];e.setLetterDisplay(a.subarray(1),"TG300 letter display",t)}).add([43,7,1],(a,c,d)=>{e.#C=0,e.#P=Date.now()+3200,e.#w.fill(0),a.forEach(function(t,s){let i=Math.floor(s/16),n=s%16,f=(n*3+i)*7,l=7,b=0;for(f-=n*5,i===2&&(l=2);b<l;)e.#w[f+b]=t>>6-b&1,b++})}),this.#R.add([66,18,0,0,127],(a,c,d)=>{e.switchMode("sc",!0),e.setPortMode(e.getTrackPort(c),2,m.sc),e.#u[m.sc][1]=e.#n.sc,e.#o=e.KARAOKE_NONE,e.#_.fill(0),console.info(`GS system to ${["single","dual"][a[0]]} mode.`)}).add([66,18,64,0],(a,c,d)=>{switch(a[0]){case 127:{e.switchMode("gs",!0),e.setPortMode(e.getTrackPort(c),4,m.gs),e.#u[m.gs][1]=e.#n.gs,e.#o=e.KARAOKE_NONE,e.#_.fill(0),console.info("MIDI reset: GS");break}default:{e.invokeSysExIndicator();let t=[0,0,0,0],s=(i,n)=>{t[n]=i};if(a.subarray(1).forEach((i,n)=>{let f=n+a[0];[s,s,s,s,l=>{this.#d=l*129/16383*100,e.dispatchEvent("mastervolume",e.#d)},l=>{},l=>{}][f](i,n)}),a[0]<4){let i=0;t.forEach(n=>{i=i<<4,i+=n}),i-=1024,console.debug(`Master tune: ${i}`)}}}}).add([66,18,64,1],(a,c,d)=>{e.invokeSysExIndicator();let t=a[0];if(t<16){let s="".padStart(t," ");a.subarray(1).forEach((i,n)=>{s+=String.fromCharCode(Math.max(32,i))}),s=s.padEnd(16," "),console.debug(`GS patch name: ${s}`)}else t<48||(t<65?a.subarray(1).forEach((s,i)=>{let n=`GS ${t+i>55?"chorus":"reverb"} `;([()=>{console.info(`${n}type: ${ee[s]}`),e.setEffectType(0,40,s),e.dispatchEvent("efxreverb",e.getEffectType(0))},()=>{},()=>{},()=>{},()=>{},()=>{},!1,()=>{console.debug(`${n}predelay: ${s}ms`)},()=>{console.info(`${n}type: ${ye[s]}`),e.setEffectType(1,40,16+s),e.dispatchEvent("efxchorus",e.getEffectType(1))},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{console.debug(`${n}to reverb: ${R(s)}`)},()=>{console.debug(`${n}to delay: ${R(s)}`)}][t+i-48]||(()=>{}))()}):t<80?console.debug(`Unknown GS patch address: ${t}`):t<91?a.subarray(1).forEach((s,i)=>{let n="GS delay ";([()=>{console.info(`${n}type: ${Ce[s]}`),e.setEffectType(2,40,32+s),e.dispatchEvent("efxdelay",e.getEffectType(2))},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{},()=>{console.debug(`${n}to reverb: ${R(s)}`)}][t+i-80]||(()=>{}))()}):console.debug(`Unknown GS patch address: ${t}`))}).add([66,18,64,2],(a,c,d)=>{let t="GS EQ ";a.subarray(1).forEach((s,i)=>{([()=>{console.debug(`${t}low freq: ${[200,400][s]}Hz`)},()=>{console.debug(`${t}low gain: ${s-64}dB`)},()=>{console.debug(`${t}high freq: ${[3e3,6e3][s]}Hz`)},()=>{console.debug(`${t}high gain: ${s-64}dB`)}][a[0]+i]||function(){console.warn(`Unknown GS EQ address: ${a[0]+i}`)})()})}).add([66,18,64,3],(a,c,d)=>{e.invokeSysExIndicator();let t="GS EFX ",s=function(i,n){let f=me(e.#S.subarray(10,12),n,i);f&&console.debug(`${t}${te(e.#S.subarray(10,12))} ${f}`)};a.subarray(1).forEach((i,n)=>{([()=>{e.setEffectTypeRaw(3,!1,32+i),e.dispatchEvent("efxinsert0",e.getEffectType(3))},()=>{e.setEffectTypeRaw(3,!0,i),console.info(`${t}type: ${te(e.#S.subarray(10,12))}`),e.dispatchEvent("efxinsert0",e.getEffectType(3))},!1,s,s,s,s,s,s,s,s,s,s,s,s,s,s,s,s,s,s,s,s,()=>{console.debug(`${t}to reverb: ${R(i)}dB`)},()=>{console.debug(`${t}to chorus: ${R(i)}dB`)},()=>{console.debug(`${t}to delay: ${R(i)}dB`)},!1,()=>{console.debug(`${t}1 source: ${i}`),i&&i<96&&e.allocateAceAll(i)},()=>{console.debug(`${t}1 depth: ${i-64}`)},()=>{console.debug(`${t}2 source: ${i}`),i&&i<96&&e.allocateAceAll(i)},()=>{console.debug(`${t}2 depth: ${i-64}`)},()=>{console.debug(`${t}to EQ: ${i?"ON":"OFF"}`)}][a[0]+n]||function(f,l){console.warn(`Unknown GS EFX address: ${l}`)})(i,a[0]+n)})}).add([66,18,65],(a,c,d)=>{E((a[0]>>4)+1<<1,a[0]&15,a.subarray(1))}).add([69,18,16],(a,c,d)=>{switch(a[0]){case 0:{let t=a[1];e.setLetterDisplay(a.subarray(2),"GS display text",t);break}case 8:{let t=a[1],s=e.modelEx.sc;a.subarray(2).forEach((i,n)=>{([()=>{s.showBar=!(i&1),s.invBar=i>>1&1,s.invDisp=i>>2&1},()=>{s.peakHold=i<4?i:1}][n+t]||(()=>{console.debug("Unsupported GS display type SysEx.")}))()});break}case 32:{e.#P=Date.now()+3200,a[1]===0&&(a[2]?(e.#C=Math.max(Math.min(a[2]-1,9),0),w()&&console.debug(`GS switch display page ${a[2]-1}.`)):(e.#C=0,e.#P=Date.now(),w()&&console.debug("GS disable display page.")));break}default:if(a[0]<6){e.#C>9&&(e.#C=0);let t=a[0]-1<<1|a[1]>>6;e.#C===t&&(e.#P=Date.now()+3200),e.#N[t]?.length||(e.#N[t]=new Uint8Array(256));let s=e.#N[t];w()&&console.debug(`GS frame draw page ${t}.`);let i=a[1]&63;s.fill(0),a.subarray(2).forEach(function(f,l){let b=l+i,C=Math.floor(b/16),k=b%16,$=(k*4+C)*5,T=5,D=0;for($-=k*4,C===3&&(T=1);D<T;)s[$+D]=f>>4-D&1,D++})}else console.warn(`Unknown GS display section: ${a[0]}`)}}).add([69,18,32],(a,c,d)=>{let t=a[0],s=a[1],i=a.subarray(2);if(t>>4){console.warn(`SC-8850 partial screen dump out of bounds: invalid bundle.
`,a);return}let n=s+i.length,f=s*6-(s*2428>>16<<1),l=n*6-(n*2428>>16<<1);if(f>640){console.warn(`SC-8850 partial screen dump out of bounds: invalid buffer range.
`,a);return}l>640&&(console.info(`SC-8850 partial screen dump out of bounds: invalid buffer end, automatically restricted.
`,a),l=640);let b=new Uint8Array(l-f);i.forEach(($,T)=>{let D=T+s,Y=(D*2428&65535)*27>>16===26,M=D*6-(D*2428>>16<<1),N=Y?2:0;for(;N<6;)b[M+(5-N)]=$>>N&1,N++});let C=t*108+s,k=C*6-(C*2428>>16<<1);e.dispatchEvent("screen",{type:"sc8850",offset:k,data:b}),w()&&console.debug(`SC-8850 screen dump: bundle ${t+1}, range ${f}~${l}`)});let y=function(a,c,d){e.invokeSysExIndicator();let t=a[0],s=x[c],i=_[c],n=`GS CH${c+1} `;t<3?(a.subarray(1).forEach((f,l)=>{[()=>{e.#e[s+g[0]]=f,e.pushChPrimitives(c)},()=>{e.#s[c]=f},()=>{let b=0;f<16?b=e.chRedir(f,d,!0):b=p.ch,e.#c[c]=b;let C=e.#c[c];e.#c[c]=b,(c!==b||b!==C)&&(e.buildRchTree(),console.info(`${n}receives from CH${b+1}`))}][t+l]()}),e.dispatchEvent("voice",{part:c})):t<19||(t<44?a.subarray(1).forEach((f,l)=>{([()=>{e.#m[c]=+!f},!1,()=>{e.setChType(c,f<<1,m.gs),console.debug(`${n}type: ${f?"drum ":"melodic"}${f||""}`)},()=>{e.#r[i+3]=f,e.#i[p.rpnt*c+2]=1,e.dispatchEvent("pitch",{part:c,pitch:e.getPitchShift(c)})},!1,()=>{e.#e[s+g[7]]=f},!1,!1,()=>{e.#e[s+g[10]]=f||128},!1,!1,()=>{console.debug(`${n}CC 1: cc${f}`)},()=>{console.debug(`${n}CC 2: cc${f}`)},()=>{e.#e[s+g[93]]=f},()=>{e.#e[s+g[91]]=f},!1,!1,()=>{e.#r[i+1]=f,e.#i[p.rpnt*c+1]=1,e.dispatchEvent("pitch",{part:c,pitch:e.getPitchShift(c)})},()=>{e.#r[i+2]=f,e.#i[p.rpnt*c+1]=1,e.dispatchEvent("pitch",{part:c,pitch:e.getPitchShift(c)})},()=>{e.#e[s+g[94]]=f}][t+l-19]||(()=>{}))()}):t<76||console.debug(`Unknown GS part address: ${t}`))},v=function(a,c){let d=a[0],t=`GS CH${c+1} `;d<2?a.subarray(1).forEach((s,i)=>{[()=>{e.setChCc(c,32,s)},()=>{}][d+i]()}):d<32?console.warn(`Unknown GS misc address: ${d}`):d<35?a.subarray(1).forEach((s,i)=>{[()=>{console.debug(`${t}EQ: o${["ff","n"][s]}`)},()=>{},()=>{console.debug(`${t}EFX: o${["ff","n"][s]}`),e.#ce[c]=s,e.dispatchEvent("partefxtoggle",{part:c,active:s})}][d+i-32]()}):console.warn(`Unknown GS misc address: ${d}`)};this.#R.add([66,18,64,16],(a,c)=>{y(a,e.chRedir(9,c,!0),c)}).add([66,18,64,17],(a,c)=>{y(a,e.chRedir(0,c,!0),c)}).add([66,18,64,18],(a,c)=>{y(a,e.chRedir(1,c,!0),c)}).add([66,18,64,19],(a,c)=>{y(a,e.chRedir(2,c,!0),c)}).add([66,18,64,20],(a,c)=>{y(a,e.chRedir(3,c,!0),c)}).add([66,18,64,21],(a,c)=>{y(a,e.chRedir(4,c,!0),c)}).add([66,18,64,22],(a,c)=>{y(a,e.chRedir(5,c,!0),c)}).add([66,18,64,23],(a,c)=>{y(a,e.chRedir(6,c,!0),c)}).add([66,18,64,24],(a,c)=>{y(a,e.chRedir(7,c,!0),c)}).add([66,18,64,25],(a,c)=>{y(a,e.chRedir(8,c,!0),c)}).add([66,18,64,26],(a,c)=>{y(a,e.chRedir(10,c,!0),c)}).add([66,18,64,27],(a,c)=>{y(a,e.chRedir(11,c,!0),c)}).add([66,18,64,28],(a,c)=>{y(a,e.chRedir(12,c,!0),c)}).add([66,18,64,29],(a,c)=>{y(a,e.chRedir(13,c,!0),c)}).add([66,18,64,30],(a,c)=>{y(a,e.chRedir(14,c,!0),c)}).add([66,18,64,31],(a,c)=>{y(a,e.chRedir(15,c,!0),c)}).add([66,18,64,64],(a,c)=>{v(a,e.chRedir(9,c,!0))}).add([66,18,64,65],(a,c)=>{v(a,e.chRedir(0,c,!0))}).add([66,18,64,66],(a,c)=>{v(a,e.chRedir(1,c,!0))}).add([66,18,64,67],(a,c)=>{v(a,e.chRedir(2,c,!0))}).add([66,18,64,68],(a,c)=>{v(a,e.chRedir(3,c,!0))}).add([66,18,64,69],(a,c)=>{v(a,e.chRedir(4,c,!0))}).add([66,18,64,70],(a,c)=>{v(a,e.chRedir(5,c,!0))}).add([66,18,64,71],(a,c)=>{v(a,e.chRedir(6,c,!0))}).add([66,18,64,72],(a,c)=>{v(a,e.chRedir(7,c,!0))}).add([66,18,64,73],(a,c)=>{v(a,e.chRedir(8,c,!0))}).add([66,18,64,74],(a,c)=>{v(a,e.chRedir(10,c,!0))}).add([66,18,64,75],(a,c)=>{v(a,e.chRedir(11,c,!0))}).add([66,18,64,76],(a,c)=>{v(a,e.chRedir(12,c,!0))}).add([66,18,64,77],(a,c)=>{v(a,e.chRedir(13,c,!0))}).add([66,18,64,78],(a,c)=>{v(a,e.chRedir(14,c,!0))}).add([66,18,64,79],(a,c)=>{v(a,e.chRedir(15,c,!0))}),this.#U.add([54,65],(a,c)=>{let d=e.#n.x5==="81"?"05rw":"x5d";e.switchMode(d,!0),e.setPortMode(e.getTrackPort(c),1,m[d]);let t=a[a.length-1],s=a.subarray(0,a.length-1),i=L(s);i!==t&&(console.info(`X5D multi parameters checksum mismatch! Expected ${i}, got ${t}.`),console.debug(a));let n=(a[1]<<7)+a[0],f=(a[3]<<7)+a[2],l=e.chRedir(n&15,c,!0),b=x[l];[()=>{f<1||(f<101?(e.setChType(l,e.CH_MELODIC,m.x5d),e.#s[l]=f-1,e.#e[b+g[0]]=e.#n.x5):f<229?(e.setChType(l,e.CH_MELODIC,m.x5d),e.#s[l]=f-101,e.#e[b+g[0]]=56):(e.setChType(l,e.CH_DRUMS,m.x5d),e.#s[l]=Te[f-229]||0,e.#e[b+g[0]]=62)),e.pushChPrimitives(l),e.dispatchEvent("voice",{part:l})},()=>{e.#e[b+g[7]]=f},()=>{f<31&&(e.#e[b+g[10]]=Math.round((f-15)*4.2+64))},()=>{e.#e[b+g[93]]=V(f)},()=>{e.#e[b+g[91]]=V(f)},()=>{e.#r[l*p.rpn+3]=f>8191?f-16320:64+f,e.#i[p.rpnt*l+2]=1,e.dispatchEvent("pitch",{part:l,pitch:e.getPitchShift(l)})},()=>{e.#r[l*p.rpn+1]=f>8191?f-16320:64+f,e.#i[p.rpnt*l+1]=1,e.dispatchEvent("pitch",{part:l,pitch:e.getPitchShift(l)})},()=>{f>0&&(e.#r[l*p.rpn]=f,e.#i[p.rpnt*l]=1,e.dispatchEvent("pitch",{part:l,pitch:e.getPitchShift(l)}))},()=>{}][n>>4]()}).add([54,76,0],(a,c)=>{e.invokeSysExIndicator();let d=e.#n.x5==="81"?"05rw":"x5d";e.switchMode(d),e.setPortMode(e.getTrackPort(c),1,m[d]);let t="",s=e.#n.x5,i=0,n=0,f="MSB	PRG	LSB	NME";A(a,function(l,b){if(b<16400){let C=b%164;switch(!0){case C<10:{l>31&&(t+=String.fromCharCode(l));break}case C===10:break;case C===11:{f+=`
${s}	${i}	${n}	${t.trim().replace("Init Voice","")}`,i++,t="";break}}i>99&&(s=90,i=0)}}),e.userBank.clearRange({msb:e.#n.x5,prg:[0,99],lsb:0}),e.userBank.load(f),w()&&console.debug(f),e.forceVoiceRefresh()}).add([54,77,0],(a,c)=>{e.invokeSysExIndicator();let d=e.#n.x5==="81"?"05rw":"x5d";e.switchMode(d),e.setPortMode(e.getTrackPort(c),1,m[d]);let t="",s=90,i=0,n=0,f="MSB	PRG	LSB	NME";A(a,function(l,b){if(b<13600){let C=b%136;switch(!0){case C<10:{l>31&&(t+=String.fromCharCode(l));break}case C===11:{f+=`
${s}	${i}	${n}	${t.trim().replace("Init Combi","")}`,i++,t="";break}}}}),e.userBank.clearRange({msb:90,prg:[0,99],lsb:0}),e.userBank.load(f),w()&&console.debug(f),e.forceVoiceRefresh()}).add([54,78],(a,c)=>{let d=e.#n.x5==="81"?"05rw":"x5d";e.switchMode(d),e.setPortMode(e.getTrackPort(c),1,m[d]),console.debug(`X5D mode switch requested: ${["combi","combi edit","prog","prog edit","multi","global"][a[0]]} mode.`)}).add([54,85],(a,c)=>{e.invokeSysExIndicator();let d=e.#n.x5==="81"?"05rw":"x5d";e.switchMode(d),e.setPortMode(e.getTrackPort(c),1,m[d]),A(a,(t,s)=>{s>0&&s<3&&(e.setEffectType(s-1,44,t),e.dispatchEvent(`efx${["reverb","chorus"][s-1]}`,e.getEffectType(s-1)))})}).add([54,104],(a,c)=>{e.invokeSysExIndicator();let d=e.#n.x5==="81"?"05rw":"x5d";e.switchMode(d,!0);let t=e.getTrackPort(c);if(e.#p[t]&&e.#p[t]!==m[d])if(e.#I.dumpLimit===e.DUMP_MODE){console.warn(`Dump cancelled for track ${c}. Port ${String.fromCharCode(65+t)} mode "${S[e.#p[t]]}" mismatch, should be "${d}".`);return}else console.info(`Track ${c} is trying to perform a mismached mode dump on port ${String.fromCharCode(65+t)}.`);e.setPortMode(t,1,m[d]),A(a,function(s,i,n,f){if(i<192){let l=e.chRedir(Math.floor(i/12),c,!0),b=x[l];switch(i%12){case 0:{s<128?(e.setChType(l,e.CH_MELODIC,m.x5d),e.#e[b+g[0]]=e.#n.x5,e.#s[l]=s):(e.setChType(l,e.CH_DRUMS,m.x5d),e.#e[b+g[0]]=62,e.#s[l]=Te[s-128]),s>0&&e.setChActive(l,1),e.pushChPrimitives(l),e.dispatchEvent("voice",{part:l});break}case 1:{e.#e[b+g[7]]=s;break}case 2:{e.#r[l*p.rpn+3]=s>127?s-192:64+s,e.#i[p.rpnt*l+2]=1,e.dispatchEvent("pitch",{part:l,pitch:e.getPitchShift(l)});break}case 3:{e.#r[l*p.rpn+1]=s>127?s-192:64+s,e.#i[p.rpnt*l+1]=1,e.dispatchEvent("pitch",{part:l,pitch:e.getPitchShift(l)});break}case 4:{s<31&&(e.#e[b+g[10]]=Math.round((s-15)*4.2+64));break}case 5:{let C=s>>4,k=s&15;e.#e[b+g[91]]=V(k),e.#e[b+g[93]]=V(C);break}case 10:{e.#a[l]||(e.#e[b+g[0]]=s>>6?56:e.#n.x5,e.pushChPrimitives(l),e.dispatchEvent("voice",{part:l}));break}case 11:{let C=e.chRedir(s&15,c,!0),k=s>>4;e.#c[l]=s,(C!==l||k)&&console.info(`X5D Part CH${l+1} receives from CH${C+1}.`)}}}else{let l=e.chRedir(i-192,c,!0)}}),e.buildRchTree()}),this.#R.add([22,18,127],(a,c,d)=>{e.switchMode("mt32",!0),e.setPortMode(e.getTrackPort(c),1,m.mt32),e.#o=e.KARAOKE_NONE,e.userBank.clearRange({msb:0,lsb:127,prg:[0,127]}),console.info("MIDI reset: MT-32")}).add([22,18,0],(a,c,d)=>{e.switchMode("mt32");let t=e.chRedir(d,c,!0),s=a[1];a.subarray(2).forEach((i,n)=>{let f=n+s;e.#H[f+(t-1)*16]=i,([!1,()=>{let l=e.#H[t-1<<4];if(l<3){if(e.#M[t]=1,l===2)for(let b=0;b<name.length;b++)e.#O[(t-1)*p.cmt+b]=e.#G[i*p.cmt+b];else{let b=e.baseBank.get(0,i+(l<<6),127,"mt32").name;for(let C=0;C<b.length;C++)e.#O[(t-1)*p.cmt+C]=b.charCodeAt(C)}e.dispatchEvent("voice",{part:t})}},()=>{e.#r[t*p.rpn+3]=i+40,e.#i[p.rpnt*t+2]=1},()=>{e.#r[t*p.rpn+1]=i+14,e.#i[p.rpnt*t+1]=1},()=>{e.#r[t*p.rpn]=i,e.#i[p.rpnt*t]=1},!1,()=>{e.setChCc(t,91,i?127:0)},!1,()=>{e.setChCc(t,7,i)},()=>{e.setChCc(t,10,Math.ceil(i*9.05))}][f]||(()=>{}))()})}).add([22,18,1],(a,c,d)=>{e.switchMode("mt32");let t=d&7;console.debug(`MT-32 slot #${d+1} Drum: ${a}`);let s=a[0]<<7|a[1];a.subarray(2).forEach((i,n)=>{let f=n+s,l=(f>>2)+24,b=f&3,C=t*p.dpn;if(w()&&console.debug(`MT-32 temp drum note ${l} param ${b}: ${i}`),l<24){console.warn(`MT-32 dev drum write attempted on an OOB note: ${l}`);return}[()=>{},()=>{e.#$[(C+O[26])*p.dnc+l]=Math.round(i*1.27)},()=>{e.#$[(C+O[26])*p.dnc+l]=i*9+1&127},()=>{e.#$[(C+O[26])*p.dnc+l]=i?127:0}][b]()})}).add([22,18,2],(a,c,d)=>{e.switchMode("mt32");let t=e.chRedir(d,c,!0),s=a[1]+(a[0]<<7);s<10&&(e.#M[t]=1),a.subarray(2).forEach((i,n)=>{let f=n+s;f<14&&(e.#O[(t-1)*p.cmt+f]=i)}),e.dispatchEvent("voice",{part:t})}).add([22,18,3],(a,c,d)=>{e.switchMode("mt32");let t=d&7;if(a[0]){let s=(a[0]-1<<7)+a[1]-16;a.subarray(2).forEach((i,n)=>{let f=n+s,l=(f>>2)+24,b=f&3,C=t*p.dpn;if(w()&&console.debug(`MT-32 dev drum note ${l} param ${b}: ${i}`),l<24){console.warn(`MT-32 dev drum write attempted on an OOB note: ${l}`);return}[()=>{},()=>{e.#$[(C+O[26])*p.dnc+l]=Math.round(i*1.27)},()=>{e.#$[(C+O[26])*p.dnc+l]=i*9+1&127},()=>{e.#$[(C+O[26])*p.dnc+l]=i?127:0}][b]()})}else{let s=a[1];a.subarray(2).forEach((i,n)=>{let f=n+s;e.#H[f]=i;let l=e.chRedir(1+(f>>4),c,!0),b=f&15;([!1,()=>{let C=e.#H[l-1<<4];if(C<3)if(e.#M[l]=1,C===2)for(let k=0;k<name.length;k++)e.#O[(l-1)*p.cmt+k]=e.#G[i*p.cmt+k];else{let k=e.baseBank.get(0,i+(C<<6),127,"mt32").name;for(let $=0;$<k.length;$++)e.#O[(l-1)*p.cmt+$]=k.charCodeAt($)}e.dispatchEvent("voice",{part:l})},()=>{e.#r[l*p.rpn+3]=i+40,e.#i[p.rpnt*l+2]=1},()=>{e.#r[l*p.rpn+1]=i+14,e.#i[p.rpnt*l+1]=1},()=>{e.#r[l*p.rpn]=i,e.#i[p.rpnt*l]=1},!1,()=>{e.setChCc(l,91,i?127:0)},!1,()=>{e.setChCc(l,7,i)},()=>{e.setChCc(l,10,Math.ceil(i*9.05))}][b]||(()=>{}))()})}}).add([22,18,4],(a,c,d)=>{e.switchMode("mt32");let t=a[1]+(a[0]<<7),s=[];a.subarray(2).forEach((i,n)=>{let f=n+t,l=e.chRedir(Math.floor(f/246+1),c,!0),b=f%246;b<14&&(e.#O[(l-1)*p.cmt+b]=i),b<10&&(e.#M[l]=1),s.indexOf(l)<0&&s.push(l)}),s.forEach(i=>{e.dispatchEvent("voice",{part:i})})}).add([22,18,5],(a,c,d)=>{e.switchMode("mt32");let t=(a[0]<<7)+a[1];a.subarray(2).forEach((s,i)=>{let n=t+i,f=Math.floor(n/8),l=n&7,b=f*8;e.#le[n]=s,([!1,()=>{let C=e.#le[b];if(C<3){let k="";if(C===2){let T=p.cmt*f;k=`MT-m:${s.toString().padStart(3,"0")}`}else k=e.baseBank.get(0,s+(C<<6),127,"mt32").name;e.userBank.clearRange({msb:0,lsb:127,prg:f});let $=`MSB	LSB	PRG	NME
49	127	${f}	${k}`;e.userBank.load($,!0)}}][l]||(()=>{}))()}),e.forceVoiceRefresh()}).add([22,18,8],(a,c,d)=>{e.switchMode("mt32");let t=((a[0]&1)<<7)+a[1],s=a[0]>>1,i=!1;if(a.subarray(2).forEach((n,f)=>{let l=t+f;l<p.cmt&&(e.#G[s*p.cmt+l]=n,i=!0)}),i){e.userBank.clearRange({msb:0,lsb:127,prg:s});let n=`MSB	LSB	PRG	NME
49	127	${s}	MT-m:${s}`;e.userBank.load(n,!0)}e.forceVoiceRefresh()}).add([22,18,16],(a,c,d)=>{e.switchMode("mt32");let t=a[1],s=!1,i=function(n,f){e.#c[f-12]=n,s=!0};a.subarray(2).forEach((n,f)=>{let l=f+t;([!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,i,i,i,i,i,i,i,i,i,()=>{e.#d=n,e.dispatchEvent("mastervolume",e.#d)}][l]||(()=>{}))(n,f)}),s&&e.buildRchTree()}).add([22,18,32],(a,c,d)=>{e.switchMode("mt32");let t=a[1],s=" ".repeat(t);a.subarray(2).forEach(i=>{i>31?s+=String.fromCharCode(i):s+=" "}),e.#X=s.padStart(20," "),e.#K=Date.now()+3200}).add([22,18,82],(a,c)=>{let d=e.chRedir(0,c,!0);for(let t=0;t<16;t++)e.#E.ano(d+t),t&&t<10&&(e.#s[d+t]=ae[t-1]);console.info("MT-32 alt reset complete.")}),this.#U.add([66,0],(a,c)=>{e.switchMode("ns5r",!0),e.setPortMode(e.getTrackPort(c),2,m.ns5r),e.#o=e.KARAOKE_NONE,console.debug(`NS5R mode switch requested: ${["global","multi","prog edit","comb edit","drum edit","effect edit"][a[0]]} mode.`)}).add([66,1],(a,c)=>{let d=["ns5r","05rw"][a[0]];e.switchMode(d,!0),e.setPortMode(e.getTrackPort(c),2,m[d]),e.#o=e.KARAOKE_NONE}).add([66,18,0,0],(a,c)=>{let d=a[0];switch(d){case 124:case 126:case 127:{e.switchMode("ns5r",!0),e.setPortMode(e.getTrackPort(c),2,m.ns5r),e.#o=e.KARAOKE_NONE;break}case 125:{e.initDrums(),console.info(`NS5R drum setup reset on drum kit ${a[1]}.`);break}default:if(d<10){let t=[0,0,0,0],s=(i,n)=>{t[n]=i};if(a.subarray(1).forEach((i,n)=>{[s,s,s,s,()=>{e.#d=i*129/16383*100,e.dispatchEvent("mastervolume",e.#d)},()=>i-64,()=>i-64,()=>{},()=>{},()=>{}][d+n]()}),a[0]<4){let i=0;t.forEach(n=>{i=i<<4,i+=n}),i-=1024,console.debug(`Master tune: ${i}`)}}}}).add([66,18,0,1],(a,c)=>{}).add([66,18,0,2],(a,c)=>{}).add([66,18,1],(a,c)=>{e.invokeSysExIndicator();let d=e.chRedir(a[0],c,!0),t=x[d],s=a[1],i=`NS5R CH${d+1} `;a.subarray(2).forEach((n,f)=>{let l=s+f;l<3?([()=>{e.#e[t+g[0]]=n||F.bank0,e.pushChPrimitives(d)},()=>{e.#e[t+g[32]]=n,e.pushChPrimitives(d)},()=>{e.#s[d]=n}][l](),e.dispatchEvent("voice",{part:d})):l<8||(l<14?[()=>{let b=e.chRedir(n,c,!0),C=e.#c[d];e.#c[d]=b,(d!==b||b!==C)&&(e.buildRchTree(),console.info(`${i}receives from CH${b+1}`))},()=>{e.#m[d]=+!n},()=>{e.setChType(d,n,m.ns5r),console.debug(`${i}type: ${K[n]}`)},()=>{e.#r[p.rpn*d+3]=n,e.#i[p.rpnt*d+2]=1,e.dispatchEvent("pitch",{part:d,pitch:e.getPitchShift(d)})},()=>{},()=>{}][l-8]():l<16||(l<33?[()=>{e.#e[t+g[7]]=n},()=>{e.#e[t+g[11]]=n},()=>{},()=>{},()=>{e.#e[t+g[10]]=n||128},()=>{},()=>{},()=>{e.#e[t+g[93]]=n},()=>{e.#e[t+g[91]]=n},()=>{e.#e[t+g[76]]=n},()=>{e.#e[t+g[77]]=n},()=>{e.#e[t+g[78]]=n},()=>{e.#e[t+g[74]]=n},()=>{e.#e[t+g[71]]=n},()=>{e.#e[t+g[73]]=n},()=>{e.#e[t+g[75]]=n},()=>{e.#e[t+g[72]]=n}][l-16]():l<112||l<114&&[()=>{e.#e[t+g[5]]=n},()=>{e.#e[t+g[65]]=n}][l-112]()))})}).add([66,18,8,0],(a,c)=>{let d=a[0];if(d<32)e.setLetterDisplay(a.subarray(1,33),"NS5R letter display");else{let t=d-32;e.#P=Date.now()+3200,e.#C=10,e.#w.fill(0);let s=a.subarray(1),i=4;s.forEach(function(n,f){let l=f+t,b=l>>4,C=l&15;if(l<80){let k=b<i?n:n>>3,$=0,T=b<i?6:3;for(;k>0;)e.#w[C*32+b*7+(T-$)]=k&1,k=k>>1,$++}})}}).add([66,18,48],(a,c,d)=>{u(0,a)}).add([66,18,49],(a,c,d)=>{u(1,a)}).add([66,18,50],(a,c,d)=>{u(2,a)}).add([66,18,51],(a,c,d)=>{u(3,a)}).add([66,18,52],(a,c,d)=>{u(4,a)}).add([66,18,53],(a,c,d)=>{u(5,a)}).add([66,18,54],(a,c,d)=>{u(6,a)}).add([66,18,55],(a,c,d)=>{u(7,a)}).add([66,52],(a,c)=>{e.switchMode("ns5r"),e.#o=e.KARAOKE_NONE;let d="";A(a,(t,s)=>{s<8?(t>31&&(d+=String.fromCharCode(t)),s===7&&(e.aiEfxName=d)):s<10&&(e.setEffectType(s-8,44,t),e.dispatchEvent(`efx${["reverb","chorus"][s-8]}`,e.getEffectType(s-8)))})}).add([66,53],(a,c)=>{e.invokeSysExIndicator(),e.switchMode("ns5r"),e.#o=e.KARAOKE_NONE;let d="",t=a[a.length-1],s=a.subarray(0,a.length-1),i=L(s);i!==t&&(console.info(`NS5R current multi dump checksum mismatch! Expected ${i}, got ${t}.`),console.debug(a));let n=e.getTrackPort(c);if(e.#p[n]&&e.#p[n]!==m.ns5r)if(e.#I.dumpLimit===e.DUMP_MODE){console.warn(`Dump cancelled for track ${c}. Port ${String.fromCharCode(65+n)} mode "${S[e.#p[n]]}" mismatch, should be "ns5r".`);return}else console.info(`Track ${c} is trying to perform a mismached mode dump on port ${String.fromCharCode(65+n)}.`);e.setPortMode(n,2,m.ns5r),A(s,function(f,l){switch(!0){case l<2944:{let b=e.chRedir(Math.floor(l/92),c,!0),C=x[b];switch(l%92){case 0:{e.#e[C+g[0]]=f,e.pushChPrimitives(b),e.dispatchEvent("voice",{part:b});break}case 1:{e.#e[C+g[32]]=f,!f&&!e.#e[C+g[0]]&&(e.#e[C+g[0]]=F.bank0),e.pushChPrimitives(b),e.dispatchEvent("voice",{part:b});break}case 2:{e.#s[b]=f,f>0&&e.setChActive(b,1),e.dispatchEvent("voice",{part:b});break}case 3:{let k=e.chRedir(f,c,!0);e.#c[b]=k,b!==k&&console.info(`NS5R CH${b+1} receives from CH${k+1}.`);break}case 7:{e.#a[b]=f,e.dispatchEvent("voice",{part:b});break}case 8:{e.#r[b*p.rpn+3]=f<40||f>88?f+(f>63?-192:64):f,e.#i[p.rpnt*b+2]=1,e.dispatchEvent("pitch",{part:b,pitch:e.getPitchShift(b)});break}case 9:case 10:{e.#e[C+g[7]]=f;break}case 11:{e.#e[C+g[11]]=f;break}case 14:{e.#e[C+g[10]]=f||128;break}case 19:{e.#e[C+g[93]]=f;break}case 20:{e.#e[C+g[91]]=f;break}case 84:{e.#e[C+g[65]]=f;break}case 85:{e.#e[C+g[5]]=f;break}}break}case l<3096:break;case l<3134:{let b=l-3096;b<8?(f>31&&(d+=String.fromCharCode(f)),b===7&&(e.aiEfxName=d)):b<10&&(e.setEffectType(b-8,44,f),e.dispatchEvent(`efx${["reverb","chorus"][b-8]}`,e.getEffectType(b-8)));break}case l<8566:break}}),e.buildRchTree()}).add([66,54],(a,c)=>{e.invokeSysExIndicator(),e.switchMode("ns5r");let d="",t=80,s=0,i=0,n="MSB	PRG	LSB	NME";A(a,function(f,l){let b=l%158;switch(!0){case b<10:{f>31&&(d+=String.fromCharCode(f));break}case b===10:break;case b===11:{t=f&127;break}case b===12:{i=f&127;break}case b===13:{n+=`
${t}	${s}	${i}	${d.trim().replace("Init Voice","")}`,s++,d="";break}}}),e.userBank.clearRange({msb:80,lsb:0}),e.userBank.load(n),w()&&console.debug(n),e.forceVoiceRefresh()}).add([66,55],(a,c)=>{e.invokeSysExIndicator(),e.switchMode("ns5r");let d="",t=88,s=0,i=0,n="MSB	PRG	LSB	NME";A(a,function(f,l){let b=l%126;switch(!0){case b<10:{f>31&&(d+=String.fromCharCode(f));break}case b===11:break;case b===12:break;case b===13:{n+=`
${t}	${s}	${i}	${d.trim().replace("Init Combi","")}`,s++,d="";break}}}),e.userBank.clearRange({msb:88,lsb:0}),e.userBank.load(n),w()&&console.debug(n),e.forceVoiceRefresh()}).add([66,125],(a,c,d)=>{e.dispatchEvent("backlight",["green","orange","red",!1,"yellow","blue","purple"][a[0]]||"white")}).add([66,127],(a,c,d)=>{let t=a[a.length-1],s=a.subarray(0,a.length-1),i=L(s);i!==t&&(console.info(`NS5R screen dump checksum mismatch! Expected ${i}, got ${t}.`),console.debug(a));let n=new Uint8Array(5760);A(a,(f,l,b)=>{if(l<720)for(let C=0;C<8;C++)n[l*8+C]=f>>7-C&1}),e.dispatchEvent("screen",{type:"ns5r",data:n})}).add([76],(a,c,d)=>{e.#U.run([66,...a],c,d)}),this.#re.add([16,0,8,0],(a,c,d)=>{let t=(a[2]<<4)+a[3],s="K11 ";([()=>{e.switchMode("k11",!0),e.setPortMode(e.getTrackPort(c),2,m.k11),e.#o=e.KARAOKE_NONE,e.#u[m.k11][1]=t?4:0,console.info("MIDI reset: GMega/K11")},()=>{e.setEffectType(0,24,t),console.debug(`${s}reverb type: ${t}`),e.dispatchEvent("efxreverb",e.getEffectType(0))},()=>{console.debug(`${s}reverb time: ${t}`)},()=>{console.debug(`${s}reverb time: ${t}`)},()=>{console.debug(`${s}reverb predelay: ${t}`)},()=>{console.debug(`${s}reverb predelay: ${t}`)},()=>{console.debug(`${s}depth high: ${t}`)},()=>{console.debug(`${s}depth high: ${t}`)},()=>{console.debug(`${s}depth low: ${t}`)},()=>{console.debug(`${s}depth low: ${t}`)}][a[0]]||(()=>{}))()}).add([16,0,8,1],(a,c,d)=>{e.invokeSysExIndicator();let t=e.chRedir(a[1],c,!0),s=x[t],i=_[t],n=(a[3]<<4)+a[4],f=`GMega CH${t+1} `;([()=>{n<128?(e.setChType(t,e.CH_MELODIC,m.k11),e.#e[s+g[0]]=0,e.#s[t]=n):(e.setChType(t,e.CH_DRUMS,m.k11),e.#s[t]=n-128),e.pushChPrimitives(t),e.dispatchEvent("voice",{part:t})},()=>{let l=e.chRedir(n,c,!0),b=e.#c[t];e.#c[t]=l,(t!==l||l!==b)&&(e.buildRchTree(),console.info(`${f}receives from CH${l+1}`))},()=>{e.#e[s+g[7]]=n},()=>{uupThis.setChActive(t,n)},()=>{e.#e[s+g[10]]=n},()=>{e.#r[i+3]=n+40,e.#i[p.rpnt*t+2]=1,e.dispatchEvent("pitch",{part:t,pitch:e.getPitchShift(t)})},()=>{e.#r[i+1]=n>>1,e.#r[i+2]=n&1,e.#i[p.rpnt*t+1]=1,e.dispatchEvent("pitch",{part:t,pitch:e.getPitchShift(t)})},()=>{e.#e[s+g[91]]=n?127:0},()=>{},()=>{e.#e[s+g[74]]=n},()=>{e.#e[s+g[73]]=n},()=>{e.#e[s+g[72]]=n}][a[0]]||(()=>{}))()}).add([16,0,9,0],(a,c,d)=>{e.invokeSysExIndicator();let t=(a[2]<<4)+a[3],s="GMLX ";([()=>{console.debug(`${s}reverb type: ${t}`)},()=>{console.debug(`${s}reverb time: ${t}`)},()=>{console.debug(`${s}reverb predelay: ${t}`)},()=>{console.debug(`${s}depth high: ${t}`)},()=>{console.debug(`${s}depth low: ${t}`)}][a[0]]||(()=>{}))()}).add([16,0,9,3],(a,c,d)=>{e.invokeSysExIndicator();let t=(a[2]<<4)+a[3],s=e.chRedir(a[1],c,!0),i=x[s],n=`GMLX CH${s+1} `;[()=>{t<128?(e.setChType(s,e.CH_MELODIC,m.k11),e.#e[i+g[0]]=0,e.#e[i+g[32]]=0,e.#s[s]=t):t<160?(e.setChType(s,e.CH_MELODIC,m.k11),e.#e[i+g[0]]=0,e.#e[i+g[32]]=7,e.#s[s]=t-100):(e.setChType(s,e.CH_DRUMS,m.k11),e.#e[i+g[0]]=122,e.#e[i+g[32]]=0,e.#s[s]=t-160),e.pushChPrimitives(s),e.dispatchEvent("voice",{part:s})},()=>{let f=e.chRedir(t,c,!0),l=e.#c[s];e.#c[s]=f,(s!==f||f!==l)&&(e.buildRchTree(),console.info(`${n}receives from CH${f+1}`))}][a[0]]()}).add([16,0,9,4],(a,c,d)=>{e.invokeSysExIndicator();let t=(a[2]<<4)+a[3],s=e.chRedir(a[1],c,!0),i=x[s],n=_[s];[()=>{e.setChActive(s,t)},()=>{e.#e[i+g[7]]=t},()=>{e.#e[i+g[10]]=t},()=>{e.#e[i+g[91]]=t?127:0},()=>{e.#r[n+3]=t+40,e.#i[p.rpnt*s+2]=1,e.dispatchEvent("pitch",{part:s,pitch:e.getPitchShift(s)})},()=>{e.#r[n+1]=t,e.#i[p.rpnt*s+1]=1,e.dispatchEvent("pitch",{part:s,pitch:e.getPitchShift(s)})},()=>{e.#r[n]=t,e.#i[p.rpnt*s]=1,e.dispatchEvent("pitch",{part:s,pitch:e.getPitchShift(s)})},()=>{}][a[0]]()}),this.#se.add([66,93,64],(a,c,d)=>{let t=a[2];switch(a[0]){case 0:{switch(a[1]){case 4:{e.invokeSysExIndicator(),e.#d=t*129/16383*100,e.dispatchEvent("mastervolume",e.#d);break}case 5:{e.invokeSysExIndicator(),t-64;break}case 6:{e.invokeSysExIndicator(),console.debug(`SG global reverb: ${t?"on":"off"}`);break}case 127:{e.switchMode("sg",!0),e.setPortMode(e.getTrackPort(c),1,m.sg);break}}break}case 1:{switch(a[1]){case 48:{e.invokeSysExIndicator(),console.debug(`SG reverb type: ${ee[t]}`);break}}break}default:if(a[0]>>4===1){e.invokeSysExIndicator();let s=e.chRedir(a[0]&15,c,!0);if(a[1]===2){let i=e.chRedir(t,c,!0),n=e.#c[s];e.#c[s]=i,(s!==i||i!==n)&&(e.buildRchTree(),console.info(`SG CH${s+1} receives from CH${i+1}`))}else a[1]===19&&e.setChCc(s,7,t)}else console.warn(`Unknown AKAI SG SysEx: ${a}`)}}),this.#ie.add([9],(a,c,d)=>{e.invokeSysExIndicator(),console.debug(`GZ set effect: ${["stage reverb","hall reverb","room reverb","chorus","tremolo","phaser","rotary speaker","enhancer","flanger","EQ"][a[0]]||"off"}`)}),this.#g.add([127,0],(a,c,d)=>{e.switchMode("motif");let t=new Uint8Array([127,1,...a]);e.#g.run(t,c,d)}).add([127,1,0,0],(a,c,d)=>{e.switchMode("s90es");let t="S90/Motif ES system ",s=a[0];a.subarray(1).forEach((i,n)=>{([()=>{e.#d=i*12900/16383,e.dispatchEvent("mastervolume",e.#d)}][s+n]||(()=>{console.info(`Unrecognized ${t}ID: ${s+n}`)}))()})}).add([127,1,14],(a,c,d)=>{e.switchMode("s90es");let t="S90/Motif ES bulk header ",s=[];s[95]=(i,n,f)=>{console.debug(`${t}multi edit buffer: ${i[1]}`)},(s[a[0]]||(()=>{console.info(`Unrecognized ${t}ID: ${a[0]}.`)}))(a.subarray(1))}).add([127,1,15],(a,c,d)=>{e.switchMode("s90es");let t="S90/Motif ES bulk footer ",s=[];s[95]=(i,n,f)=>{console.debug(`${t}multi edit buffer: ${i[1]}`)},(s[a[0]]||(()=>{console.info(`Unrecognized ${t}ID: ${a[0]}.`)}))(a.subarray(1))}).add([127,1,54,1],(a,c,d)=>{e.switchMode("s90es");let t="S90/Motif ES reverb ",s=a[0];a.subarray(1).forEach((i,n)=>{([()=>{e.setEffectTypeRaw(0,!1,i&15|128)},()=>{e.setEffectTypeRaw(0,!0,i)}][s+n]||(()=>{}))()}),e.dispatchEvent("efxreverb",e.getEffectType(0))}).add([127,1,54,2],(a,c,d)=>{e.switchMode("s90es");let t="S90/Motif ES chorus ",s=a[0];a.subarray(1).forEach((i,n)=>{([()=>{e.setEffectTypeRaw(1,!1,i&15|128)},()=>{e.setEffectTypeRaw(1,!0,i)}][s+n]||(()=>{}))()}),e.dispatchEvent("efxchorus",e.getEffectType(1))}).add([127,1,54,3],(a,c,d)=>{e.switchMode("s90es");let t="S90/Motif ES insert 1 ",s=a[0];a.subarray(1).forEach((i,n)=>{([()=>{e.setEffectTypeRaw(3,!1,i&15|128)},()=>{e.setEffectTypeRaw(3,!0,i)}][s+n]||(()=>{}))()}),e.dispatchEvent("efxinsert0",e.getEffectType(3))}).add([127,1,54,4],(a,c,d)=>{e.switchMode("s90es");let t="S90/Motif ES insert 2 ",s=a[0];a.subarray(1).forEach((i,n)=>{([()=>{e.setEffectTypeRaw(4,!1,i&15|128)},()=>{e.setEffectTypeRaw(4,!0,i)}][s+n]||(()=>{}))()}),e.dispatchEvent("efxinsert1",e.getEffectType(4))}).add([127,1,54,16],(a,c,d)=>{e.switchMode("s90es");let t=a[0];a.subarray(1).forEach((s,i)=>{let f=`S90/Motif ES EQ${(i>>2)+1} `;([()=>{let l=s-64},()=>{let l=B[s]},()=>{let l=s/10},()=>{let l=s}][t+i&3]||(()=>{}))()})}).add([127,1,54,17],(a,c,d)=>{e.switchMode("s90es");let t="S90/Motif ES variation ",s=a[0];a.subarray(1).forEach((i,n)=>{([()=>{e.setEffectTypeRaw(2,!1,i&15|128)},()=>{e.setEffectTypeRaw(2,!0,i)}][s+n]||(()=>{}))()}),e.dispatchEvent("efxdelay",e.getEffectType(2))}).add([127,1,55],(a,c,d)=>{e.invokeSysExIndicator(),e.switchMode("s90es");let t=e.getTrackPort(c);if(e.#p[t]&&e.#p[t]!==e.#n.smotif)if(e.#I.dumpLimit===e.DUMP_MODE){console.warn(`Dump cancelled for track ${c}. Port ${String.fromCharCode(65+t)} mode "${S[e.#p[t]]}" mismatch, should be "${S[e.#n.smotif]}".`);return}else console.info(`Track ${c} is trying to perform a mismached mode dump on port ${String.fromCharCode(65+t)}.`);let s=e.chRedir(a[0],c,!0),i=x[s],n=a[1];a[0]>15&&(s=a[0]+32);let f=`Track ${c} S90/Motif ES bulk CH${s<128?s+1:"U"+(s-127)} `;console.debug(f,a),!(a[0]>15)&&a.subarray(2).forEach((l,b)=>{([()=>{e.#e[i+g[0]]=l,e.pushChPrimitives(s),e.dispatchEvent("voice",{part:s})},()=>{l&&e.setChActive(s,1),e.#e[i+g[32]]=l,e.getChPrimitive(s,1)===63&&e.setChType(s,[32,40].indexOf(l)>-1?e.CH_DRUMS:e.CH_MELODIC,e.#t,!0),e.pushChPrimitives(s),e.dispatchEvent("voice",{part:s})},()=>{l&&e.setChActive(s,1),e.#s[s]=l,e.dispatchEvent("voice",{part:s})},()=>{let C=e.chRedir(l,c,!0),k=e.#c[s];e.#c[s]=C,(s!==C||C!==k)&&(e.buildRchTree(),console.info(`${f}receives from CH${C+1}`))},()=>{e.#m[s]=l?0:1},!1,!1,!1,!1,!1,!1,!1,!1,()=>{l!==100&&e.setChActive(s,1),e.#e[i+g[7]]=l},()=>{l!==64&&e.setChActive(s,1),e.#e[i+g[10]]=l},!1,!1,!1,()=>{e.#e[i+g[91]]=l},()=>{l&&e.setChActive(s,1),e.#e[i+g[93]]=l},()=>{l&&e.setChActive(s,1),e.#e[i+g[94]]=l},()=>{e.setChCc(s,128,l),l!==127&&(e.setChActive(s,1),e.allocateAce(s,128))},()=>{},()=>{l!==64&&e.setChActive(s,1),e.#e[i+g[74]]=l},()=>{l!==64&&e.setChActive(s,1),e.#e[i+g[71]]=l},!1,()=>{e.#e[i+g[65]]=l},()=>{e.#e[i+g[5]]=l},()=>{}][n+b]||(()=>{}))()})}),e.#g.add([100,14],(a,c,d)=>{e.switchMode("cs6x"),e.setPortMode(e.getTrackPort(c),1,m.cs6x);let t=["normal voice","plugin voice PLG","drums",,"performance",,"phrase clip"][a[0]>>4]??"invalid";a[0]&!0?t+=" edit buffer":a[0]>>4==1?t+=`${(a[0]&1)+1}`:t+=` ${["INT","EXT"][a[0]&1]}`,console.debug(`CS6x bulk dump for ${t} started.`)}).add([100,15],(a,c,d)=>{e.switchMode("cs6x");let t=["normal voice","plugin voice PLG","drums",,"performance",,"phrase clip"][a[0]>>4]??"invalid";a[0]&!0?t+=" edit buffer":a[0]>>4==1?t+=`${(a[0]&1)+1}`:t+=` ${["INT","EXT"][a[0]&1]}`,console.debug(`CS6x bulk dump for ${t} ended.`)}).add([100,76,112],(a,c,d)=>{e.switchMode("cs6x");let t=0,s=a[0];a.subarray(1).forEach((i,n)=>{let f=n+s;f<10?(e.setChCvnRegister(t,n,i&127),e.#M[t]=1):f<12||f<13&&console.debug(`Plugin voice type: ${i}`)}),e.dispatchEvent("voice",{part:t})}).add([100,76,0],(a,c,d)=>{e.switchMode("cs6x"),e.setPortMode(e.getTrackPort(c),1,m.cs6x);let t=0,s=a[0];a.subarray(1).forEach((i,n)=>{let f=n+s;([()=>{e.setChCc(t,7,i),i!==100&&e.setChActive(t,1)},,,()=>{e.#m[t]=i==0,e.setChCc(t,64,0),e.#E.ano(t),e.resetChAceAll(t)},,()=>{},,,()=>{e.setChCc(t,65,i?127:0)},()=>{e.setChCc(t,5,i)},,()=>{e.setChCc(t,91,i),i!==40&&e.setChActive(t,1)},()=>{e.setChCc(t,93,i),i&&e.setChActive(t,1)}][f]||(()=>{}))()})}).add([100,76,1],(a,c,d)=>{e.switchMode("cs6x");let t=0,s=a[0],i=!1;a.subarray(1).forEach((n,f)=>{let l=f+s;([()=>{e.setEffectTypeRaw(0,!1,n&15|128),i=!0},()=>{e.setEffectTypeRaw(0,!0,n),i=!0}][l]||(()=>{}))()}),i&&e.dispatchEvent("efxreverb",e.getEffectType(0))}).add([100,76,2],(a,c,d)=>{e.switchMode("cs6x");let t=0,s=a[0],i=!1;a.subarray(1).forEach((n,f)=>{let l=f+s;([()=>{e.setEffectTypeRaw(1,!1,n&15|128),i=!0},()=>{e.setEffectTypeRaw(1,!0,n),i=!0}][l]||(()=>{}))()}),i&&e.dispatchEvent("efxchorus",e.getEffectType(1))}).add([100,76,3],(a,c,d)=>{e.switchMode("cs6x");let t=0,s=a[0],i=!1;a.subarray(1).forEach((n,f)=>{let l=f+s;([()=>{e.setEffectTypeRaw(2,!1,n&15|128),i=!0},()=>{e.setEffectTypeRaw(2,!0,n),i=!0}][l]||(()=>{}))()}),i&&e.dispatchEvent("efxdelay",e.getEffectType(2))}).add([100,76,5],(a,c,d)=>{e.switchMode("cs6x")}).add([100,76,16],(a,c,d)=>{e.switchMode("cs6x");let t=0,s=a[0],i=!1;if(a.subarray(1).forEach((n,f)=>{let l=f+s;([()=>{e.setChCc(t,0,n),i=!0},()=>{e.setChCc(t,32,n),i=!0,n&&e.setChActive(t,1)},()=>{e.#s[t]=n,i=!0,n&&e.setChActive(t,1)},()=>{e.#i[_[t]+z[2]]=1,e.#r[_[t]+z[2]]=n,n&&e.setChActive(t,1)}][l]||(()=>{}))()}),i){switch(e.pushChPrimitives(t),e.dispatchEvent("voice",{part:t}),e.getChVoice(t).standard){case"DX":{e.#v[t]=e.EXT_DX;break}case"VL":{e.#v[t]=e.EXT_VL;break}}e.dispatchEvent("metacommit",{type:"OSysMeta",data:`CH${t+1} was renamed from "${e.getVoice(...e.getChPrimitives(t,!0),e.getChMode(t))?.name}" to "${e.getChCvnString(t)}".`})}}).add([100,76,32],(a,c,d)=>{e.switchMode("cs6x");let t=0,s=a[0],i=e.#v[t];switch(i){case e.EXT_DX:{a.length>2&&console.debug(a),a.subarray(1).forEach((n,f)=>{let l=f+s;if(l<6){let b=l+142;e.setChCc(t,b,n),n!==64&&e.allocateAce(t,b)}else if(l<12){let b=l+144;e.setChCc(t,b,n),n!==64&&e.allocateAce(t,b)}else([()=>{},()=>{},()=>{},()=>{}][l]||(()=>{}))()});break}case e.EXT_VL:{console.info(`Support for Modular System Plug-in writes is not yet present for plugin type ${i}.`);break}default:console.warn(`Unsupported plug-in type: ${i}`)}}),this.#R.add([0,72,18,0,0,0,0],(a,c,d)=>{e.switchMode("sd",!0),e.setPortMode(e.getTrackPort(c),2,m.sd),console.info("MIDI reset: SD")}).add([0,72,18,16,0],(a,c,d)=>{e.invokeSysExIndicator();let t=a[0]>>5,s=a[0]&31;switch(t){case 0:{let i=a[0]>>1,n=a[1];switch(i){case 1:{a.subarray(2).forEach((f,l,b)=>{let C=l+n;switch(C){case 0:{f&&(e.setEffectType(1,60,f-1),e.dispatchEvent("efxchorus",e.getEffectType(1)),console.debug(`SD MFX Cho: ${C} - ${f}`));break}}});break}case 2:{a.subarray(2).forEach((f,l)=>{let b=l+n;switch(b){case 0:{f&&(e.setEffectType(0,55+f,0),e.dispatchEvent("efxreverb",e.getEffectType(0)),console.debug(`SD MFX Rev: ${b} - ${f}`));break}}});break}case 3:case 4:case 5:{let f=i-1;a.subarray(2).forEach((l,b)=>{let C=b+n;switch(console.debug(`SD MFX ${f-2}: ${C} - ${l}`),C){case 0:{e.setEffectTypeRaw(f,62,l),e.dispatchEvent(`efx${f>2?"delay":"insert"+(f-4)}`,e.getEffectType(f));break}}}),console.debug(`SD MFX message:
%o`,a);break}default:console.debug(`Unknown SD-90 global effects message:
%o`,a)}break}case 1:{let i=e.chRedir(s,c,!0),n=a[1],f=x[i];a.subarray(2).forEach((l,b)=>{let C=n+b;C<37?([()=>{},()=>{},0,()=>{},()=>{switch(l){case 104:case 105:case 106:case 107:case 120:{e.#a[i]||e.setChType(i,e.CH_DRUMS);break}default:e.#a[i]&&e.setChType(i,e.CH_MELODIC)}e.setChCc(i,0,l),e.pushChPrimitives(i),e.dispatchEvent("voice",{part:i})},()=>{e.#e[f+g[32]]=l,e.pushChPrimitives(i),e.dispatchEvent("voice",{part:i})},()=>{e.#s[i]=l,e.dispatchEvent("voice",{part:i})},()=>{e.#e[f+g[7]]=l},()=>{e.#e[f+g[10]]=l},()=>{},()=>{},()=>{l<2&&(e.#m[i]=l)},()=>{l<2&&(e.#e[f+g[68]]=l?127:0)},()=>{},()=>{l<2&&(e.#e[f+g[65]]=l?127:0)},()=>{e.#e[f+g[5]]=l&15<<4|e.#e[f+g[5]]&15},()=>{e.#e[f+g[5]]=l&15|(e.#e[f+g[5]]&240)>>4},()=>{e.#e[f+g[74]]=l},()=>{e.#e[f+g[71]]=l},()=>{e.#e[f+g[73]]=l},()=>{e.#e[f+g[72]]=l},0,0,0,0,0,0,0,()=>{e.#e[f+g[128]]=l,e.allocateAce(128)},()=>{e.#e[f+g[93]]=l},()=>{e.#e[f+g[91]]=l},0,0,()=>{e.#e[f+g[75]]=l},()=>{e.#e[f+g[76]]=l},()=>{e.#e[f+g[77]]=l},()=>{e.#e[f+g[78]]=l}][C]||(()=>{}))():C<63||(C<64?(e.#a[i]?(e.#e[f+g[0]]=104|l,e.pushChPrimitives(i),e.dispatchEvent("voice",{part:i})):(e.#e[f+g[0]]=96|l,e.pushChPrimitives(i),e.dispatchEvent("voice",{part:i})),e.dispatchEvent("voice",{part:i})):console.debug(`Unknown SD-90 global CH${i+1} param setup message:
%o`,a))});break}case 2:{let i=e.chRedir(s,c,!0),n=a[1];console.debug(`Unknown SD-90 global CH${i+1} MIDI setup message:
%o`,a.subarray(2));break}default:console.warn(`Unknown SD-90 global part setup message:
%o`,a)}}),e.#U.add([0,1,73,78],(a,c,d)=>{e.switchMode("krs"),e.setPortMode(e.getTrackPort(c),1,m.krs),console.debug("Might be KORG KROSS 2 mode reset... Not sure.")}).add([0,1,73,117,2,37],(a,c,d)=>{e.switchMode("krs");let t=e.getTrackPort(c);if(e.#p[t]&&e.#p[t]!==m.krs)if(e.#I.dumpLimit===e.DUMP_MODE){console.warn(`Dump cancelled. Port ${String.fromCharCode(65+t)} mode "${S[e.#p[t]]}" mismatch, should be "krs".`);return}else console.info(`Track ${c} is trying to perform a mismached mode dump on port ${String.fromCharCode(65+t)}.`);e.setPortMode(e.getTrackPort(c),1,m.krs);let s="KROSS 2 BMT1 ",i="";A(a,(n,f)=>{if(f<24)i+=String.fromCharCode(Math.max(32,n));else if(!(f<1276)){let l=f-1276,b=e.chRedir(Math.floor(l/44),c,!0),C=l%44,k=x[b];C<15?([()=>{n&&e.setChActive(b,1),e.#s[b]=n,e.dispatchEvent("voice",{part:b})},()=>{n&&e.setChActive(b,1),n<10?(e.#e[k+g[0]]=63,e.#e[k+g[32]]=n):n<20?(e.#e[k+g[0]]=121,e.#e[k+g[32]]=n-10):n<24&&(e.#e[k+g[0]]=[120,0,56,62][n-20],e.#e[k+g[32]]=0),e.pushChPrimitives(b),e.dispatchEvent("voice",{part:b})},()=>{let $=e.chRedir(n&15,c,!0);e.#c[b]=$,console.info(`${s}CH${b+1} receives from CH${$+1}`)},!1,!1,()=>{e.#e[k+g[7]]=n},!1,()=>{},()=>{},!1,!1,!1,!1,!1,()=>{e.#e[k+g[10]]=n||128}][C]||(()=>{}))():C<36||([()=>{e.#e[k+g[74]]=(n+128&255)-64},()=>{e.#e[k+g[71]]=(n+128&255)-64},!1,!1,()=>{e.#e[k+g[73]]=(n+128&255)-64},()=>{e.#e[k+g[75]]=(n+128&255)-64},!1,()=>{e.#e[k+g[72]]=(n+128&255)-64}][C]||(()=>{}))()}}),i=i.trimRight(),e.dispatchEvent("metacommit",{type:"EORTitle",data:i})}),e.#g.add([92,0,0],(a,c,d)=>{let t=a[0];a.subarray(1).forEach((s,i)=>{let n=i+t;n<2||([!1,!1,!1,!1,!1,!1,()=>{e.setChMode(s,m.an1x),e.pushChPrimitives(s),console.debug(`Yamaha AN1x slot 1 receives from CH${s+1}`)},()=>{e.setChMode(s,m.an1x),e.pushChPrimitives(s),console.debug(`Yamaha AN1x slot 2 receives from CH${s+1}.`)}][n-2]||(()=>{}))()})}),e.#g.add([75,80,0],(a,c,d)=>{let t=a[0];a.subarray(1).forEach((s,i)=>{let n=i+t;([()=>{e.modelEx.cs1x.perfCh=s,e.pushChPrimitives(s),console.debug(`Yamaha CS1x performance on CH${s+1}.`)},!1,!1,!1,()=>{},!1,()=>{switch(s){case 1:{e.switchMode("xg",!0),e.setPortMode(e.getTrackPort(c),1,m.xg),console.debug("Yamaha CS1x set to XG mode.");break}case 3:{e.switchMode("cs1x",!0),e.setPortMode(e.getTrackPort(c),1,m.cs1x),console.debug("Yamaha CS1x set to performance mode.");break}default:console.warn(`Unknown Yamaha CS1x mode: ${s}`)}},()=>{}][n]||(()=>{}))()})}).add([75,96,0],(a,c,d)=>{let t=a[0],s=!1,i=e.modelEx.cs1x.perfCh;a.subarray(1).forEach((n,f)=>{let l=f+t;l<8?(s=!0,e.#M[i]=1,e.setChCvnRegister(i,l,n)):l<48?([!1,()=>{e.setChCc(i,7,n)}][l]||(()=>{}))():l<80?([()=>{e.setEffectTypeRaw(0,!1,n)},()=>{e.setEffectTypeRaw(0,!0,n),e.dispatchEvent("efxreverb",e.getEffectType(0))},()=>{e.setEffectTypeRaw(1,!1,n)},()=>{e.setEffectTypeRaw(1,!0,n),e.dispatchEvent("efxchorus",e.getEffectType(1))},()=>{e.setEffectTypeRaw(2,!1,n)},()=>{e.setEffectTypeRaw(2,!0,n),e.dispatchEvent("efxdelay",e.getEffectType(2))}][l-48]||(()=>{}))():w()&&console.debug(`Unknown CS1x effect register: ${l}.`)}),s&&(e.setChActive(i,1),e.pushChPrimitives(i))})}};export{Ot as OctaviaDevice,p as allocated,g as ccToPos,O as dnToPos,w as getDebugState,F as overrides};
