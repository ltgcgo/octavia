var W=Object.create;var _=Object.defineProperty;var Y=Object.getOwnPropertyDescriptor;var Z=Object.getOwnPropertyNames;var J=Object.getPrototypeOf,j=Object.prototype.hasOwnProperty;var ee=(e,r)=>()=>(r||e((r={exports:{}}).exports,r),r.exports);var te=(e,r,a,t)=>{if(r&&typeof r=="object"||typeof r=="function")for(let n of Z(r))!j.call(e,n)&&n!==a&&_(e,n,{get:()=>r[n],enumerable:!(t=Y(r,n))||t.enumerable});return e};var re=(e,r,a)=>(a=e!=null?W(J(e)):{},te(r||!e||!e.__esModule?_(a,"default",{value:e,enumerable:!0}):a,e));var K=ee((ht,I)=>{(function(){"use strict";let e={fatal:!0},r=[new TextDecoder("iso-8859-15",e),new TextDecoder("sjis",e),new TextDecoder("euc-jp",e),new TextDecoder("utf-8",e),new TextDecoder("utf-16",e),new TextDecoder("ascii")],a={debug:!1,parse:function(t,n){if(t instanceof Uint8Array)return a.Uint8(t);if(typeof t=="string")return a.Base64(t);if(t instanceof HTMLElement&&t.type==="file")return a.addListener(t,n);throw new Error("MidiParser.parse() : Invalid input provided")},addListener:function(t,n){if(!File||!FileReader)throw new Error("The File|FileReader APIs are not supported in this browser. Use instead MidiParser.Base64() or MidiParser.Uint8()");if(t===void 0||!(t instanceof HTMLElement)||t.tagName!=="INPUT"||t.type.toLowerCase()!=="file")return console.warn("MidiParser.addListener() : Provided element is not a valid FILE INPUT element"),!1;n=n||function(){},t.addEventListener("change",function(s){if(!s.target.files.length)return!1;console.log("MidiParser.addListener() : File detected in INPUT ELEMENT processing data..");let h=new FileReader;h.readAsArrayBuffer(s.target.files[0]),h.onload=function(o){n(a.Uint8(new Uint8Array(o.target.result)))}})},Base64:function(t){let n=function(o){var b="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";if(o=o.replace(/^.*?base64,/,""),o=String(o).replace(/[\t\n\f\r ]+/g,""),!/^(?:[A-Za-z\d+\/]{4})*?(?:[A-Za-z\d+\/]{2}(?:==)?|[A-Za-z\d+\/]{3}=?)?$/.test(o))throw new TypeError("Failed to execute _atob() : The string to be decoded is not correctly encoded.");o+="==".slice(2-(3&o.length));let u,f="",i,c,l=0;for(;l<o.length;)u=b.indexOf(o.charAt(l++))<<18|b.indexOf(o.charAt(l++))<<12|(i=b.indexOf(o.charAt(l++)))<<6|(c=b.indexOf(o.charAt(l++))),f+=i===64?String.fromCharCode(u>>16&255):c===64?String.fromCharCode(u>>16&255,u>>8&255):String.fromCharCode(u>>16&255,u>>8&255,255&u);return f}(t=String(t));var s=n.length;let h=new Uint8Array(new ArrayBuffer(s));for(let o=0;o<s;o++)h[o]=n.charCodeAt(o);return a.Uint8(h)},Uint8:function(h){let n={data:null,pointer:0,movePointer:function(i){return this.pointer+=i,this.pointer},readInt:function(i){if((i=Math.min(i,this.data.byteLength-this.pointer))<1)return-1;let c=0;if(1<i)for(let l=1;l<=i-1;l++)c+=this.data.getUint8(this.pointer)*Math.pow(256,i-l),this.pointer++;return c+=this.data.getUint8(this.pointer),this.pointer++,c},readStr:function(i){let c=new Uint8Array(i),l=!1,d;c.forEach((g,p)=>{c[p]=this.readInt(1)});for(let g=0;g<r.length;g++)if(!l)try{if(d=r[g].decode(c),g==0)for(let p=0;p<d.length;p++){let m=d.charCodeAt(p);if(m>191||m>127&&m<160)throw new RangeError(`Invalid code point: ${m}`)}l=!0,console.debug(`String byte sequence in ${r[g].encoding}`)}catch(p){console.debug(`SMF string ${p}`)}return d||"String byte sequence read failed."},backOne:function(){this.pointer--},readIntVLV:function(){let i=0;if(this.pointer>=this.data.byteLength)return-1;if(this.data.getUint8(this.pointer)<128)i=this.readInt(1);else{let l=[];for(;128<=this.data.getUint8(this.pointer);)l.push(this.readInt(1)-128);var c=this.readInt(1);for(let d=1;d<=l.length;d++)i+=l[l.length-d]*Math.pow(128,d);i+=c}return i}};if(n.data=new DataView(h.buffer,h.byteOffset,h.byteLength),n.readInt(4)!==1297377380)return console.warn("Header validation failed (not MIDI standard or file corrupt.)"),!1;n.readInt(4);let s={};s.formatType=n.readInt(2),s.tracks=n.readInt(2),s.track=[];var h=n.readInt(1),o=n.readInt(1);128<=h?(s.timeDivision=[],s.timeDivision[0]=h-128,s.timeDivision[1]=o):s.timeDivision=256*h+o;for(let i=1;i<=s.tracks;i++){s.track[i-1]={event:[]};var b,u=n.readInt(4);if(u===-1)break;if(u!==1297379947)return!1;n.readInt(4);let c=0,l=!1,d,g;for(;!l&&(c++,s.track[i-1].event[c-1]={},s.track[i-1].event[c-1].deltaTime=n.readIntVLV(),(d=n.readInt(1))!==-1);)if(128<=d?g=d:(d=g,n.movePointer(-1)),d===255){s.track[i-1].event[c-1].type=255,s.track[i-1].event[c-1].metaType=n.readInt(1);var f=n.readIntVLV();switch(s.track[i-1].event[c-1].metaType){case 47:case-1:l=!0;break;case 1:case 2:case 3:case 4:case 5:case 7:case 6:s.track[i-1].event[c-1].data=n.readStr(f);break;case 33:case 89:case 81:s.track[i-1].event[c-1].data=n.readInt(f);break;case 84:s.track[i-1].event[c-1].data=[],s.track[i-1].event[c-1].data[0]=n.readInt(1),s.track[i-1].event[c-1].data[1]=n.readInt(1),s.track[i-1].event[c-1].data[2]=n.readInt(1),s.track[i-1].event[c-1].data[3]=n.readInt(1),s.track[i-1].event[c-1].data[4]=n.readInt(1);break;case 88:s.track[i-1].event[c-1].data=[],s.track[i-1].event[c-1].data[0]=n.readInt(1),s.track[i-1].event[c-1].data[1]=n.readInt(1),s.track[i-1].event[c-1].data[2]=n.readInt(1),s.track[i-1].event[c-1].data[3]=n.readInt(1);break;default:this.customInterpreter!==null&&(s.track[i-1].event[c-1].data=this.customInterpreter(s.track[i-1].event[c-1].metaType,n,f)),this.customInterpreter!==null&&s.track[i-1].event[c-1].data!==!1||(n.readInt(f),s.track[i-1].event[c-1].data=n.readInt(f),this.debug&&console.info("Unimplemented 0xFF meta event! data block readed as Integer"))}}else switch((d=d.toString(16).split(""))[1]||d.unshift("0"),s.track[i-1].event[c-1].type=parseInt(d[0],16),s.track[i-1].event[c-1].channel=parseInt(d[1],16),s.track[i-1].event[c-1].type){case 15:this.customInterpreter!==null&&(s.track[i-1].event[c-1].data=this.customInterpreter(s.track[i-1].event[c-1].type,n,!1)),this.customInterpreter!==null&&s.track[i-1].event[c-1].data!==!1||(b=n.readIntVLV(),s.track[i-1].event[c-1].data=n.readInt(b),this.debug&&console.info("Unimplemented 0xF exclusive events! data block readed as Integer"));break;case 10:case 11:case 14:case 8:case 9:s.track[i-1].event[c-1].data=[],s.track[i-1].event[c-1].data[0]=n.readInt(1),s.track[i-1].event[c-1].data[1]=n.readInt(1);break;case 12:case 13:s.track[i-1].event[c-1].data=n.readInt(1);break;case-1:l=!0;break;default:if(this.customInterpreter!==null&&(s.track[i-1].event[c-1].data=this.customInterpreter(s.track[i-1].event[c-1].metaType,n,!1)),this.customInterpreter===null||s.track[i-1].event[c-1].data===!1)return console.log("Unknown EVENT detected... reading cancelled!"),!1}}return s},customInterpreter:null};if(typeof I<"u")I.exports=a;else{let t=typeof window=="object"&&window.self===window&&window||typeof self=="object"&&self.self===self&&self||typeof global=="object"&&global.global===global&&global;t.MidiParser=a}})()});var P=class{#e={};addEventListener(e,r){this.#e[e]||(this.#e[e]=[]),this.#e[e].unshift(r)}removeEventListener(e,r){if(this.#e[e]){let a=this.#e[e].indexOf(r);a>-1&&this.#e[e].splice(a,1),this.#e[e].length<1&&delete this.#e[e]}}dispatchEvent(e,r){let a=new Event(e),t=this;a.data=r,this.#e[e]?.length>0&&this.#e[e].forEach(function(n){try{n?.call(t,a)}catch(s){console.error(s)}}),this[`on${e}`]&&this[`on${e}`](a)}};var G=class{#e={};context;set(e,r){this.#e[e]=r}has(e){return!!this.#e[e]}async read(e,r){if(!this.has(e))throw new Error(`No decoder registered for "${e}"`);return await this.#e[e].call(this.context||this,r)}};var ae=function(e,r){let a=!0;return r.forEach((t,n)=>{a=a&&e[n]==t}),a},T=function(e){let r=0;return e.forEach(a=>{r*=256,r+=a}),r},$=new TextDecoder,R=new G;R.set("s7e",async function(e){let r=new Uint8Array(await e.slice(0,65536).arrayBuffer()),a="MSB	LSB	PRG	NME",t=[0,0,0,0],n=32,s=0,h=0,o=!0,b=[],u=0;for(;o;){let f=r.subarray(s);([()=>{$.decode(f.subarray(0,4))=="YSFC"?(s+=80,h=1):s++},()=>{if(ae(f.subarray(0,4),t))b.forEach((i,c,l)=>{let d=T(r.subarray(i.start+4,i.start+8));i.length=d}),h=2;else{let i=$.decode(f.subarray(0,4)),c=T(f.subarray(4,8));b.push({type:i,start:c}),s+=8}},()=>{let i=b[u],c=r.subarray(i.start,i.start+i.length),l=32;switch(i.type){case"ENVC":{let d=n;for(;d<c.length;){let g=c.subarray(d,d+l),p=$.decode(g.subarray(0,10)).trimEnd();p.slice(0,5)=="Init "&&(p=""),p&&(a+=`
063	${(g[17]+13).toString().padStart(3,"0")}	${g[19].toString().padStart(3,"0")}	${p}`),d+=l}break}case"EDVC":{let d=n;for(;d<c.length;){let g=c.subarray(d,d+l),p=$.decode(g.subarray(0,10)).trimEnd();p.slice(0,5)=="Init "&&(p=""),p&&(a+=`
063	024	${g[19].toString().padStart(3,"0")}	${p}`),d+=l}break}case"EPVC":{let d=32,g=n;for(;g<c.length;){let p=c.subarray(g,g+d),m=$.decode(p.subarray(0,10)).trimEnd();m=="----------"&&(m=""),m&&(a+=`
063	${(p[17]+1).toString().padStart(3,"0")}	${p[19].toString().padStart(3,"0")}	${m}`),g+=d}break}}u++,u>=b.length&&(h=3,o=!1)}][h]||(()=>{o=!1}))()}return a});R.set("pcg",async function(e){let r=new Uint8Array(await e.arrayBuffer()),a="MSB	LSB	PRG	NME",t=100,n=0,s=0,h=!0,o=[],b=0;for(;h;){let u=r.subarray(t);([()=>{h=$.decode(u.subarray(0,4))=="INI2",s=u[15],t+=16,n=1},()=>{let f=$.decode(u.subarray(0,4)),i=u[5],c=u[7],l=u[11],d=T(u.subarray(12,16)),g=T(u.subarray(16,20)),p=T(u.subarray(36,40)),m=$.decode(u.subarray(44,44+l));o.push({type:f,tipMsb:i,tipLsb:c,nameLen:l,length:d,start:g,entryLen:p,name:m}),t+=64,s--,s<1&&(n=2)},()=>{let f=o[b],i=r.subarray(f.start,f.start+f.length);switch(f.type){case"PRG1":break;case"PBK1":{let c=63,l=(f.tipMsb?6:0)+f.tipLsb;for(let d=0;d<128;d++){let g=d*f.entryLen,p=i.subarray(g,g+f.entryLen),m=$.decode(p.subarray(0,24)).trimEnd().replace("InitProg","");m.length&&l>5&&(a+=`
${c.toString().padStart(3,"0")}	${l.toString().padStart(3,"0")}	${d.toString().padStart(3,"0")}	${m}`)}break}case"CBK1":{let c=63,l=(f.tipMsb?3:0)+f.tipLsb+10;for(let d=0;d<128;d++){let g=d*f.entryLen,p=i.subarray(g,g+f.entryLen),m=$.decode(p.subarray(0,24)).trimEnd().replace("InitCombi","");m.length&&l>12&&(a+=`
${c.toString().padStart(3,"0")}	${l.toString().padStart(3,"0")}	${d.toString().padStart(3,"0")}	${m}`)}break}}b++,b>=o.length&&(n=3,h=!1)}][n]||(()=>{h=!1}))()}return a});var se=["off","hall","room","stage","plate","delay LCR","delay LR","echo","cross delay","early reflections","gate reverb","reverse gate"].concat(new Array(4),["white room","tunnel","canyon","basement","karaoke"],new Array(43),["pass through","chorus","celeste","flanger","symphonic","rotary speaker","tremelo","auto pan","phaser","distortion","overdrive","amplifier","3-band EQ","2-band EQ","auto wah"],new Array(1),["pitch change","harmonic","touch wah","compressor","noise gate","voice channel","2-way rotary speaker","ensemble detune","ambience"],new Array(4),["talking mod","Lo-Fi","dist + delay","comp + dist + delay","wah + dist + delay","V dist","dual rotor speaker"]);var ie=",a,i,u,e,o,ka,ki,ku,ke,ko,ky,kw,sa,si,su,se,so,sh,ta,ti,tu,te,to,t,ch,t,s,na,ni,nu,ne,no,ny,nn,ha,hi,hu,he,ho,hy,fa,fi,fu,fe,fo,ma,mi,mu,me,mo,my,mm,ya,yu,ye,yo,ra,ri,ru,re,ro,ry,wa,wi,we,wo,ga,gi,gu,ge,go,gy,gw,za,zi,zu,ze,zo,ja,ji,ju,je,jo,jy,da,di,du,de,do,dy,ba,bi,bu,be,bo,by,va,vi,vu,ve,vo,pa,pi,pu,pe,po,py,nga,ngi,ngu,nge,ngo,ngy,ng,hha,hhi,hhu,hhe,hho,hhy,hhw,*,_,,,~,.".split(","),ne={};`hi*,
ka,ã‹
ki,ã
ku,ã
ke,ã‘
ko,ã“
ky,ã!
kw,ãl
tsu,ã¤
ts,ã¤l
sa,ã•
si,ã™ãƒ
su,ã™
se,ã›
so,ã
shi,ã—
sh,ã—!
ta,ãŸ
ti,ã¦ãƒ
tu,ã¨ã…
te,ã¦
to,ã¨
tchy,ã¡!
tchi,ã¡
na,ãª
ni,ã«
nu,ã¬
ne,ã­
no,ã®
ny,ã«!
nn,ã‚“
ha,ã¯
hi,ã²
hu,ã»ã…
he,ã¸
ho,ã»
hy,ã²!
fa,ãµã
fi,ãµãƒ
fu,ãµ
fe,ãµã‡
fo,ãµã‰
ma,ã¾
mi,ã¿
mu,ã‚€
me,ã‚
mo,ã‚‚
my,ã¿!
mm,ã‡º
ra,ã‚‰
ri,ã‚Š
ru,ã‚‹
re,ã‚Œ
ro,ã‚
ry,ã‚Š!
wa,ã‚
wi,ã‚
we,ã‚‘
wo,ã‚’
nga,ã‹ã‚š
ngi,ãã‚š
ngu,ãã‚š
nge,ã‘ã‚š
ngo,ã“ã‚š
ngy,ãã‚š!
ng,ãƒ³
ga,ãŒ
gi,ãŽ
gu,ã
ge,ã’
go,ã”
gy,ãŽ!
gw,ãl
za,ã–
zi,ãšãƒ
zu,ãš
ze,ãœ
zo,ãž
ja,ã˜ã‚ƒ
ji,ã˜
ju,ã˜ã‚…
je,ã˜ã‡
jo,ã˜ã‚‡
jy,ã˜!
da,ã 
di,ã§ãƒ
du,ã©ã…
de,ã§
do,ã©
dy,ã§!
ba,ã°
bi,ã³
bu,ã¶
be,ã¹
bo,ã¼
by,ã³!
va,ã‚”ã
vi,ã‚”ãƒ
vu,ã‚”
ve,ã‚”ã‡
vo,ã‚”ã‰
pa,ã±
pi,ã´
pu,ã·
pe,ãƒš
po,ã½
py,ã´!
!ya,ã‚ƒ
!yu,ã‚…
!ye,ã‡
!yo,ã‚‡
ya,ã‚„
yu,ã‚†
ye,ð›€
yo,ã‚ˆ
!a,ã‚ƒ
!u,ã‚…
!e,ã‡
!o,ã‚‡
!a,ã‚ƒ
!u,ã‚…
!e,ã‡
!o,ã‚‡
la,ã
li,ãƒ
lu,ã…
le,ã‡
lo,ã‰
a,ã‚
i,ã„
u,ã†
e,ãˆ
o,ãŠ
*,ã£
~,
^,
_,`.split(`
`).forEach(e=>{let r=e.split(",");ne[r[0]]=r[1]});var X=function(e,r,a){let t=[],n=a==!1?r.readIntVLV():a;e==0||e==127;for(let s=0;s<n;s++){let h=r.readInt(1);if(t.push(h),h!=247){if(h!=240){if(h>127)return console.debug(`Early termination: ${t}`),t.pop(),r.backOne(),r.backOne(),new Uint8Array(t)}}}return new Uint8Array(t)};var ce=["?","gm","gs","sc","xg","g2","mt32","doc","qy10","qy20","ns5r","x5d","05rw","k11","sg","sd","pa","krs","s90es","motif","trin"];var oe=["melodic","drum","menu"];var le=[36,37,48,49,52,53],A=[20,21,22,23,24,25,26,28,29,30,31,36,37,48,49,52,53,64,65];var O=[0,1,2,4,5,6,7,8,10,11,32,38,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,84,91,92,93,94,95,98,99,100,101,128,12,13,16,17,18,19,14,15,20,21,26,28,22,80,81,82,83,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157];var de={};ce.forEach((e,r)=>{de[e]=r});var S={length:O.length};O.forEach((e,r)=>{S[e]=r});var F={length:A.length};A.forEach((e,r)=>{F[e]=r});var he={};oe.forEach((e,r)=>{he[e]=r});var D=8,v={port:D,ch:D<<4,chShift:Math.ceil(Math.log2(D))+4,cc:O.length,nn:128,pl:512,tr:256,cmt:14,rpn:6,rpnt:4,nrpn:le.length,ace:8,drm:8,dpn:A.length,dnc:128,ext:3,efx:7,cvn:12,redir:32,vxPrim:3,invalidCh:255};v.chcc=v.cc*v.ch;var w={bank0:128},fe=new Uint16Array(v.ch),ue=new Uint16Array(v.ch),pe=new Uint16Array(v.ch),ge=new Uint16Array(v.ch),be=new Uint16Array(v.ch),V=new Array(v.drm);for(let e=0;e<v.ch;e++)fe[e]=e*v.cc,ue[e]=e*v.rpn,pe[e]=e*v.nrpn,ge[e]=e*v.ace,be[e]=e*v.ext;for(let e=0;e<v.drm;e++){V[e]=new Uint16Array(v.dpn);let r=e*v.dpn*v.dnc;for(let a=0;a<v.dpn;a++)V[e][a]=r+a*v.dnc}var U=re(K(),1);var z=class{#e=!1;constructor(e,r,a,t){this.#e=e,this.start=r,this.end=a,this.data=t}get duration(){return this.ranged?this.end-this.start:0}get ranged(){return this.#e}},L=class extends z{constructor(e,r,a){super(!0,e,r,a)}},q=class extends z{constructor(e,r){super(!1,e,e,r)}},B=class extends Array{#e=-1;constructor(){super(...arguments)}resetIndex(e){this.#e=-1}fresh(){this.sort(function(e,r){return e.start==r.start?0:(+(e.start>r.start)<<1)-1}),this.forEach(function(e,r){e.index=r})}step(e,r=!1){let a=[];if(r)for(let t=0;t<this.length&&!(this[t].start>e);t++){if(this[t].end<e)continue;a.push(this[t])}else{let t=this.getRange(this.#e==-1?0:e-1,e),n=this;t.forEach(function(s){s.index>n.#e&&(a.push(s),n.#e=s.index)})}return a}getRange(e,r){e>r&&([e,r]=[r,e]);let a=[],t=-1,n=Math.ceil(Math.sqrt(this.length)),s=!0;for(let h=0;h<this.length;h+=n)this[h+n]?t<0&&this[h+n].start>=e&&(t=h):t=t<0?h:t;for(;s;)this[t]?.end<r?this[t].start>=e&&a.push(this[t]):s=!1,t++;return a}};var me=0xffffffffffff,Q=function(e){let r=new B,a=this,t=e.timeDivision,n=120,s=new B,h=0,o=0;s.push(new L(0,me,[120,0])),e.track.forEach(function(i){h=0,i.event.forEach(function(c){h+=c.deltaTime,c.type==255&&c?.metaType==81&&(n=6e7/c.data,s[s.length-1]&&s.push(new L(h,0xffffffffffff,[n,0])))})}),s.fresh(),s.forEach(function(i,c,l){c>0&&(l[c-1].end=i.start)});let b=120;s.forEach(function(i,c,l){c>0&&(i.end==i.start?l.splice(l.indexOf(i),1):b==i.data[0]&&(l[c-1].end=i.end,l.splice(l.indexOf(i),1)),b=i.data[0])});let u=0,f=120;return s.forEach(function(i){let c=i.start,l=c/f/t*60+u;f=i.data[0],u=l-c/f/t*60,i.data[1]=u}),console.debug("All tempo changes: ",s),n=120,h=0,o=0,e.track.forEach(function(i,c){h=0,o=0;let l=c+1;i.event.forEach(function(d,g){h+=d.deltaTime;let p=s.step(h,!0)[0];p&&(n=p.data[0],o=p.data[1]);let m={type:d.type,data:d.data,track:l,part:0};d.type>14?m.meta=d.metaType:m.part=d.channel,r.push(new q(h/n/t*60+o,m))})}),r.fresh(),self.midiEvents=r,console.debug(`Parsed a type ${e.formatType} MIDI sequence.`),r};U.default.customInterpreter=X;var E=function(e,r,a){e.addEventListener(a,t=>{r.dispatchEvent(a,t.data)})},kt=class extends P{device;#e;#s={};#f=[];#a="";#o=[];#u=[];#l=new Uint8ClampedArray(128);#p=new Uint8ClampedArray(128);#i=.5;#n=120;#t=4;#d=4;#r=0;#h=0;#g=new Array(v.ch);#c=new Uint8Array(v.ch);smoothingAtk=0;smoothingDcy=0;reset(){let e=this;e.dispatchEvent("reset"),e.#e?.resetIndex(),e.device.init(),e.#a="",e.#i=.5,e.#n=120,e.#t=4,e.#d=4,e.#r=0,e.#h=0,e.dispatchEvent("tempo",e.#n),e.dispatchEvent("title",e.#a)}init(){this.reset(),this.#e=void 0}async loadFile(e){this.#e=Q(U.default.parse(new Uint8Array(await e.arrayBuffer())))}async loadMap(e,r,a){let t=this,n=0,s=0,h=0,o=0,b,u;e.split(`
`).forEach((f,i)=>{if(!f)return;let c=f.split("	");if(i){if(!o)return;let l="",d="";c.forEach((p,m)=>{switch(m){case b:{l=p;break}case u:{d=p;break}}});let g=!1;t.#s[l]?.priority>a&&(g=!0,h++),!t.#s[l]||g||r?(t.#s[l]={name:d,priority:a},n++):self.debugMode&&console.debug(`Voice "${d}" (${l}) seems to be in conflict with (${t.#s[l]}).`),s++}else c.forEach((l,d)=>{switch(l){case"ID":{b=d,o++;break}case"Name":{u=d,o++;break}default:console.debug(`Unknown map field: ${l}`)}})}),console.debug(`Voice names: ${s} total, ${n} loaded (${n-h} + ${h}).`),t?.device.forceVoiceRefresh()}async loadMapPaths(e){let r=this;e.forEach(async(a,t)=>{r.loadMap(await(await fetch(a)).text(),0,t)})}async loadEfx(e,r){let a=this,t=0,n=0,s,h,o;e.split(`
`).forEach((b,u)=>{if(b)if(u){let f=0,i;b.split("	").forEach((c,l)=>{switch(l){case s:{f|=parseInt(c,16)<<8;break}case h:{f|=parseInt(c,16);break}case o:{i=c;break}}}),!a.#f[f]||r?(a.#f[f]=i,t++):self.debugMode&&console.debug(`EFX ID 0x${f.toString(16).padStart(4,"0")} (${i}) seems to be in conflict.`),n++}else b.split("	").forEach((f,i)=>{switch(f){case"MSB":{s=i;break}case"LSB":{h=i;break}case"Name":{o=i;break}default:console.debug(`Unknown EFX field: ${f}`)}})}),console.debug(`EFX: ${n} total, ${t} loaded.`),a.dispatchEvent("efxreverb",a.device.getEffectType(0)),a.dispatchEvent("efxchorus",a.device.getEffectType(1)),a.dispatchEvent("efxdelay",a.device.getEffectType(2)),a.dispatchEvent("efxinsert0",a.device.getEffectType(3)),a.dispatchEvent("efxinsert1",a.device.getEffectType(4)),a.dispatchEvent("efxinsert2",a.device.getEffectType(5)),a.dispatchEvent("efxinsert3",a.device.getEffectType(6))}switchMode(e,r=!1){this.device.switchMode(e,r)}getMode(){return this.device.getMode()}getVoice(){return this.device.getVoice(...arguments)}getChVoice(e){return this.device.getChVoice(e)}getChPrimitive(e,r,a){return this.device.getChPrimitive(e,r,a)}getChPrimitives(e,r){return this.device.getChPrimitives(e,r)}getMapped(e){return this.#s[e]?.name||e}getEfx([e,r]){let a=e<<8|r;return this.#f[a]||`0x${a.toString(16).padStart(4,"0")}`}getVoxBm(e){if(!e)throw new Error("Voice object must be valid");let r=this;if(!r.voxBm)throw new Error("Voice bitmap repository isn't yet initialized");let a=r.voxBm.getBm(e.name);if(!a)switch(e.mode){case"xg":{switch(e.sid[0]){case 0:case 80:case 81:case 83:case 84:case 96:case 97:case 99:case 100:{a=r.voxBm.getBm(r.getVoice(w.bank0,e.sid[1],w.bank0,e.mode).name);break}}break}case"g2":case"sd":{switch(e.sid[0]){case 96:case 97:case 98:case 99:{a=r.voxBm.getBm(r.getVoice(w.bank0,e.sid[1],w.bank0,e.mode).name);break}case 104:case 105:case 106:case 107:{a=r.voxBm.getBm(r.getVoice(120,e.sid[1],w.bank0,e.mode).name);break}}break}case"gs":case"sc":case"k11":case"sg":case"gm":{switch(e.sid[0]){case 120:break;case 122:case 127:{a=r.voxBm.getBm(r.getVoice(120,e.sid[1],0,e.mode).name);break}default:a=r.voxBm.getBm(r.getVoice(0,e.sid[1],0,e.mode).name)}break}default:switch(e.sid[0]){case 56:{a=r.voxBm.getBm(r.getVoice(0,e.sid[1],0,e.mode).name);break}}}return a||(a=r.voxBm.getBm(r.getVoice(e.sid[0],e.sid[1],0,e.mode).name)),a}getChBm(e,r){let a=this;r=r||a.getChVoice(e);let t=a.getVoxBm(r);if(!t){if(!a.sysBm)return;switch(r.mode){case"xg":{switch(r.sid[0]){case 126:{r.sid[1]>>1==56&&(t=a.sysBm.getBm("cat_smpl"));break}case 16:{t=a.sysBm.getBm("cat_smpl");break}case 64:case 67:{t=a.sysBm.getBm("cat_sfx");break}case 32:case 33:case 34:case 35:case 36:case 48:case 82:{t=a.sysBm.getBm("cat_xg");break}}break}default:switch(r.sid[0]){case 63:case 32:case 33:case 34:case 35:case 36:case 48:case 82:{t=a.sysBm.getBm("cat_mex");break}}}}return t||(a.device.getChType()[e]?t=a.sysBm.getBm("cat_drm"):t=a.sysBm.getBm("no_vox")),t}get noteProgress(){return this.#h/this.#i}get noteOverall(){return this.noteProgress-this.#r}get noteBar(){return Math.floor(this.noteOverall/this.#t)}get noteBeat(){let e=this.noteOverall%this.#t;return e<0&&(e+=this.#t),e}get noteOffset(){return this.#r}getTimeSig(){return[this.#t,this.#d]}getTempo(){return this.#n}eachVoice(e){this.#g.forEach(e)}sendCmd(e){this.device.runJson(e)}render(e){e>this.#h&&(this.#h=e);let r=this.#e?.step(e)||[],a=0,t=0,n=new Set,s={},h=[],o=this,b=[];for(o.device.getStrength().forEach((C,y)=>{o.#p[y]=C}),o.device.newStrength(),r.forEach(function(C){let y=C.data,k=o.device.runJson(y);switch(k?.reply){case"meta":{b.push(k);break}}k?.reply&&delete k.reply});o.#u.length>0;){let C=o.#u.shift(),y=C.part<<7|C.note;C.state?(n.add(y),s[y]=C.velo):n.has(y)&&(h.push({part:C.part,note:C.note,velo:s[y],state:o.device.NOTE_SUSTAIN}),a++,t+=o.#c[C.part])}b?.length>0&&o.dispatchEvent("meta",b);let u=o.device.getActive(),f=[],i=o.device.getPitch(),c=o.device.getCcAll(),l=o.device.getProgram(),d=o.device.getChType(),g=[],p=o.device.getStrength();p.forEach(function(C,y,k){k[y]=Math.max(o.#p[y],C);let x=k[y]-o.#l[y],H=S.length*y;if(x>=0){let M=4*.25**(c[H+S[73]]/64);o.#l[y]+=Math.ceil(x-x*o.smoothingAtk**M)}else{let M=4*.25**(c[H+S[72]]/64);o.#l[y]+=Math.floor(x-x*o.smoothingDcy**M)}});let m=0,N=0;return u.forEach(function(C,y){C&&(f[y]=o.device.getVel(y),g[y]=o.device.getExt(y),m+=f[y].size,N+=f[y].size*o.#c[y])}),{extraPoly:a,extraPolyEC:t,extraNotes:h,curPoly:m,curPolyEC:N,chInUse:u,chKeyPr:f,chPitch:i,chProgr:l,chContr:c,chType:d,chExt:g,eventCount:r.length,title:o.#a,bitmap:o.device.getBitmap(),letter:o.device.getLetter(),texts:o.device.getTexts(),master:o.device.getMaster(),mode:o.device.getMode(),strength:o.#l.slice(),velo:p,rpn:o.device.getRpn(),tSig:o.getTimeSig(),tempo:o.getTempo(),noteBar:o.noteBar,noteBeat:o.noteBeat,ace:o.device.getAce(),rawVelo:o.device.getStrength(),rawStrength:o.device.getRawStrength(),rawPitch:o.device.getRawPitch(),efxSink:o.device.getEffectSink()}}constructor(e,r=.5,a=.5){super();let t=this;t.smoothingAtk=r,t.smoothingDcy=a,t.device=e,t.addEventListener("meta",function(n){n?.data?.forEach(function(s){(t.#o[s.meta]||console.debug).call(t,s.meta,s.data)})}),E(t.device,t,"mode"),E(t.device,t,"mastervolume"),E(t.device,t,"channelactive"),E(t.device,t,"channelmin"),E(t.device,t,"channelmax"),E(t.device,t,"portrange"),E(t.device,t,"portstart"),E(t.device,t,"channelreset"),E(t.device,t,"channeltoggle"),E(t.device,t,"screen"),E(t.device,t,"metacommit"),E(t.device,t,"voice"),E(t.device,t,"pitch"),E(t.device,t,"note"),E(t.device,t,"reset"),E(t.device,t,"banklevel"),E(t.device,t,"efxreverb"),E(t.device,t,"efxchorus"),E(t.device,t,"efxdelay"),E(t.device,t,"efxinsert0"),E(t.device,t,"efxinsert1"),E(t.device,t,"efxinsert2"),E(t.device,t,"efxinsert3"),E(t.device,t,"partefxtoggle"),E(t.device,t,"chmode"),t.addEventListener("note",function({data:n}){t.#u.push(n)}),t.addEventListener("voice",({data:n})=>{let s=t.getChVoice(n.part);t.#g[n.part]=s,t.#c[n.part]=s.poly??1}),t.addEventListener("reset",({data:n})=>{t.#c.fill(1)}),t.#c.fill(1),t.#o[3]=function(n,s){t.#a?.length<1&&(t.#a=s,t.dispatchEvent("title",t.#a))},t.#o[81]=function(n,s){let h=t.noteProgress,o=t.#i||.5;t.#n=6e7/s,t.#i=s/1e6,t.#r+=h*(o/t.#i)-h,t.dispatchEvent("tempo",t.#n)},t.#o[88]=function(n,s){let h=t.noteProgress,o=t.noteOverall,b=t.noteBar,u=t.noteBeat,f=t.#t,i=t.#d;t.#t=s[0],t.#d=1<<s[1];let c=24*(32/s[3])/s[2];if(f!=t.#t){let l=b;t.#r-=l*(t.#t-f),u+1>=f&&(f<t.#t?t.#r-=Math.ceil(t.#t-u-1):t.#r+=t.#t)}t.dispatchEvent("tsig",t.getTimeSig())}}};export{kt as RootDisplay,v as allocated,S as ccToPos,F as dnToPos};
