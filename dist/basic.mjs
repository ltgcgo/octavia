var de=Object.create;var B=Object.defineProperty;var fe=Object.getOwnPropertyDescriptor;var he=Object.getOwnPropertyNames;var ue=Object.getPrototypeOf,pe=Object.prototype.hasOwnProperty;var be=(e,a,r)=>a in e?B(e,a,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[a]=r;var ge=(e,a)=>()=>(a||e((a={exports:{}}).exports,a),a.exports);var ye=(e,a,r,t)=>{if(a&&typeof a=="object"||typeof a=="function")for(let i of he(a))!pe.call(e,i)&&i!==r&&B(e,i,{get:()=>a[i],enumerable:!(t=fe(a,i))||t.enumerable});return e};var Q=(e,a,r)=>(r=e!=null?de(ue(e)):{},ye(a||!e||!e.__esModule?B(r,"default",{value:e,enumerable:!0}):r,e));var k=(e,a,r)=>(be(e,typeof a!="symbol"?a+"":a,r),r);var G=ge((tt,H)=>{(function(){"use strict";let e={fatal:!0},a=[new TextDecoder("iso-8859-15",e),new TextDecoder("utf-8",e),new TextDecoder("sjis",e),new TextDecoder("euc-jp",e),new TextDecoder("ascii")],r={debug:!1,parse:function(t,i){if(t instanceof Uint8Array)return r.Uint8(t);if(typeof t=="string")return r.Base64(t);if(t instanceof HTMLElement&&t.type==="file")return r.addListener(t,i);throw new Error("MidiParser.parse() : Invalid input provided")},addListener:function(t,i){if(!File||!FileReader)throw new Error("The File|FileReader APIs are not supported in this browser. Use instead MidiParser.Base64() or MidiParser.Uint8()");if(t===void 0||!(t instanceof HTMLElement)||t.tagName!=="INPUT"||t.type.toLowerCase()!=="file")return console.warn("MidiParser.addListener() : Provided element is not a valid FILE INPUT element"),!1;i=i||function(){},t.addEventListener("change",function(s){if(!s.target.files.length)return!1;console.log("MidiParser.addListener() : File detected in INPUT ELEMENT processing data..");let o=new FileReader;o.readAsArrayBuffer(s.target.files[0]),o.onload=function(n){i(r.Uint8(new Uint8Array(n.target.result)))}})},Base64:function(t){let i=function(n){var f="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";if(n=n.replace(/^.*?base64,/,""),n=String(n).replace(/[\t\n\f\r ]+/g,""),!/^(?:[A-Za-z\d+\/]{4})*?(?:[A-Za-z\d+\/]{2}(?:==)?|[A-Za-z\d+\/]{3}=?)?$/.test(n))throw new TypeError("Failed to execute _atob() : The string to be decoded is not correctly encoded.");n+="==".slice(2-(3&n.length));let p,u="",c,l,d=0;for(;d<n.length;)p=f.indexOf(n.charAt(d++))<<18|f.indexOf(n.charAt(d++))<<12|(c=f.indexOf(n.charAt(d++)))<<6|(l=f.indexOf(n.charAt(d++))),u+=c===64?String.fromCharCode(p>>16&255):l===64?String.fromCharCode(p>>16&255,p>>8&255):String.fromCharCode(p>>16&255,p>>8&255,255&p);return u}(t=String(t));var s=i.length;let o=new Uint8Array(new ArrayBuffer(s));for(let n=0;n<s;n++)o[n]=i.charCodeAt(n);return r.Uint8(o)},Uint8:function(o){let i={data:null,pointer:0,movePointer:function(c){return this.pointer+=c,this.pointer},readInt:function(c){if((c=Math.min(c,this.data.byteLength-this.pointer))<1)return-1;let l=0;if(1<c)for(let d=1;d<=c-1;d++)l+=this.data.getUint8(this.pointer)*Math.pow(256,c-d),this.pointer++;return l+=this.data.getUint8(this.pointer),this.pointer++,l},readStr:function(c){let l=new Uint8Array(c),d=!1,h;l.forEach((b,g)=>{l[g]=this.readInt(1)});for(let b=0;b<a.length;b++)if(!d)try{if(h=a[b].decode(l),b===0)for(let g=0;g<h.length;g++){let y=h.charCodeAt(g);if(y>191||y>127&&y<160)throw new RangeError(`Invalid code point: ${y}`)}d=!0,console.debug(`String byte sequence in ${a[b].encoding}`)}catch(g){console.debug(`SMF string ${g}`)}return h||"String byte sequence read failed."},backOne:function(){this.pointer--},readIntVLV:function(){let c=0;if(this.pointer>=this.data.byteLength)return-1;if(this.data.getUint8(this.pointer)<128)c=this.readInt(1);else{let d=[];for(;128<=this.data.getUint8(this.pointer);)d.push(this.readInt(1)-128);var l=this.readInt(1);for(let h=1;h<=d.length;h++)c+=d[d.length-h]*Math.pow(128,h);c+=l}return c}};if(i.data=new DataView(o.buffer,o.byteOffset,o.byteLength),i.readInt(4)!==1297377380)return console.warn("Header validation failed (not MIDI standard or file corrupt.)"),!1;i.readInt(4);let s={};s.formatType=i.readInt(2),s.tracks=i.readInt(2),s.track=[];var o=i.readInt(1),n=i.readInt(1);128<=o?(s.timeDivision=[],s.timeDivision[0]=o-128,s.timeDivision[1]=n):s.timeDivision=256*o+n;for(let c=1;c<=s.tracks;c++){s.track[c-1]={event:[]};var f,p=i.readInt(4);if(p===-1)break;if(p!==1297379947)return!1;i.readInt(4);let l=0,d=!1,h,b;for(;!d&&(l++,s.track[c-1].event[l-1]={},s.track[c-1].event[l-1].deltaTime=i.readIntVLV(),(h=i.readInt(1))!==-1);)if(128<=h?b=h:(h=b,i.movePointer(-1)),h===255){s.track[c-1].event[l-1].type=255,s.track[c-1].event[l-1].metaType=i.readInt(1);var u=i.readIntVLV();switch(s.track[c-1].event[l-1].metaType){case 47:case-1:d=!0;break;case 1:case 2:case 3:case 4:case 5:case 7:case 6:s.track[c-1].event[l-1].data=i.readStr(u);break;case 33:case 89:case 81:s.track[c-1].event[l-1].data=i.readInt(u);break;case 84:s.track[c-1].event[l-1].data=[],s.track[c-1].event[l-1].data[0]=i.readInt(1),s.track[c-1].event[l-1].data[1]=i.readInt(1),s.track[c-1].event[l-1].data[2]=i.readInt(1),s.track[c-1].event[l-1].data[3]=i.readInt(1),s.track[c-1].event[l-1].data[4]=i.readInt(1);break;case 88:s.track[c-1].event[l-1].data=[],s.track[c-1].event[l-1].data[0]=i.readInt(1),s.track[c-1].event[l-1].data[1]=i.readInt(1),s.track[c-1].event[l-1].data[2]=i.readInt(1),s.track[c-1].event[l-1].data[3]=i.readInt(1);break;default:this.customInterpreter!==null&&(s.track[c-1].event[l-1].data=this.customInterpreter(s.track[c-1].event[l-1].metaType,i,u)),this.customInterpreter!==null&&s.track[c-1].event[l-1].data!==!1||(i.readInt(u),s.track[c-1].event[l-1].data=i.readInt(u),this.debug&&console.info("Unimplemented 0xFF meta event! data block readed as Integer"))}}else switch((h=h.toString(16).split(""))[1]||h.unshift("0"),s.track[c-1].event[l-1].type=parseInt(h[0],16),s.track[c-1].event[l-1].channel=parseInt(h[1],16),s.track[c-1].event[l-1].type){case 15:this.customInterpreter!==null&&(s.track[c-1].event[l-1].data=this.customInterpreter(s.track[c-1].event[l-1].type,i,!1)),this.customInterpreter!==null&&s.track[c-1].event[l-1].data!==!1||(f=i.readIntVLV(),s.track[c-1].event[l-1].data=i.readInt(f),this.debug&&console.info("Unimplemented 0xF exclusive events! data block readed as Integer"));break;case 10:case 11:case 14:case 8:case 9:s.track[c-1].event[l-1].data=[],s.track[c-1].event[l-1].data[0]=i.readInt(1),s.track[c-1].event[l-1].data[1]=i.readInt(1);break;case 12:case 13:s.track[c-1].event[l-1].data=i.readInt(1);break;case-1:d=!0;break;default:if(this.customInterpreter!==null&&(s.track[c-1].event[l-1].data=this.customInterpreter(s.track[c-1].event[l-1].metaType,i,!1)),this.customInterpreter===null||s.track[c-1].event[l-1].data===!1)return console.log("Unknown EVENT detected... reading cancelled!"),!1}}return s},customInterpreter:null};if(typeof H<"u")H.exports=r;else{let t=typeof window=="object"&&window.self===window&&window||typeof self=="object"&&self.self===self&&self||typeof global=="object"&&global.global===global&&global;t.MidiParser=r}})()});var N=class{#e={};addEventListener(e,a){this.#e[e]||(this.#e[e]=[]),this.#e[e].unshift(a)}removeEventListener(e,a){if(this.#e[e]){let r=this.#e[e].indexOf(a);r>-1&&this.#e[e].splice(r,1),this.#e[e].length<1&&delete this.#e[e]}}dispatchEvent(e,a){let r=new Event(e),t=this;r.data=a,this.#e[e]?.length>0&&this.#e[e].forEach(function(i){try{i?.call(t,r)}catch(s){console.error(s)}}),this[`on${e}`]&&this[`on${e}`](r)}};var J=class{#e={};context;set(e,a){this.#e[e]=a}has(e){return!!this.#e[e]}async read(e,a){if(!this.has(e))throw new Error(`No decoder registered for "${e}"`);return await this.#e[e].call(this.context||this,a)}};var me=function(e,a){let r=!0;return a.forEach((t,i)=>{r=r&&e[i]===t}),r},I=function(e){let a=0;return e.forEach(r=>{a*=256,a+=r}),a},$=new TextDecoder,_=new J;_.set("s7e",async function(e){let a=new Uint8Array(await e.slice(0,65536).arrayBuffer()),r="MSB	LSB	PRG	NME",t=[0,0,0,0],i=32,s=0,o=0,n=!0,f=[],p=0;for(;n;){let u=a.subarray(s);([()=>{$.decode(u.subarray(0,4))==="YSFC"?(s+=80,o=1):s++},()=>{if(me(u.subarray(0,4),t))f.forEach((c,l,d)=>{let h=I(a.subarray(c.start+4,c.start+8));c.length=h}),o=2;else{let c=$.decode(u.subarray(0,4)),l=I(u.subarray(4,8));f.push({type:c,start:l}),s+=8}},()=>{let c=f[p],l=a.subarray(c.start,c.start+c.length),d=32;switch(c.type){case"ENVC":{let h=i;for(;h<l.length;){let b=l.subarray(h,h+d),g=$.decode(b.subarray(0,10)).trimEnd();g.slice(0,5)==="Init "&&(g=""),g&&(r+=`
063	${(b[17]+13).toString().padStart(3,"0")}	${b[19].toString().padStart(3,"0")}	${g}`),h+=d}break}case"EDVC":{let h=i;for(;h<l.length;){let b=l.subarray(h,h+d),g=$.decode(b.subarray(0,10)).trimEnd();g.slice(0,5)==="Init "&&(g=""),g&&(r+=`
063	024	${b[19].toString().padStart(3,"0")}	${g}`),h+=d}break}case"EPVC":{let h=32,b=i;for(;b<l.length;){let g=l.subarray(b,b+h),y=$.decode(g.subarray(0,10)).trimEnd();y==="----------"&&(y=""),y&&(r+=`
063	${(g[17]+1).toString().padStart(3,"0")}	${g[19].toString().padStart(3,"0")}	${y}`),b+=h}break}}p++,p>=f.length&&(o=3,n=!1)}][o]||(()=>{n=!1}))()}return r});_.set("pcg",async function(e){let a=new Uint8Array(await e.arrayBuffer()),r="MSB	LSB	PRG	NME",t=100,i=0,s=0,o=!0,n=[],f=0;for(;o;){let p=a.subarray(t);([()=>{o=$.decode(p.subarray(0,4))==="INI2",s=p[15],t+=16,i=1},()=>{let u=$.decode(p.subarray(0,4)),c=p[5],l=p[7],d=p[11],h=I(p.subarray(12,16)),b=I(p.subarray(16,20)),g=I(p.subarray(36,40)),y=$.decode(p.subarray(44,44+d));n.push({type:u,tipMsb:c,tipLsb:l,nameLen:d,length:h,start:b,entryLen:g,name:y}),t+=64,s--,s<1&&(i=2)},()=>{let u=n[f],c=a.subarray(u.start,u.start+u.length);switch(u.type){case"PRG1":break;case"PBK1":{let l=63,d=(u.tipMsb?6:0)+u.tipLsb;for(let h=0;h<128;h++){let b=h*u.entryLen,g=c.subarray(b,b+u.entryLen),y=$.decode(g.subarray(0,24)).trimEnd().replace("InitProg","");y.length&&d>5&&(r+=`
${l.toString().padStart(3,"0")}	${d.toString().padStart(3,"0")}	${h.toString().padStart(3,"0")}	${y}`)}break}case"CBK1":{let l=63,d=(u.tipMsb?3:0)+u.tipLsb+10;for(let h=0;h<128;h++){let b=h*u.entryLen,g=c.subarray(b,b+u.entryLen),y=$.decode(g.subarray(0,24)).trimEnd().replace("InitCombi","");y.length&&d>12&&(r+=`
${l.toString().padStart(3,"0")}	${d.toString().padStart(3,"0")}	${h.toString().padStart(3,"0")}	${y}`)}break}}f++,f>=n.length&&(i=3,o=!1)}][i]||(()=>{o=!1}))()}return r});var Ee=["off","hall","room","stage","plate","delay LCR","delay LR","echo","cross delay","early reflections","gate reverb","reverse gate"].concat(new Array(4),["white room","tunnel","canyon","basement","karaoke"],new Array(43),["pass through","chorus","celeste","flanger","symphonic","rotary speaker","tremelo","auto pan","phaser","distortion","overdrive","amplifier","3-band EQ","2-band EQ","auto wah"],new Array(1),["pitch change","harmonic","touch wah","compressor","noise gate","voice channel","2-way rotary speaker","ensemble detune","ambience"],new Array(4),["talking mod","Lo-Fi","dist + delay","comp + dist + delay","wah + dist + delay","V dist","dual rotor speaker"]);var Ce=",a,i,u,e,o,ka,ki,ku,ke,ko,ky,kw,sa,si,su,se,so,sh,ta,ti,tu,te,to,t,ch,t,s,na,ni,nu,ne,no,ny,nn,ha,hi,hu,he,ho,hy,fa,fi,fu,fe,fo,ma,mi,mu,me,mo,my,mm,ya,yu,ye,yo,ra,ri,ru,re,ro,ry,wa,wi,we,wo,ga,gi,gu,ge,go,gy,gw,za,zi,zu,ze,zo,ja,ji,ju,je,jo,jy,da,di,du,de,do,dy,ba,bi,bu,be,bo,by,va,vi,vu,ve,vo,pa,pi,pu,pe,po,py,nga,ngi,ngu,nge,ngo,ngy,ng,hha,hhi,hhu,hhe,hho,hhy,hhw,*,_,,,~,.".split(","),ke={};`hi*,
ka,ã‹
ki,ã
ku,ã
ke,ã‘
ko,ã“
ky,ã!
kw,ãl
tsu,ã¤
ts,ã¤l
sa,ã•
si,ã™ãƒ
su,ã™
se,ã›
so,ã
shi,ã—
sh,ã—!
ta,ãŸ
ti,ã¦ãƒ
tu,ã¨ã…
te,ã¦
to,ã¨
tchy,ã¡!
tchi,ã¡
na,ãª
ni,ã«
nu,ã¬
ne,ã­
no,ã®
ny,ã«!
nn,ã‚“
ha,ã¯
hi,ã²
hu,ã»ã…
he,ã¸
ho,ã»
hy,ã²!
fa,ãµã
fi,ãµãƒ
fu,ãµ
fe,ãµã‡
fo,ãµã‰
ma,ã¾
mi,ã¿
mu,ã‚€
me,ã‚
mo,ã‚‚
my,ã¿!
mm,ã‡º
ra,ã‚‰
ri,ã‚Š
ru,ã‚‹
re,ã‚Œ
ro,ã‚
ry,ã‚Š!
wa,ã‚
wi,ã‚
we,ã‚‘
wo,ã‚’
nga,ã‹ã‚š
ngi,ãã‚š
ngu,ãã‚š
nge,ã‘ã‚š
ngo,ã“ã‚š
ngy,ãã‚š!
ng,ãƒ³
ga,ãŒ
gi,ãŽ
gu,ã
ge,ã’
go,ã”
gy,ãŽ!
gw,ãl
za,ã–
zi,ãšãƒ
zu,ãš
ze,ãœ
zo,ãž
ja,ã˜ã‚ƒ
ji,ã˜
ju,ã˜ã‚…
je,ã˜ã‡
jo,ã˜ã‚‡
jy,ã˜!
da,ã 
di,ã§ãƒ
du,ã©ã…
de,ã§
do,ã©
dy,ã§!
ba,ã°
bi,ã³
bu,ã¶
be,ã¹
bo,ã¼
by,ã³!
va,ã‚”ã
vi,ã‚”ãƒ
vu,ã‚”
ve,ã‚”ã‡
vo,ã‚”ã‰
pa,ã±
pi,ã´
pu,ã·
pe,ãƒš
po,ã½
py,ã´!
!ya,ã‚ƒ
!yu,ã‚…
!ye,ã‡
!yo,ã‚‡
ya,ã‚„
yu,ã‚†
ye,ð›€
yo,ã‚ˆ
!a,ã‚ƒ
!u,ã‚…
!e,ã‡
!o,ã‚‡
!a,ã‚ƒ
!u,ã‚…
!e,ã‡
!o,ã‚‡
la,ã
li,ãƒ
lu,ã…
le,ã‡
lo,ã‰
a,ã‚
i,ã„
u,ã†
e,ãˆ
o,ãŠ
*,ã£
~,
^,
_,`.split(`
`).forEach(e=>{let a=e.split(",");ke[a[0]]=a[1]});var Z=(e,a)=>{let r=Math.min(e.length,a.length),t=0;for(let i=0;i<r;i++)if(t=e[i]-a[i],t!==0)return[i,t];return e.length!==a.length?[r,e.length-a.length]:[0,0]};var j=function(e,a,r){let t=[],i=r==!1?a.readIntVLV():r;e==0||e==127;for(let s=0;s<i;s++){let o=a.readInt(1);if(t.push(o),o!=247){if(o!=240){if(o>127)return console.debug(`Early termination: ${t}`),t.pop(),a.backOne(),a.backOne(),new Uint8Array(t)}}}return new Uint8Array(t)};var je="â™­ð„«,ð„«,â™­,,â™¯,ð„ª,ð„ªâ™¯".split(",");var Ht=Q(G(),1),we=["?","gm","gs","sc","xg","g2","mt32","doc","qy10","qy20","ns5r","x5d","05rw","k11","sg","sd","pa","krs","s90es","motif","cs6x","trin","an1x","cs1x"];var ve=["melodic","drum","menu"];var $e=[36,37,48,49,52,53],V=[20,21,22,23,24,25,26,28,29,30,31,36,37,48,49,52,53,64,65];var te=[0,1,2,4,5,6,7,8,10,11,12,13,14,15,16,17,18,19,20,21,22,26,28,32,38,40,41,42,43,44,45,46,47,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,80,81,82,83,84,91,92,93,94,95,98,99,100,101,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157];var K="reverb,chorus,delay,insert0,insert1,insert2,insert3,insert4".split(",");var Se={};we.forEach((e,a)=>{Se[e]=a});var ae=[];te.forEach((e,a)=>{ae[e]=a});var re={length:V.length};V.forEach((e,a)=>{re[e]=a});var xe={};ve.forEach((e,a)=>{xe[e]=a});var X=8,m={port:X,ch:X<<4,chShift:Math.ceil(Math.log2(X))+4,cc:te.length,nn:128,pl:512,tr:256,cmt:14,rpn:6,rpnt:4,nrpn:$e.length,ace:8,drm:8,dpn:V.length,dnc:128,ext:3,efx:8,cvn:12,redir:32,vxPrim:3,invalidCh:255};m.chcc=m.cc*m.ch;var P={bank0:255},Xt=new TextDecoder("l9"),Te=new Uint16Array(m.ch),Me=new Uint16Array(m.ch),Pe=new Uint16Array(m.ch),Re=new Uint16Array(m.ch),Ae=new Uint16Array(m.ch),Ie=new Uint16Array(m.ch),ee=new Array(m.drm);for(let e=0;e<m.ch;e++)Te[e]=e*m.cc,Me[e]=e*m.rpn,Pe[e]=e*m.nrpn,Re[e]=e*m.ace,Ae[e]=e*m.ext,Ie[e]=e*m.cvn;for(let e=0;e<m.drm;e++){ee[e]=new Uint16Array(m.dpn);let a=e*m.dpn*m.dnc;for(let r=0;r<m.dpn;r++)ee[e][r]=a+r*m.dnc}var q=Q(G(),1);var ie=class{#e=!1;constructor(e,a,r,t){this.#e=e,this.start=a,this.end=r,this.data=t}get duration(){return this.ranged?this.end-this.start:0}get ranged(){return this.#e}},F=class extends ie{constructor(e,a,r){super(!0,e,a,r)}},se=class extends ie{constructor(e,a){super(!1,e,e,a)}},Y=class extends Array{#e=-1;constructor(){super(...arguments)}resetIndex(e){this.#e=-1}fresh(){this.sort(function(e,a){return e.start==a.start?0:(+(e.start>a.start)<<1)-1}),this.forEach(function(e,a){e.index=a})}step(e,a=!1){let r=[];if(a)for(let t=0;t<this.length&&!(this[t].start>e);t++){if(this[t].end<e)continue;r.push(this[t])}else{let t=this.getRange(this.#e==-1?0:e-1,e),i=this;t.forEach(function(s){s.index>i.#e&&(r.push(s),i.#e=s.index)})}return r}getRange(e,a){e>a&&([e,a]=[a,e]);let r=[],t=-1,i=Math.ceil(Math.sqrt(this.length)),s=!0;for(let o=0;o<this.length;o+=i)this[o+i]?t<0&&this[o+i].start>=e&&(t=o):t=t<0?o:t;for(;s;)this[t]?.end<a?this[t].start>=e&&r.push(this[t]):s=!1,t++;return r}};var De=0xffffffffffff,ne=function(e){let a=new Y,r=this,t=e.timeDivision,i=120,s=new Y,o=0,n=0;s.push(new F(0,De,[120,0])),e.track.forEach(function(c){o=0,c.event.forEach(function(l){o+=l.deltaTime,l.type===255&&l?.metaType===81&&(i=6e7/l.data,s[s.length-1]&&s.push(new F(o,0xffffffffffff,[i,0])))})}),s.fresh(),s.forEach(function(c,l,d){l>0&&(d[l-1].end=c.start)});let f=120;s.forEach(function(c,l,d){l>0&&(c.end===c.start?d.splice(d.indexOf(c),1):f===c.data[0]&&(d[l-1].end=c.end,d.splice(d.indexOf(c),1)),f=c.data[0])});let p=0,u=120;return s.forEach(function(c){let l=c.start,d=l/u/t*60+p;u=c.data[0],p=d-l/u/t*60,c.data[1]=p}),console.debug("All tempo changes: ",s),i=120,o=0,n=0,e.track.forEach(function(c,l){o=0,n=0;let d=l+1;c.event.forEach(function(h,b){o+=h.deltaTime;let g=s.step(o,!0)[0];g&&(i=g.data[0],n=g.data[1]);let y={type:h.type,data:h.data,track:d,part:0};h.type>14?y.meta=h.metaType:y.part=h.channel,a.push(new se(o/i/t*60+n,y))})}),a.fresh(),self.midiEvents=a,console.debug(`Parsed a type ${e.formatType} MIDI sequence.`),a};var Oe={866:"cp866","utf-8":"utf-8",utf8:"utf-8","utf-16":"utf-16",utf16:"utf-16","utf-16le":"utf-16",utf16le:"utf-16",unicode:"utf-16",unicodefeff:"utf-16","ucs-2":"utf-16","utf-16be":"utf-16be",utf16be:"utf-16be","utf-24":"utf-24",utf24:"utf-24","utf-24le":"utf-24",utf24le:"utf-24","utf-24be":"utf-24be",utf24be:"utf-24be","utf-32":"utf-32",utf32:"utf-32","utf-32le":"utf-32",utf32le:"utf-32","utf-32be":"utf-32be",utf32be:"utf-32be",latin1:"latin1",l1:"latin1",ascii:"latin1","us-ascii":"latin1","iso-8859-1":"latin1","iso8859-1":"latin1",cp1252:"latin1","windows-1252":"latin1",cp819:"latin1",ibm819:"latin1",latin2:"latin2",l2:"latin2","iso-8859-2":"latin2","iso8859-2":"latin2",latin3:"latin3",l3:"latin3","iso-8859-3":"latin3","iso8859-3":"latin3",latin4:"latin4",l4:"latin4","iso-8859-4":"latin4","iso8859-4":"latin4",latin5:"latin5",l5:"latin5","iso-8859-9":"latin5","iso8859-9":"latin5",cp1254:"latin5","windows-1254":"latin5",latin6:"latin6",l6:"latin6","iso-8859-10":"latin6","iso8859-10":"latin6",latin9:"latin9",l9:"latin9","iso-8859-15":"latin9","iso8859-15":"latin9","iso-8859-5":"iso-8859-5","iso8859-5":"iso-8859-5",cyrillic:"iso-8859-5","iso-8859-6":"iso-8859-6","iso8859-6":"iso-8859-6","iso-8859-6-e":"iso-8859-6","iso8859-6e":"iso-8859-6","iso-8859-6-i":"iso-8859-6","iso8859-6i":"iso-8859-6","asmo-708":"iso-8859-6","ecma-114":"iso-8859-6",arabic:"iso-8859-6","iso-8859-7":"iso-8859-7","iso8859-7":"iso-8859-7","ecma-118":"iso-8859-7",greek:"iso-8859-7",greek8:"iso-8859-7","iso-8859-8":"iso-8859-8","iso8859-8":"iso-8859-8","iso-8859-8-e":"iso-8859-8","iso8859-8e":"iso-8859-8",hebrew:"iso-8859-8",visual:"iso-8859-8","iso-8859-8-i":"iso-8859-8-i","iso8859-8i":"iso-8859-8-i",logical:"iso-8859-8-i","iso-8859-11":"iso-8859-11","iso8859-11":"iso-8859-11","windows-874":"iso-8859-11","dos-874":"iso-8859-11",cp874:"iso-8859-11","tis-620":"iso-8859-11","iso-8859-13":"iso-8859-13","iso8859-13":"iso-8859-13",latin7:"iso-8859-13",l7:"iso-8859-13","iso-8859-14":"iso-8859-14","iso8859-14":"iso-8859-14",latin8:"iso-8859-14",l8:"iso-8859-14","iso-8859-16":"iso-8859-16","iso8859-16":"iso-8859-16",cp866:"cp866",ibm866:"cp866",cp1250:"cp1250","windows-1250":"cp1250",cp1251:"cp1251","windows-1251":"cp1251",cp1253:"cp1253","windows-1253":"cp1253",cp1255:"cp1255","windows-1255":"cp1255",cp1256:"cp1256","windows-1256":"cp1256",cp1257:"cp1257","windows-1257":"cp1257",cp1258:"cp1258","windows-1258":"cp1258","euc-jp":"euc-jp",cp954:"euc-jp","euc-kr":"euc-kr",koi8:"koi8",koi:"koi8","koi8-r":"koi8","koi8-u":"koi8-u","koi8-ru":"koi8-u",mac:"mac",macintosh:"mac","mac-cyrillic":"x-mac-cyrillic","x-mac-cyrillic":"x-mac-cyrillic","x-mac-ukrainian":"x-mac-cyrillic",gbk:"gbk",gb2312:"gbk",chinese:"gbk","euc-cn":"gbk",gb18030:"gb18030",big5:"big5","big5-hkscs":"big5",sjis:"sjis","shift-jis":"sjis",ms932:"sjis","windows-31j":"sjis"},Le={"utf-8":1,"utf-16":2,"utf-16be":3,"utf-24":4,"utf-24be":5,"utf-32":6,"utf-32be":7,latin1:0,latin2:0,latin3:0,latin4:0,latin5:0,latin6:0,latin9:0,"iso-8859-5":0,"iso-8859-6":0,"iso-8859-7":0,"iso-8859-8":0,"iso-8859-8-i":0,"iso-8859-11":0,"iso-8859-13":0,"iso-8859-14":0,"iso-8859-16":0,cp866:0,cp1250:0,cp1251:0,cp1253:0,cp1255:0,cp1256:0,cp1257:0,cp1258:0,"euc-jp":1,"euc-kr":1,koi8:0,"koi8-u":0,mac:0,"x-mac-cyrillic":0,gbk:1,gb18030:1,big5:1,sjis:1},S,x=(S=class{static getUnitSize(e){if(e>7)throw new RangeError("Cannot decode encodings with more than 4 bits per unit.");return(e>>1)+1}static isBigEndian(e){return(e&1)===1}static collapse(e){let a=Oe[e];if(typeof a!="string")throw new TypeError(`Provided label "${e}" is not supported.`);return a}static indicator(e){let a=Le[e];if(typeof a!="number")throw new TypeError(`Provided collapsed label "${e}" is not supported.`);return a}},k(S,"BYTE_1",0),k(S,"BYTE_1_VL",1),k(S,"BYTE_2_LE",2),k(S,"BYTE_2_BE",3),k(S,"BYTE_3_LE",4),k(S,"BYTE_3_BE",5),k(S,"BYTE_4_LE",6),k(S,"BYTE_4_BE",7),S),v=(e,a)=>{e.unsent=!1,e.enqueue(a)},O=(e,a,r=1,t=!0)=>{if(typeof r!="number"||r<=0||r>4)throw new RangeError(`Invalid byte size ${r}.`);if(!(e instanceof Uint8Array||e instanceof Uint8ClampedArray))throw new TypeError("Input buffer is not Uint8Array.");if(typeof a!="number"||a<0||a>=e.length)throw new RangeError(`Provided offset ${a} is out of buffer range.`);if(r===1)return e[a];{let i=0;if(t)for(let s=0;s<r;s++)i<<=8,i|=e[a+s];else for(let s=0;s<r;s++)i|=e[a+s]<<(s<<3);return i<0?i+4294967296:i}},Ue=class{static lineRaw(e,a=0){if(typeof a!="number"||a<0||a>7)throw new TypeError("Invalid split mode.");if(!e||e?.constructor!==ReadableStream)throw new TypeError("Not a readable stream.");let r=x.getUnitSize(a),t=x.isBigEndian(a),i=e.getReader(),s,o=!1,n=[],f=0,p=0,u=0;return new ReadableStream({pull:async c=>{for(c.unsent=!0;c.unsent;){if(!s||f>=s.length){f>p&&(n.push(s.subarray(p)),p=0);let l=await i.read();s=l.value,o=l.done,f=0}if(s){let l=0;if(r===1)l=s[f];else if(t)for(let h=0;h<r;h++)l<<=8,l|=s[f+h];else for(let h=0;h<r;h++)l|=s[f+h]<<(h<<3);let d=!1;switch(l){case 10:{u===13?p+=r:d=!0;break}case 13:{d=!0;break}}if(d){if(n.length){n.push(s.subarray(p,f));let h=0;for(let y=0;y<n.length;y++)h+=n[y].length;let b=new Uint8Array(h),g=0;for(let y=0;y<n.length;y++)b.set(n[y],g),g+=n[y].length;v(c,b),n=[]}else v(c,s.subarray(p,f));p=f+=r}u=l}if(o){if(p!==f&&s&&n.push(s.subarray(p,f)),n.length){let l=0;for(let b=0;b<n.length;b++)l+=n[b].length;let d=new Uint8Array(l),h=0;for(let b=0;b<n.length;b++)d.set(n[b],h),h+=n[b].length;v(c,d)}c.unsent=!1,c.close()}f+=r}}},new ByteLengthQueuingStrategy({highWaterMark:256}))}static chunkRaw(e,a="utf-8"){if(!e||e?.constructor!==ReadableStream)throw new TypeError("Not a readable stream.");let r=x.indicator(a),t=x.getUnitSize(r),i=x.isBigEndian(r),s=e.getReader(),o;return new ReadableStream({pull:async n=>{n.unsent=!0;let{value:f,done:p}=await s.read();if(f){let u=0,c=f.length;if(r!==0&&typeof o?.length=="number"){let l=!1;switch(a){case"big5":case"gbk":case"sjis":case"euc-kr":{u=1;let d=new Uint8Array(2);d[0]=o[0],d[1]=f[0],v(n,d);break}case"euc-jp":{let d=3;o[0]===143?u=3-o.length:o[0]>127?(u=1,d=2):d=o.length;let h=new Uint8Array(3);h.set(o),h.set(f.subarray(0,u),o.length),v(n,h.subarray(0,d));break}case"gb18030":{let d=new Uint8Array(4),h=4;d.set(o),d.set(f.subarray(0,4-o.length),o.length),d[0]<128?h=o.length:d[1]>=64?(u=1,h=2):u=4-o.length,v(n,d.subarray(0,h));break}case"utf-8":{let d=4;o[0]>=240?u=4-o.length:o[0]>=224?(u=3-o.length,d=3):o[0]>=192?(u=1,d=2):d=o.length;let h=new Uint8Array(4);h.set(o),h.set(f.subarray(0,u),o.length),v(n,h.subarray(0,d));break}case"utf-16":case"utf-16be":{let d=new Uint8Array(4);d.set(o),d.set(f.subarray(0,4-o.length)),u=4-o.length,O(transientSize,0,2,i)>=55296&&O(transientSize,2,2,i)>=55296?v(n,d):(v(n,d.subarray(0,2)),v(n,d.subarray(2)));break}default:{let d=new Uint8Array(t);d.set(o),d.set(f.subarray(0,t-o.length),o.length),v(n,d)}}}if(o=void 0,r===0)v(n,f.subarray(u));else{switch(a){case"utf-24":case"utf-24be":{c=Math.floor((f.length-u)/t)*t+u;break}case"utf-32":case"utf-32be":{c=(f.length-u>>2<<2)+u;break}case"utf-8":{if(f[f.length-1]>127){let l=!0,d=f.length,h=f.length-8;for(;l&&d>h;)d--,f[d]<128?c=d+1:f[d]>192&&(c=d)}break}case"utf-16":case"utf-16be":{if(c=(f.length-u>>1<<1)+u,O(f,c-2,2,i)>=55296){let l=!0,d=c,h=c-6;for(;l&&d>h;)d-=2,O(f,d,2,i)>>10===54&&(c=d)}break}default:throw new TypeError("Maybe someday the rest of the decoders will be implemented")}v(n,f.subarray(u,c))}c<f.length&&(o=f.subarray(c))}p&&(typeof o?.length=="number"&&v(n,o),n.unsent=!1,n.close())}},new ByteLengthQueuingStrategy({highWaterMark:256}))}static line(e,a="utf-8",r){let t=x.collapse(a),i=x.indicator(t),s=this.lineRaw(e,i).getReader(),o=new TextDecoder(t,onlostpointercapture);return new ReadableStream({pull:async n=>{let{value:f,done:p}=await s.read();f&&n.enqueue(o.decode(f)),p&&n.close()}})}static chunk(e,a="utf-8",r){let t=x.collapse(a);if(self.TextDecoderStream){let i=new TextDecoderStream(t,r);return e.pipeTo(i.writable),i.readable}else{let i=this.chunkRaw(e,t).getReader(),s=new TextDecoder(t);return new ReadableStream({pull:async o=>{let{value:n,done:f}=await i.read();n&&(console.debug(n),o.enqueue(s.decode(n))),f&&o.close()}})}}},ce=Ue;var z={0:"\0",a:"\x07",b:"\b",e:"\x1B",f:"\f",n:`
`,r:"\r",t:"	",v:"\v","\\":"\\","'":"'",'"':'"'},W=new Uint8Array(128);W.fill(1,48,58);W.fill(1,65,71);W.fill(1,97,103);var R=new Uint8Array(256);R.fill(1,0,32);R.fill(1,128,160);R[127]=1;var Be={};for(let e in z){let a=z[e];Be[a]=`\\${e}`,R[a.charCodeAt(0)]=2}R[34]=3;R[39]=3;var oe=e=>{let a="",r=!1;for(let t=0;t<e.length;t++){let i=e[t];if(r){let s=0;switch(i){case"x":{s=2;break}case"u":{s=4;break}case"U":{s=8;break}default:{let o=z[i];if(typeof o=="string")a+=o;else throw new Error(`Invalid escape identifier "${i}" at index ${t}`);r=!1;continue}}if(s>0){let o=t+1,n=e.substring(o,o+s);if(n.length<s)throw new RangeError(`Insufficient code point buffer "${n}" at index ${o}`);let f=parseInt(n,16);if(Number.isNaN(f))throw new RangeError(`Malformed code point representation "${n}" at index ${o}`);if(f>=1114112)throw new RangeError(`Code point "${n}" exceeds 0x10ffff at index ${o}`);a+=String.fromCodePoint(f),r=!1,t+=s}}else i==="\\"?r=!0:a+=i}return a},Ne=(e,a=0)=>{};self.TextEscape=Ne;var T,L=(T=class{static parse(e,a){let r=e&this.MASK_TYPE,t=e&this.MASK_DATA,i=0,s=0,o,n=0,f,p=a.getReader();return new ReadableStream({pull:async u=>{let{value:c,done:l}=await p.read();if(typeof c=="string"){switch(r){case this.TYPE_TSV:{o=[];try{for(let d of c.split("	"))switch(t){case this.DATA_TEXT:{o.push(oe(d));break}case this.DATA_JSON:{o.push(i===0?oe(d):JSON.parse(d));break}default:throw new TypeError(`Unknown DSV value type ${r}`)}}catch(d){console.debug(`The following error appeared when parsing on line ${i+1}.`),console.error(d)}break}case this.TYPE_CSV:{if(t!==this.DATA_TEXT)throw new TypeError(`Invalid type ${r} for CSV, only plain text is allowed`);break}default:throw new TypeError(`Unknown DSV type ${r}`)}u.enqueue(o),i++}l&&u.close()}})}static parseObjects(e,a){let r=0,t=this.parse(e,a).getReader(),i;return new ReadableStream({start:async s=>{let{value:o,done:n}=await t.read();typeof o?.length=="number"&&(i=o),n&&s.close()},pull:async s=>{let{value:o,done:n}=await t.read();if(typeof o?.length=="number"){let f={};for(let p=0;p<o.length;p++)o[p]&&(f[i[p]]=o[p]);s.enqueue(f)}n&&s.close()}})}},k(T,"MASK_TYPE",3),k(T,"MASK_DATA",12),k(T,"TYPE_TSV",0),k(T,"TYPE_CSV",1),k(T,"DATA_TEXT",0),k(T,"DATA_JSON",4),T);q.default.customInterpreter=j;var E=(e,a,r)=>{e.addEventListener(r,t=>{a.dispatchEvent(r,t.data)})},le=e=>{let a=e.split("/");return a[a.length-1]||a[a.length-2]||"(remote)"},da=class extends N{device;#e;#c={};#b=[];#n=new Map;#a="";#h=[];#g=[];#u=new Uint8ClampedArray(128);#y=new Uint8ClampedArray(128);#o=.5;#l=120;#r=4;#t=4;#i=0;#p=0;#s=new Array(m.ch);#d=new Uint8Array(m.ch);#f=0;smoothAttack=0;smoothDecay=0;reset(){let e=this;e.dispatchEvent("reset"),e.#e?.resetIndex(),e.device.init(),e.#a="",e.#o=.5,e.#l=120,e.#r=4,e.#t=4,e.#i=0,e.#p=0,e.dispatchEvent("tempo",e.#l),e.dispatchEvent("title",e.#a),e.dispatchEvent("tsig",e.getTimeSig())}init(){this.reset(),this.#e=void 0}async loadFile(e){this.#e=ne(q.default.parse(new Uint8Array(await e.arrayBuffer())))}async loadMap(e,a,r,t="(internal)"){let i=this,s=0,o=0,n=0,f=0,p,u;e.split(`
`).forEach((c,l)=>{if(!c)return;let d=c.split("	");if(l){if(!f)return;let h="",b="";d.forEach((y,D)=>{switch(D){case p:{h=y;break}case u:{b=y;break}}});let g=!1;i.#c[h]?.priority>r&&(g=!0,n++),!i.#c[h]||g||a?(i.#c[h]={name:b,priority:r},s++):self.debugMode&&console.debug(`Voice "${b}" (${h}) seems to be in conflict with (${i.#c[h]}).`),o++}else d.forEach((h,b)=>{switch(h){case"ID":{p=b,f++;break}case"Name":{u=b,f++;break}default:console.debug(`Unknown map field: ${h}`)}})}),console.debug(`Voice names: From "${t}", ${o} total, ${s} loaded (${s-n} + ${n}).`),i?.device.forceVoiceRefresh()}async loadMapPaths(e){let a=this;e.forEach(async(r,t)=>{a.loadMap(await(await fetch(r)).text(),0,t,le(r))})}async loadEfx(e,a){let r=this,t=0,i=0,s,o,n;e.split(`
`).forEach((f,p)=>{if(f)if(p){let u=0,c;f.split("	").forEach((l,d)=>{switch(d){case s:{u|=(parseInt(l,16)&255)<<8;break}case o:{u|=parseInt(l,16)&255;break}case n:{c=l;break}}}),!r.#b[u]||a?(r.#b[u]=c,t++):self.debugMode&&console.debug(`EFX ID 0x${u.toString(16).padStart(4,"0")} (${c}) seems to be in conflict.`),i++}else f.split("	").forEach((u,c)=>{switch(u){case"MSB":{s=c;break}case"LSB":{o=c;break}case"Name":{n=c;break}default:console.debug(`Unknown EFX field: ${u}`)}})}),console.debug(`EFX: ${i} total, ${t} loaded.`);for(let f=0;f<K.length;f++){let p=!1,u=r.device.getEffectType(f);u[0]===0&&u[1]>>4===15&&(p=!0),r.dispatchEvent(`efx${K[f]}`,{id:u,hidden:p})}}async loadModels(e,a){let r=this,t=0,i=0}async loadStyles(e,a){let r=this,t=0,i=0}async loadProps(e,a,r=0,t="(internal)"){let i=this,s=0,o=0,n=0;for await(let f of L.parseObjects(L.DATA_TEXT|L.TYPE_TSV,ce.line(e)))if(typeof f?.voiceId=="string")if(o++,!(i.#n.has(f.voiceId)||i.#n.get(f.voiceId)?.priority<=r)||a){if(Object.keys(f).length<2)continue;i.#n.get(f.voiceId)?.priority>r&&n++,f.priority=r,i.handleProp&&await i.handleProp(f),i.#n.set(f.voiceId,f),s++}else console.debug(`Tried to write a pre-existing entry "${f.voiceId}" on entry ${o}.`);console.debug(`Voice properties: From "${t}", ${o} total, ${s} loaded (${s-n} + ${n}).`)}async loadPropsPaths(e){let a=this;e.forEach(async(r,t)=>{let i=r.split("/");a.loadProps((await fetch(r)).body,0,t,le(r))})}switchMode(e,a=!1){this.device.switchMode(e,a)}getMode(){return this.device.getMode()}getVoice(){return this.device.getVoice(...arguments)}getChVoice(e){return this.device.getChVoice(e)}refreshCachedChVoice(e,a){let r=this,t=a??r.device.getChVoice(e),i=r.#s[e],s=!0;if(r.#f++,!a)switch(r.device.getChMode(e)){case"xg":{r.device.getChType(e)>0&&t.ending==="!"&&(s=!1,i.refreshFailure=!0,console.debug("Cached voice persisted due to invalid drum kit."));break}case"gs":case"sc":{t.ending!==" "&&(t.sid[2]===1?(t.name="Silence",t.refreshFailure=!0,console.debug("Cached voice nullified due to invalid SC-55 voice.")):(s=!1,i.refreshFailure=!0,console.debug("Cached voice persisted due to invalid GS voice.")));break}}return s?(r.#s[e]=t,r.#d[e]=t.poly??1,r.#f>1?console.debug(`Bubbling prevented at instance #${r.#f}.`):r.dispatchEvent("cachedvoice",{part:e}),r.#f--,t):(r.#f--,i)}getCachedChVoice(e){let a=this,r=a.#s[e],t=a.device?.getChPrimitives(e,!0);if(r&&a.device?.getChCvnIsWritten(e)===0)switch(r.ending){case"?":case"!":return a.refreshCachedChVoice(e,void 0);default:return Z(r.sid,t)[1]!==0?a.refreshCachedChVoice(e):r}else return a.refreshCachedChVoice(e)}getChPrimitive(e,a,r){return this.device.getChPrimitive(e,a,r)}getChPrimitives(e,a){return this.device.getChPrimitives(e,a)}getMapped(e){return this.#c[e]?.name||e}getEfx(e){let[a,r]=e,t=a<<8|r;return this.#b[t]||`0x${t.toString(16).padStart(4,"0")}`}getVoxBm(e){if(!e)throw new Error("Voice object must be valid");let a=this;if(!a.voxBm)throw new Error("Voice bitmap repository isn't yet initialized");let r=a.voxBm.getBm(e.name);if(!r)switch(e.mode){case"xg":{switch(e.sid[0]){case 0:case 80:case 81:case 83:case 84:case 96:case 97:case 99:case 100:{r=a.voxBm.getBm(a.getVoice(P.bank0,e.sid[1],P.bank0,e.mode).name);break}}break}case"g2":case"sd":{switch(e.sid[0]){case 96:case 97:case 98:case 99:{r=a.voxBm.getBm(a.getVoice(P.bank0,e.sid[1],P.bank0,e.mode).name);break}case 104:case 105:case 106:case 107:{r=a.voxBm.getBm(a.getVoice(120,e.sid[1],P.bank0,e.mode).name);break}}break}case"gs":case"sc":case"k11":case"sg":case"gm":{switch(e.sid[0]){case 120:break;case 122:case 127:{r=a.voxBm.getBm(a.getVoice(120,e.sid[1],0,e.mode).name);break}default:r=a.voxBm.getBm(a.getVoice(0,e.sid[1],0,e.mode).name)}break}default:switch(e.sid[0]){case 56:{r=a.voxBm.getBm(a.getVoice(0,e.sid[1],0,e.mode).name);break}}}return r||(r=a.voxBm.getBm(a.getVoice(e.sid[0],e.sid[1],0,e.mode).name)),r}getChBm(e,a){let r=this;a=a??r.getChVoice(e);let t=r.getVoxBm(a);if(!t){if(!r.sysBm)return;switch(a.mode){case"xg":{switch(a.sid[0]){case 126:{a.sid[1]>>1===56&&(t=r.sysBm.getBm("cat_smpl"));break}case 16:{t=r.sysBm.getBm("cat_smpl");break}case 64:case 67:{t=r.sysBm.getBm("cat_sfx");break}case 32:case 33:case 34:case 35:case 36:case 48:case 82:{t=r.sysBm.getBm("cat_xg");break}}break}default:switch(a.sid[0]){case 63:case 32:case 33:case 34:case 35:case 36:case 48:case 82:{t=r.sysBm.getBm("cat_mex");break}}}}return t||(r.device.getChType(e)?t=r.sysBm.getBm("cat_drm"):t=r.sysBm.getBm("no_vox")),t}getProps(e){let a=this,r,t,i=0,s=e;for(;i<8&&r==null&&(!t?.constructor||t instanceof Array&&(t[1]!==e.eid[1]||t[2]!==e.eid[2]));)t=e.eid,typeof e.voice=="string"&&(a.#n.has(e.voice)?r=a.#n.get(e.voice):e=a.getVoice(t[0],t[2]===0?0:t[1],t[2]===0?0:t[2]-1));return!r&&i===8&&console.info(`Voice property fetching failed for "${e.name}" (${e.eid.join(" ")}).`),r}get noteProgress(){return this.#p/this.#o}get noteOverall(){return(this.noteProgress-this.#i)*this.#t/4}get noteBar(){return Math.floor(this.noteOverall/this.#r)}get noteBeat(){let e=this.noteOverall%this.#r;return e<0&&(e+=this.#r),e}get noteOffset(){return this.#i}getTimeSig(){return[this.#r,this.#t]}getTempo(){return this.#l}getChCachedVoice(e){return this.#s[e]}eachVoice(e,a=!1){let r=this;for(let t=0;t<r.#s.length;t++)(a||r.device?.getChActive(t))&&e(r.#s[t],t,r.#s)}sendCmd(e){this.device.runJson(e)}render(e){e>this.#p&&(this.#p=e);let a=this.#e?.step(e)||[],r=0,t=0,i=new Set,s={},o=[],n=this,f=[];for(n.device.getStrength().forEach((w,C)=>{n.#y[C]=w}),n.device.newStrength(),a.forEach(function(w){let C=w.data,M=n.device.runJson(C);switch(M?.reply){case"meta":{f.push(M);break}}M?.reply&&delete M.reply});n.#g.length>0;){let w=n.#g.shift(),C=w.part<<7|w.note;w.state?(i.add(C),s[C]=w.velo):i.has(C)&&(o.push({part:w.part,note:w.note,velo:s[C],state:n.device.NOTE_SUSTAIN}),r++,t+=n.#d[w.part])}f?.length>0&&n.dispatchEvent("meta",f);let p=n.device.getActive(),u=[],c=n.device.getPitch(),l=n.device.getCcAll(),d=n.device.getProgram(),h=n.device.getChTypes(),b=[],g=n.device.getStrength();g.forEach(function(w,C,M){M[C]=Math.max(n.#y[C],w);let A=M[C]-n.#u[C];if(A>=0){let U=4*.25**(n.device.getChCc(C,73)/64);n.#u[C]+=Math.ceil(A-A*n.smoothAttack**U)}else{let U=4*.25**(n.device.getChCc(C,72)/64);n.#u[C]+=Math.floor(A-A*n.smoothDecay**U)}});let y=0,D=0;return p.forEach(function(w,C){w&&(u[C]=n.device.getVel(C),b[C]=n.device.getExt(C),y+=u[C].size,D+=u[C].size*n.#d[C])}),{extraPoly:r,extraPolyEC:t,extraNotes:o,curPoly:y,curPolyEC:D,chInUse:p,chKeyPr:u,chPitch:c,chProgr:d,chContr:l,chType:h,chExt:b,eventCount:a.length,title:n.#a,bitmap:n.device.getBitmap(),letter:n.device.getLetter(),texts:n.device.getTexts(),master:n.device.getMaster(),mode:n.device.getMode(),strength:n.#u.slice(),velo:g,rpn:n.device.getRpn(),tSig:n.getTimeSig(),tempo:n.getTempo(),noteBar:n.noteBar,noteBeat:n.noteBeat,ace:n.device.getAce(),rawVelo:n.device.getStrength(),rawStrength:n.device.getRawStrength(),rawPitch:n.device.getRawPitch(),efxSink:n.device.getEffectSink()}}constructor(e,a=.5,r=.5){super();let t=this;t.smoothAttack=a,t.smoothDecay=r,t.device=e,t.addEventListener("meta",function(i){i?.data?.forEach(function(s){(t.#h[s.meta]||console.debug).call(t,s.meta,s.data)})}),E(t.device,t,"mode"),E(t.device,t,"mastervolume"),E(t.device,t,"channelactive"),E(t.device,t,"channelmin"),E(t.device,t,"channelmax"),E(t.device,t,"portrange"),E(t.device,t,"portstart"),E(t.device,t,"channelreset"),E(t.device,t,"channeltoggle"),E(t.device,t,"screen"),E(t.device,t,"metacommit"),E(t.device,t,"voice"),E(t.device,t,"pitch"),E(t.device,t,"note"),E(t.device,t,"reset"),E(t.device,t,"banklevel"),E(t.device,t,"efxreverb"),E(t.device,t,"efxchorus"),E(t.device,t,"efxdelay"),E(t.device,t,"efxinsert0"),E(t.device,t,"efxinsert1"),E(t.device,t,"efxinsert2"),E(t.device,t,"efxinsert3"),E(t.device,t,"efxinsert4"),E(t.device,t,"partefxtoggle"),E(t.device,t,"chmode"),t.addEventListener("note",function({data:i}){t.#g.push(i)}),t.addEventListener("voice",({data:i})=>{t.refreshCachedChVoice(i.part)}),t.addEventListener("reset",({data:i})=>{t.#d.fill(1)}),t.#d.fill(1),t.#h[3]=function(i,s){t.#a?.length<1&&(t.#a=s,t.dispatchEvent("title",t.#a))},t.#h[81]=function(i,s){let o=t.noteProgress,n=t.#o||.5;t.#l=6e7/s,t.#o=s/1e6,t.#i+=o*(n/t.#o)-o,t.dispatchEvent("tempo",t.#l)},t.#h[88]=function(i,s){let o=t.noteBar,n=t.noteBeat,f=t.#r,p=t.#t;t.#r=s[0],t.#t=1<<s[1];let u=Math.round(o+n/f);f!==t.#r&&(t.#i-=u*(t.#r-f)*(4/t.#t)),p!==t.#t&&(console.debug(`${o}/${n}`),p<t.#t?t.#i+=u*(t.#t-p)*(p/t.#t):t.#i+=u*(t.#t-p)*(t.#t/p)),t.dispatchEvent("tsig",t.getTimeSig())},t.addEventListener("metacommit",({data:i})=>{switch(i.type){case"KarTitle":case"EORTitle":{t.#a?.length<1&&(t.#a=i.data,t.dispatchEvent("title",t.#a));break}}})}};export{da as RootDisplay,m as allocated,ae as ccToPos,re as dnToPos};
