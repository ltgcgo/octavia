"use strict";let he=Object.create;let H=Object.defineProperty;let ue=Object.getOwnPropertyDescriptor;let pe=Object.getOwnPropertyNames;let be=Object.getPrototypeOf,ge=Object.prototype.hasOwnProperty;let me=(e,s,a)=>s in e?H(e,s,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[s]=a;let ye=(e,s)=>()=>(s||e((s={exports:{}}).exports,s),s.exports);let Ee=(e,s,a,t)=>{if(s&&typeof s=="object"||typeof s=="function")for(let i of pe(s))!ge.call(e,i)&&i!==a&&H(e,i,{get:()=>s[i],enumerable:!(t=ue(s,i))||t.enumerable});return e};let ke=(e,s,a)=>(a=e!=null?he(be(e)):{},Ee(s||!e||!e.__esModule?H(a,"default",{value:e,enumerable:!0}):a,e));let k=(e,s,a)=>(me(e,typeof s!="symbol"?s+"":s,a),a);let ie=ye((ta,Y)=>{(function(){"use strict";let e={fatal:!0},s=[new TextDecoder("iso-8859-15",e),new TextDecoder("utf-8",e),new TextDecoder("sjis",e),new TextDecoder("euc-jp",e),new TextDecoder("ascii")],a={debug:!1,parse:function(t,i){if(t instanceof Uint8Array)return a.Uint8(t);if(typeof t=="string")return a.Base64(t);if(t instanceof HTMLElement&&t.type==="file")return a.addListener(t,i);throw new Error("MidiParser.parse() : Invalid input provided")},addListener:function(t,i){if(!File||!FileReader)throw new Error("The File|FileReader APIs are not supported in this browser. Use instead MidiParser.Base64() or MidiParser.Uint8()");if(t===void 0||!(t instanceof HTMLElement)||t.tagName!=="INPUT"||t.type.toLowerCase()!=="file")return console.warn("MidiParser.addListener() : Provided element is not a valid FILE INPUT element"),!1;i=i||function(){},t.addEventListener("change",function(r){if(!r.target.files.length)return!1;console.log("MidiParser.addListener() : File detected in INPUT ELEMENT processing data..");let n=new FileReader;n.readAsArrayBuffer(r.target.files[0]),n.onload=function(o){i(a.Uint8(new Uint8Array(o.target.result)))}})},Base64:function(t){let i=function(o){let f="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";if(o=o.replace(/^.*?base64,/,""),o=String(o).replace(/[\t\n\f\r ]+/g,""),!/^(?:[A-Za-z\d+\/]{4})*?(?:[A-Za-z\d+\/]{2}(?:==)?|[A-Za-z\d+\/]{3}=?)?$/.test(o))throw new TypeError("Failed to execute _atob() : The string to be decoded is not correctly encoded.");o+="==".slice(2-(3&o.length));let p,u="",c,l,d=0;for(;d<o.length;)p=f.indexOf(o.charAt(d++))<<18|f.indexOf(o.charAt(d++))<<12|(c=f.indexOf(o.charAt(d++)))<<6|(l=f.indexOf(o.charAt(d++))),u+=c===64?String.fromCharCode(p>>16&255):l===64?String.fromCharCode(p>>16&255,p>>8&255):String.fromCharCode(p>>16&255,p>>8&255,255&p);return u}(t=String(t));let r=i.length;let n=new Uint8Array(new ArrayBuffer(r));for(let o=0;o<r;o++)n[o]=i.charCodeAt(o);return a.Uint8(n)},Uint8:function(n){let i={data:null,pointer:0,movePointer:function(c){return this.pointer+=c,this.pointer},readInt:function(c){if((c=Math.min(c,this.data.byteLength-this.pointer))<1)return-1;let l=0;if(1<c)for(let d=1;d<=c-1;d++)l+=this.data.getUint8(this.pointer)*Math.pow(256,c-d),this.pointer++;return l+=this.data.getUint8(this.pointer),this.pointer++,l},readStr:function(c){let l=new Uint8Array(c),d=!1,h;l.forEach((b,g)=>{l[g]=this.readInt(1)});for(let b=0;b<s.length;b++)if(!d)try{if(h=s[b].decode(l),b===0)for(let g=0;g<h.length;g++){let m=h.charCodeAt(g);if(m>191||m>127&&m<160)throw new RangeError(`Invalid code point: ${m}`)}d=!0,console.debug(`String byte sequence in ${s[b].encoding}`)}catch(g){console.debug(`SMF string ${g}`)}return h||"String byte sequence read failed."},backOne:function(){this.pointer--},readIntVLV:function(){let c=0;if(this.pointer>=this.data.byteLength)return-1;if(this.data.getUint8(this.pointer)<128)c=this.readInt(1);else{let d=[];for(;128<=this.data.getUint8(this.pointer);)d.push(this.readInt(1)-128);let l=this.readInt(1);for(let h=1;h<=d.length;h++)c+=d[d.length-h]*Math.pow(128,h);c+=l}return c}};if(i.data=new DataView(n.buffer,n.byteOffset,n.byteLength),i.readInt(4)!==1297377380)return console.warn("Header validation failed (not MIDI standard or file corrupt.)"),!1;i.readInt(4);let r={};r.formatType=i.readInt(2),r.tracks=i.readInt(2),r.track=[];let n=i.readInt(1),o=i.readInt(1);128<=n?(r.timeDivision=[],r.timeDivision[0]=n-128,r.timeDivision[1]=o):r.timeDivision=256*n+o;for(let c=1;c<=r.tracks;c++){r.track[c-1]={event:[]};let f,p=i.readInt(4);if(p===-1)break;if(p!==1297379947)return!1;i.readInt(4);let l=0,d=!1,h,b;for(;!d&&(l++,r.track[c-1].event[l-1]={},r.track[c-1].event[l-1].deltaTime=i.readIntVLV(),(h=i.readInt(1))!==-1);)if(128<=h?b=h:(h=b,i.movePointer(-1)),h===255){r.track[c-1].event[l-1].type=255,r.track[c-1].event[l-1].metaType=i.readInt(1);let u=i.readIntVLV();switch(r.track[c-1].event[l-1].metaType){case 47:case-1:d=!0;break;case 1:case 2:case 3:case 4:case 5:case 7:case 6:r.track[c-1].event[l-1].data=i.readStr(u);break;case 33:case 89:case 81:r.track[c-1].event[l-1].data=i.readInt(u);break;case 84:r.track[c-1].event[l-1].data=[],r.track[c-1].event[l-1].data[0]=i.readInt(1),r.track[c-1].event[l-1].data[1]=i.readInt(1),r.track[c-1].event[l-1].data[2]=i.readInt(1),r.track[c-1].event[l-1].data[3]=i.readInt(1),r.track[c-1].event[l-1].data[4]=i.readInt(1);break;case 88:r.track[c-1].event[l-1].data=[],r.track[c-1].event[l-1].data[0]=i.readInt(1),r.track[c-1].event[l-1].data[1]=i.readInt(1),r.track[c-1].event[l-1].data[2]=i.readInt(1),r.track[c-1].event[l-1].data[3]=i.readInt(1);break;default:this.customInterpreter!==null&&(r.track[c-1].event[l-1].data=this.customInterpreter(r.track[c-1].event[l-1].metaType,i,u)),this.customInterpreter!==null&&r.track[c-1].event[l-1].data!==!1||(i.readInt(u),r.track[c-1].event[l-1].data=i.readInt(u),this.debug&&console.info("Unimplemented 0xFF meta event! data block readed as Integer"))}}else switch((h=h.toString(16).split(""))[1]||h.unshift("0"),r.track[c-1].event[l-1].type=parseInt(h[0],16),r.track[c-1].event[l-1].channel=parseInt(h[1],16),r.track[c-1].event[l-1].type){case 15:this.customInterpreter!==null&&(r.track[c-1].event[l-1].data=this.customInterpreter(r.track[c-1].event[l-1].type,i,!1)),this.customInterpreter!==null&&r.track[c-1].event[l-1].data!==!1||(f=i.readIntVLV(),r.track[c-1].event[l-1].data=i.readInt(f),this.debug&&console.info("Unimplemented 0xF exclusive events! data block readed as Integer"));break;case 10:case 11:case 14:case 8:case 9:r.track[c-1].event[l-1].data=[],r.track[c-1].event[l-1].data[0]=i.readInt(1),r.track[c-1].event[l-1].data[1]=i.readInt(1);break;case 12:case 13:r.track[c-1].event[l-1].data=i.readInt(1);break;case-1:d=!0;break;default:if(this.customInterpreter!==null&&(r.track[c-1].event[l-1].data=this.customInterpreter(r.track[c-1].event[l-1].metaType,i,!1)),this.customInterpreter===null||r.track[c-1].event[l-1].data===!1)return console.log("Unknown EVENT detected... reading cancelled!"),!1}}return r},customInterpreter:null};if(typeof Y<"u")Y.exports=a;else{let t=typeof window=="object"&&window.self===window&&window||typeof self=="object"&&self.self===self&&self||typeof global=="object"&&global.global===global&&global;t.MidiParser=a}})()});let G=class{#e={};addEventListener(e,s){this.#e[e]||(this.#e[e]=[]),this.#e[e].unshift(s)}removeEventListener(e,s){if(this.#e[e]){let a=this.#e[e].indexOf(s);a>-1&&this.#e[e].splice(a,1),this.#e[e].length<1&&delete this.#e[e]}}dispatchEvent(e,s){let a=new Event(e),t=this;a.data=s,this.#e[e]?.length>0&&this.#e[e].forEach(function(i){try{i?.call(t,a)}catch(r){console.error(r)}}),this[`on${e}`]&&this[`on${e}`](a)}};let I={g2:new Set("gm,GM,g2,G2".split(",")),xg:new Set};for(let e of"XG,MU,AN,AP,DR,DX,PC,PF,SG,VL".split(","))I.xg.add(e),I.xg.add(e.toLowerCase());let Z=class{#e={};context;set(e,s){this.#e[e]=s}has(e){return!!this.#e[e]}async read(e,s){if(!this.has(e))throw new Error(`No decoder registered for "${e}"`);return await this.#e[e].call(this.context||this,s)}};let we=function(e,s){let a=!0;return s.forEach((t,i)=>{a=a&&e[i]===t}),a},B=function(e){let s=0;return e.forEach(a=>{s*=256,s+=a}),s},v=new TextDecoder,V=new Z;V.set("s7e",async function(e){let s=new Uint8Array(await e.slice(0,65536).arrayBuffer()),a="MSB	LSB	PRG	NME",t=[0,0,0,0],i=32,r=0,n=0,o=!0,f=[],p=0;for(;o;){let u=s.subarray(r);([()=>{v.decode(u.subarray(0,4))==="YSFC"?(r+=80,n=1):r++},()=>{if(we(u.subarray(0,4),t))f.forEach((c,l,d)=>{let h=B(s.subarray(c.start+4,c.start+8));c.length=h}),n=2;else{let c=v.decode(u.subarray(0,4)),l=B(u.subarray(4,8));f.push({type:c,start:l}),r+=8}},()=>{let c=f[p],l=s.subarray(c.start,c.start+c.length),d=32;switch(c.type){case"ENVC":{let h=i;for(;h<l.length;){let b=l.subarray(h,h+d),g=v.decode(b.subarray(0,10)).trimEnd();g.slice(0,5)==="Init "&&(g=""),g&&(a+=`
063	${(b[17]+13).toString().padStart(3,"0")}	${b[19].toString().padStart(3,"0")}	${g}`),h+=d}break}case"EDVC":{let h=i;for(;h<l.length;){let b=l.subarray(h,h+d),g=v.decode(b.subarray(0,10)).trimEnd();g.slice(0,5)==="Init "&&(g=""),g&&(a+=`
063	024	${b[19].toString().padStart(3,"0")}	${g}`),h+=d}break}case"EPVC":{let h=32,b=i;for(;b<l.length;){let g=l.subarray(b,b+h),m=v.decode(g.subarray(0,10)).trimEnd();m==="----------"&&(m=""),m&&(a+=`
063	${(g[17]+1).toString().padStart(3,"0")}	${g[19].toString().padStart(3,"0")}	${m}`),b+=h}break}}p++,p>=f.length&&(n=3,o=!1)}][n]||(()=>{o=!1}))()}return a});V.set("pcg",async function(e){let s=new Uint8Array(await e.arrayBuffer()),a="MSB	LSB	PRG	NME",t=100,i=0,r=0,n=!0,o=[],f=0;for(;n;){let p=s.subarray(t);([()=>{n=v.decode(p.subarray(0,4))==="INI2",r=p[15],t+=16,i=1},()=>{let u=v.decode(p.subarray(0,4)),c=p[5],l=p[7],d=p[11],h=B(p.subarray(12,16)),b=B(p.subarray(16,20)),g=B(p.subarray(36,40)),m=v.decode(p.subarray(44,44+d));o.push({type:u,tipMsb:c,tipLsb:l,nameLen:d,length:h,start:b,entryLen:g,name:m}),t+=64,r--,r<1&&(i=2)},()=>{let u=o[f],c=s.subarray(u.start,u.start+u.length);switch(u.type){case"PRG1":break;case"PBK1":{let l=63,d=(u.tipMsb?6:0)+u.tipLsb;for(let h=0;h<128;h++){let b=h*u.entryLen,g=c.subarray(b,b+u.entryLen),m=v.decode(g.subarray(0,24)).trimEnd().replace("InitProg","");m.length&&d>5&&(a+=`
${l.toString().padStart(3,"0")}	${d.toString().padStart(3,"0")}	${h.toString().padStart(3,"0")}	${m}`)}break}case"CBK1":{let l=63,d=(u.tipMsb?3:0)+u.tipLsb+10;for(let h=0;h<128;h++){let b=h*u.entryLen,g=c.subarray(b,b+u.entryLen),m=v.decode(g.subarray(0,24)).trimEnd().replace("InitCombi","");m.length&&d>12&&(a+=`
${l.toString().padStart(3,"0")}	${d.toString().padStart(3,"0")}	${h.toString().padStart(3,"0")}	${m}`)}break}}f++,f>=o.length&&(i=3,n=!1)}][i]||(()=>{n=!1}))()}return a});let Ce=["off","hall","room","stage","plate","delay LCR","delay LR","echo","cross delay","early reflections","gate reverb","reverse gate"].concat(new Array(4),["white room","tunnel","canyon","basement","karaoke"],new Array(43),["pass through","chorus","celeste","flanger","symphonic","rotary speaker","tremelo","auto pan","phaser","distortion","overdrive","amplifier","3-band EQ","2-band EQ","auto wah"],new Array(1),["pitch change","harmonic","touch wah","compressor","noise gate","voice channel","2-way rotary speaker","ensemble detune","ambience"],new Array(4),["talking mod","Lo-Fi","dist + delay","comp + dist + delay","wah + dist + delay","V dist","dual rotor speaker"]);let ve=",a,i,u,e,o,ka,ki,ku,ke,ko,ky,kw,sa,si,su,se,so,sh,ta,ti,tu,te,to,t,ch,t,s,na,ni,nu,ne,no,ny,nn,ha,hi,hu,he,ho,hy,fa,fi,fu,fe,fo,ma,mi,mu,me,mo,my,mm,ya,yu,ye,yo,ra,ri,ru,re,ro,ry,wa,wi,we,wo,ga,gi,gu,ge,go,gy,gw,za,zi,zu,ze,zo,ja,ji,ju,je,jo,jy,da,di,du,de,do,dy,ba,bi,bu,be,bo,by,va,vi,vu,ve,vo,pa,pi,pu,pe,po,py,nga,ngi,ngu,nge,ngo,ngy,ng,hha,hhi,hhu,hhe,hho,hhy,hhw,*,_,,,~,.".split(","),$e={};`hi*,
ka,„Åã
ki,„Åç
ku,„Åè
ke,„Åë
ko,„Åì
ky,„Åç!
kw,„Åèl
tsu,„Å§
ts,„Å§l
sa,„Åï
si,„Åô„ÅÉ
su,„Åô
se,„Åõ
so,„Åù
shi,„Åó
sh,„Åó!
ta,„Åü
ti,„Å¶„ÅÉ
tu,„Å®„ÅÖ
te,„Å¶
to,„Å®
tchy,„Å°!
tchi,„Å°
na,„Å™
ni,„Å´
nu,„Å¨
ne,„Å≠
no,„ÅÆ
ny,„Å´!
nn,„Çì
ha,„ÅØ
hi,„Å≤
hu,„Åª„ÅÖ
he,„Å∏
ho,„Åª
hy,„Å≤!
fa,„Åµ„ÅÅ
fi,„Åµ„ÅÉ
fu,„Åµ
fe,„Åµ„Åá
fo,„Åµ„Åâ
ma,„Åæ
mi,„Åø
mu,„ÇÄ
me,„ÇÅ
mo,„ÇÇ
my,„Åø!
mm,„á∫
ra,„Çâ
ri,„Çä
ru,„Çã
re,„Çå
ro,„Çç
ry,„Çä!
wa,„Çè
wi,„Çê
we,„Çë
wo,„Çí
nga,„Åã„Çö
ngi,„Åç„Çö
ngu,„Åè„Çö
nge,„Åë„Çö
ngo,„Åì„Çö
ngy,„Åç„Çö!
ng,„É≥
ga,„Åå
gi,„Åé
gu,„Åê
ge,„Åí
go,„Åî
gy,„Åé!
gw,„Åêl
za,„Åñ
zi,„Åö„ÅÉ
zu,„Åö
ze,„Åú
zo,„Åû
ja,„Åò„ÇÉ
ji,„Åò
ju,„Åò„ÇÖ
je,„Åò„Åá
jo,„Åò„Çá
jy,„Åò!
da,„Å†
di,„Åß„ÅÉ
du,„Å©„ÅÖ
de,„Åß
do,„Å©
dy,„Åß!
ba,„Å∞
bi,„Å≥
bu,„Å∂
be,„Åπ
bo,„Åº
by,„Å≥!
va,„Çî„ÅÅ
vi,„Çî„ÅÉ
vu,„Çî
ve,„Çî„Åá
vo,„Çî„Åâ
pa,„Å±
pi,„Å¥
pu,„Å∑
pe,„Éö
po,„ÅΩ
py,„Å¥!
!ya,„ÇÉ
!yu,„ÇÖ
!ye,„Åá
!yo,„Çá
ya,„ÇÑ
yu,„ÇÜ
ye,õÄÅ
yo,„Çà
!a,„ÇÉ
!u,„ÇÖ
!e,„Åá
!o,„Çá
!a,„ÇÉ
!u,„ÇÖ
!e,„Åá
!o,„Çá
la,„ÅÅ
li,„ÅÉ
lu,„ÅÖ
le,„Åá
lo,„Åâ
a,„ÅÇ
i,„ÅÑ
u,„ÅÜ
e,„Åà
o,„Åä
*,„Å£
~,
^,
_,`.split(`
`).forEach(e=>{let s=e.split(",");$e[s[0]]=s[1]});let $=new TextEncoder,j=(e,s)=>{let a=Math.min(e.length,s.length),t=0;for(let i=0;i<a;i++)if(t=e[i]-s[i],t!==0)return[i,t];return e.length!==s.length?[a,e.length-s.length]:[0,0]};let ee=function(e,s,a){let t=[],i=a==!1?s.readIntVLV():a;e==0||e==127;for(let r=0;r<i;r++){let n=s.readInt(1);if(t.push(n),n!=247){if(n!=240){if(n>127)return console.debug(`Early termination: ${t}`),t.pop(),s.backOne(),s.backOne(),new Uint8Array(t)}}}return new Uint8Array(t)};let S=function(){return self?.debugMode??!1};let it="‚ô≠ùÑ´,ùÑ´,‚ô≠,,‚ôØ,ùÑ™,ùÑ™‚ôØ".split(",");let C=[new Map,new Map];C[0].set("base64",$.encode("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"));C[0].set("base64url",$.encode("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_"));C[0].set("hex",$.encode("0123456789abcdef"));C[0].set("ovm43",$.encode("0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-_"));C[0].set("radix64",$.encode("0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz+/"));C[0].set("radix64url",$.encode("0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-_"));C[0].set("xx",$.encode("+-0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz"));C[0].set("xxurl",$.encode("_-0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz"));C[0].set("z64",$.encode("0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ+/"));C[0].set("z64url",$.encode("0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ-_"));for(let[e,s]of C[0]){let a=new Uint8Array(128).fill(255);for(let t=0;t<s.length;t++)a[s[t]]=t;switch(e){case"hex":{for(let t=10;t<16;t++)a[t+55]=t;break}default:a[9]=254,a[10]=254,a[12]=254,a[13]=254,a[32]=254,a[61]=254}C[1].set(e,a)}console.debug(C);let xe=(e="base64",s,a=!1)=>{};self.bufferTo=xe;let L={red:"#ff7986",orange:"#fca022",grYellow:"#c9e10a",green:"#c1ff0a",white:"#b7e5e3",blue:"#2280ff"},U={black:"#000000",blue:"#0516bb",purple:"#48009a",inactive:22,medium:59,active:170,range:148},Se=[[6,26],[7,35],[8,44],[9,53],[10,62],[11,71],[12,80],[13,89],[14,98],[15,107],[16,116],[17,125],[18,134],[19,143],[20,152],[21,161],[22,170]],D={},Te="06,68,2a,16,aa,3b".split(",");for(let e in U)D[e]=[],Te.forEach(s=>{D[e].push(`${U[e]}${s}`)});let te=[];for(let e of Se)te.push([`${U.black}${e[0].toString(16).padStart(2,"0")}`,`${U.black}${e[1].toString(16).padStart(2,"0")}`]),e.push(e[1]-e[0]);let ot=`${L.orange}64`,ct=`${L.green}64`,lt=`${L.white}64`,dt=`${L.red}64`,ft=D.black[0],ht=D.black[2],ut=D.black[1];let Me=["?","gm","gs","sc","xg","g2","mt32","doc","qy10","qy20","ns5r","x5d","05rw","k11","sg","sd","pa","krs","s90es","motif","cs6x","trin","an1x","cs1x"];let Pe=["melodic","drum","menu"];let Ae=[36,37,48,49,52,53],F=[20,21,22,23,24,25,26,28,29,30,31,36,37,48,49,52,53,64,65];let re=[0,1,2,4,5,6,7,8,10,11,12,13,14,15,16,17,18,19,20,21,22,26,28,32,38,40,41,42,43,44,45,46,47,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,80,81,82,83,84,91,92,93,94,95,98,99,100,101,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157];let K="reverb,chorus,delay,insert0,insert1,insert2,insert3,insert4".split(",");let Re={};Me.forEach((e,s)=>{Re[e]=s});let Ie=[];re.forEach((e,s)=>{Ie[e]=s});let se={length:F.length};F.forEach((e,s)=>{se[e]=s});let Be={};Pe.forEach((e,s)=>{Be[e]=s});let X=8,y={port:X,ch:X<<4,chShift:Math.ceil(Math.log2(X))+4,cc:re.length,nn:128,pl:512,tr:256,cmt:14,rpn:6,rpnt:4,nrpn:Ae.length,ace:8,drm:8,dpn:F.length,dnc:128,ext:3,efx:8,cvn:12,redir:32,vxPrim:3,invalidCh:255};y.chcc=y.cc*y.ch;let A={bank0:255},jt=new TextDecoder("l9"),De=new Uint16Array(y.ch),Ue=new Uint16Array(y.ch),Le=new Uint16Array(y.ch),Oe=new Uint16Array(y.ch),_e=new Uint16Array(y.ch),Ne=new Uint16Array(y.ch),ae=new Array(y.drm);for(let e=0;e<y.ch;e++)De[e]=e*y.cc,Ue[e]=e*y.rpn,Le[e]=e*y.nrpn,Oe[e]=e*y.ace,_e[e]=e*y.ext,Ne[e]=e*y.cvn;for(let e=0;e<y.drm;e++){ae[e]=new Uint16Array(y.dpn);let s=e*y.dpn*y.dnc;for(let a=0;a<y.dpn;a++)ae[e][a]=s+a*y.dnc}if(typeof self?.require<"u")throw new Error("Environments supporting CommonJS is not supported.");let J=ke(ie(),1);let ne=class{#e=!1;constructor(e,s,a,t){this.#e=e,this.start=s,this.end=a,this.data=t}get duration(){return this.ranged?this.end-this.start:0}get ranged(){return this.#e}},z=class extends ne{constructor(e,s,a){super(!0,e,s,a)}},oe=class extends ne{constructor(e,s){super(!1,e,e,s)}},W=class extends Array{#e=-1;constructor(){super(...arguments)}resetIndex(e){this.#e=-1}fresh(){this.sort(function(e,s){return e.start==s.start?0:(+(e.start>s.start)<<1)-1}),this.forEach(function(e,s){e.index=s})}step(e,s=!1){let a=[];if(s)for(let t=0;t<this.length&&!(this[t].start>e);t++){if(this[t].end<e)continue;a.push(this[t])}else{let t=this.getRange(this.#e==-1?0:e-1,e),i=this;t.forEach(function(r){r.index>i.#e&&(a.push(r),i.#e=r.index)})}return a}getRange(e,s){e>s&&([e,s]=[s,e]);let a=[],t=-1,i=Math.ceil(Math.sqrt(this.length)),r=!0;for(let n=0;n<this.length;n+=i)this[n+i]?t<0&&this[n+i].start>=e&&(t=n):t=t<0?n:t;for(;r;)this[t]?.end<s?this[t].start>=e&&a.push(this[t]):r=!1,t++;return a}};let He=0xffffffffffff,ce=function(e){let s=new W,a=this,t=e.timeDivision,i=120,r=new W,n=0,o=0;r.push(new z(0,He,[120,0])),e.track.forEach(function(c){n=0,c.event.forEach(function(l){n+=l.deltaTime,l.type===255&&l?.metaType===81&&(i=6e7/l.data,r[r.length-1]&&r.push(new z(n,0xffffffffffff,[i,0])))})}),r.fresh(),r.forEach(function(c,l,d){l>0&&(d[l-1].end=c.start)});let f=120;r.forEach(function(c,l,d){l>0&&(c.end===c.start?d.splice(d.indexOf(c),1):f===c.data[0]&&(d[l-1].end=c.end,d.splice(d.indexOf(c),1)),f=c.data[0])});let p=0,u=120;return r.forEach(function(c){let l=c.start,d=l/u/t*60+p;u=c.data[0],p=d-l/u/t*60,c.data[1]=p}),console.debug("All tempo changes: ",r),i=120,n=0,o=0,e.track.forEach(function(c,l){n=0,o=0;let d=l+1;c.event.forEach(function(h,b){n+=h.deltaTime;let g=r.step(n,!0)[0];g&&(i=g.data[0],o=g.data[1]);let m={type:h.type,data:h.data,track:d,part:0};h.type>14?m.meta=h.metaType:m.part=h.channel,s.push(new oe(n/i/t*60+o,m))})}),s.fresh(),self.midiEvents=s,console.debug(`Parsed a type ${e.formatType} MIDI sequence.`),s};let Ge={866:"cp866","utf-8":"utf-8",utf8:"utf-8","utf-16":"utf-16",utf16:"utf-16","utf-16le":"utf-16",utf16le:"utf-16",unicode:"utf-16",unicodefeff:"utf-16","ucs-2":"utf-16","utf-16be":"utf-16be",utf16be:"utf-16be","utf-24":"utf-24",utf24:"utf-24","utf-24le":"utf-24",utf24le:"utf-24","utf-24be":"utf-24be",utf24be:"utf-24be","utf-32":"utf-32",utf32:"utf-32","utf-32le":"utf-32",utf32le:"utf-32","utf-32be":"utf-32be",utf32be:"utf-32be",latin1:"latin1",l1:"latin1",ascii:"latin1","us-ascii":"latin1","iso-8859-1":"latin1","iso8859-1":"latin1",cp1252:"latin1","windows-1252":"latin1",cp819:"latin1",ibm819:"latin1",latin2:"latin2",l2:"latin2","iso-8859-2":"latin2","iso8859-2":"latin2",latin3:"latin3",l3:"latin3","iso-8859-3":"latin3","iso8859-3":"latin3",latin4:"latin4",l4:"latin4","iso-8859-4":"latin4","iso8859-4":"latin4",latin5:"latin5",l5:"latin5","iso-8859-9":"latin5","iso8859-9":"latin5",cp1254:"latin5","windows-1254":"latin5",latin6:"latin6",l6:"latin6","iso-8859-10":"latin6","iso8859-10":"latin6",latin9:"latin9",l9:"latin9","iso-8859-15":"latin9","iso8859-15":"latin9","iso-8859-5":"iso-8859-5","iso8859-5":"iso-8859-5",cyrillic:"iso-8859-5","iso-8859-6":"iso-8859-6","iso8859-6":"iso-8859-6","iso-8859-6-e":"iso-8859-6","iso8859-6e":"iso-8859-6","iso-8859-6-i":"iso-8859-6","iso8859-6i":"iso-8859-6","asmo-708":"iso-8859-6","ecma-114":"iso-8859-6",arabic:"iso-8859-6","iso-8859-7":"iso-8859-7","iso8859-7":"iso-8859-7","ecma-118":"iso-8859-7",greek:"iso-8859-7",greek8:"iso-8859-7","iso-8859-8":"iso-8859-8","iso8859-8":"iso-8859-8","iso-8859-8-e":"iso-8859-8","iso8859-8e":"iso-8859-8",hebrew:"iso-8859-8",visual:"iso-8859-8","iso-8859-8-i":"iso-8859-8-i","iso8859-8i":"iso-8859-8-i",logical:"iso-8859-8-i","iso-8859-11":"iso-8859-11","iso8859-11":"iso-8859-11","windows-874":"iso-8859-11","dos-874":"iso-8859-11",cp874:"iso-8859-11","tis-620":"iso-8859-11","iso-8859-13":"iso-8859-13","iso8859-13":"iso-8859-13",latin7:"iso-8859-13",l7:"iso-8859-13","iso-8859-14":"iso-8859-14","iso8859-14":"iso-8859-14",latin8:"iso-8859-14",l8:"iso-8859-14","iso-8859-16":"iso-8859-16","iso8859-16":"iso-8859-16",cp866:"cp866",ibm866:"cp866",cp1250:"cp1250","windows-1250":"cp1250",cp1251:"cp1251","windows-1251":"cp1251",cp1253:"cp1253","windows-1253":"cp1253",cp1255:"cp1255","windows-1255":"cp1255",cp1256:"cp1256","windows-1256":"cp1256",cp1257:"cp1257","windows-1257":"cp1257",cp1258:"cp1258","windows-1258":"cp1258","euc-jp":"euc-jp",cp954:"euc-jp","euc-kr":"euc-kr",koi8:"koi8",koi:"koi8","koi8-r":"koi8","koi8-u":"koi8-u","koi8-ru":"koi8-u",mac:"mac",macintosh:"mac","mac-cyrillic":"x-mac-cyrillic","x-mac-cyrillic":"x-mac-cyrillic","x-mac-ukrainian":"x-mac-cyrillic",gbk:"gbk",gb2312:"gbk",chinese:"gbk","euc-cn":"gbk",gb18030:"gb18030",big5:"big5","big5-hkscs":"big5",sjis:"sjis","shift-jis":"sjis",ms932:"sjis","windows-31j":"sjis"},Ve={"utf-8":1,"utf-16":2,"utf-16be":3,"utf-24":4,"utf-24be":5,"utf-32":6,"utf-32be":7,latin1:0,latin2:0,latin3:0,latin4:0,latin5:0,latin6:0,latin9:0,"iso-8859-5":0,"iso-8859-6":0,"iso-8859-7":0,"iso-8859-8":0,"iso-8859-8-i":0,"iso-8859-11":0,"iso-8859-13":0,"iso-8859-14":0,"iso-8859-16":0,cp866:0,cp1250:0,cp1251:0,cp1253:0,cp1255:0,cp1256:0,cp1257:0,cp1258:0,"euc-jp":1,"euc-kr":1,koi8:0,"koi8-u":0,mac:0,"x-mac-cyrillic":0,gbk:1,gb18030:1,big5:1,sjis:1},x,T=(x=class{static getUnitSize(e){if(e>7)throw new RangeError("Cannot decode encodings with more than 4 bits per unit.");return(e>>1)+1}static isBigEndian(e){return(e&1)===1}static collapse(e){let s=Ge[e];if(typeof s!="string")throw new TypeError(`Provided label "${e}" is not supported.`);return s}static indicator(e){let s=Ve[e];if(typeof s!="number")throw new TypeError(`Provided collapsed label "${e}" is not supported.`);return s}},k(x,"BYTE_1",0),k(x,"BYTE_1_VL",1),k(x,"BYTE_2_LE",2),k(x,"BYTE_2_BE",3),k(x,"BYTE_3_LE",4),k(x,"BYTE_3_BE",5),k(x,"BYTE_4_LE",6),k(x,"BYTE_4_BE",7),x),w=(e,s)=>{e.unsent=!1,e.enqueue(s)},O=(e,s,a=1,t=!0)=>{if(typeof a!="number"||a<=0||a>4)throw new RangeError(`Invalid byte size ${a}.`);if(!(e instanceof Uint8Array||e instanceof Uint8ClampedArray))throw new TypeError("Input buffer is not Uint8Array.");if(typeof s!="number"||s<0||s>=e.length)throw new RangeError(`Provided offset ${s} is out of buffer range.`);if(a===1)return e[s];{let i=0;if(t)for(let r=0;r<a;r++)i<<=8,i|=e[s+r];else for(let r=0;r<a;r++)i|=e[s+r]<<(r<<3);return i<0?i+4294967296:i}},Xe=class{static lineRaw(e,s=0){if(typeof s!="number"||s<0||s>7)throw new TypeError("Invalid split mode.");if(!e||e?.constructor!==ReadableStream)throw new TypeError("Not a readable stream.");let a=T.getUnitSize(s),t=T.isBigEndian(s),i=e.getReader(),r,n=!1,o=[],f=0,p=0,u=0;return new ReadableStream({pull:async c=>{for(c.unsent=!0;c.unsent;){if(!r||f>=r.length){f>p&&(o.push(r.subarray(p)),p=0);let l=await i.read();r=l.value,n=l.done,f=0}if(r){let l=0;if(a===1)l=r[f];else if(t)for(let h=0;h<a;h++)l<<=8,l|=r[f+h];else for(let h=0;h<a;h++)l|=r[f+h]<<(h<<3);let d=!1;switch(l){case 10:{u===13?p+=a:d=!0;break}case 13:{d=!0;break}}if(d){if(o.length){o.push(r.subarray(p,f));let h=0;for(let m=0;m<o.length;m++)h+=o[m].length;let b=new Uint8Array(h),g=0;for(let m=0;m<o.length;m++)b.set(o[m],g),g+=o[m].length;w(c,b),o=[]}else w(c,r.subarray(p,f));p=f+=a}u=l}if(n){if(p!==f&&r&&o.push(r.subarray(p,f)),o.length){let l=0;for(let b=0;b<o.length;b++)l+=o[b].length;let d=new Uint8Array(l),h=0;for(let b=0;b<o.length;b++)d.set(o[b],h),h+=o[b].length;w(c,d)}c.unsent=!1,c.close()}f+=a}}},new ByteLengthQueuingStrategy({highWaterMark:256}))}static chunkRaw(e,s="utf-8"){if(!e||e?.constructor!==ReadableStream)throw new TypeError("Not a readable stream.");let a=T.indicator(s),t=T.getUnitSize(a),i=T.isBigEndian(a),r=e.getReader(),n;return new ReadableStream({pull:async o=>{o.unsent=!0;let{value:f,done:p}=await r.read();if(f){let u=0,c=f.length;if(a!==0&&typeof n?.length=="number"){let l=!1;switch(s){case"big5":case"gbk":case"sjis":case"euc-kr":{u=1;let d=new Uint8Array(2);d[0]=n[0],d[1]=f[0],w(o,d);break}case"euc-jp":{let d=3;n[0]===143?u=3-n.length:n[0]>127?(u=1,d=2):d=n.length;let h=new Uint8Array(3);h.set(n),h.set(f.subarray(0,u),n.length),w(o,h.subarray(0,d));break}case"gb18030":{let d=new Uint8Array(4),h=4;d.set(n),d.set(f.subarray(0,4-n.length),n.length),d[0]<128?h=n.length:d[1]>=64?(u=1,h=2):u=4-n.length,w(o,d.subarray(0,h));break}case"utf-8":{let d=4;n[0]>=240?u=4-n.length:n[0]>=224?(u=3-n.length,d=3):n[0]>=192?(u=1,d=2):d=n.length;let h=new Uint8Array(4);h.set(n),h.set(f.subarray(0,u),n.length),w(o,h.subarray(0,d));break}case"utf-16":case"utf-16be":{let d=new Uint8Array(4);d.set(n),d.set(f.subarray(0,4-n.length)),u=4-n.length,O(transientSize,0,2,i)>=55296&&O(transientSize,2,2,i)>=55296?w(o,d):(w(o,d.subarray(0,2)),w(o,d.subarray(2)));break}default:{let d=new Uint8Array(t);d.set(n),d.set(f.subarray(0,t-n.length),n.length),w(o,d)}}}if(n=void 0,a===0)w(o,f.subarray(u));else{switch(s){case"utf-24":case"utf-24be":{c=Math.floor((f.length-u)/t)*t+u;break}case"utf-32":case"utf-32be":{c=(f.length-u>>2<<2)+u;break}case"utf-8":{if(f[f.length-1]>127){let l=!0,d=f.length,h=f.length-8;for(;l&&d>h;)d--,f[d]<128?c=d+1:f[d]>192&&(c=d)}break}case"utf-16":case"utf-16be":{if(c=(f.length-u>>1<<1)+u,O(f,c-2,2,i)>=55296){let l=!0,d=c,h=c-6;for(;l&&d>h;)d-=2,O(f,d,2,i)>>10===54&&(c=d)}break}default:throw new TypeError("Maybe someday the rest of the decoders will be implemented")}w(o,f.subarray(u,c))}c<f.length&&(n=f.subarray(c))}p&&(typeof n?.length=="number"&&w(o,n),o.unsent=!1,o.close())}},new ByteLengthQueuingStrategy({highWaterMark:256}))}static line(e,s="utf-8",a){let t=T.collapse(s),i=T.indicator(t),r=this.lineRaw(e,i).getReader(),n=new TextDecoder(t,onlostpointercapture);return new ReadableStream({pull:async o=>{let{value:f,done:p}=await r.read();f&&o.enqueue(n.decode(f)),p&&o.close()}})}static chunk(e,s="utf-8",a){let t=T.collapse(s);if(self.TextDecoderStream){let i=new TextDecoderStream(t,a);return e.pipeTo(i.writable),i.readable}else{let i=this.chunkRaw(e,t).getReader(),r=new TextDecoder(t);return new ReadableStream({pull:async n=>{let{value:o,done:f}=await i.read();o&&(console.debug(o),n.enqueue(r.decode(o))),f&&n.close()}})}}},le=Xe;let q={0:"\0",a:"\x07",b:"\b",e:"\x1B",f:"\f",n:`
`,r:"\r",t:"	",v:"\v","\\":"\\","'":"'",'"':'"'},Q=new Uint8Array(128);Q.fill(1,48,58);Q.fill(1,65,71);Q.fill(1,97,103);let R=new Uint8Array(256);R.fill(1,0,32);R.fill(1,128,160);R[127]=1;let Fe={};for(let e in q){let s=q[e];Fe[s]=`\\${e}`,R[s.charCodeAt(0)]=2}R[34]=3;R[39]=3;let de=e=>{let s="",a=!1;for(let t=0;t<e.length;t++){let i=e[t];if(a){let r=0;switch(i){case"x":{r=2;break}case"u":{r=4;break}case"U":{r=8;break}default:{let n=q[i];if(typeof n=="string")s+=n;else throw new Error(`Invalid escape identifier "${i}" at index ${t}`);a=!1;continue}}if(r>0){let n=t+1,o=e.substring(n,n+r);if(o.length<r)throw new RangeError(`Insufficient code point buffer "${o}" at index ${n}`);let f=parseInt(o,16);if(Number.isNaN(f))throw new RangeError(`Malformed code point representation "${o}" at index ${n}`);if(f>=1114112)throw new RangeError(`Code point "${o}" exceeds 0x10ffff at index ${n}`);s+=String.fromCodePoint(f),a=!1,t+=r}}else i==="\\"?a=!0:s+=i}return s},Ke=(e,s=0)=>{};self.TextEscape=Ke;let M,_=(M=class{static parse(e,s){let a=e&this.MASK_TYPE,t=e&this.MASK_DATA,i=0,r=0,n,o=0,f,p=s.getReader();return new ReadableStream({pull:async u=>{let{value:c,done:l}=await p.read();if(typeof c=="string"){switch(a){case this.TYPE_TSV:{n=[];try{for(let d of c.split("	"))switch(t){case this.DATA_TEXT:{n.push(de(d));break}case this.DATA_JSON:{n.push(i===0?de(d):JSON.parse(d));break}default:throw new TypeError(`Unknown DSV value type ${a}`)}}catch(d){console.debug(`The following error appeared when parsing on line ${i+1}.`),console.error(d)}break}case this.TYPE_CSV:{if(t!==this.DATA_TEXT)throw new TypeError(`Invalid type ${a} for CSV, only plain text is allowed`);break}default:throw new TypeError(`Unknown DSV type ${a}`)}u.enqueue(n),i++}l&&u.close()}})}static parseObjects(e,s){let a=0,t=this.parse(e,s).getReader(),i;return new ReadableStream({start:async r=>{let{value:n,done:o}=await t.read();typeof n?.length=="number"&&(i=n),o&&r.close()},pull:async r=>{let{value:n,done:o}=await t.read();if(typeof n?.length=="number"){let f={};for(let p=0;p<n.length;p++)n[p]&&(f[i[p]]=n[p]);r.enqueue(f)}o&&r.close()}})}},k(M,"MASK_TYPE",3),k(M,"MASK_DATA",12),k(M,"TYPE_TSV",0),k(M,"TYPE_CSV",1),k(M,"DATA_TEXT",0),k(M,"DATA_JSON",4),M);J.default.customInterpreter=ee;let E=(e,s,a)=>{e.addEventListener(a,t=>{s.dispatchEvent(a,t.data)})},fe=e=>{let s=e.split("/");return s[s.length-1]||s[s.length-2]||"(remote)"};if(typeof self?.require<"u")throw new Error("Environments supporting CommonJS is not supported.");let $a=class extends G{BM_UNIVERSAL=0;BM_YAMAHA_MU=1;device;#e;#c={};#g=[];#n=new Map;#a="";#u=[];#m=[];#p=new Uint8ClampedArray(y.ch);#E=new Uint8ClampedArray(y.ch);#y=new Uint32Array(y.ch);#b=new Uint32Array(y.ch);#l=.5;#d=120;#r=4;#t=4;#s=0;#o=0;#i=new Array(y.ch);#f=new Uint8Array(y.ch);#h=0;dState;msActive=200;msFrame=100;msExhaust=300;smoothAttack=0;smoothDecay=0;get clockSource(){return this.device?.clockSource}set clockSource(e){if(this.device)this.device.clockSource=e;else throw new Error("OctaviaDevice is not ready.")}reset(){let e=this;e.dispatchEvent("reset"),e.#e?.resetIndex(),e.device.init(),e.#a="",e.#l=.5,e.#d=120,e.#r=4,e.#t=4,e.#s=0,e.#o=0,e.dispatchEvent("tempo",e.#d),e.dispatchEvent("title",e.#a),e.dispatchEvent("tsig",e.getTimeSig())}init(){this.reset(),this.#e=void 0}async loadFile(e){this.#e=ce(J.default.parse(new Uint8Array(await e.arrayBuffer())))}async loadMap(e,s,a,t="(internal)"){let i=this,r=0,n=0,o=0,f=0,p,u;e.split(`
`).forEach((c,l)=>{if(!c)return;let d=c.split("	");if(l){if(!f)return;let h="",b="";d.forEach((m,P)=>{switch(P){case p:{h=m;break}case u:{b=m;break}}});let g=!1;i.#c[h]?.priority>a&&(g=!0,o++),!i.#c[h]||g||s?(i.#c[h]={name:b,priority:a},r++):self.debugMode&&console.debug(`Voice "${b}" (${h}) seems to be in conflict with (${i.#c[h]}).`),n++}else d.forEach((h,b)=>{switch(h){case"ID":{p=b,f++;break}case"Name":{u=b,f++;break}default:console.debug(`Unknown map field: ${h}`)}})}),console.debug(`Voice names: From "${t}", ${n} total, ${r} loaded (${r-o} + ${o}).`),i?.device.forceVoiceRefresh()}async loadMapPaths(e){let s=this;e.forEach(async(a,t)=>{s.loadMap(await(await fetch(a)).text(),0,t,fe(a))})}async loadEfx(e,s){let a=this,t=0,i=0,r,n,o;e.split(`
`).forEach((f,p)=>{if(f)if(p){let u=0,c;f.split("	").forEach((l,d)=>{switch(d){case r:{u|=(parseInt(l,16)&255)<<8;break}case n:{u|=parseInt(l,16)&255;break}case o:{c=l;break}}}),!a.#g[u]||s?(a.#g[u]=c,t++):self.debugMode&&console.debug(`EFX ID 0x${u.toString(16).padStart(4,"0")} (${c}) seems to be in conflict.`),i++}else f.split("	").forEach((u,c)=>{switch(u){case"MSB":{r=c;break}case"LSB":{n=c;break}case"Name":{o=c;break}default:console.debug(`Unknown EFX field: ${u}`)}})}),console.debug(`EFX: ${i} total, ${t} loaded.`);for(let f=0;f<K.length;f++){let p=!1,u=a.device.getEffectType(f);u[0]===0&&u[1]>>4===15&&(p=!0),a.dispatchEvent(`efx${K[f]}`,{id:u,hidden:p})}}async loadModels(e,s){let a=this,t=0,i=0}async loadStyles(e,s){let a=this,t=0,i=0}async loadProps(e,s,a=0,t="(internal)"){let i=this,r=0,n=0,o=0;for await(let f of _.parseObjects(_.DATA_TEXT|_.TYPE_TSV,le.line(e)))if(typeof f?.voiceId=="string")if(n++,!(i.#n.has(f.voiceId)||i.#n.get(f.voiceId)?.priority<=a)||s){if(Object.keys(f).length<2)continue;i.#n.get(f.voiceId)?.priority>a&&o++,f.priority=a,i.handleProp&&await i.handleProp(f),i.#n.set(f.voiceId,f),r++}else console.debug(`Tried to write a pre-existing entry "${f.voiceId}" on entry ${n}.`);console.debug(`Voice properties: From "${t}", ${n} total, ${r} loaded (${r-o} + ${o}).`)}async loadPropsPaths(e){let s=this;e.forEach(async(a,t)=>{let i=a.split("/");s.loadProps((await fetch(a)).body,0,t,fe(a))})}switchMode(e,s=!1){this.device.switchMode(e,s)}getMode(){return this.device.getMode()}getVoice(){return this.device.getVoice(...arguments)}getChVoice(e){return this.device.getChVoice(e)}refreshCachedChVoice(e,s){let a=this,t=s??a.device.getChVoice(e),i=a.#i[e],r=!0;if(a.#h++,!s)switch(a.device.getChMode(e)){case"xg":{if(a.device.getChType(e)>0&&a.device.getChPrimitive(e,1)!==126)switch(t.ending){case"!":case"?":{r=!1,i.refreshFailure=!0,console.debug("Cached voice persisted due to invalid drum kit.");break}}break}case"gs":case"sc":{t.ending!==" "&&(t.sid[2]===1?(t.name="Silence",t.refreshFailure=!0,console.debug("Cached voice nullified due to invalid SC-55 voice.")):(r=!1,i.refreshFailure=!0,console.debug("Cached voice persisted due to invalid GS voice.")));break}}return r?(a.#i[e]=t,a.#f[e]=t.poly??1,a.#h>1?console.debug(`Bubbling prevented at instance #${a.#h}.`):a.dispatchEvent("cachedvoice",{part:e}),a.#h--,t):(a.#h--,i)}getCachedChVoice(e){let s=this,a=s.#i[e],t=s.device?.getChPrimitives(e,!0);if(a&&s.device?.getChCvnIsWritten(e)===0)switch(a.ending){case"?":case"!":return s.refreshCachedChVoice(e,void 0);default:return j(a.sid,t)[1]!==0||a.name==="Unloaded"?s.refreshCachedChVoice(e):a}else return s.refreshCachedChVoice(e)}getChPrimitive(e,s,a){return this.device.getChPrimitive(e,s,a)}getChPrimitives(e,s){return this.device.getChPrimitives(e,s)}getMapped(e){return this.#c[e]?.name||e}getEfx(e){let[s,a]=e,t=s<<8|a;return this.#g[t]||`0x${t.toString(16).padStart(4,"0")}`}getVoxBm(e,s=this.BM_UNIVERSAL){if(!e)throw new Error("Voice object must be valid");let a=this;if(!a.voxBm)throw new Error("Voice bitmap repository isn't yet initialized");let t=a.voxBm.getBm(e.name);if(!t){switch(e.mode){case"xg":{switch(e.sid[0]){case 0:case 80:case 81:case 83:case 84:case 96:case 97:case 99:case 100:{t=a.voxBm.getBm(a.getVoice(A.bank0,e.sid[1],A.bank0,e.mode).name);break}}break}case"g2":case"sd":{switch(e.sid[0]){case 96:case 97:case 98:case 99:{t=a.voxBm.getBm(a.getVoice(A.bank0,e.sid[1],A.bank0,e.mode).name);break}case 104:case 105:case 106:case 107:{t=a.voxBm.getBm(a.getVoice(120,e.sid[1],A.bank0,e.mode).name);break}}break}case"gs":case"sc":case"k11":case"sg":case"gm":{switch(e.sid[0]){case 120:break;case 122:case 127:{t=a.voxBm.getBm(a.getVoice(120,e.sid[1],0,e.mode).name);break}default:t=a.voxBm.getBm(a.getVoice(0,e.sid[1],0,e.mode).name)}break}case"05rw":case"x5d":case"ns5r":{switch(e.sid[0]){case 56:{t=a.voxBm.getBm(a.getVoice(0,e.sid[1],0,"gm").name);break}}break}default:}switch(s){case a.BM_UNIVERSAL:break;case a.BM_YAMAHA_MU:{let i=e.standard.toLowerCase();if(i!==e.mode&&I.xg.has(i))switch(e.sid[0]>>4){case 2:{t=a.sysBm?.getBm(`ext_${i}I`);break}case 3:{e.sid[0]===48&&(t=a.sysBm?.getBm("boot_3"));break}case 6:{t=a.sysBm.getBm(`ext_${i}P`);break}default:{t=a.sysBm.getBm(`ext_${i}`);break}}else["es"].indexOf(i)>-1?t=a.sysBm.getBm("boot_3"):i==="kr"&&(t=a.sysBm.getBm("st_korg"));break}}}return t||(t=a.voxBm.getBm(a.getVoice(e.sid[0],e.sid[1],0,e.mode).name)),t}getChBm(e,s=this.BM_UNIVERSAL,a){let t=this;a=a??t.getChVoice(e);let i=t?.device.getChType(e),r;switch(s){case t.BM_UNIVERSAL:break;case t.BM_YAMAHA_MU:{let n=a.standard.toLowerCase();if(n!==a.mode&&I.xg.has(n))switch(a.sid[0]>>4){case 1:{a.sid[0]===16&&(r=t.sysBm.getBm("cat_svox"));break}case 2:{r=t.sysBm?.getBm(`ext_${n}I`);break}case 3:{a.sid[0]===48&&(r=t.sysBm?.getBm("boot_3"));break}case 6:{r=t.sysBm.getBm(`ext_${n}P`);break}default:{r=t.sysBm.getBm(`ext_${n}`);break}}else if(["es"].indexOf(n)>-1)r=t.sysBm.getBm("boot_3");else if(n==="kr")r=t.sysBm.getBm("st_korg");else if(n==="xg")switch(a.sid[0]){case 126:{a.sid[1]>>2===28&&(r=t.sysBm.getBm("cat_smpl"));break}}if(!r&&i)switch(a.ending){case"!":case"?":case"*":{r=t.sysBm.getBm(i>1&&i<6?`cat_dS${i-1}`:"cat_drS");break}default:r=t.sysBm.getBm(i>1&&i<10?`cat_dr${i-1}`:"cat_drm")}break}}if(r=r||t.getVoxBm(a,s),!r){if(!t.sysBm)return;switch(a.mode){case"xg":{switch(a.sid[0]){case 126:{a.sid[1]>>2===28&&(r=t.sysBm.getBm("cat_smpl"));break}case 16:{r=t.sysBm.getBm("cat_smpl");break}case 64:case 67:{r=t.sysBm.getBm("cat_sfx");break}case 32:case 33:case 34:case 35:case 36:case 48:case 82:{r=t.sysBm.getBm("cat_xg");break}}break}default:switch(a.sid[0]){case 63:case 32:case 33:case 34:case 35:case 36:case 48:case 82:{r=t.sysBm.getBm("cat_mex");break}}}}if(r)switch(a.ending){case"!":case"?":case"*":{r=t.sysBm.getBm(i?"cat_drS":"no_vox");break}}else i?r=t.sysBm.getBm("cat_drS"):r=t.sysBm.getBm("no_vox");return r}getChBmState(e,s=1){let a=this,t=Math.floor(a.#o*1e3)-a.getChLastNoteExhausted(e);return a.getChLastNoteExhausted(e)<=0?0:t<a.msActive?(s-=1,s<1?0:Math.floor(t/a.msFrame)%s+1):0}detachState(e){let s=this;if(s.dState){let a=s.dState;switch(e){case"mu":{s.removeEventListener("mupromptex",a.muScheduleSysEx),s.removeEventListener("mode",a.muModeFunc),delete a.muModeFunc,delete a.muModeBm,delete a.muExhaustEx,delete a.muDurationEx,delete a.muBlinkSpeedEx,delete a.muPromptEx,delete a.muScheduledEx,delete a.muUnresolvedEx,delete a.muDisableExBlink,delete a.muUseVoiceBm,delete a.muTempWindow,delete a.muBlinkSpeedMode,delete a.muBmex,delete a.muBmst,delete a.isMu;break}}return!0}else return!1}attachState(e){let s=this;s.dState=s.dState??{};let a=s.dState,t=!1;switch(e){case"mu":{a.isMu=!0,a.muBmst=0,a.muBmex=0,a.muBlinkSpeedMode=400,a.muTempWindow=new Uint8Array(256),a.muUseVoiceBm=!0,a.muDisableExBlink=!1,a.muUnresolvedEx=0,a.muScheduledEx=0,a.muPromptEx=0,a.muBlinkSpeedEx=200,a.muDurationEx=a.muBlinkSpeedEx*5,a.muExhaustEx=a.muBlinkSpeedEx<<1,a.muModeFunc=function(i){let r=s.sysBm.getBm(`st_${{gm:"gm1",g2:"gm2","?":"gm1",ns5r:"korg",ag10:"korg",x5d:"korg","05rw":"korg",krs:"korg",sg:"gm1",k11:"gm1",sd:"gm2",sc:"gs"}[i.data]||i.data}`);r&&(a.muModeBm=r.getFrame(0)),a.muBmst=2,a.muBmex=s.clockSource.now()+(a.muBlinkSpeedMode<<2)},s.addEventListener("mode",a.muModeFunc),a.muScheduleSysEx=function(i){a.muDisableExBlink?(a.muScheduledEx=0,S()&&console.debug("SysEx blinking cancelled due to disabled feature.")):(a.muScheduledEx+=i.data,S()&&console.debug(`Scheduled a SysEx prompt at ${i.data} B. Remaining ${a.muScheduledEx} B unfulfilled prompts.`))},s.device?.addEventListener("mupromptex",a.muScheduleSysEx);break}default:t=!0}return!t}muWriteBm(e,s,a){if(e?.BYTES_PER_ELEMENT!==1)throw new TypeError("Buffer must be Uint8Array.");let t=this,i=e.length>>8||1;if(!t.dState.isMu)throw new Error("Device state for MU is not yet attached.");let r=t.dState,n=t.clockSource.now(),o=t.device?.getBitmap(),f=r.muTempWindow,p=!1,u=!1;if(r.muScheduledEx>0){let c=r.muScheduledEx*85+4095>>12;n-r.muPromptEx>r.muBlinkSpeedEx?(r.muUnresolvedEx+=c*204+4095>>12,S()&&console.debug(`SysEx blinking submitted, now at ${r.muUnresolvedEx}.`)):((n-r.muPromptEx)*41>>12&1&&r.muUnresolvedEx<8&&r.muUnresolvedEx==8,r.muUnresolvedEx+=c+1>>1,S()&&console.debug(`SysEx blinking too busy, now at ${r.muUnresolvedEx}.`)),r.muScheduledEx=0}if(n<o.expire)r.muUnresolvedEx>0&&(r.muUnresolvedEx=0,S()&&console.debug("SysEx blinking cancelled by bitmap.")),o.bitmap.length<=256?(f=o.bitmap,p=!0):(e.set(o.bitmap.subarray(0,e.length)),u=!0);else if(n<r.muBmex){if(r.muBmst===2){p=!0,r.muUnresolvedEx>0&&(r.muUnresolvedEx=0,S()&&console.debug("SysEx blinking cancelled by mode set."));let c=Math.floor((r.muBmex-n)/r.muBlinkSpeedMode)&1;r.muModeBm?r.muModeBm?.forEach((l,d)=>{f[d]=c===l}):f.fill(c?0:1)}}else if(r.muUseVoiceBm){p=!0,r.muUnresolvedEx>0&&n-r.muPromptEx>=r.muExhaustEx?(r.muUnresolvedEx<16?r.muUnresolvedEx=0:r.muUnresolvedEx-=16,r.muPromptEx=n,S()&&console.debug(`SysEx blinking resolved to ${r.muUnresolvedEx}.`)):r.muUnresolvedEx<0&&(r.muUnresolvedEx=0),r.muBmst=0;let c=t.getChBm(s,t.BM_YAMAHA_MU,a),l=t.getChBmState(s,c?.frames||1);c&&f.set(c.getFrame(l));let d=n-r.muPromptEx;d<=r.muDurationEx&&(t.sysBm.getBm("sysex_m")?.getFrame(0).forEach((h,b)=>{h&&(f[b]=0)}),t.sysBm.getBm(`sysex_${Math.floor(d/r.muDurationEx*5)&1}`)?.getFrame(0).forEach((h,b)=>{h&&(f[b]=1)}))}if(p){let c=0;for(let l=0;l<f.length;l++){let d=f[l];e[c]=d?255:0,i===2&&(e[c+1]=d?255:0),c+=i}}return p||u}getProps(e){let s=this,a,t,i=0,r=e;for(;i<8&&a==null&&(!t?.constructor||t instanceof Array&&(t[1]!==e.eid[1]||t[2]!==e.eid[2]));)t=e.eid,typeof e.voice=="string"&&(s.#n.has(e.voice)?a=s.#n.get(e.voice):e=s.getVoice(t[0],t[2]===0?0:t[1],t[2]===0?0:t[2]-1));return!a&&i===8&&console.info(`Voice property fetching failed for "${e.name}" (${e.eid.join(" ")}).`),a}get noteProgress(){return this.#o/this.#l}get noteOverall(){return(this.noteProgress-this.#s)*this.#t/4}get noteBar(){return Math.floor(this.noteOverall/this.#r)}get noteBeat(){let e=this.noteOverall%this.#r;return e<0&&(e+=this.#r),e}get noteOffset(){return this.#s}getTimeSig(){return[this.#r,this.#t]}getTempo(){return this.#d}getPool(){return this.#e}getChCachedVoiceRaw(e){return this.#i[e]}getChLastNoteAt(e){return this.#y[e]}getChLastNoteExhausted(e){return this.#b[e]}eachVoice(e,s=!1){let a=this;for(let t=0;t<a.#i.length;t++)(s||a.device?.getChActive(t))&&e(a.#i[t],t,a.#i)}sendCmd(e){this.device.runJson(e)}render(e){e>this.#o&&(this.#o=e);let s=this.#e?.step(e)||[],a=0,t=0,i=new Set,r={},n=[],o=this,f=[];for(o.device.getStrength().forEach((b,g)=>{o.#E[g]=b}),o.device.newStrength(),s.forEach(function(b){let g=b.data,m=o.device.runJson(g);switch(m?.reply){case"meta":{f.push(m);break}}m?.reply&&delete m.reply});o.#m.length>0;){let b=o.#m.shift(),g=b.part<<7|b.note;b.state?(i.add(g),r[g]=b.velo):i.has(g)&&(n.push({part:b.part,note:b.note,velo:r[g],state:o.device.NOTE_SUSTAIN}),a++,t+=o.#f[b.part])}f?.length>0&&o.dispatchEvent("meta",f);let p=[],u=[],c=o.device.getStrength();c.forEach(function(b,g,m){m[g]=Math.max(o.#E[g],b);let P=m[g]-o.#p[g];if(P>=0){let N=4*.25**(o.device.getChCc(g,73)/64);o.#p[g]+=Math.ceil(P-P*o.smoothAttack**N)}else{let N=4*.25**(o.device.getChCc(g,72)/64);o.#p[g]+=Math.floor(P-P*o.smoothDecay**N)}});let l=0,d=0;return o.device?.getActive()?.forEach(function(b,g){b&&(p[g]=o.device.getVel(g),u[g]=o.device.getExt(g),l+=p[g].size,d+=p[g].size*o.#f[g])}),{extraPoly:a,extraPolyEC:t,extraNotes:n,curPoly:l,curPolyEC:d,chKeyPr:p,chExt:u,eventCount:s.length,title:o.#a,texts:o.device.getTexts(),master:o.device.getMaster(),strength:o.#p,velo:c,rpn:o.device.getRpn(),tSig:o.getTimeSig(),tempo:o.getTempo(),noteBar:o.noteBar,noteBeat:o.noteBeat,ace:o.device.getAce(),rawVelo:o.device.getStrength(),rawStrength:o.device.getRawStrength(),rawPitch:o.device.getRawPitch(),efxSink:o.device.getEffectSink()}}constructor(e,s=.5,a=.5){super();let t=this;t.smoothAttack=s,t.smoothDecay=a,t.device=e,t.addEventListener("meta",function(i){i?.data?.forEach(function(r){(t.#u[r.meta]||console.debug).call(t,r.meta,r.data)})}),E(t.device,t,"mode"),E(t.device,t,"mastervolume"),E(t.device,t,"channelactive"),E(t.device,t,"channelmin"),E(t.device,t,"channelmax"),E(t.device,t,"portrange"),E(t.device,t,"portstart"),E(t.device,t,"channelreset"),E(t.device,t,"channeltoggle"),E(t.device,t,"screen"),E(t.device,t,"metacommit"),E(t.device,t,"voice"),E(t.device,t,"pitch"),E(t.device,t,"note"),E(t.device,t,"reset"),E(t.device,t,"banklevel"),E(t.device,t,"efxreverb"),E(t.device,t,"efxchorus"),E(t.device,t,"efxdelay"),E(t.device,t,"efxinsert0"),E(t.device,t,"efxinsert1"),E(t.device,t,"efxinsert2"),E(t.device,t,"efxinsert3"),E(t.device,t,"efxinsert4"),E(t.device,t,"partefxtoggle"),E(t.device,t,"chmode"),t.addEventListener("note",function({data:i}){if(t.#m.push(i),i.state===3){let r=Math.floor(t.#o*1e3);t.#y[i.part]=r,r-t.#b[i.part]>=t.msExhaust&&(t.#b[i.part]=r)}}),t.addEventListener("voice",({data:i})=>{t.refreshCachedChVoice(i.part)}),t.addEventListener("reset",({data:i})=>{t.#f.fill(1),t.#y.fill(0),t.#b.fill(0)}),t.#f.fill(1),t.#u[3]=function(i,r){t.#a?.length<1&&(t.#a=r,t.dispatchEvent("title",t.#a))},t.#u[81]=function(i,r){let n=t.noteProgress,o=t.#l||.5;t.#d=6e7/r,t.#l=r/1e6,t.#s+=n*(o/t.#l)-n,t.dispatchEvent("tempo",t.#d)},t.#u[88]=function(i,r){let n=t.noteBar,o=t.noteBeat,f=t.#r,p=t.#t;t.#r=r[0],t.#t=1<<r[1];let u=Math.round(n+o/f);f!==t.#r&&(t.#s-=u*(t.#r-f)*(4/t.#t)),p!==t.#t&&(console.debug(`${n}/${o}`),p<t.#t?t.#s+=u*(t.#t-p)*(p/t.#t):t.#s+=u*(t.#t-p)*(t.#t/p)),t.dispatchEvent("tsig",t.getTimeSig())},t.addEventListener("metacommit",({data:i})=>{switch(i.type){case"KarTitle":case"EORTitle":{t.#a?.length<1&&(t.#a=i.data,t.dispatchEvent("title",t.#a));break}}})}};export{$a as RootDisplay,y as allocated,se as dnToPos};
