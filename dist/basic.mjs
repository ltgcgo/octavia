var fe=Object.create;var N=Object.defineProperty;var he=Object.getOwnPropertyDescriptor;var ue=Object.getOwnPropertyNames;var pe=Object.getPrototypeOf,be=Object.prototype.hasOwnProperty;var ge=(t,r,a)=>r in t?N(t,r,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[r]=a;var me=(t,r)=>()=>(r||t((r={exports:{}}).exports,r),r.exports);var ye=(t,r,a,e)=>{if(r&&typeof r=="object"||typeof r=="function")for(let i of ue(r))!be.call(t,i)&&i!==a&&N(t,i,{get:()=>r[i],enumerable:!(e=he(r,i))||e.enumerable});return t};var Ee=(t,r,a)=>(a=t!=null?fe(pe(t)):{},ye(r||!t||!t.__esModule?N(a,"default",{value:t,enumerable:!0}):a,t));var k=(t,r,a)=>(ge(t,typeof r!="symbol"?r+"":r,a),a);var se=me((ta,K)=>{(function(){"use strict";let t={fatal:!0},r=[new TextDecoder("iso-8859-15",t),new TextDecoder("utf-8",t),new TextDecoder("sjis",t),new TextDecoder("euc-jp",t),new TextDecoder("ascii")],a={debug:!1,parse:function(e,i){if(e instanceof Uint8Array)return a.Uint8(e);if(typeof e=="string")return a.Base64(e);if(e instanceof HTMLElement&&e.type==="file")return a.addListener(e,i);throw new Error("MidiParser.parse() : Invalid input provided")},addListener:function(e,i){if(!File||!FileReader)throw new Error("The File|FileReader APIs are not supported in this browser. Use instead MidiParser.Base64() or MidiParser.Uint8()");if(e===void 0||!(e instanceof HTMLElement)||e.tagName!=="INPUT"||e.type.toLowerCase()!=="file")return console.warn("MidiParser.addListener() : Provided element is not a valid FILE INPUT element"),!1;i=i||function(){},e.addEventListener("change",function(s){if(!s.target.files.length)return!1;console.log("MidiParser.addListener() : File detected in INPUT ELEMENT processing data..");let o=new FileReader;o.readAsArrayBuffer(s.target.files[0]),o.onload=function(n){i(a.Uint8(new Uint8Array(n.target.result)))}})},Base64:function(e){let i=function(n){var f="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";if(n=n.replace(/^.*?base64,/,""),n=String(n).replace(/[\t\n\f\r ]+/g,""),!/^(?:[A-Za-z\d+\/]{4})*?(?:[A-Za-z\d+\/]{2}(?:==)?|[A-Za-z\d+\/]{3}=?)?$/.test(n))throw new TypeError("Failed to execute _atob() : The string to be decoded is not correctly encoded.");n+="==".slice(2-(3&n.length));let p,u="",c,l,d=0;for(;d<n.length;)p=f.indexOf(n.charAt(d++))<<18|f.indexOf(n.charAt(d++))<<12|(c=f.indexOf(n.charAt(d++)))<<6|(l=f.indexOf(n.charAt(d++))),u+=c===64?String.fromCharCode(p>>16&255):l===64?String.fromCharCode(p>>16&255,p>>8&255):String.fromCharCode(p>>16&255,p>>8&255,255&p);return u}(e=String(e));var s=i.length;let o=new Uint8Array(new ArrayBuffer(s));for(let n=0;n<s;n++)o[n]=i.charCodeAt(n);return a.Uint8(o)},Uint8:function(o){let i={data:null,pointer:0,movePointer:function(c){return this.pointer+=c,this.pointer},readInt:function(c){if((c=Math.min(c,this.data.byteLength-this.pointer))<1)return-1;let l=0;if(1<c)for(let d=1;d<=c-1;d++)l+=this.data.getUint8(this.pointer)*Math.pow(256,c-d),this.pointer++;return l+=this.data.getUint8(this.pointer),this.pointer++,l},readStr:function(c){let l=new Uint8Array(c),d=!1,h;l.forEach((b,g)=>{l[g]=this.readInt(1)});for(let b=0;b<r.length;b++)if(!d)try{if(h=r[b].decode(l),b===0)for(let g=0;g<h.length;g++){let m=h.charCodeAt(g);if(m>191||m>127&&m<160)throw new RangeError(`Invalid code point: ${m}`)}d=!0,console.debug(`String byte sequence in ${r[b].encoding}`)}catch(g){console.debug(`SMF string ${g}`)}return h||"String byte sequence read failed."},backOne:function(){this.pointer--},readIntVLV:function(){let c=0;if(this.pointer>=this.data.byteLength)return-1;if(this.data.getUint8(this.pointer)<128)c=this.readInt(1);else{let d=[];for(;128<=this.data.getUint8(this.pointer);)d.push(this.readInt(1)-128);var l=this.readInt(1);for(let h=1;h<=d.length;h++)c+=d[d.length-h]*Math.pow(128,h);c+=l}return c}};if(i.data=new DataView(o.buffer,o.byteOffset,o.byteLength),i.readInt(4)!==1297377380)return console.warn("Header validation failed (not MIDI standard or file corrupt.)"),!1;i.readInt(4);let s={};s.formatType=i.readInt(2),s.tracks=i.readInt(2),s.track=[];var o=i.readInt(1),n=i.readInt(1);128<=o?(s.timeDivision=[],s.timeDivision[0]=o-128,s.timeDivision[1]=n):s.timeDivision=256*o+n;for(let c=1;c<=s.tracks;c++){s.track[c-1]={event:[]};var f,p=i.readInt(4);if(p===-1)break;if(p!==1297379947)return!1;i.readInt(4);let l=0,d=!1,h,b;for(;!d&&(l++,s.track[c-1].event[l-1]={},s.track[c-1].event[l-1].deltaTime=i.readIntVLV(),(h=i.readInt(1))!==-1);)if(128<=h?b=h:(h=b,i.movePointer(-1)),h===255){s.track[c-1].event[l-1].type=255,s.track[c-1].event[l-1].metaType=i.readInt(1);var u=i.readIntVLV();switch(s.track[c-1].event[l-1].metaType){case 47:case-1:d=!0;break;case 1:case 2:case 3:case 4:case 5:case 7:case 6:s.track[c-1].event[l-1].data=i.readStr(u);break;case 33:case 89:case 81:s.track[c-1].event[l-1].data=i.readInt(u);break;case 84:s.track[c-1].event[l-1].data=[],s.track[c-1].event[l-1].data[0]=i.readInt(1),s.track[c-1].event[l-1].data[1]=i.readInt(1),s.track[c-1].event[l-1].data[2]=i.readInt(1),s.track[c-1].event[l-1].data[3]=i.readInt(1),s.track[c-1].event[l-1].data[4]=i.readInt(1);break;case 88:s.track[c-1].event[l-1].data=[],s.track[c-1].event[l-1].data[0]=i.readInt(1),s.track[c-1].event[l-1].data[1]=i.readInt(1),s.track[c-1].event[l-1].data[2]=i.readInt(1),s.track[c-1].event[l-1].data[3]=i.readInt(1);break;default:this.customInterpreter!==null&&(s.track[c-1].event[l-1].data=this.customInterpreter(s.track[c-1].event[l-1].metaType,i,u)),this.customInterpreter!==null&&s.track[c-1].event[l-1].data!==!1||(i.readInt(u),s.track[c-1].event[l-1].data=i.readInt(u),this.debug&&console.info("Unimplemented 0xFF meta event! data block readed as Integer"))}}else switch((h=h.toString(16).split(""))[1]||h.unshift("0"),s.track[c-1].event[l-1].type=parseInt(h[0],16),s.track[c-1].event[l-1].channel=parseInt(h[1],16),s.track[c-1].event[l-1].type){case 15:this.customInterpreter!==null&&(s.track[c-1].event[l-1].data=this.customInterpreter(s.track[c-1].event[l-1].type,i,!1)),this.customInterpreter!==null&&s.track[c-1].event[l-1].data!==!1||(f=i.readIntVLV(),s.track[c-1].event[l-1].data=i.readInt(f),this.debug&&console.info("Unimplemented 0xF exclusive events! data block readed as Integer"));break;case 10:case 11:case 14:case 8:case 9:s.track[c-1].event[l-1].data=[],s.track[c-1].event[l-1].data[0]=i.readInt(1),s.track[c-1].event[l-1].data[1]=i.readInt(1);break;case 12:case 13:s.track[c-1].event[l-1].data=i.readInt(1);break;case-1:d=!0;break;default:if(this.customInterpreter!==null&&(s.track[c-1].event[l-1].data=this.customInterpreter(s.track[c-1].event[l-1].metaType,i,!1)),this.customInterpreter===null||s.track[c-1].event[l-1].data===!1)return console.log("Unknown EVENT detected... reading cancelled!"),!1}}return s},customInterpreter:null};if(typeof K<"u")K.exports=a;else{let e=typeof window=="object"&&window.self===window&&window||typeof self=="object"&&self.self===self&&self||typeof global=="object"&&global.global===global&&global;e.MidiParser=a}})()});var H=class{#e={};addEventListener(t,r){this.#e[t]||(this.#e[t]=[]),this.#e[t].unshift(r)}removeEventListener(t,r){if(this.#e[t]){let a=this.#e[t].indexOf(r);a>-1&&this.#e[t].splice(a,1),this.#e[t].length<1&&delete this.#e[t]}}dispatchEvent(t,r){let a=new Event(t),e=this;a.data=r,this.#e[t]?.length>0&&this.#e[t].forEach(function(i){try{i?.call(e,a)}catch(s){console.error(s)}}),this[`on${t}`]&&this[`on${t}`](a)}};var R={g2:new Set("gm,GM,g2,G2".split(",")),xg:new Set};for(let t of"XG,MU,AN,AP,DR,DX,PC,PF,SG,VL".split(","))R.xg.add(t),R.xg.add(t.toLowerCase());var J=class{#e={};context;set(t,r){this.#e[t]=r}has(t){return!!this.#e[t]}async read(t,r){if(!this.has(t))throw new Error(`No decoder registered for "${t}"`);return await this.#e[t].call(this.context||this,r)}};var ke=function(t,r){let a=!0;return r.forEach((e,i)=>{a=a&&t[i]===e}),a},I=function(t){let r=0;return t.forEach(a=>{r*=256,r+=a}),r},v=new TextDecoder,G=new J;G.set("s7e",async function(t){let r=new Uint8Array(await t.slice(0,65536).arrayBuffer()),a="MSB	LSB	PRG	NME",e=[0,0,0,0],i=32,s=0,o=0,n=!0,f=[],p=0;for(;n;){let u=r.subarray(s);([()=>{v.decode(u.subarray(0,4))==="YSFC"?(s+=80,o=1):s++},()=>{if(ke(u.subarray(0,4),e))f.forEach((c,l,d)=>{let h=I(r.subarray(c.start+4,c.start+8));c.length=h}),o=2;else{let c=v.decode(u.subarray(0,4)),l=I(u.subarray(4,8));f.push({type:c,start:l}),s+=8}},()=>{let c=f[p],l=r.subarray(c.start,c.start+c.length),d=32;switch(c.type){case"ENVC":{let h=i;for(;h<l.length;){let b=l.subarray(h,h+d),g=v.decode(b.subarray(0,10)).trimEnd();g.slice(0,5)==="Init "&&(g=""),g&&(a+=`
063	${(b[17]+13).toString().padStart(3,"0")}	${b[19].toString().padStart(3,"0")}	${g}`),h+=d}break}case"EDVC":{let h=i;for(;h<l.length;){let b=l.subarray(h,h+d),g=v.decode(b.subarray(0,10)).trimEnd();g.slice(0,5)==="Init "&&(g=""),g&&(a+=`
063	024	${b[19].toString().padStart(3,"0")}	${g}`),h+=d}break}case"EPVC":{let h=32,b=i;for(;b<l.length;){let g=l.subarray(b,b+h),m=v.decode(g.subarray(0,10)).trimEnd();m==="----------"&&(m=""),m&&(a+=`
063	${(g[17]+1).toString().padStart(3,"0")}	${g[19].toString().padStart(3,"0")}	${m}`),b+=h}break}}p++,p>=f.length&&(o=3,n=!1)}][o]||(()=>{n=!1}))()}return a});G.set("pcg",async function(t){let r=new Uint8Array(await t.arrayBuffer()),a="MSB	LSB	PRG	NME",e=100,i=0,s=0,o=!0,n=[],f=0;for(;o;){let p=r.subarray(e);([()=>{o=v.decode(p.subarray(0,4))==="INI2",s=p[15],e+=16,i=1},()=>{let u=v.decode(p.subarray(0,4)),c=p[5],l=p[7],d=p[11],h=I(p.subarray(12,16)),b=I(p.subarray(16,20)),g=I(p.subarray(36,40)),m=v.decode(p.subarray(44,44+d));n.push({type:u,tipMsb:c,tipLsb:l,nameLen:d,length:h,start:b,entryLen:g,name:m}),e+=64,s--,s<1&&(i=2)},()=>{let u=n[f],c=r.subarray(u.start,u.start+u.length);switch(u.type){case"PRG1":break;case"PBK1":{let l=63,d=(u.tipMsb?6:0)+u.tipLsb;for(let h=0;h<128;h++){let b=h*u.entryLen,g=c.subarray(b,b+u.entryLen),m=v.decode(g.subarray(0,24)).trimEnd().replace("InitProg","");m.length&&d>5&&(a+=`
${l.toString().padStart(3,"0")}	${d.toString().padStart(3,"0")}	${h.toString().padStart(3,"0")}	${m}`)}break}case"CBK1":{let l=63,d=(u.tipMsb?3:0)+u.tipLsb+10;for(let h=0;h<128;h++){let b=h*u.entryLen,g=c.subarray(b,b+u.entryLen),m=v.decode(g.subarray(0,24)).trimEnd().replace("InitCombi","");m.length&&d>12&&(a+=`
${l.toString().padStart(3,"0")}	${d.toString().padStart(3,"0")}	${h.toString().padStart(3,"0")}	${m}`)}break}}f++,f>=n.length&&(i=3,o=!1)}][i]||(()=>{o=!1}))()}return a});var we=["off","hall","room","stage","plate","delay LCR","delay LR","echo","cross delay","early reflections","gate reverb","reverse gate"].concat(new Array(4),["white room","tunnel","canyon","basement","karaoke"],new Array(43),["pass through","chorus","celeste","flanger","symphonic","rotary speaker","tremelo","auto pan","phaser","distortion","overdrive","amplifier","3-band EQ","2-band EQ","auto wah"],new Array(1),["pitch change","harmonic","touch wah","compressor","noise gate","voice channel","2-way rotary speaker","ensemble detune","ambience"],new Array(4),["talking mod","Lo-Fi","dist + delay","comp + dist + delay","wah + dist + delay","V dist","dual rotor speaker"]);var Ce=",a,i,u,e,o,ka,ki,ku,ke,ko,ky,kw,sa,si,su,se,so,sh,ta,ti,tu,te,to,t,ch,t,s,na,ni,nu,ne,no,ny,nn,ha,hi,hu,he,ho,hy,fa,fi,fu,fe,fo,ma,mi,mu,me,mo,my,mm,ya,yu,ye,yo,ra,ri,ru,re,ro,ry,wa,wi,we,wo,ga,gi,gu,ge,go,gy,gw,za,zi,zu,ze,zo,ja,ji,ju,je,jo,jy,da,di,du,de,do,dy,ba,bi,bu,be,bo,by,va,vi,vu,ve,vo,pa,pi,pu,pe,po,py,nga,ngi,ngu,nge,ngo,ngy,ng,hha,hhi,hhu,hhe,hho,hhy,hhw,*,_,,,~,.".split(","),ve={};`hi*,
ka,„Åã
ki,„Åç
ku,„Åè
ke,„Åë
ko,„Åì
ky,„Åç!
kw,„Åèl
tsu,„Å§
ts,„Å§l
sa,„Åï
si,„Åô„ÅÉ
su,„Åô
se,„Åõ
so,„Åù
shi,„Åó
sh,„Åó!
ta,„Åü
ti,„Å¶„ÅÉ
tu,„Å®„ÅÖ
te,„Å¶
to,„Å®
tchy,„Å°!
tchi,„Å°
na,„Å™
ni,„Å´
nu,„Å¨
ne,„Å≠
no,„ÅÆ
ny,„Å´!
nn,„Çì
ha,„ÅØ
hi,„Å≤
hu,„Åª„ÅÖ
he,„Å∏
ho,„Åª
hy,„Å≤!
fa,„Åµ„ÅÅ
fi,„Åµ„ÅÉ
fu,„Åµ
fe,„Åµ„Åá
fo,„Åµ„Åâ
ma,„Åæ
mi,„Åø
mu,„ÇÄ
me,„ÇÅ
mo,„ÇÇ
my,„Åø!
mm,„á∫
ra,„Çâ
ri,„Çä
ru,„Çã
re,„Çå
ro,„Çç
ry,„Çä!
wa,„Çè
wi,„Çê
we,„Çë
wo,„Çí
nga,„Åã„Çö
ngi,„Åç„Çö
ngu,„Åè„Çö
nge,„Åë„Çö
ngo,„Åì„Çö
ngy,„Åç„Çö!
ng,„É≥
ga,„Åå
gi,„Åé
gu,„Åê
ge,„Åí
go,„Åî
gy,„Åé!
gw,„Åêl
za,„Åñ
zi,„Åö„ÅÉ
zu,„Åö
ze,„Åú
zo,„Åû
ja,„Åò„ÇÉ
ji,„Åò
ju,„Åò„ÇÖ
je,„Åò„Åá
jo,„Åò„Çá
jy,„Åò!
da,„Å†
di,„Åß„ÅÉ
du,„Å©„ÅÖ
de,„Åß
do,„Å©
dy,„Åß!
ba,„Å∞
bi,„Å≥
bu,„Å∂
be,„Åπ
bo,„Åº
by,„Å≥!
va,„Çî„ÅÅ
vi,„Çî„ÅÉ
vu,„Çî
ve,„Çî„Åá
vo,„Çî„Åâ
pa,„Å±
pi,„Å¥
pu,„Å∑
pe,„Éö
po,„ÅΩ
py,„Å¥!
!ya,„ÇÉ
!yu,„ÇÖ
!ye,„Åá
!yo,„Çá
ya,„ÇÑ
yu,„ÇÜ
ye,õÄÅ
yo,„Çà
!a,„ÇÉ
!u,„ÇÖ
!e,„Åá
!o,„Çá
!a,„ÇÉ
!u,„ÇÖ
!e,„Åá
!o,„Çá
la,„ÅÅ
li,„ÅÉ
lu,„ÅÖ
le,„Åá
lo,„Åâ
a,„ÅÇ
i,„ÅÑ
u,„ÅÜ
e,„Åà
o,„Åä
*,„Å£
~,
^,
_,`.split(`
`).forEach(t=>{let r=t.split(",");ve[r[0]]=r[1]});var $=new TextEncoder,Z=(t,r)=>{let a=Math.min(t.length,r.length),e=0;for(let i=0;i<a;i++)if(e=t[i]-r[i],e!==0)return[i,e];return t.length!==r.length?[a,t.length-r.length]:[0,0]};var j=function(t,r,a){let e=[],i=a==!1?r.readIntVLV():a;t==0||t==127;for(let s=0;s<i;s++){let o=r.readInt(1);if(e.push(o),o!=247){if(o!=240){if(o>127)return console.debug(`Early termination: ${e}`),e.pop(),r.backOne(),r.backOne(),new Uint8Array(e)}}}return new Uint8Array(e)};var st="‚ô≠ùÑ´,ùÑ´,‚ô≠,,‚ôØ,ùÑ™,ùÑ™‚ôØ".split(",");var C=[new Map,new Map];C[0].set("base64",$.encode("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"));C[0].set("base64url",$.encode("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_"));C[0].set("hex",$.encode("0123456789abcdef"));C[0].set("ovm43",$.encode("0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-_"));C[0].set("radix64",$.encode("0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz+/"));C[0].set("radix64url",$.encode("0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-_"));C[0].set("xx",$.encode("+-0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz"));C[0].set("xxurl",$.encode("_-0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz"));C[0].set("z64",$.encode("0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ+/"));C[0].set("z64url",$.encode("0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ-_"));for(let[t,r]of C[0]){let a=new Uint8Array(128).fill(255);for(let e=0;e<r.length;e++)a[r[e]]=e;switch(t){case"hex":{for(let e=10;e<16;e++)a[e+55]=e;break}default:a[9]=254,a[10]=254,a[12]=254,a[13]=254,a[32]=254,a[61]=254}C[1].set(t,a)}console.debug(C);var $e=(t="base64",r,a=!1)=>{};self.bufferTo=$e;var L={red:"#ff7986",orange:"#fca022",grYellow:"#c9e10a",green:"#c1ff0a",white:"#b7e5e3",blue:"#2280ff"},D={black:"#000000",blue:"#0516bb",purple:"#48009a",inactive:22,medium:59,active:170,range:148},Se=[[6,26],[7,35],[8,44],[9,53],[10,62],[11,71],[12,80],[13,89],[14,98],[15,107],[16,116],[17,125],[18,134],[19,143],[20,152],[21,161],[22,170]],B={},xe="06,68,2a,16,aa,3b".split(",");for(let t in D)B[t]=[],xe.forEach(r=>{B[t].push(`${D[t]}${r}`)});var ee=[];for(let t of Se)ee.push([`${D.black}${t[0].toString(16).padStart(2,"0")}`,`${D.black}${t[1].toString(16).padStart(2,"0")}`]),t.push(t[1]-t[0]);var nt=`${L.orange}64`,ot=`${L.green}64`,ct=`${L.white}64`,lt=`${L.red}64`,dt=B.black[0],ft=B.black[2],ht=B.black[1];var Te=["?","gm","gs","sc","xg","g2","mt32","doc","qy10","qy20","ns5r","x5d","05rw","k11","sg","sd","pa","krs","s90es","motif","cs6x","trin","an1x","cs1x"];var Me=["melodic","drum","menu"];var Pe=[36,37,48,49,52,53],X=[20,21,22,23,24,25,26,28,29,30,31,36,37,48,49,52,53,64,65];var ae=[0,1,2,4,5,6,7,8,10,11,12,13,14,15,16,17,18,19,20,21,22,26,28,32,38,40,41,42,43,44,45,46,47,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,80,81,82,83,84,91,92,93,94,95,98,99,100,101,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157];var F="reverb,chorus,delay,insert0,insert1,insert2,insert3,insert4".split(",");var Ae={};Te.forEach((t,r)=>{Ae[t]=r});var Re=[];ae.forEach((t,r)=>{Re[t]=r});var re={length:X.length};X.forEach((t,r)=>{re[t]=r});var Ie={};Me.forEach((t,r)=>{Ie[t]=r});var V=8,y={port:V,ch:V<<4,chShift:Math.ceil(Math.log2(V))+4,cc:ae.length,nn:128,pl:512,tr:256,cmt:14,rpn:6,rpnt:4,nrpn:Pe.length,ace:8,drm:8,dpn:X.length,dnc:128,ext:3,efx:8,cvn:12,redir:32,vxPrim:3,invalidCh:255};y.chcc=y.cc*y.ch;var P={bank0:255},jt=new TextDecoder("l9"),Be=new Uint16Array(y.ch),De=new Uint16Array(y.ch),Le=new Uint16Array(y.ch),Ue=new Uint16Array(y.ch),Oe=new Uint16Array(y.ch),_e=new Uint16Array(y.ch),te=new Array(y.drm);for(let t=0;t<y.ch;t++)Be[t]=t*y.cc,De[t]=t*y.rpn,Le[t]=t*y.nrpn,Ue[t]=t*y.ace,Oe[t]=t*y.ext,_e[t]=t*y.cvn;for(let t=0;t<y.drm;t++){te[t]=new Uint16Array(y.dpn);let r=t*y.dpn*y.dnc;for(let a=0;a<y.dpn;a++)te[t][a]=r+a*y.dnc}if(typeof self?.require<"u")throw new Error("Environments supporting CommonJS is not supported.");var Q=Ee(se(),1);var ie=class{#e=!1;constructor(t,r,a,e){this.#e=t,this.start=r,this.end=a,this.data=e}get duration(){return this.ranged?this.end-this.start:0}get ranged(){return this.#e}},Y=class extends ie{constructor(t,r,a){super(!0,t,r,a)}},ne=class extends ie{constructor(t,r){super(!1,t,t,r)}},z=class extends Array{#e=-1;constructor(){super(...arguments)}resetIndex(t){this.#e=-1}fresh(){this.sort(function(t,r){return t.start==r.start?0:(+(t.start>r.start)<<1)-1}),this.forEach(function(t,r){t.index=r})}step(t,r=!1){let a=[];if(r)for(let e=0;e<this.length&&!(this[e].start>t);e++){if(this[e].end<t)continue;a.push(this[e])}else{let e=this.getRange(this.#e==-1?0:t-1,t),i=this;e.forEach(function(s){s.index>i.#e&&(a.push(s),i.#e=s.index)})}return a}getRange(t,r){t>r&&([t,r]=[r,t]);let a=[],e=-1,i=Math.ceil(Math.sqrt(this.length)),s=!0;for(let o=0;o<this.length;o+=i)this[o+i]?e<0&&this[o+i].start>=t&&(e=o):e=e<0?o:e;for(;s;)this[e]?.end<r?this[e].start>=t&&a.push(this[e]):s=!1,e++;return a}};var Ne=0xffffffffffff,oe=function(t){let r=new z,a=this,e=t.timeDivision,i=120,s=new z,o=0,n=0;s.push(new Y(0,Ne,[120,0])),t.track.forEach(function(c){o=0,c.event.forEach(function(l){o+=l.deltaTime,l.type===255&&l?.metaType===81&&(i=6e7/l.data,s[s.length-1]&&s.push(new Y(o,0xffffffffffff,[i,0])))})}),s.fresh(),s.forEach(function(c,l,d){l>0&&(d[l-1].end=c.start)});let f=120;s.forEach(function(c,l,d){l>0&&(c.end===c.start?d.splice(d.indexOf(c),1):f===c.data[0]&&(d[l-1].end=c.end,d.splice(d.indexOf(c),1)),f=c.data[0])});let p=0,u=120;return s.forEach(function(c){let l=c.start,d=l/u/e*60+p;u=c.data[0],p=d-l/u/e*60,c.data[1]=p}),console.debug("All tempo changes: ",s),i=120,o=0,n=0,t.track.forEach(function(c,l){o=0,n=0;let d=l+1;c.event.forEach(function(h,b){o+=h.deltaTime;let g=s.step(o,!0)[0];g&&(i=g.data[0],n=g.data[1]);let m={type:h.type,data:h.data,track:d,part:0};h.type>14?m.meta=h.metaType:m.part=h.channel,r.push(new ne(o/i/e*60+n,m))})}),r.fresh(),self.midiEvents=r,console.debug(`Parsed a type ${t.formatType} MIDI sequence.`),r};var He={866:"cp866","utf-8":"utf-8",utf8:"utf-8","utf-16":"utf-16",utf16:"utf-16","utf-16le":"utf-16",utf16le:"utf-16",unicode:"utf-16",unicodefeff:"utf-16","ucs-2":"utf-16","utf-16be":"utf-16be",utf16be:"utf-16be","utf-24":"utf-24",utf24:"utf-24","utf-24le":"utf-24",utf24le:"utf-24","utf-24be":"utf-24be",utf24be:"utf-24be","utf-32":"utf-32",utf32:"utf-32","utf-32le":"utf-32",utf32le:"utf-32","utf-32be":"utf-32be",utf32be:"utf-32be",latin1:"latin1",l1:"latin1",ascii:"latin1","us-ascii":"latin1","iso-8859-1":"latin1","iso8859-1":"latin1",cp1252:"latin1","windows-1252":"latin1",cp819:"latin1",ibm819:"latin1",latin2:"latin2",l2:"latin2","iso-8859-2":"latin2","iso8859-2":"latin2",latin3:"latin3",l3:"latin3","iso-8859-3":"latin3","iso8859-3":"latin3",latin4:"latin4",l4:"latin4","iso-8859-4":"latin4","iso8859-4":"latin4",latin5:"latin5",l5:"latin5","iso-8859-9":"latin5","iso8859-9":"latin5",cp1254:"latin5","windows-1254":"latin5",latin6:"latin6",l6:"latin6","iso-8859-10":"latin6","iso8859-10":"latin6",latin9:"latin9",l9:"latin9","iso-8859-15":"latin9","iso8859-15":"latin9","iso-8859-5":"iso-8859-5","iso8859-5":"iso-8859-5",cyrillic:"iso-8859-5","iso-8859-6":"iso-8859-6","iso8859-6":"iso-8859-6","iso-8859-6-e":"iso-8859-6","iso8859-6e":"iso-8859-6","iso-8859-6-i":"iso-8859-6","iso8859-6i":"iso-8859-6","asmo-708":"iso-8859-6","ecma-114":"iso-8859-6",arabic:"iso-8859-6","iso-8859-7":"iso-8859-7","iso8859-7":"iso-8859-7","ecma-118":"iso-8859-7",greek:"iso-8859-7",greek8:"iso-8859-7","iso-8859-8":"iso-8859-8","iso8859-8":"iso-8859-8","iso-8859-8-e":"iso-8859-8","iso8859-8e":"iso-8859-8",hebrew:"iso-8859-8",visual:"iso-8859-8","iso-8859-8-i":"iso-8859-8-i","iso8859-8i":"iso-8859-8-i",logical:"iso-8859-8-i","iso-8859-11":"iso-8859-11","iso8859-11":"iso-8859-11","windows-874":"iso-8859-11","dos-874":"iso-8859-11",cp874:"iso-8859-11","tis-620":"iso-8859-11","iso-8859-13":"iso-8859-13","iso8859-13":"iso-8859-13",latin7:"iso-8859-13",l7:"iso-8859-13","iso-8859-14":"iso-8859-14","iso8859-14":"iso-8859-14",latin8:"iso-8859-14",l8:"iso-8859-14","iso-8859-16":"iso-8859-16","iso8859-16":"iso-8859-16",cp866:"cp866",ibm866:"cp866",cp1250:"cp1250","windows-1250":"cp1250",cp1251:"cp1251","windows-1251":"cp1251",cp1253:"cp1253","windows-1253":"cp1253",cp1255:"cp1255","windows-1255":"cp1255",cp1256:"cp1256","windows-1256":"cp1256",cp1257:"cp1257","windows-1257":"cp1257",cp1258:"cp1258","windows-1258":"cp1258","euc-jp":"euc-jp",cp954:"euc-jp","euc-kr":"euc-kr",koi8:"koi8",koi:"koi8","koi8-r":"koi8","koi8-u":"koi8-u","koi8-ru":"koi8-u",mac:"mac",macintosh:"mac","mac-cyrillic":"x-mac-cyrillic","x-mac-cyrillic":"x-mac-cyrillic","x-mac-ukrainian":"x-mac-cyrillic",gbk:"gbk",gb2312:"gbk",chinese:"gbk","euc-cn":"gbk",gb18030:"gb18030",big5:"big5","big5-hkscs":"big5",sjis:"sjis","shift-jis":"sjis",ms932:"sjis","windows-31j":"sjis"},Ge={"utf-8":1,"utf-16":2,"utf-16be":3,"utf-24":4,"utf-24be":5,"utf-32":6,"utf-32be":7,latin1:0,latin2:0,latin3:0,latin4:0,latin5:0,latin6:0,latin9:0,"iso-8859-5":0,"iso-8859-6":0,"iso-8859-7":0,"iso-8859-8":0,"iso-8859-8-i":0,"iso-8859-11":0,"iso-8859-13":0,"iso-8859-14":0,"iso-8859-16":0,cp866:0,cp1250:0,cp1251:0,cp1253:0,cp1255:0,cp1256:0,cp1257:0,cp1258:0,"euc-jp":1,"euc-kr":1,koi8:0,"koi8-u":0,mac:0,"x-mac-cyrillic":0,gbk:1,gb18030:1,big5:1,sjis:1},S,x=(S=class{static getUnitSize(t){if(t>7)throw new RangeError("Cannot decode encodings with more than 4 bits per unit.");return(t>>1)+1}static isBigEndian(t){return(t&1)===1}static collapse(t){let r=He[t];if(typeof r!="string")throw new TypeError(`Provided label "${t}" is not supported.`);return r}static indicator(t){let r=Ge[t];if(typeof r!="number")throw new TypeError(`Provided collapsed label "${t}" is not supported.`);return r}},k(S,"BYTE_1",0),k(S,"BYTE_1_VL",1),k(S,"BYTE_2_LE",2),k(S,"BYTE_2_BE",3),k(S,"BYTE_3_LE",4),k(S,"BYTE_3_BE",5),k(S,"BYTE_4_LE",6),k(S,"BYTE_4_BE",7),S),w=(t,r)=>{t.unsent=!1,t.enqueue(r)},U=(t,r,a=1,e=!0)=>{if(typeof a!="number"||a<=0||a>4)throw new RangeError(`Invalid byte size ${a}.`);if(!(t instanceof Uint8Array||t instanceof Uint8ClampedArray))throw new TypeError("Input buffer is not Uint8Array.");if(typeof r!="number"||r<0||r>=t.length)throw new RangeError(`Provided offset ${r} is out of buffer range.`);if(a===1)return t[r];{let i=0;if(e)for(let s=0;s<a;s++)i<<=8,i|=t[r+s];else for(let s=0;s<a;s++)i|=t[r+s]<<(s<<3);return i<0?i+4294967296:i}},Ve=class{static lineRaw(t,r=0){if(typeof r!="number"||r<0||r>7)throw new TypeError("Invalid split mode.");if(!t||t?.constructor!==ReadableStream)throw new TypeError("Not a readable stream.");let a=x.getUnitSize(r),e=x.isBigEndian(r),i=t.getReader(),s,o=!1,n=[],f=0,p=0,u=0;return new ReadableStream({pull:async c=>{for(c.unsent=!0;c.unsent;){if(!s||f>=s.length){f>p&&(n.push(s.subarray(p)),p=0);let l=await i.read();s=l.value,o=l.done,f=0}if(s){let l=0;if(a===1)l=s[f];else if(e)for(let h=0;h<a;h++)l<<=8,l|=s[f+h];else for(let h=0;h<a;h++)l|=s[f+h]<<(h<<3);let d=!1;switch(l){case 10:{u===13?p+=a:d=!0;break}case 13:{d=!0;break}}if(d){if(n.length){n.push(s.subarray(p,f));let h=0;for(let m=0;m<n.length;m++)h+=n[m].length;let b=new Uint8Array(h),g=0;for(let m=0;m<n.length;m++)b.set(n[m],g),g+=n[m].length;w(c,b),n=[]}else w(c,s.subarray(p,f));p=f+=a}u=l}if(o){if(p!==f&&s&&n.push(s.subarray(p,f)),n.length){let l=0;for(let b=0;b<n.length;b++)l+=n[b].length;let d=new Uint8Array(l),h=0;for(let b=0;b<n.length;b++)d.set(n[b],h),h+=n[b].length;w(c,d)}c.unsent=!1,c.close()}f+=a}}},new ByteLengthQueuingStrategy({highWaterMark:256}))}static chunkRaw(t,r="utf-8"){if(!t||t?.constructor!==ReadableStream)throw new TypeError("Not a readable stream.");let a=x.indicator(r),e=x.getUnitSize(a),i=x.isBigEndian(a),s=t.getReader(),o;return new ReadableStream({pull:async n=>{n.unsent=!0;let{value:f,done:p}=await s.read();if(f){let u=0,c=f.length;if(a!==0&&typeof o?.length=="number"){let l=!1;switch(r){case"big5":case"gbk":case"sjis":case"euc-kr":{u=1;let d=new Uint8Array(2);d[0]=o[0],d[1]=f[0],w(n,d);break}case"euc-jp":{let d=3;o[0]===143?u=3-o.length:o[0]>127?(u=1,d=2):d=o.length;let h=new Uint8Array(3);h.set(o),h.set(f.subarray(0,u),o.length),w(n,h.subarray(0,d));break}case"gb18030":{let d=new Uint8Array(4),h=4;d.set(o),d.set(f.subarray(0,4-o.length),o.length),d[0]<128?h=o.length:d[1]>=64?(u=1,h=2):u=4-o.length,w(n,d.subarray(0,h));break}case"utf-8":{let d=4;o[0]>=240?u=4-o.length:o[0]>=224?(u=3-o.length,d=3):o[0]>=192?(u=1,d=2):d=o.length;let h=new Uint8Array(4);h.set(o),h.set(f.subarray(0,u),o.length),w(n,h.subarray(0,d));break}case"utf-16":case"utf-16be":{let d=new Uint8Array(4);d.set(o),d.set(f.subarray(0,4-o.length)),u=4-o.length,U(transientSize,0,2,i)>=55296&&U(transientSize,2,2,i)>=55296?w(n,d):(w(n,d.subarray(0,2)),w(n,d.subarray(2)));break}default:{let d=new Uint8Array(e);d.set(o),d.set(f.subarray(0,e-o.length),o.length),w(n,d)}}}if(o=void 0,a===0)w(n,f.subarray(u));else{switch(r){case"utf-24":case"utf-24be":{c=Math.floor((f.length-u)/e)*e+u;break}case"utf-32":case"utf-32be":{c=(f.length-u>>2<<2)+u;break}case"utf-8":{if(f[f.length-1]>127){let l=!0,d=f.length,h=f.length-8;for(;l&&d>h;)d--,f[d]<128?c=d+1:f[d]>192&&(c=d)}break}case"utf-16":case"utf-16be":{if(c=(f.length-u>>1<<1)+u,U(f,c-2,2,i)>=55296){let l=!0,d=c,h=c-6;for(;l&&d>h;)d-=2,U(f,d,2,i)>>10===54&&(c=d)}break}default:throw new TypeError("Maybe someday the rest of the decoders will be implemented")}w(n,f.subarray(u,c))}c<f.length&&(o=f.subarray(c))}p&&(typeof o?.length=="number"&&w(n,o),n.unsent=!1,n.close())}},new ByteLengthQueuingStrategy({highWaterMark:256}))}static line(t,r="utf-8",a){let e=x.collapse(r),i=x.indicator(e),s=this.lineRaw(t,i).getReader(),o=new TextDecoder(e,onlostpointercapture);return new ReadableStream({pull:async n=>{let{value:f,done:p}=await s.read();f&&n.enqueue(o.decode(f)),p&&n.close()}})}static chunk(t,r="utf-8",a){let e=x.collapse(r);if(self.TextDecoderStream){let i=new TextDecoderStream(e,a);return t.pipeTo(i.writable),i.readable}else{let i=this.chunkRaw(t,e).getReader(),s=new TextDecoder(e);return new ReadableStream({pull:async o=>{let{value:n,done:f}=await i.read();n&&(console.debug(n),o.enqueue(s.decode(n))),f&&o.close()}})}}},ce=Ve;var W={0:"\0",a:"\x07",b:"\b",e:"\x1B",f:"\f",n:`
`,r:"\r",t:"	",v:"\v","\\":"\\","'":"'",'"':'"'},q=new Uint8Array(128);q.fill(1,48,58);q.fill(1,65,71);q.fill(1,97,103);var A=new Uint8Array(256);A.fill(1,0,32);A.fill(1,128,160);A[127]=1;var Xe={};for(let t in W){let r=W[t];Xe[r]=`\\${t}`,A[r.charCodeAt(0)]=2}A[34]=3;A[39]=3;var le=t=>{let r="",a=!1;for(let e=0;e<t.length;e++){let i=t[e];if(a){let s=0;switch(i){case"x":{s=2;break}case"u":{s=4;break}case"U":{s=8;break}default:{let o=W[i];if(typeof o=="string")r+=o;else throw new Error(`Invalid escape identifier "${i}" at index ${e}`);a=!1;continue}}if(s>0){let o=e+1,n=t.substring(o,o+s);if(n.length<s)throw new RangeError(`Insufficient code point buffer "${n}" at index ${o}`);let f=parseInt(n,16);if(Number.isNaN(f))throw new RangeError(`Malformed code point representation "${n}" at index ${o}`);if(f>=1114112)throw new RangeError(`Code point "${n}" exceeds 0x10ffff at index ${o}`);r+=String.fromCodePoint(f),a=!1,e+=s}}else i==="\\"?a=!0:r+=i}return r},Fe=(t,r=0)=>{};self.TextEscape=Fe;var T,O=(T=class{static parse(t,r){let a=t&this.MASK_TYPE,e=t&this.MASK_DATA,i=0,s=0,o,n=0,f,p=r.getReader();return new ReadableStream({pull:async u=>{let{value:c,done:l}=await p.read();if(typeof c=="string"){switch(a){case this.TYPE_TSV:{o=[];try{for(let d of c.split("	"))switch(e){case this.DATA_TEXT:{o.push(le(d));break}case this.DATA_JSON:{o.push(i===0?le(d):JSON.parse(d));break}default:throw new TypeError(`Unknown DSV value type ${a}`)}}catch(d){console.debug(`The following error appeared when parsing on line ${i+1}.`),console.error(d)}break}case this.TYPE_CSV:{if(e!==this.DATA_TEXT)throw new TypeError(`Invalid type ${a} for CSV, only plain text is allowed`);break}default:throw new TypeError(`Unknown DSV type ${a}`)}u.enqueue(o),i++}l&&u.close()}})}static parseObjects(t,r){let a=0,e=this.parse(t,r).getReader(),i;return new ReadableStream({start:async s=>{let{value:o,done:n}=await e.read();typeof o?.length=="number"&&(i=o),n&&s.close()},pull:async s=>{let{value:o,done:n}=await e.read();if(typeof o?.length=="number"){let f={};for(let p=0;p<o.length;p++)o[p]&&(f[i[p]]=o[p]);s.enqueue(f)}n&&s.close()}})}},k(T,"MASK_TYPE",3),k(T,"MASK_DATA",12),k(T,"TYPE_TSV",0),k(T,"TYPE_CSV",1),k(T,"DATA_TEXT",0),k(T,"DATA_JSON",4),T);Q.default.customInterpreter=j;var E=(t,r,a)=>{t.addEventListener(a,e=>{r.dispatchEvent(a,e.data)})},de=t=>{let r=t.split("/");return r[r.length-1]||r[r.length-2]||"(remote)"};if(typeof self?.require<"u")throw new Error("Environments supporting CommonJS is not supported.");var va=class extends H{BM_UNIVERSAL=0;BM_YAMAHA_MU=1;device;#e;#c={};#g=[];#n=new Map;#a="";#u=[];#m=[];#p=new Uint8ClampedArray(y.ch);#E=new Uint8ClampedArray(y.ch);#y=new Uint32Array(y.ch);#b=new Uint32Array(y.ch);#l=.5;#d=120;#r=4;#t=4;#s=0;#o=0;#i=new Array(y.ch);#f=new Uint8Array(y.ch);#h=0;dState;msActive=200;msFrame=100;msExhaust=300;smoothAttack=0;smoothDecay=0;get clockSource(){return this.device?.clockSource}set clockSource(t){if(this.device)this.device.clockSource=t;else throw new Error("OctaviaDevice is not ready.")}reset(){let t=this;t.dispatchEvent("reset"),t.#e?.resetIndex(),t.device.init(),t.#a="",t.#l=.5,t.#d=120,t.#r=4,t.#t=4,t.#s=0,t.#o=0,t.dispatchEvent("tempo",t.#d),t.dispatchEvent("title",t.#a),t.dispatchEvent("tsig",t.getTimeSig())}init(){this.reset(),this.#e=void 0}async loadFile(t){this.#e=oe(Q.default.parse(new Uint8Array(await t.arrayBuffer())))}async loadMap(t,r,a,e="(internal)"){let i=this,s=0,o=0,n=0,f=0,p,u;t.split(`
`).forEach((c,l)=>{if(!c)return;let d=c.split("	");if(l){if(!f)return;let h="",b="";d.forEach((m,M)=>{switch(M){case p:{h=m;break}case u:{b=m;break}}});let g=!1;i.#c[h]?.priority>a&&(g=!0,n++),!i.#c[h]||g||r?(i.#c[h]={name:b,priority:a},s++):self.debugMode&&console.debug(`Voice "${b}" (${h}) seems to be in conflict with (${i.#c[h]}).`),o++}else d.forEach((h,b)=>{switch(h){case"ID":{p=b,f++;break}case"Name":{u=b,f++;break}default:console.debug(`Unknown map field: ${h}`)}})}),console.debug(`Voice names: From "${e}", ${o} total, ${s} loaded (${s-n} + ${n}).`),i?.device.forceVoiceRefresh()}async loadMapPaths(t){let r=this;t.forEach(async(a,e)=>{r.loadMap(await(await fetch(a)).text(),0,e,de(a))})}async loadEfx(t,r){let a=this,e=0,i=0,s,o,n;t.split(`
`).forEach((f,p)=>{if(f)if(p){let u=0,c;f.split("	").forEach((l,d)=>{switch(d){case s:{u|=(parseInt(l,16)&255)<<8;break}case o:{u|=parseInt(l,16)&255;break}case n:{c=l;break}}}),!a.#g[u]||r?(a.#g[u]=c,e++):self.debugMode&&console.debug(`EFX ID 0x${u.toString(16).padStart(4,"0")} (${c}) seems to be in conflict.`),i++}else f.split("	").forEach((u,c)=>{switch(u){case"MSB":{s=c;break}case"LSB":{o=c;break}case"Name":{n=c;break}default:console.debug(`Unknown EFX field: ${u}`)}})}),console.debug(`EFX: ${i} total, ${e} loaded.`);for(let f=0;f<F.length;f++){let p=!1,u=a.device.getEffectType(f);u[0]===0&&u[1]>>4===15&&(p=!0),a.dispatchEvent(`efx${F[f]}`,{id:u,hidden:p})}}async loadModels(t,r){let a=this,e=0,i=0}async loadStyles(t,r){let a=this,e=0,i=0}async loadProps(t,r,a=0,e="(internal)"){let i=this,s=0,o=0,n=0;for await(let f of O.parseObjects(O.DATA_TEXT|O.TYPE_TSV,ce.line(t)))if(typeof f?.voiceId=="string")if(o++,!(i.#n.has(f.voiceId)||i.#n.get(f.voiceId)?.priority<=a)||r){if(Object.keys(f).length<2)continue;i.#n.get(f.voiceId)?.priority>a&&n++,f.priority=a,i.handleProp&&await i.handleProp(f),i.#n.set(f.voiceId,f),s++}else console.debug(`Tried to write a pre-existing entry "${f.voiceId}" on entry ${o}.`);console.debug(`Voice properties: From "${e}", ${o} total, ${s} loaded (${s-n} + ${n}).`)}async loadPropsPaths(t){let r=this;t.forEach(async(a,e)=>{let i=a.split("/");r.loadProps((await fetch(a)).body,0,e,de(a))})}switchMode(t,r=!1){this.device.switchMode(t,r)}getMode(){return this.device.getMode()}getVoice(){return this.device.getVoice(...arguments)}getChVoice(t){return this.device.getChVoice(t)}refreshCachedChVoice(t,r){let a=this,e=r??a.device.getChVoice(t),i=a.#i[t],s=!0;if(a.#h++,!r)switch(a.device.getChMode(t)){case"xg":{if(a.device.getChType(t)>0&&a.device.getChPrimitive(t,1)!==126)switch(e.ending){case"!":case"?":{s=!1,i.refreshFailure=!0,console.debug("Cached voice persisted due to invalid drum kit.");break}}break}case"gs":case"sc":{e.ending!==" "&&(e.sid[2]===1?(e.name="Silence",e.refreshFailure=!0,console.debug("Cached voice nullified due to invalid SC-55 voice.")):(s=!1,i.refreshFailure=!0,console.debug("Cached voice persisted due to invalid GS voice.")));break}}return s?(a.#i[t]=e,a.#f[t]=e.poly??1,a.#h>1?console.debug(`Bubbling prevented at instance #${a.#h}.`):a.dispatchEvent("cachedvoice",{part:t}),a.#h--,e):(a.#h--,i)}getCachedChVoice(t){let r=this,a=r.#i[t],e=r.device?.getChPrimitives(t,!0);if(a&&r.device?.getChCvnIsWritten(t)===0)switch(a.ending){case"?":case"!":return r.refreshCachedChVoice(t,void 0);default:return Z(a.sid,e)[1]!==0||a.name==="Unloaded"?r.refreshCachedChVoice(t):a}else return r.refreshCachedChVoice(t)}getChPrimitive(t,r,a){return this.device.getChPrimitive(t,r,a)}getChPrimitives(t,r){return this.device.getChPrimitives(t,r)}getMapped(t){return this.#c[t]?.name||t}getEfx(t){let[r,a]=t,e=r<<8|a;return this.#g[e]||`0x${e.toString(16).padStart(4,"0")}`}getVoxBm(t,r=this.BM_UNIVERSAL){if(!t)throw new Error("Voice object must be valid");let a=this;if(!a.voxBm)throw new Error("Voice bitmap repository isn't yet initialized");let e=a.voxBm.getBm(t.name);if(!e){switch(t.mode){case"xg":{switch(t.sid[0]){case 0:case 80:case 81:case 83:case 84:case 96:case 97:case 99:case 100:{e=a.voxBm.getBm(a.getVoice(P.bank0,t.sid[1],P.bank0,t.mode).name);break}}break}case"g2":case"sd":{switch(t.sid[0]){case 96:case 97:case 98:case 99:{e=a.voxBm.getBm(a.getVoice(P.bank0,t.sid[1],P.bank0,t.mode).name);break}case 104:case 105:case 106:case 107:{e=a.voxBm.getBm(a.getVoice(120,t.sid[1],P.bank0,t.mode).name);break}}break}case"gs":case"sc":case"k11":case"sg":case"gm":{switch(t.sid[0]){case 120:break;case 122:case 127:{e=a.voxBm.getBm(a.getVoice(120,t.sid[1],0,t.mode).name);break}default:e=a.voxBm.getBm(a.getVoice(0,t.sid[1],0,t.mode).name)}break}case"05rw":case"x5d":case"ns5r":{switch(t.sid[0]){case 56:{e=a.voxBm.getBm(a.getVoice(0,t.sid[1],0,"gm").name);break}}break}default:}switch(r){case a.BM_UNIVERSAL:break;case a.BM_YAMAHA_MU:{let i=t.standard.toLowerCase();if(i!==t.mode&&R.xg.has(i))switch(t.sid[0]>>4){case 2:{e=a.sysBm?.getBm(`ext_${i}I`);break}case 3:{t.sid[0]===48&&(e=a.sysBm?.getBm("boot_3"));break}case 6:{e=a.sysBm.getBm(`ext_${i}P`);break}default:{e=a.sysBm.getBm(`ext_${i}`);break}}else["es"].indexOf(i)>-1?e=a.sysBm.getBm("boot_3"):i==="kr"&&(e=a.sysBm.getBm("st_korg"));break}}}return e||(e=a.voxBm.getBm(a.getVoice(t.sid[0],t.sid[1],0,t.mode).name)),e}getChBm(t,r=this.BM_UNIVERSAL,a){let e=this;a=a??e.getChVoice(t);let i=e?.device.getChType(t),s;switch(r){case e.BM_UNIVERSAL:break;case e.BM_YAMAHA_MU:{let o=a.standard.toLowerCase();if(o!==a.mode&&R.xg.has(o))switch(a.sid[0]>>4){case 1:{a.sid[0]===16&&(s=e.sysBm.getBm("cat_svox"));break}case 2:{s=e.sysBm?.getBm(`ext_${o}I`);break}case 3:{a.sid[0]===48&&(s=e.sysBm?.getBm("boot_3"));break}case 6:{s=e.sysBm.getBm(`ext_${o}P`);break}default:{s=e.sysBm.getBm(`ext_${o}`);break}}else if(["es"].indexOf(o)>-1)s=e.sysBm.getBm("boot_3");else if(o==="kr")s=e.sysBm.getBm("st_korg");else if(o==="xg")switch(a.sid[0]){case 126:{a.sid[1]>>2===28&&(s=e.sysBm.getBm("cat_smpl"));break}}if(!s&&i)switch(a.ending){case"!":case"?":case"*":{s=e.sysBm.getBm(i>1&&i<6?`cat_dS${i-1}`:"cat_drS");break}default:s=e.sysBm.getBm(i>1&&i<10?`cat_dr${i-1}`:"cat_drm")}break}}if(s=s||e.getVoxBm(a,r),!s){if(!e.sysBm)return;switch(a.mode){case"xg":{switch(a.sid[0]){case 126:{a.sid[1]>>2===28&&(s=e.sysBm.getBm("cat_smpl"));break}case 16:{s=e.sysBm.getBm("cat_smpl");break}case 64:case 67:{s=e.sysBm.getBm("cat_sfx");break}case 32:case 33:case 34:case 35:case 36:case 48:case 82:{s=e.sysBm.getBm("cat_xg");break}}break}default:switch(a.sid[0]){case 63:case 32:case 33:case 34:case 35:case 36:case 48:case 82:{s=e.sysBm.getBm("cat_mex");break}}}}if(s)switch(a.ending){case"!":case"?":case"*":{s=e.sysBm.getBm(i?"cat_drS":"no_vox");break}}else i?s=e.sysBm.getBm("cat_drS"):s=e.sysBm.getBm("no_vox");return s}getChBmState(t,r=1){let a=this,e=Math.floor(a.#o*1e3)-a.getChLastNoteExhausted(t);return a.getChLastNoteExhausted(t)<=0?0:e<a.msActive?(r-=1,r<1?0:Math.floor(e/a.msFrame)%r+1):0}detachState(t){let r=this;if(r.dState){let a=r.dState;switch(t){case"mu":{r.removeEventListener("mode",a.muModeFunc),delete a.muModeFunc,delete a.muModeBm,delete a.muUnresolvedEx,delete a.muUseVoiceBm,delete a.muTempWindow,delete a.muBlinkSpeedMode,delete a.muBmex,delete a.muBmst,delete a.isMu;break}}return!0}else return!1}attachState(t){let r=this;r.dState=r.dState??{};let a=r.dState,e=!1;switch(t){case"mu":{a.isMu=!0,a.muBmst=0,a.muBmex=0,a.muBlinkSpeedMode=400,a.muTempWindow=new Uint8Array(256),a.muUseVoiceBm=!0,a.muUnresolvedEx=0,a.muModeFunc=function(i){let s=r.sysBm.getBm(`st_${{gm:"gm1",g2:"gm2","?":"gm1",ns5r:"korg",ag10:"korg",x5d:"korg","05rw":"korg",krs:"korg",sg:"gm1",k11:"gm1",sd:"gm2",sc:"gs"}[i.data]||i.data}`);s&&(a.muModeBm=s.getFrame(0)),a.muBmst=2,a.muBmex=r.clockSource.now()+a.muBlinkSpeedMode*4},r.addEventListener("mode",a.muModeFunc);break}default:e=!0}return!e}muWriteBm(t,r,a){if(t?.BYTES_PER_ELEMENT!==1)throw new TypeError("Buffer must be Uint8Array.");let e=this,i=t.length>>8||1;if(!e.dState.isMu)throw new Error("Device state for MU is not yet attached.");let s=e.clockSource.now(),o=e.device?.getBitmap(),n=e.dState.muTempWindow,f=!1,p=!1;if(s<o.expire)o.bitmap.length<=256?(n=o.bitmap,f=!0):(t.set(o.bitmap.subarray(0,t.length)),p=!0);else if(s<e.dState.muBmex){if(e.dState.muBmst===2){f=!0;let u=Math.floor((e.dState.muBmex-s)/e.dState.muBlinkSpeedMode)&1;e.dState.muModeBm?e.dState.muModeBm?.forEach((c,l)=>{n[l]=u===c}):n.fill(u?0:1)}}else if(e.dState.muUseVoiceBm){f=!0,e.dState.muBmst=0;let u=e.getChBm(r,e.BM_YAMAHA_MU,a),c=e.getChBmState(r,u?.frames||1);u&&n.set(u.getFrame(c))}if(f){let u=0;for(let c=0;c<n.length;c++){let l=n[c];t[u]=l?255:0,i===2&&(t[u+1]=l?255:0),u+=i}}return f||p}getProps(t){let r=this,a,e,i=0,s=t;for(;i<8&&a==null&&(!e?.constructor||e instanceof Array&&(e[1]!==t.eid[1]||e[2]!==t.eid[2]));)e=t.eid,typeof t.voice=="string"&&(r.#n.has(t.voice)?a=r.#n.get(t.voice):t=r.getVoice(e[0],e[2]===0?0:e[1],e[2]===0?0:e[2]-1));return!a&&i===8&&console.info(`Voice property fetching failed for "${t.name}" (${t.eid.join(" ")}).`),a}get noteProgress(){return this.#o/this.#l}get noteOverall(){return(this.noteProgress-this.#s)*this.#t/4}get noteBar(){return Math.floor(this.noteOverall/this.#r)}get noteBeat(){let t=this.noteOverall%this.#r;return t<0&&(t+=this.#r),t}get noteOffset(){return this.#s}getTimeSig(){return[this.#r,this.#t]}getTempo(){return this.#d}getPool(){return this.#e}getChCachedVoiceRaw(t){return this.#i[t]}getChLastNoteAt(t){return this.#y[t]}getChLastNoteExhausted(t){return this.#b[t]}eachVoice(t,r=!1){let a=this;for(let e=0;e<a.#i.length;e++)(r||a.device?.getChActive(e))&&t(a.#i[e],e,a.#i)}sendCmd(t){this.device.runJson(t)}render(t){t>this.#o&&(this.#o=t);let r=this.#e?.step(t)||[],a=0,e=0,i=new Set,s={},o=[],n=this,f=[];for(n.device.getStrength().forEach((b,g)=>{n.#E[g]=b}),n.device.newStrength(),r.forEach(function(b){let g=b.data,m=n.device.runJson(g);switch(m?.reply){case"meta":{f.push(m);break}}m?.reply&&delete m.reply});n.#m.length>0;){let b=n.#m.shift(),g=b.part<<7|b.note;b.state?(i.add(g),s[g]=b.velo):i.has(g)&&(o.push({part:b.part,note:b.note,velo:s[g],state:n.device.NOTE_SUSTAIN}),a++,e+=n.#f[b.part])}f?.length>0&&n.dispatchEvent("meta",f);let p=[],u=[],c=n.device.getStrength();c.forEach(function(b,g,m){m[g]=Math.max(n.#E[g],b);let M=m[g]-n.#p[g];if(M>=0){let _=4*.25**(n.device.getChCc(g,73)/64);n.#p[g]+=Math.ceil(M-M*n.smoothAttack**_)}else{let _=4*.25**(n.device.getChCc(g,72)/64);n.#p[g]+=Math.floor(M-M*n.smoothDecay**_)}});let l=0,d=0;return n.device?.getActive()?.forEach(function(b,g){b&&(p[g]=n.device.getVel(g),u[g]=n.device.getExt(g),l+=p[g].size,d+=p[g].size*n.#f[g])}),{extraPoly:a,extraPolyEC:e,extraNotes:o,curPoly:l,curPolyEC:d,chKeyPr:p,chExt:u,eventCount:r.length,title:n.#a,texts:n.device.getTexts(),master:n.device.getMaster(),mode:n.device.getMode(),strength:n.#p,velo:c,rpn:n.device.getRpn(),tSig:n.getTimeSig(),tempo:n.getTempo(),noteBar:n.noteBar,noteBeat:n.noteBeat,ace:n.device.getAce(),rawVelo:n.device.getStrength(),rawStrength:n.device.getRawStrength(),rawPitch:n.device.getRawPitch(),efxSink:n.device.getEffectSink()}}constructor(t,r=.5,a=.5){super();let e=this;e.smoothAttack=r,e.smoothDecay=a,e.device=t,e.addEventListener("meta",function(i){i?.data?.forEach(function(s){(e.#u[s.meta]||console.debug).call(e,s.meta,s.data)})}),E(e.device,e,"mode"),E(e.device,e,"mastervolume"),E(e.device,e,"channelactive"),E(e.device,e,"channelmin"),E(e.device,e,"channelmax"),E(e.device,e,"portrange"),E(e.device,e,"portstart"),E(e.device,e,"channelreset"),E(e.device,e,"channeltoggle"),E(e.device,e,"screen"),E(e.device,e,"metacommit"),E(e.device,e,"voice"),E(e.device,e,"pitch"),E(e.device,e,"note"),E(e.device,e,"reset"),E(e.device,e,"banklevel"),E(e.device,e,"efxreverb"),E(e.device,e,"efxchorus"),E(e.device,e,"efxdelay"),E(e.device,e,"efxinsert0"),E(e.device,e,"efxinsert1"),E(e.device,e,"efxinsert2"),E(e.device,e,"efxinsert3"),E(e.device,e,"efxinsert4"),E(e.device,e,"partefxtoggle"),E(e.device,e,"chmode"),e.addEventListener("note",function({data:i}){if(e.#m.push(i),i.state===3){let s=Math.floor(e.#o*1e3);e.#y[i.part]=s,s-e.#b[i.part]>=e.msExhaust&&(e.#b[i.part]=s)}}),e.addEventListener("voice",({data:i})=>{e.refreshCachedChVoice(i.part)}),e.addEventListener("reset",({data:i})=>{e.#f.fill(1),e.#y.fill(0),e.#b.fill(0)}),e.#f.fill(1),e.#u[3]=function(i,s){e.#a?.length<1&&(e.#a=s,e.dispatchEvent("title",e.#a))},e.#u[81]=function(i,s){let o=e.noteProgress,n=e.#l||.5;e.#d=6e7/s,e.#l=s/1e6,e.#s+=o*(n/e.#l)-o,e.dispatchEvent("tempo",e.#d)},e.#u[88]=function(i,s){let o=e.noteBar,n=e.noteBeat,f=e.#r,p=e.#t;e.#r=s[0],e.#t=1<<s[1];let u=Math.round(o+n/f);f!==e.#r&&(e.#s-=u*(e.#r-f)*(4/e.#t)),p!==e.#t&&(console.debug(`${o}/${n}`),p<e.#t?e.#s+=u*(e.#t-p)*(p/e.#t):e.#s+=u*(e.#t-p)*(e.#t/p)),e.dispatchEvent("tsig",e.getTimeSig())},e.addEventListener("metacommit",({data:i})=>{switch(i.type){case"KarTitle":case"EORTitle":{e.#a?.length<1&&(e.#a=i.data,e.dispatchEvent("title",e.#a));break}}})}};export{va as RootDisplay,y as allocated,re as dnToPos};
